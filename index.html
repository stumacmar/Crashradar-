<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="description" content="CrashRadar monitors financial market crash risk using multiple economic indicators including yield curve, credit spreads, unemployment, and market drawdowns." />
  <title>CrashRadar — Composite Crash Risk Dashboard</title>

  <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
  <link rel="dns-prefetch" href="https://cdn.jsdelivr.net">

  <style>
    :root{
      --bg:#0f1421; --panel:#161c2e; --muted:#9aa6bf; --text:#e8eeff; --accent:#7da6ff;
      --green:#1ec28b; --amber:#ffc247; --red:#ff6070; --radius:16px; --t:all .2s ease;
    }
    *{box-sizing:border-box}
    html,body{margin:0;background:var(--bg);color:var(--text);font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Inter,Helvetica,Arial}
    :focus{outline:2px solid var(--accent);outline-offset:2px}
    :focus:not(:focus-visible){outline:none}
    .wrap{max-width:980px;margin:0 auto;padding:20px 16px 64px}
    h1{font-size:clamp(28px,5.5vw,44px);line-height:1.1;margin:0 0 8px}
    .sub{color:var(--muted);margin:6px 0 18px;font-size:14px}
    .ok{color:var(--green)} .warn{color:var(--amber)} .bad{color:var(--red)}
    .card{background:var(--panel);border-radius:var(--radius);padding:20px;margin:16px 0;box-shadow:0 0 0 1px rgba(255,255,255,.03) inset;transition:var(--t)}
    .card:hover{box-shadow:0 0 0 1px rgba(125,166,255,.1) inset}
    .pill{display:inline-flex;align-items:center;background:#13192a;border:1px solid #1f2740;color:var(--text);padding:8px 12px;border-radius:999px;font-weight:600;margin:6px 8px 0 0;transition:var(--t)}
    .pill:hover{border-color:var(--accent);transform:translateY(-1px)}
    .meta{color:var(--muted);font-size:13px}
    .gauge{display:flex;align-items:center;gap:24px;flex-wrap:wrap}
    .ringwrap{position:relative;width:180px;height:180px;flex-shrink:0}
    .ring{position:absolute;inset:0;border-radius:50%;isolation:isolate;z-index:0;
      background:conic-gradient(var(--green) 0deg 120deg, var(--amber) 120deg 216deg, var(--red) 216deg 360deg)}
    .ring::after{content:"";position:absolute;inset:20px;border-radius:50%;background:var(--panel);z-index:0}
    .score{position:absolute;inset:0;display:grid;place-items:center;font-weight:800;font-size:36px;z-index:2}
    .badge{display:inline-flex;align-items:center;padding:6px 12px;border-radius:10px;font-weight:800;letter-spacing:.4px;margin-left:12px}
    .badge.green{background:rgba(30,194,139,.15);color:var(--green);border:1px solid rgba(30,194,139,.35)}
    .badge.amber{background:rgba(255,194,71,.15);color:var(--amber);border:1px solid rgba(255,194,71,.35)}
    .badge.red{background:rgba(255,96,112,.17);color:var(--red);border:1px solid rgba(255,96,112,.35)}
    .callout{font-size:14px;color:var(--muted);line-height:1.4}
    .chart{position:relative;height:300px}
    canvas{width:100%!important;height:100%!important}
    .foot{margin-top:24px}
    .err{background:#2b1620;color:#ffdbe0;border:1px solid #57313f;padding:12px;border-radius:10px}
    @media (max-width:768px){.gauge{justify-content:center;text-align:center}.ringwrap{width:140px;height:140px}.score{font-size:28px}}
    @media (max-width:480px){.card{padding:16px}.pill{display:block;margin:6px 0;width:100%}}
  </style>
</head>
<body>
  <div class="wrap">
    <header role="banner">
      <h1>CrashRadar — Composite Crash Risk</h1>
      <div id="status" class="sub" aria-live="polite">Loading market data…</div>
    </header>

    <main role="main">
      <section aria-labelledby="composite-heading" class="card">
        <div class="gauge">
          <div class="ringwrap" aria-hidden="true">
            <div class="ring"></div>
            <div id="scoreText" class="score">–</div>
          </div>
          <div>
            <h2 id="composite-heading" style="margin:0 0 6px;font-size:26px">
              Composite Score <span id="garBadge" class="badge">—</span>
            </h2>
            <div class="callout">
              Lower scores indicate safer conditions.
              Risk thresholds: <b class="ok">Green ≤ 30</b>, <b class="warn">Amber ≤ 60</b>, <b class="bad">Red &gt; 60</b>.
            </div>
            <div class="meta" id="freshness" style="margin-top:8px">—</div>
            <div style="margin-top:16px" role="list">
              <span class="pill" id="pill_t10y3m" role="listitem">Yield (10y–3m): —</span>
              <span class="pill" id="pill_credit" role="listitem">Credit (BAA–AAA): —</span>
              <span class="pill" id="pill_un" role="listitem">Unemp Δ6m: —</span>
              <span class="pill" id="pill_dd" role="listitem">Drawdown 12m: —</span>
              <span class="pill" id="pill_nfci" role="listitem">NFCI: —</span>
            </div>
          </div>
        </div>
      </section>

      <section aria-labelledby="composite-chart-heading" class="card">
        <h3 id="composite-chart-heading" style="margin:0 0 8px">Composite Risk History (normalised 0–100)</h3>
        <div class="meta">Legend: <span class="ok">●</span> Green &nbsp; <span class="warn">●</span> Amber &nbsp; <span class="bad">●</span> Red</div>
        <div class="chart"><canvas id="compChart" aria-label="Composite risk score over time"></canvas></div>
        <div class="callout">Composite (30-day rolling average). Smoothed view of overall risk using recent readings.</div>
      </section>

      <div id="charts"></div>
    </main>

    <footer class="card foot" role="contentinfo">
      <h3 style="margin:0 0 12px;">Data & Diagnostics</h3>
      <details>
        <summary style="cursor:pointer;margin-bottom:8px;font-weight:600;">Technical Details</summary>
        <pre id="diag" style="white-space:pre-wrap;word-break:break-word;color:#ffdca8;background:#241d12;border:1px solid #4a3e20;border-radius:10px;padding:12px;max-height:420px;overflow:auto;margin:0;font-size:12px;"></pre>
      </details>
      <div class="meta" style="margin-top:12px;">Data sourced from FRED. Last updated: <span id="update-time">—</span></div>
    </footer>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3.1.1/dist/chartjs-plugin-annotation.min.js"></script>

  <script>
  class CrashRadar {
    constructor(){
      this.keys = ['T10Y3M','CREDIT','UN_SLOPE6','DD_12M','NFCI'];
      this.scales = {
        T10Y3M: v => this.clamp(this.map(v, 1.0, -2.0)),
        CREDIT: v => this.clamp(this.map(v, 0.3, 1.0)),
        UN_SLOPE6: v => this.clamp(this.map(v, 0.0, 0.6)),
        DD_12M: v => this.clamp(this.map(v, 0.0, -0.30)),
        NFCI: v => this.clamp(this.map(v, -0.8, 1.0)),
      };
      this.weights = {T10Y3M:0.25, CREDIT:0.25, UN_SLOPE6:0.20, DD_12M:0.20, NFCI:0.10};
      this.data = {raw:null, series:{}, latest:{}, composite:null};
      this.init();
    }

    // utils
    setStatus(msg, cls=''){ const el=document.getElementById('status'); el.textContent=msg; el.className='sub '+cls; }
    gbDate(d){ return new Date(d).toLocaleDateString('en-GB',{year:'numeric',month:'short',day:'2-digit'}); }
    safeNum(v){ return (v===null||v===undefined||isNaN(+v)) ? null : +v; }
    last(a){ return (a&&a.length)?a[a.length-1]:null; }
    clamp(x){ return Math.max(0, Math.min(100,x)); }
    map(val, good, bad){ if(val==null) return 50; const t=(val-good)/(bad-bad?bad-good:1); return t*100; } // guard div/0
    zoneOf(s){ return s<=30?'green':(s<=60?'amber':'red'); }

    async init(){
      this.setStatus('Loading market data…');
      try{
        const res = await fetch('data/fred_cache.json',{cache:'no-cache'});
        if(!res.ok) throw new Error(`HTTP ${res.status}`);
        this.data.raw = await res.json();
        this.setStatus('Cache file found and parsed.','ok');
        this.process(); this.render();
      }catch(e){
        this.setStatus('No cache yet — run the workflow','bad');
        document.getElementById('diag').textContent = 'Load error: '+e.message;
      }
    }

    process(){
      const S = this.data.raw?.series || {};
      for(const k of this.keys){
        const obs = S[k]?.observations || [];
        const xs=[], ys=[];
        for(const o of obs){
          const v = this.safeNum(o.value);
          if(v==null || !o.date) continue;
          xs.push(this.gbDate(o.date)); ys.push(v);
        }
        this.data.series[k] = {xs,ys};
        this.data.latest[k] = this.last(ys);
      }
      // composite now
      let comp=0;
      for(const k of this.keys){
        const sv = this.scales[k](this.data.latest[k]);
        comp += (isFinite(sv)?sv:50) * (this.weights[k]||0);
      }
      this.data.composite = Math.round(comp*10)/10;
    }

    render(){
      this.renderGauge();
      this.renderPills();
      this.renderCompositeChart();
      this.renderIndicatorCharts();
      this.renderDiagnostics();
    }

    renderGauge(){
      const c = this.data.composite, z=this.zoneOf(c);
      const badge = document.getElementById('garBadge'); badge.className='badge '+z; badge.textContent=z.toUpperCase();
      const scoreEl = document.getElementById('scoreText'); scoreEl.textContent=isFinite(c)?Math.round(c):'–';
      const ts = this.data.raw?.fetched_at_utc ? new Date(this.data.raw.fetched_at_utc) : null;
      document.getElementById('freshness').textContent = ts ? this.gbDate(ts)+' '+ts.toLocaleTimeString('en-GB',{hour:'2-digit',minute:'2-digit'}) : '—';
    }

    renderPills(){
      // explicit ID map (fixes the DeepSeek mismatch)
      const mapId = {
        T10Y3M:'pill_t10y3m',
        CREDIT:'pill_credit',
        UN_SLOPE6:'pill_un',
        DD_12M:'pill_dd',
        NFCI:'pill_nfci'
      };
      const labels = {
        T10Y3M:'Yield (10y–3m)',
        CREDIT:'Credit (BAA–AAA)',
        UN_SLOPE6:'Unemp Δ6m',
        DD_12M:'Drawdown 12m',
        NFCI:'NFCI'
      };
      const fmt = {
        T10Y3M:v=>v.toFixed(2),
        CREDIT:v=>v.toFixed(2),
        UN_SLOPE6:v=>v.toFixed(2),
        DD_12M:v=>(v*100).toFixed(1)+'%',
        NFCI:v=>v.toFixed(3)
      };
      for(const k of this.keys){
        const el = document.getElementById(mapId[k]);
        if(!el) continue; // defensive
        const v = this.data.latest[k];
        el.textContent = `${labels[k]}: ${v==null?'—':fmt[k](v)}`;
      }
    }

    renderCompositeChart(){
      const el = document.getElementById('compChart');
      const minLen = Math.min(...this.keys.map(k=>this.data.series[k].ys.length||Infinity));
      if(!isFinite(minLen) || minLen<3){
        el.closest('.card').querySelector('.chart').innerHTML = '<div class="err">Not enough overlapping history yet to draw composite.</div>';
        return;
      }
      const tail=minLen, xs=this.data.series.T10Y3M.xs.slice(-tail), ys=[];
      for(let i=-tail;i<0;i++){
        let v=0;
        for(const k of this.keys){
          v += this.scales[k](this.data.series[k].ys.at(i))*(this.weights[k]||0);
        }
        ys.push(Math.round(v*10)/10);
      }
      this.makeChart(el,{
        type:'line',
        data:{labels:xs,datasets:[{data:ys,borderColor:'#7da6ff',backgroundColor:'transparent'}]},
        options:this.baseOpts({scales:{y:{min:0,max:100}}})
      });
    }

    renderIndicatorCharts(){
      const cfgs=[
        {k:'T10Y3M', title:'Yield Curve (10y–3m)', desc:'<b>More negative = worse</b>. Inversions (below zero) often precede recessions and major drawdowns.', color:'#6bb9ff'},
        {k:'CREDIT', title:'Credit Spread (BAA–AAA)', desc:'<b>Wider = worse</b>. Rising lower-grade vs top-tier borrowing costs signal stress in corporate credit.', color:'#ffb36b'},
        {k:'UN_SLOPE6', title:'Unemployment 6-month slope', desc:'<b>Rising = worse</b>. Early labour-market deterioration is a classic late-cycle signal.', color:'#ffa0b5'},
        {k:'DD_12M', title:'12-month Drawdown (S&P vs 1-yr peak)', desc:'<b>More negative = worse</b>. Captures market-price stress, complementing macro/credit indicators.', color:'#a6c7ff'},
        {k:'NFCI', title:'Chicago Fed NFCI', desc:'<b>Higher = tighter/worse</b>. Summarises overall financial conditions (rates, credit, funding, volatility).', color:'#9bd3c1'}
      ];
      const host=document.getElementById('charts');
      for(const c of cfgs){
        const sec=document.createElement('section'); sec.className='card'; sec.setAttribute('aria-labelledby','chart-'+c.k);
        sec.innerHTML = `<h3 id="chart-${c.k}" style="margin:0 0 8px">${c.title}</h3>
          <div class="chart"><canvas id="c_${c.k}" aria-label="${c.title} over time"></canvas></div>
          <div class="callout">${c.desc}</div>`;
        host.appendChild(sec);
        const s=this.data.series[c.k];
        if(!s.ys.length){ sec.querySelector('.chart').innerHTML=`<div class="err">No data available for ${c.title}</div>`; continue; }
        this.makeChart(document.getElementById('c_'+c.k),{
          type:'line',
          data:{labels:s.xs,datasets:[{data:s.ys,borderColor:c.color,backgroundColor:'transparent'}]},
          options:this.baseOpts()
        });
      }
    }

    baseOpts(ovr={}){
      const base={
        responsive:true,maintainAspectRatio:false,
        scales:{
          x:{grid:{color:'rgba(255,255,255,.04)'},ticks:{color:'#9aa6bf',maxRotation:0,autoSkip:true}},
          y:{grid:{color:'rgba(255,255,255,.04)'},ticks:{color:'#9aa6bf'}}
        },
        plugins:{legend:{display:false},tooltip:{enabled:true}},
        elements:{line:{tension:.35,borderWidth:2},point:{radius:2,hitRadius:8}}
      };
      return {...base,...ovr,scales:{...base.scales,...(ovr.scales||{})}};
    }

    makeChart(el, cfg){
      try{
        // register annotation plugin defensively (won’t crash if missing)
        try{
          const ap = (window.ChartAnnotation || window['chartjs-plugin-annotation']);
          if(ap) Chart.register(ap);
        }catch(e){}
        return new Chart(el,cfg);
      }catch(e){
        console.error(e);
        el.closest('.chart').innerHTML = `<div class="err">Chart error: ${e.message}</div>`;
      }
    }

    renderDiagnostics(){
      const diag=document.getElementById('diag');
      const out={
        fetched_at_utc:this.data.raw?.fetched_at_utc||null,
        latest_values:Object.fromEntries(this.keys.map(k=>[k,this.data.latest[k]])),
        sample_sizes:Object.fromEntries(this.keys.map(k=>[k,this.data.series[k].ys.length])),
        composite:this.data.composite
      };
      diag.textContent = JSON.stringify(out,null,2);
      document.getElementById('update-time').textContent =
        new Date().toLocaleTimeString('en-GB',{hour:'2-digit',minute:'2-digit'});
    }
  }

  document.addEventListener('DOMContentLoaded',()=>new CrashRadar());
  </script>
</body>
</html>
