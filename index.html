<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>CrashRadar — Composite Crash Risk</title>
<meta name="description" content="CrashRadar — Composite Crash Risk (FRED cache, freshness, per-indicator charts, multi-timeframe composite)." />
<link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"/>

<style>
:root{
  --bg:#0f1421; --panel:#161c2e; --muted:#9aa6bf; --text:#e8eeff; --accent:#7da6ff;
  --green:#1ec28b; --amber:#ffc247; --red:#ff6070; --radius:16px;
  --ring:180px; --ring-m:140px;
  --safe-bg:rgba(30,194,139,.08); --warn-bg:rgba(255,194,71,.08); --danger-bg:rgba(255,96,112,.08);
}
*{box-sizing:border-box}
html,body{margin:0;background:var(--bg);color:var(--text);font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Inter,Helvetica,Arial}
.wrap{max-width:1280px;margin:0 auto;padding:20px 16px 64px}
h1{font-size:clamp(28px,5.5vw,44px);line-height:1.1;margin:0 0 8px}
.sub{color:var(--muted);margin:6px 0 18px;font-size:14px}
.card{background:var(--panel);border-radius:var(--radius);padding:20px;margin:16px 0;border:1px solid rgba(255,255,255,.05)}
.meta{color:var(--muted);font-size:13px}

/* Gauge */
.gauge-row{display:flex;gap:24px;align-items:center;flex-wrap:wrap}
.multi-gauge{position:relative;width:var(--ring);height:var(--ring)}
.ring{position:absolute;inset:0;border-radius:50%;
  background:conic-gradient(var(--green) 0 120deg, var(--amber) 120deg 216deg, var(--red) 216deg 360deg);opacity:.85}
.ring-outer{width:calc(var(--ring) + 40px);height:calc(var(--ring) + 40px);inset:-20px;opacity:.5}
.ring-middle{width:calc(var(--ring) + 20px);height:calc(var(--ring) + 20px);inset:-10px;opacity:.7}
.ring::after{content:"";position:absolute;inset:20px;border-radius:50%;background:var(--panel)}
.ring-outer::after{inset:25px}.ring-middle::after{inset:22px}
.score{position:absolute;inset:0;display:grid;place-items:center;font-weight:800;font-size:40px;z-index:2}
.needle{position:absolute;inset:0;pointer-events:none}
.needle::after{content:"";width:8px;height:8px;border-radius:50%;background:var(--accent);
  transform:rotate(var(--angle,0deg)) translateY(calc(-1 * (var(--ring)/2 - 10px)));
  transform-origin:center center;display:block;margin:auto;box-shadow:0 0 0 3px var(--panel)}
.tf-badges{display:flex;gap:8px;margin-top:8px}
.badge{border:1px solid #1f2740;background:#13192a;border-radius:999px;padding:6px 10px;font-size:12px}

/* Tabs / Pills */
.tabs{display:flex;gap:8px;margin-bottom:16px;border-bottom:1px solid rgba(255,255,255,.08)}
.tab{padding:8px 14px;border-radius:6px 6px 0 0;cursor:pointer}
.tab.active{background:rgba(125,166,255,.1);color:var(--accent)}
.pill{display:inline-flex;align-items:center;gap:8px;background:#13192a;border:1px solid #1f2740;color:var(--text);
  padding:8px 12px;border-radius:999px;font-weight:600;margin:6px 8px 0 0;cursor:pointer}
.pill .dot{width:8px;height:8px;border-radius:50%}

/* Heatmap */
.heat{display:grid;grid-template-columns:repeat(auto-fill,minmax(150px,1fr));gap:12px}
.tile{background:#13192a;border:1px solid #1f2740;border-radius:10px;padding:12px}
.tlabel{font-size:12px;color:var(--muted)}
.tval{font-weight:700;font-size:18px;margin-top:6px}

/* Progress */
.progress{margin:10px 0}
.progress-head{display:flex;justify-content:space-between;font-size:13px}
.bar{height:6px;background:#1f2740;border-radius:3px;overflow:hidden}
.fill{height:100%;background:var(--accent)}

/* Alert */
.alert{display:none;gap:10px;align-items:center;border-left:4px solid var(--amber);background:var(--warn-bg);padding:12px;border-radius:6px;margin:16px 0}
.alert.danger{border-left-color:var(--red);background:var(--danger-bg)}
.alert.safe{border-left-color:var(--green);background:var(--safe-bg)}

/* Chart */
.chart{position:relative;height:300px}
canvas{width:100%!important;height:100%!important}

details summary{cursor:pointer;font-weight:600}
pre{white-space:pre-wrap;word-break:break-word;background:#241d12;color:#ffdca8;border:1px solid #4a3e20;border-radius:10px;padding:12px;max-height:360px;overflow:auto;font-size:12px}

/* Responsive */
@media (max-width:768px){
  .gauge-row{justify-content:center;text-align:center}
  .multi-gauge{width:var(--ring-m);height:var(--ring-m)}
  .ring-outer{width:calc(var(--ring-m) + 40px);height:calc(var(--ring-m) + 40px);inset:-20px}
  .ring-middle{width:calc(var(--ring-m) + 20px);height:calc(var(--ring-m) + 20px);inset:-10px}
}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <h1>Economic Crash Radar <span style="color:var(--accent);font-size:.7em">Advanced</span></h1>
    <div id="status" class="sub" aria-live="polite">Loading…</div>
  </header>

  <main>
    <div id="alert" class="alert"><i class="fa-solid fa-triangle-exclamation"></i><div id="alertMsg"></div></div>

    <!-- Gauge -->
    <section class="card">
      <div class="gauge-row">
        <div class="multi-gauge">
          <div class="ring ring-outer" title="12-month composite"></div>
          <div class="ring ring-middle" title="3-month composite"></div>
          <div class="ring" title="Current composite"></div>
          <div id="needle" class="needle"></div>
          <div id="scoreNow" class="score">–</div>
        </div>
        <div>
          <h2 style="margin:0 0 8px">Multi-Timeframe Composite</h2>
          <div class="meta">Risk zones: <b style="color:var(--green)">≤30 Green</b>, <b style="color:var(--amber)">≤60 Amber</b>, <b style="color:var(--red)">>60 Red</b></div>
          <div id="fresh" class="meta" style="margin-top:6px">—</div>
          <div id="reg" class="meta" style="margin-top:6px">—</div>
          <div class="tf-badges" style="margin-top:8px">
            <span id="bNow" class="badge">Now: —</span>
            <span id="b3m" class="badge">3m: —</span>
            <span id="b12m" class="badge">12m: —</span>
          </div>
        </div>
      </div>
    </section>

    <!-- Attribution -->
    <section class="card">
      <h3 style="margin:0 0 10px">Risk Attribution</h3>
      <div id="attrib"></div>
      <div class="meta" id="attribSum" style="margin-top:6px"></div>
    </section>

    <!-- Indicator dashboard -->
    <section class="card">
      <h3 style="margin:0 0 8px">Indicator Dashboard</h3>
      <div class="tabs">
        <div class="tab active" data-tab="market">Market</div>
        <div class="tab" data-tab="liquidity">Liquidity</div>
        <div class="tab" data-tab="corporate">Corporate</div>
        <div class="tab" data-tab="real">Real Economy</div>
      </div>
      <div id="pills"></div>
    </section>

    <!-- Heatmap -->
    <section class="card">
      <h3 style="margin:0 0 8px">Indicator Heat Map</h3>
      <div id="heat" class="heat"></div>
    </section>

    <!-- Composite chart -->
    <section class="card">
      <h3 style="margin:0 0 6px">Composite History (7-day MA)</h3>
      <div class="meta">Bands: 0–30 Green, 30–60 Amber, 60–100 Red. Gauge shows raw latest.</div>
      <div class="chart"><canvas id="compChart" aria-label="Composite (7-day MA)"></canvas></div>
    </section>

    <!-- Indicator charts -->
    <div id="charts"></div>

    <!-- Diagnostics -->
    <section class="card">
      <h3 style="margin:0 0 8px">Data & Diagnostics</h3>
      <details>
        <summary>Technical Details</summary>
        <pre id="diag"></pre>
      </details>
      <div class="meta" style="margin-top:8px">Live data source: <code>data/fred_cache.json</code></div>
    </section>
  </main>
</div>

<!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3.1.1/dist/chartjs-plugin-annotation.min.js"></script>

<script>
/* ---------- CONFIG ---------- */
const KEYS = [
  'T10Y3M','CREDIT','UN_SLOPE6','DD_12M','NFCI',
  'VIX','TEDRATE','BAMLH0A0HYM2','INDPRO','CSUSHPINSA','EMRATIO','UMCSENT','USEPUINDXD'
];

const BASE_WEIGHTS = {
  T10Y3M:.18, CREDIT:.12, UN_SLOPE6:.10, DD_12M:.15, NFCI:.10,
  VIX:.08, TEDRATE:.07, BAMLH0A0HYM2:.08, INDPRO:.04, CSUSHPINSA:.03, EMRATIO:.02, UMCSENT:.02, USEPUINDXD:.01
};

const SCALE = {
  T10Y3M: v => clamp(map01(v, 1.0, -2.0)),
  CREDIT: v => clamp(map01(v, 0.30, 1.00)),
  UN_SLOPE6: v => clamp(map01(v, 0.05, 0.50)),
  DD_12M: v => clamp(map01(v, 0.00, -0.20)),
  NFCI: v => clamp(map01(v, -0.80, 0.40)),
  VIX: v => clamp(map01(v, 12, 40)),
  TEDRATE: v => clamp(map01(v, 0.10, 2.00)),
  BAMLH0A0HYM2: v => clamp(map01(v, 3.0, 10.0)),
  INDPRO: v => clamp(map01(v, 2.0, -8.0)),
  CSUSHPINSA: v => clamp(map01(v, 5.0, -10.0)),
  EMRATIO: v => clamp(map01(v, -0.5, -3.0)),
  UMCSENT: v => clamp(map01(v, -5.0, -20.0)),
  USEPUINDXD: v => clamp(map01(v, 100, 300))
};

const CADENCE = {
  T10Y3M:'daily', CREDIT:'monthly', UN_SLOPE6:'monthly', DD_12M:'daily', NFCI:'weekly',
  VIX:'daily', TEDRATE:'daily', BAMLH0A0HYM2:'daily', INDPRO:'monthly', CSUSHPINSA:'monthly', EMRATIO:'monthly', UMCSENT:'monthly', USEPUINDXD:'monthly'
};
const FRESH = {daily:{ok:7,warn:30},weekly:{ok:7,warn:30},monthly:{ok:30,warn:60}};

/* ---------- UTILS ---------- */
const clamp = x => Math.max(0, Math.min(100, x));
function map01(val, good, bad){ if(val==null) return 50; const d=bad-good; if(Math.abs(d)<1e-9) return 50; return ((val-good)/d)*100; }
const zone = s => s<=30?'green':(s<=60?'amber':'red');
const gbAsOf = ts => ts ? new Date(ts).toLocaleString('en-GB',{hour:'2-digit',minute:'2-digit',day:'2-digit',month:'short',year:'numeric'}) : '—';
function latest(series){ const obs=series?.observations||[]; if(!obs.length) return null; const o=obs[obs.length-1]; return {value:+o.value,date:o.date}; }
function ageDays(series, fetched){ const L=latest(series); if(!L) return Infinity; return Math.max(0, Math.round((new Date(fetched)-new Date(L.date+"T00:00:00Z"))/86400000)); }
function freshnessPenalty(days,cad){ const lim=FRESH[cad]||FRESH.daily; if(days<=lim.ok) return 1; if(days<=lim.warn) return .85; return .7; }
const mean = a => a.reduce((x,y)=>x+y,0)/a.length;
function movingAvg(a,k){const out=[];let s=0;for(let i=0;i<a.length;i++){s+=a[i]; if(i>=k) s-=a[i-k]; out.push(i>=k-1? +(s/k).toFixed(1):null)} return out;}

/* ---------- STATE ---------- */
const App = {
  raw:null, fetched:null, latestVals:{}, ages:{}, weights:{}, compNow:null, comp3m:null, comp12m:null,
  compRaw:[], compMA7:[], xs:[], charts:new Map(), activeTab:'market'
};

/* ---------- BOOT ---------- */
init();
async function init(){
  setStatus('Loading…');
  let res;
  try{
    const ctl=new AbortController(); const to=setTimeout(()=>ctl.abort(),10000);
    res = await fetch('data/fred_cache.json',{cache:'no-cache',signal:ctl.signal});
    clearTimeout(to);
  }catch(e){
    emptyState('Failed to load: '+(e.message||e));
    return;
  }
  if(!res || !res.ok){ emptyState('Cache not found (data/fred_cache.json).'); return; }
  try{ App.raw = await res.json(); }catch{ emptyState('Cache is not valid JSON.'); return; }
  if(!App.raw.series){ emptyState('Cache missing "series".'); return; }
  App.fetched = App.raw.fetched_at_utc || null;
  setStatus('Ready');

  compute();
  renderAll();
  wireUI();
}

/* ---------- COMPUTE ---------- */
function compute(){
  const S = App.raw.series;
  // compute weights (no regime multiplier to keep math transparent)
  App.weights = {...BASE_WEIGHTS};

  // latest values + ages
  for(const k of KEYS){
    const L = latest(S[k]);
    App.latestVals[k] = L ? L.value : null;
    App.ages[k] = ageDays(S[k], App.fetched || new Date().toISOString());
  }

  // composite NOW
  let sum=0, wsum=0;
  for(const k of KEYS){
    const v = App.latestVals[k]; if(v==null) continue;
    const r = SCALE[k](v);
    const pen = freshnessPenalty(App.ages[k], CADENCE[k]);
    const w = App.weights[k];
    sum += r*w*pen; wsum += w;
  }
  App.compNow = wsum ? Math.round(sum/wsum) : null;

  // 3m and 12m composites (value from 63 and 252 obs back if available)
  App.comp3m = compositeAtOffset(S, 63);
  App.comp12m = compositeAtOffset(S, 252);

  // history (align to shortest)
  const arrays = KEYS.map(k => (S[k]?.observations||[]));
  const minLen = Math.min(...arrays.map(a=>a.length||0));
  const n = Math.min(minLen, 240);
  App.xs = (S[KEYS[0]]?.observations||[]).slice(-n).map(o=>o.date);

  const comp=[];
  for(let i=arrays[0].length-n;i<arrays[0].length;i++){
    let t=0,w=0;
    for(const k of KEYS){
      const obs=S[k]?.observations||[];
      const v = +obs[i]?.value;
      if(Number.isFinite(v)){ t+= SCALE[k](v) * App.weights[k]; w+= App.weights[k]; }
    }
    comp.push(w? +(t/w).toFixed(1) : null);
  }
  App.compRaw = comp;
  App.compMA7 = movingAvg(comp, 7);
}

function compositeAtOffset(S, off){
  let sum=0, wsum=0;
  for(const k of KEYS){
    const obs=S[k]?.observations||[];
    if(obs.length<=off) continue;
    const v = +obs[obs.length-1-off].value;
    if(!Number.isFinite(v)) continue;
    const r=SCALE[k](v);
    const pen=freshnessPenalty(App.ages[k], CADENCE[k]);
    sum += r*App.weights[k]*pen; wsum += App.weights[k];
  }
  return wsum? Math.round(sum/wsum) : null;
}

/* ---------- RENDER ---------- */
function renderAll(){
  renderGauge();
  renderAlert();
  renderAttribution();
  renderPills();
  renderHeatmap();
  renderCompositeChart();
  renderIndicatorCharts();
  renderDiag();
}

function renderGauge(){
  const now=App.compNow, m3=App.comp3m, y12=App.comp12m;
  document.getElementById('scoreNow').textContent = numOrDash(now);
  setNeedle(now);
  document.getElementById('bNow').textContent = `Now: ${numOrDash(now)}`;
  document.getElementById('b3m').textContent  = `3m: ${numOrDash(m3)}`;
  document.getElementById('b12m').textContent = `12m: ${numOrDash(y12)}`;
  document.getElementById('fresh').textContent = `AS-OF ${gbAsOf(App.fetched)}`;
  const regime = now==null?'—':zone(now).toUpperCase();
  document.getElementById('reg').innerHTML = `Regime: <b style="color:${zoneColor(now)}">${regime}</b>`;
}

function setNeedle(score){
  const el=document.getElementById('needle');
  const ang = Number.isFinite(score)? (score/100)*360 : 180;
  el.style.setProperty('--angle', ang+'deg');
}

function renderAlert(){
  const box=document.getElementById('alert'), msg=document.getElementById('alertMsg');
  const s=App.compNow;
  if(!Number.isFinite(s)){ box.style.display='none'; return; }
  if(s>70){ box.className='alert danger'; msg.innerHTML=`<b>High Risk:</b> Composite ${s}. Consider defensive positioning.`; box.style.display='flex'; }
  else if(s>50){ box.className='alert'; msg.innerHTML=`<b>Moderate Risk:</b> Composite ${s}. Monitor indicators closely.`; box.style.display='flex'; }
  else{ box.className='alert safe'; msg.innerHTML=`<b>Low/Normal Risk:</b> Composite ${s}.`; box.style.display='flex'; }
}

function renderAttribution(){
  const host=document.getElementById('attrib'); host.innerHTML='';
  // contribution = risk * weight * freshness, then normalized to 100%
  const contrib=[], labels = niceLabels();
  let total=0;
  for(const k of KEYS){
    const v=App.latestVals[k]; if(v==null) continue;
    const c = SCALE[k](v) * App.weights[k] * freshnessPenalty(App.ages[k], CADENCE[k]);
    contrib.push([k, c]); total+=c;
  }
  contrib.sort((a,b)=>b[1]-a[1]);
  let shown=0, acc=0;
  contrib.forEach(([k,c],i)=>{
    const pct = total? (i===contrib.length-1 ? 100-acc : Math.round((c/total)*100)) : 0;
    acc += pct; shown += pct;
    const row=document.createElement('div');
    row.className='progress';
    row.innerHTML=`
      <div class="progress-head"><span>${labels[k]||k}</span><span>${pct}%</span></div>
      <div class="bar"><div class="fill" style="width:${pct}%"></div></div>`;
    host.appendChild(row);
  });
  document.getElementById('attribSum').textContent = `Sum: ${shown}% (normalized)`;
}

function renderPills(){
  const groups = {
    market:['T10Y3M','DD_12M','VIX'],
    liquidity:['NFCI','TEDRATE'],
    corporate:['CREDIT','BAMLH0A0HYM2'],
    real:['UN_SLOPE6','INDPRO','CSUSHPINSA','EMRATIO','UMCSENT','USEPUINDXD']
  };
  const order = groups[App.activeTab]||[];
  const host=document.getElementById('pills'); host.innerHTML='';
  const fmt = formatters(), labels = niceLabels();
  order.forEach(k=>{
    if(!KEYS.includes(k)) return;
    const v=App.latestVals[k], dot = freshnessDot(App.ages[k], CADENCE[k]);
    const pill=document.createElement('span');
    pill.className='pill'; pill.dataset.indicator=k; pill.title=explain(k);
    pill.innerHTML=`<span class="dot" style="background:${dot}"></span>${labels[k]||k}: ${v==null?'—':fmt[k](v)}`;
    host.appendChild(pill);
  });
}

function renderHeatmap(){
  const host=document.getElementById('heat'); host.innerHTML='';
  const labels=niceLabels();
  for(const k of KEYS){
    const v=App.latestVals[k]; if(v==null) continue;
    const r=SCALE[k](v); const z=zone(r);
    const tile=document.createElement('div'); tile.className='tile';
    tile.style.borderColor = zoneColor(r); tile.style.background = zoneBg(r);
    tile.innerHTML = `<div class="tlabel">${labels[k]||k}</div>
                      <div class="tval" style="color:${zoneColor(r)}">${Math.round(r)}</div>
                      <div class="tlabel">Weight: ${Math.round(App.weights[k]*100)}%</div>`;
    host.appendChild(tile);
  }
}

function renderCompositeChart(){
  const el=document.getElementById('compChart');
  const ds = App.compMA7.filter(x=>x!=null);
  if(!ds.length){ el.closest('.chart').innerHTML='<div class="meta">No data.</div>'; return; }
  try{ if(!Chart.registry.getPlugin('annotation')) Chart.register(window['chartjs-plugin-annotation']); }catch{}
  const prev=App.charts.get(el); if(prev) prev.destroy();

  const labels = App.xs.map(s=>{
    const D=new Date(s+"T00:00:00Z");
    return isNaN(D)? s : D.toLocaleDateString('en-GB',{month:'short',year:'2-digit'});
  });

  const chart=new Chart(el,{type:'line',
    data:{labels, datasets:[{label:'Composite (7-day MA)',data:App.compMA7,borderColor:'#7da6ff',backgroundColor:'rgba(125,166,255,.12)',fill:true,pointRadius:0,tension:.35,spanGaps:true}]},
    options:{
      responsive:true,maintainAspectRatio:false,
      scales:{
        y:{min:0,max:100,grid:{color:'rgba(255,255,255,.06)'},ticks:{color:'#9aa6bf'}},
        x:{grid:{color:'rgba(255,255,255,.04)'},ticks:{color:'#9aa6bf',maxTicksLimit:6}}
      },
      plugins:{
        legend:{display:false},
        annotation:{annotations:{
          g:{type:'box',yMin:0,yMax:30,backgroundColor:'rgba(30,194,139,.06)',borderWidth:0},
          a:{type:'box',yMin:30,yMax:60,backgroundColor:'rgba(255,194,71,.05)',borderWidth:0},
          r:{type:'box',yMin:60,yMax:100,backgroundColor:'rgba(255,96,112,.05)',borderWidth:0},
          gl:{type:'line',yMin:30,yMax:30,borderColor:'rgba(30,194,139,.6)',borderDash:[6,4]},
          al:{type:'line',yMin:60,yMax:60,borderColor:'rgba(255,194,71,.7)',borderDash:[6,4]}
        }}
      }
    }
  });
  App.charts.set(el, chart);
}

function renderIndicatorCharts(){
  const host=document.getElementById('charts'); host.innerHTML='';
  const S=App.raw.series;
  const list = [
    ['T10Y3M','Yield Curve (10y–3m)','More negative = worse.',true,'#6bb9ff'],
    ['CREDIT','Credit Spread (BAA–AAA)','Wider = worse.',false,'#ffb36b'],
    ['UN_SLOPE6','Unemployment 6-month slope','Rising = worse.',true,'#ffa0b5'],
    ['DD_12M','12-month Drawdown','More negative = worse.',true,'#a6c7ff'],
    ['NFCI','Chicago Fed NFCI','Higher = tighter/worse.',true,'#9bd3c1'],
    ['VIX','CBOE VIX','Higher = worse.',false,'#ff7b7b'],
    ['TEDRATE','TED Spread','Wider = worse.',false,'#c97bff'],
    ['BAMLH0A0HYM2','High-Yield Spread','Wider = worse.',false,'#7bffc2'],
  ];
  list.forEach(([k,title,desc,zero,color])=>{
    const sec=document.createElement('section'); sec.className='card';
    sec.innerHTML=`<h3 style="margin:0 0 8px">${title}</h3>
      <div class="chart"><canvas id="c_${k}" aria-label="${title}"></canvas></div>
      <div class="meta">${desc}</div>`;
    host.appendChild(sec);
    const obs=(S[k]?.observations||[]).slice(-180);
    const el = sec.querySelector('canvas');
    if(!obs.length){ el.parentElement.innerHTML='<div class="meta">No data.</div>'; return; }
    const xs=obs.map(o=>o.date), ys=obs.map(o=>+o.value);
    const prev=App.charts.get(el); if(prev) prev.destroy();
    const chart=new Chart(el,{type:'line',
      data:{labels:xs,datasets:[{data:ys,borderColor:color,backgroundColor:'transparent',pointRadius:0,tension:.35}]},
      options:{
        responsive:true,maintainAspectRatio:false,
        scales:{
          x:{grid:{color:'rgba(255,255,255,.04)'},ticks:{color:'#9aa6bf',maxTicksLimit:6,callback:(v,i,t)=>fmtX(t?.[i]?.label)}},
          y:{grid:{color:'rgba(255,255,255,.06)'},ticks:{color:'#9aa6bf'}}
        },
        plugins:{legend:{display:false},annotation: zero? {annotations:{z:{type:'line',yMin:0,yMax:0,borderColor:'rgba(154,166,191,.6)',borderDash:[4,4]}}}:{}}
      }
    });
    App.charts.set(el,chart);
  });
}

function renderDiag(){
  const diag=document.getElementById('diag');
  const out = {
    fetched_at_utc: App.fetched || null,
    sample_sizes: Object.fromEntries(KEYS.map(k=>[k,(App.raw.series[k]?.observations||[]).length])),
    latest_values: App.latestVals,
    ages_days: App.ages,
    weights: App.weights,
    composite_now: App.compNow,
    composite_3m: App.comp3m,
    composite_12m: App.comp12m,
    calc_ts: new Date().toISOString()
  };
  diag.textContent = JSON.stringify(out,null,2);
}

/* ---------- UI ---------- */
function wireUI(){
  document.querySelectorAll('.tab').forEach(t=>{
    t.addEventListener('click',()=>{
      document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
      t.classList.add('active');
      App.activeTab = t.dataset.tab; renderPills();
    });
  });
  document.addEventListener('click',(e)=>{
    const pill = e.target.closest?.('.pill'); if(!pill) return;
    const k = pill.dataset.indicator;
    alert(detailText(k));
  });
}

/* ---------- HELPERS ---------- */
function setStatus(t){ const el=document.getElementById('status'); if(el) el.textContent=t; }
function emptyState(msg){
  setStatus('Error');
  document.getElementById('diag').textContent = msg;
  document.getElementById('alert').style.display='none';
}
function numOrDash(x){ return Number.isFinite(x)? x : '—'; }
function zoneColor(s){
  if(!Number.isFinite(s)) return '#9aa6bf';
  return s<=30?'var(--green)':(s<=60?'var(--amber)':'var(--red)');
}
function zoneBg(s){
  if(!Number.isFinite(s)) return '#13192a';
  return s<=30?'var(--safe-bg)':(s<=60?'var(--warn-bg)':'var(--danger-bg)');
}
function freshnessDot(days,c){ const lim=FRESH[c]||FRESH.daily; if(days<=lim.ok) return 'var(--green)'; if(days<=lim.warn) return 'var(--amber)'; return 'var(--red)'; }
function niceLabels(){
  return {
    T10Y3M:'Yield Curve', CREDIT:'Credit Spread', UN_SLOPE6:'Unemp Δ(6m)',
    DD_12M:'Drawdown 12m', NFCI:'NFCI', VIX:'VIX',
    TEDRATE:'TED Spread', BAMLH0A0HYM2:'HY Spread', INDPRO:'Industrial Prod.',
    CSUSHPINSA:'Housing (Case-Shiller)', EMRATIO:'Employment Ratio',
    UMCSENT:'Consumer Sentiment', USEPUINDXD:'Policy Uncertainty'
  };
}
function formatters(){
  return {
    T10Y3M:v=>v?.toFixed(2), CREDIT:v=>v?.toFixed(2), UN_SLOPE6:v=>v?.toFixed(2),
    DD_12M:v=>((v??0)*100).toFixed(1)+'%', NFCI:v=>v?.toFixed(3), VIX:v=>v?.toFixed(1),
    TEDRATE:v=>v?.toFixed(2), BAMLH0A0HYM2:v=>v?.toFixed(2), INDPRO:v=>v?.toFixed(1)+'%',
    CSUSHPINSA:v=>v?.toFixed(1)+'%', EMRATIO:v=>v?.toFixed(1)+'%', UMCSENT:v=>v?.toFixed(0),
    USEPUINDXD:v=>v?.toFixed(0)
  };
}
function explain(k){
  const map={
    T10Y3M:'More negative = worse (inversions often precede recessions).',
    CREDIT:'Wider = worse (BAA–AAA).',
    UN_SLOPE6:'Rising unemployment over 6 months = worse.',
    DD_12M:'More negative = worse (price stress).',
    NFCI:'Higher = tighter/worse; >0 tighter than average.',
    VIX:'Higher = more market fear/worse.',
    TEDRATE:'Wider = interbank stress/worse.',
    BAMLH0A0HYM2:'Wider = corporate credit stress/worse.',
    INDPRO:'Negative = contracting activity/worse.',
    CSUSHPINSA:'Negative = falling home prices/worse.',
    EMRATIO:'Declining = weakening labor market/worse.',
    UMCSENT:'Declining = worsening sentiment/worse.',
    USEPUINDXD:'Higher = more policy uncertainty/worse.'
  }; return map[k]||k;
}
function detailText(k){
  const v = App.latestVals[k]; const fmt = formatters();
  return `${niceLabels()[k]||k}\nValue: ${v==null?'—':fmt[k](v)}\nRisk (0–100): ${v==null?'—':Math.round(SCALE[k](v))}\n${explain(k)}`;
}
function fmtX(raw){
  const D=new Date(raw+"T00:00:00Z");
  return isNaN(D)? raw : D.toLocaleDateString('en-GB',{month:'short',year:'2-digit'});
}
</script>
</body>
</html>
