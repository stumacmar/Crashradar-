<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="description" content="Economic Crash Radar - Real-time market stress monitoring with actionable risk intelligence" />
  <title>Economic Crash Radar</title>

  <style>
    :root{
      --bg:#0a0e1a; --panel:#12182b; --panel-hover:#151d33; --muted:#8b96b0;
      --text:#e8eeff; --accent:#6b9eff; --accent-bright:#8fb4ff;
      --green:#1ec28b; --amber:#ffc247; --red:#ff6070; --orange:#ff8c42;
      --radius:14px; --shadow:0 4px 24px rgba(0,0,0,.3);
      --ring:200px; --ring-m:160px;
    }
    *{box-sizing:border-box}
    html,body{margin:0;background:var(--bg);color:var(--text);
      font:15px/1.6 -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Inter,Helvetica,Arial,sans-serif}
    .wrap{max-width:1400px;margin:0 auto;padding:20px 16px 80px}

    header{margin-bottom:24px}
    h1{font-size:clamp(32px,5vw,48px);line-height:1.1;margin:0 0 8px;
      background:linear-gradient(135deg,var(--text),var(--accent-bright));
      -webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
    .subtitle{color:var(--muted);font-size:15px;margin:8px 0}

    .card{background:var(--panel);border-radius:var(--radius);padding:24px;margin:20px 0;
      box-shadow:var(--shadow),0 0 0 1px rgba(255,255,255,.04) inset;transition:transform .2s,box-shadow .2s}
    .card:hover{transform:translateY(-2px);box-shadow:0 6px 32px rgba(0,0,0,.4)}

    .gauge-container{display:flex;align-items:center;gap:32px;flex-wrap:wrap}
    .gauge-wrap{position:relative;width:var(--ring);height:var(--ring)}
    .multi-ring{position:absolute;inset:0}
    .ring{position:absolute;border-radius:50%;transition:opacity .3s}
    .ring-outer{inset:0;background:conic-gradient(var(--green)0 108deg,var(--amber)108deg 216deg,var(--red)216deg 360deg);opacity:.3}
    .ring-mid{inset:15px;background:conic-gradient(var(--green)0 108deg,var(--amber)108deg 216deg,var(--red)216deg 360deg);opacity:.5}
    .ring-inner{inset:30px;background:conic-gradient(var(--green)0 108deg,var(--amber)108deg 216deg,var(--red)216deg 360deg)}
    .ring::after{content:"";position:absolute;inset:20px;border-radius:50%;background:var(--panel)}
    .needle{position:absolute;inset:0;transition:transform .6s cubic-bezier(.34,1.56,.64,1)}
    .needle::before{content:"";position:absolute;top:50%;left:50%;width:4px;height:45%;
      background:linear-gradient(180deg,var(--accent-bright),var(--accent));
      transform:translateX(-50%) translateY(-100%) rotate(var(--angle,0deg));
      transform-origin:bottom center;border-radius:4px;box-shadow:0 0 12px var(--accent)}
    .needle::after{content:"";position:absolute;top:50%;left:50%;width:16px;height:16px;background:var(--accent-bright);
      border-radius:50%;transform:translate(-50%,-50%);box-shadow:0 0 16px var(--accent),0 0 0 3px var(--panel)}
    .score{position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;font-weight:800;font-size:48px;line-height:1}
    .score-label{font-size:12px;font-weight:600;color:var(--muted);margin-top:4px;letter-spacing:.5px}

    .gauge-info h2{font-size:28px;margin:0 0 8px;font-weight:700}
    .confidence{display:inline-flex;align-items:center;gap:8px;background:rgba(107,158,255,.15);padding:6px 12px;border-radius:8px;font-size:13px;font-weight:600;margin-top:8px}
    .confidence-bar{width:60px;height:6px;background:rgba(255,255,255,.1);border-radius:3px;overflow:hidden}
    .confidence-fill{height:100%;background:var(--accent);border-radius:3px;transition:width .3s}

    .pills-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:12px}
    .pill{background:rgba(255,255,255,.03);border:1px solid rgba(255,255,255,.06);padding:14px 16px;border-radius:12px;transition:all .2s;cursor:pointer;position:relative}
    .pill:hover{background:rgba(255,255,255,.06);border-color:rgba(255,255,255,.12);transform:translateY(-2px)}
    .pill:hover .pill-tooltip{opacity:1;visibility:visible;transform:translateY(0)}
    .pill-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px}
    .pill-title{font-weight:600;font-size:13px}
    .pill-badge{font-size:11px;padding:3px 8px;border-radius:6px;font-weight:600}
    .pill-value{font-size:20px;font-weight:700;margin:4px 0}
    .pill-change{font-size:12px;color:var(--muted);display:flex;align-items:center;gap:4px}
    .pill-status{display:inline-block;width:8px;height:8px;border-radius:50%;margin-left:8px}
    .pill-status-green{background:var(--green)}
    .pill-status-amber{background:var(--amber)}
    .pill-status-red{background:var(--red)}
    .pill-tooltip{position:absolute;bottom:calc(100% + 8px);left:50%;transform:translateX(-50%) translateY(-4px);
      background:var(--panel-hover);border:1px solid rgba(255,255,255,.12);padding:12px;border-radius:8px;
      font-size:12px;line-height:1.5;color:var(--text);width:280px;z-index:100;
      box-shadow:0 8px 24px rgba(0,0,0,.4);opacity:0;visibility:hidden;transition:all .2s;pointer-events:none}
    .pill-tooltip::after{content:"";position:absolute;top:100%;left:50%;transform:translateX(-50%);
      border:6px solid transparent;border-top-color:var(--panel-hover)}
    .badge-fresh{background:rgba(30,194,139,.15);color:var(--green)}
    .badge-stale{background:rgba(255,194,71,.15);color:var(--amber)}
    .badge-old{background:rgba(255,96,112,.15);color:var(--red)}
    .info-tooltip{display:inline-block;width:16px;height:16px;line-height:16px;text-align:center;
      background:rgba(255,255,255,.1);border-radius:50%;font-size:11px;font-weight:700;
      cursor:help;margin-left:6px;color:var(--accent-bright)}
    .info-tooltip:hover{background:rgba(255,255,255,.2)}

    .chart-container{position:relative;height:320px;margin:16px 0}
    .chart-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;flex-wrap:wrap;gap:12px}
    .chart-title{font-size:18px;font-weight:600;margin:0}
    .chart-controls{display:flex;gap:8px}
    .btn-group{display:flex;gap:4px;background:rgba(255,255,255,.03);padding:4px;border-radius:8px}
    .btn{background:transparent;border:none;color:var(--muted);padding:6px 14px;border-radius:6px;cursor:pointer;font-size:13px;font-weight:500;transition:all .2s}
    .btn:hover{color:var(--text);background:rgba(255,255,255,.06)}
    .btn.active{background:var(--accent);color:#fff}

    .tabs{display:flex;gap:8px;border-bottom:2px solid rgba(255,255,255,.06);margin-bottom:20px;overflow-x:auto}
    .tab{background:transparent;border:none;color:var(--muted);padding:12px 20px;cursor:pointer;font-size:14px;font-weight:600;position:relative;white-space:nowrap}
    .tab:hover{color:var(--text)}
    .tab.active{color:var(--accent-bright)}
    .tab.active::after{content:"";position:absolute;bottom:-2px;left:0;right:0;height:2px;background:var(--accent)}
    .tab-content{display:none}
    .tab-content.active{display:block}

    .status{display:inline-flex;align-items:center;gap:8px;padding:8px 14px;border-radius:8px;font-weight:600;font-size:13px}
    .status-dot{width:8px;height:8px;border-radius:50%}

    .audit{font-size:12px;color:var(--muted);margin-top:8px}
    .audit .bad{color:#ff9da6}
    .audit .warn{color:#ffc247}

    .loading{text-align:center;padding:40px;color:var(--muted)}
    .error-state{background:rgba(255,96,112,.1);border:1px solid rgba(255,96,112,.3);padding:20px;border-radius:var(--radius);margin:20px 0}

    /* Enhanced alert system */
    .alert-banner {
      background: linear-gradient(135deg, rgba(255,96,112,.15), rgba(255,140,66,.15));
      border: 1px solid rgba(255,96,112,.3);
      padding: 16px;
      border-radius: var(--radius);
      margin: 16px 0;
      animation: pulse 2s infinite;
    }
    .alert-banner.warning {
      background: linear-gradient(135deg, rgba(255,194,71,.15), rgba(255,140,66,.1));
      border-color: rgba(255,194,71,.3);
    }
    @keyframes pulse {
      0% { box-shadow: 0 0 0 0 rgba(255,96,112,.4); }
      70% { box-shadow: 0 0 0 10px rgba(255,96,112,0); }
      100% { box-shadow: 0 0 0 0 rgba(255,96,112,0); }
    }

    .alert-list {
      margin-top: 8px;
    }
    .alert-item {
      display: flex;
      align-items: flex-start;
      gap: 8px;
      padding: 8px 0;
      border-bottom: 1px solid rgba(255,255,255,.06);
    }
    .alert-item:last-child {
      border-bottom: none;
    }
    .alert-icon {
      font-size: 16px;
      margin-top: 2px;
    }
    .alert-content {
      flex: 1;
    }
    .alert-title {
      font-weight: 600;
      margin-bottom: 2px;
    }
    .alert-description {
      font-size: 13px;
      color: var(--muted);
      line-height: 1.4;
    }

    /* Risk explanation */
    .risk-explanation {
      background: rgba(255,255,255,.03);
      padding: 16px;
      border-radius: 10px;
      margin-top: 12px;
      border: 1px solid rgba(255,255,255,.06);
    }
    .risk-explanation h4 {
      margin: 0 0 8px 0;
      font-size: 14px;
      color: var(--accent-bright);
    }
    .risk-explanation p {
      margin: 0;
      font-size: 13px;
      color: var(--muted);
      line-height: 1.5;
    }

    @media (max-width:768px){
      .gauge-container{justify-content:center;text-align:center}
      .gauge-wrap{width:var(--ring-m);height:var(--ring-m)}
      .score{font-size:36px}
      .pills-grid{grid-template-columns:1fr}
      .chart-header{flex-direction:column;align-items:flex-start}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>‚ö° Economic Crash Radar</h1>
      <div class="subtitle">Real-time market stress monitoring with actionable risk intelligence</div>
      <div id="statusBadge"></div>
      <div id="alertBanner"></div>
      <div id="auditBox" class="audit"></div>
    </header>

    <main id="mainContent">
      <div class="loading">Loading economic data...</div>
    </main>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3.1.1/dist/chartjs-plugin-annotation.min.js"></script>

  <script>
    'use strict';

    // ==================== SIMPLIFIED CONFIGURATION ====================
    const CONFIG = {
      FRED_CACHE_PATH: 'data/fred_cache.json',
      CACHE_TIMEOUT: 10000,
      
      // Core indicators only - removed redundant ones
      INDICATORS: {
        T10Y3M:          { 
          label:'Yield Curve',         
          format:v=>v?.toFixed(2),               
          weight:0.25, 
          cadence:'daily',
          description: '10-year minus 3-month Treasury yield. Negative = inverted curve (recession warning). Current: -0.22 = strong inversion.',
          thresholds: { green: [0.5, Infinity], amber: [-0.5, 0.5], red: [-Infinity, -0.5] },
          crisisThreshold: -0.5,
          crisisMessage: 'Yield curve inversion historically precedes recessions by 6-18 months'
        },
        CREDIT:          { 
          label:'Credit Spread',       
          format:v=>v?.toFixed(2),               
          weight:0.20, 
          cadence:'daily',
          description: 'High-yield corporate bond spread over Treasuries. Wider spreads = higher perceived risk.',
          thresholds: { green: [-Infinity, 0.40], amber: [0.40, 0.70], red: [0.70, Infinity] },
          crisisThreshold: 0.8,
          crisisMessage: 'Credit spreads above 0.8 indicate severe stress in corporate debt markets'
        },
        SAHM_RULE:       { 
          label:'Sahm Rule',      
          format:v=>v?.toFixed(2),               
          weight:0.25, 
          cadence:'monthly',
          description: '3-month unemployment avg minus 12-month low. ‚â•0.5 = recession likely started.',
          thresholds: { green: [-Infinity, 0.1], amber: [0.1, 0.4], red: [0.4, Infinity] },
          crisisThreshold: 0.5,
          crisisMessage: 'Sahm Rule triggered - unemployment rise suggests recession has begun'
        },
        DD_12M:          { 
          label:'Market Drawdown',     
          format:v=>((v??0)*100).toFixed(1)+'%', 
          weight:0.20, 
          cadence:'daily',
          description: 'S&P 500 decline from 1-year peak. -20% = bear market.',
          thresholds: { green: [-0.05, 0], amber: [-0.15, -0.05], red: [-Infinity, -0.15] },
          crisisThreshold: -0.2,
          crisisMessage: 'Market in bear territory (>20% decline from highs)'
        },
        NFCI:            { 
          label:'Financial Conditions',
          format:v=>v?.toFixed(3),               
          weight:0.10, 
          cadence:'weekly',
          description: 'Chicago Fed NFCI. >0 = tighter than average financial conditions.',
          thresholds: { green: [-Infinity, -0.20], amber: [-0.20, 0.20], red: [0.20, Infinity] },
          crisisThreshold: 0.3,
          crisisMessage: 'Financial conditions severely tightened, restricting credit flow'
        }
      },

      // Clear risk level definitions
      RISK_LEVELS: {
        LOW: { threshold: 30, color: 'green', label: 'Low Risk', description: 'Normal market conditions' },
        MEDIUM: { threshold: 60, color: 'amber', label: 'Elevated Risk', description: 'Monitor closely - stress building' },
        HIGH: { threshold: 100, color: 'red', label: 'High Risk', description: 'Take defensive actions' }
      },

      // Time horizon definitions
      TIME_HORIZONS: {
        '1m': {
          label: '1 Month',
          description: 'Probability of >10% market decline within 1 month. Based on current volatility and stress levels.',
          action: 'Short-term hedging and position sizing'
        },
        '3m': {
          label: '3 Month', 
          description: 'Probability of >15% correction within a quarter. Incorporates economic momentum and credit conditions.',
          action: 'Portfolio rebalancing and sector rotation'
        },
        '6m': {
          label: '6 Month',
          description: 'Probability of >20% bear market or recession within 6 months. Based on leading indicators and historical patterns.',
          action: 'Strategic asset allocation changes'
        }
      },

      FRESH_LIMITS: { 
        daily: { ok:7, warn:14 }, 
        weekly: { ok:7, warn:14 }, 
        monthly: { ok:30, warn:45 } 
      }
    };

    // ==================== SIMPLIFIED UTILITIES ====================
    const Utils = {
      clamp: (x, min = 0, max = 100) => Math.max(min, Math.min(max, x)),
      
      map01: (val, good, bad) => {
        if (val == null) return 50;
        const denom = bad - good;
        if (Math.abs(denom) < 1e-9) return 50;
        return ((val - good) / denom) * 100;
      },

      zoneOf: score => score <= 30 ? 'green' : (score <= 60 ? 'amber' : 'red'),
      
      safeParseFloat: val => {
        if (val == null || val === '.' || val === 'NaN' || val === '') return null;
        const num = +val;
        return isFinite(num) ? num : null;
      }
    };

    // ==================== DATA SCALING ====================
    const SCALE = {
      T10Y3M:   v => Utils.clamp(Utils.map01(v,  1.0, -2.0)),
      CREDIT:   v => Utils.clamp(Utils.map01(v,  0.30, 1.00)),
      SAHM_RULE:v => Utils.clamp(Utils.map01(v,  0.0, 0.5)),
      DD_12M:   v => Utils.clamp(Utils.map01(v,  0.00, -0.20)),
      NFCI:     v => Utils.clamp(Utils.map01(v, -0.80, 0.40))
    };

    // ==================== ENHANCED DATA LAYER ====================
    class DataService {
      static async loadFredCache() {
        const controller = new AbortController();
        const timeout = setTimeout(() => controller.abort(), CONFIG.CACHE_TIMEOUT);

        try {
          const res = await fetch(`${CONFIG.FRED_CACHE_PATH}?t=${Date.now()}`, { 
            cache: 'no-store',
            signal: controller.signal
          });
          
          clearTimeout(timeout);
          
          if (!res.ok) throw new Error(`HTTP ${res.status}: ${res.statusText}`);
          
          const raw = await res.json();
          return this.normalizeCache(raw);
        } catch (err) {
          clearTimeout(timeout);
          if (err.name === 'AbortError') throw new Error('Request timeout');
          throw err;
        }
      }

      static normalizeCache(raw) {
        const out = {};
        
        if (!raw) return out;

        // Direct format: { SERIES_ID: { observations: [...] } }
        const directLike = typeof raw === 'object' && 
          Object.keys(raw).some(k => raw[k] && Array.isArray(raw[k].observations));
        
        if (directLike) return raw;

        // Array format with series property
        if (Array.isArray(raw?.series)) {
          for (const item of raw.series) {
            const id = item?.id || item?.series_id || item?.name;
            if (!id) continue;
            const obs = Array.isArray(item.observations) ? item.observations :
                       Array.isArray(item.data) ? item.data : [];
            out[id] = { observations: obs, fetchedAt: item.fetchedAt };
          }
          return out;
        }

        return out;
      }

      static latest(series) {
        const obs = series?.observations || [];
        if (!obs.length) return null;
        const o = obs[obs.length - 1];
        const v = Utils.safeParseFloat(o.value);
        return { value: v, date: o.date };
      }

      static seriesAgeDays(series, fetchedAt) {
        const L = this.latest(series);
        if (!L) return Infinity;
        const d = new Date(L.date + 'T00:00:00Z');
        const ref = new Date(fetchedAt || Date.now());
        return Math.max(0, Math.round((ref - d) / 86400000));
      }
    }

    // ==================== ENHANCED ALERT SYSTEM ====================
    class AlertSystem {
      static generateAlerts(parts, composite) {
        const alerts = [];
        
        // Composite score alerts
        if (composite >= 80) {
          alerts.push({
            level: 'critical',
            title: 'CRITICAL: Market Stress at Crisis Levels',
            description: `Composite score ${Math.round(composite)} indicates systemic stress similar to historical crisis periods. Immediate risk management actions recommended.`,
            type: 'composite'
          });
        } else if (composite >= 65) {
          alerts.push({
            level: 'warning',
            title: 'WARNING: Elevated Market Stress',
            description: `Composite score ${Math.round(composite)} suggests heightened risk environment. Monitor positions closely and consider hedging.`,
            type: 'composite'
          });
        }

        // Individual indicator alerts
        for (const part of parts) {
          if (part.value >= part.crisisThreshold) {
            alerts.push({
              level: 'critical',
              title: `CRITICAL: ${part.label} at ${part.valueDisp}`,
              description: part.crisisMessage,
              type: 'indicator',
              indicator: part.key
            });
          } else if (part.ragStatus === 'red') {
            alerts.push({
              level: 'warning', 
              title: `WARNING: ${part.label} in Stress Zone`,
              description: `${part.label} at ${part.valueDisp} indicates elevated risk. Monitor for further deterioration.`,
              type: 'indicator',
              indicator: part.key
            });
          }
        }

        return alerts;
      }

      static formatAlertLevel(level) {
        return level === 'critical' ? 'üö® CRITICAL' : '‚ö†Ô∏è WARNING';
      }
    }

    // ==================== SIMPLIFIED UI MANAGER ====================
    class UIManager {
      constructor() {
        this.elements = {
          statusBadge: document.getElementById('statusBadge'),
          alertBanner: document.getElementById('alertBanner'),
          auditBox: document.getElementById('auditBox'),
          mainContent: document.getElementById('mainContent')
        };
        this.charts = { composite: null, decomp: null };
        this.currentTimeframe = '3m';
      }

      setStatus(zone, text) {
        const color = CONFIG.RISK_LEVELS[zone.toUpperCase()]?.color || '#8fb4ff';
        this.elements.statusBadge.innerHTML = `
          <div class="status" style="background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.08)">
            <span class="status-dot" style="background:${color}"></span>
            <span>${text}</span>
          </div>`;
      }

      // ENHANCED: Show all alerts with explanations
      renderAlerts(alerts) {
        if (!alerts.length) {
          this.elements.alertBanner.innerHTML = '';
          return;
        }

        const criticalAlerts = alerts.filter(a => a.level === 'critical');
        const warningAlerts = alerts.filter(a => a.level === 'warning');
        const displayAlerts = [...criticalAlerts, ...warningAlerts].slice(0, 5); // Limit to 5

        const alertLevel = criticalAlerts.length > 0 ? 'critical' : 'warning';
        
        this.elements.alertBanner.innerHTML = `
          <div class="alert-banner ${alertLevel === 'warning' ? 'warning' : ''}">
            <div style="display:flex;align-items:flex-start;gap:12px">
              <span style="font-size:24px">${alertLevel === 'critical' ? 'üö®' : '‚ö†Ô∏è'}</span>
              <div style="flex:1">
                <div style="font-weight:700;margin-bottom:8px;font-size:16px">
                  ${alertLevel === 'critical' ? 'CRITICAL ALERTS' : 'WARNINGS'}
                </div>
                <div class="alert-list">
                  ${displayAlerts.map(alert => `
                    <div class="alert-item">
                      <div class="alert-icon">${alert.level === 'critical' ? 'üî¥' : 'üü°'}</div>
                      <div class="alert-content">
                        <div class="alert-title">${alert.title}</div>
                        <div class="alert-description">${alert.description}</div>
                      </div>
                    </div>
                  `).join('')}
                </div>
                ${alerts.length > 5 ? 
                  `<div style="margin-top:8px;font-size:12px;color:var(--muted)">
                    +${alerts.length - 5} more alerts...
                  </div>` : ''}
              </div>
            </div>
          </div>`;
      }

      showError(message) {
        this.elements.mainContent.innerHTML = `
          <div class="error-state">
            <h3 style="margin:0 0 8px;color:#ff9da6">‚ö†Ô∏è Unable to Load Data</h3>
            <p style="margin:0;color:var(--muted)">${message}</p>
          </div>`;
      }

      renderMainUI() {
        this.elements.mainContent.innerHTML = `
          <section class="card">
            <div class="gauge-container">
              <div class="gauge-wrap">
                <div class="multi-ring">
                  <div class="ring ring-outer"></div>
                  <div class="ring ring-mid"></div>
                  <div class="ring ring-inner"></div>
                </div>
                <div id="needle" class="needle"></div>
                <div class="score"><div id="scoreText">--</div><div class="score-label">STRESS INDEX</div></div>
              </div>

              <div class="gauge-info">
                <h2>Market Stress Monitor</h2>
                <div style="color:var(--muted);font-size:14px;margin-bottom:12px">
                  Real-time composite of 5 critical economic indicators
                </div>
                
                <!-- ENHANCED: Risk probabilities with clear explanations -->
                <div style="display:flex;gap:16px;margin:20px 0;flex-wrap:wrap">
                  ${Object.entries(CONFIG.TIME_HORIZONS).map(([key, horizon]) => `
                    <div style="flex:1;min-width:140px;background:rgba(255,255,255,.03);padding:16px;border-radius:10px;border:1px solid rgba(255,255,255,.06);position:relative">
                      <h4 style="margin:0 0 8px;font-size:12px;color:var(--muted);letter-spacing:.5px;text-transform:uppercase">
                        ${horizon.label} Risk
                      </h4>
                      <div id="prob${key}" style="font-size:28px;font-weight:700;color:var(--accent-bright);margin-bottom:8px">--%</div>
                      <div style="font-size:11px;color:var(--muted);line-height:1.4">${horizon.description}</div>
                    </div>
                  `).join('')}
                </div>

                <div class="confidence">
                  <span>Data Confidence:</span>
                  <div class="confidence-bar"><div id="confidenceFill" class="confidence-fill"></div></div>
                  <span id="confidenceText">--</span>
                </div>
                <div id="regimeIndicator" style="margin-top:12px"></div>
              </div>
            </div>
          </section>

          <!-- REMOVED: Historical comparisons section -->

          <section class="card">
            <h3 style="margin:0 0 16px;font-size:20px">
              üìä Live Risk Indicators
            </h3>
            <div style="margin-bottom:12px;padding:12px;background:rgba(255,255,255,.02);border-radius:8px;font-size:13px;color:var(--muted)">
              <strong style="color:var(--text)">Status Legend:</strong>
              <span style="display:inline-flex;align-items:center;margin-left:12px">
                <span class="pill-status pill-status-green" style="margin-right:4px"></span> Normal
              </span>
              <span style="display:inline-flex;align-items:center;margin-left:12px">
                <span class="pill-status pill-status-amber" style="margin-right:4px"></span> Elevated
              </span>
              <span style="display:inline-flex;align-items:center;margin-left:12px">
                <span class="pill-status pill-status-red" style="margin-right:4px"></span> Critical
              </span>
            </div>
            <div id="pillsGrid" class="pills-grid"></div>
          </section>

          <!-- SIMPLIFIED: Only Composite tab -->
          <div class="tabs">
            <button class="tab active" data-tab="composite">Risk Analysis</button>
            <button class="tab" data-tab="scenarios">Forward Outlook</button>
          </div>

          <div id="tab-composite" class="tab-content active">
            <section class="card">
              <div class="chart-header">
                <h3 class="chart-title">Stress Index Timeline</h3>
                <div class="chart-controls">
                  <div class="btn-group" id="timeframeButtons">
                    <button class="btn" data-tf="1m">1M</button>
                    <button class="btn active" data-tf="3m">3M</button>
                    <button class="btn" data-tf="6m">6M</button>
                    <button class="btn" data-tf="1y">1Y</button>
                  </div>
                </div>
              </div>
              <div class="chart-container"><canvas id="compositeChart"></canvas></div>
            </section>

            <section class="card">
              <h3 style="margin:0 0 16px">Risk Contributors</h3>
              <div class="chart-container"><canvas id="decompChart"></canvas></div>
            </section>
          </div>

          <div id="tab-scenarios" class="tab-content">
            <section class="card">
              <h3 style="margin:0 0 12px">Forward-Looking Risk Assessment</h3>
              <p style="color:var(--muted);margin:0 0 20px;font-size:14px">
                Probability-weighted scenarios based on current stress levels and historical patterns
              </p>
              
              <div class="risk-explanation">
                <h4>üìà Understanding Risk Probabilities</h4>
                <p><strong>1-Month Risk</strong> assesses immediate market stress and volatility spikes. 
                <strong>3-Month Risk</strong> incorporates economic momentum and credit conditions. 
                <strong>6-Month Risk</strong> evaluates recession and bear market probabilities using leading indicators.</p>
                <p style="margin-top:8px">These probabilities help inform different time horizons for risk management decisions.</p>
              </div>

              <div id="scenarioGrid" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:16px;margin-top:20px"></div>
            </section>
          </div>`;
        
        this.setupEventListeners();
      }

      setupEventListeners() {
        // Tab switching
        document.querySelectorAll('.tab').forEach(tab => {
          tab.addEventListener('click', (e) => {
            const target = e.currentTarget.dataset.tab;
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            e.currentTarget.classList.add('active');
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.getElementById(`tab-${target}`).classList.add('active');
          });
        });

        // Timeframe buttons
        document.querySelectorAll('#timeframeButtons .btn').forEach(btn => {
          btn.addEventListener('click', (e) => {
            document.querySelectorAll('#timeframeButtons .btn').forEach(b => b.classList.remove('active'));
            e.currentTarget.classList.add('active');
            this.currentTimeframe = e.currentTarget.dataset.tf;
            if (this.charts.composite) {
              this.renderCompositeChart(app.state.compositeHistory);
            }
          });
        });
      }

      setGauge(score) {
        const scoreEl = document.getElementById('scoreText');
        const needleEl = document.getElementById('needle');
        if (scoreEl) scoreEl.textContent = Math.round(score);
        if (needleEl) {
          const angle = (score / 100) * 360;
          needleEl.style.setProperty('--angle', angle + 'deg');
        }
      }

      renderPills(parts) {
        const grid = document.getElementById('pillsGrid');
        if (!grid) return;
        
        grid.innerHTML = parts.map(p => {
          const arrow = p.change == null ? '' : (p.change > 0 ? '‚ñ≤' : '‚ñº');
          const changeTxt = p.change == null ? '' : `${p.change > 0 ? '+' : ''}${p.change.toFixed(2)}`;
          const ragClass = `pill-status-${p.ragStatus || 'green'}`;
          
          return `
            <div class="pill" data-key="${p.key}">
              <div class="pill-header">
                <div style="display:flex;align-items:center">
                  <div class="pill-title">${p.label}</div>
                  <span class="pill-status ${ragClass}"></span>
                </div>
                <div class="pill-badge ${p.freshClass}">${p.freshTxt}</div>
              </div>
              <div class="pill-value">${p.valueDisp}</div>
              <div class="pill-change"><span>${arrow}</span>${changeTxt}</div>
              ${p.description ? `<div class="pill-tooltip">${p.description}</div>` : ''}
            </div>`;
        }).join('');
      }

      renderCompositeChart(history) {
        const hist = history || [];
        if (!hist.length) return;
        
        const now = new Date(hist[hist.length - 1].date + 'T00:00:00Z');
        const spanDays = this.currentTimeframe === '1m' ? 30 :
                        this.currentTimeframe === '3m' ? 90 :
                        this.currentTimeframe === '6m' ? 180 :
                        this.currentTimeframe === '1y' ? 365 : 365;
        
        const filtered = hist.filter(d => {
          const dt = new Date(d.date + 'T00:00:00Z');
          return (now - dt) / 86400000 <= spanDays;
        });
        
        const labels = filtered.map(d => {
          const date = new Date(d.date + 'T00:00:00Z');
          return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        });
        const data = filtered.map(d => d.value);
        
        if (this.charts.composite) this.charts.composite.destroy();
        
        const ctx = document.getElementById('compositeChart');
        if (!ctx) return;
        
        this.charts.composite = new Chart(ctx, {
          type: 'line',
          data: {
            labels,
            datasets: [{
              label: 'Stress Index',
              data,
              borderColor: '#ffc247',
              backgroundColor: 'rgba(255,194,71,0.1)',
              borderWidth: 2,
              fill: true,
              tension: 0.25,
              pointRadius: 0,
              pointHoverRadius: 4
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { display: false },
              tooltip: {
                mode: 'index',
                intersect: false
              }
            },
            scales: {
              x: { 
                display: true, 
                grid: { color: 'rgba(255,255,255,0.05)' },
                ticks: { maxTicksLimit: 8 }
              },
              y: { 
                min: 0, 
                max: 100,
                grid: { color: 'rgba(255,255,255,0.05)' },
                ticks: { 
                  callback: (val) => val
                }
              }
            }
          }
        });
      }

      renderDecomp(parts) {
        const labels = parts.map(p => p.label);
        const contrib = parts.map(p => +(p.scaled * p.w).toFixed(1));
        
        if (this.charts.decomp) this.charts.decomp.destroy();
        
        const ctx = document.getElementById('decompChart');
        if (!ctx) return;
        
        this.charts.decomp = new Chart(ctx, {
          type: 'bar',
          data: {
            labels,
            datasets: [{
              label: 'Contribution to Stress',
              data: contrib,
              backgroundColor: contrib.map(c => {
                if (c < 10) return '#1ec28b';
                if (c < 20) return '#ffc247';
                return '#ff6070';
              }),
              borderWidth: 0
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: {
              y: { 
                beginAtZero: true,
                max: Math.max(10, Math.ceil(Math.max(...contrib, 10) / 10) * 10),
                grid: { color: 'rgba(255,255,255,0.05)' },
                title: { display: true, text: 'Points to Composite Score' }
              },
              x: { 
                grid: { display: false }
              }
            }
          }
        });
      }

      renderScenarios(composite, probs) {
        const scenarios = [
          { 
            title: 'Base Case', 
            prob: Math.round(100 - probs.p3), 
            desc: 'Markets stabilize, economic data mixed but no major deterioration. Gradual recovery continues.',
            color: '#1ec28b'
          },
          { 
            title: 'Correction Scenario', 
            prob: Math.round(probs.p3 - probs.p1), 
            desc: '10-15% market decline as stress indicators persist. Increased volatility but no systemic crisis.',
            color: '#ffc247'
          },
          { 
            title: 'Crisis Scenario', 
            prob: Math.round(probs.p1), 
            desc: '>20% decline with credit stress and economic contraction. Requires defensive positioning.',
            color: '#ff6070'
          }
        ];
        
        const grid = document.getElementById('scenarioGrid');
        if (!grid) return;
        
        grid.innerHTML = scenarios.map(s => `
          <div style="background:rgba(255,255,255,.03);padding:20px;border-radius:12px;border:1px solid rgba(255,255,255,.06);border-left:4px solid ${s.color}">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
              <div style="font-weight:600;font-size:16px">${s.title}</div>
              <div style="font-size:24px;font-weight:700;color:${s.color}">${s.prob}%</div>
            </div>
            <div style="color:var(--muted);font-size:13px;line-height:1.5">${s.desc}</div>
          </div>`).join('');
      }

      updateAudit(missing, stale) {
        const auditHTML = 
          (missing.length ? `<div><b class="bad">Missing</b>: ${missing.join(', ')}</div>` : '') +
          (stale.length ? `<div><b class="warn">Stale Data</b>: ${stale.join(', ')}</div>` : '');
        
        this.elements.auditBox.innerHTML = auditHTML || '<div style="color:var(--green)">‚úì All data current</div>';
      }
    }

    // ==================== SIMPLIFIED APP CORE ====================
    class App {
      constructor() {
        this.ui = new UIManager();
        this.state = {
          dataMap: null,
          compositeHistory: [],
          cache: null
        };
      }

      async init() {
        try {
          this.ui.setStatus('green', 'Loading data‚Ä¶');
          
          const cache = await DataService.loadFredCache();
          this.state.cache = cache;
          
          // Simple indicator mapping
          const dataMap = {};
          for (const k of Object.keys(CONFIG.INDICATORS)) {
            if (cache[k]) dataMap[k] = cache[k];
          }
          this.state.dataMap = dataMap;
          
          // Calculate composite score
          let num = 0, den = 0;
          const parts = [];
          const currentValues = {};
          
          for (const [k, cfg] of Object.entries(CONFIG.INDICATORS)) {
            const s = dataMap[k];
            if (!s?.observations?.length) continue;
            
            const L = DataService.latest(s);
            if (!L || L.value === null) continue;

            currentValues[k] = L.value;
            const days = DataService.seriesAgeDays(s, s.fetchedAt);
            const lim = CONFIG.FRESH_LIMITS[cfg.cadence] || CONFIG.FRESH_LIMITS.daily;
            const badge = days <= lim.ok ? { cls: 'badge-fresh', txt: 'Fresh' } :
                         days <= lim.warn ? { cls: 'badge-stale', txt: 'Stale' } :
                         { cls: 'badge-old', txt: 'Old' };

            const scaled = SCALE[k](L.value);
            const w = cfg.weight * (days <= lim.warn ? 1.0 : 0.7); // Simple freshness penalty
            
            if (Number.isFinite(scaled) && Number.isFinite(w)) {
              num += scaled * w;
              den += w;
            }

            // Determine status
            let ragStatus = 'green';
            const thresh = cfg.thresholds;
            if (thresh) {
              if (L.value >= thresh.red[0] && L.value <= thresh.red[1]) ragStatus = 'red';
              else if (L.value >= thresh.amber[0] && L.value <= thresh.amber[1]) ragStatus = 'amber';
              else ragStatus = 'green';
            }

            let change = null;
            const obs = s.observations;
            if (obs.length >= 2) {
              const a = Utils.safeParseFloat(obs[obs.length - 1].value);
              const b = Utils.safeParseFloat(obs[obs.length - 2].value);
              if (a !== null && b !== null) change = a - b;
            }

            parts.push({
              key: k,
              label: cfg.label,
              value: L.value,
              valueDisp: cfg.format?.(L.value) ?? L.value,
              change,
              freshClass: badge.cls,
              freshTxt: badge.txt,
              scaled,
              w,
              ragStatus,
              description: cfg.description,
              crisisThreshold: cfg.crisisThreshold,
              crisisMessage: cfg.crisisMessage
            });
          }
          
          if (den <= 0) throw new Error('No valid indicators available');
          
          const composite = num / den;
          
          // Build simple history
          this.state.compositeHistory = this.buildCompositeHistory(dataMap);
          
          // Generate alerts
          const alerts = AlertSystem.generateAlerts(parts, composite);
          
          // Render UI
          this.ui.renderMainUI();
          this.ui.setGauge(composite);
          
          const zone = Utils.zoneOf(composite);
          const level = CONFIG.RISK_LEVELS[zone.toUpperCase()];
          
          this.ui.setStatus(zone, `${level.label}: ${Math.round(composite)} - ${level.description}`);
          
          // Show all alerts with explanations
          this.ui.renderAlerts(alerts);
          
          this.ui.renderPills(parts);
          this.ui.renderCompositeChart(this.state.compositeHistory);
          this.ui.renderDecomp(parts);
          
          // Calculate simple risk probabilities
          const probs = this.calculateRiskProbabilities(composite, this.state.compositeHistory);
          document.getElementById('prob1m').textContent = `${probs.p1}%`;
          document.getElementById('prob3m').textContent = `${probs.p3}%`;
          document.getElementById('prob6m').textContent = `${probs.p6}%`;
          
          this.ui.renderScenarios(composite, probs);
          
          // Regime indicator
          document.getElementById('regimeIndicator').innerHTML = `
            <div class="status" style="background:rgba(255,255,255,.03);border:1px solid rgba(255,255,255,.06);display:inline-flex">
              <span class="status-dot" style="background:${level.color}"></span>
              <span>${level.label} Regime ‚Ä¢ ${parts.length} indicators active</span>
            </div>`;
          
          // Confidence and audit
          const { missing, stale } = this.auditData(parts);
          const confidence = Math.max(40, 100 - (missing.length * 15 + stale.length * 8));
          
          document.getElementById('confidenceFill').style.width = confidence + '%';
          document.getElementById('confidenceText').textContent = confidence + '%';
          
          this.ui.updateAudit(missing, stale);
          
        } catch (err) {
          console.error('Initialization error:', err);
          this.ui.setErrorStatus(err.message);
          this.ui.showError(err.message);
        }
      }

      buildCompositeHistory(dataMap) {
        const keys = Object.keys(CONFIG.INDICATORS);
        const allDates = new Set();
        
        for (const k of keys) {
          (dataMap[k]?.observations || []).forEach(o => allDates.add(o.date));
        }
        
        const dates = Array.from(allDates).sort();
        const history = [];
        
        for (const date of dates.slice(-100)) { // Last 100 days
          let num = 0, den = 0;
          
          for (const [k, cfg] of Object.entries(CONFIG.INDICATORS)) {
            const s = dataMap[k];
            if (!s) continue;
            
            const obs = s.observations;
            let value = null;
            
            // Find latest value on or before this date
            for (let i = obs.length - 1; i >= 0; i--) {
              if (obs[i].date <= date) {
                value = Utils.safeParseFloat(obs[i].value);
                break;
              }
            }
            
            if (value === null) continue;
            const scaled = SCALE[k](value);
            num += scaled * cfg.weight;
            den += cfg.weight;
          }
          
          if (den > 0) {
            history.push({ date, value: +(num / den).toFixed(1) });
          }
        }
        
        return history;
      }

      calculateRiskProbabilities(composite, history) {
        // Simple probability calculation based on composite score
        const base1m = Math.min(40, composite * 0.6);
        const base3m = Math.min(60, composite * 0.8);
        const base6m = Math.min(80, composite * 1.0);
        
        // Add momentum effect
        const momentum = history.length > 10 ? 
          (history[history.length - 1].value - history[history.length - 10].value) / 10 : 0;
        
        return {
          p1: Math.round(base1m + momentum * 5),
          p3: Math.round(base3m + momentum * 8),
          p6: Math.round(base6m + momentum * 12)
        };
      }

      auditData(parts) {
        const missing = [];
        const stale = [];
        
        for (const [k, cfg] of Object.entries(CONFIG.INDICATORS)) {
          const s = this.state.dataMap[k];
          if (!s?.observations?.length) {
            missing.push(k);
            continue;
          }
          
          const days = DataService.seriesAgeDays(s, s.fetchedAt);
          const lim = CONFIG.FRESH_LIMITS[cfg.cadence] || CONFIG.FRESH_LIMITS.daily;
          
          if (days > lim.warn) {
            stale.push(`${cfg.label} (${days}d)`);
          }
        }
        
        return { missing, stale };
      }
    }

    // ==================== INITIALIZE ====================
    const app = new App();
    
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', () => app.init());
    } else {
      app.init();
    }
  </script>
</body>
</html>
