<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="description" content="CrashRadar Lite — a 7-signal, FRED-based composite of macro and market stress for long-only investors." />
  <title>CrashRadar — Composite Crash Risk (Lite)</title>

  <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
  <link rel="dns-prefetch" href="https://cdn.jsdelivr.net">

  <style>
    :root{
      --bg:#0f1421; --panel:#161c2e; --muted:#9aa6bf; --text:#e8eeff; --accent:#7da6ff;
      --green:#1ec28b; --amber:#ffc247; --red:#ff6070; --radius:16px; --t:all .2s ease;
      --ring-size: 180px; --ring-size-mobile: 140px;
    }
    *{box-sizing:border-box}
    html,body{margin:0;background:var(--bg);color:var(--text);font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Inter,Helvetica,Arial}
    :focus{outline:2px solid var(--accent);outline-offset:2px}
    :focus:not(:focus-visible){outline:none}
    .wrap{max-width:980px;margin:0 auto;padding:20px 16px 64px}
    h1{font-size:clamp(28px,5.5vw,44px);line-height:1.1;margin:0 0 8px}
    .sub{color:var(--muted);margin:6px 0 18px;font-size:14px}
    .ok{color:var(--green)} .warn{color:var(--amber)} .bad{color:var(--red)}
    .card{background:var(--panel);border-radius:var(--radius);padding:20px;margin:16px 0;box-shadow:0 0 0 1px rgba(255,255,255,.03) inset;transition:var(--t)}
    .card:hover{box-shadow:0 0 0 1px rgba(125,166,255,.1) inset}
    .pill{display:inline-flex;align-items:center;background:#13192a;border:1px solid #1f2740;color:var(--text);padding:8px 12px;border-radius:999px;font-weight:600;margin:6px 8px 0 0;transition:var(--t);cursor:help}
    .pill:hover{border-color:var(--accent);transform:translateY(-1px)}
    .meta{color:var(--muted);font-size:13px}
    .gauge{display:flex;align-items:center;gap:24px;flex-wrap:wrap}
    .ringwrap{position:relative;width:var(--ring-size);height:var(--ring-size);flex-shrink:0}
    .ring{position:absolute;inset:0;border-radius:50%;isolation:isolate;z-index:0;
      background:conic-gradient(var(--green) 0deg 120deg, var(--amber) 120deg 216deg, var(--red) 216deg 360deg)}
    .ring::after{content:"";position:absolute;inset:20px;border-radius:50%;background:var(--panel);z-index:0}
    .score{position:absolute;inset:0;display:grid;place-items:center;font-weight:800;font-size:40px;z-index:2}
    .badge{display:inline-flex;align-items:center;padding:6px 12px;border-radius:10px;font-weight:800;letter-spacing:.4px;margin-left:12px}
    .badge.green{background:rgba(30,194,139,.15);color:var(--green);border:1px solid rgba(30,194,139,.35)}
    .badge.amber{background:rgba(255,194,71,.15);color:var(--amber);border:1px solid rgba(255,194,71,.35)}
    .badge.red{background:rgba(255,96,112,.17);color:var(--red);border:1px solid rgba(255,96,112,.35)}
    .callout{font-size:14px;color:var(--muted);line-height:1.4}
    .chart{position:relative;height:300px}
    canvas{width:100%!important;height:100%!important}
    .foot{margin-top:24px}
    .err{background:#2b1620;color:#ffdbe0;border:1px solid #57313f;padding:12px;border-radius:10px}
    .skeleton{background:linear-gradient(90deg, #161c2e 25%, #1a2238 50%, #161c2e 75%);background-size:200% 100%;animation:loading 1.5s infinite}
    @keyframes loading{0%{background-position:200% 0}100%{background-position:-200% 0}}
    .tooltip{position:relative;cursor:help;border-bottom:1px dotted var(--muted)}
    .tooltip:hover::after{content:attr(data-tooltip);position:absolute;bottom:100%;left:50%;transform:translateX(-50%);background:rgba(0,0,0,0.9);color:white;padding:8px 12px;border-radius:6px;font-size:12px;white-space:nowrap;z-index:1000}
    .risk-explanation{margin-top:12px;padding:12px;background:rgba(255,255,255,0.03);border-radius:8px;border-left:3px solid var(--accent)}

    /* Donut needle */
    .needle { position:absolute; inset:0; pointer-events:none; z-index:1; }
    .needle::after{
      content:"";
      width:8px; height:8px; border-radius:50%;
      background:#7da6ff; box-shadow:0 0 0 3px rgba(125,166,255,.25);
      transform: rotate(var(--angle,0deg)) translateY(calc(-1 * (var(--ring-size)/2 - 10px)));
      transform-origin: center center;
      display:block; margin:auto;
    }

    @media (max-width:768px){
      .gauge{justify-content:center;text-align:center}
      .ringwrap{width:var(--ring-size-mobile);height:var(--ring-size-mobile)}
      .score{font-size:32px}
    }
    @media (max-width:480px){
      .card{padding:16px}
      .pill{display:block;margin:6px 0;width:100%}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header role="banner">
      <h1>CrashRadar — Composite Crash Risk</h1>
      <div id="status" class="sub" aria-live="polite">Loading market data…</div>
    </header>

    <main role="main">
      <section aria-labelledby="composite-heading" class="card">
        <div class="gauge">
          <div class="ringwrap" aria-hidden="true">
            <div class="ring"></div>
            <div id="needle" class="needle"></div>
            <div id="scoreText" class="score">–</div>
          </div>
          <div>
            <h2 id="composite-heading" style="margin:0 0 6px;font-size:26px">
              Composite Score <span id="garBadge" class="badge">—</span>
            </h2>
            <div class="callout">
              Lower scores indicate safer conditions.
              Risk thresholds: <b class="ok">Green ≤ 30</b>, <b class="warn">Amber ≤ 60</b>, <b class="bad">Red &gt; 60</b>.
            </div>
            <div class="meta" id="freshness" style="margin-top:8px">—</div>
            <div id="riskExplanation" class="risk-explanation" style="display:none">
              <strong id="riskTitle">Risk Assessment</strong>
              <div id="riskDescription" class="meta" style="margin-top:4px"></div>
            </div>

            <!-- 7-signal pills -->
            <div style="margin-top:16px" role="list">
              <span class="pill" id="pill_t10y3m" role="listitem" data-tooltip="10y minus 3m Treasury. More negative = worse.">Yield (10y–3m): —</span>
              <span class="pill" id="pill_hyoas" role="listitem" data-tooltip="ICE BofA US High Yield OAS. Higher = worse.">HY OAS: —</span>
              <span class="pill" id="pill_nfci" role="listitem" data-tooltip="Chicago Fed National Financial Conditions Index. Higher = tighter/worse.">NFCI: —</span>
              <span class="pill" id="pill_icsa" role="listitem" data-tooltip="Initial jobless claims, 13-week % change. Higher = worse.">Claims Δ13w: —</span>
              <span class="pill" id="pill_mkt" role="listitem" data-tooltip="Average of VIX risk and S&P 12m drawdown risk (0–100).">Market stress: —</span>
              <span class="pill" id="pill_t10yie" role="listitem" data-tooltip="10y breakeven inflation. Higher can imply tighter policy risk.">10y BE (T10YIE): —</span>
              <span class="pill" id="pill_sahm" role="listitem" data-tooltip="Sahm Rule (current). Higher = recession confirmation.">Sahm: —</span>
            </div>
          </div>
        </div>
      </section>

      <section aria-labelledby="composite-chart-heading" class="card">
        <h3 id="composite-chart-heading" style="margin:0 0 8px">Composite Risk History (normalised 0–100)</h3>
        <div class="meta">Legend: <span class="ok">●</span> Green &nbsp; <span class="warn">●</span> Amber &nbsp; <span class="bad">●</span> Red</div>
        <div class="chart"><canvas id="compChart" aria-label="Composite risk score over time"></canvas></div>
        <div class="callout">Composite (30-day rolling average). Smoothed view of overall risk using recent readings.</div>
      </section>

      <div id="charts"></div>
    </main>

    <footer class="card foot" role="contentinfo">
      <h3 style="margin:0 0 12px;">Data & Diagnostics</h3>
      <details>
        <summary style="cursor:pointer;margin-bottom:8px;font-weight:600;">Technical Details</summary>
        <pre id="diag" style="white-space:pre-wrap;word-break:break-word;color:#ffdca8;background:#241d12;border:1px solid #4a3e20;border-radius:10px;padding:12px;max-height:420px;overflow:auto;margin:0;font-size:12px;"></pre>
      </details>
      <div class="meta" style="margin-top:12px;">Data sourced from FRED. Last updated: <span id="update-time">—</span></div>
    </footer>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3.1.1/dist/chartjs-plugin-annotation.min.js"></script>

  <script>
  class CrashRadar {
    constructor(){
      // Core 7-signal lite model
      this.keys = ['T10Y3M','HYOAS','NFCI','ICSA_D13W','MKT_STRESS','T10YIE','SAHM'];

      // Piecewise mappings via linear helper (good→bad).
      this.scales = {
        T10Y3M: v => this.clamp(this.map(v, +1.5, -0.75)),   // +150bp -> 0,  -75bp -> 100
        HYOAS:  v => this.clamp(this.map(v, 3.0,  8.0)),     // 300bp -> 0,   800bp -> 100
        NFCI:   v => this.clamp(this.map(v, -0.5, +1.0)),    // -0.5 -> 0,    +1.0 -> 100
        ICSA_D13W: v => this.clamp(this.map(v, -0.10, +0.40)), // -10% -> 0,  +40% -> 100
        MKT_STRESS: v => this.clamp(v),                      // 0–100 already
        T10YIE: v => this.clamp(this.map(v, 1.5, 3.5)),      // 1.5% -> 0,    3.5% -> 100
        SAHM:   v => this.clamp(this.map(v, 0.20, 0.60)),    // 0.20 -> 0,    0.60 -> 100
      };

      // Weights (sum 100) — can later be replaced by model-derived weights
      this.weights = {T10Y3M:15, HYOAS:25, NFCI:20, ICSA_D13W:15, MKT_STRESS:15, T10YIE:5, SAHM:5};

      this.data = {raw:null, series:{}, latest:{}, composite:null};
      this.charts = new Map();
      this.init();
    }

    // ---------- utils ----------
    setStatus(msg, cls=''){ const el=document.getElementById('status'); el.textContent=msg; el.className='sub '+cls; }
    gbDate(d){ try{return new Date(d).toLocaleDateString('en-GB',{day:'2-digit',month:'short'})}catch{return 'Invalid Date'} }
    safeNum(v){ return (v===null||v===undefined||isNaN(+v))?null:+v; }
    last(a){ return (a&&a.length)?a[a.length-1]:null; }
    clamp(x){ return Math.max(0, Math.min(100,x)); }
    map(val, good, bad){ if(val==null) return 50; const denom=bad-good; if(Math.abs(denom)<1e-10) return 50; return ((val-good)/denom)*100; }
    zoneOf(s){ return s<=30?'green':(s<=60?'amber':'red'); }
    scoreToAngle(s){ return (Math.max(0,Math.min(100,s))/100)*360; }
    setNeedle(score){ const n=document.getElementById('needle'); if(n) n.style.setProperty('--angle', this.scoreToAngle(score)+'deg'); }

    // 13-week % change for claims (weekly series)
    pctChange13w(series){
      const ys = series?.ys || [];
      if (ys.length < 14) return null;
      const last = ys[ys.length-1], prior = ys[ys.length-14];
      if (prior===0 || prior==null || last==null) return null;
      return (last - prior) / prior;
    }

    async init(){
      this.setStatus('Loading market data…');
      document.querySelectorAll('.pill, .score, .badge').forEach(el=>el.classList.add('skeleton'));
      try{
        const controller=new AbortController(); const t=setTimeout(()=>controller.abort(),10000);
        const res=await fetch('data/fred_cache.json',{cache:'no-cache',signal:controller.signal}); clearTimeout(t);
        if(!res.ok) throw new Error(`HTTP ${res.status}: ${res.statusText}`);
        this.data.raw=await res.json(); this.setStatus('Market data loaded successfully','ok');
        this.process(); this.render();
      }catch(e){
        this.setStatus(e.name==='AbortError'?'Request timeout — please try again':'Failed to load data','bad');
        const diag=document.getElementById('diag'); if(diag) diag.textContent='Load error: '+e.message;
        const card=document.querySelector('.gauge')?.closest('.card');
        if(card) card.insertAdjacentHTML('beforeend',`<div class="err" style="margin-top:16px"><strong>Unable to load market data</strong><div style="margin-top:8px;font-size:14px">Check connection or rebuild <code>data/fred_cache.json</code>.</div></div>`);
      }
    }

    process(){
      const S=this.data.raw?.series||{};
      const pull = (key) => {
        const obs=S[key]?.observations||[], xs=[], ys=[];
        for(const o of obs){ const v=this.safeNum(o.value); if(v==null||!o.date) continue; xs.push(this.gbDate(o.date)); ys.push(v); }
        return {xs,ys};
      };

      // Load series (expects these keys in fred_cache.json)
      const t10y3m = this.data.series.T10Y3M = pull('T10Y3M');
      const hyoas  = this.data.series.HYOAS  = pull('BAMLH0A0HYM2');  // HY OAS
      const nfci   = this.data.series.NFCI   = pull('NFCI');
      const icsa   = this.data.series.ICSA   = pull('ICSA');
      const vix    = this.data.series.VIXCLS = pull('VIXCLS');
      const dd12m  = this.data.series.DD_12M = pull('DD_12M');        // derived from SP500
      const t10yie = this.data.series.T10YIE = pull('T10YIE');
      const sahm   = this.data.series.SAHM   = pull('SAHMCURRENT');

      // Latest raw values
      this.data.latest.T10Y3M    = this.last(t10y3m.ys);
      this.data.latest.HYOAS     = this.last(hyoas.ys);
      this.data.latest.NFCI      = this.last(nfci.ys);
      this.data.latest.ICSA_D13W = this.pctChange13w(icsa);
      this.data.latest.T10YIE    = this.last(t10yie.ys);
      this.data.latest.SAHM      = this.last(sahm.ys);

      // Market stress = average of VIX risk and 12m drawdown risk (0–100)
      const vixRisk = this.scalesFromVIX(this.last(vix.ys));
      const ddRisk  = this.scalesFromDrawdown(this.last(dd12m.ys));
      this.data.latest.MKT_STRESS = (vixRisk!=null && ddRisk!=null) ? (vixRisk + ddRisk)/2 : null;

      // Composite
      let comp=0, wsum=0;
      for(const k of this.keys){
        const raw = this.data.latest[k];
        const sv = (raw==null) ? NaN : this.scales[k](raw);
        if(isFinite(sv)){ comp+=sv*(this.weights[k]||0); wsum+=this.weights[k]||0; }
      }
      this.data.composite = (wsum>0)? Math.round((comp/wsum)*10)/10 : null;
    }

    // Risk maps for components inside MKT_STRESS
    scalesFromVIX(v){ if(v==null) return null; return this.clamp(this.map(v, 12, 35)); }          // 12→0, 35→100
    scalesFromDrawdown(v){ if(v==null) return null; return this.clamp(this.map(v, 0.0, -0.25)); } // 0→0, -25%→100

    render(){
      this.renderGauge(); this.renderPills(); this.renderCompositeChart(); this.renderIndicatorCharts(); this.renderDiagnostics();
    }

    renderGauge(){
      const c=this.data.composite, z=this.zoneOf(c ?? 50);
      const badge=document.getElementById('garBadge'); badge.className='badge '+z; badge.textContent=z.toUpperCase(); badge.classList.remove('skeleton');
      // Hide text badge to keep the UI clean — needle + number is enough
      badge.style.display = 'none';

      const scoreEl=document.getElementById('scoreText'); scoreEl.textContent=isFinite(c)?Math.round(c):'–'; scoreEl.classList.remove('skeleton');
      this.setNeedle(c ?? 50);

      const ts=this.data.raw?.fetched_at_utc?new Date(this.data.raw.fetched_at_utc):null;
      document.getElementById('freshness').textContent=ts? `${ts.toLocaleDateString('en-GB',{day:'2-digit',month:'short'})} ${ts.toLocaleTimeString('en-GB',{hour:'2-digit',minute:'2-digit'})}`:'—';

      const ex={green:{title:'Low Risk Environment',description:'Signals look benign; limited systemic stress.'},
                amber:{title:'Moderate Risk Environment',description:'Some stress building. Monitor for deterioration.'},
                red:{title:'High Risk Environment',description:'Multiple stress signals elevated; turbulence risk high.'}}[z];
      const riskEl=document.getElementById('riskExplanation');
      document.getElementById('riskTitle').textContent=ex.title;
      document.getElementById('riskDescription').textContent=ex.description;
      riskEl.style.display='block';
    }

    renderPills(){
      const id={T10Y3M:'pill_t10y3m',HYOAS:'pill_hyoas',NFCI:'pill_nfci',ICSA_D13W:'pill_icsa',MKT_STRESS:'pill_mkt',T10YIE:'pill_t10yie',SAHM:'pill_sahm'};
      const label={T10Y3M:'Yield (10y–3m)',HYOAS:'HY OAS',NFCI:'NFCI',ICSA_D13W:'Claims Δ13w',MKT_STRESS:'Market stress',T10YIE:'10y BE',SAHM:'Sahm'};
      const fmt={
        T10Y3M:v=>v!=null? v.toFixed(2) : '—',
        HYOAS:v=>v!=null? Math.round(v*100)+'bp' : '—',
        NFCI:v=>v!=null? v.toFixed(3) : '—',
        ICSA_D13W:v=>v!=null? (v*100).toFixed(1)+'%' : '—',
        MKT_STRESS:v=>v!=null? Math.round(v)+'/100' : '—',
        T10YIE:v=>v!=null? v.toFixed(2)+'%' : '—',
        SAHM:v=>v!=null? v.toFixed(2) : '—'
      };
      for(const k of this.keys){
        const el=document.getElementById(id[k]); if(!el) continue;
        el.textContent = `${label[k]}: ${fmt[k](this.data.latest[k])}`;
        el.classList.remove('skeleton');
      }
    }

    renderCompositeChart(){
      const el=document.getElementById('compChart');
      const minLen=Math.min(
        this.data.series.T10Y3M?.ys.length||Infinity,
        this.data.series.HYOAS?.ys.length||Infinity,
        this.data.series.NFCI?.ys.length||Infinity,
        this.data.series.ICSA?.ys.length||Infinity,
        this.data.series.VIXCLS?.ys.length||Infinity,
        this.data.series.DD_12M?.ys.length||Infinity,
        this.data.series.T10YIE?.ys.length||Infinity,
        this.data.series.SAHM?.ys.length||Infinity
      );
      if(!isFinite(minLen)||minLen<3){ el.closest('.card').querySelector('.chart').innerHTML='<div class="err">Not enough overlapping history yet to draw composite chart.</div>'; return; }

      const tail=Math.min(minLen,90);
      const xs=this.data.series.T10Y3M.xs.slice(-tail), ys=[];
      for(let i=-tail;i<0;i++){
        const point={
          T10Y3M: this.scales.T10Y3M(this.data.series.T10Y3M.ys.at(i)),
          HYOAS:  this.scales.HYOAS(this.data.series.HYOAS.ys.at(i)),
          NFCI:   this.scales.NFCI(this.data.series.NFCI.ys.at(i)),
          ICSA_D13W: this.scales.ICSA_D13W(this.pctChange13w({ys:this.data.series.ICSA.ys.slice(0,this.data.series.ICSA.ys.length+i)})),
          MKT_STRESS: (()=>{
            const vix=this.scalesFromVIX(this.data.series.VIXCLS.ys.at(i));
            const dd =this.scalesFromDrawdown(this.data.series.DD_12M.ys.at(i));
            if(vix==null||dd==null) return null;
            return (vix+dd)/2;
          })(),
          T10YIE: this.scales.T10YIE(this.data.series.T10YIE.ys.at(i)),
          SAHM:   this.scales.SAHM(this.data.series.SAHM.ys.at(i))
        };
        let v=0,w=0;
        for(const k of this.keys){ const sv=point[k]; if(sv!=null && isFinite(sv)){ v+=sv*(this.weights[k]||0); w+=this.weights[k]||0; } }
        ys.push(w>0? Math.round((v/w)*10)/10 : null);
      }

      this.makeChart(el,{
        type:'line',
        data:{ labels:xs, datasets:[{ data:ys, borderColor:'#7da6ff', backgroundColor:'transparent', fill:false, tension:.4 }]},
        options:this.baseOpts({
          scales:{ y:{min:0,max:100} },
          plugins:{
            tooltip:{callbacks:{label:(c)=>`Composite: ${c.parsed.y}`}},
            annotation:{
              annotations:{
                green:{ type:'line', yMin:30, yMax:30, borderColor:'rgba(30,194,139,.6)', borderDash:[6,4], borderWidth:1 },
                amber:{ type:'line', yMin:60, yMax:60, borderColor:'rgba(255,194,71,.7)', borderDash:[6,4], borderWidth:1 }
              }
            }
          }
        })
      });
    }

    renderIndicatorCharts(){
      const cfgs=[
        {k:'T10Y3M', title:'Yield Curve (10y–3m)', desc:'<b>More negative = worse</b>. Inversions often precede recessions.', color:'#6bb9ff', zero:true},
        {k:'HYOAS',  title:'High Yield OAS (bps)', desc:'<b>Wider = worse</b>. Fast, contemporaneous credit stress.', color:'#ffb36b', zero:false,
          buildSeries:()=>({xs:this.data.series.HYOAS.xs, ys:this.data.series.HYOAS.ys.map(v=>v!=null? v*100 : v)})},
        {k:'NFCI',   title:'Chicago Fed NFCI', desc:'<b>Higher = tighter/worse</b>. Financial conditions composite.', color:'#9bd3c1', zero:true},
        {k:'ICSA_D13W', title:'Initial Claims (13-week % change)', desc:'<b>Higher = worse</b>. Early labour-market deterioration.', color:'#ffa0b5', zero:true,
          buildSeries:()=>{
            const s=this.data.series.ICSA, xs=[], ys=[];
            for(let i=13;i<s.ys.length;i++){
              const prior=s.ys[i-13], cur=s.ys[i];
              if(prior!=null && cur!=null && prior!==0){ xs.push(s.xs[i]); ys.push((cur-prior)/prior); }
            }
            return {xs, ys};
          },
          fmt:(v)=> (v!=null? (v*100).toFixed(1)+'%' : '—')
        },
        {k:'MKT_STRESS', title:'Market Stress (VIX + 12m Drawdown)', desc:'Average of VIX-risk and SPX drawdown-risk (0–100).', color:'#a6c7ff', zero:false,
          buildSeries:()=>{
            const n=Math.min(this.data.series.VIXCLS.ys.length, this.data.series.DD_12M.ys.length);
            const xs=this.data.series.VIXCLS.xs.slice(-n), ys=[];
            for(let i=0;i<n;i++){
              const vix=this.scalesFromVIX(this.data.series.VIXCLS.ys[i]);
              const dd =this.scalesFromDrawdown(this.data.series.DD_12M.ys[i]);
              ys.push( (vix!=null && dd!=null)? (vix+dd)/2 : null );
            }
            return {xs, ys};
          }
        },
        {k:'T10YIE', title:'10y Breakeven Inflation (%)', desc:'Inflation expectations context; higher can imply tighter policy risk.', color:'#c6b5ff', zero:false},
        {k:'SAHM', title:'Sahm Rule (current)', desc:'Recession confirmation; kept at low weight to avoid whipsaw.', color:'#e7c676', zero:false}
      ];

      const host=document.getElementById('charts'); host.innerHTML='';
      for(const c of cfgs){
        const sec=document.createElement('section'); sec.className='card'; sec.setAttribute('aria-labelledby','chart-'+c.k);
        sec.innerHTML=`<h3 id="chart-${c.k}" style="margin:0 0 8px">${c.title}</h3>
          <div class="chart"><canvas id="c_${c.k}" aria-label="${c.title} over time"></canvas></div>
          <div class="callout">${c.desc}</div>`;
        host.appendChild(sec);

        const s = c.buildSeries ? c.buildSeries() : (this.data.series[c.k] || {xs:[],ys:[]});
        if(!s.ys?.length){ sec.querySelector('.chart').innerHTML=`<div class="err">No data available for ${c.title}</div>`; continue; }

        this.makeChart(document.getElementById('c_'+c.k),{
          type:'line',
          data:{ labels:s.xs.slice(-90), datasets:[{ data:s.ys.slice(-90), borderColor:c.color, backgroundColor:'transparent', fill:false, tension:.4 }]},
          options:this.baseOpts({
            plugins: c.zero ? { annotation:{ annotations:{ zero:{ type:'line', yMin:0, yMax:0, borderColor:'rgba(154,166,191,.6)', borderDash:[4,4], borderWidth:1 }}}} : {}
          })
        });
      }
    }

    baseOpts(ovr={}){
      const base={
        responsive:true, maintainAspectRatio:false,
        scales:{
          x:{
            grid:{color:'rgba(255,255,255,.04)'},
            ticks:{
              color:'#9aa6bf',
              font:{size:10},
              maxRotation:0,
              autoSkip:true,
              maxTicksLimit:6,
              callback:function(value,index,ticks){
                const raw = ticks?.[index]?.label ?? '';
                const d = new Date(raw);
                if(!isNaN(d)) return d.toLocaleDateString('en-GB',{day:'2-digit',month:'short'}); // dd-Mon
                return raw;
              }
            }
          },
          y:{ grid:{color:'rgba(255,255,255,.04)'}, ticks:{ color:'#9aa6bf' } }
        },
        plugins:{ legend:{display:false}, tooltip:{enabled:true} },
        elements:{ line:{tension:.4,borderWidth:2}, point:{radius:2,hitRadius:8,hoverRadius:6} },
        animation:{ duration:800, easing:'easeOutQuart' }
      };
      return {...base, ...ovr, scales:{...base.scales, ...(ovr.scales||{})}, plugins:{...base.plugins, ...(ovr.plugins||{})}};
    }

    makeChart(el,cfg){
      try{
        if(this.charts.has(el)) this.charts.get(el).destroy();
        try{ const ap=(window.ChartAnnotation||window['chartjs-plugin-annotation']); if(ap && !Chart.registry.getPlugin('annotation')) Chart.register(ap); }catch(e){}
        const chart=new Chart(el,cfg); this.charts.set(el,chart); return chart;
      }catch(e){ console.error('Chart error:',e); el.closest('.chart').innerHTML=`<div class="err">Chart error: ${e.message}</div>`; return null;}
    }

    renderDiagnostics(){
      const diag=document.getElementById('diag');
      const out={
        fetched_at_utc:this.data.raw?.fetched_at_utc||null,
        latest_values:Object.fromEntries(this.keys.map(k=>[k,this.data.latest[k]])),
        sample_sizes:{
          T10Y3M:this.data.series.T10Y3M?.ys.length||0,
          HYOAS:this.data.series.HYOAS?.ys.length||0,
          NFCI:this.data.series.NFCI?.ys.length||0,
          ICSA:this.data.series.ICSA?.ys.length||0,
          VIXCLS:this.data.series.VIXCLS?.ys.length||0,
          DD_12M:this.data.series.DD_12M?.ys.length||0,
          T10YIE:this.data.series.T10YIE?.ys.length||0,
          SAHM:this.data.series.SAHM?.ys.length||0
        },
        composite:this.data.composite,
        calculation_timestamp:new Date().toISOString()
      };
      if(diag) diag.textContent=JSON.stringify(out,null,2);
      const ut=document.getElementById('update-time');
      if(ut) ut.textContent=new Date().toLocaleTimeString('en-GB',{hour:'2-digit',minute:'2-digit'});
    }

    destroy(){ this.charts.forEach(c=>c.destroy()); this.charts.clear(); }
  }

  if(document.readyState==='loading'){ document.addEventListener('DOMContentLoaded',()=>new CrashRadar()); } else { new CrashRadar(); }
  </script>
</body>
</html>
