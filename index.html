<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Economic Crash Radar Pro</title>
<style>
:root{
  --bg:#0a0e1a; --panel:#12182b; --panel-hover:#151d33; --text:#e8eeff; --muted:#8b96b0;
  --accent:#6b9eff; --accent-bright:#8fb4ff; --green:#1ec28b; --amber:#ffc247; --red:#ff6070;
}
*{box-sizing:border-box;margin:0;padding:0}
body{background:var(--bg);color:var(--text);font:15px/1.6 -apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;-webkit-font-smoothing:antialiased}
.wrap{max-width:1600px;margin:0 auto;padding:24px 16px 80px}
h1{font-size:clamp(34px,6vw,54px);line-height:1.08;font-weight:800;margin-bottom:8px;background:linear-gradient(135deg,var(--text),var(--accent-bright));-webkit-background-clip:text;-webkit-text-fill-color:transparent;letter-spacing:-.02em}
.subtitle{color:var(--muted);font-weight:600}
.header{display:flex;justify-content:space-between;align-items:flex-start;gap:16px;flex-wrap:wrap;margin-bottom:18px}
.badges{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
.badge{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border:1px solid rgba(255,255,255,.08);background:rgba(255,255,255,.04);border-radius:10px;font-weight:700}
.live-dot{width:8px;height:8px;border-radius:50%;background:var(--green);box-shadow:0 0 10px var(--green)}
.btn{display:inline-flex;align-items:center;gap:8px;padding:10px 16px;border:none;border-radius:10px;background:var(--accent);color:#fff;font-weight:700;cursor:pointer;transition:all .2s}
.btn:hover{background:var(--accent-bright);transform:translateY(-1px)}
.card{background:var(--panel);border:1px solid rgba(255,255,255,.06);border-radius:16px;padding:24px;margin:18px 0;box-shadow:0 4px 24px rgba(0,0,0,.3);transition:all .3s}
.card:hover{box-shadow:0 8px 32px rgba(0,0,0,.4);transform:translateY(-2px)}
.status-pill{display:inline-flex;align-items:center;gap:10px;padding:10px 16px;border:1px solid rgba(255,255,255,.1);border-radius:12px;background:rgba(255,255,255,.04);font-weight:700}
.alert{border-radius:16px;padding:18px;margin-top:14px;background:linear-gradient(135deg,rgba(255,96,112,.12),rgba(255,194,71,.12));border:1px solid rgba(255,96,112,.25)}
.audit{border-radius:12px;padding:12px;margin:12px 0;background:rgba(255,96,112,.08);border:1px dashed rgba(255,96,112,.4);display:none}
.tabs{display:flex;gap:8px;border-bottom:2px solid rgba(255,255,255,.06);margin-top:8px}
.tab{background:transparent;border:none;color:var(--muted);padding:12px 18px;font-weight:800;cursor:pointer;border-radius:8px 8px 0 0;transition:all .2s}
.tab.active{color:var(--accent-bright);background:rgba(255,255,255,.03)}
.tab:hover:not(.active){color:var(--text);background:rgba(255,255,255,.02)}
.view{display:none;animation:fadeIn .5s ease}.view.active{display:block}
@keyframes fadeIn{from{opacity:0}to{opacity:1}}
.gauge{display:flex;gap:36px;align-items:center;flex-wrap:wrap}
.gauge-wrap{position:relative;width:220px;height:220px}
.ring{position:absolute;inset:0;border-radius:50%;background:conic-gradient(var(--green) 0 108deg,var(--amber)108deg 216deg,var(--red)216deg 360deg);opacity:.35}
.ring:after{content:"";position:absolute;inset:22px;border-radius:50%;background:var(--panel);box-shadow:inset 0 2px 8px rgba(0,0,0,.35)}
.needle{position:absolute;inset:0}
.needle:before{content:"";position:absolute;top:50%;left:50%;width:6px;height:48%;transform-origin:bottom center;transform:translate(-50%,-100%) rotate(var(--angle,0deg));background:linear-gradient(180deg,var(--accent-bright),var(--accent));border-radius:6px 6px 0 0;box-shadow:0 0 10px var(--accent);transition:transform 1s ease}
.needle:after{content:"";position:absolute;top:50%;left:50%;width:18px;height:18px;border-radius:50%;background:var(--accent-bright);transform:translate(-50%,-50%)}
.score{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;flex-direction:column;font-weight:800;z-index:1}
.score .v{font-size:56px;background:linear-gradient(135deg,var(--text),var(--accent-bright));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.score .l{font-size:11px;color:var(--muted);letter-spacing:1px;margin-top:4px}
.kpi-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:12px}
.kpi{border:1px solid rgba(255,255,255,.06);border-radius:12px;padding:16px;background:rgba(255,255,255,.03);transition:all .2s}
.kpi:hover{border-color:rgba(255,255,255,.1);background:rgba(255,255,255,.05)}
.kpi h4{display:flex;align-items:center;justify-content:space-between;font-size:14px;margin-bottom:6px}
.dot{width:10px;height:10px;border-radius:50%}
.dot.g{background:var(--green);box-shadow:0 0 8px var(--green)}
.dot.a{background:var(--amber);box-shadow:0 0 8px var(--amber)}
.dot.r{background:var(--red);box-shadow:0 0 8px var(--red)}
.small{font-size:12px;color:var(--muted)}
.kpi .val{font-size:28px;font-weight:800;margin:8px 0}
.badge{font-size:10px;padding:3px 8px;border-radius:6px;border:1px solid}
.b-fresh{color:var(--green);border-color:rgba(30,194,139,.35);background:rgba(30,194,139,.15)}
.b-stale{color:var(--amber);border-color:rgba(255,194,71,.5);background:rgba(255,194,71,.15)}
.toggle-desc{cursor:pointer;font-size:12px;color:var(--accent-bright);transition:color .2s}
.toggle-desc:hover{color:var(--accent-bright)}
.desc{display:none;font-size:12px;color:var(--muted);margin-top:6px}
.show .desc{display:block}
.btns{display:flex;gap:6px;background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.06);padding:4px;border-radius:10px}
.btns button{background:transparent;border:none;color:var(--muted);padding:6px 10px;border-radius:8px;font-weight:700;cursor:pointer;transition:all .2s}
.btns button.active{background:var(--accent);color:#fff}
.btns button:hover:not(.active){background:rgba(255,255,255,.05);color:var(--text)}
.chart{position:relative;height:360px;margin-top:12px}
.heat{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:12px}
.cell{border:1px solid rgba(255,255,255,.06);border-radius:10px;padding:14px;background:rgba(255,255,255,.03);transition:all .2s}
.cell:hover{border-color:rgba(255,255,255,.1);background:rgba(255,255,255,.05)}
.bar{height:8px;border-radius:6px;background:rgba(255,255,255,.06);overflow:hidden;margin-top:8px}
.bar>span{display:block;height:100%;transition:width .5s ease}
.radar-chart{height:320px;margin-top:20px}
.risk-meter{display:flex;align-items:center;gap:12px;margin-top:8px}
.risk-level{width:100%;height:8px;border-radius:4px;background:rgba(255,255,255,.1);overflow:hidden}
.risk-level>div{height:100%;transition:width .5s ease}
.risk-labels{display:flex;justify-content:space-between;margin-top:4px}
.risk-labels span{font-size:10px;color:var(--muted)}
.loading{display:flex;justify-content:center;align-items:center;height:200px;font-size:16px;color:var(--muted)}
@media (max-width:768px){.gauge{flex-direction:column;align-items:center}}
</style>
</head>
<body>
<div class="wrap">
  <div class="header">
    <div>
      <h1>‚ö° Economic Crash Radar Pro</h1>
      <div class="subtitle">World-class institutional analytics (FRED-only)</div>
    </div>
    <div style="display:flex;gap:10px">
      <button class="btn" id="refreshBtn">üîÑ Refresh</button>
      <button class="btn" id="exportBtn">üì• Export Report</button>
    </div>
  </div>

  <div class="badges">
    <div class="badge"><span class="live-dot"></span> Live Data</div>
    <div class="badge" id="upd">Last Update: --</div>
    <div class="badge" id="qual">Quality: --</div>
    <div class="badge" id="indicatorsCount">Indicators: --/10</div>
  </div>

  <div class="audit" id="auditBox"></div>
  <div class="status-pill" id="regime">--</div>
  <div class="alert" id="alert" style="display:none"></div>

  <div class="card">
    <div class="gauge">
      <div class="gauge-wrap">
        <div class="ring"></div>
        <div class="needle" id="needle"></div>
        <div class="score"><div class="v" id="scoreV">--</div><div class="l">COMPOSITE STRESS</div></div>
      </div>
      <div style="flex:1;min-width:280px">
        <h2 style="margin:0 0 6px">Market Stress Index</h2>
        <div class="small" id="partsNote">Composite derived from 0 indicators</div>

        <div style="margin-top:10px;display:flex;align-items:center;gap:10px" class="badge">
          <span>Data Quality</span>
          <div style="width:90px;height:8px;background:rgba(255,255,255,.1);border-radius:4px;overflow:hidden"><div id="qfill" style="height:100%;background:linear-gradient(90deg,#4a7fe8,var(--accent-bright));width:0%"></div></div>
          <strong id="qtxt">--</strong>
        </div>

        <div class="risk-meter">
          <span class="small">Risk Level:</span>
          <div class="risk-level">
            <div id="riskFill" style="width:0%;background:linear-gradient(90deg,var(--green),var(--amber),var(--red))"></div>
          </div>
        </div>
        <div class="risk-labels">
          <span>Low</span><span>Medium</span><span>High</span><span>Critical</span>
        </div>

        <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:10px;margin-top:12px">
          <div class="kpi"><div class="small">1-Month Risk</div><div class="val" id="r1m">--</div><div class="small" id="m1dir">‚Üí Momentum</div></div>
          <div class="kpi"><div class="small">3-Month Risk</div><div class="val" id="r3m">--</div><div class="small" id="m3dir">‚Üí Elevated</div></div>
          <div class="kpi"><div class="small">6-Month Risk</div><div class="val" id="r6m">--</div><div class="small" id="m6dir">‚Üó Accelerating</div></div>
        </div>
      </div>
    </div>
  </div>

  <div class="tabs">
    <button class="tab active" data-t="overview">Overview</button>
    <button class="tab" data-t="ind">Indicators</button>
    <button class="tab" data-t="hist">Historical</button>
    <button class="tab" data-t="scn">Scenarios</button>
    <button class="tab" data-t="news">News & Events</button>
  </div>

  <div id="view-overview" class="view active">
    <div class="card">
      <h3 style="margin-bottom:12px">üìä Live Indicator Dashboard</h3>
      <div class="kpi-grid" id="pillGrid"></div>
    </div>

    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap">
        <h3 style="margin:0">üìà Composite Trend Analysis</h3>
        <div class="btns">
          <button data-p="30d" class="active">30D</button>
          <button data-p="90d">90D</button>
          <button data-p="6m">6M</button>
          <button data-p="1y">1Y</button>
          <button data-p="all">ALL</button>
        </div>
      </div>
      <div class="chart"><canvas id="mainChart"></canvas></div>
    </div>
  </div>

  <div id="view-ind" class="view">
    <div class="card">
      <h3 style="margin-bottom:10px">Risk Contribution Breakdown</h3>
      <div class="chart"><canvas id="decomp"></canvas></div>
    </div>

    <div class="card">
      <h3 style="margin-bottom:10px">Indicator Radar</h3>
      <div class="radar-chart"><canvas id="radarChart"></canvas></div>
    </div>

    <div class="card">
      <h3 style="margin-bottom:10px">Indicator Heat Map</h3>
      <div class="heat" id="heat"></div>
    </div>
  </div>

  <div id="view-hist" class="view">
    <div class="card">
      <h3 style="margin-bottom:10px">üìà Historical Crisis Comparisons</h3>
      <div id="crises" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:12px"></div>
    </div>

    <div class="card">
      <h3 style="margin-bottom:10px">Crisis Timeline</h3>
      <div class="chart"><canvas id="crisisTimeline"></canvas></div>
    </div>
  </div>

  <div id="view-scn" class="view">
    <div class="card">
      <h3 style="margin-bottom:10px">üéØ Forward-Looking Scenarios</h3>
      <div id="scenarios" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:12px"></div>
    </div>
    <div class="card">
      <h3 style="margin-bottom:10px">Risk Trajectory Forecast (26 Weeks)</h3>
      <div class="chart"><canvas id="traj"></canvas></div>
    </div>
  </div>

  <div id="view-news" class="view">
    <div class="card">
      <h3 style="margin-bottom:10px">üì∞ Market News & Events</h3>
      <div id="newsFeed" class="loading">Loading market news...</div>
    </div>

    <div class="card">
      <h3 style="margin-bottom:10px">üóìÔ∏è Upcoming Economic Events</h3>
      <div id="economicCalendar" class="loading">Loading economic calendar...</div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script>
'use strict';

/* ===================== CONFIG ===================== */
const CONFIG = {
  FRED_CACHE_PATH: 'data/fred_cache.json',

  // 10 indicators; SAHM is shown but unweighted (flag).
  INDICATORS: {
    T10Y3M:{label:'Yield Curve',short:'Yield',weight:0.20,format:v=>v?.toFixed(2)+'%',crisis:-1.0,dir:'below',
      desc:'10y‚Äì3m Treasury spread. Inversions typically precede recessions by 6‚Äì18 months.'},
    CREDIT:{label:'Credit Spread',short:'Credit',weight:0.20,format:v=>v?.toFixed(2)+'%',crisis:5.5,dir:'above',
      desc:'US HY OAS. Wider spreads signal rising default risk & tighter liquidity.'},
    NFCI:{label:'Financial Conditions',short:'NFCI',weight:0.15,format:v=>v?.toFixed(3),crisis:0.50,dir:'above',
      desc:'Chicago Fed NFCI. >0 = tighter than average; stress rises with + readings.'},
    UN_SLOPE6:{label:'Unemp Slope (6m)',short:'U-Slope6',weight:0.10,format:v=>v?.toFixed(2)+' pp',crisis:0.30,dir:'above',
      desc:'Change in unemployment rate over 6 months (percentage points).'},
    VALUATION:{label:'Valuation',short:'Valuation',weight:0.10,
      format:v=>v>20? (v?.toFixed(0)+'% MC/GDP') : (v?.toFixed(2)+'% EY'),
      crisis:null,dir:'above',
      desc:'Market-cap/GDP (Buffett) or Earnings Yield fallback. High MC/GDP or low EY = higher crash susceptibility.'},
    DD_12M:{label:'Market Drawdown',short:'Drawdown',weight:0.08,format:v=>((v??0)*100).toFixed(1)+'%',crisis:-0.25,dir:'below',
      desc:'S&P 500 drawdown from 12-month peak. < ‚àí20% = bear territory.'},
    SENTIMENT:{label:'Consumer Sentiment',short:'Sent',weight:0.07,format:v=>v?.toFixed(0),crisis:60,dir:'below',
      desc:'UMich Sentiment. Persistent lows correlate with weak demand & risk-off.'},
    RETAIL_MOMENTUM:{label:'Retail Momentum',short:'Retail',weight:0.05,format:v=>v?.toFixed(1)+'%',crisis:-2.0,dir:'below',
      desc:'RSAFS 3m/3m annualised growth. Weaker growth ‚Üí higher stress.'},
    VIX_PROXY:{label:'Volatility',short:'VIX',weight:0.05,format:v=>v?.toFixed(1),crisis:40,dir:'above',
      desc:'VIXCLS. <15 calm, 15‚Äì25 elevated, 25‚Äì35 stressed, >35 fear.'},
    SAHM_RULE:{label:'Sahm Rule (flag)',short:'Sahm',weight:0.00,format:v=>v?.toFixed(2),crisis:0.50,dir:'above',
      desc:'Unemployment 3m avg minus 12m low. Useful flag; not weighted in composite.'}
  },

  // Accept multiple possible keys from the cache
  ALIAS:{
    T10Y3M:['T10Y3M'],
    CREDIT:['BAMLH0A0HYM2'],
    NFCI:['NFCI'],
    VIX_PROXY:['VIXCLS'],
    SENTIMENT:['UMCSENT'],
    RETAIL_BASE:['RSAFS'],
    UNRATE:['UNRATE'],
    SPX:['SP500','SPX','^GSPC'],
    VALUATION:['DDDM01USA156NWDB','Q13051USQ156NNBR'] // MC/GDP, fallback: Earnings Yield
  },

  INSIGHTS: [
    {min: 0, max: 30, text: "Favourable: stress low; conditions benign but keep discipline."},
    {min: 31, max: 50, text: "Moderate stress: early warning; review tilts and buffers."},
    {min: 51, max: 70, text: "Elevated: volatility risk higher; raise liquidity/hedges."},
    {min: 71, max: 85, text: "High: crisis probability rising; execute contingency steps."},
    {min: 86, max: 100, text: "Critical: crisis protocols; maximum defense/liquidity."}
  ]
};

/* ===================== SCALE (0‚Äì100 stress) ===================== */
const SCALE = {
  T10Y3M:v=>clamp((Math.max(0,-v)/1.5)*100),
  CREDIT:v=>{
    if (v<=4.0) return clamp((v/4.0)*10);
    if (v<=5.5) return clamp(10 + ((v-4.0)/1.5)*60);
    return clamp(70 + Math.min(30,(v-5.5)/3.0*30));
  },
  NFCI:v=>clamp(((v + 0.80)/1.20)*100),
  UN_SLOPE6:v=>clamp(((v - 0)/0.6)*100),
  VALUATION:v=>{
    if (v==null || !isFinite(v)) return 0;
    if (v>20) return clamp(((v - 100)/80)*100); // MC/GDP % : 100‚Üí0, 180‚Üí100
    return clamp(((6 - v)/4)*100);              // Earnings Yield % : lower‚Üímore stress
  },
  DD_12M:v=>clamp((0 - v)/0.20*100),
  SENTIMENT:v=>clamp(((80 - v)/40)*100),
  RETAIL_MOMENTUM:v=>clamp(((2 - v)/4)*100),
  VIX_PROXY:v=>clamp(((v - 12)/23)*100),
  SAHM_RULE:v=>clamp((v/0.5)*100) // unweighted but displayed
};
function clamp(x){return Math.max(0,Math.min(100,x));}

/* ===================== BOOT ===================== */
let app={boundPeriods:false,boundTabs:false};
window.addEventListener('DOMContentLoaded',init);

async function init(){
  setLoading(true);
  try{
    const cache = await fetch(`${CONFIG.FRED_CACHE_PATH}?t=${Date.now()}`,{cache:'no-store'}).then(r=>r.json());
    const s = k=> resolveSeries(cache, CONFIG.ALIAS[k]);
    const now = new Date(); byId('upd').textContent='Last Update: '+now.toLocaleTimeString();

    const ser = {
      T10Y3M:s('T10Y3M'), CREDIT:s('CREDIT'), NFCI:s('NFCI'),
      VIX:s('VIX_PROXY'), UMCSENT:s('SENTIMENT'), RSAFS:s('RETAIL_BASE'),
      UNRATE:s('UNRATE'), SPX:s('SPX'), VALUATION:s('VALUATION')
    };

    const deriv = buildDerived(ser);
    const kpis  = computeLatestKPIs(ser, deriv);

    // ===== Audit: show any missing series clearly
    auditMissing(ser, deriv);

    const history = buildCompositeHistory(pickAnchorDates(ser), ser, deriv);

    renderTop(kpis, history);
    renderPills(kpis);
    renderHeat(kpis);
    renderDecomp(kpis);
    renderRadar(kpis);
    renderCrises(history);
    renderScenarios(history);
    renderNewsFeed();
    setupTabs();
    setupPeriodButtons(history);

    byId('refreshBtn').onclick = ()=>init();
    byId('exportBtn').onclick  = ()=>exportReport(kpis, history);
  }catch(e){
    console.error(e); showError();
  }finally{ setLoading(false); }
}

function setLoading(b){document.body.style.opacity=b?'0.7':'1';document.body.style.pointerEvents=b?'none':'auto'}
function showError(){
  document.body.innerHTML=`<div class="wrap" style="text-align:center;padding-top:100px">
    <h1 style="color:var(--red)">‚ö†Ô∏è Data Loading Error</h1>
    <p style="color:var(--muted);margin:20px 0">Couldn‚Äôt load <code>data/fred_cache.json</code>. Check path/case & schema.</p>
    <button class="btn" onclick="location.reload()">üîÑ Retry</button></div>`;
}
function byId(id){return document.getElementById(id)}
function resolveSeries(cache, aliases){ if(!cache||!aliases) return null; for(const k of aliases){ if(cache[k]) return cache[k]; } return null; }
function lastValidObs(series){
  if(!series?.observations?.length) return null;
  for(let i=series.observations.length-1;i>=0;i--){
    const v=parseFloat(series.observations[i].value);
    if(isFinite(v)) return {date:series.observations[i].date, value:v};
  } return null;
}
function parseDate(d){return new Date(d)}
function daysSince(d){return Math.floor((Date.now()-parseDate(d))/86400000)}

/* ===================== DERIVED ===================== */
function buildDerived(ser){
  const out={};

  // SAHM & slope 6m from UNRATE
  if(ser.UNRATE?.observations){
    const map = obsMap(ser.UNRATE.observations), mkeys=Object.keys(map).sort();
    const sahm=[], slope6=[];
    for(const ym of mkeys){
      const cur = map[ym], m1=map[monthOffset(ym,-1)], m2=map[monthOffset(ym,-2)];
      if(m1!==undefined && m2!==undefined){
        const avg3=(cur+m1+m2)/3;
        let low12=Infinity; for(let i=0;i<12;i++){ const k=monthOffset(ym,-i); if(map[k]!==undefined) low12=Math.min(low12,map[k]); }
        if(low12<Infinity) sahm.push({date:ym+'-01', value:+(avg3-low12).toFixed(2)});
      }
      const back6 = map[monthOffset(ym,-6)]; if(back6!==undefined) slope6.push({date:ym+'-01', value:+(cur-back6).toFixed(2)});
    }
    out.SAHM_RULE={observations:sahm}; out.UN_SLOPE6={observations:slope6};
  }

  // 12-month drawdown from SPX
  if(ser.SPX?.observations){
    const obs=ser.SPX.observations.filter(o=>isFinite(parseFloat(o.value)));
    const vals=[], outObs=[];
    for(let i=0;i<obs.length;i++){
      const p=parseFloat(obs[i].value); vals.push(p);
      const start=Math.max(0,i-252); let max=-Infinity; for(let j=start;j<=i;j++) if(vals[j]>max) max=vals[j];
      outObs.push({date:obs[i].date, value:+(p/max - 1).toFixed(4)});
    }
    out.DD_12M = {observations: outObs};
  }

  // Retail momentum (3m/3m annualised)
  if(ser.RSAFS?.observations){
    const map = obsMap(ser.RSAFS.observations), mkeys=Object.keys(map).sort(), outR=[];
    for(const ym of mkeys){
      const back3=map[monthOffset(ym,-3)];
      if(back3!==undefined){ const g=((map[ym]/back3)-1)*4*100; outR.push({date:ym+'-01', value:+g.toFixed(2)}); }
    }
    out.RETAIL_MOMENTUM={observations:outR};
  }

  if(ser.VIX) out.VIX_PROXY=ser.VIX;
  if(ser.UMCSENT) out.SENTIMENT=ser.UMCSENT;
  if(ser.VALUATION) out.VALUATION=ser.VALUATION; // pass-through (monthly/quarterly ok)

  return out;
}
function obsMap(observations){const m={}; for(const o of observations){const v=parseFloat(o.value); if(!isFinite(v)) continue; m[o.date.slice(0,7)]=v;} return m;}
function monthOffset(ym,off){const [y,m]=ym.split('-').map(Number); const d=new Date(y,m-1,1); d.setMonth(d.getMonth()+off); return d.toISOString().slice(0,7);}

/* ===================== KPIs ===================== */
function computeLatestKPIs(ser, deriv){
  const out=[];
  const defs=CONFIG.INDICATORS;
  function add(key, source){
    const def=defs[key], lv=lastValidObs(source);
    if(!lv) return;
    const raw=lv.value, scaled=SCALE[key](raw);
    const rag= scaled<30?'g':(scaled<60?'a':'r');
    const crisis = def.crisis==null ? false : (def.dir==='below' ? raw<=def.crisis : raw>=def.crisis);
    out.push({key,label:def.label,short:def.short,desc:def.desc,weight:def.weight,date:lv.date,raw,scaled,disp:def.format(raw),rag,crisis});
  }
  add('T10Y3M', ser.T10Y3M);
  add('CREDIT', ser.CREDIT);
  add('NFCI',   ser.NFCI);
  add('UN_SLOPE6', deriv.UN_SLOPE6);
  add('VALUATION', deriv.VALUATION || ser.VALUATION);
  add('DD_12M', deriv.DD_12M);
  add('SENTIMENT', deriv.SENTIMENT);
  add('RETAIL_MOMENTUM', deriv.RETAIL_MOMENTUM);
  add('VIX_PROXY', deriv.VIX_PROXY);
  add('SAHM_RULE', deriv.SAHM_RULE); // display only
  return out;
}

/* ===================== HISTORY ===================== */
function pickAnchorDates(ser){
  const s = ser.SPX?.observations?.length ? ser.SPX
        : ser.T10Y3M?.observations?.length ? ser.T10Y3M
        : ser.CREDIT?.observations?.length ? ser.CREDIT
        : ser.NFCI;
  return (s?.observations||[]).filter(o=>isFinite(parseFloat(o.value))).map(o=>o.date);
}
function valueOnOrBefore(arr, date){
  if(!arr?.length) return null;
  let lo=0,hi=arr.length-1,ans=null;
  while(lo<=hi){ const mid=(lo+hi)>>1, d=arr[mid].date; if(d<=date){ans=arr[mid]; lo=mid+1}else hi=mid-1 }
  return ans ? parseFloat(ans.value) : null;
}
function buildCompositeHistory(anchorDates, ser, deriv){
  const keys = Object.keys(CONFIG.INDICATORS);
  const look = k => (['VIX_PROXY','SENTIMENT','RETAIL_MOMENTUM','SAHM_RULE','UN_SLOPE6','DD_12M','VALUATION'].includes(k) ? (deriv[k]||ser[k]) : ser[k]);

  const obs={};
  for(const k of keys){
    const src=look(k); if(!src?.observations) continue;
    obs[k]=src.observations.filter(o=>isFinite(parseFloat(o.value))).sort((a,b)=>a.date.localeCompare(b.date));
  }

  const hist=[];
  for(const d of anchorDates){
    let sum=0,wsum=0;
    for(const k of keys){
      const arr=obs[k]; if(!arr) continue;
      const v=valueOnOrBefore(arr,d); if(v==null) continue;
      const w=CONFIG.INDICATORS[k].weight; sum+=SCALE[k](v)*w; wsum+=w;
    }
    if(wsum>0) hist.push({date:d, composite:+(sum/wsum).toFixed(2)});
  }
  return hist;
}

/* ===================== COMPOSITE & AUDIT ===================== */
function compositeFromKPIs(kpis){
  let sum=0,wsum=0;
  kpis.forEach(k=>{
    let w=k.weight; const staleCut=(k.key==='VALUATION'?60:7);
    if(daysSince(k.date)>staleCut) w*=0.5;
    sum+=k.scaled*w; wsum+=w;
  });
  return wsum>0 ? +(sum/wsum).toFixed(2) : 50;
}
function auditMissing(ser, deriv){
  const need = {
    T10Y3M:ser.T10Y3M, CREDIT:ser.CREDIT, NFCI:ser.NFCI, UN_SLOPE6:deriv.UN_SLOPE6,
    VALUATION:deriv.VALUATION||ser.VALUATION, DD_12M:deriv.DD_12M, SENTIMENT:deriv.SENTIMENT,
    RETAIL_MOMENTUM:deriv.RETAIL_MOMENTUM, VIX_PROXY:deriv.VIX_PROXY, SAHM_RULE:deriv.SAHM_RULE
  };
  const missing = Object.entries(need).filter(([,v])=>!v||!v.observations?.length).map(([k])=>k);
  const box=byId('auditBox');
  if(missing.length){
    box.style.display='block';
    box.innerHTML = `üîé Missing or empty series in <code>fred_cache.json</code>: <strong>${missing.join(', ')}</strong><br/>
    Expected keys present? <code>${JSON.stringify(CONFIG.ALIAS)}</code><br/>
    Tip: open DevTools console and run <code>window.CR_DEBUG()</code> to inspect cache keys.`;
  }else box.style.display='none';
}

/* ===================== RENDER ===================== */
function renderTop(kpis, history){
  const composite = compositeFromKPIs(kpis);
  const zone = composite<=30?'green':(composite<=60?'amber':'red');
  byId('scoreV').textContent = Math.round(composite);
  byId('needle').style.setProperty('--angle', `${composite*3.6}deg`);
  byId('partsNote').textContent = `Composite derived from ${kpis.filter(k=>k.weight>0).length} indicators`;
  byId('indicatorsCount').textContent = `Indicators: ${kpis.length}/10`;
  byId('riskFill').style.width = `${composite}%`;

  // Quality: missing + stale penalty
  const missing = 10 - kpis.length;
  let stale=0; kpis.forEach(k=>{ if(daysSince(k.date)>(k.key==='VALUATION'?60:7)) stale++; });
  const quality = Math.max(40, 100 - (missing*12 + stale*6));
  byId('qfill').style.width = quality+'%'; byId('qtxt').textContent = quality+'%';
  byId('qual').textContent = 'Quality: '+quality+'%';

  const status = zone==='green'?'Normal':(zone==='amber'?'Elevated':'Critical');
  byId('regime').innerHTML = `<span style="width:12px;height:12px;border-radius:50%;background:var(--${zone});box-shadow:0 0 10px var(--${zone})"></span> <strong style="font-size:18px">${Math.round(composite)}</strong> | ${status} Market Regime`;

  const alerts = kpis.filter(p=>p.crisis);
  const alertBox = byId('alert');
  if(composite>=80){ alertBox.style.display='block'; alertBox.innerHTML = `üö® <strong>CRITICAL</strong> ‚Äî Stress ${Math.round(composite)}. ${alerts.length} indicator(s) at crisis.`; }
  else if(alerts.length>0){ alertBox.style.display='block'; alertBox.innerHTML = `‚ö†Ô∏è <strong>ATTENTION</strong> ‚Äî ${alerts.length} indicator(s) at crisis threshold.`; }
  else alertBox.style.display='none';

  // Simple horizon ‚Äúrisk‚Äù dials (heuristics)
  const r1m = Math.round(20 + composite*0.6);
  const r3m = Math.round(30 + composite*0.7);
  const r6m = Math.round(40 + composite*0.8);
  byId('r1m').textContent = r1m + '%'; byId('r3m').textContent = r3m + '%'; byId('r6m').textContent = r6m + '%';
  byId('m1dir').innerHTML = getTrendIndicator(r1m);
  byId('m3dir').innerHTML = getTrendIndicator(r3m);
  byId('m6dir').innerHTML = getTrendIndicator(r6m);

  const insight = CONFIG.INSIGHTS.find(i => composite >= i.min && composite <= i.max);
  if (insight) { // optional insight card suppressed if no match
    const cardText = insight.text + (alerts.length? ` (${alerts.length} crisis flag${alerts.length>1?'s':''})`:'');
    addInsight(cardText);
  }
  drawTrend(history,'30d');
}
function getTrendIndicator(v){ if(v<30) return '‚Üì Low Risk'; if(v<50) return '‚Üí Moderate'; if(v<70) return '‚Üó Elevated'; return '‚Üó‚Üë High Risk'; }
function addInsight(txt){
  let card=document.querySelector('.card .insight-card'); if(!card){ card=document.createElement('div'); card.className='insight-card'; document.querySelector('.card').appendChild(card); card.innerHTML='<h4>üí° Market Insight</h4><div id="insightText"></div>'; }
  byId('insightText').textContent = txt;
}

function pill(node){ node.addEventListener('click',()=>node.classList.toggle('show')); }
function renderPills(kpis){
  const grid=byId('pillGrid');
  grid.innerHTML = kpis.map(k=>{
    const staleCut=(k.key==='VALUATION'?60:7);
    const badge=daysSince(k.date)<=staleCut?'<span class="badge b-fresh">FRESH</span>':'<span class="badge b-stale">STALE</span>';
    const rag=k.rag==='g'?'g':(k.rag==='a'?'a':'r');
    return `<div class="kpi show" id="pill-${k.key}">
      <h4>${k.label} <span class="dot ${rag}"></span></h4>
      <div class="val">${k.disp}</div>
      <div class="small">Last: ${k.date} &nbsp; ${badge} ${k.weight===0? '&nbsp;‚Ä¢ <em style="color:#8b96b0">not weighted</em>':''}</div>
      <div class="toggle-desc small" title="Tap to expand">About this KPI</div>
      <div class="desc">${k.desc}</div>
    </div>`;
  }).join('');
  kpis.forEach(k=>pill(byId('pill-'+k.key)));
}

let charts={};
function renderHeat(kpis){
  const heat=byId('heat');
  heat.innerHTML = kpis.map(k=>{
    const pct=Math.round(k.scaled), col = pct<30?'var(--green)':(pct<60?'var(--amber)':'var(--red)');
    return `<div class="cell"><div class="small" style="text-transform:uppercase;font-weight:800">${k.short}</div>
      <div style="font-weight:800;font-size:26px;margin:6px 0">${k.disp}</div>
      <div class="bar"><span style="width:${pct}%;background:${col};box-shadow:0 0 8px ${col}"></span></div></div>`;
  }).join('');
}
function renderDecomp(kpis){
  const ctx=byId('decomp').getContext('2d');
  const adj=kpis.filter(k=>k.weight>0).map(k=>{
    let w=k.weight; const staleCut=(k.key==='VALUATION'?60:7); if(daysSince(k.date)>staleCut) w*=0.5;
    return {label:k.short,contrib:+(k.scaled*w).toFixed(2),rag:k.rag,disp:k.disp,scaled:k.scaled,w:k.weight};
  });
  const labels=adj.map(x=>x.label), data=adj.map(x=>x.contrib), colors=adj.map(x=>x.rag==='g'?'#1ec28b':(x.rag==='a'?'#ffc247':'#ff6070'));
  if(charts.decomp) charts.decomp.destroy();
  charts.decomp=new Chart(ctx,{type:'bar',data:{labels,datasets:[{data,backgroundColor:colors}]},
    options:{responsive:true,plugins:{legend:{display:false},tooltip:{callbacks:{label:(c)=>`${kpis[c.dataIndex].label}: ${adj[c.dataIndex].disp} (${Math.round(adj[c.dataIndex].scaled)} stress, w=${kpis[c.dataIndex].weight.toFixed(2)})`}}},
      scales:{x:{ticks:{color:'#8b96b0'}},y:{ticks:{color:'#8b96b0'},grid:{color:'rgba(255,255,255,.06)'}}}});
}
function renderRadar(kpis){
  const ctx=byId('radarChart').getContext('2d');
  const labels=kpis.map(k=>k.short), data=kpis.map(k=>k.scaled), colors=kpis.map(k=>k.rag==='g'?'#1ec28b':(k.rag==='a'?'#ffc247':'#ff6070'));
  if(charts.radar) charts.radar.destroy();
  charts.radar=new Chart(ctx,{type:'radar',data:{labels,datasets:[{data,backgroundColor:'rgba(107,158,255,.2)',borderColor:'#6b9eff',pointBackgroundColor:colors,pointBorderColor:'#fff',pointRadius:4,pointHoverRadius:6}]},
    options:{responsive:true,plugins:{legend:{display:false}},scales:{r:{angleLines:{color:'rgba(255,255,255,0.1)'},grid:{color:'rgba(255,255,255,0.1)'},pointLabels:{color:'#8b96b0',font:{size:11}},ticks:{color:'#8b96b0',backdropColor:'transparent',callback:v=>v+'%'},min:0,max:100}}});
}
function renderCrises(history){
  const cur=history.length?history[history.length-1].composite:50;
  const CRISES=[
    {name:'2022 Inflation',score:65,date:'2022-06-13',phase:'Rate Shock',duration:'9m',drawdown:'-25%'},
    {name:'2000 Dot-com',score:78,date:'2001-03-12',phase:'Tech Bubble',duration:'30m',drawdown:'-49%'},
    {name:'2020 COVID',score:88,date:'2020-03-23',phase:'Pandemic',duration:'2m',drawdown:'-34%'},
    {name:'2008 GFC',score:92,date:'2008-10-15',phase:'Credit',duration:'18m',drawdown:'-57%'}
  ];
  const box=byId('crises');
  box.innerHTML=CRISES.map(c=>{
    const sim=Math.max(50,100-Math.abs(cur-c.score)), col=sim>70?'var(--red)':'var(--amber)';
    return `<div class="cell" style="border-radius:12px"><div style="font-weight:800;margin-bottom:6px">${c.name}</div>
      <div class="badge" style="margin-bottom:6px">${c.phase}</div>
      <div class="small">Peak Stress</div><div style="font-weight:800">${c.score}</div>
      <div class="small" style="margin-top:6px">Similarity</div><div style="font-weight:800;color:${col}">${Math.round(sim)}%</div>
      <div class="small" style="margin-top:6px">Max Drawdown</div><div style="font-weight:800">${c.drawdown}</div>
      <div class="small" style="margin-top:6px">${c.date} ‚Ä¢ ${c.duration}</div></div>`;
  }).join('');
  drawCrisisTimeline(history);
}
function renderScenarios(history){
  const cur=history.length?history[history.length-1].composite:50;
  const base=Math.max(10,Math.min(80,Math.round(60-cur*0.2)));
  const down=Math.max(5,Math.min(80,Math.round(20+cur*0.4)));
  const up=Math.max(5,Math.min(80,100-base-down));
  const box=byId('scenarios');
  box.innerHTML=`<div class="cell"><div style="font-weight:800;margin-bottom:6px">Base Case</div>
      <div style="font-size:28px;font-weight:800;background:linear-gradient(135deg,var(--accent-bright),#4a7fe8);-webkit-background-clip:text;-webkit-text-fill-color:transparent">${base}%</div>
      <div class="small" style="margin-top:6px">Sideways to mild vol; improve in 3‚Äì6m.</div></div>
    <div class="cell"><div style="font-weight:800;margin-bottom:6px">Downside</div>
      <div style="font-size:28px;font-weight:800;color:var(--red)">${down}%</div>
      <div class="small" style="margin-top:6px">Tighter conditions; correction risk.</div></div>
    <div class="cell"><div style="font-weight:800;margin-bottom:6px">Upside</div>
      <div style="font-size:28px;font-weight:800;color:var(--green)">${up}%</div>
      <div class="small" style="margin-top:6px">Soft-landing prints; easing stress.</div></div>`;
  drawTrajectory(cur);
}
function renderNewsFeed(){
  const news=[{title:"Bond spreads widen amid equity selloff",source:"Reuters",time:"Today",impact:"high"},
              {title:"Fed minutes due",source:"FT",time:"Tomorrow",impact:"high"},
              {title:"Housing shows cooling",source:"WSJ",time:"This week",impact:"medium"}];
  const cal=[{event:"FOMC Minutes",date:"Tomorrow",importance:"high"},
             {event:"CPI",date:"Nov 14",importance:"high"},
             {event:"Retail Sales",date:"Nov 15",importance:"medium"}];
  byId('newsFeed').innerHTML = news.map(n=>`<div class="cell" style="display:flex;gap:12px;padding:12px">
    <div style="width:8px;height:8px;border-radius:50%;margin-top:6px;background:${n.impact==='high'?'var(--red)':n.impact==='medium'?'var(--amber)':'var(--green)'}"></div>
    <div><div style="font-weight:700;margin-bottom:4px">${n.title}</div><div class="small">${n.source} ‚Ä¢ ${n.time}</div></div></div>`).join('');
  byId('economicCalendar').innerHTML = cal.map(c=>`<div class="cell" style="display:flex;justify-content:space-between;align-items:center;padding:12px">
    <div><div style="font-weight:700">${c.event}</div><div class="small">${c.date}</div></div>
    <span class="badge ${c.importance==='high'?'b-stale':'b-fresh'}">${c.importance.toUpperCase()}</span></div>`).join('');
}

function drawTrend(history,period='30d'){
  const ctx=byId('mainChart').getContext('2d');
  const sliced=sliceHistory(history,period), labels=sliced.map(x=>fmt(x.date)), data=sliced.map(x=>x.composite);
  if(charts.main) charts.main.destroy();
  charts.main=new Chart(ctx,{type:'line',data:{labels,datasets:[{data,fill:true,tension:.35,borderWidth:2,borderColor:'#6b9eff',backgroundColor:'rgba(107,158,255,.12)',pointRadius:0}]},
    options:{responsive:true,plugins:{legend:{display:false},tooltip:{mode:'index',intersect:false,backgroundColor:'rgba(18,24,43,.95)',titleColor:'#e8eeff',bodyColor:'#8b96b0',callbacks:{label:(c)=>`Stress: ${c.parsed.y}%`}}},
    scales:{y:{min:0,max:100,ticks:{color:'#8b96b0',callback:v=>v+'%'},grid:{color:'rgba(255,255,255,.06)'}},x:{ticks:{color:'#8b96b0'},grid:{color:'rgba(255,255,255,.06)'}}},interaction:{intersect:false,mode:'index'}}); }
function drawCrisisTimeline(history){
  const ctx=byId('crisisTimeline').getContext('2d');
  const sliced=sliceHistory(history,'5y'), labels=sliced.map(x=>{const d=new Date(x.date);return d.getFullYear()+'-'+String(d.getMonth()+1).padStart(2,'0')}); const data=sliced.map(x=>x.composite);
  if(charts.crisisTimeline) charts.crisisTimeline.destroy();
  charts.crisisTimeline=new Chart(ctx,{type:'line',data:{labels,datasets:[{data,fill:true,tension:.4,borderWidth:2,borderColor:'#6b9eff',backgroundColor:'rgba(107,158,255,.12)',pointRadius:0,segment:{borderColor:c=>{const v=c.p0.parsed.y;return v<30?'#1ec28b':(v<60?'#ffc247':'#ff6070')}}}]},
    options:{responsive:true,plugins:{legend:{display:false}},scales:{y:{min:0,max:100,ticks:{color:'#8b96b0',callback:v=>v+'%'},grid:{color:'rgba(255,255,255,.06)'}},x:{ticks:{color:'#8b96b0',autoSkip:true,maxTicksLimit:10},grid:{color:'rgba(255,255,255,.06)'}}}}); }
function drawTrajectory(cur){
  const ctx=byId('traj').getContext('2d'); const weeks=26, path=[],upper=[],lower=[]; let v=cur;
  for(let i=0;i<weeks;i++){ v=0.85*v+0.15*50; const b=6*Math.sqrt((i+1)/weeks); path.push(+v.toFixed(1)); upper.push(Math.min(100,+(v+b).toFixed(1))); lower.push(Math.max(0,+(v-b).toFixed(1))); }
  if(charts.traj) charts.traj.destroy();
  charts.traj=new Chart(ctx,{type:'line',data:{labels:Array.from({length:weeks},(_,i)=>'W+'+(i+1)),datasets:[{label:'Projected',data:path,borderColor:'#ffc247',borderWidth:2,tension:.35,fill:false},{label:'Upper',data:upper,borderColor:'#ff6070',borderDash:[4,4],borderWidth:1,fill:false},{label:'Lower',data:lower,borderColor:'#1ec28b',borderDash:[4,4],borderWidth:1,fill:false}]},
    options:{responsive:true,plugins:{legend:{labels:{color:'#8b96b0'}}},scales:{y:{min:0,max:100,ticks:{color:'#8b96b0',callback:v=>v+'%'},grid:{color:'rgba(255,255,255,.06)'}},x:{ticks:{color:'#8b96b0'},grid:{color:'rgba(255,255,255,.06)'}}}}); }

function sliceHistory(history,period){ if(!history.length) return []; if(period==='all') return history; const end=parseDate(history[history.length-1].date); let start=new Date(end);
  if(period==='30d') start.setDate(start.getDate()-30); else if(period==='90d') start.setDate(start.getDate()-90);
  else if(period==='6m') start.setMonth(start.getMonth()-6); else if(period==='1y') start.setFullYear(start.getFullYear()-1);
  else if(period==='2y') start.setFullYear(start.getFullYear()-2); else if(period==='3y') start.setFullYear(start.getFullYear()-3); else if(period==='5y') start.setFullYear(start.getFullYear()-5);
  return history.filter(x=>parseDate(x.date)>=start); }
function fmt(d){const dt=new Date(d);return dt.toLocaleDateString('en-GB',{month:'short',day:'numeric'});}

function setupPeriodButtons(history){
  if(app.boundPeriods) return; app.boundPeriods=true;
  document.querySelectorAll('.btns button').forEach(b=>{
    b.addEventListener('click',()=>{ document.querySelectorAll('.btns button').forEach(x=>x.classList.remove('active')); b.classList.add('active'); drawTrend(history,b.dataset.p); });
  });
}
function setupTabs(){
  if(app.boundTabs) return; app.boundTabs=true;
  document.querySelectorAll('.tab').forEach(t=>{ t.onclick=()=>{ document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active')); t.classList.add('active');
    document.querySelectorAll('.view').forEach(v=>v.classList.remove('active')); byId('view-'+t.dataset.t).classList.add('active'); }; });
}

/* ===================== EXPORT ===================== */
function exportReport(kpis,history){
  const report={timestamp:new Date().toISOString(),composite:compositeFromKPIs(kpis),quality:byId('qtxt').textContent,
    indicators:kpis.map(k=>({name:k.label,value:k.disp,status:k.rag,crisis:k.crisis,last:k.date,weight:k.weight}))};
  const blob=new Blob([JSON.stringify(report,null,2)],{type:'application/json'});
  const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=`crash-radar-report-${Date.now()}.json`; a.click(); URL.revokeObjectURL(url);
}

/* ===================== CONSOLE DEBUG HELPERS ===================== */
window.CR_DEBUG = async function(){
  const res = await fetch(`${CONFIG.FRED_CACHE_PATH}?nocache=${Date.now()}`).then(r=>r.json());
  console.log('Cache keys:', Object.keys(res));
  const need = ['T10Y3M','BAMLH0A0HYM2','NFCI','VIXCLS','UMCSENT','RSAFS','UNRATE','SP500','DDDM01USA156NWDB','Q13051USQ156NNBR'];
  console.table(need.map(k=>({k, present: !!res[k]})));
  const pick = k => (res[k] && res[k].observations && res[k].observations.slice(-3)) || null;
  console.log('Sample obs:', {CREDIT:pick('BAMLH0A0HYM2'), SP500:pick('SP500'), VALUATION:pick('DDDM01USA156NWDB')||pick('Q13051USQ156NNBR')});
};
</script>
</body>
</html>
