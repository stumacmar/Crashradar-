<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="description" content="CrashRadar — Composite Crash Risk (live FRED cache, freshness, episodes, per-indicator charts)." />
  <title>CrashRadar — Composite Crash Risk</title>

  <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>

  <style>
    :root{
      --bg:#0f1421; --panel:#161c2e; --muted:#9aa6bf; --text:#e8eeff; --accent:#7da6ff;
      --green:#1ec28b; --amber:#ffc247; --red:#ff6070; --radius:16px;
      --ring:180px; --ring-m:140px;
    }
    *{box-sizing:border-box}
    html,body{margin:0;background:var(--bg);color:var(--text);font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Inter,Helvetica,Arial}
    .wrap{max-width:980px;margin:0 auto;padding:20px 16px 64px}
    h1{font-size:clamp(28px,5.5vw,44px);line-height:1.1;margin:0 0 8px}
    .sub{color:var(--muted);margin:6px 0 18px;font-size:14px}

    .card{background:var(--panel);border-radius:var(--radius);padding:20px;margin:16px 0;
      box-shadow:0 0 0 1px rgba(255,255,255,.05) inset}
    .alert{background:#2b1f12;border:1px solid #4d3817;color:#ffdca8;padding:10px;border-radius:10px;margin-top:8px}

    /* Gauge */
    .gauge{display:flex;align-items:center;gap:24px;flex-wrap:wrap}
    .ringwrap{position:relative;width:var(--ring);height:var(--ring)}
    .ring{position:absolute;inset:0;border-radius:50%;
      background:conic-gradient(var(--green) 0deg 120deg, var(--amber) 120deg 216deg, var(--red) 216deg 360deg)}
    .ring::after{content:"";position:absolute;inset:20px;border-radius:50%;background:var(--panel)}
    .needle{position:absolute;inset:0;pointer-events:none}
    .needle::after{content:"";width:8px;height:8px;border-radius:50%;background:var(--accent);
      transform:rotate(var(--angle,0deg)) translateY(calc(-1 * (var(--ring)/2 - 10px)));
      transform-origin:center center;display:block;margin:auto}
    .score{position:absolute;inset:0;display:grid;place-items:center;font-weight:800;font-size:40px}

    /* Pills */
    .pill{display:inline-flex;align-items:center;gap:8px;background:#13192a;border:1px solid #1f2740;
      color:var(--text);padding:8px 12px;border-radius:999px;font-weight:600;margin:6px 8px 0 0}
    .dot{width:8px;height:8px;border-radius:50%}
    .meta{color:var(--muted);font-size:13px}

    /* Charts */
    .chart{position:relative;height:300px}
    canvas{width:100%!important;height:100%!important}

    /* Table */
    table{width:100%;border-collapse:collapse;font-size:13px}
    th,td{padding:8px;border-bottom:1px solid rgba(255,255,255,.06);text-align:left}
    details summary{cursor:pointer;font-weight:600}

    @media (max-width:768px){
      .gauge{justify-content:center;text-align:center}
      .ringwrap{width:var(--ring-m);height:var(--ring-m)}
      .score{font-size:32px}
      .pill{display:block}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>CrashRadar — Composite Crash Risk</h1>
      <div id="status" class="sub" aria-live="polite">Loading market data…</div>
      <div id="labourBanner" class="alert" style="display:none"></div>
    </header>

    <main>
      <!-- Gauge -->
      <section class="card">
        <div class="gauge">
          <div class="ringwrap">
            <div class="ring"></div>
            <div id="needle" class="needle"></div>
            <div id="scoreText" class="score">–</div>
          </div>
          <div>
            <h2 style="margin:0 0 6px;font-size:26px">Composite Score</h2>
            <div class="meta">Lower = safer. Thresholds: <b style="color:var(--green)">≤30 Green</b>, <b style="color:var(--amber)">≤60 Amber</b>, <b style="color:var(--red)">&gt;60 Red</b>.</div>
            <div id="freshness" class="meta" style="margin-top:6px">—</div>
          </div>
        </div>
      </section>

      <!-- Pills -->
      <section class="card">
        <h3 style="margin:0 0 8px">Indicators</h3>
        <div id="pills" role="list"></div>
      </section>

      <!-- Composite -->
      <section class="card">
        <h3 style="margin:0 0 6px">Composite History (7-day MA)</h3>
        <div class="meta">Bands: 0–30 (Green), 30–60 (Amber), 60–100 (Red). Aligned to your cache; gauge = raw latest.</div>
        <div class="chart"><canvas id="compChart" aria-label="Composite risk 7-day moving average"></canvas></div>
      </section>

      <!-- Indicator charts -->
      <div id="charts"></div>

      <!-- Diagnostics -->
      <section class="card">
        <h3 style="margin:0 0 8px">Data & Diagnostics</h3>
        <details>
          <summary>Technical Details</summary>
          <pre id="diag" style="white-space:pre-wrap;word-break:break-word;color:#ffdca8;background:#241d12;border:1px solid #4a3e20;border-radius:10px;padding:12px;max-height:360px;overflow:auto;margin:10px 0;font-size:12px;"></pre>
        </details>

        <div id="episodesWrap" style="margin-top:8px;display:none">
          <h4 style="margin:0 0 6px">Regime Episodes</h4>
          <table id="episodesTable">
            <thead><tr><th>Date</th><th>From</th><th>To</th><th>Composite</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>

        <div class="meta" style="margin-top:8px;">Live data source: <code>data/fred_cache.json</code>.</div>
      </section>
    </main>
  </div>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3.1.1/dist/chartjs-plugin-annotation.min.js"></script>

  <script>
  // ====================== CONFIG (dynamic labour signal) ======================
  // Fixed core signals
  const CORE_KEYS = ['T10Y3M','CREDIT','DD_12M','NFCI']; // always required
  // Labour will be chosen dynamically: SAHMCURRENT preferred, else UN_SLOPE6 (fallback).

  // 0–100 risk mappings (good -> bad)
  const SCALE = {
    T10Y3M:     v => clamp(map01(v,  1.0, -2.0)),   // ↓ worse
    CREDIT:     v => clamp(map01(v,  0.30, 1.00)),  // ↑ worse (BAA–AAA)
    SAHMCURRENT:v => clamp(map01(v,  0.10, 0.50)),  // ↑ worse; ~0.5 => red trigger
    UN_SLOPE6:  v => clamp(map01(v,  0.05, 0.50)),  // ↑ worse (legacy)
    DD_12M:     v => clamp(map01(v,  0.00, -0.20)), // ↓ worse
    NFCI:       v => clamp(map01(v, -0.80, 0.40))   // ↑ worse (>0 tighter)
  };

  // Weights (sum≈1). Labour gets 0.16 either way.
  const W_BASE = { T10Y3M:0.26, CREDIT:0.18, LABOUR:0.16, DD_12M:0.25, NFCI:0.15 };

  // Freshness penalties
  const FRESH = { daily:{ok:7,warn:30}, weekly:{ok:7,warn:30}, monthly:{ok:30,warn:60} };
  const CADENCE_BASE = {T10Y3M:'daily',CREDIT:'monthly',DD_12M:'daily',NFCI:'weekly'};
  const CADENCE_LABOUR = {SAHMCURRENT:'monthly', UN_SLOPE6:'monthly'};
  function freshnessPenalty(days, cadence){
    const lim = FRESH[cadence]||FRESH.daily;
    if (days<=lim.ok) return 1.00;
    if (days<=lim.warn) return 0.85;
    return 0.70;
  }

  // Small delta boosts to catch fast moves (labour excluded)
  const DELTA_RULES = {
    NFCI:  { lookbackDays:28, th:+0.15, add:+4 },   // tightening quickly
    DD_12M:{ lookbackDays:14, th:-0.05, add:+3 },   // quick slide lower
    T10Y3M:{ lookbackDays:14, th:-0.25, add:+3 }    // curve plunges
  };

  // ====================== UTILS ======================
  const GREEN=30, AMBER=60;
  const d = s => new Date(s+"T00:00:00Z");
  function gbDate(D){return D? D.toLocaleDateString('en-GB',{day:'2-digit',month:'short',year:'numeric'}):'—'}
  function clamp(x){ return Math.max(0, Math.min(100,x)); }
  function map01(val, good, bad){ if(val==null) return 50; const denom=bad-good; if(Math.abs(denom)<1e-9) return 50; return ((val-good)/denom)*100; }
  function zoneOf(s){ return s<=GREEN?'green':(s<=AMBER?'amber':'red'); }
  function zoneName(z){ return z==='green'?'Green':z==='amber'?'Amber':'Red'; }
  function movingAvg(a,k){ const out=[]; let sum=0; for(let i=0;i<a.length;i++){ sum+=a[i]; if(i>=k) sum-=a[i-k]; out.push(i>=k-1? +(sum/k).toFixed(1):null);} return out; }
  function latest(series){ const obs=series?.observations||[]; if(!obs.length) return null; const o=obs[obs.length-1]; return {value:+o.value,date:o.date}; }
  function seriesAgeDays(series, fetchedAt){
    const L=latest(series); if(!L) return Infinity;
    return Math.max(0, Math.round((new Date(fetchedAt)-d(L.date))/(1000*60*60*24)));
  }
  function alignedTail(S, keys, tail=240){
    const arrays = keys.map(k => (S[k]?.observations||[]));
    const minLen = Math.min(...arrays.map(a=>a.length||0));
    const n = Math.min(minLen, tail);
    const byKey = {};
    keys.forEach((k,i)=> byKey[k] = arrays[i].slice(-n).map(o=>({date:o.date, value:+o.value})));
    const xs = byKey[keys[0]].map(o=> o.date);
    return {xs,byKey,n};
  }

  // ====================== APP ======================
  const App = {
    raw:null, keys:[], labourKey:null, weights:{}, cadence:{},
    compLatest:null, compMA7:[], compRaw:[], latestVals:{}, ages:{}, charts:new Map(),

    async init(){
      this.setStatus('Loading market data…');
      try{
        const ctl = new AbortController(); const t=setTimeout(()=>ctl.abort(),10000);
        const res = await fetch('data/fred_cache.json',{cache:'no-cache',signal:ctl.signal}); clearTimeout(t);
        if(!res.ok) throw new Error(`HTTP ${res.status}`);
        this.raw = await res.json();
        this.setStatus('Ready');
      }catch(e){
        this.setStatus('Failed to load data');
        console.error(e);
        return;
      }

      // Decide labour signal based on availability
      const S = this.raw?.series || {};
      this.labourKey = S['SAHMCURRENT']?.observations?.length ? 'SAHMCURRENT'
                       : (S['UN_SLOPE6']?.observations?.length ? 'UN_SLOPE6' : null);
      if(!this.labourKey){
        // Neither labour series present — we still render the rest but show a clear banner
        document.getElementById('labourBanner').style.display='block';
        document.getElementById('labourBanner').innerHTML = 'Labour signal missing: expected <code>SAHMCURRENT</code> (preferred) or <code>UN_SLOPE6</code>. Composite shown without labour (slightly less robust).';
        this.keys = [...CORE_KEYS]; // run without labour
      }else{
        this.keys = [...CORE_KEYS, this.labourKey];
        if(this.labourKey==='UN_SLOPE6'){
          const b=document.getElementById('labourBanner');
          b.style.display='block';
          b.innerHTML='Using <b>UN_SLOPE6</b> as a temporary labour fallback. Add <code>SAHMCURRENT</code> to <code>data/fred_cache.json</code> and the dashboard will switch automatically.';
        }
      }

      // Build weights & cadence maps
      this.weights = { T10Y3M:W_BASE.T10Y3M, CREDIT:W_BASE.CREDIT, DD_12M:W_BASE.DD_12M, NFCI:W_BASE.NFCI };
      this.cadence = {...CADENCE_BASE};
      if(this.labourKey){
        this.weights[this.labourKey] = W_BASE.LABOUR;
        this.cadence[this.labourKey] = CADENCE_LABOUR[this.labourKey] || 'monthly';
      }

      this.process();
      this.renderAll();
    },

    setStatus(msg){ const el=document.getElementById('status'); if(el) el.textContent=msg; },
    setNeedle(score){ const n=document.getElementById('needle'); if(n) n.style.setProperty('--angle', ((Math.max(0,Math.min(100,score))/100)*360)+'deg'); },

    process(){
      const S = this.raw?.series||{};
      const fetchedAt = this.raw?.fetched_at_utc ? new Date(this.raw.fetched_at_utc) : new Date();

      // latest values & ages
      for(const k of this.keys){
        const L = latest(S[k]);
        this.latestVals[k] = L? L.value : null;
        this.ages[k] = seriesAgeDays(S[k], fetchedAt);
      }

      // latest composite (with freshness & delta boosts)
      let wsum=0, sum=0;
      for(const k of this.keys){
        const v = this.latestVals[k];
        const risk = (k in SCALE)? SCALE[k](v) : 50;
        const pen = freshnessPenalty(this.ages[k], this.cadence[k]);
        const wk = this.weights[k] ?? 0;
        sum += risk * wk * pen;
        wsum += wk;
      }
      let boosts = this.deltaBoost('NFCI', DELTA_RULES.NFCI)
                 + this.deltaBoost('DD_12M', DELTA_RULES.DD_12M)
                 + this.deltaBoost('T10Y3M', DELTA_RULES.T10Y3M);
      this.compLatest = Math.round(Math.min(100, Math.max(0, wsum>0? (sum/wsum) + boosts : null)));

      // composite history
      const {xs,byKey,n} = alignedTail(S, this.keys, 240);
      const comp=[];
      for(let i=0;i<n;i++){
        let tot=0, w=0;
        for(const k of this.keys){ const v = byKey[k][i]?.value; const r=SCALE[k](v); const wk=this.weights[k]??0; tot += r*wk; w+=wk; }
        comp.push( +(tot/(w||1)).toFixed(1) );
      }
      this.compRaw = comp;
      this.compMA7 = movingAvg(comp, 7);

      this.fetchedAt = fetchedAt;
      this.alignedXs = xs;  // ISO dates
    },

    deltaBoost(key, rule){
      const S=this.raw?.series?.[key]?.observations||[];
      if(!S.length) return 0;
      const last=S[S.length-1]; const lb = new Date(new Date(last.date+"T00:00:00Z").getTime()-rule.lookbackDays*864e5);
      let base=+S[S.length-1].value;
      for(let i=S.length-1;i>=0;i--){
        const di = new Date(S[i].date+"T00:00:00Z");
        if(di<=lb){ base = +S[i].value; break; }
      }
      const chg = (+last.value) - base;
      if(key==='DD_12M'){ return (chg<=rule.th) ? rule.add : 0; }
      return (chg>=rule.th) ? rule.add : 0;
    },

    renderAll(){
      this.renderGauge();
      this.renderPills();
      this.renderCompositeChart();
      this.renderIndicatorCharts();
      this.renderDiagnostics();
      this.renderEpisodes();
    },

    renderGauge(){
      document.getElementById('scoreText').textContent = isFinite(this.compLatest)? this.compLatest : '–';
      this.setNeedle(isFinite(this.compLatest)? this.compLatest : 50);
      const ts = this.raw?.fetched_at_utc? new Date(this.raw.fetched_at_utc) : null;
      const txt = ts ? `${ts.toLocaleDateString('en-GB',{day:'2-digit',month:'short',year:'numeric'})} ${ts.toLocaleTimeString('en-GB',{hour:'2-digit',minute:'2-digit'})}` : '—';
      document.getElementById('freshness').textContent = `AS-OF ${txt}`;
    },

    pillDot(days, cadence){
      const lim = FRESH[cadence]||FRESH.daily;
      if (days<=lim.ok) return 'var(--green)';
      if (days<=lim.warn) return 'var(--amber)';
      return 'var(--red)';
    },

    renderPills(){
      const host=document.getElementById('pills'); host.innerHTML='';
      const labelBase={T10Y3M:'Yield (10y–3m)',CREDIT:'Credit (BAA–AAA)',DD_12M:'Drawdown 12m',NFCI:'NFCI'};
      const labourLabel = this.labourKey==='SAHMCURRENT' ? 'Sahm Rule' : (this.labourKey==='UN_SLOPE6' ? 'Unemp Δ6m (fallback)' : null);
      const label = {...labelBase}; if(this.labourKey) label[this.labourKey]=labourLabel;

      const fmt={T10Y3M:v=>v?.toFixed(2),CREDIT:v=>v?.toFixed(2),
                 SAHMCURRENT:v=>v?.toFixed(2),UN_SLOPE6:v=>v?.toFixed(2),
                 DD_12M:v=>((v??0)*100).toFixed(1)+'%',NFCI:v=>v?.toFixed(3)};

      const tipBase={
        T10Y3M:'More negative = worse (inversions often precede recessions).',
        CREDIT:'Wider = worse (lower-grade vs AAA).',
        DD_12M:'More negative = worse (price stress).',
        NFCI:'Higher = tighter/worse; >0 tighter than average.'
      };
      const tipLabour = this.labourKey==='SAHMCURRENT'
        ? '3-mo avg unemployment minus its 12-mo low; ≥0.5 historically signals recession.'
        : '6-month change in unemployment; rising = worse (temporary fallback).';
      const tip = {...tipBase}; if(this.labourKey) tip[this.labourKey]=tipLabour;

      for(const k of this.keys){
        const pill=document.createElement('span'); pill.className='pill'; pill.title=tip[k]||'';
        const dot=document.createElement('span'); dot.className='dot'; dot.style.background=this.pillDot(this.ages[k], (this.cadence[k]||'daily'));
        const val=this.latestVals[k];
        pill.append(dot, document.create
