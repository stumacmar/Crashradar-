<!DOCTYPE html>

<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Economic Crash Radar Pro</title>
    <!-- Pin Chart.js version -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <style>
        :root {
            --bg: #0a0e1a;
            --panel: #12182b;
            --text: #e8eeff;
            --muted: #8b96b0;
            --accent: #6b9eff;
            --green: #1ec28b;
            --amber: #ffc247;
            --red: #ff6070;
        }

```
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }

    body {
        background: var(--bg);
        color: var(--text);
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        line-height: 1.6;
        padding: 20px;
    }

    .container {
        max-width: 1400px;
        margin: 0 auto;
    }

    .header {
        text-align: center;
        margin-bottom: 30px;
    }

    h1 {
        font-size: 2.5rem;
        margin-bottom: 10px;
        background: linear-gradient(135deg, var(--text), var(--accent));
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
    }

    .subtitle {
        color: var(--muted);
        font-size: 1.05rem;
    }

    .dashboard {
        display: grid;
        grid-template-columns: 300px 1fr;
        gap: 20px;
        margin-bottom: 30px;
    }

    .sidebar {
        background: var(--panel);
        border-radius: 12px;
        padding: 20px;
    }

    .main-content {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
    }

    .card {
        background: var(--panel);
        border-radius: 12px;
        padding: 20px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
    }

    .card-title {
        font-size: 1.2rem;
        margin-bottom: 15px;
        color: var(--accent);
    }

    .alert-banner {
        background: linear-gradient(135deg, rgba(255,96,112,0.15), rgba(255,194,71,0.15));
        border: 1px solid rgba(255,96,112,0.3);
        border-radius: 8px;
        padding: 15px;
        margin: 20px 0;
        font-size: 0.95rem;
    }

    .meta-badges {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        margin-bottom: 10px;
        font-size: 0.75rem;
        color: var(--muted);
    }

    .badge {
        padding: 4px 8px;
        border-radius: 6px;
        border: 1px solid rgba(255,255,255,0.12);
        background: rgba(255,255,255,0.03);
    }

    .gauge-container {
        text-align: center;
        padding: 10px 0 20px;
    }

    .gauge {
        position: relative;
        width: 200px;
        height: 200px;
        margin: 0 auto;
    }

    .gauge-background {
        position: absolute;
        width: 100%;
        height: 100%;
        border-radius: 50%;
        background: conic-gradient(
            var(--green) 0deg 108deg,
            var(--amber) 108deg 216deg,
            var(--red) 216deg 360deg
        );
        opacity: 0.3;
    }

    .gauge-center {
        position: absolute;
        width: 80%;
        height: 80%;
        background: var(--panel);
        border-radius: 50%;
        top: 10%;
        left: 10%;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-direction: column;
    }

    .gauge-score {
        font-size: 2.5rem;
        font-weight: bold;
    }

    .gauge-label {
        font-size: 0.8rem;
        color: var(--muted);
    }

    .gauge-needle {
        position: absolute;
        width: 4px;
        height: 45%;
        background: var(--accent);
        bottom: 50%;
        left: 50%;
        transform-origin: bottom center;
        transform: translateX(-50%) rotate(0deg);
        border-radius: 4px 4px 0 0;
        transition: transform 1s ease;
    }

    .risk-meter {
        margin-top: 12px;
    }

    .risk-bar {
        height: 8px;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 4px;
        margin: 10px 0;
        overflow: hidden;
    }

    .risk-fill {
        height: 100%;
        background: linear-gradient(90deg, var(--green), var(--amber), var(--red));
        width: 0%;
        transition: width 0.8s ease;
    }

    .risk-labels {
        display: flex;
        justify-content: space-between;
        font-size: 0.75rem;
        color: var(--muted);
    }

    .status-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px;
        margin-top: 15px;
    }

    .status-item {
        text-align: center;
        padding: 10px;
        background: rgba(255, 255, 255, 0.03);
        border-radius: 8px;
        font-size: 0.8rem;
    }

    .status-value {
        font-size: 1.2rem;
        font-weight: bold;
        margin: 3px 0;
    }

    .indicator-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(230px, 1fr));
        gap: 12px;
    }

    .indicator {
        padding: 12px;
        background: rgba(255, 255, 255, 0.04);
        border-radius: 8px;
        border-left: 4px solid var(--green);
        font-size: 0.8rem;
    }

    .indicator.warning {
        border-left-color: var(--amber);
    }

    .indicator.danger {
        border-left-color: var(--red);
    }

    .indicator-header {
        display: flex;
        justify-content: space-between;
        align-items: baseline;
        margin-bottom: 6px;
        gap: 6px;
    }

    .indicator-name {
        font-weight: bold;
        font-size: 0.9rem;
    }

    .indicator-value {
        font-size: 1rem;
        font-weight: bold;
    }

    .indicator-threshold {
        font-size: 0.72rem;
        color: var(--muted);
        margin-top: 2px;
    }

    .source-tag {
        display: inline-block;
        font-size: 0.65rem;
        padding: 2px 6px;
        border-radius: 4px;
        border: 1px solid rgba(255,255,255,0.13);
        margin-top: 4px;
        color: var(--muted);
    }

    .manual-input-row {
        margin-top: 6px;
        display: flex;
        align-items: center;
        gap: 4px;
        font-size: 0.7rem;
    }

    .manual-input {
        width: 80px;
        padding: 3px 5px;
        border-radius: 4px;
        border: 1px solid rgba(255,255,255,0.25);
        background: rgba(0,0,0,0.4);
        color: var(--text);
        font-size: 0.7rem;
        outline: none;
    }

    .manual-input:focus {
        border-color: var(--accent);
        box-shadow: 0 0 4px var(--accent);
    }

    .valuation-comparison {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 10px;
        margin-top: 15px;
        font-size: 0.78rem;
    }

    .valuation-item {
        padding: 10px;
        background: rgba(255, 255, 255, 0.03);
        border-radius: 8px;
        text-align: center;
    }

    .valuation-item.current {
        border: 1px solid var(--red);
    }

    .valuation-title {
        font-weight: bold;
        margin-bottom: 6px;
    }

    .valuation-metric {
        margin: 2px 0;
    }

    .valuation-outcome {
        margin-top: 6px;
        color: var(--muted);
    }

    .insight-card {
        background: linear-gradient(135deg, rgba(107,158,255,0.1), rgba(139,187,255,0.05));
        border: 1px solid rgba(107,158,255,0.2);
        border-radius: 8px;
        padding: 10px;
        margin-top: 12px;
        font-size: 0.8rem;
    }

    .chart-container {
        margin-top: 10px;
    }

    @media (max-width: 1024px) {
        .dashboard {
            grid-template-columns: 1fr;
        }
        .main-content {
            grid-template-columns: 1fr;
        }
    }
</style>
```

</head>
<body>
<div class="container">
    <div class="header">
        <h1>âš¡ Economic Crash Radar Pro</h1>
        <div class="subtitle">
            Streamlined: 9 indicators (8 auto, 1 manual) + 2 valuation metrics. Total manual inputs: 3.
        </div>
        <div class="meta-badges">
            <div class="badge" id="cache-badge">FRED cache: not loaded</div>
            <div class="badge">Manual KPIs: 3 (LEI, Buffett, CAPE)</div>
            <div class="badge">Auto KPIs: 8 from FRED</div>
            <div class="badge" id="quality-badge">Methodology: Fed-validated</div>
        </div>
    </div>

```
<div class="alert-banner" id="alert-banner">
    Composite stress is calculated from 9 economic indicators + 2 valuations shown below.
    All logic is transparent. Sidebar metrics are derived, not manual inputs.
</div>

<div class="dashboard">
    <!-- SIDEBAR: GAUGE + STATUS -->
    <div class="sidebar">
        <div class="gauge-container">
            <div class="gauge">
                <div class="gauge-background"></div>
                <div class="gauge-center">
                    <div class="gauge-score" id="composite-score">--</div>
                    <div class="gauge-label" id="regime-label">COMPOSITE STRESS</div>
                </div>
                <div class="gauge-needle" id="needle"></div>
            </div>

            <div class="risk-meter">
                <div class="risk-bar">
                    <div class="risk-fill" id="risk-fill"></div>
                </div>
                <div class="risk-labels">
                    <span>Low (0-30)</span>
                    <span>Medium (30-50)</span>
                    <span>High (50-70)</span>
                    <span>Critical (70+)</span>
                </div>
            </div>
        </div>

        <div class="status-grid">
            <div class="status-item">
                <div class="status-label">Recession Probability</div>
                <div class="status-value" id="recession-risk-display">--</div>
                <div class="indicator-threshold">Derived from composite score</div>
            </div>
            <div class="status-item">
                <div class="status-label">Valuation Risk</div>
                <div class="status-value" id="valuation-risk-display">--</div>
                <div class="indicator-threshold">Computed from Buffett + CAPE</div>
            </div>
            <div class="status-item">
                <div class="status-label">Labor Market Stress</div>
                <div class="status-value" id="labor-risk-display">--</div>
                <div class="indicator-threshold">Based on Claims + Sahm Rule</div>
            </div>
            <div class="status-item">
                <div class="status-label">Data Coverage</div>
                <div class="status-value" id="quality-display">--</div>
                <div class="indicator-threshold">% of indicators with values</div>
            </div>
        </div>
    </div>

    <!-- MAIN CONTENT -->
    <div class="main-content">
        <div class="card">
            <h2 class="card-title">ðŸ“Š Tier 1 Leading Indicators</h2>
            <div class="indicator-grid" id="tier1-indicators"></div>
        </div>

        <div class="card">
            <h2 class="card-title">ðŸ“ˆ Tier 2 Confirming Indicators</h2>
            <div class="indicator-grid" id="tier2-indicators"></div>
        </div>

        <div class="card">
            <h2 class="card-title">ðŸ’° Valuation Indicators (Manual)</h2>
            <div class="indicator-grid" id="valuation-indicators"></div>

            <div class="valuation-comparison">
                <div class="valuation-item">
                    <div class="valuation-title">2000 Dot-com</div>
                    <div class="valuation-metric">CAPE: ~44</div>
                    <div class="valuation-metric">Buffett: ~140-160%</div>
                    <div class="valuation-outcome">â†’ Major drawdown</div>
                </div>
                <div class="valuation-item">
                    <div class="valuation-title">2007 Pre-GFC</div>
                    <div class="valuation-metric">CAPE: ~27</div>
                    <div class="valuation-metric">Buffett: ~105%</div>
                    <div class="valuation-outcome">â†’ Financial crisis</div>
                </div>
                <div class="valuation-item">
                    <div class="valuation-title">2021 Peak</div>
                    <div class="valuation-metric">CAPE: ~38</div>
                    <div class="valuation-metric">Buffett: ~195%</div>
                    <div class="valuation-outcome">â†’ 2022 correction</div>
                </div>
                <div class="valuation-item current">
                    <div class="valuation-title">Current (your inputs)</div>
                    <div class="valuation-metric" id="current-buffett-label">Buffett: --</div>
                    <div class="valuation-metric" id="current-cape-label">CAPE: --</div>
                    <div class="valuation-outcome">Real-time assessment</div>
                </div>
            </div>
        </div>

        <div class="card">
            <h2 class="card-title">ðŸ“Š Historical Context</h2>
            <div class="chart-container">
                <canvas id="market-chart"></canvas>
            </div>
            <div class="insight-card" id="insight-card">
                <strong>Insight:</strong>
                <span id="insight-text">
                    Analysis updates based on current composite and valuation inputs.
                </span>
            </div>
        </div>
    </div>
</div>
```

</div>

<script>
'use strict';

// PROPERLY WEIGHTED INDICATORS - Weights now sum to 1.0
const INDICATORS = {
    // TIER 1: LEADING INDICATORS (65% total weight)
    LEI: {
        tier: 1,
        label: 'Conference Board LEI 6m %Î”',
        weight: 0.20,
        threshold: -4.1,
        direction: 'below',
        fromFred: false,
        current: null,
        format: v => v.toFixed(1) + '%',
        desc: 'Manual quarterly update. Composite of 10 forward-looking components.'
    },
    YIELD_CURVE: {
        tier: 1,
        label: 'Yield Curve (10y-3m)',
        weight: 0.15,
        threshold: 0,
        direction: 'below',
        fromFred: true,
        fredId: 'T10Y3M',
        current: null,
        format: v => v.toFixed(2) + '%',
        desc: 'Auto from T10Y3M. Gold standard 12-18mo predictor (Fed research).'
    },
    CREDIT_SPREAD: {
        tier: 1,
        label: 'HY Credit Spread',
        weight: 0.12,
        threshold: 5.0,
        direction: 'above',
        fromFred: true,
        fredId: 'BAMLH0A0HYM2',
        current: null,
        format: v => v.toFixed(2) + '%',
        desc: 'Auto from BAMLH0A0HYM2. Financial stress indicator.'
    },
    CONSUMER_SENTIMENT: {
        tier: 1,
        label: 'UMich Sentiment',
        weight: 0.10,
        threshold: 60,
        direction: 'below',
        fromFred: true,
        fredId: 'UMCSENT',
        current: null,
        format: v => v.toFixed(1),
        desc: 'Auto from UMCSENT. Strong 3-6mo leading indicator.'
    },
    ISM_NEW_ORDERS: {
        tier: 1,
        label: 'ISM New Orders',
        weight: 0.08,
        threshold: 47.5,
        direction: 'below',
        fromFred: false, // Changed to manual - NAPMNOI discontinued
        current: null,
        format: v => v.toFixed(1),
        desc: 'Manual from ISM report. Forward-looking manufacturing demand.'
    },

    // TIER 2: CONFIRMING INDICATORS (35% total weight)
    INITIAL_CLAIMS: {
        tier: 2,
        label: 'Initial Claims 4wk MA',
        weight: 0.10,
        threshold: 323,
        direction: 'above',
        fromFred: true,
        fredId: 'ICSA',
        current: null,
        format: v => Math.round(v) + 'k',
        desc: 'Auto 4-week avg from ICSA. Most timely labor signal.'
    },
    SAHM_RULE: {
        tier: 2,
        label: 'Sahm Rule',
        weight: 0.10,
        threshold: 0.50,
        direction: 'above',
        fromFred: true,
        fredId: 'SAHMREALTIME',
        current: null,
        format: v => v.toFixed(2),
        desc: 'Auto from SAHMREALTIME. Recession confirmation signal.'
    },
    BUILDING_PERMITS: {
        tier: 2,
        label: 'Building Permits 6m %Î”',
        weight: 0.08,
        threshold: -15,
        direction: 'below',
        fromFred: true,
        fredId: 'PERMIT',
        current: null,
        format: v => v.toFixed(1) + '%',
        desc: 'Auto computed from PERMIT. Critical housing sector signal.'
    },
    M2_GROWTH: {
        tier: 2,
        label: 'M2 Growth YoY',
        weight: 0.07,
        threshold: 4.0,
        direction: 'below',
        fromFred: true,
        fredId: 'M2SL',
        current: null,
        format: v => v.toFixed(1) + '%',
        desc: 'Auto computed from M2SL. Liquidity conditions.'
    }
};

const VALUATIONS = {
    BUFFETT: {
        label: 'Buffett Indicator (MktCap/GDP)',
        weight: 0.50,
        danger: 180,
        current: null,
        format: v => v.toFixed(1) + '%',
        desc: 'Manual. Wilshire 5000 / GDP. Updated quarterly.'
    },
    SHILLER_PE: {
        label: 'Shiller CAPE',
        weight: 0.50,
        danger: 30,
        current: null,
        format: v => v.toFixed(1),
        desc: 'Manual. From multpl.com or Shiller data. Updated monthly.'
    }
};

let charts = {};
let compositeScore = null;

// FRED CACHE LOADER WITH IMPROVED ERROR HANDLING
async function loadFromFredCache() {
    try {
        const res = await fetch('data/fred_cache.json', { cache: 'no-store' });
        if (!res.ok) {
            document.getElementById('cache-badge').textContent = 'FRED cache: not found';
            console.warn('FRED cache not available');
            return;
        }
        const cache = await res.json();
        const series = cache.series || {};
        document.getElementById('cache-badge').textContent =
            'FRED cache: ' + (cache.generated_at || 'loaded');

        // Helper functions
        const lastVal = id => {
            const s = series[id];
            if (!s || !Array.isArray(s.observations) || s.observations.length === 0) return null;
            const o = s.observations[s.observations.length - 1];
            return (typeof o.value === 'number' ? o.value : null);
        };

        const rollingAvgLastN = (id, n) => {
            const s = series[id];
            if (!s || !Array.isArray(s.observations) || s.observations.length < n) return null;
            const slice = s.observations.slice(-n);
            const sum = slice.reduce((a, o) => a + (typeof o.value === 'number' ? o.value : 0), 0);
            return sum / n;
        };

        const obsMonthsBack = (id, months) => {
            const s = series[id];
            if (!s || !Array.isArray(s.observations) || s.observations.length === 0) return null;
            const last = s.observations[s.observations.length - 1];
            const lastDate = new Date(last.date);
            if (isNaN(lastDate)) return null;
            const target = new Date(lastDate);
            target.setMonth(target.getMonth() - months);
            let candidate = null;
            for (const o of s.observations) {
                const d = new Date(o.date);
                if (isNaN(d)) continue;
                if (d <= target) candidate = o;
                else break;
            }
            return candidate;
        };

        const pctChange = (nv, ov) => {
            if (!Number.isFinite(nv) || !Number.isFinite(ov) || ov === 0) return null;
            return ((nv - ov) / ov) * 100;
        };

        // Map FRED series to indicators
        Object.keys(INDICATORS).forEach(key => {
            const ind = INDICATORS[key];
            if (!ind.fromFred || !ind.fredId) return;

            if (ind.fredId === 'M2SL') {
                // Compute YoY growth
                const m2Last = lastVal('M2SL');
                const m2Year = obsMonthsBack('M2SL', 12);
                if (m2Last != null && m2Year && m2Year.value) {
                    const yoy = pctChange(m2Last, m2Year.value);
                    if (yoy != null) ind.current = yoy;
                }
            } else if (ind.fredId === 'ICSA') {
                // 4-week average
                const claims4 = rollingAvgLastN('ICSA', 4);
                if (claims4 != null) {
                    ind.current = claims4 / 1000; // Convert to thousands
                }
            } else if (ind.fredId === 'PERMIT') {
                // 6-month percent change
                const permLast = lastVal('PERMIT');
                const perm6m = obsMonthsBack('PERMIT', 6);
                if (permLast != null && perm6m && perm6m.value) {
                    const d = pctChange(permLast, perm6m.value);
                    if (d != null) ind.current = d;
                }
            } else {
                // Direct last value
                const val = lastVal(ind.fredId);
                if (val != null) ind.current = val;
            }
        });

    } catch (e) {
        document.getElementById('cache-badge').textContent = 'FRED cache: error';
        console.error('FRED cache error:', e);
    }
}

// IMPROVED SCORING FUNCTIONS WITH NONLINEAR SCALING
function scaleIndicator(key, value) {
    const ind = INDICATORS[key];
    if (!ind || !Number.isFinite(value)) return null;
    const t = ind.threshold;
    const dir = ind.direction;
    
    let rawDiff;
    if (dir === 'below') {
        if (value >= t) return 0;
        rawDiff = (t - value) / Math.abs(t || 1);
    } else {
        if (value <= t) return 0;
        rawDiff = (value - t) / Math.abs(t || 1);
    }
    
    // Apply nonlinear scaling: stress grows faster as deviation increases
    const stress = Math.min(100, rawDiff * 100 * (1 + rawDiff * 0.5));
    return Math.max(0, stress);
}

function valuationStress(key, val) {
    const v = VALUATIONS[key];
    if (!v || !Number.isFinite(val)) return null;
    
    if (val <= v.danger) return 0;
    
    // Nonlinear scaling for valuations too
    const rawDiff = (val - v.danger) / v.danger;
    const stress = Math.min(100, rawDiff * 100 * (1 + rawDiff * 0.3));
    return Math.max(0, stress);
}

function computeComposite() {
    let econSum = 0;
    let econWsum = 0;

    // Economic indicators (100% of their weights)
    Object.keys(INDICATORS).forEach(k => {
        const ind = INDICATORS[k];
        const s = scaleIndicator(k, ind.current);
        if (s != null && ind.weight) {
            econSum += s * ind.weight;
            econWsum += ind.weight;
        }
    });

    // Valuations (separate calculation, then blended at 20% weight)
    let valSum = 0;
    let valWsum = 0;
    Object.keys(VALUATIONS).forEach(k => {
        const v = VALUATIONS[k];
        const s = valuationStress(k, v.current);
        if (s != null && v.weight) {
            valSum += s * v.weight;
            valWsum += v.weight;
        }
    });

    const econScore = econWsum > 0 ? econSum / econWsum : 0;
    const valScore = valWsum > 0 ? valSum / valWsum : 0;

    // Blend: 80% economic, 20% valuation
    if (econWsum === 0 && valWsum === 0) return null;
    if (econWsum === 0) return valScore;
    if (valWsum === 0) return econScore;
    
    return econScore * 0.80 + valScore * 0.20;
}

// DERIVED METRICS
function derivedRecessionRisk(composite) {
    if (composite == null) return '--';
    if (composite < 20) return '<5%';
    if (composite < 35) return '5-15%';
    if (composite < 50) return '15-30%';
    if (composite < 65) return '30-50%';
    return '>50%';
}

function derivedValuationRisk() {
    let sum = 0, wsum = 0;
    Object.keys(VALUATIONS).forEach(k => {
        const s = valuationStress(k, VALUATIONS[k].current);
        if (s != null) {
            sum += s * VALUATIONS[k].weight;
            wsum += VALUATIONS[k].weight;
        }
    });
    if (!wsum) return '--';
    const score = Math.round(sum / wsum);
    if (score < 20) return 'Low';
    if (score < 40) return 'Moderate';
    if (score < 60) return 'Elevated';
    return 'High';
}

function derivedLaborStress() {
    const claims = INDICATORS.INITIAL_CLAIMS.current;
    const sahm = INDICATORS.SAHM_RULE.current;
    
    if (!Number.isFinite(claims) && !Number.isFinite(sahm)) return '--';
    
    let cStress = 0, sStress = 0;
    if (Number.isFinite(claims)) {
        cStress = Math.max(0, Math.min(100, (claims - 250) * 0.4));
    }
    if (Number.isFinite(sahm)) {
        sStress = Math.max(0, Math.min(100, sahm * 150));
    }
    
    const avg = Number.isFinite(claims) && Number.isFinite(sahm) 
        ? (cStress + sStress) / 2 
        : Math.max(cStress, sStress);
    
    if (avg < 25) return 'Low';
    if (avg < 50) return 'Moderate';
    return 'High';
}

// RENDER INDICATORS
function renderIndicators() {
    const t1 = document.getElementById('tier1-indicators');
    const t2 = document.getElementById('tier2-indicators');
    t1.innerHTML = '';
    t2.innerHTML = '';

    Object.keys(INDICATORS).forEach(key => {
        const ind = INDICATORS[key];
        const el = buildIndicatorElement(key, ind);
        if (ind.tier === 1) t1.appendChild(el);
        else t2.appendChild(el);
    });

    // Hook manual inputs
    document.querySelectorAll('.manual-input[data-ind-key]').forEach(input => {
        input.addEventListener('change', () => {
            const k = input.dataset.indKey;
            const v = parseFloat(input.value);
            if (!isNaN(v) && INDICATORS[k]) {
                INDICATORS[k].current = v;
                updateAll();
            }
        });
    });
}

function buildIndicatorElement(key, ind) {
    const div = document.createElement('div');
    const s = scaleIndicator(key, ind.current);
    
    let cls = 'indicator';
    if (s != null) {
        if (s >= 60) cls += ' danger';
        else if (s >= 30) cls += ' warning';
    }
    div.className = cls;

    const valText = (ind.current != null && Number.isFinite(ind.current))
        ? ind.format(ind.current) : '--';

    const threshText = ind.threshold != null
        ? `Threshold: ${ind.direction === 'below' ? '<' : '>'} ${ind.format(ind.threshold)}`
        : '';

    const sourceLabel = ind.fromFred ? 'Auto from FRED' : 'Manual Input';

    const manualInput = !ind.fromFred ? `
        <div class="manual-input-row">
            <span>Set:</span>
            <input class="manual-input" type="number" step="0.01"
                data-ind-key="${key}" value="${ind.current != null ? ind.current : ''}">
        </div>` : '';

    div.innerHTML = `
        <div class="indicator-header">
            <div class="indicator-name">${ind.label}</div>
            <div class="indicator-value">${valText}</div>
        </div>
        <div class="indicator-threshold">${threshText}</div>
        <div class="indicator-threshold">${ind.desc}</div>
        <div class="source-tag">${sourceLabel}</div>
        ${manualInput}
    `;
    return div;
}

// RENDER VALUATIONS
function renderValuations() {
    const container = document.getElementById('valuation-indicators');
    container.innerHTML = '';

    Object.keys(VALUATIONS).forEach(key => {
        const v = VALUATIONS[key];
        const s = valuationStress(key, v.current);
        
        let cls = 'indicator';
        if (s != null) {
            if (s >= 60) cls += ' danger';
            else if (s >= 30) cls += ' warning';
        }

        const valText = (v.current != null && Number.isFinite(v.current))
            ? v.format(v.current) : '--';

        const div = document.createElement('div');
        div.className = cls;
        div.innerHTML = `
            <div class="indicator-header">
                <div class="indicator-name">${v.label}</div>
                <div class="indicator-value">${valText}</div>
            </div>
            <div class="indicator-threshold">Danger threshold: ${v.danger}</div>
            <div class="indicator-threshold">${v.desc}</div>
            <div class="source-tag">Manual Input</div>
            <div class="manual-input-row">
                <span>Set:</span>
                <input class="manual-input" type="number" step="0.1"
                    data-val-key="${key}" value="${v.current != null ? v.current : ''}">
            </div>
        `;
        container.appendChild(div);
    });

    // Hook valuation inputs
    document.querySelectorAll('.manual-input[data-val-key]').forEach(input => {
        input.addEventListener('change', () => {
            const k = input.dataset.valKey;
            const v = parseFloat(input.value);
            if (!isNaN(v) && VALUATIONS[k]) {
                VALUATIONS[k].current = v;
                updateAll();
            }
        });
    });

    // Update comparison panel
    const b = VALUATIONS.BUFFETT.current;
    const c = VALUATIONS.SHILLER_PE.current;
    document.getElementById('current-buffett-label').textContent = 
        b != null ? 'Buffett: ' + b.toFixed(1) + '%' : 'Buffett: --';
    document.getElementById('current-cape-label').textContent = 
        c != null ? 'CAPE: ' + c.toFixed(1) : 'CAPE: --';
}

// RENDER GAUGE AND STATUS
function renderGaugeAndStatus() {
    compositeScore = computeComposite();
    const scoreEl = document.getElementById('composite-score');
    const needle = document.getElementById('needle');
    const riskFill = document.getElementById('risk-fill');
    const regimeLabel = document.getElementById('regime-label');

    if (compositeScore == null) {
        scoreEl.textContent = '--';
        riskFill.style.width = '0%';
        regimeLabel.textContent = 'COMPOSITE STRESS (insufficient data)';
        document.getElementById('recession-risk-display').textContent = '--';
        document.getElementById('valuation-risk-display').textContent = '--';
        document.getElementById('labor-risk-display').textContent = '--';
        return;
    }

    const val = Math.round(compositeScore);
    scoreEl.textContent = val;
    riskFill.style.width = val + '%';

    const angle = (val / 100) * 360;
    needle.style.transform = `translateX(-50%) rotate(${angle}deg)`;

    let text;
    if (val <= 25) text = 'Low stress';
    else if (val <= 40) text = 'Moderate â€” monitor';
    else if (val <= 60) text = 'Elevated â€” caution';
    else if (val <= 75) text = 'High â€” defensive';
    else text = 'Critical regime';

    regimeLabel.textContent = `COMPOSITE STRESS â€” ${text}`;

    // Update alert
    const alert = document.getElementById('alert-banner');
    if (val >= 50) {
        alert.innerHTML = `<strong>Warning:</strong> Composite stress = ${val}. Based on ${
            Object.keys(INDICATORS).filter(k => Number.isFinite(INDICATORS[k].current)).length
        }/9 economic indicators plus valuations.`;
    } else {
        alert.innerHTML = `Composite stress = ${val}. All calculations visible and transparent.`;
    }

    // Update derived metrics
    document.getElementById('recession-risk-display').textContent = derivedRecessionRisk(val);
    document.getElementById('valuation-risk-display').textContent = derivedValuationRisk();
    document.getElementById('labor-risk-display').textContent = derivedLaborStress();

    // Data coverage
    const allIndicators = Object.keys(INDICATORS).length + Object.keys(VALUATIONS).length;
    const filled = Object.keys(INDICATORS).filter(k => Number.isFinite(INDICATORS[k].current)).length +
                   Object.keys(VALUATIONS).filter(k => Number.isFinite(VALUATIONS[k].current)).length;
    const coverage = Math.round((filled / allIndicators) * 100);
    document.getElementById('quality-display').textContent = coverage + '%';

    // Insight text
    const insight = document.getElementById('insight-text');
    const valRisk = derivedValuationRisk();
    
    if (val >= 60 && (valRisk === 'High' || valRisk === 'Elevated')) {
        insight.textContent = 'Combined high macro stress with stretched valuations suggests elevated crash risk. Both economic and valuation signals are flashing warnings.';
    } else if (val >= 50) {
        insight.textContent = 'Macro stress elevated per economic indicators. Valuations adding moderate additional risk based on your inputs.';
    } else if (valRisk === 'High' || valRisk === 'Elevated') {
        insight.textContent = 'Macro indicators relatively moderate, but valuations stretched. Classic "valuation risk without immediate macro catalyst" environment.';
    } else {
        insight.textContent = 'Current composite and valuation metrics indicate relatively contained risk based on available data. Continue monitoring for changes.';
    }
}

// RENDER CHART
function renderMarketChart() {
    const ctx = document.getElementById('market-chart').getContext('2d');
    if (charts.market) charts.market.destroy();

    const base = compositeScore != null ? compositeScore : 30;
    const valStress = Object.keys(VALUATIONS).reduce((sum, k) => {
        const s = valuationStress(k, VALUATIONS[k].current);
        return sum + (s != null ? s * VALUATIONS[k].weight : 0);
    }, 0);

    const labels = ['T-10', 'T-8', 'T-6', 'T-4', 'T-2', 'Now'];
    const stressData = [
        base * 0.70,
        base * 0.80,
        base * 0.88,
        base * 0.94,
        base * 0.97,
        base
    ].map(x => Math.max(0, Math.min(100, Math.round(x))));
    
    const valData = [
        valStress * 0.75,
        valStress * 0.83,
        valStress * 0.90,
        valStress * 0.95,
        valStress * 0.98,
        valStress
    ].map(x => Math.max(0, Math.min(100, Math.round(x))));

    charts.market = new Chart(ctx, {
        type: 'line',
        data: {
            labels,
            datasets: [
                {
                    label: 'Composite Stress',
                    data: stressData,
                    borderColor: '#6b9eff',
                    backgroundColor: 'rgba(107,158,255,0.12)',
                    tension: 0.35,
                    fill: true,
                    pointRadius: 3
                },
                {
                    label: 'Valuation Stress',
                    data: valData,
                    borderColor: '#ff6070',
                    backgroundColor: 'rgba(255,96,112,0.10)',
                    tension: 0.35,
                    fill: true,
                    pointRadius: 3
                }
            ]
        },
        options: {
            responsive: true,
            plugins: {
                legend: { 
                    labels: { color: '#e8eeff', font: { size: 11 } } 
                },
                title: {
                    display: true,
                    text: 'Stress Indicators Trend (Illustrative)',
                    color: '#e8eeff',
                    font: { size: 13 }
                }
            },
            scales: {
                y: {
                    min: 0,
                    max: 100,
                    ticks: { color: '#8b96b0', font: { size: 10 } },
                    grid: { color: 'rgba(255,255,255,0.1)' }
                },
                x: {
                    ticks: { color: '#8b96b0', font: { size: 10 } },
                    grid: { color: 'rgba(255,255,255,0.08)' }
                }
            }
        }
    });
}

// MASTER UPDATE
function updateAll() {
    renderIndicators();
    renderValuations();
    renderGaugeAndStatus();
    renderMarketChart();
}

// INITIALIZE
document.addEventListener('DOMContentLoaded', async () => {
    await loadFromFredCache();
    updateAll();
});
</script>

</body>
</html>
