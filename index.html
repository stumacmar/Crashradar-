<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>CrashRadar — Composite Crash Risk</title>
  <meta name="description" content="CrashRadar monitors financial crash risk using yield curve, credit spreads, unemployment, drawdown and financial conditions."/>
  <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
  <link rel="dns-prefetch" href="https://cdn.jsdelivr.net">
  <style>
    :root{
      --bg:#0f1421; --panel:#161c2e; --muted:#9aa6bf; --text:#e8eeff; --accent:#7da6ff;
      --green:#1ec28b; --amber:#ffc247; --red:#ff6070; --radius:16px; --t:all .2s ease;
      --chip:#13192a; --chip-b:#1f2740;
    }
    *{box-sizing:border-box}
    html,body{margin:0;background:var(--bg);color:var(--text);font:16px/1.55 system-ui,-apple-system,Segoe UI,Roboto,Inter,Helvetica,Arial}
    .wrap{max-width:980px;margin:0 auto;padding:20px 16px 64px}
    h1{font-size:clamp(28px,5.5vw,44px);line-height:1.1;margin:0 0 8px}
    h2{margin:0 0 8px}
    .sub{color:var(--muted);margin:6px 0 18px;font-size:14px}
    .ok{color:var(--green)} .warn{color:var(--amber)} .bad{color:var(--red)}
    .card{background:var(--panel);border-radius:16px;padding:20px;margin:16px 0;box-shadow:0 0 0 1px rgba(255,255,255,.03) inset}
    .pill{display:inline-flex;align-items:center;background:var(--chip);border:1px solid var(--chip-b);color:var(--text);padding:8px 12px;border-radius:999px;font-weight:600;margin:6px 8px 0 0}
    .meta{color:var(--muted);font-size:13px}
    .grid{display:grid;gap:14px}
    .gauge{display:flex;align-items:center;gap:24px;flex-wrap:wrap}
    .ringwrap{position:relative;width:180px;height:180px;flex-shrink:0}
    .ring{position:absolute;inset:0;border-radius:50%;background:
      conic-gradient(var(--green) 0 120deg,var(--amber) 120deg 216deg,var(--red) 216deg 360deg)}
    .ring::after{content:"";position:absolute;inset:20px;border-radius:50%;background:var(--panel)}
    .score{position:absolute;inset:0;display:grid;place-items:center;font-weight:800;font-size:36px}
    .badge{display:inline-flex;align-items:center;padding:6px 12px;border-radius:10px;font-weight:800;margin-left:12px}
    .badge.green{background:rgba(30,194,139,.15);color:var(--green);border:1px solid rgba(30,194,139,.35)}
    .badge.amber{background:rgba(255,194,71,.15);color:var(--amber);border:1px solid rgba(255,194,71,.35)}
    .badge.red{background:rgba(255,96,112,.17);color:var(--red);border:1px solid rgba(255,96,112,.35)}
    .callout{font-size:14px;color:var(--muted);line-height:1.4}
    .chart{position:relative;height:300px}
    canvas{width:100%!important;height:100%!important}
    .err{background:#2b1620;color:#ffdbe0;border:1px solid #57313f;padding:12px;border-radius:10px}
    .risk-expl{margin-top:12px;padding:12px;background:rgba(255,255,255,.03);border-left:3px solid var(--amber);border-radius:8px}
    .risk-expl.green{border-left-color:var(--green)} .risk-expl.amber{border-left-color:var(--amber)} .risk-expl.red{border-left-color:var(--red)}
    @media (max-width:768px){.gauge{justify-content:center;text-align:center}.ringwrap{width:140px;height:140px}.score{font-size:28px}}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>CrashRadar — Composite Crash Risk</h1>
      <div id="status" class="sub">Loading market data…</div>
    </header>

    <main>
      <!-- Top: Composite block -->
      <section class="card">
        <div class="gauge">
          <div class="ringwrap" aria-hidden="true">
            <div class="ring"></div>
            <div id="scoreText" class="score">–</div>
          </div>
          <div>
            <h2 style="font-size:26px">Composite Score
              <span id="garBadge" class="badge">—</span>
            </h2>
            <div class="callout">
              Lower = safer. Thresholds:
              <b class="ok">Green ≤ 30</b>,
              <b class="warn">Amber ≤ 60</b>,
              <b class="bad">Red &gt; 60</b>.
            </div>
            <div class="meta" id="freshness" style="margin-top:6px">—</div>
            <div id="riskBox" class="risk-expl" style="display:none">
              <b id="riskTitle">—</b>
              <div id="riskDesc" class="meta" style="margin-top:4px"></div>
            </div>
            <div style="margin-top:14px">
              <span class="pill" id="pill_t10y3m">Yield (10y–3m): —</span>
              <span class="pill" id="pill_credit">Credit (BAA–AAA): —</span>
              <span class="pill" id="pill_un">Unemp Δ6m: —</span>
              <span class="pill" id="pill_dd">Drawdown 12m: —</span>
              <span class="pill" id="pill_nfci">NFCI: —</span>
            </div>
          </div>
        </div>
      </section>

      <!-- Composite history with RAG bands and optional SPX overlay -->
      <section class="card">
        <h2 style="margin:0 0 6px">Composite Risk History (0–100)</h2>
        <div class="meta" style="margin-bottom:8px">Shaded bands show Green/Amber/Red thresholds. S&P overlay is shown if present in cache.</div>
        <div class="chart"><canvas id="compChart"></canvas></div>
        <div class="callout">Composite is a weighted blend of yield curve, credit spreads, unemployment slope, 12-month drawdown and NFCI, scaled to a comparable 0–100 risk score.</div>
      </section>

      <!-- Indicators -->
      <div id="indicators"></div>

      <!-- Diagnostics -->
      <section class="card">
        <h2 style="margin:0 0 8px">Data & Diagnostics</h2>
        <details>
          <summary style="cursor:pointer;margin-bottom:8px;font-weight:600">Technical details</summary>
          <pre id="diag" style="white-space:pre-wrap;word-break:break-word;color:#ffdca8;background:#241d12;border:1px solid #4a3e20;border-radius:10px;padding:12px;max-height:420px;overflow:auto;margin:0;font-size:12px"></pre>
        </details>
        <div class="meta">Data source: FRED. Last updated: <span id="updated">—</span></div>
      </section>
    </main>
  </div>

  <!-- libs -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3.1.1/dist/chartjs-plugin-annotation.min.js"></script>

  <script>
    // ----- core model (same as before, but robust + no repo assumptions) -----
    const KEYS   = ['T10Y3M','CREDIT','UN_SLOPE6','DD_12M','NFCI'];
    const LABELS = {
      T10Y3M:'Yield Curve (10y–3m)',
      CREDIT:'Credit Spread (BAA–AAA)',
      UN_SLOPE6:'Unemployment 6-month slope',
      DD_12M:'12-month Drawdown (S&P vs 1-yr peak)',
      NFCI:'Chicago Fed NFCI'
    };
    const FMT = {
      T10Y3M:v=>v.toFixed(2),
      CREDIT:v=>v.toFixed(2),
      UN_SLOPE6:v=>v.toFixed(2),
      DD_12M:v=>(v*100).toFixed(1)+'%',
      NFCI:v=>v.toFixed(3)
    };
    const WEIGHTS = { T10Y3M:0.25, CREDIT:0.25, UN_SLOPE6:0.20, DD_12M:0.20, NFCI:0.10 };
    const SCALE = {
      T10Y3M:v=>clamp(map(v, 1.0, -2.0)),
      CREDIT:v=>clamp(map(v, 0.3, 1.0)),
      UN_SLOPE6:v=>clamp(map(v, 0.0, 0.6)),
      DD_12M:v=>clamp(map(v, 0.0,-0.30)),
      NFCI:v=>clamp(map(v,-0.8, 1.0))
    };

    function clamp(x){ return Math.max(0, Math.min(100, x)); }
    function map(val, good, bad){ if(val==null) return 50; const d=bad-good; if(Math.abs(d)<1e-9) return 50; return ((val-good)/d)*100; }
    function gbDate(d){ return new Date(d).toLocaleDateString('en-GB',{day:'2-digit',month:'short',year:'numeric'}); }
    const zone = s => s<=30?'green':(s<=60?'amber':'red');

    const state = { raw:null, series:{}, latest:{}, composite:NaN, charts:[] };

    start();
    async function start(){
      setStatus('Loading market data…');
      try{
        const res = await fetch('data/fred_cache.json', { cache:'no-cache' });
        if(!res.ok) throw new Error(`HTTP ${res.status}`);
        state.raw = await res.json();
        setStatus('Market data loaded successfully','ok');
        process();
        renderTop();
        renderCompositeHistory();
        renderIndicators();
        renderDiag();
      }catch(e){
        setStatus('No cache yet — run the workflow','bad');
        document.getElementById('diag').textContent = 'Load error: ' + e.message;
      }
    }

    function process(){
      const S = state.raw?.series || {};
      KEYS.forEach(k=>{
        const obs = (S[k]?.observations||[]).filter(o => o && o.date!=null && o.value!=null);
        const xs = obs.map(o=>gbDate(o.date));
        const ys = obs.map(o=>+o.value);
        state.series[k] = { xs, ys };
        state.latest[k] = ys.length ? ys[ys.length-1] : null;
      });

      // composite now
      let wsum=0, comp=0;
      KEYS.forEach(k=>{
        const scaled = SCALE[k](state.latest[k]);
        if(isFinite(scaled)){ comp += scaled * (WEIGHTS[k]||0); wsum += (WEIGHTS[k]||0); }
      });
      state.composite = Math.round((wsum?comp/wsum:NaN) * 10)/10;
    }

    function setStatus(msg, cls=''){ const el=document.getElementById('status'); el.textContent=msg; el.className='sub '+cls; }

    // ----- UI: top block -----
    function renderTop(){
      // ring + badge + freshness
      const c = state.composite, z = zone(c);
      document.getElementById('scoreText').textContent = isFinite(c)?Math.round(c):'–';
      const badge = document.getElementById('garBadge'); badge.className = 'badge '+z; badge.textContent = z.toUpperCase();

      const ts = state.raw?.fetched_at_utc ? new Date(state.raw.fetched_at_utc) : null;
      document.getElementById('freshness').textContent = ts ?
        `${gbDate(ts)} ${ts.toLocaleTimeString('en-GB',{hour:'2-digit',minute:'2-digit'})}` : '—';
      document.getElementById('updated').textContent =
        new Date().toLocaleTimeString('en-GB',{hour:'2-digit',minute:'2-digit'});

      // short explainer
      const expl = {
        green:{t:'Low Risk Environment', d:'Conditions look favourable. Macro and market stress signals are muted.'},
        amber:{t:'Moderate Risk Environment', d:'Some stress signals are active. Monitor for further deterioration.'},
        red:{t:'High Risk Environment', d:'Multiple stress signals are elevated. Turbulence risk is high.'}
      }[z];
      const box = document.getElementById('riskBox');
      box.className = 'risk-expl '+z;
      document.getElementById('riskTitle').textContent = expl.t;
      document.getElementById('riskDesc').textContent  = expl
