<script>
/* ---------- helpers ---------- */
const $=s=>document.querySelector(s);
const fmt=(x,d=2)=>Number.isFinite(x)?(+x).toFixed(d):'—';
const gbDate = (iso)=> new Date(iso).toLocaleDateString('en-GB',{day:'2-digit',month:'short',year:'numeric'});
function setBadge(score){
  const b=$('#badge'); b.className='badge';
  if(!Number.isFinite(score)){b.textContent='—';return;}
  if(score<=30){b.textContent='GREEN';b.classList.add('g');}
  else if(score<=60){b.textContent='AMBER';b.classList.add('y');}
  else{b.textContent='RED';b.classList.add('r');}
}
function renderGauge(score){
  const g=$('#gauge'),v=$('#gval');
  const s=Number.isFinite(score)?Math.max(0,Math.min(score,100)):NaN;
  v.textContent=Number.isFinite(s)?s.toFixed(1):'—';
  const deg=Number.isFinite(s)?(s/100)*360:0;
  const col=!Number.isFinite(s)?'var(--ok)':(s<=30?'var(--ok)':s<=60?'var(--warn)':'var(--risk)');
  g.style.background=`conic-gradient(${col} ${deg}deg, #2a2f55 ${deg}deg)`;
  setBadge(s);
}
function seriesToPoints(s){
  return (s?.observations||[]).map(o=>({d:o.date,v:Number(o.value)})).filter(p=>Number.isFinite(p.v));
}
/* SAFE latest value: prefer .last if finite, else last observation */
function getLastVal(seriesObj, points){
  const raw = seriesObj?.last;
  const n = Number(raw);
  if (Number.isFinite(n)) return n;
  return points?.length ? points[points.length-1].v : NaN;
}

/* ---------- risk normalisation (0–100) ---------- */
function normYield(v){return (!Number.isFinite(v))?NaN:v>=2?0:v<=-1?100:((2-v)/3)*100;}
function normCredit(v){return (!Number.isFinite(v))?NaN:Math.min(100,Math.max(0,(v-1)*50));}
function normUn(v){return (!Number.isFinite(v))?NaN:v<=0?0:v>=0.6?100:(v/0.6)*100;}
function normDD(v){return (!Number.isFinite(v))?NaN:Math.min(100,Math.max(0,(-v)*500));}
function normNFCI(v){return (!Number.isFinite(v))?NaN:v<=-0.5?0:v>=1?100:(v+0.5)*66;}

/* ---------- Chart.js plugin: shaded GAR bands + latest marker ---------- */
const yBandsPlugin = {
  id:'yBands',
  beforeDraw(chart, args, opts){
    const {ctx, chartArea:{top,bottom,left,right}, scales:{y}} = chart;
    if(!y) return;
    (opts?.zones||[]).forEach(z=>{
      const y1 = y.getPixelForValue(z.to);
      const y2 = y.getPixelForValue(z.from);
      ctx.save();
      ctx.fillStyle=z.color; ctx.globalAlpha=z.alpha??0.12;
      ctx.fillRect(left, Math.min(y1,y2), right-left, Math.abs(y2-y1));
      ctx.restore();
    });
  },
  afterDatasetsDraw(chart, args, opts){
    const {ctx, chartArea:{left,right}, scales:{y}} = chart;
    const lv = opts?.latest;
    if(!Number.isFinite(lv) || !y) return;
    const py = y.getPixelForValue(lv);
    ctx.save();
    ctx.strokeStyle = '#ffffff55'; ctx.setLineDash([6,4]);
    ctx.beginPath(); ctx.moveTo(left,py); ctx.lineTo(right,py); ctx.stroke();
    ctx.restore();
  }
};
Chart.register(yBandsPlugin);

/* ---------- draw a chart (line or bar) with UK dates + bands ---------- */
function drawChart(cfg){
  const {canvasId, title, type='line', points=[], zones=[], latest} = cfg;
  if(!points.length) return;
  const labels = points.map(p=>gbDate(p.d));
  const data = points.map(p=>p.v);
  const ctx = document.getElementById(canvasId).getContext('2d');
  new Chart(ctx,{
    type,
    data:{labels,datasets:[{
      label:title,data,
      borderColor:'#9dbaff',backgroundColor:type==='bar'?'#9dbaff77':'#9dbaff33',
      tension:.25,pointRadius:0
    }]},
    options:{
      responsive:true,maintainAspectRatio:false,
      plugins:{
        legend:{display:false},
        title:{display:true,text:title,color:'#cfe3ff'},
        yBands:{zones, latest}
      },
      scales:{
        x:{ticks:{color:'#a7b0d9',maxRotation:0,autoSkip:true,maxTicksLimit:6},
           grid:{color:'rgba(255,255,255,.06)'}},
        y:{ticks:{color:'#a7b0d9'},grid:{color:'rgba(255,255,255,.06)'}}
      }
    }
  });
}

/* ---------- main ---------- */
(async()=>{
  try{
    const res = await fetch('data/fred_cache.json',{cache:'no-store'});
    const txt = await res.text();
    $('#diag')?.textContent !== undefined && ($('#diag').textContent = txt);
    const j = JSON.parse(txt), S = j.series||{};
    $('#status').textContent = '✅ Cache loaded';
    $('#fresh').textContent = j.fetched_at_utc? new Date(j.fetched_at_utc).toLocaleString('en-GB'): '—';

    // series -> points
    const sY = seriesToPoints(S.T10Y3M || S.T10Y3m || S.TERM);
    const sC = seriesToPoints(S.CREDIT);
    const sU = seriesToPoints(S.UN_SLOPE6 || S.UNEMP_SLOPE6);
    const sD = seriesToPoints(S.DD_12M || S.DD12M);
    const sN = seriesToPoints(S.NFCI);

    // SAFE latest values (use .last if finite, else last observation)
    const y = getLastVal(S.T10Y3M || S.T10Y3m || S.TERM, sY);
    const c = getLastVal(S.CREDIT, sC);
    const u = getLastVal(S.UN_SLOPE6 || S.UNEMP_SLOPE6, sU);
    const d = getLastVal(S.DD_12M || S.DD12M, sD);
    const n = getLastVal(S.NFCI, sN);

    // header KPIs
    $('#k_term').textContent = fmt(y);
    $('#k_credit').textContent = fmt(c);
    $('#k_un').textContent = fmt(u);
    $('#k_dd').textContent = Number.isFinite(d)? (d*100).toFixed(1)+'%':'—';
    $('#k_nfci').textContent = fmt(n);

    // composite (0–100)
    const comp = (normYield(y)*0.25)+(normCredit(c)*0.25)+(normUn(u)*0.20)+(normDD(d)*0.15)+(normNFCI(n)*0.15);
    renderGauge(comp);

    // composite mini-series (last ~24 aligned points, where available)
    const len = Math.min(sY.length, sC.length, sU.length, sD.length, sN.length);
    const compSeries = [];
    for(let i=Math.max(0,len-24); i<len; i++){
      const vy=sY[i]?.v, vc=sC[i]?.v, vu=sU[i]?.v, vd=sD[i]?.v, vn=sN[i]?.v;
      if([vy,vc,vu,vd,vn].every(Number.isFinite)){
        const val=(normYield(vy)*0.25)+(normCredit(vc)*0.25)+(normUn(vu)*0.20)+(normDD(vd)*0.15)+(normNFCI(vn)*0.15);
        compSeries.push({d:sY[i].d, v:val});
      }
    }
    if(!compSeries.length && Number.isFinite(comp)){
      compSeries.push({d: j.fetched_at_utc || new Date().toISOString(), v: comp});
    }

    // === charts ===
    drawChart({
      canvasId:'cComp',
      title:'Composite (0–100 risk)',
      type:'line',
      points:compSeries,
      zones:[
        {from:0, to:30, color:'var(--ok)'},
        {from:30, to:60, color:'var(--warn)'},
        {from:60, to:100, color:'var(--risk)'}
      ],
      latest: comp
    });
    drawChart({
      canvasId:'cTerm',
      title:'Yield Curve (10y–3m)',
      type:'line',
      points:sY,
      zones:[
        {from:0.5, to:10, color:'var(--ok)'},
        {from:0, to:0.5, color:'var(--warn)'},
        {from:-5, to:0, color:'var(--risk)'}
      ],
      latest:y
    });
    drawChart({
      canvasId:'cCredit',
      title:'Credit Spread (BAA–AAA)',
      type:'bar',
      points:sC,
      zones:[
        {from:-10, to:0.60, color:'var(--ok)'},
        {from:0.60, to:0.80, color:'var(--warn)'},
        {from:0.80, to:5, color:'var(--risk)'}
      ],
      latest:c
    });
    drawChart({
      canvasId:'cUn',
      title:'Unemployment Δ6m',
      type:'bar',
      points:sU,
      zones:[
        {from:-5, to:0, color:'var(--ok)'},
        {from:0, to:0.20, color:'var(--warn)'},
        {from:0.20, to:5, color:'var(--risk)'}
      ],
      latest:u
    });
    drawChart({
      canvasId:'cDD',
      title:'12-month Drawdown',
      type:'line',
      points:sD,
      zones:[
        {from:-0.02, to:1, color:'var(--ok)'},
        {from:-0.08, to:-0.02, color:'var(--warn)'},
        {from:-5, to:-0.08, color:'var(--risk)'}
      ],
      latest:d
    });
    drawChart({
      canvasId:'cNFCI',
      title:'NFCI',
      type:'line',
      points:sN,
      zones:[
        {from:-5, to:0, color:'var(--ok)'},
        {from:0, to:0.5, color:'var(--warn)'},
        {from:0.5, to:5, color:'var(--risk)'}
      ],
      latest:n
    });

  }catch(e){
    $('#status').textContent = '❌ ' + e.message;
    const d=$('#diag'); if(d) d.textContent = e.stack || String(e);
    renderGauge(NaN);
  }
})();
</script>
