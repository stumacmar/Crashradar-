<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="description" content="CrashRadar monitors market crash risk via yield curve, credit spreads, unemployment slope, drawdowns, and financial conditions." />
  <title>CrashRadar — Composite Crash Risk</title>

  <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
  <link rel="dns-prefetch" href="https://cdn.jsdelivr.net">

  <style>
    :root{
      --bg:#0f1421; --panel:#161c2e; --muted:#9aa6bf; --text:#e8eeff; --accent:#7da6ff;
      --green:#1ec28b; --amber:#ffc247; --red:#ff6070; --radius:16px; --t:all .2s ease;
      --ring:180px; --ring-sm:140px;
    }
    *{box-sizing:border-box}
    html,body{margin:0;background:var(--bg);color:var(--text);font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Inter,Helvetica,Arial}
    :focus{outline:2px solid var(--accent);outline-offset:2px}
    :focus:not(:focus-visible){outline:none}
    .wrap{max-width:980px;margin:0 auto;padding:20px 16px 64px}
    h1{font-size:clamp(28px,5.5vw,44px);line-height:1.1;margin:0 0 8px}
    .sub{color:var(--muted);margin:6px 0 18px;font-size:14px}
    .ok{color:var(--green)} .warn{color:var(--amber)} .bad{color:var(--red)}

    .card{background:var(--panel);border-radius:var(--radius);padding:20px;margin:16px 0;
      box-shadow:0 0 0 1px rgba(255,255,255,.03) inset;transition:var(--t)}
    .card:hover{box-shadow:0 0 0 1px rgba(125,166,255,.1) inset}

    .pill{display:inline-flex;align-items:center;background:#13192a;border:1px solid #1f2740;
      color:var(--text);padding:8px 12px;border-radius:999px;font-weight:600;margin:6px 8px 0 0;transition:var(--t)}
    .pill small{color:var(--muted);margin-left:8px}
    .pill:hover{border-color:var(--accent);transform:translateY(-1px)}
    .meta{color:var(--muted);font-size:13px}

    .gauge{display:flex;align-items:center;gap:24px;flex-wrap:wrap}
    .ringwrap{position:relative;width:var(--ring);height:var(--ring);flex-shrink:0}
    .ring{position:absolute;inset:0;border-radius:50%;
      background:conic-gradient(var(--green) 0deg 120deg, var(--amber) 120deg 216deg, var(--red) 216deg 360deg)}
    .ring::after{content:"";position:absolute;inset:20px;border-radius:50%;background:var(--panel)}
    .score{position:absolute;inset:0;display:grid;place-items:center;font-weight:800;font-size:36px}
    .badge{display:inline-flex;align-items:center;padding:6px 12px;border-radius:10px;font-weight:800;letter-spacing:.4px;margin-left:10px}
    .badge.green{background:rgba(30,194,139,.15);color:var(--green);border:1px solid rgba(30,194,139,.35)}
    .badge.amber{background:rgba(255,194,71,.15);color:var(--amber);border:1px solid rgba(255,194,71,.35)}
    .badge.red{background:rgba(255,96,112,.17);color:var(--red);border:1px solid rgba(255,96,112,.35)}

    .mode{display:flex;gap:8px;margin:10px 0 4px;flex-wrap:wrap}
    .btn{padding:6px 10px;border-radius:8px;border:1px solid #27304e;background:#1a2141;color:#cfe3ff;cursor:pointer;font-weight:600}
    .btn.active{background:var(--accent);color:#0b1026;border-color:var(--accent)}

    .chart{position:relative;height:300px}
    canvas{width:100%!important;height:100%!important}
    .err{background:#2b1620;color:#ffdbe0;border:1px solid #57313f;padding:10px;border-radius:10px}

    .risk-note{margin-top:12px;padding:12px;background:rgba(255,255,255,.03);border-radius:8px;border-left:3px solid var(--accent);font-size:14px;color:var(--muted)}
    .fresh{display:inline-flex;align-items:center;margin-left:8px;font-size:11px}
    .dot{width:7px;height:7px;border-radius:50%;margin-right:5px}
    .d-fresh{background:var(--green)} .d-stale{background:var(--amber)} .d-old{background:var(--red)}

    @media (max-width:768px){
      .gauge{justify-content:center;text-align:center}
      .ringwrap{width:var(--ring-sm);height:var(--ring-sm)}
      .score{font-size:28px}
    }
    @media (max-width:480px){
      .card{padding:16px}
      .pill{display:block;width:100%}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>CrashRadar — Composite Crash Risk</h1>
      <div id="status" class="sub" aria-live="polite">Loading market data…</div>
    </header>

    <main>
      <!-- Top: Gauge + mode + pills -->
      <section class="card">
        <div class="gauge">
          <div class="ringwrap" aria-hidden="true">
            <div class="ring"></div>
            <div id="scoreText" class="score">–</div>
          </div>
          <div>
            <div class="mode" role="group" aria-label="Composite mode">
              <button class="btn active" data-mode="asof" aria-pressed="true">AS-OF TODAY</button>
              <button class="btn" data-mode="strict" aria-pressed="false">STRICT (ALIGNED)</button>
            </div>
            <h2 style="margin:0 0 6px;font-size:26px">
              Composite Score <span id="garBadge" class="badge">—</span>
            </h2>
            <div class="meta" id="freshness">—</div>
            <div class="risk-note" id="riskNote" style="display:none"></div>

            <div style="margin-top:12px">
              <span class="pill" id="pill_t10y3m">Yield (10y–3m): —</span>
              <span class="pill" id="pill_credit">Credit (BAA–AAA): —</span>
              <span class="pill" id="pill_un">Unemp Δ6m: —</span>
              <span class="pill" id="pill_dd">Drawdown 12m: —</span>
              <span class="pill" id="pill_nfci">NFCI: —</span>
            </div>
          </div>
        </div>
      </section>

      <!-- Composite history -->
      <section class="card">
        <h3 style="margin:0 0 8px">Composite Risk History (normalised 0–100)</h3>
        <div class="meta">RAG bands: <span class="ok">≤30</span> • <span class="warn">≤60</span> • <span class="bad">&gt;60</span></div>
        <div class="chart"><canvas id="compChart" aria-label="Composite risk score over time"></canvas></div>
        <div class="sub" style="margin-top:8px">
          History is computed on the latest overlapping date across all indicators (“STRICT”); the gauge can show “AS-OF TODAY” with staleness weighting for more actionable reads.
        </div>
      </section>

      <!-- Indicator charts -->
      <section class="card">
        <h3 style="margin:0 0 8px">Key Indicators</h3>
        <div id="charts"></div>
      </section>
    </main>

    <footer class="card" style="margin-top:20px">
      <h3 style="margin:0 0 10px">Diagnostics</h3>
      <details>
        <summary style="cursor:pointer;font-weight:600">Open</summary>
        <pre id="diag" style="white-space:pre-wrap;word-break:break-word;color:#ffdca8;background:#241d12;border:1px solid #4a3e20;border-radius:10px;padding:12px;max-height:420px;overflow:auto;margin:8px 0 0;font-size:12px"></pre>
      </details>
      <div class="meta" style="margin-top:10px">
        Data from FRED cache • Last build: <span id="built">—</span>
      </div>
    </footer>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3.1.1/dist/chartjs-plugin-annotation.min.js"></script>

  <script>
  // ---------- Utilities ----------
  const gb = d => new Date(d).toLocaleDateString('en-GB',{year:'numeric',month:'short',day:'2-digit'});
  const toISO = d => new Date(d).toISOString().slice(0,10);
  const clamp01 = (x,min=0,max=100)=>Math.max(min,Math.min(max,x));
  const zone = s => s<=30?'green':(s<=60?'amber':'red');
  const dotClass = days => (days==null)?'d-old':(days<=1?'d-fresh':(days<=7?'d-stale':'d-old'));

  function setStatus(msg, cls=''){ const el=document.getElementById('status'); el.textContent=msg; el.className='sub '+cls; }

  // Pull observations as {xs,ys,iso}
  function parseSeries(node){
    // Accepts either {observations:[{date,value}...]} or legacy {last: number}
    const obs = Array.isArray(node?.observations) ? node.observations : [];
    if (obs.length){
      const iso = [], xs=[], ys=[];
      for(const o of obs){
        const v = (o?.value==null || isNaN(+o.value)) ? null : +o.value;
        if(v==null || !o?.date) continue;
        const dISO = toISO(o.date);
        iso.push(dISO); xs.push(gb(dISO)); ys.push(v);
      }
      return {xs,ys,iso};
    }
    // Legacy: fabricate a single-point series for display safety
    const last = (node?.last==null || isNaN(+node.last)) ? null : +node.last;
    if (last!=null) {
      const today = toISO(new Date());
      return { xs:[gb(today)], ys:[last], iso:[today] };
    }
    return { xs:[], ys:[], iso:[] };
  }

  // ---------- App ----------
  class CrashRadar {
    constructor(){
      this.keys = ['T10Y3M','CREDIT','UN_SLOPE6','DD_12M','NFCI'];
      // Same intent as your current front end (keep user familiarity)
      this.weights = { T10Y3M:0.30, CREDIT:0.25, UN_SLOPE6:0.20, DD_12M:0.15, NFCI:0.10 };

      // Risk mapping (0=good, 100=bad). Keep simple & robust.
      this.scales = {
        // For spreads: good→bad anchors are pragmatic notches (keep consistent with current site feel)
        T10Y3M: v => clamp01(((1.0 - v)/(1.0 - (-2.0)))*100),   // more negative = worse
        CREDIT: v => clamp01(((v - 0.3)/(1.0 - 0.3))*100),      // wider = worse
        UN_SLOPE6: v => clamp01(((v - 0.0)/(0.6 - 0.0))*100),   // rising = worse
        DD_12M: v => clamp01(((-v - 0.0)/(0.30 - 0.0))*100),    // more negative drawdown = worse
        NFCI: v => clamp01(((v - (-0.8))/(1.0 - (-0.8)))*100)   // higher = tighter/worse
      };

      this.mode = 'asof'; // 'asof' or 'strict'
      this.data = { raw:null, S:{}, last:{}, lastISO:{}, freshDays:{}, commonISO:null };
      this.charts = new Map();
      this.init();
    }

    async init(){
      setStatus('Loading market data…');
      // mode buttons
      document.querySelectorAll('.btn').forEach(btn=>{
        btn.addEventListener('click', (e)=>{
          document.querySelectorAll('.btn').forEach(b=>{b.classList.remove('active'); b.setAttribute('aria-pressed','false');});
          e.currentTarget.classList.add('active'); e.currentTarget.setAttribute('aria-pressed','true');
          this.mode = e.currentTarget.dataset.mode;
          this.renderGauge(); // refresh label + value
        });
      });

      try{
        const r = await fetch('data/fred_cache.json',{cache:'no-cache'});
        if(!r.ok) throw new Error(`HTTP ${r.status}`);
        this.data.raw = await r.json();
        this.ingest();
        this.renderAll();
        setStatus('Market data loaded', 'ok');
      }catch(err){
        setStatus('Failed to load cache — run your workflow to build data/fred_cache.json', 'bad');
        document.getElementById('diag').textContent = String(err);
      }
    }

    ingest(){
      const Snode = this.data.raw?.series || {};
      // Build parsed series
      for(const k of this.keys){
        this.data.S[k] = parseSeries(Snode[k]);
        const iso = this.data.S[k].iso;
        const ys  = this.data.S[k].ys;
        this.data.last[k]    = ys.length ? ys[ys.length-1] : null;
        this.data.lastISO[k] = iso.length ? iso[iso.length-1] : null;
      }

      // Find strict latest common ISO across all series
      const sets = this.keys.map(k => new Set(this.data.S[k].iso));
      const shortest = this.keys.slice().sort((a,b)=>this.data.S[a].iso.length - this.data.S[b].iso.length)[0];
      let common = null;
      for(let i=this.data.S[shortest].iso.length-1; i>=0; i--){
        const d = this.data.S[shortest].iso[i];
        if(this.keys.every((_, idx)=>sets[idx].has(d))){ common=d; break; }
      }
      this.data.commonISO = common;

      // Freshness days relative to today
      const today = toISO(new Date());
      for(const k of this.keys){
        const d = this.data.lastISO[k];
        this.data.freshDays[k] = (d? Math.round((new Date(today)-new Date(d))/86400000) : null);
      }
    }

    // Composite calculators
    compStrict(){
      const d = this.data.commonISO;
      if(!d) return null;
      let num=0, den=0;
      for(const k of this.keys){
        const idx = this.data.S[k].iso.lastIndexOf(d);
        if(idx<0) return null;
        const v = this.data.S[k].ys[idx];
        const s = this.scales[k](v);
        if(isFinite(s)){ num += s*(this.weights[k]||0); den += (this.weights[k]||0); }
      }
      return den ? Math.round((num/den)*10)/10 : null;
    }

    compAsOf(){
      let num=0, den=0;
      for(const k of this.keys){
        const v = this.data.last[k];
        if(v==null) continue;
        const s = this.scales[k](v);
        const age = this.data.freshDays[k] ?? 99;
        // freshness weight: ≤1d=1.0 → ≥7d=0.4
        const f = Math.max(0.4, Math.min(1, 1 - (age/7)));
        const w = (this.weights[k]||0) * f;
        num += s*w; den += w;
      }
      return den ? Math.round((num/den)*10)/10 : null;
    }

    renderAll(){
      this.renderGauge();
      this.renderPills();
      this.renderCompositeHistory();
      this.renderIndicators();
      this.renderDiag();
    }

    renderGauge(){
      const composite = (this.mode==='strict') ? this.compStrict() : this.compAsOf();
      const z = zone(composite ?? 50);
      const badge = document.getElementById('garBadge');
      badge.className = 'badge '+z;
      badge.textContent = (this.mode==='strict'?'STRICT':'AS-OF TODAY') + ' · ' + z.toUpperCase();

      const scoreEl = document.getElementById('scoreText');
      scoreEl.textContent = isFinite(composite) ? Math.round(composite) : '–';

      // freshness / build text
      const built = this.data.raw?.fetched_at_utc ? new Date(this.data.raw.fetched_at_utc) : null;
      const strictTxt = this.data.commonISO ? `STRICT to ${gb(this.data.commonISO)}` : 'STRICT: —';
      const builtTxt = built ? `${gb(toISO(built))} ${built.toLocaleTimeString('en-GB',{hour:'2-digit',minute:'2-digit'})}` : '—';
      document.getElementById('freshness').textContent =
        `${strictTxt} • cache built ${builtTxt}`;

      // contextual note
      const note = {
        green: 'Low risk backdrop. Historically, these readings align with benign conditions. Stay close to strategic allocation.',
        amber: 'Mixed conditions. Risk is building but not extreme. Reduce leverage, consider partial hedges, review stops.',
        red: 'Elevated stress across indicators. Historically associated with higher drawdown odds. Defensive stance/hedges prudent.'
      }[z];
      const rn = document.getElementById('riskNote');
      rn.textContent = note; rn.style.display = 'block';
    }

    renderPills(){
      const id = { T10Y3M:'pill_t10y3m', CREDIT:'pill_credit', UN_SLOPE6:'pill_un', DD_12M:'pill_dd', NFCI:'pill_nfci' };
      const fmt = {
        T10Y3M:v=>v?.toFixed(2),
        CREDIT:v=>v?.toFixed(2),
        UN_SLOPE6:v=>v?.toFixed(2),
        DD_12M:v=> (v!=null ? (v*100).toFixed(1)+'%' : '—'),
        NFCI:v=>v?.toFixed(3)
      };
      for(const k of this.keys){
        const el = document.getElementById(id[k]); if(!el) continue;
        const val = this.data.last[k];
        const d   = this.data.lastISO[k];
        const age = this.data.freshDays[k];
        el.textContent = `${el.textContent.split(':')[0]}: ${val==null?'—':fmt[k](val)}`;
        const dot = document.createElement('small');
        dot.className='fresh';
        dot.innerHTML = `<span class="dot ${dotClass(age)}"></span>${d?gb(d):'—'}${age!=null?` · ${age}d`:''}`;
        // wipe any previous small
        el.querySelectorAll('small').forEach(n=>n.remove());
        el.appendChild(dot);
      }
    }

    renderCompositeHistory(){
      const ctx = document.getElementById('compChart');
      // Need overlapping history: compute composite per common index across tail
      const minLen = Math.min(...this.keys.map(k=>this.data.S[k].ys.length||Infinity));
      if(!isFinite(minLen) || minLen<3){
        ctx.closest('.chart').innerHTML = '<div class="err">Not enough overlapping history to draw composite.</div>';
        return;
      }
      const tail = Math.min(minLen, 180);
      const xs = this.data.S[this.keys[0]].xs.slice(-tail); // any aligned xs works
      const ys = [];
      for(let i=-tail;i<0;i++){
        let num=0, den=0;
        for(const k of this.keys){
          const v = this.data.S[k].ys.at(i);
          if(v==null) continue;
          const s = this.scales[k](v);
          num += s*(this.weights[k]||0); den += (this.weights[k]||0);
        }
        ys.push(den? Math.round((num/den)*10)/10 : null);
      }

      this.makeChart(ctx,{
        type:'line',
        data:{labels:xs, datasets:[{data:ys,borderColor:'#7da6ff',backgroundColor:'transparent',fill:false,tension:.35}]},
        options:this.baseOpts({
          scales:{ y:{min:0,max:100} },
          plugins:{
            annotation:{
              annotations:{
                g:{type:'line',yMin:30,yMax:30,borderColor:'rgba(30,194,139,.6)',borderDash:[6,4],borderWidth:1},
                a:{type:'line',yMin:60,yMax:60,borderColor:'rgba(255,194,71,.7)',borderDash:[6,4],borderWidth:1}
              }
            }
          }
        })
      });
    }

    renderIndicators(){
      const host = document.getElementById('charts'); host.innerHTML='';
      const configs = [
        {k:'T10Y3M', title:'Yield Curve (10y–3m)', color:'#6bb9ff', zero:true,
         expl:'More negative = worse. Deep/persistent inversion has preceded past recessions.'},
        {k:'CREDIT', title:'Credit Spread (BAA–AAA)', color:'#ffb36b', zero:false,
         expl:'Wider = worse. Rising lower-grade vs top-tier borrowing costs signal credit stress.'},
        {k:'UN_SLOPE6', title:'Unemployment 6-month Slope', color:'#ffa0b5', zero:true,
         expl:'Rising = worse. Early labour-market deterioration is a classic late-cycle sign.'},
        {k:'DD_12M', title:'S&P 12-month Drawdown vs Peak', color:'#a6c7ff', zero:true,
         expl:'More negative = worse. Captures price stress complementing the macro signals.'},
        {k:'NFCI', title:'Chicago Fed NFCI', color:'#9bd3c1', zero:true,
         expl:'Higher = tighter/worse. Summary of rates, credit, funding and volatility.'}
      ];

      for(const c of configs){
        const sec = document.createElement('div'); sec.style.marginBottom='14px';
        sec.innerHTML = `
          <div class="sub" style="font-weight:700;margin-bottom:6px">${c.title}</div>
          <div class="chart"><canvas id="c_${c.k}" aria-label="${c.title}"></canvas></div>
          <div class="sub" style="margin-top:6px">${c.expl}</div>
        `;
        host.appendChild(sec);

        const s = this.data.S[c.k];
        if(!s.ys.length){ sec.querySelector('.chart').innerHTML = '<div class="err">No data</div>'; continue; }

        // Tail for responsiveness
        const xs = s.xs.slice(-180);
        const ys = s.ys.slice(-180);
        this.makeChart(document.getElementById('c_'+c.k),{
          type:'line',
          data:{labels:xs, datasets:[{data:ys,borderColor:c.color,backgroundColor:'transparent',fill:false,tension:.35}]},
          options:this.baseOpts({
            plugins: c.zero ? { annotation:{ annotations:{ zero:{ type:'line', yMin:0, yMax:0, borderColor:'rgba(154,166,191,.6)', borderDash:[4,4], borderWidth:1 }}}} : {}
          })
        });
      }
    }

    renderDiag(){
      const out = {
        fetched_at_utc: this.data.raw?.fetched_at_utc ?? null,
        last_dates: Object.fromEntries(this.keys.map(k=>[k,this.data.lastISO[k]])),
        last_values: Object.fromEntries(this.keys.map(k=>[k,this.data.last[k]])),
        fresh_days: Object.fromEntries(this.keys.map(k=>[k,this.data.freshDays[k]])),
        composite_asof: this.compAsOf(),
        composite_strict: this.compStrict(),
        weights: this.weights
      };
      document.getElementById('diag').textContent = JSON.stringify(out,null,2);
      const built = this.data.raw?.fetched_at_utc ? new Date(this.data.raw.fetched_at_utc) : null;
      document.getElementById('built').textContent = built ? `${gb(toISO(built))} ${built.toLocaleTimeString('en-GB',{hour:'2-digit',minute:'2-digit'})}` : '—';
    }

    // Chart helpers
    baseOpts(ovr={}){
      const base = {
        responsive:true, maintainAspectRatio:false,
        scales:{
          x:{ grid:{color:'rgba(255,255,255,.05)'}, ticks:{color:'#9aa6bf', maxRotation:0, autoSkip:true, maxTicksLimit:8} },
          y:{ grid:{color:'rgba(255,255,255,.05)'}, ticks:{color:'#9aa6bf'} }
        },
        plugins:{ legend:{display:false}, tooltip:{enabled:true} },
        elements:{ line:{borderWidth:2}, point:{radius:0, hitRadius:8, hoverRadius:4} },
        animation:{ duration:600 }
      };
      // merge
      const merged = {...base, ...ovr};
      merged.scales = {...base.scales, ...(ovr.scales||{})};
      merged.plugins = {...base.plugins, ...(ovr.plugins||{})};
      return merged;
    }

    makeChart(el, cfg){
      try{
        // Register annotation once
        try{
          const ap = (window.ChartAnnotation || window['chartjs-plugin-annotation']);
          if(ap && !Chart.registry.getPlugin('annotation')) Chart.register(ap);
        }catch(e){}
        if(this.charts.has(el)) this.charts.get(el).destroy();
        const c = new Chart(el, cfg);
        this.charts.set(el,c);
        return c;
      }catch(e){
        console.error(e);
        el.closest('.chart').innerHTML = `<div class="err">Chart error: ${e.message}</div>`;
        return null;
      }
    }
  }

  // boot
  if(document.readyState==='loading') document.addEventListener('DOMContentLoaded',()=>new CrashRadar());
  else new CrashRadar();
  </script>
</body>
</html>
