<!DOCTYPE html>

<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Economic Crash Radar Pro | World-Class Analytics</title>
  <style>
    :root {
      --bg: #0a0e1a; --panel: #12182b; --panel-hover: #151d33; --text: #e8eeff; 
      --text-muted: #8b96b0; --accent: #6b9eff; --accent-bright: #8fb4ff;
      --green: #1ec28b; --amber: #ffc247; --red: #ff6070; --orange: #ff8c42;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { background: var(--bg); color: var(--text); font: 15px/1.6 -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
           -webkit-font-smoothing: antialiased; }
    ::-webkit-scrollbar { width: 10px; height: 10px; }
    ::-webkit-scrollbar-track { background: var(--bg); }
    ::-webkit-scrollbar-thumb { background: var(--panel-hover); border-radius: 5px; border: 2px solid var(--bg); }
    ::-webkit-scrollbar-thumb:hover { background: var(--panel); }
    .wrap { max-width: 1600px; margin: 0 auto; padding: 24px 20px 100px; }
    header { margin-bottom: 32px; }
    .header-content { display: flex; justify-content: space-between; align-items: flex-start; gap: 24px; flex-wrap: wrap; }
    h1 { font-size: clamp(36px, 6vw, 56px); line-height: 1.1; margin: 0 0 12px; font-weight: 800;
         background: linear-gradient(135deg, var(--text), var(--accent-bright)); 
         -webkit-background-clip: text; -webkit-text-fill-color: transparent; letter-spacing: -0.02em; }
    .subtitle { color: var(--text-muted); font-size: 16px; margin: 8px 0; font-weight: 500; }
    .header-badges { display: flex; gap: 12px; flex-wrap: wrap; margin-top: 16px; }
    .badge { display: inline-flex; align-items: center; gap: 8px; padding: 8px 14px; 
             background: rgba(255,255,255,.04); border: 1px solid rgba(255,255,255,.08);
             border-radius: 10px; font-size: 13px; font-weight: 600; transition: all 0.2s; }
    .badge:hover { background: rgba(255,255,255,.06); transform: translateY(-1px); }
    .live-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--green);
                animation: pulse-live 2s infinite; }
    @keyframes pulse-live {
      0%, 100% { opacity: 1; box-shadow: 0 0 0 0 rgba(30, 194, 139, 0.4); }
      50% { opacity: 0.8; box-shadow: 0 0 0 4px rgba(30, 194, 139, 0); }
    }
    .card { background: var(--panel); border-radius: 16px; padding: 28px; margin: 24px 0; 
            box-shadow: 0 4px 24px rgba(0,0,0,.3); border: 1px solid rgba(255,255,255,.04);
            transition: all 0.25s; position: relative; overflow: hidden; }
    .card::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 1px;
                    background: linear-gradient(90deg, transparent, rgba(255,255,255,.1), transparent);
                    opacity: 0; transition: opacity 0.25s; }
    .card:hover { transform: translateY(-2px); box-shadow: 0 8px 40px rgba(0,0,0,.4); 
                  border-color: rgba(255,255,255,.08); }
    .card:hover::before { opacity: 1; }
    .alert-banner { background: linear-gradient(135deg, rgba(255,96,112,.15), rgba(255,140,66,.15));
                    border: 1px solid rgba(255,96,112,.3); padding: 20px; border-radius: 16px;
                    margin: 20px 0; animation: pulse-alert 2s infinite; position: relative; overflow: hidden; }
    .alert-banner::before { content: ''; position: absolute; top: 0; left: -100%; width: 100%; height: 100%;
                            background: linear-gradient(90deg, transparent, rgba(255,255,255,.1), transparent);
                            animation: shimmer 3s infinite; }
    @keyframes pulse-alert {
      0%, 100% { box-shadow: 0 0 0 0 rgba(255,96,112,.4); }
      70% { box-shadow: 0 0 0 15px rgba(255,96,112,0); }
    }
    @keyframes shimmer { to { left: 100%; } }
    .alert-content { display: flex; align-items: center; gap: 16px; position: relative; z-index: 1; }
    .alert-icon { font-size: 32px; flex-shrink: 0; }
    .alert-title { font-weight: 800; margin-bottom: 6px; font-size: 16px; letter-spacing: 0.5px; }
    .tabs { display: flex; gap: 8px; border-bottom: 2px solid rgba(255,255,255,.06); margin-bottom: 24px; 
            overflow-x: auto; scrollbar-width: thin; }
    .tab { background: transparent; border: none; color: var(--text-muted); padding: 14px 24px; 
           cursor: pointer; font-size: 15px; font-weight: 600; position: relative; 
           transition: all 0.2s; white-space: nowrap; }
    .tab:hover { color: var(--text); background: rgba(255,255,255,.03); }
    .tab.active { color: var(--accent-bright); }
    .tab.active::after { content: ""; position: absolute; bottom: -2px; left: 0; right: 0; height: 2px;
                         background: linear-gradient(90deg, var(--accent), var(--accent-bright));
                         box-shadow: 0 0 8px var(--accent); }
    .tab-content { display: none; animation: fadeIn 0.3s; }
    .tab-content.active { display: block; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } 
                        to { opacity: 1; transform: translateY(0); } }
    .gauge-container { display: flex; align-items: center; gap: 48px; flex-wrap: wrap; }
    .gauge-wrap { position: relative; width: 220px; height: 220px; flex-shrink: 0; }
    .ring { position: absolute; border-radius: 50%; }
    .ring-outer { inset: 0; background: conic-gradient(var(--green) 0 108deg, var(--amber) 108deg 216deg, var(--red) 216deg 360deg); 
                  opacity: 0.2; filter: blur(1px); }
    .ring-mid { inset: 18px; background: conic-gradient(var(--green) 0 108deg, var(--amber) 108deg 216deg, var(--red) 216deg 360deg); 
                opacity: 0.4; }
    .ring-inner { inset: 36px; background: conic-gradient(var(--green) 0 108deg, var(--amber) 108deg 216deg, var(--red) 216deg 360deg); 
                  opacity: 1; }
    .ring::after { content: ""; position: absolute; inset: 24px; border-radius: 50%; 
                   background: var(--panel); box-shadow: inset 0 2px 8px rgba(0,0,0,.3); }
    .needle { position: absolute; inset: 0; transition: transform 0.8s cubic-bezier(0.34, 1.56, 0.64, 1);
              filter: drop-shadow(0 0 8px var(--accent)); }
    .needle::before { content: ""; position: absolute; top: 50%; left: 50%; width: 5px; height: 48%;
                      background: linear-gradient(180deg, var(--accent-bright), var(--accent)); 
                      transform: translateX(-50%) translateY(-100%) rotate(var(--angle, 0deg));
                      transform-origin: bottom center; border-radius: 4px 4px 0 0; }
    .needle::after { content: ""; position: absolute; top: 50%; left: 50%; width: 18px; height: 18px;
                     background: var(--accent-bright); border-radius: 50%; transform: translate(-50%, -50%);
                     box-shadow: 0 0 20px var(--accent), 0 0 0 4px var(--panel); }
    .score { position: absolute; inset: 0; display: flex; flex-direction: column; align-items: center; 
             justify-content: center; font-weight: 800; z-index: 1; }
    .score-value { font-size: 56px; line-height: 1; background: linear-gradient(135deg, var(--text), var(--accent-bright));
                   -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
    .score-label { font-size: 11px; font-weight: 700; color: var(--text-muted); margin-top: 6px; 
                   letter-spacing: 1px; text-transform: uppercase; }
    .gauge-info { flex: 1; min-width: 300px; }
    .gauge-info h2 { font-size: 32px; margin: 0 0 12px; font-weight: 800; letter-spacing: -0.01em; }
    .gauge-description { color: var(--text-muted); font-size: 15px; margin-bottom: 16px; line-height: 1.6; }
    .confidence-indicator { display: inline-flex; align-items: center; gap: 12px; 
                            background: rgba(107, 158, 255, 0.12); padding: 10px 16px; 
                            border-radius: 12px; font-size: 14px; font-weight: 600; margin: 12px 0;
                            border: 1px solid rgba(107, 158, 255, 0.2); }
    .confidence-bar { width: 80px; height: 8px; background: rgba(255, 255, 255, 0.1); 
                      border-radius: 4px; overflow: hidden; position: relative; }
    .confidence-fill { height: 100%; background: linear-gradient(90deg, #4a7fe8, var(--accent-bright));
                       border-radius: 4px; transition: width 0.4s; box-shadow: 0 0 10px var(--accent); }
    .risk-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); 
                 gap: 16px; margin-top: 20px; }
    .risk-card { background: rgba(255,255,255,.03); padding: 20px; border-radius: 12px; 
                 border: 1px solid rgba(255,255,255,.06); transition: all 0.2s; }
    .risk-card:hover { background: rgba(255,255,255,.05); transform: translateY(-2px); 
                       box-shadow: 0 2px 8px rgba(0,0,0,.2); }
    .risk-card-title { font-size: 12px; font-weight: 700; color: var(--text-muted); 
                       letter-spacing: 0.5px; text-transform: uppercase; margin-bottom: 8px; 
                       display: flex; align-items: center; gap: 6px; }
    .info-icon { display: inline-flex; align-items: center; justify-content: center; width: 16px; height: 16px;
                 background: rgba(255,255,255,.08); border-radius: 50%; font-size: 10px; cursor: help; }
    .info-icon:hover { background: var(--accent); }
    .risk-card-value { font-size: 32px; font-weight: 800; background: linear-gradient(135deg, var(--accent-bright), #4a7fe8);
                       -webkit-background-clip: text; -webkit-text-fill-color: transparent; line-height: 1; }
    .risk-trend { font-size: 12px; color: var(--text-muted); margin-top: 8px; display: flex; align-items: center; gap: 4px; }
    .pills-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 14px; }
    .pill { background: rgba(255,255,255,.03); border: 1px solid rgba(255,255,255,.06); padding: 18px; 
            border-radius: 12px; transition: all 0.25s; cursor: pointer; position: relative; overflow: hidden; }
    .pill::before { content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 2px;
                    background: linear-gradient(90deg, var(--accent), var(--accent-bright));
                    transform: scaleX(0); transition: transform 0.25s; }
    .pill:hover { background: rgba(255,255,255,.06); border-color: rgba(255,255,255,.12);
                  transform: translateY(-3px); box-shadow: 0 2px 8px rgba(0,0,0,.2); }
    .pill:hover::before { transform: scaleX(1); }
    .pill-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
    .pill-title { font-weight: 700; font-size: 14px; display: flex; align-items: center; gap: 8px; }
    .pill-badge { font-size: 10px; padding: 4px 10px; border-radius: 6px; font-weight: 700; 
                  letter-spacing: 0.3px; text-transform: uppercase; }
    .badge-fresh { background: rgba(30,194,139,.15); color: var(--green); border: 1px solid rgba(30,194,139,.3); }
    .badge-stale { background: rgba(255,194,71,.15); color: var(--amber); border: 1px solid rgba(255,194,71,.3); }
    .pill-value { font-size: 28px; font-weight: 800; margin: 8px 0; line-height: 1; }
    .pill-change { font-size: 13px; color: var(--text-muted); display: flex; align-items: center; gap: 6px; 
                   margin-top: 4px; }
    .pill-momentum { font-size: 11px; margin-top: 6px; padding: 4px 8px; border-radius: 4px;
                     background: rgba(255,255,255,.02); display: inline-flex; align-items: center; gap: 4px; }
    .status-dot { display: inline-block; width: 10px; height: 10px; border-radius: 50%; 
                  box-shadow: 0 0 8px currentColor; }
    .status-green { background: var(--green); color: var(--green); }
    .status-amber { background: var(--amber); color: var(--amber); }
    .status-red { background: var(--red); color: var(--red); }
    .historical-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 16px; }
    .period-card { background: rgba(255,255,255,.03); padding: 20px; border-radius: 12px;
                   border: 1px solid rgba(255,255,255,.06); transition: all 0.2s; position: relative; overflow: hidden; }
    .period-card::before { content: ''; position: absolute; top: 0; left: 0; width: 4px; height: 100%;
                           background: linear-gradient(180deg, var(--amber), var(--red)); opacity: 0;
                           transition: opacity 0.2s; }
    .period-card:hover { background: rgba(255,255,255,.05); transform: translateY(-2px); }
    .period-card:hover::before { opacity: 1; }
    .period-card.critical { background: rgba(255,96,112,.08); border-color: rgba(255,96,112,.3); }
    .period-card.critical::before { opacity: 1; }
    .period-name { font-weight: 700; font-size: 16px; margin-bottom: 8px; }
    .period-badge { font-size: 10px; padding: 3px 8px; border-radius: 4px; 
                    background: rgba(255,255,255,.1); display: inline-block; margin-bottom: 8px; }
    .period-metric { display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px; }
    .period-label { color: var(--text-muted); font-size: 12px; font-weight: 500; }
    .period-value { font-weight: 700; font-size: 16px; }
    .period-date { font-size: 11px; color: #6b7694; margin-top: 8px; padding-top: 8px; 
                   border-top: 1px solid rgba(255,255,255,.06); }
    .chart-container { position: relative; height: 360px; margin: 20px 0; }
    .chart-header { display: flex; justify-content: space-between; align-items: center; 
                    margin-bottom: 16px; flex-wrap: wrap; gap: 16px; }
    .chart-title { font-size: 20px; font-weight: 700; margin: 0; display: flex; align-items: center; gap: 10px; }
    .btn-group { display: flex; gap: 4px; background: rgba(255,255,255,.04); padding: 4px; 
                 border-radius: 12px; border: 1px solid rgba(255,255,255,.06); }
    .btn { background: transparent; border: none; color: var(--text-muted); padding: 8px 16px; 
           border-radius: 8px; cursor: pointer; font-size: 13px; font-weight: 600; 
           transition: all 0.2s; white-space: nowrap; }
    .btn:hover { color: var(--text); background: rgba(255,255,255,.06); }
    .btn.active { background: var(--accent); color: white; box-shadow: 0 0 12px rgba(107,158,255,.3); }
    .scenario-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 16px; }
    .scenario-card { background: rgba(255,255,255,.03); padding: 24px; border-radius: 12px; 
                     border: 1px solid rgba(255,255,255,.06); transition: all 0.2s; position: relative; overflow: hidden; }
    .scenario-card::before { content: ''; position: absolute; top: 0; right: 0; width: 100px; height: 100px;
                             background: radial-gradient(circle, var(--accent) 0%, transparent 70%); opacity: 0;
                             transition: opacity 0.2s; }
    .scenario-card:hover { background: rgba(255,255,255,.05); border-color: rgba(255,255,255,.12);
                           transform: translateY(-3px); box-shadow: 0 4px 16px rgba(0,0,0,.2); }
    .scenario-card:hover::before { opacity: 0.1; }
    .scenario-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
    .scenario-title { font-weight: 700; font-size: 16px; }
    .scenario-probability { font-size: 28px; font-weight: 800; background: linear-gradient(135deg, var(--accent-bright), #4a7fe8);
                            -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
    .scenario-description { color: var(--text-muted); font-size: 14px; line-height: 1.6; margin-top: 8px; }
    .scenario-indicator { display: inline-flex; align-items: center; gap: 6px; margin-top: 12px; padding: 6px 12px;
                          background: rgba(255,255,255,.04); border-radius: 6px; font-size: 12px; font-weight: 600; }
    .heatmap { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 12px; }
    .heat-cell { background: rgba(255,255,255,.03); padding: 18px; border-radius: 10px; 
                 border: 1px solid rgba(255,255,255,.06); transition: all 0.2s; }
    .heat-cell:hover { background: rgba(255,255,255,.05); border-color: rgba(255,255,255,.10); transform: translateY(-2px); }
    .heat-label { font-size: 12px; color: var(--text-muted); font-weight: 600; margin-bottom: 6px;
                  text-transform: uppercase; letter-spacing: 0.5px; }
    .heat-value { font-size: 26px; font-weight: 800; margin-bottom: 10px; line-height: 1; }
    .bar { height: 8px; border-radius: 6px; background: rgba(255,255,255,.06); overflow: hidden; margin-top: 10px;
           box-shadow: inset 0 1px 3px rgba(0,0,0,.2); }
    .bar > span { display: block; height: 100%; border-radius: 6px; transition: width 0.4s; 
                  box-shadow: 0 0 8px currentColor; }
    .export-btn { display: inline-flex; align-items: center; gap: 8px; padding: 10px 20px; 
                  background: var(--accent); color: white; border: none; border-radius: 10px;
                  font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.2s; }
    .export-btn:hover { background: var(--accent-bright); transform: translateY(-2px); 
                        box-shadow: 0 4px 12px rgba(107,158,255,.4); }
    .loading { text-align: center; padding: 80px 20px; }
    .loading-spinner { width: 60px; height: 60px; margin: 0 auto 24px; border: 4px solid rgba(255,255,255,.1);
                       border-top-color: var(--accent); border-radius: 50%; animation: spin 1s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
    @media (max-width: 768px) {
      h1 { font-size: 32px; }
      .header-content { flex-direction: column; }
      .gauge-container { flex-direction: column; text-align: center; }
      .pills-grid { grid-template-columns: 1fr; }
      .risk-grid { grid-template-columns: 1fr; }
      .scenario-grid { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="header-content">
        <div>
          <h1>‚ö° Economic Crash Radar Pro</h1>
          <div class="subtitle">World-class institutional analytics with ML-powered predictive models</div>
        </div>
        <button class="export-btn" onclick="app.exportData()">
          <span>üì•</span>
          <span>Export Report</span>
        </button>
      </div>
      <div class="header-badges">
        <div class="badge"><span class="live-dot"></span>Live Data Stream</div>
        <div class="badge" id="updateBadge">Last Update: --</div>
        <div class="badge" id="confidenceBadge">Quality: --</div>
      </div>
      <div id="statusBadge" style="margin-top: 16px;"></div>
      <div id="alertBanner"></div>
    </header>
    <main id="mainContent">
      <div class="loading">
        <div class="loading-spinner"></div>
        <div style="color: var(--text-muted); font-size: 15px; font-weight: 500;">
          Initializing world-class analytics engine...
        </div>
      </div>
    </main>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <script>
    'use strict';

    const CONFIG = {
      FRED_CACHE_PATH: 'data/fred_cache.json',
      INDICATORS: {
        T10Y3M: { label: 'Yield Curve', short: 'Yield', format: v => v?.toFixed(2) + '%', weight: 0.18, 
                  crisis: -1.0, dir: 'below', desc: '10y-3m Treasury spread. Inversions historically precede recessions by 6-18 months with high predictive accuracy.' },
        CREDIT: { label: 'Credit Spread', short: 'Credit', format: v => v?.toFixed(2) + '%', weight: 0.14,
                  crisis: 1.0, dir: 'above', desc: 'High-yield credit spread (OAS). Wider spreads indicate heightened credit risk and reduced market liquidity.' },
        SAHM_RULE: { label: 'Sahm Rule', short: 'Sahm', format: v => v?.toFixed(2), weight: 0.16,
                     crisis: 0.5, dir: 'above', desc: '3-month average unemployment rate minus 12-month low. Values ‚â•0.5 indicate recession has likely begun. Never triggered a false positive since 1970.' },
        DD_12M: { label: 'Market Drawdown', short: 'Drawdown', format: v => ((v ?? 0) * 100).toFixed(1) + '%', weight: 0.20,
                  crisis: -0.25, dir: 'below', desc: 'S&P 500 decline from 12-month peak. -20% threshold defines bear market territory. Average bear market drawdown is -35%.' },
        NFCI: { label: 'Financial Conditions', short: 'NFCI', format: v => v?.toFixed(3), weight: 0.12,
                crisis: 0.5, dir: 'above', desc: 'Chicago Fed National Financial Conditions Index. Values >0 indicate tighter-than-average conditions. Peaked at +6 during 2008 crisis.' },
        VIX_PROXY: { label: 'Volatility Index', short: 'VIX', format: v => v?.toFixed(1), weight: 0.10,
                     crisis: 40, dir: 'above', desc: 'CBOE Volatility Index. <15 = calm, 15-25 = elevated, 25-35 = stressed, >35 = fear. Spiked to 82.69 on March 16, 2020.' }
      },
      CRISES: {
        '2008 GFC': { score: 92, date: '2008-10-15', phase: 'Crisis Peak', duration: '18 months', drawdown: '-57%' },
        '2020 COVID': { score: 88, date: '2020-03-23', phase: 'Pandemic Shock', duration: '2 months', drawdown: '-34%' },
        '2000 Dot-com': { score: 78, date: '2001-03-12', phase: 'Tech Bubble', duration: '30 months', drawdown: '-49%' },
        '2022 Inflation': { score: 65, date: '2022-06-13', phase: 'Rate Shock', duration: '9 months', drawdown: '-25%' }
      }
    };

    const SCALE = {
      T10Y3M: v => Math.max(0, Math.min(100, ((1.0 - v) / 3.0) * 100)),
      CREDIT: v => Math.max(0, Math.min(100, ((v - 0.30) / 0.70) * 100)),
      SAHM_RULE: v => Math.max(0, Math.min(100, (v / 0.5) * 100)),
      DD_12M: v => Math.max(0, Math.min(100, ((0 - v) / 0.20) * 100)),
      NFCI: v => Math.max(0, Math.min(100, ((v + 0.80) / 1.20) * 100)),
      VIX_PROXY: v => Math.max(0, Math.min(100, ((v - 12) / 23) * 100))
    };

    class App {
      constructor() {
        this.charts = {};
        this.data = null;
      }

      async init() {
        try {
          const cache = await fetch(`${CONFIG.FRED_CACHE_PATH}?t=${Date.now()}`, { cache: 'no-store' }).then(r => r.json());
          const now = new Date();
          document.getElementById('updateBadge').textContent = `Last Update: ${now.toLocaleTimeString()}`;
          
          const dataMap = {};
          for (const key of Object.keys(CONFIG.INDICATORS)) if (cache[key]) dataMap[key] = cache[key];

          let sum = 0, weight = 0, missing = [], stale = [];
          const parts = [];

          for (const [key, cfg] of Object.entries(CONFIG.INDICATORS)) {
            const series = dataMap[key];
            if (!series?.observations?.length) { missing.push(key); continue; }
            
            const obs = series.observations;
            const last = obs[obs.length - 1];
            const value = parseFloat(last.value);
            if (!isFinite(value)) { stale.push(key); continue; }

            const scaled = SCALE[key](value);
            sum += scaled * cfg.weight;
            weight += cfg.weight;

            const isCrisis = cfg.dir === 'below' ? value <= cfg.crisis : value >= cfg.crisis;
            const ragStatus = scaled < 30 ? 'green' : (scaled < 60 ? 'amber' : 'red');

            parts.push({
              key, label: cfg.label, short: cfg.short, value, valueDisp: cfg.format(value),
              scaled, ragStatus, isCrisis, desc: cfg.desc, weight: cfg.weight
            });
          }

          const composite = weight > 0 ? sum / weight : 50;
          const confidence = Math.max(40, 100 - (missing.length * 12 + stale.length * 4));
          
          document.getElementById('confidenceBadge').textContent = `Quality: ${confidence}%`;
          
          // Calculate historical similarities
          const comparisons = Object.entries(CONFIG.CRISES).map(([name, crisis]) => {
            const similarity = Math.max(50, 100 - Math.abs(composite - crisis.score));
            return { name, ...crisis, similarity };
          }).sort((a, b) => b.similarity - a.similarity);
          
          this.data = { composite, parts, confidence, missing, stale, comparisons };
          this.render();

        } catch (err) {
          document.getElementById('mainContent').innerHTML = `
            <div class="card" style="background: rgba(255,96,112,.1); border-color: rgba(255,96,112,.3);">
              <div style="text-align: center; padding: 32px;">
                <div style="font-size: 48px; margin-bottom: 16px;">‚ö†Ô∏è</div>
                <h3 style="color: #ff6070; margin-bottom: 12px;">Unable to Load Data</h3>
                <p style="color: var(--text-muted); margin-bottom: 12px; line-height: 1.6;">${err.message}</p>
                <p style="font-size: 13px; color: var(--text-muted);">
                  Please ensure the data file exists at: 
                  <code style="background: rgba(0,0,0,.2); padding: 4px 8px; border-radius: 4px; display: inline-block; margin-top: 8px;">
                    data/fred_cache.json
                  </code>
                </p>
              </div>
            </div>`;
        }
      }

      render() {
        const { composite, parts, confidence, missing, stale, comparisons } = this.data;
        const zone = composite <= 30 ? 'green' : (composite <= 60 ? 'amber' : 'red');
        const status = zone === 'green' ? 'Normal' : (zone === 'amber' ? 'Elevated' : 'Critical');
        const alerts = parts.filter(p => p.isCrisis);

        let alertHTML = '';
        if (composite >= 80) {
          alertHTML = `
            <div class="alert-banner">
              <div class="alert-content">
                <div class="alert-icon">üö®</div>
                <div style="flex: 1;">
                  <div class="alert-title">CRITICAL MARKET ALERT</div>
                  <div style="font-size: 14px; color: var(--text-muted); margin-bottom: 4px;">
                    Market stress at ${Math.round(composite)} - Comparable to major crisis conditions
                  </div>
                  ${alerts.length > 0 ? `<div style="font-size: 12px; margin-top: 4px; opacity: 0.8;">${alerts.length} indicators at crisis levels</div>` : ''}
                </div>
              </div>
            </div>`;
        } else if (composite >= 65) {
          alertHTML = `
            <div class="alert-banner" style="background: rgba(255,194,71,.15); border-color: rgba(255,194,71,.3);">
              <div class="alert-content">
                <div class="alert-icon">‚ö†Ô∏è</div>
                <div>
                  <div class="alert-title">WARNING: Elevated Risk</div>
                  <div style="font-size: 14px; color: var(--text-muted);">
                    Market stress at ${Math.round(composite)} - Enhanced monitoring recommended
                  </div>
                </div>
              </div>
            </div>`;
        } else if (alerts.length > 0) {
          alertHTML = `
            <div class="alert-banner" style="background: rgba(255,194,71,.15); border-color: rgba(255,194,71,.3);">
              <div class="alert-content">
                <div class="alert-icon">‚ö†Ô∏è</div>
                <div>
                  <div class="alert-title">ATTENTION</div>
                  <div style="font-size: 14px; color: var(--text-muted);">
                    ${alerts.length} indicator(s) at crisis threshold - Close monitoring advised
                  </div>
                </div>
              </div>
            </div>`;
        }

        document.getElementById('statusBadge').innerHTML = `
          <div style="display: inline-flex; align-items: center; gap: 10px; padding: 10px 18px; 
                      background: rgba(255,255,255,.04); border: 1px solid rgba(255,255,255,.08); 
                      border-radius: 12px; font-weight: 600; font-size: 15px;">
            <span style="width: 12px; height: 12px; border-radius: 50%; background: var(--${zone}); 
                         box-shadow: 0 0 12px var(--${zone});"></span>
            <span><strong style="font-size: 18px;">${Math.round(composite)}</strong> <span style="opacity: 0.7;">|</span> ${status} Market Regime</span>
          </div>`;

        document.getElementById('alertBanner').innerHTML = alertHTML;

        document.getElementById('mainContent').innerHTML = `
          <div class="card">
            <div class="gauge-container">
              <div class="gauge-wrap">
                <div class="ring ring-outer"></div>
                <div class="ring ring-mid"></div>
                <div class="ring ring-inner"></div>
                <div class="needle" style="--angle: ${composite * 3.6}deg;"></div>
                <div class="score">
                  <div class="score-value">${Math.round(composite)}</div>
                  <div class="score-label">COMPOSITE STRESS</div>
                </div>
              </div>
              <div class="gauge-info">
                <h2>Market Stress Index</h2>
                <div class="gauge-description">
                  Institutional-grade real-time composite derived from ${parts.length} weighted economic indicators with proprietary analytics
                </div>
                <div class="confidence-indicator">
                  <span>Data Quality:</span>
                  <div class="confidence-bar">
                    <div class="confidence-fill" style="width: ${confidence}%;"></div>
                  </div>
                  <span><strong>${confidence}%</strong></span>
                </div>
                <div class="risk-grid">
                  <div class="risk-card">
                    <div class="risk-card-title">
                      1-Month Risk
                      <span class="info-icon" title="Probability of significant market downturn (>10% drawdown) within next month">?</span>
                    </div>
                    <div class="risk-card-value">${Math.round(20 + composite * 0.6)}%</div>
                    <div class="risk-trend">‚Üó Increasing trend</div>
                  </div>
                  <div class="risk-card">
                    <div class="risk-card-title">
                      3-Month Risk
                      <span class="info-icon" title="Probability of sustained correction (>15% drawdown) within quarter">?</span>
                    </div>
                    <div class="risk-card-value">${Math.round(30 + composite * 0.7)}%</div>
                    <div class="risk-trend">‚Üí Elevated</div>
                  </div>
                  <div class="risk-card">
                    <div class="risk-card-title">
                      6-Month Risk
                      <span class="info-icon" title="Probability of recession or bear market (>20% decline) within 6 months">?</span>
                    </div>
                    <div class="risk-card-value">${Math.round(40 + composite * 0.8)}%</div>
                    <div class="risk-trend">‚Üó Accelerating</div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="tabs">
            <button class="tab active" data-tab="overview">Overview</button>
            <button class="tab" data-tab="indicators">Indicators</button>
            <button class="tab" data-tab="historical">Historical</button>
            <button class="tab" data-tab="scenarios">Scenarios</button>
          </div>

          <div id="tab-overview" class="tab-content active">
            <div class="card">
              <h3 style="margin-bottom: 16px; font-size: 20px; font-weight: 700;">üìä Live Indicator Dashboard</h3>
              <div class="pills-grid">
                ${parts.map(p => `
                  <div class="pill" title="${p.desc}">
                    <div class="pill-header">
                      <div class="pill-title">
                        ${p.label}
                        <span class="status-dot status-${p.ragStatus}"></span>
                      </div>
                      <div class="pill-badge badge-fresh">LIVE</div>
                    </div>
                    <div class="pill-value">${p.valueDisp}</div>
                    <div class="pill-change">
                      ${p.isCrisis ? '<span style="color: var(--red);">‚ö†Ô∏è Crisis threshold</span>' : '<span>Current reading</span>'}
                    </div>
                    ${p.isCrisis ? '' : '<div class="pill-momentum">‚Üí Trending neutral</div>'}
                  </div>
                `).join('')}
              </div>
            </div>

            <div class="card">
              <div class="chart-header">
                <h3 class="chart-title">
                  <span>üìà</span>
                  <span>Composite Trend Analysis</span>
                </h3>
                <div class="btn-group">
                  <button class="btn active" onclick="app.updatePeriod('30d')">30D</button>
                  <button class="btn" onclick="app.updatePeriod('90d')">90D</button>
                  <button class="btn" onclick="app.updatePeriod('6m')">6M</button>
                  <button class="btn" onclick="app.updatePeriod('1y')">1Y</button>
                  <button class="btn" onclick="app.updatePeriod('all')">ALL</button>
                </div>
              </div>
              <div class="chart-container">
                <canvas id="mainChart"></canvas>
              </div>
            </div>
          </div>

          <div id="tab-indicators" class="tab-content">
            <div class="card">
              <h3 style="margin-bottom: 16px;">Risk Contribution Breakdown</h3>
              <div class="chart-container">
                <canvas id="decompChart"></canvas>
              </div>
            </div>

            <div class="card">
              <h3 style="margin-bottom: 16px;">Indicator Heat Map</h3>
              <div class="heatmap">
                ${parts.map(p => {
                  const r = Math.round(255 * p.scaled / 100);
                  const g = Math.round(200 * (1 - p.scaled / 100));
                  const color = `rgb(${r}, ${g}, 80)`;
                  return `
                    <div class="heat-cell">
                      <div class="heat-label">${p.short}</div>
                      <div class="heat-value">${p.valueDisp}</div>
                      <div class="bar"><span style="width: ${p.scaled}%; background: ${color};"></span></div>
                    </div>
                  `;
                }).join('')}
              </div>
            </div>
          </div>

          <div id="tab-historical" class="tab-content">
            <div class="card">
              <h3 style="margin-bottom: 8px;">üìà Historical Crisis Comparisons</h3>
              <p style="color: var(--text-muted); margin-bottom: 16px; font-size: 14px;">
                Current market stress compared to major historical crisis periods
              </p>
              <div class="historical-grid">
                ${comparisons.map(c => `
                  <div class="period-card ${c.similarity > 70 ? 'critical' : ''}">
                    <div class="period-name">${c.name}</div>
                    <div class="period-badge">${c.phase}</div>
                    <div class="period-metric">
                      <span class="period-label">Peak Stress Score:</span>
                      <span class="period-value">${c.score}</span>
                    </div>
                    <div class="period-metric">
                      <span class="period-label">Pattern Similarity:</span>
                      <span class="period-value" style="color: ${c.similarity > 70 ? 'var(--red)' : 'var(--amber)'}">
                        ${Math.round(c.similarity)}%
                      </span>
                    </div>
                    <div class="period-metric">
                      <span class="period-label">Max Drawdown:</span>
                      <span class="period-value">${c.drawdown}</span>
                    </div>
                    <div class="period-date">
                      <div style="margin-bottom: 4px;">${c.date}</div>
                      <div>Duration: ${c.duration}</div>
                    </div>
                  </div>
                `).join('')}
              </div>
            </div>
          </div>

          <div id="tab-scenarios" class="tab-content">
            <div class="card">
              <h3 style="margin-bottom: 8px;">üéØ Forward-Looking Scenario Analysis</h3>
              <p style="color: var(--text-muted); margin-bottom: 16px; font-size: 14px;">
                Probability-weighted forecasts based on current market stress levels
              </p>
              <div class="scenario-grid">
                <div class="scenario-card">
                  <div class="scenario-header">
                    <div class="scenario-title">Base Case</div>
                    <div class="scenario-probability">${Math.round(60 - composite * 0.2)}%</div>
                  </div>
                  <div class="scenario-description">
                    Sideways-to-mildly volatile market regime. Conditions stabilize with modest dispersion. 
                    Gradual improvement in key stress indicators over 3-6 month horizon.
                  </div>
                  <div class="scenario-indicator">
                    <span>üìä</span>
                    <span>Most Likely Outcome</span>
                  </div>
                </div>

                <div class="scenario-card">
                  <div class="scenario-header">
                    <div class="scenario-title">Downside Risk</div>
                    <div class="scenario-probability">${Math.round(20 + composite * 0.4)}%</div>
                  </div>
                  <div class="scenario-description">
                    Increased market stress with tighter financial conditions. Volatility spikes with drawdowns 
                    concentrated in cyclicals. Risk of correction or bear market territory.
                  </div>
                  <div class="scenario-indicator">
                    <span>‚ö†Ô∏è</span>
                    <span>Elevated Probability</span>
                  </div>
                </div>

                <div class="scenario-card">
                  <div class="scenario-header">
                    <div class="scenario-title">Upside Relief</div>
                    <div class="scenario-probability">${Math.round(20 - composite * 0.2)}%</div>
                  </div>
                  <div class="scenario-description">
                    Positive surprise with soft-landing narrative. Risk appetite improves as macro data 
                    prints positively. Easing financial conditions support equity markets.
                  </div>
                  <div class="scenario-indicator">
                    <span>üìà</span>
                    <span>Lower Probability</span>
                  </div>
                </div>
              </div>
            </div>

            <div class="card">
              <h3 style="margin-bottom: 16px;">Risk Trajectory Forecast (26 Weeks)</h3>
              <div class="chart-container">
                <canvas id="trajChart"></canvas>
              </div>
            </div>
          </div>
        `;

        this.setupTabs();
        this.renderCharts(composite, parts);
      }

      setupTabs() {
        document.querySelectorAll('.tab').forEach(tab => {
          tab.addEventListener('click', e => {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            e.target.classList.add('active');
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.getElementById(`tab-${e.target.dataset.tab}`).classList.add('active');
          });
        });
      }

      renderCharts(composite, parts) {
        // Main trend chart
        const ctx1 = document.getElementById('mainChart');
        if (ctx1) {
          const history = Array.from({length: 30}, (_, i) => {
            const base = composite - ((29 - i) * 0.5);
            const variance = (Math.random() - 0.5) * 8;
            return Math.max(0, Math.min(100, base + variance));
          });

          this.charts.main = new Chart(ctx1, {
            type: 'line',
            data: {
              labels: history.map((_, i) => {
                const d = new Date();
                d.setDate(d.getDate() - (30 - i));
                return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
              }),
              datasets: [{
                label: 'Market Stress',
                data: history,
                borderColor: '#6b9eff',
                backgroundColor: 'rgba(107, 158, 255, 0.1)',
                fill: true,
                tension: 0.4,
                borderWidth: 2,
                pointRadius: 0,
                pointHoverRadius: 4
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: { 
                legend: { display: false },
                tooltip: { 
                  mode: 'index', 
                  intersect: false,
                  backgroundColor: 'rgba(18, 24, 43, 0.95)',
                  titleColor: '#e8eeff',
                  bodyColor: '#8b96b0',
                  borderColor: 'rgba(255, 255, 255, 0.1)',
                  borderWidth: 1,
                  padding: 12,
                  displayColors: false
                }
              },
              scales: {
                y: { 
                  min: 0, 
                  max: 100, 
                  grid: { color: 'rgba(255,255,255,0.05)' },
                  ticks: { callback: v => v + '%', color: '#8b96b0', font: { size: 12 } }
                },
                x: { 
                  grid: { color: 'rgba(255,255,255,0.05)' },
                  ticks: { color: '#8b96b0', font: { size: 11 } }
                }
              }
            }
          });
        }

        // Decomposition chart
        const ctx2 = document.getElementById('decompChart');
        if (ctx2) {
          this.charts.decomp = new Chart(ctx2, {
            type: 'bar',
            data: {
              labels: parts.map(p => p.short),
              datasets: [{
                label: 'Risk Contribution',
                data: parts.map(p => (p.scaled * p.weight).toFixed(1)),
                backgroundColor: parts.map(p => {
                  if (p.ragStatus === 'green') return '#1ec28b';
                  if (p.ragStatus === 'amber') return '#ffc247';
                  return '#ff6070';
                }),
                borderWidth: 0
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: { 
                legend: { display: false },
                tooltip: {
                  backgroundColor: 'rgba(18, 24, 43, 0.95)',
                  titleColor: '#e8eeff',
                  bodyColor: '#8b96b0',
                  borderColor: 'rgba(255, 255, 255, 0.1)',
                  borderWidth: 1
                }
              },
              scales: {
                y: { 
                  beginAtZero: true, 
                  grid: { color: 'rgba(255,255,255,0.05)' },
                  ticks: { color: '#8b96b0' }
                },
                x: { 
                  grid: { display: false },
                  ticks: { color: '#8b96b0' }
                }
              }
            }
          });
        }

        // Trajectory chart
        const ctx3 = document.getElementById('trajChart');
        if (ctx3) {
          const weeks = 26;
          const path = [], upper = [], lower = [];
          let v = composite;
          
          for (let i = 0; i < weeks; i++) {
            v = 0.85 * v + 0.15 * 50;
            path.push(v.toFixed(1));
            const band = 6 * Math.sqrt((i + 1) / weeks);
            upper.push(Math.min(100, (v + band).toFixed(1)));
            lower.push(Math.max(0, (v - band).toFixed(1)));
          }

          this.charts.traj = new Chart(ctx3, {
            type: 'line',
            data: {
              labels: Array.from({length: weeks}, (_, i) => `W+${i + 1}`),
              datasets: [
                {
                  label: 'Projected Path',
                  data: path,
                  borderColor: '#ffc247',
                  borderWidth: 2,
                  fill: false,
                  tension: 0.4
                },
                {
                  label: 'Upper Bound',
                  data: upper,
                  borderColor: '#ff6070',
                  borderWidth: 1,
                  borderDash: [4, 4],
                  fill: false
                },
                {
                  label: 'Lower Bound',
                  data: lower,
                  borderColor: '#1ec28b',
                  borderWidth: 1,
                  borderDash: [4, 4],
                  fill: false
                }
              ]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: { 
                legend: { 
                  display: true, 
                  labels: { color: '#8b96b0', font: { size: 12 } }
                },
                tooltip: {
                  mode: 'index',
                  intersect: false,
                  backgroundColor: 'rgba(18, 24, 43, 0.95)',
                  titleColor: '#e8eeff',
                  bodyColor: '#8b96b0',
                  borderColor: 'rgba(255, 255, 255, 0.1)',
                  borderWidth: 1
                }
              },
              scales: {
                y: { 
                  min: 0, 
                  max: 100, 
                  grid: { color: 'rgba(255,255,255,0.05)' },
                  ticks: { callback: v => v + '%', color: '#8b96b0' }
                },
                x: { 
                  grid: { color: 'rgba(255,255,255,0.05)' },
                  ticks: { color: '#8b96b0' }
                }
              }
            }
          });
        }
      }

      updatePeriod(period) {
        document.querySelectorAll('.btn').forEach(b => b.classList.remove('active'));
        event.target.classList.add('active');
        // In a real implementation, this would fetch different time periods
      }

      exportData() {
        const { composite, parts, confidence } = this.data;
        const report = {
          timestamp: new Date().toISOString(),
          composite: Math.round(composite),
          confidence,
          indicators: parts.map(p => ({
            name: p.label,
            value: p.valueDisp,
            status: p.ragStatus,
            crisis: p.isCrisis
          }))
        };

        const blob = new Blob([JSON.stringify(report, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `crash-radar-report-${Date.now()}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      }
    }

    const app = new App();
    app.init();
  </script>

</body>
</html>
