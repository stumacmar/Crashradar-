<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Economic Crash Radar Pro</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <style>
    :root {
      --bg:#0a0e1a;
      --panel:#12182b;
      --text:#e8eeff;
      --muted:#8b96b0;
      --accent:#6b9eff;
      --accent-soft:#8fb4ff;
      --green:#1ec28b;
      --amber:#ffc247;
      --red:#ff6070;
      --radius-lg:16px;
      --shadow-soft:0 8px 24px rgba(0,0,0,0.45);
      --font-main:-apple-system,BlinkMacSystemFont,"Segoe UI",system-ui,sans-serif;
    }

    *{margin:0;padding:0;box-sizing:border-box;}

    body{
      background:var(--bg);
      color:var(--text);
      font:15px/1.6 var(--font-main);
      -webkit-font-smoothing:antialiased;
      padding:18px 12px 40px;
    }

    .container{max-width:1440px;margin:0 auto;}

    .header{text-align:center;margin-bottom:18px;}

    h1{
      font-size:clamp(30px,6vw,46px);
      font-weight:800;
      margin-bottom:6px;
      background:linear-gradient(135deg,var(--text),var(--accent-soft));
      -webkit-background-clip:text;
      -webkit-text-fill-color:transparent;
    }

    .subtitle{
      color:var(--muted);
      font-size:0.95rem;
    }

    .meta-badges{
      display:flex;
      flex-wrap:wrap;
      justify-content:center;
      gap:6px;
      margin-top:8px;
      font-size:0.7rem;
      color:var(--muted);
    }

    .badge{
      padding:4px 8px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,0.12);
      background:rgba(255,255,255,0.02);
    }

    .alert-banner{
      margin:16px auto 18px;
      padding:10px 12px;
      max-width:900px;
      border-radius:10px;
      background:linear-gradient(135deg,rgba(107,158,255,0.08),rgba(139,187,255,0.02));
      border:1px solid rgba(107,158,255,0.25);
      font-size:0.8rem;
      color:var(--text);
    }

    .dashboard{
      display:grid;
      grid-template-columns:280px 1fr;
      gap:16px;
      align-items:flex-start;
    }

    .sidebar{
      background:var(--panel);
      border-radius:var(--radius-lg);
      padding:16px 14px 14px;
      box-shadow:var(--shadow-soft);
    }

    .main-content{
      display:grid;
      grid-template-columns:repeat(2,minmax(0,1fr));
      gap:14px;
    }

    .card{
      background:var(--panel);
      border-radius:var(--radius-lg);
      padding:14px 12px 12px;
      box-shadow:var(--shadow-soft);
    }

    .card-title{
      font-size:1rem;
      font-weight:700;
      color:var(--accent-soft);
      display:flex;
      align-items:center;
      gap:6px;
      margin-bottom:8px;
    }

    .card-title .icon{font-size:1.1rem;}

    .gauge-container{text-align:center;margin-bottom:8px;}

    .gauge{
      position:relative;
      width:190px;
      height:190px;
      margin:0 auto;
    }

    .gauge-background{
      position:absolute;
      inset:0;
      border-radius:50%;
      background:conic-gradient(
        var(--green) 0deg 108deg,
        var(--amber) 108deg 216deg,
        var(--red) 216deg 360deg
      );
      opacity:0.28;
    }

    .gauge-center{
      position:absolute;
      top:10%;
      left:10%;
      width:80%;
      height:80%;
      border-radius:50%;
      background:var(--panel);
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
    }

    .gauge-score{
      font-size:2.4rem;
      font-weight:800;
    }

    .gauge-label{
      font-size:0.7rem;
      color:var(--muted);
      text-transform:uppercase;
      letter-spacing:0.08em;
      margin-top:2px;
      text-align:center;
    }

    .gauge-needle{
      position:absolute;
      bottom:50%;
      left:50%;
      width:3px;
      height:46%;
      background:var(--accent);
      transform-origin:bottom center;
      transform:translateX(-50%) rotate(0deg);
      border-radius:4px 4px 0 0;
      transition:transform 0.9s ease;
    }

    .risk-meter{margin-top:6px;}

    .risk-bar{
      height:6px;
      border-radius:4px;
      background:rgba(255,255,255,0.1);
      overflow:hidden;
    }

    .risk-fill{
      height:100%;
      width:0%;
      background:linear-gradient(90deg,var(--green),var(--amber),var(--red));
      transition:width 0.8s ease;
    }

    .risk-labels{
      display:flex;
      justify-content:space-between;
      margin-top:4px;
      font-size:0.65rem;
      color:var(--muted);
    }

    .status-grid{
      display:grid;
      grid-template-columns:repeat(2,minmax(0,1fr));
      gap:6px;
      margin-top:10px;
    }

    .status-item{
      padding:7px 6px;
      background:rgba(255,255,255,0.02);
      border-radius:8px;
      font-size:0.7rem;
    }

    .status-label{
      color:var(--muted);
      font-size:0.66rem;
    }

    .status-value{
      font-weight:700;
      font-size:0.95rem;
      margin-top:1px;
    }

    .indicator-grid{
      display:grid;
      grid-template-columns:repeat(auto-fill,minmax(220px,1fr));
      gap:7px;
      margin-top:4px;
    }

    .indicator{
      padding:7px 7px 6px;
      background:rgba(255,255,255,0.03);
      border-radius:8px;
      border-left:3px solid var(--green);
      font-size:0.7rem;
    }

    .indicator.warning{border-left-color:var(--amber);}
    .indicator.danger{border-left-color:var(--red);}

    .indicator-header{
      display:flex;
      justify-content:space-between;
      gap:4px;
      align-items:baseline;
      margin-bottom:2px;
    }

    .indicator-name{
      font-weight:600;
      font-size:0.78rem;
    }

    .indicator-value{
      font-weight:700;
      font-size:0.9rem;
    }

    .indicator-threshold{
      color:var(--muted);
      font-size:0.62rem;
      margin-top:1px;
    }

    .source-tag{
      display:inline-block;
      margin-top:3px;
      padding:2px 5px;
      border-radius:6px;
      border:1px solid rgba(255,255,255,0.14);
      font-size:0.58rem;
      color:var(--muted);
    }

    .manual-input-row{
      display:flex;
      flex-direction:column;
      gap:3px;
      margin-top:4px;
      font-size:0.6rem;
    }

    .manual-input-row span{
      color:var(--muted);
      font-size:0.62rem;
    }

    .manual-input{
      width:100%;
      padding:8px 8px;
      min-height:44px;              /* mobile touch target */
      border-radius:6px;
      border:1px solid rgba(255,255,255,0.25);
      background:rgba(0,0,0,0.5);
      color:var(--text);
      font-size:0.75rem;
      outline:none;
    }

    .manual-input:focus{
      border-color:var(--accent);
      box-shadow:0 0 4px var(--accent);
    }

    .valuation-comparison{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(150px,1fr));
      gap:6px;
      margin-top:8px;
      font-size:0.68rem;
    }

    .valuation-item{
      padding:6px;
      background:rgba(255,255,255,0.02);
      border-radius:8px;
      text-align:center;
    }

    .valuation-item.current{
      border:1px solid var(--red);
      background:rgba(255,96,112,0.05);
    }

    .valuation-title{
      font-weight:600;
      margin-bottom:2px;
    }

    .valuation-metric{margin:1px 0;}

    .valuation-outcome{
      margin-top:2px;
      color:var(--muted);
    }

    .insight-card{
      margin-top:6px;
      padding:6px 7px;
      border-radius:8px;
      background:linear-gradient(135deg,rgba(107,158,255,0.10),rgba(10,14,26,1));
      border:1px solid rgba(107,158,255,0.25);
      font-size:0.7rem;
    }

    .chart-container{margin-top:4px;}

    .history-grid{
      margin-top:6px;
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(160px,1fr));
      gap:5px;
      font-size:0.66rem;
    }

    .history-item{
      padding:5px;
      border-radius:8px;
      background:rgba(255,255,255,0.02);
    }

    .history-title{
      font-weight:600;
      margin-bottom:1px;
      font-size:0.7rem;
    }

    @media(max-width:900px){
      body{padding:14px 8px 26px;}
      .dashboard{grid-template-columns:1fr;}
      .main-content{grid-template-columns:1fr;}
      .sidebar{order:-1;}
    }
  </style>
</head>
<body>
<div class="container">
  <div class="header">
    <h1>âš¡ Economic Crash Radar Pro</h1>
    <div class="subtitle">
      9 indicators (8 auto from FRED, 1 manual) + 2 valuations. Transparent, deterministic logic.
    </div>
    <div class="meta-badges">
      <div class="badge" id="cache-badge">FRED cache: not loaded</div>
      <div class="badge">Manual: LEI, Buffett, CAPE</div>
      <div class="badge">Auto: Yield, HY, UMich, ISM, M2, Claims, Sahm, Permits</div>
      <div class="badge" id="inputs-badge">Inputs: 0/11 populated</div>
    </div>
  </div>

  <div class="alert-banner" id="alert-banner">
    Composite stress = 70% macro indicators + 30% valuations when both blocks have data.
  </div>

  <div class="dashboard">
    <!-- SIDEBAR -->
    <div class="sidebar">
      <div class="gauge-container">
        <div class="gauge">
          <div class="gauge-background"></div>
          <div class="gauge-center">
            <div class="gauge-score" id="composite-score">--</div>
            <div class="gauge-label" id="regime-label">COMPOSITE STRESS</div>
          </div>
          <div class="gauge-needle" id="needle"></div>
        </div>
        <div class="risk-meter">
          <div class="risk-bar">
            <div class="risk-fill" id="risk-fill"></div>
          </div>
          <div class="risk-labels">
            <span>Low (0-30)</span>
            <span>Med (30-50)</span>
            <span>High (50-70)</span>
            <span>Critical (70-100)</span>
          </div>
        </div>
      </div>
      <div class="status-grid">
        <div class="status-item">
          <div class="status-label">Recession Probability (12â€“18m)</div>
          <div class="status-value" id="recession-risk-display">--</div>
          <div class="indicator-threshold">Mapped from composite.</div>
        </div>
        <div class="status-item">
          <div class="status-label">Valuation Risk</div>
          <div class="status-value" id="valuation-risk-display">--</div>
          <div class="indicator-threshold">Buffett + CAPE combined.</div>
        </div>
        <div class="status-item">
          <div class="status-label">Labor Market Stress</div>
          <div class="status-value" id="labor-risk-display">--</div>
          <div class="indicator-threshold">Claims + Sahm.</div>
        </div>
        <div class="status-item">
          <div class="status-label">Data Coverage</div>
          <div class="status-value" id="quality-display">--</div>
          <div class="indicator-threshold">Filled indicators / total.</div>
        </div>
      </div>
    </div>

    <!-- MAIN -->
    <div class="main-content">
      <div class="card">
        <div class="card-title"><span class="icon">ðŸ“Š</span>Tier 1 Leading Indicators</div>
        <div class="indicator-grid" id="tier1-indicators"></div>
      </div>

      <div class="card">
        <div class="card-title"><span class="icon">ðŸ“ˆ</span>Tier 2 Confirming Indicators</div>
        <div class="indicator-grid" id="tier2-indicators"></div>
      </div>

      <div class="card">
        <div class="card-title"><span class="icon">ðŸ’°</span>Valuation Indicators</div>
        <div class="indicator-grid" id="valuation-indicators"></div>

        <div class="valuation-comparison">
          <div class="valuation-item">
            <div class="valuation-title">2000 Dot-com</div>
            <div class="valuation-metric">CAPE â‰ˆ 44</div>
            <div class="valuation-metric">Buffett â‰ˆ 140â€“160%</div>
            <div class="valuation-outcome">Severe drawdown.</div>
          </div>
          <div class="valuation-item">
            <div class="valuation-title">2007 Pre-GFC</div>
            <div class="valuation-metric">CAPE â‰ˆ 27</div>
            <div class="valuation-metric">Buffett â‰ˆ 105%</div>
            <div class="valuation-outcome">Crisis.</div>
          </div>
          <div class="valuation-item">
            <div class="valuation-title">2021 Peak</div>
            <div class="valuation-metric">CAPE â‰ˆ 38</div>
            <div class="valuation-metric">Buffett â‰ˆ 195%</div>
            <div class="valuation-outcome">2022 correction.</div>
          </div>
          <div class="valuation-item current">
            <div class="valuation-title">Current (your inputs)</div>
            <div class="valuation-metric" id="current-buffett-label">Buffett: --</div>
            <div class="valuation-metric" id="current-cape-label">CAPE: --</div>
            <div class="valuation-outcome">Reflects manual entries.</div>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="card-title"><span class="icon">ðŸ•’</span>History, Radar & Prior Recessions</div>
        <div class="chart-container">
          <canvas id="market-trend" height="130"></canvas>
        </div>
        <div class="chart-container">
          <canvas id="risk-radar" height="140"></canvas>
        </div>
        <div class="insight-card">
          <strong>Insight:</strong>
          <span id="insight-text">
            Once populated, this compares todayâ€™s configuration to prior stress regimes.
          </span>
        </div>
        <div class="history-grid">
          <div class="history-item">
            <div class="history-title">1973â€“75 / early 80s</div>
            <div>Curve inversion + energy shocks + weak leads.</div>
          </div>
          <div class="history-item">
            <div class="history-title">2000â€“02</div>
            <div>Extreme valuations, tightening, growth rollover.</div>
          </div>
          <div class="history-item">
            <div class="history-title">2007â€“09</div>
            <div>Housing + credit + inversion aligned.</div>
          </div>
          <div class="history-item">
            <div class="history-title">2020</div>
            <div>External shock; indicator behavior distinct.</div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
'use strict';

/**
 * Transparent configuration:
 * Leading indicators total weight = 0.62
 * Confirming indicators total weight = 0.28
 * Valuation block = 30% of final composite when present.
 */

const VALUATION_BLOCK_WEIGHT = 0.30;
let cacheAgeDays = null;

const INDICATORS = {
  LEI: {
    tier:1,
    label:'Conference Board LEI 6m %Î”',
    weight:0.18,
    threshold:-4.1,
    direction:'below',
    span:3.0,
    fromFred:false,
    fredId:null,
    current:null,
    format:v => v.toFixed(1) + '%',
    desc:'Manual quarterly input.'
  },
  YIELD_CURVE: {
    tier:1,
    label:'Yield Curve (10y-3m)',
    weight:0.12,
    threshold:0,
    direction:'below',
    span:1.0, // -1% inversion => 100 stress
    fromFred:true,
    fredId:'T10Y3M',
    current:null,
    format:v => v.toFixed(2) + '%',
    desc:'T10Y3M. 12â€“18m lead.'
  },
  CREDIT_SPREAD: {
    tier:1,
    label:'HY Credit Spread',
    weight:0.10,
    threshold:5.0,
    direction:'above',
    span:3.0, // 5%->8% => 100 stress
    fromFred:true,
    fredId:'BAMLH0A0HYM2',
    current:null,
    format:v => v.toFixed(2) + '%',
    desc:'BAMLH0A0HYM2. Credit stress.'
  },
  CONSUMER_SENTIMENT: {
    tier:1,
    label:'UMich Sentiment',
    weight:0.09,
    threshold:60,
    direction:'below',
    span:20, // 60->40 => 100 stress
    fromFred:true,
    fredId:'UMCSENT',
    current:null,
    format:v => v.toFixed(1),
    desc:'UMCSENT. Demand & confidence.'
  },
  ISM_NEW_ORDERS: {
    tier:1,
    label:'ISM New Orders',
    weight:0.07,
    threshold:47.5,
    direction:'below',
    span:5.0, // 47.5->42.5 => 100 stress
    fromFred:true,
    // Use NAPMNOI: documented FRED ID for ISM New Orders Index.  [oai_citation:0â€¡Social Science Computing Cooperative](https://www.ssc.wisc.edu/~bhansen/econometrics/FRED-MD_description.pdf?utm_source=chatgpt.com)
    fredId:'NAPMNOI',
    current:null,
    format:v => v.toFixed(1),
    desc:'ISM: New Orders Index.'
  },
  M2_GROWTH: {
    tier:1,
    label:'M2 Growth YoY',
    weight:0.06,
    threshold:4.0,
    direction:'below',
    span:5.0,
    fromFred:true,
    fredId:'M2SL',
    current:null,
    format:v => v.toFixed(1) + '%',
    desc:'YoY growth from M2SL. Liquidity regime.'
  },
  INITIAL_CLAIMS: {
    tier:2,
    label:'Initial Claims 4wk MA',
    weight:0.10,
    threshold:323,
    direction:'above',
    span:150, // +150k => 100 stress
    fromFred:true,
    fredId:'ICSA',
    current:null,
    format:v => Math.round(v) + 'k',
    desc:'4-week avg. Labor market turn.'
  },
  SAHM_RULE: {
    tier:2,
    label:'Sahm Rule',
    weight:0.10,
    threshold:0.50,
    direction:'above',
    span:1.0,
    fromFred:true,
    fredId:'SAHMREALTIME',
    current:null,
    format:v => v.toFixed(2),
    desc:'>= 0.5 is recession confirmation.'
  },
  BUILDING_PERMITS: {
    tier:2,
    label:'Building Permits 6m %Î”',
    weight:0.08,
    threshold:-15,
    direction:'below',
    span:15, // -15 -> -30 => 100 stress
    fromFred:true,
    fredId:'PERMIT',
    current:null,
    format:v => v.toFixed(1) + '%',
    desc:'6m change. Housing lead.'
  }
};

const VALUATIONS = {
  BUFFETT: {
    label:'Buffett Indicator (MktCap/GDP)',
    weight:0.50,
    danger:180,
    current:null,
    format:v => v.toFixed(1) + '%',
    desc:'Manual. Wilshire 5000 / GDP.'
  },
  SHILLER_PE: {
    label:'Shiller CAPE',
    weight:0.50,
    danger:30,
    current:null,
    format:v => v.toFixed(1),
    desc:'Manual. Long-term earnings multiple.'
  }
};

let charts = { trend:null, radar:null };
let compositeScore = null;

/**
 * Load FRED cache (data/fred_cache.json).
 * No hard-coded indicator values.
 */

async function loadFromFredCache(){
  try{
    const res = await fetch('data/fred_cache.json', { cache:'no-store' });
    if(!res.ok){
      console.error('FRED cache HTTP error', res.status);
      document.getElementById('cache-badge').textContent = 'FRED cache: not found';
      return;
    }

    const cache = await res.json();
    const series = cache.series || {};
    const gen = cache.generated_at || 'loaded';

    document.getElementById('cache-badge').textContent = 'FRED cache: ' + gen;

    // Cache age diagnostics (stale > 7 days)
    const genDate = new Date(gen);
    if(!isNaN(genDate)){
      const now = new Date();
      cacheAgeDays = (now - genDate) / (1000*60*60*24);
      if(cacheAgeDays < 0) cacheAgeDays = null; // bad clock, ignore
    }

    function lastVal(id){
      const s = series[id];
      if(!s) return null;
      // Support either {value,last_updated} OR full observations[]
      if(Array.isArray(s.observations) && s.observations.length){
        const o = s.observations[s.observations.length - 1];
        const v = Number(o.value);
        return Number.isFinite(v) ? v : null;
      }
      if(typeof s.value !== 'undefined'){
        const v = Number(s.value);
        return Number.isFinite(v) ? v : null;
      }
      return null;
    }

    function obsMonthsBack(id, months){
      const s = series[id];
      if(!s || !Array.isArray(s.observations) || !s.observations.length) return null;
      const last = s.observations[s.observations.length - 1];
      const lastDate = new Date(last.date);
      if(isNaN(lastDate)) return null;
      const target = new Date(lastDate);
      target.setMonth(target.getMonth() - months);
      let candidate = null;
      for(let i=0;i<s.observations.length;i++){
        const o = s.observations[i];
        const d = new Date(o.date);
        if(isNaN(d)) continue;
        if(d <= target) candidate = o; else break;
      }
      return candidate;
    }

    function rollingAvgLastN(id, n){
      const s = series[id];
      if(!s || !Array.isArray(s.observations) || s.observations.length < n) return null;
      const slice = s.observations.slice(-n);
      const vals = slice
        .map(o => Number(o.value))
        .filter(v => Number.isFinite(v));
      if(vals.length < n) return null;
      const sum = vals.reduce((a,b)=>a+b,0);
      return sum / n;
    }

    function pctChange(nv, ov){
      const n = Number(nv), o = Number(ov);
      if(!Number.isFinite(n) || !Number.isFinite(o) || o === 0) return null;
      return ((n - o) / o) * 100;
    }

    // Map FRED -> indicator.current
    Object.keys(INDICATORS).forEach(key => {
      const ind = INDICATORS[key];
      if(!ind.fromFred || !ind.fredId) return;

      if(ind.fredId === 'M2SL'){
        const lvlNow = lastVal('M2SL');
        const back = obsMonthsBack('M2SL', 12);
        if(lvlNow != null && back && back.value != null){
          const pc = pctChange(lvlNow, back.value);
          if(pc != null) ind.current = pc;
        }
      } else if(ind.fredId === 'ICSA'){
        const avg = rollingAvgLastN('ICSA', 4);
        if(avg != null) ind.current = avg / 1000; // thousands
      } else if(ind.fredId === 'PERMIT'){
        const now = lastVal('PERMIT');
        const back = obsMonthsBack('PERMIT', 6);
        if(now != null && back && back.value != null){
          const pc = pctChange(now, back.value);
          if(pc != null) ind.current = pc;
        }
      } else {
        const v = lastVal(ind.fredId);
        if(v != null) ind.current = v;
      }
    });

    // Diagnostics: which key FRED series are present
    const required = [
      'T10Y3M','BAMLH0A0HYM2','UMCSENT','NAPMNOI','M2SL',
      'ICSA','SAHMREALTIME','PERMIT'
    ];
    required.forEach(id => {
      const v = lastVal(id);
      if(v != null){
        console.log(`âœ… ${id} loaded from fred_cache.json:`, v);
      } else {
        console.warn(`âš ï¸ ${id} missing or invalid in fred_cache.json`);
      }
    });

  }catch(err){
    console.error('FRED cache error:', err);
    document.getElementById('cache-badge').textContent = 'FRED cache: error';
  }
}

/**
 * Scale indicator values to 0â€“100 stress.
 * By construction: crossing threshold = >0; 1 span beyond = 100.
 */

function scaleIndicator(key, value){
  const ind = INDICATORS[key];
  if(!ind || !Number.isFinite(value)) return null;

  const t = ind.threshold;
  const dir = ind.direction;
  const span = (ind.span && ind.span > 0)
    ? ind.span
    : Math.max(1, Math.abs(t) * 0.5);

  let stress = 0;

  if(dir === 'below'){
    if(value < t){
      stress = ((t - value) / span) * 100;
    }
  } else if(dir === 'above'){
    if(value > t){
      stress = ((value - t) / span) * 100;
    }
  }

  if(stress < 0) stress = 0;
  if(stress > 100) stress = 100;
  return stress;
}

/**
 * Valuation stress.
 * (ratio - 1) * 300 => 20% above danger â‰ˆ 60, 33% â‰ˆ 100.
 * Clamped 0â€“100.
 */

function valuationStress(key, val){
  const v = VALUATIONS[key];
  if(!v || !Number.isFinite(val)) return null;
  if(val <= v.danger) return 0;
  const ratio = val / v.danger;
  let stress = (ratio - 1) * 300;
  if(stress < 0) stress = 0;
  if(stress > 100) stress = 100;
  return stress;
}

/**
 * Composite:
 * - Macro block = weighted average of all available indicator stresses.
 * - Val block = weighted average of valuation stresses.
 * - Final = 70% macro + 30% val when both exist.
 * Console logs expose every contribution.
 */

function computeComposite(){
  let mSum = 0, mW = 0;
  Object.entries(INDICATORS).forEach(([k,ind]) => {
    const s = scaleIndicator(k, ind.current);
    if(s != null && ind.weight){
      const contrib = s * ind.weight;
      mSum += contrib;
      mW   += ind.weight;
      console.log(`Indicator ${k}: value=${ind.current}, stress=${s.toFixed(1)}, weight=${ind.weight}, contrib=${contrib.toFixed(2)}`);
    } else {
      console.log(`Indicator ${k}: missing or unweighted. value=${ind.current}`);
    }
  });
  const macroAvg = mW > 0 ? (mSum / mW) : null;
  if(macroAvg != null) console.log(`Macro block avg=${macroAvg.toFixed(2)}`);

  let vSum = 0, vW = 0;
  Object.entries(VALUATIONS).forEach(([k,v]) => {
    const s = valuationStress(k, v.current);
    if(s != null && v.weight){
      const contrib = s * v.weight;
      vSum += contrib;
      vW   += v.weight;
      console.log(`Valuation ${k}: value=${v.current}, stress=${s.toFixed(1)}, weight=${v.weight}, contrib=${contrib.toFixed(2)}`);
    }
  });
  const valAvg = vW > 0 ? (vSum / vW) : null;
  if(valAvg != null) console.log(`Valuation block avg=${valAvg.toFixed(2)}`);

  let composite = null;
  if(macroAvg != null && valAvg != null){
    composite = macroAvg * (1 - VALUATION_BLOCK_WEIGHT) + valAvg * VALUATION_BLOCK_WEIGHT;
  }else if(macroAvg != null){
    composite = macroAvg;
  }else if(valAvg != null){
    composite = valAvg;
  }

  if(composite != null) console.log(`Composite=${composite.toFixed(2)}`);
  return composite;
}

/**
 * Derived labels.
 */

function derivedRecessionRisk(c){
  if(c == null) return '--';
  if(c < 25) return '<10%';
  if(c < 40) return '10â€“20%';
  if(c < 55) return '20â€“30%';
  if(c < 70) return '30â€“50%';
  return '>50%';
}

function derivedValuationRisk(){
  let sum = 0, w = 0;
  Object.entries(VALUATIONS).forEach(([k,v]) => {
    const s = valuationStress(k, v.current);
    if(s != null && v.weight){
      sum += s * v.weight;
      w   += v.weight;
    }
  });
  if(!w) return '--';
  const sc = Math.round(sum / w);
  if(sc < 33) return 'Low';
  if(sc < 66) return 'Moderate';
  return 'High';
}

function derivedLaborStress(){
  const c = INDICATORS.INITIAL_CLAIMS.current;
  const s = INDICATORS.SAHM_RULE.current;
  if(!Number.isFinite(c) || !Number.isFinite(s)) return '--';

  // Claims above ~250k and Sahm above 0 raise stress.
  const cs = Math.max(0, Math.min(100, (c - 250) * 0.5));
  const ss = Math.max(0, Math.min(100, s * 200));
  const avg = (cs + ss) / 2;

  if(avg < 30) return 'Low';
  if(avg < 60) return 'Moderate';
  return 'High';
}

/**
 * Indicator cards.
 */

function buildIndicatorElement(key, ind){
  const s = scaleIndicator(key, ind.current);
  let cls = 'indicator';
  if(s != null){
    if(s >= 66) cls += ' danger';
    else if(s >= 33) cls += ' warning';
  }
  const hasVal = Number.isFinite(ind.current);
  const valText = hasVal ? ind.format(ind.current) : '--';

  const thrText = (ind.threshold != null && ind.format)
    ? 'Threshold: ' + (ind.direction === 'below' ? '< ' : '> ') + ind.format(ind.threshold)
    : '';

  const src = ind.fromFred ? 'Auto from FRED' : 'Manual input';

  let manual = '';
  if(!ind.fromFred){
    manual =
      '<div class="manual-input-row">' +
        '<span>Set (e.g. latest 6m %Î” LEI):</span>' +
        '<input class="manual-input" type="number" step="0.1" ' +
        'data-ind-key="'+key+'" value="'+(hasVal ? ind.current : '')+'">' +
      '</div>';
  }

  const div = document.createElement('div');
  div.className = cls;
  div.setAttribute('data-ind-card', key);
  div.innerHTML =
    '<div class="indicator-header">' +
      '<div class="indicator-name">'+ind.label+'</div>' +
      '<div class="indicator-value" data-ind-value="'+key+'">'+valText+'</div>' +
    '</div>' +
    '<div class="indicator-threshold">'+thrText+'</div>' +
    '<div class="indicator-threshold">'+ind.desc+'</div>' +
    '<div class="source-tag">'+src+'</div>' +
    manual;
  return div;
}

function renderIndicators(){
  const t1 = document.getElementById('tier1-indicators');
  const t2 = document.getElementById('tier2-indicators');
  t1.innerHTML = '';
  t2.innerHTML = '';

  Object.entries(INDICATORS).forEach(([k,ind]) => {
    const el = buildIndicatorElement(k, ind);
    if(ind.tier === 1) t1.appendChild(el);
    else t2.appendChild(el);
  });

  // Manual LEI input.
  document.querySelectorAll('.manual-input[data-ind-key]').forEach(inp => {
    inp.addEventListener('input', () => {
      const key = inp.getAttribute('data-ind-key');
      const v = parseFloat(inp.value);
      INDICATORS[key].current = Number.isFinite(v) ? v : null;

      const valEl = document.querySelector('[data-ind-value="'+key+'"]');
      if(valEl){
        valEl.textContent = Number.isFinite(v)
          ? INDICATORS[key].format(v)
          : '--';
      }
      updateDynamic();
    });
  });
}

/**
 * Valuation cards.
 */

function renderValuations(){
  const box = document.getElementById('valuation-indicators');
  box.innerHTML = '';

  Object.entries(VALUATIONS).forEach(([k,v]) => {
    const s = valuationStress(k, v.current);
    let cls = 'indicator';
    if(s != null){
      if(s >= 66) cls += ' danger';
      else if(s >= 33) cls += ' warning';
    }
    const hasVal = Number.isFinite(v.current);
    const valText = hasVal ? v.format(v.current) : '--';

    const div = document.createElement('div');
    div.className = cls;
    div.setAttribute('data-val-card', k);
    div.innerHTML =
      '<div class="indicator-header">' +
        '<div class="indicator-name">'+v.label+'</div>' +
        '<div class="indicator-value" data-val-value="'+k+'">'+valText+'</div>' +
      '</div>' +
      '<div class="indicator-threshold">Danger threshold: '+v.danger+'</div>' +
      '<div class="indicator-threshold">'+v.desc+'</div>' +
      '<div class="source-tag">Manual input</div>' +
      '<div class="manual-input-row">' +
        '<span>Set (current reading):</span>' +
        '<input class="manual-input" type="number" step="0.1" ' +
        'data-val-key="'+k+'" value="'+(hasVal ? v.current : '')+'">' +
      '</div>';
    box.appendChild(div);
  });

  // Manual valuation inputs.
  document.querySelectorAll('.manual-input[data-val-key]').forEach(inp => {
    inp.addEventListener('input', () => {
      const key = inp.getAttribute('data-val-key');
      const v = parseFloat(inp.value);
      VALUATIONS[key].current = Number.isFinite(v) ? v : null;

      const valEl = document.querySelector('[data-val-value="'+key+'"]');
      if(valEl){
        valEl.textContent = Number.isFinite(v)
          ? VALUATIONS[key].format(v)
          : '--';
      }
      updateDynamic();
    });
  });
}

/**
 * Sync "Current (your inputs)" valuation tile.
 */

function syncValuationCurrentBox(){
  const b = VALUATIONS.BUFFETT.current;
  const c = VALUATIONS.SHILLER_PE.current;
  const bEl = document.getElementById('current-buffett-label');
  const cEl = document.getElementById('current-cape-label');

  if(bEl){
    bEl.textContent = Number.isFinite(b)
      ? ('Buffett: ' + b.toFixed(1) + '%')
      : 'Buffett: --';
  }
  if(cEl){
    cEl.textContent = Number.isFinite(c)
      ? ('CAPE: ' + c.toFixed(1))
      : 'CAPE: --';
  }
}

/**
 * Gauge, coverage, messaging.
 */

function renderGaugeAndStatus(){
  compositeScore = computeComposite();

  const scoreEl = document.getElementById('composite-score');
  const needle = document.getElementById('needle');
  const fill = document.getElementById('risk-fill');
  const regimeEl = document.getElementById('regime-label');
  const alert = document.getElementById('alert-banner');

  const total = Object.keys(INDICATORS).length + Object.keys(VALUATIONS).length;
  const used =
    Object.keys(INDICATORS).filter(k => Number.isFinite(INDICATORS[k].current)).length +
    Object.keys(VALUATIONS).filter(k => Number.isFinite(VALUATIONS[k].current)).length;

  const coverage = total ? (used / total) : 0;
  document.getElementById('inputs-badge').textContent =
    'Inputs: ' + used + '/' + total + ' populated';
  document.getElementById('quality-display').textContent =
    total ? Math.round(coverage * 100) + '%' : '--';

  if(compositeScore == null){
    scoreEl.textContent = '--';
    fill.style.width = '0%';
    needle.style.transform = 'translateX(-50%) rotate(0deg)';
    regimeEl.textContent = 'COMPOSITE STRESS â€” insufficient data';
    document.getElementById('recession-risk-display').textContent = '--';
    document.getElementById('valuation-risk-display').textContent = '--';
    document.getElementById('labor-risk-display').textContent = '--';

    let msg = 'No composite yet. Check FRED cache and manual LEI / valuation inputs.';
    if(cacheAgeDays != null && cacheAgeDays > 7){
      msg = 'Data warning: FRED cache is ' + cacheAgeDays.toFixed(1) +
            ' days old. Update fred_cache.json. ' + msg;
    }
    alert.textContent = msg;
    return;
  }

  const v = Math.round(compositeScore);
  scoreEl.textContent = v;
  fill.style.width = v + '%';
  const angle = (v / 100) * 360;        // 0â€“100 -> 0â€“360 degrees
  needle.style.transform = 'translateX(-50%) rotate(' + angle + 'deg)';

  let regime;
  if(v <= 30) regime = 'Low stress regime';
  else if(v <= 50) regime = 'Elevated â€” monitor';
  else if(v <= 70) regime = 'High â€” defensive bias';
  else regime = 'Critical regime';

  regimeEl.textContent = 'COMPOSITE STRESS â€” ' + regime;

  document.getElementById('recession-risk-display').textContent =
    derivedRecessionRisk(v);
  document.getElementById('valuation-risk-display').textContent =
    derivedValuationRisk();
  document.getElementById('labor-risk-display').textContent =
    derivedLaborStress();

  // Alert text with data quality overlays.
  let prefix = '';
  if(cacheAgeDays != null && cacheAgeDays > 7){
    prefix += 'Data warning: FRED cache is ' + cacheAgeDays.toFixed(1) +
              ' days old. Update fred_cache.json. ';
  }
  if(coverage < 0.8){
    prefix += 'Coverage below 80%. Treat composite as tentative. ';
  }

  if(v >= 70){
    alert.innerHTML = prefix + '<strong>Critical:</strong> Composite = ' + v +
      '. Macro + valuations in historical danger cluster.';
  }else if(v >= 50){
    alert.innerHTML = prefix + '<strong>Warning:</strong> Composite = ' + v +
      '. Elevated risk â€” inspect indicator tiles.';
  }else{
    alert.textContent = prefix +
      'Composite = ' + v +
      '. Configuration not in the classic crash cluster based on your inputs; always cross-check.';
  }
}

/**
 * Charts (illustrative, driven by current composite / valuation stresses).
 */

function renderMarketTrendChart(){
  const ctx = document.getElementById('market-trend').getContext('2d');
  if(charts.trend) charts.trend.destroy();

  const base = compositeScore != null ? compositeScore : 40;
  const labels = ['T-10','T-8','T-6','T-4','T-2','Now'];
  const compData = [0.7,0.8,0.9,0.95,0.98,1].map(f => {
    let x = base * f;
    if(x < 0) x = 0;
    if(x > 100) x = 100;
    return Math.round(x);
  });

  let vSum = 0, vW = 0;
  Object.entries(VALUATIONS).forEach(([k,v]) => {
    const s = valuationStress(k, v.current);
    if(s != null && v.weight){
      vSum += s * v.weight;
      vW   += v.weight;
    }
  });
  const valBase = vW ? (vSum / vW) : 30;
  const valData = [0.75,0.85,0.92,0.96,0.99,1].map(f => {
    let x = valBase * f;
    if(x < 0) x = 0;
    if(x > 100) x = 100;
    return Math.round(x);
  });

  charts.trend = new Chart(ctx, {
    type:'line',
    data:{
      labels,
      datasets:[
        {
          label:'Composite Stress',
          data:compData,
          borderColor:'#6b9eff',
          backgroundColor:'rgba(107,158,255,0.14)',
          tension:0.32,
          fill:true,
          pointRadius:2
        },
        {
          label:'Valuation Stress',
          data:valData,
          borderColor:'#ff6070',
          backgroundColor:'rgba(255,96,112,0.12)',
          tension:0.32,
          fill:true,
          pointRadius:2
        }
      ]
    },
    options:{
      responsive:true,
      plugins:{
        legend:{labels:{color:'#e8eeff',font:{size:9}}},
        title:{
          display:true,
          text:'Stress & Valuation Trajectory (Illustrative)',
          color:'#e8eeff',
          font:{size:11}
        }
      },
      scales:{
        y:{
          min:0,
          max:100,
          ticks:{color:'#8b96b0',font:{size:8}},
          grid:{color:'rgba(255,255,255,0.08)'}
        },
        x:{
          ticks:{color:'#8b96b0',font:{size:8}},
          grid:{color:'rgba(255,255,255,0.06)'}
        }
      }
    }
  });
}

function renderRiskRadarChart(){
  const ctx = document.getElementById('risk-radar').getContext('2d');
  if(charts.radar) charts.radar.destroy();

  const labels = [];
  const data = [];

  Object.entries(INDICATORS).forEach(([k,ind]) => {
    const s = scaleIndicator(k, ind.current);
    if(s != null){
      labels.push(ind.label);
      data.push(Math.round(s));
    }
  });

  let vSum = 0, vW = 0;
  Object.entries(VALUATIONS).forEach(([k,v]) => {
    const s = valuationStress(k, v.current);
    if(s != null && v.weight){
      vSum += s * v.weight;
      vW   += v.weight;
    }
  });
  if(vW){
    labels.push('Valuations (Buffett + CAPE)');
    data.push(Math.round(vSum / vW));
  }

  if(!labels.length) return;

  charts.radar = new Chart(ctx, {
    type:'radar',
    data:{
      labels,
      datasets:[{
        label:'Normalized Stress (0â€“100)',
        data,
        borderColor:'#6b9eff',
        backgroundColor:'rgba(107,158,255,0.18)',
        pointRadius:2
      }]
    },
    options:{
      responsive:true,
      plugins:{legend:{display:false}},
      scales:{
        r:{
          angleLines:{color:'rgba(255,255,255,0.05)'},
          grid:{color:'rgba(255,255,255,0.09)'},
          suggestedMin:0,
          suggestedMax:100,
          ticks:{display:false},
          pointLabels:{color:'#8b96b0',font:{size:7}}
        }
      }
    }
  });
}

/**
 * Insight text.
 */

function updateInsight(){
  const el = document.getElementById('insight-text');
  if(!el) return;
  const c = compositeScore;
  const vRisk = derivedValuationRisk();

  if(c == null){
    el.textContent = 'No composite yet. Ensure fred_cache.json is present, fresh (<7 days), and LEI/Buffett/CAPE are populated.';
  } else if(c >= 70 && vRisk === 'High'){
    el.textContent = 'Macro and valuations both extreme â€” historically associated with major drawdowns.';
  } else if(c >= 50 && vRisk !== 'Low'){
    el.textContent = 'Elevated macro stress with stretched valuations â€” asymmetry poor.';
  } else if(c < 40 && vRisk === 'High'){
    el.textContent = 'Macro reasonable but valuations rich â€” vulnerable to shocks and policy errors.';
  } else if(c < 40 && vRisk === 'Low'){
    el.textContent = 'Macro and valuations both moderate vs history â€” no classic crash cluster.';
  } else {
    el.textContent = 'Mixed configuration. Use radar and tiles to see which levers are driving risk.';
  }
}

/**
 * Update orchestrator.
 */

function updateDynamic(){
  renderGaugeAndStatus();
  renderMarketTrendChart();
  renderRiskRadarChart();
  syncValuationCurrentBox();
  updateInsight();
}

function updateAll(){
  renderIndicators();
  renderValuations();
  updateDynamic();
}

/**
 * Init.
 */

document.addEventListener('DOMContentLoaded', () => {
  loadFromFredCache()
    .then(updateAll)
    .catch(err => {
      console.error('Init error:', err);
      updateAll();
    });
});
</script>
</body>
</html>
