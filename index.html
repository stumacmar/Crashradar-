<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="description" content="CrashRadar monitors financial market crash risk using multiple economic indicators including yield curve, credit spreads, unemployment, and market drawdowns." />
  <title>CrashRadar — Composite Crash Risk Dashboard</title>

  <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
  <link rel="dns-prefetch" href="https://cdn.jsdelivr.net">

  <style>
    :root{
      --bg:#0f1421; --panel:#161c2e; --muted:#9aa6bf; --text:#e8eeff; --accent:#7da6ff;
      --green:#1ec28b; --amber:#ffc247; --red:#ff6070; --radius:16px; --t:all .2s ease;
      --ring-size: 180px; --ring-size-mobile: 140px;
    }
    *{box-sizing:border-box}
    html,body{margin:0;background:var(--bg);color:var(--text);font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Inter,Helvetica,Arial}
    :focus{outline:2px solid var(--accent);outline-offset:2px}
    :focus:not(:focus-visible){outline:none}
    .wrap{max-width:980px;margin:0 auto;padding:20px 16px 64px}
    h1{font-size:clamp(28px,5.5vw,44px);line-height:1.1;margin:0 0 8px}
    .sub{color:var(--muted);margin:6px 0 18px;font-size:14px}
    .ok{color:var(--green)} .warn{color:var(--amber)} .bad{color:var(--red)}
    .card{background:var(--panel);border-radius:var(--radius);padding:20px;margin:16px 0;box-shadow:0 0 0 1px rgba(255,255,255,.03) inset;transition:var(--t)}
    .card:hover{box-shadow:0 0 0 1px rgba(125,166,255,.1) inset}
    .pill{display:inline-flex;align-items:center;background:#13192a;border:1px solid #1f2740;color:var(--text);padding:8px 12px;border-radius:999px;font-weight:600;margin:6px 8px 0 0;transition:var(--t);cursor:help}
    .pill:hover{border-color:var(--accent);transform:translateY(-1px)}
    .meta{color:var(--muted);font-size:13px}
    .gauge{display:flex;align-items:center;gap:24px;flex-wrap:wrap}
    .ringwrap{position:relative;width:var(--ring-size);height:var(--ring-size);flex-shrink:0}
    .ring{position:absolute;inset:0;border-radius:50%;isolation:isolate;z-index:0;
      background:conic-gradient(var(--green) 0deg 120deg, var(--amber) 120deg 216deg, var(--red) 216deg 360deg)}
    .ring::after{content:"";position:absolute;inset:20px;border-radius:50%;background:var(--panel);z-index:0}
    .score{position:absolute;inset:0;display:grid;place-items:center;font-weight:800;font-size:36px;z-index:2}
    .badge{display:inline-flex;align-items:center;padding:6px 12px;border-radius:10px;font-weight:800;letter-spacing:.4px;margin-left:12px}
    .badge.green{background:rgba(30,194,139,.15);color:var(--green);border:1px solid rgba(30,194,139,.35)}
    .badge.amber{background:rgba(255,194,71,.15);color:var(--amber);border:1px solid rgba(255,194,71,.35)}
    .badge.red{background:rgba(255,96,112,.17);color:var(--red);border:1px solid rgba(255,96,112,.35)}
    .callout{font-size:14px;color:var(--muted);line-height:1.4}
    .chart{position:relative;height:300px}
    canvas{width:100%!important;height:100%!important}
    .foot{margin-top:24px}
    .err{background:#2b1620;color:#ffdbe0;border:1px solid #57313f;padding:12px;border-radius:10px}
    .skeleton{background:linear-gradient(90deg, #161c2e 25%, #1a2238 50%, #161c2e 75%);background-size:200% 100%;animation:loading 1.5s infinite}
    @keyframes loading{0%{background-position:200% 0}100%{background-position:-200% 0}}
    .tooltip{position:relative;cursor:help;border-bottom:1px dotted var(--muted)}
    .tooltip:hover::after{content:attr(data-tooltip);position:absolute;bottom:100%;left:50%;transform:translateX(-50%);background:rgba(0,0,0,0.9);color:white;padding:8px 12px;border-radius:6px;font-size:12px;white-space:nowrap;z-index:1000}
    .risk-explanation{margin-top:12px;padding:12px;background:rgba(255,255,255,0.03);border-radius:8px;border-left:3px solid var(--accent)}
    @media (max-width:768px){
      .gauge{justify-content:center;text-align:center}
      .ringwrap{width:var(--ring-size-mobile);height:var(--ring-size-mobile)}
      .score{font-size:28px}
    }
    @media (max-width:480px){
      .card{padding:16px}
      .pill{display:block;margin:6px 0;width:100%}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header role="banner">
      <h1>CrashRadar — Composite Crash Risk</h1>
      <div id="status" class="sub" aria-live="polite">Loading market data…</div>
    </header>

    <main role="main">
      <section aria-labelledby="composite-heading" class="card">
        <div class="gauge">
          <div class="ringwrap" aria-hidden="true">
            <div class="ring"></div>
            <div id="scoreText" class="score">–</div>
          </div>
          <div>
            <h2 id="composite-heading" style="margin:0 0 6px;font-size:26px">
              Composite Score <span id="garBadge" class="badge">—</span>
            </h2>
            <div class="callout">
              Lower scores indicate safer conditions.
              Risk thresholds: <b class="ok">Green ≤ 30</b>, <b class="warn">Amber ≤ 60</b>, <b class="bad">Red &gt; 60</b>.
            </div>
            <div class="meta" id="freshness" style="margin-top:8px">—</div>
            <div id="riskExplanation" class="risk-explanation" style="display:none">
              <strong id="riskTitle">Risk Assessment</strong>
              <div id="riskDescription" class="meta" style="margin-top:4px"></div>
            </div>
            <div style="margin-top:16px" role="list">
              <span class="pill" id="pill_t10y3m" role="listitem" data-tooltip="10-year minus 3-month Treasury yield spread">Yield (10y–3m): —</span>
              <span class="pill" id="pill_credit" role="listitem" data-tooltip="BAA corporate bond yield minus AAA yield">Credit (BAA–AAA): —</span>
              <span class="pill" id="pill_un" role="listitem" data-tooltip="6-month change in unemployment rate">Unemp Δ6m: —</span>
              <span class="pill" id="pill_dd" role="listitem" data-tooltip="S&P 500 drawdown from 12-month high">Drawdown 12m: —</span>
              <span class="pill" id="pill_nfci" role="listitem" data-tooltip="National Financial Conditions Index">NFCI: —</span>
            </div>
          </div>
        </div>
      </section>

      <section aria-labelledby="composite-chart-heading" class="card">
        <h3 id="composite-chart-heading" style="margin:0 0 8px">Composite Risk History (normalised 0–100)</h3>
        <div class="meta">Legend: <span class="ok">●</span> Green &nbsp; <span class="warn">●</span> Amber &nbsp; <span class="bad">●</span> Red</div>
        <div class="chart"><canvas id="compChart" aria-label="Composite risk score over time"></canvas></div>
        <div class="callout">Composite (30-day rolling average). Smoothed view of overall risk using recent readings.</div>
      </section>

      <div id="charts"></div>
    </main>

    <footer class="card foot" role="contentinfo">
      <h3 style="margin:0 0 12px;">Data & Diagnostics</h3>
      <details>
        <summary style="cursor:pointer;margin-bottom:8px;font-weight:600;">Technical Details</summary>
        <pre id="diag" style="white-space:pre-wrap;word-break:break-word;color:#ffdca8;background:#241d12;border:1px solid #4a3e20;border-radius:10px;padding:12px;max-height:420px;overflow:auto;margin:0;font-size:12px;"></pre>
      </details>
      <div class="meta" style="margin-top:12px;">Data sourced from FRED. Last updated: <span id="update-time">—</span></div>
    </footer>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3.1.1/dist/chartjs-plugin-annotation.min.js"></script>

  <script>
  class CrashRadar {
    constructor(){
      this.keys = ['T10Y3M','CREDIT','UN_SLOPE6','DD_12M','NFCI'];

      // NEW: composite modes (actionable by default)
      this.MODES = { STRICT:'strict', ASOF:'asof' };
      this.mode = this.MODES.ASOF;

      this.scales = {
        T10Y3M: v => this.clamp(this.map(v, 1.0, -2.0)),
        CREDIT: v => this.clamp(this.map(v, 0.3, 1.0)),
        UN_SLOPE6: v => this.clamp(this.map(v, 0.0, 0.6)),
        DD_12M: v => this.clamp(this.map(v, 0.0, -0.30)),
        NFCI: v => this.clamp(this.map(v, -0.8, 1.0)),
      };
      this.weights = {T10Y3M:0.25, CREDIT:0.25, UN_SLOPE6:0.20, DD_12M:0.20, NFCI:0.10};

      this.data = {
        raw:null,
        series:{},         // { key: { xs, ys, datesISO } }
        latest:{},         // { key: number }
        latestISO:{},      // { key: 'YYYY-MM-DD' }
        freshness:{},      // { key: { ageDays, latestISO } }
        commonISO:null,    // latest ISO date common to all series
        composite:null,    // current mode
        composite_strict:null
      };
      this.charts = new Map();
      this.init();
    }

    /* ---------- utils ---------- */
    setStatus(msg, cls=''){ const el=document.getElementById('status'); el.textContent=msg; el.className='sub '+cls; }
    gbDate(d){ try{return new Date(d).toLocaleDateString('en-GB',{year:'numeric',month:'short',day:'2-digit'})}catch{return 'Invalid Date'} }
    safeNum(v){ return (v===null||v===undefined||isNaN(+v))?null:+v; }
    last(a){ return (a&&a.length)?a[a.length-1]:null; }
    clamp(x){ return Math.max(0, Math.min(100,x)); }
    map(val, good, bad){ if(val==null) return 50; const denom=bad-good; if(Math.abs(denom)<1e-10) return 50; return ((val-good)/denom)*100; }
    zoneOf(s){ return s<=30?'green':(s<=60?'amber':'red'); }
    toISO(d){ return new Date(d).toISOString().slice(0,10); }
    daysBetween(aISO,bISO){ const a=new Date(aISO+"T00:00:00Z"), b=new Date(bISO+"T00:00:00Z"); return Math.round((b-a)/86400000); }

    getRiskExplanation(score, zone){
      const x={
        green:{title:'Low Risk Environment',description:'Market conditions look benign. Indicators show limited stress.'},
        amber:{title:'Moderate Risk Environment',description:'Some stress signals are active. Monitor for further deterioration.'},
        red:{title:'High Risk Environment',description:'Multiple stress signals. Risk of turbulence/contracting conditions is elevated.'}
      }; return x[zone]||x.green;
    }

    async init(){
      this.setStatus('Loading market data…');
      document.querySelectorAll('.pill, .score, .badge').forEach(el=>el.classList.add('skeleton'));
      try{
        const controller=new AbortController(); const t=setTimeout(()=>controller.abort(),10000);
        const res=await fetch('data/fred_cache.json',{cache:'no-cache',signal:controller.signal}); clearTimeout(t);
        if(!res.ok) throw new Error(`HTTP ${res.status}: ${res.statusText}`);
        this.data.raw=await res.json(); this.setStatus('Market data loaded successfully','ok');
        this.process(); this.render();
      }catch(e){
        this.setStatus(e.name==='AbortError'?'Request timeout — please try again':'Failed to load data','bad');
        document.getElementById('diag').textContent='Load error: '+e.message;
        const card=document.querySelector('.gauge').closest('.card');
        card.insertAdjacentHTML('beforeend',`<div class="err" style="margin-top:16px"><strong>Unable to load market data</strong><div style="margin-top:8px;font-size:14px">Check connection or run the workflow to build <code>data/fred_cache.json</code>.</div></div>`);
      }
    }

    /* ---------- ingest + dates ---------- */
    process(){
      const S=this.data.raw?.series||{};
      const dateSets=[];

      for(const k of this.keys){
        const obs=S[k]?.observations||[], xs=[], ys=[], iso=[];
        for(const o of obs){
          const v=this.safeNum(o.value); if(v==null||!o.date) continue;
          const dISO=this.toISO(o.date); iso.push(dISO);
          xs.push(this.gbDate(dISO)); ys.push(v);
        }
        this.data.series[k]={xs,ys,datesISO:iso};
        this.data.latest[k]=this.last(ys);
        this.data.latestISO[k]=this.last(iso);
        dateSets.push(new Set(iso));
      }

      // latest common ISO across all series
      const shortest = this.keys.slice().sort((a,b)=>(
        this.data.series[a].datesISO.length - this.data.series[b].datesISO.length
      ))[0];
      let common=null;
      for(let i=this.data.series[shortest].datesISO.length-1;i>=0;i--){
        const d=this.data.series[shortest].datesISO[i];
        if(this.keys.every((k,idx)=>dateSets[idx].has(d))){ common=d; break; }
      }
      this.data.commonISO=common;

      // freshness ages vs today
      const todayISO=this.toISO(new Date());
      for(const k of this.keys){
        const d=this.data.latestISO[k];
        const age=(d? this.daysBetween(d,todayISO) : null);
        this.data.freshness[k]={ageDays:age, latestISO:d};
      }

      // composites
      this.data.composite_strict = this.computeComposite(this.MODES.STRICT);
      this.data.composite = this.computeComposite(this.mode);
    }

    computeComposite(mode){
      let num=0, denom=0;

      if(mode===this.MODES.STRICT){
        if(!this.data.commonISO) return null;
        const d=this.data.commonISO;
        for(const k of this.keys){
          const idx=this.data.series[k].datesISO.lastIndexOf(d);
          if(idx===-1) return null;
          const val=this.data.series[k].ys[idx];
          const scaled=this.scales[k](val);
          if(isFinite(scaled)){ num+=scaled*(this.weights[k]||0); denom+=(this.weights[k]||0); }
        }
      } else { // AS-OF (actionable)
        const todayISO=this.toISO(new Date());
        for(const k of this.keys){
          const val=this.data.latest[k];
          const scaled=this.scales[k](val);
          if(!isFinite(scaled)) continue;
          const age=this.data.freshness[k].ageDays ?? 99;
          // freshness: <=1d → 1.0, 7+d → 0.4
          const freshness=Math.max(0.4, Math.min(1, 1 - (age/7)));
          const w=(this.weights[k]||0)*freshness;
          num+=scaled*w; denom+=w;
        }
      }
      if(denom===0) return null;
      return Math.round((num/denom)*10)/10;
    }

    /* ---------- render ---------- */
    render(){
      this.renderGauge(); this.renderPills(); this.renderCompositeChart(); this.renderIndicatorCharts(); this.renderDiagnostics();
    }

    renderGauge(){
      const c=this.data.composite, z=this.zoneOf(c??50);
      const badge=document.getElementById('garBadge');
      const modeLabel=(this.mode===this.MODES.STRICT?'STRICT':'AS-OF TODAY');
      badge.className='badge '+z;
      badge.textContent=`${modeLabel} · ${z.toUpperCase()}`;
      badge.classList.remove('skeleton');

      const scoreEl=document.getElementById('scoreText');
      scoreEl.textContent=isFinite(c)?Math.round(c):'–';
      scoreEl.classList.remove('skeleton');

      const ts=this.data.raw?.fetched_at_utc?new Date(this.data.raw.fetched_at_utc):null;
      const commonTxt=this.data.commonISO?`Data through (STRICT): ${this.gbDate(this.data.commonISO)}`:'Data through (STRICT): —';
      const fetchedTxt=ts? `${this.gbDate(this.toISO(ts))} ${ts.toLocaleTimeString('en-GB',{hour:'2-digit',minute:'2-digit'})}` : '—';
      document.getElementById('freshness').textContent=
        `${commonTxt} • Cache built: ${fetchedTxt} • FRED posts with ~1 business-day lag`;

      const ex=this.getRiskExplanation(c??50,z);
      const riskEl=document.getElementById('riskExplanation');
      document.getElementById('riskTitle').textContent=ex.title;
      document.getElementById('riskDescription').textContent=ex.description;
      riskEl.style.display='block';

      // warn if any series is stale (≥7d)
      const stale=this.keys.filter(k=> (this.data.freshness[k].ageDays??0) >= 7);
      if(stale.length){ this.setStatus(`Market data loaded (note: ${stale.length} series ≥7d old)`, 'warn'); }
      else{ this.setStatus('Market data loaded successfully','ok'); }
    }

    renderPills(){
      const id={T10Y3M:'pill_t10y3m',CREDIT:'pill_credit',UN_SLOPE6:'pill_un',DD_12M:'pill_dd',NFCI:'pill_nfci'};
      const label={T10Y3M:'Yield (10y–3m)',CREDIT:'Credit (BAA–AAA)',UN_SLOPE6:'Unemp Δ6m',DD_12M:'Drawdown 12m',NFCI:'NFCI'};
      const fmt={T10Y3M:v=>v.toFixed(2),CREDIT:v=>v.toFixed(2),UN_SLOPE6:v=>v.toFixed(2),DD_12M:v=>(v*100).toFixed(1)+'%',NFCI:v=>v.toFixed(3)};
      for(const k of this.keys){
        const el=document.getElementById(id[k]); if(!el) continue;
        const v=this.data.latest[k];
        const d=this.data.freshness[k].latestISO || '—';
        const age=this.data.freshness[k].ageDays;
        const ageTxt=(age==null)?'':` · ${age}d old`;
        el.textContent=`${label[k]}: ${v==null?'—':fmt[k](v)} (${this.gbDate(d)}${ageTxt})`;
        el.classList.remove('skeleton');
        el.title=`${label[k]} latest: ${d} (${age} days old)`;
      }
    }

    renderCompositeChart(){
      const el=document.getElementById('compChart');
      const minLen=Math.min(...this.keys.map(k=>this.data.series[k].ys.length||Infinity));
      if(!isFinite(minLen)||minLen<3){
        el.closest('.card').querySelector('.chart').innerHTML='<div class="err">Not enough overlapping history yet to draw composite chart.</div>';
        return;
      }
      const tail=Math.min(minLen,90), xs=this.data.series.T10Y3M.xs.slice(-tail), ys=[];
      for(let i=-tail;i<0;i++){ let v=0; for(const k of this.keys){ v+=this.scales[k](this.data.series[k].ys.at(i))*(this.weights[k]||0); } ys.push(Math.round(v*10)/10); }
      this.makeChart(el,{
        type:'line',
        data:{ labels:xs, datasets:[{ data:ys, borderColor:'#7da6ff', backgroundColor:'transparent', fill:false, tension:.4 }]},
        options:this.baseOpts({
          scales:{ y:{min:0,max:100} },
          plugins:{
            tooltip:{callbacks:{label:(c)=>`Composite: ${c.parsed.y}`}},
            annotation:{
              annotations:{
                green:{ type:'line', yMin:30, yMax:30, borderColor:'rgba(30,194,139,.6)', borderDash:[6,4], borderWidth:1 },
                amber:{ type:'line', yMin:60, yMax:60, borderColor:'rgba(255,194,71,.7)', borderDash:[6,4], borderWidth:1 }
              }
            }
          }
        })
      });
    }

    renderIndicatorCharts(){
      const cfgs=[
        {k:'T10Y3M', title:'Yield Curve (10y–3m)', desc:'<b>More negative = worse</b>. Inversions (below zero) often precede recessions and major drawdowns.', color:'#6bb9ff', zero:true},
        {k:'CREDIT', title:'Credit Spread (BAA–AAA)', desc:'<b>Wider = worse</b>. Rising lower-grade vs top-tier borrowing costs signal stress in corporate credit.', color:'#ffb36b', zero:false},
        {k:'UN_SLOPE6', title:'Unemployment 6-month slope', desc:'<b>Rising = worse</b>. Early labour-market deterioration is a classic late-cycle signal.', color:'#ffa0b5', zero:true},
        {k:'DD_12M', title:'12-month Drawdown (S&P vs 1-yr peak)', desc:'<b>More negative = worse</b>. Captures market-price stress, complementing macro/credit indicators.', color:'#a6c7ff', zero:true},
        {k:'NFCI', title:'Chicago Fed NFCI', desc:'<b>Higher = tighter/worse</b>. Summarises overall financial conditions (rates, credit, funding, volatility).', color:'#9bd3c1', zero:true}
      ];
      const host=document.getElementById('charts');
      for(const c of cfgs){
        const sec=document.createElement('section'); sec.className='card'; sec.setAttribute('aria-labelledby','chart-'+c.k);
        sec.innerHTML=`<h3 id="chart-${c.k}" style="margin:0 0 8px">${c.title}</h3>
          <div class="chart"><canvas id="c_${c.k}" aria-label="${c.title} over time"></canvas></div>
          <div class="callout">${c.desc}</div>`;
        host.appendChild(sec);
        const s=this.data.series[c.k]; if(!s.ys.length){ sec.querySelector('.chart').innerHTML=`<div class="err">No data available for ${c.title}</div>`; continue; }
        this.makeChart(document.getElementById('c_'+c.k),{
          type:'line',
          data:{ labels:s.xs.slice(-90), datasets:[{ data:s.ys.slice(-90), borderColor:c.color, backgroundColor:'transparent', fill:false, tension:.4 }]},
          options:this.baseOpts({
            plugins: c.zero ? { annotation:{ annotations:{ zero:{ type:'line', yMin:0, yMax:0, borderColor:'rgba(154,166,191,.6)', borderDash:[4,4], borderWidth:1 }}}} : {}
          })
        });
      }
    }

    baseOpts(ovr={}){
      const base={
        responsive:true, maintainAspectRatio:false,
        scales:{
          x:{ grid:{color:'rgba(255,255,255,.04)'}, ticks:{ color:'#9aa6bf', maxRotation:0, autoSkip:true, maxTicksLimit:8 } },
          y:{ grid:{color:'rgba(255,255,255,.04)'}, ticks:{ color:'#9aa6bf' } }
        },
        plugins:{ legend:{display:false}, tooltip:{enabled:true} },
        elements:{ line:{tension:.4,borderWidth:2}, point:{radius:2,hitRadius:8,hoverRadius:6} },
        animation:{ duration:1000, easing:'easeOutQuart' }
      };
      return {...base, ...ovr, scales:{...base.scales, ...(ovr.scales||{})}, plugins:{...base.plugins, ...(ovr.plugins||{})}};
    }

    makeChart(el,cfg){
      try{
        if(this.charts.has(el)) this.charts.get(el).destroy();
        try{ const ap=(window.ChartAnnotation||window['chartjs-plugin-annotation']); if(ap && !Chart.registry.getPlugin('annotation')) Chart.register(ap); }catch(e){}
        const chart=new Chart(el,cfg); this.charts.set(el,chart); return chart;
      }catch(e){ console.error('Chart error:',e); el.closest('.chart').innerHTML=`<div class="err">Chart error: ${e.message}</div>`; return null;}
    }

    renderDiagnostics(){
      const diag=document.getElementById('diag');
      const out={
        fetched_at_utc:this.data.raw?.fetched_at_utc||null,
        latest_values:Object.fromEntries(this.keys.map(k=>[k,this.data.latest[k]])),
        latest_dates:Object.fromEntries(this.keys.map(k=>[k,this.data.latestISO[k]])),
        freshness_days:Object.fromEntries(this.keys.map(k=>[k,this.data.freshness[k].ageDays])),
        strict_common_date:this.data.commonISO,
        composite_asof:this.data.composite,
        composite_strict:this.data.composite_strict,
        calculation_timestamp:new Date().toISOString()
      };
      diag.textContent=JSON.stringify(out,null,2);
      document.getElementById('update-time').textContent=new Date().toLocaleTimeString('en-GB',{hour:'2-digit',minute:'2-digit'});
    }

    destroy(){ this.charts.forEach(c=>c.destroy()); this.charts.clear(); }
  }

  if(document.readyState==='loading'){
    document.addEventListener('DOMContentLoaded',()=>{ window.crash = new CrashRadar(); });
  } else {
    window.crash = new CrashRadar();
  }
  </script>
</body>
</html>
