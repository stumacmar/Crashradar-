<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="description" content="Economic Crash Radar — Advanced Market Stress Analysis with Enhanced Indicators, Intelligent Weighting & Predictive Features" />
  <title>Economic Crash Radar | Advanced Market Stress Analysis</title>
  <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <style>
    :root {
      --bg: #0f1421; --panel: #161c2e; --muted: #9aa6bf; --text: #e8eeff; --accent: #7da6ff;
      --green: #1ec28b; --amber: #ffc247; --red: #ff6070; --radius: 16px;
      --ring: 180px; --ring-m: 140px;
      --safe-bg: rgba(30, 194, 139, 0.08); --warning-bg: rgba(255, 194, 71, 0.08); --danger-bg: rgba(255, 96, 112, 0.08);
      --transition: all 0.3s ease;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    html, body { 
      margin: 0; 
      background: var(--bg); 
      color: var(--text); 
      font: 16px/1.5 system-ui, -apple-system, Segoe UI, Roboto, Inter, Helvetica, Arial;
      overflow-x: hidden;
    }
    .wrap { max-width: 1280px; margin: 0 auto; padding: 20px 16px 64px; }
    h1 { font-size: clamp(28px, 5.5vw, 44px); line-height: 1.1; margin: 0 0 8px; }
    .sub { color: var(--muted); margin: 6px 0 18px; font-size: 14px; }
    .card { 
      background: var(--panel); 
      border-radius: var(--radius); 
      padding: 20px; 
      margin: 16px 0;
      box-shadow: 0 0 0 1px rgba(255,255,255,.05) inset;
      transition: var(--transition);
    }
    .card:hover { box-shadow: 0 0 0 1px rgba(125, 166, 255, 0.2) inset; }

    /* Enhanced Gauge */
    .gauge-container { display: flex; align-items: center; gap: 24px; flex-wrap: wrap; }
    .multi-gauge { position: relative; width: var(--ring); height: var(--ring); }
    .multi-gauge .ring { 
      position: absolute; 
      inset: 0; 
      border-radius: 50%;
      background: conic-gradient(
        var(--green) 0deg 120deg, 
        var(--amber) 120deg 216deg, 
        var(--red) 216deg 360deg
      );
      opacity: 0.8;
    }
    .multi-gauge .ring-outer { 
      width: calc(var(--ring) + 40px); 
      height: calc(var(--ring) + 40px);
      inset: -20px;
      opacity: 0.5;
    }
    .multi-gauge .ring-middle { 
      width: calc(var(--ring) + 20px); 
      height: calc(var(--ring) + 20px);
      inset: -10px;
      opacity: 0.7;
    }
    .multi-gauge .ring::after { 
      content: ""; 
      position: absolute; 
      inset: 20px; 
      border-radius: 50%; 
      background: var(--panel); 
    }
    .multi-gauge .ring-outer::after { inset: 25px; }
    .multi-gauge .ring-middle::after { inset: 22px; }
    .multi-gauge .needle { 
      position: absolute; 
      inset: 0; 
      pointer-events: none; 
    }
    .multi-gauge .needle::after { 
      content: ""; 
      width: 8px; 
      height: 8px; 
      border-radius: 50%; 
      background: var(--accent);
      transform: rotate(var(--angle, 0deg)) translateY(calc(-1 * (var(--ring)/2 - 10px)));
      transform-origin: center center; 
      display: block; 
      margin: auto;
      box-shadow: 0 0 0 3px var(--panel);
    }
    .score { 
      position: absolute; 
      inset: 0; 
      display: grid; 
      place-items: center; 
      font-weight: 800; 
      font-size: 40px; 
      z-index: 10;
    }
    .timeframe-labels {
      display: flex;
      justify-content: space-between;
      width: calc(var(--ring) + 40px);
      margin-top: 10px;
      font-size: 11px;
      color: var(--muted);
    }

    /* Enhanced Pills */
    .pill { 
      display: inline-flex; 
      align-items: center; 
      gap: 8px; 
      background: #13192a; 
      border: 1px solid #1f2740;
      color: var(--text); 
      padding: 8px 12px; 
      border-radius: 999px; 
      font-weight: 600; 
      margin: 6px 8px 0 0;
      cursor: pointer;
      transition: var(--transition);
    }
    .pill:hover { border-color: var(--accent); }
    .pill.active { border-color: var(--accent); background: rgba(125, 166, 255, 0.1); }
    .dot { width: 8px; height: 8px; border-radius: 50%; }
    .meta { color: var(--muted); font-size: 13px; }

    /* Enhanced Charts */
    .chart { position: relative; height: 300px; }
    canvas { width: 100%!important; height: 100%!important; }

    /* Enhanced Table */
    table { width: 100%; border-collapse: collapse; font-size: 13px; }
    th, td { padding: 8px; border-bottom: 1px solid rgba(255,255,255,.06); text-align: left; }
    details summary { cursor: pointer; font-weight: 600; }

    /* Tabs */
    .tabs { display: flex; gap: 8px; margin-bottom: 16px; border-bottom: 1px solid rgba(255,255,255,.1); }
    .tab { padding: 8px 16px; cursor: pointer; border-radius: 6px 6px 0 0; transition: var(--transition); }
    .tab.active { background: rgba(125, 166, 255, 0.1); color: var(--accent); }

    /* Heat Map */
    .heatmap { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 12px; margin-top: 16px; }
    .heatmap-item { 
      background: #13192a; 
      border-radius: 8px; 
      padding: 12px; 
      text-align: center;
      border: 1px solid #1f2740;
      transition: var(--transition);
    }
    .heatmap-item:hover { border-color: var(--accent); }
    .heatmap-value { font-size: 18px; font-weight: 700; margin: 8px 0; }
    .heatmap-label { font-size: 12px; color: var(--muted); }

    /* Alert Banner */
    .alert-banner {
      background: var(--warning-bg);
      border-left: 4px solid var(--amber);
      padding: 12px 16px;
      margin: 16px 0;
      border-radius: 4px;
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .alert-banner.danger {
      background: var(--danger-bg);
      border-left-color: var(--red);
    }
    .alert-banner.safe {
      background: var(--safe-bg);
      border-left-color: var(--green);
    }

    /* Progress Bars */
    .progress-container { margin: 12px 0; }
    .progress-label { display: flex; justify-content: space-between; margin-bottom: 4px; font-size: 13px; }
    .progress-bar { height: 6px; background: #1f2740; border-radius: 3px; overflow: hidden; }
    .progress-fill { height: 100%; background: var(--accent); border-radius: 3px; transition: width 0.5s ease; }

    /* Responsive */
    @media (max-width: 768px) {
      .gauge-container { justify-content: center; text-align: center; }
      .multi-gauge { width: var(--ring-m); height: var(--ring-m); }
      .multi-gauge .ring-outer { 
        width: calc(var(--ring-m) + 40px); 
        height: calc(var(--ring-m) + 40px);
        inset: -20px;
      }
      .multi-gauge .ring-middle { 
        width: calc(var(--ring-m) + 20px); 
        height: calc(var(--ring-m) + 20px);
        inset: -10px;
      }
      .score { font-size: 32px; }
      .pill { display: block; }
      .heatmap { grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>Economic Crash Radar <span style="color: var(--accent); font-size: 0.7em;">Advanced</span></h1>
      <div id="status" class="sub" aria-live="polite">Loading market data…</div>
    </header>

    <main>
      <!-- Alert Banner -->
      <div id="alertBanner" class="alert-banner" style="display: none;">
        <i class="fas fa-exclamation-triangle"></i>
        <div id="alertMessage"></div>
      </div>

      <!-- Enhanced Gauge -->
      <section class="card">
        <div class="gauge-container">
          <div class="multi-gauge">
            <div class="ring ring-outer"></div>
            <div class="ring ring-middle"></div>
            <div class="ring"></div>
            <div id="needle" class="needle"></div>
            <div id="scoreText" class="score">–</div>
          </div>
          <div>
            <h2 style="margin:0 0 6px;font-size:26px">Multi-Timeframe Composite</h2>
            <div class="meta">
              <div><b style="color:var(--green)">Inner: Current</b> | <b style="color:var(--amber)">Middle: 3-Month</b> | <b style="color:var(--red)">Outer: 12-Month</b></div>
              <div style="margin-top: 8px;">Risk Zones: <b style="color:var(--green)">≤30 Green</b>, <b style="color:var(--amber)">≤60 Amber</b>, <b style="color:var(--red)">&gt;60 Red</b></div>
            </div>
            <div id="freshness" class="meta" style="margin-top:6px">—</div>
            <div id="regimeIndicator" class="meta" style="margin-top:6px"></div>
          </div>
        </div>
        <div class="timeframe-labels">
          <span>Current</span>
          <span>3-Month</span>
          <span>12-Month</span>
        </div>
      </section>

      <!-- Risk Attribution -->
      <section class="card">
        <h3 style="margin:0 0 12px">Risk Attribution</h3>
        <div id="riskAttribution">
          <!-- Dynamic content will be inserted here -->
        </div>
      </section>

      <!-- Enhanced Pills -->
      <section class="card">
        <h3 style="margin:0 0 8px">Indicator Dashboard</h3>
        <div class="tabs">
          <div class="tab active" data-tab="market">Market</div>
          <div class="tab" data-tab="liquidity">Liquidity</div>
          <div class="tab" data-tab="corporate">Corporate</div>
          <div class="tab" data-tab="real">Real Economy</div>
        </div>
        <div id="pills" role="list"></div>
      </section>

      <!-- Heat Map -->
      <section class="card">
        <h3 style="margin:0 0 12px">Indicator Heat Map</h3>
        <div id="heatmap" class="heatmap">
          <!-- Dynamic content will be inserted here -->
        </div>
      </section>

      <!-- Composite Chart -->
      <section class="card">
        <h3 style="margin:0 0 6px">Composite History (7-day MA)</h3>
        <div class="meta">Bands: 0–30 (Green), 30–60 (Amber), 60–100 (Red). Aligned to your cache; gauge = raw latest.</div>
        <div class="chart"><canvas id="compChart" aria-label="Composite risk 7-day moving average"></canvas></div>
      </section>

      <!-- Indicator charts -->
      <div id="charts"></div>

      <!-- Historical Analogs -->
      <section class="card">
        <h3 style="margin:0 0 12px">Historical Analog Analysis</h3>
        <div id="analogContainer">
          <div class="meta">Comparing current market conditions to historical stress episodes</div>
          <div id="analogCharts" style="display: flex; flex-wrap: wrap; gap: 20px; margin-top: 16px;">
            <!-- Dynamic content will be inserted here -->
          </div>
        </div>
      </section>

      <!-- Diagnostics -->
      <section class="card">
        <h3 style="margin:0 0 8px">Data & Diagnostics</h3>
        <details>
          <summary>Technical Details & Advanced Analytics</summary>
          <pre id="diag" style="white-space:pre-wrap;word-break:break-word;color:#ffdca8;background:#241d12;border:1px solid #4a3e20;border-radius:10px;padding:12px;max-height:360px;overflow:auto;margin:10px 0;font-size:12px;"></pre>
        </details>

        <div id="episodesWrap" style="margin-top:8px;display:none">
          <h4 style="margin:0 0 6px">Regime Episodes</h4>
          <table id="episodesTable">
            <thead><tr><th>Date</th><th>From</th><th>To</th><th>Composite</th><th>Duration</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>

        <div class="meta" style="margin-top:8px;">Live data source: <code>data/fred_cache.json</code>.</div>
      </section>
    </main>
  </div>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3.1.1/dist/chartjs-plugin-annotation.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/moment@2.29.4/moment.min.js"></script>

  <script>
  // ====================== ENHANCED MODEL ======================
  // Expanded indicator suite
  const KEYS = [
    // Original indicators
    'T10Y3M','CREDIT','UN_SLOPE6','DD_12M','NFCI',
    // Enhanced indicators
    'VIX',           // Market Volatility
    'TEDRATE',       // TED Spread (Liquidity Stress)
    'BAMLH0A0HYM2',  // High-Yield Bond Spread (Corporate Health)
    'INDPRO',        // Industrial Production (Real Economy)
    'CSUSHPINSA',    // Case-Shiller Home Price Index (Housing)
    'EMRATIO',       // Employment-Population Ratio (Real Economy)
    'UMCSENT',       // Consumer Sentiment (Sentiment)
    'USEPUINDXD'     // Economic Policy Uncertainty (Sentiment)
  ];

  // Enhanced risk mappings with Z-score normalization
  const SCALE = {
    T10Y3M:   v => clamp(map01(v,  1.0, -2.0)),     // ↓ worse
    CREDIT:   v => clamp(map01(v,  0.30, 1.00)),    // ↑ worse (BAA–AAA)
    UN_SLOPE6:v => clamp(map01(v,  0.05, 0.50)),    // ↑ worse (min sensitivity 0.05)
    DD_12M:   v => clamp(map01(v,  0.00, -0.20)),   // ↓ worse (−20% = red)
    NFCI:     v => clamp(map01(v, -0.80, 0.40)),    // ↑ worse (>0 tighter)
    // Enhanced indicators
    VIX:      v => clamp(map01(v,  12,   40)),      // ↑ worse
    TEDRATE:  v => clamp(map01(v,  0.10, 2.00)),    // ↑ worse
    BAMLH0A0HYM2: v => clamp(map01(v, 3.0, 10.0)),  // ↑ worse
    INDPRO:   v => clamp(map01(v,  2.0, -8.0)),     // ↓ worse
    CSUSHPINSA: v => clamp(map01(v, 5.0, -10.0)),   // ↓ worse
    EMRATIO:  v => clamp(map01(v, -0.5, -3.0)),     // ↓ worse
    UMCSENT:  v => clamp(map01(v, -5.0, -20.0)),    // ↓ worse
    USEPUINDXD: v => clamp(map01(v, 100, 300))      // ↑ worse
  };

  // Enhanced weighting system with regime detection
  const BASE_WEIGHTS = {
    T10Y3M: 0.18, CREDIT: 0.12, UN_SLOPE6: 0.10, DD_12M: 0.15, NFCI: 0.10,
    VIX: 0.08, TEDRATE: 0.07, BAMLH0A0HYM2: 0.08, INDPRO: 0.04, 
    CSUSHPINSA: 0.03, EMRATIO: 0.02, UMCSENT: 0.02, USEPUINDXD: 0.01
  };

  // Regime-based weight adjustments
  const REGIME_WEIGHTS = {
    normal: { 
      T10Y3M: 1.0, CREDIT: 1.0, UN_SLOPE6: 0.8, DD_12M: 1.2, NFCI: 1.0,
      VIX: 0.7, TEDRATE: 0.8, BAMLH0A0HYM2: 0.9, INDPRO: 1.1, 
      CSUSHPINSA: 1.0, EMRATIO: 1.0, UMCSENT: 1.0, USEPUINDXD: 0.8
    },
    stressed: { 
      T10Y3M: 1.2, CREDIT: 1.3, UN_SLOPE6: 1.1, DD_12M: 1.1, NFCI: 1.3,
      VIX: 1.4, TEDRATE: 1.3, BAMLH0A0HYM2: 1.2, INDPRO: 0.9, 
      CSUSHPINSA: 0.9, EMRATIO: 1.1, UMCSENT: 1.2, USEPUINDXD: 1.3
    },
    crisis: { 
      T10Y3M: 1.1, CREDIT: 1.2, UN_SLOPE6: 1.4, DD_12M: 0.9, NFCI: 1.2,
      VIX: 1.5, TEDRATE: 1.5, BAMLH0A0HYM2: 1.4, INDPRO: 1.3, 
      CSUSHPINSA: 1.2, EMRATIO: 1.3, UMCSENT: 1.4, USEPUINDXD: 1.5
    }
  };

  // Enhanced freshness penalties
  const FRESH = { daily:{ok:7,warn:30}, weekly:{ok:7,warn:30}, monthly:{ok:30,warn:60} };
  const CADENCE = {
    T10Y3M:'daily', CREDIT:'monthly', UN_SLOPE6:'monthly', DD_12M:'daily', NFCI:'weekly',
    VIX:'daily', TEDRATE:'daily', BAMLH0A0HYM2:'daily', INDPRO:'monthly', 
    CSUSHPINSA:'monthly', EMRATIO:'monthly', UMCSENT:'monthly', USEPUINDXD:'monthly'
  };

  // Enhanced delta rules for acceleration detection
  const DELTA_RULES = {
    NFCI:  { lookbackDays:28, th:+0.15, add:+4 },   // tightening quickly
    DD_12M:{ lookbackDays:14, th:-0.05, add:+3 },   // quick slide lower
    T10Y3M:{ lookbackDays:14, th:-0.25, add:+3 },   // curve plunges
    VIX:   { lookbackDays:14, th:+8, add:+5 },      // volatility spike
    TEDRATE:{ lookbackDays:14, th:+0.5, add:+4 }    // liquidity stress
  };

  // Historical analogs for comparison
  const HISTORICAL_ANALOGS = {
    '2008 Crisis': { start: '2007-12-01', end: '2009-06-01', color: '#ff6070' },
    'Dot-com Bubble': { start: '2000-03-01', end: '2002-10-01', color: '#ff9d47' },
    'COVID Crash': { start: '2020-02-01', end: '2020-04-01', color: '#47b5ff' },
    '2018 Correction': { start: '2018-09-01', end: '2018-12-01', color: '#9d47ff' }
  };

  // ====================== UTILS ======================
  const GREEN=30, AMBER=60;
  const d = s => new Date(s+"T00:00:00Z");
  function gbDate(D){return D? D.toLocaleDateString('en-GB',{day:'2-digit',month:'short',year:'numeric'}):'—'}
  function clamp(x){ return Math.max(0, Math.min(100,x)); }
  function map01(val, good, bad){ if(val==null) return 50; const denom=bad-good; if(Math.abs(denom)<1e-9) return 50; return ((val-good)/denom)*100; }
  function zoneOf(s){ return s<=GREEN?'green':(s<=AMBER?'amber':'red'); }
  function zoneName(z){ return z==='green'?'Green':z==='amber'?'Amber':'Red'; }
  function movingAvg(a,k){ const out=[]; let sum=0; for(let i=0;i<a.length;i++){ sum+=a[i]; if(i>=k) sum-=a[i-k]; out.push(i>=k-1? +(sum/k).toFixed(1):null);} return out; }
  function latest(series){ const obs=series?.observations||[]; if(!obs.length) return null; const o=obs[obs.length-1]; return {value:+o.value,date:o.date}; }
  function seriesAgeDays(series, fetchedAt){
    const L=latest(series); if(!L) return Infinity;
    return Math.max(0, Math.round((new Date(fetchedAt)-d(L.date))/(1000*60*60*24)));
  }

  // Align on common tail (your cache arrays are same length & dates in STRICT mode)
  function alignedTail(S, keys, tail=180){
    const arrays = keys.map(k => (S[k]?.observations||[]));
    const minLen = Math.min(...arrays.map(a=>a.length||0));
    const n = Math.min(minLen, tail);
    const byKey = {};
    keys.forEach((k,i)=> byKey[k] = arrays[i].slice(-n).map(o=>({date:o.date, value:+o.value})));
    const xs = byKey[keys[0]].map(o=> o.date);
    return {xs,byKey,n};
  }

  // Calculate Z-score for advanced normalization
  function calculateZScore(value, mean, stdDev) {
    if (!stdDev || stdDev === 0) return 0;
    return (value - mean) / stdDev;
  }

  // Calculate statistical moments for a series
  function calculateMoments(values) {
    const n = values.length;
    if (n === 0) return { mean: 0, stdDev: 0, skewness: 0, kurtosis: 0 };
    
    const mean = values.reduce((a, b) => a + b, 0) / n;
    const variance = values.reduce((a, b) => a + Math.pow(b - mean, 2), 0) / n;
    const stdDev = Math.sqrt(variance);
    
    // Calculate skewness and kurtosis if we have enough data
    let skewness = 0;
    let kurtosis = 0;
    
    if (n > 2 && stdDev > 0) {
      skewness = values.reduce((a, b) => a + Math.pow((b - mean) / stdDev, 3), 0) / n;
      kurtosis = values.reduce((a, b) => a + Math.pow((b - mean) / stdDev, 4), 0) / n - 3;
    }
    
    return { mean, stdDev, skewness, kurtosis };
  }

  // ====================== ENHANCED APP ======================
  const App = {
    raw:null, 
    compLatest:null, 
    compMA7:[], 
    compRaw:[],
    comp3Month: null,
    comp12Month: null,
    latestVals:{}, 
    ages:{}, 
    charts:new Map(), 
    currentRegime: 'normal',
    regimeProbability: { normal: 0.6, stressed: 0.3, crisis: 0.1 },
    activeTab: 'market',

    async init(){
      this.setStatus('Loading market data…');
      try{
        const ctl = new AbortController(); 
        const t=setTimeout(()=>ctl.abort(),10000);
        const res = await fetch('data/fred_cache.json',{cache:'no-cache',signal:ctl.signal}); 
        clearTimeout(t);
        if(!res.ok) throw new Error(`HTTP ${res.status}`);
        this.raw = await res.json();
        this.setStatus('Ready');
      }catch(e){
        this.setStatus('Failed to load data','bad');
        document.getElementById('diag').textContent = 'Load error: '+e.message;
        return;
      }
      this.process();
      this.renderAll();
      this.setupEventListeners();
    },

    setStatus(msg){ const el=document.getElementById('status'); if(el) el.textContent=msg; },
    setNeedle(score){ 
      const n=document.getElementById('needle'); 
      if(n) n.style.setProperty('--angle', ((Math.max(0,Math.min(100,score))/100)*360)+'deg'); 
    },

    setupEventListeners() {
      // Tab switching
      document.querySelectorAll('.tab').forEach(tab => {
        tab.addEventListener('click', () => {
          document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
          tab.classList.add('active');
          this.activeTab = tab.dataset.tab;
          this.renderPills();
        });
      });

      // Pill clicking for indicator details
      document.addEventListener('click', (e) => {
        if (e.target.closest('.pill')) {
          const pill = e.target.closest('.pill');
          const indicator = pill.dataset.indicator;
          if (indicator) {
            this.showIndicatorDetails(indicator);
          }
        }
      });
    },

    process(){
      const S = this.raw?.series||{};
      const fetchedAt = this.raw?.fetched_at_utc ? new Date(this.raw.fetched_at_utc) : new Date();

      // Detect current regime
      this.detectRegime(S, fetchedAt);

      // Get current weights based on regime
      const currentWeights = this.getCurrentWeights();

      // latest values & ages
      for(const k of KEYS){
        const L = latest(S[k]);
        this.latestVals[k] = L? L.value : null;
        this.ages[k] = seriesAgeDays(S[k], fetchedAt);
      }

      // latest composite (with freshness & delta boosts)
      let wsum=0, sum=0;
      for(const k of KEYS){
        const v = this.latestVals[k];
        const risk = SCALE[k](v);
        const pen = this.freshnessPenalty(this.ages[k], CADENCE[k]);
        const weight = currentWeights[k];
        sum += risk * weight * pen;
        wsum += weight;
      }
      let boosts = this.deltaBoost('NFCI', DELTA_RULES.NFCI)
                 + this.deltaBoost('DD_12M', DELTA_RULES.DD_12M)
                 + this.deltaBoost('T10Y3M', DELTA_RULES.T10Y3M)
                 + this.deltaBoost('VIX', DELTA_RULES.VIX)
                 + this.deltaBoost('TEDRATE', DELTA_RULES.TEDRATE);
      this.compLatest = Math.round(Math.min(100, Math.max(0,(sum/wsum) + boosts)));

      // Calculate 3-month and 12-month composites
      this.calculateMultiTimeframeComposites(S, fetchedAt, currentWeights);

      // composite history (aligned tail), then 7-day MA
      const {xs,byKey,n} = alignedTail(S, KEYS, 240);
      const comp=[];
      for(let i=0;i<n;i++){
        let tot=0, w=0;
        for(const k of KEYS){ 
          const v = byKey[k][i]?.value; 
          const r=SCALE[k](v); 
          tot += r*currentWeights[k]; 
          w+=currentWeights[k]; 
        }
        comp.push( +(tot/w).toFixed(1) );
      }
      this.compRaw = comp;
      this.compMA7 = movingAvg(comp, 7);

      this.fetchedAt = fetchedAt;
      this.alignedXs = xs;  // ISO dates
    },

    detectRegime(S, fetchedAt) {
      // Simple regime detection based on VIX and composite score
      const vix = latest(S['VIX'])?.value || 15;
      const nfci = latest(S['NFCI'])?.value || -0.5;
      const credit = latest(S['CREDIT'])?.value || 0.5;
      
      let crisisScore = 0;
      if (vix > 30) crisisScore += 0.4;
      else if (vix > 20) crisisScore += 0.2;
      
      if (nfci > 0.2) crisisScore += 0.3;
      else if (nfci > 0) crisisScore += 0.15;
      
      if (credit > 0.8) crisisScore += 0.3;
      else if (credit > 0.6) crisisScore += 0.15;
      
      if (crisisScore > 0.7) {
        this.currentRegime = 'crisis';
        this.regimeProbability = { normal: 0.1, stressed: 0.3, crisis: 0.6 };
      } else if (crisisScore > 0.4) {
        this.currentRegime = 'stressed';
        this.regimeProbability = { normal: 0.3, stressed: 0.5, crisis: 0.2 };
      } else {
        this.currentRegime = 'normal';
        this.regimeProbability = { normal: 0.6, stressed: 0.3, crisis: 0.1 };
      }
    },

    getCurrentWeights() {
      const weights = {};
      for (const k of KEYS) {
        weights[k] = BASE_WEIGHTS[k] * (REGIME_WEIGHTS[this.currentRegime][k] || 1);
      }
      return weights;
    },

    calculateMultiTimeframeComposites(S, fetchedAt, weights) {
      // For 3-month composite (approx 63 trading days)
      let sum3m = 0, wsum3m = 0;
      for(const k of KEYS){
        const series = S[k]?.observations || [];
        if (series.length < 63) continue;
        
        // Get value from 3 months ago
        const value3m = +series[series.length - 63].value;
        const risk = SCALE[k](value3m);
        const pen = this.freshnessPenalty(this.ages[k], CADENCE[k]);
        sum3m += risk * weights[k] * pen;
        wsum3m += weights[k];
      }
      this.comp3Month = wsum3m > 0 ? Math.round(Math.min(100, Math.max(0, sum3m/wsum3m))) : null;

      // For 12-month composite (approx 252 trading days)
      let sum12m = 0, wsum12m = 0;
      for(const k of KEYS){
        const series = S[k]?.observations || [];
        if (series.length < 252) continue;
        
        // Get value from 12 months ago
        const value12m = +series[series.length - 252].value;
        const risk = SCALE[k](value12m);
        const pen = this.freshnessPenalty(this.ages[k], CADENCE[k]);
        sum12m += risk * weights[k] * pen;
        wsum12m += weights[k];
      }
      this.comp12Month = wsum12m > 0 ? Math.round(Math.min(100, Math.max(0, sum12m/wsum12m))) : null;
    },

    freshnessPenalty(days, cadence){
      const lim = FRESH[cadence]||FRESH.daily;
      if (days<=lim.ok) return 1.00;
      if (days<=lim.warn) return 0.85;
      return 0.70;
    },

    deltaBoost(key, rule){
      const S=this.raw?.series?.[key]?.observations||[];
      if(!S.length) return 0;
      const last=S[S.length-1]; 
      const lb = new Date(new Date(last.date+"T00:00:00Z").getTime()-rule.lookbackDays*864e5);
      // find observation on/just before lookback
      let base=+S[S.length-1].value;
      for(let i=S.length-1;i>=0;i--){
        const di = new Date(S[i].date+"T00:00:00Z");
        if(di<=lb){ base = +S[i].value; break; }
      }
      const chg = (+last.value) - base;
      if(key==='DD_12M'){ return (chg<=rule.th) ? rule.add : 0; } // more negative quickly
      return (chg>=rule.th) ? rule.add : 0;
    },

    renderAll(){
      this.renderGauge();
      this.renderRiskAttribution();
      this.renderPills();
      this.renderHeatmap();
      this.renderCompositeChart();
      this.renderIndicatorCharts();
      this.renderHistoricalAnalogs();
      this.renderDiagnostics();
      this.renderEpisodes();
      this.checkAlerts();
    },

    renderGauge(){
      document.getElementById('scoreText').textContent = isFinite(this.compLatest)? this.compLatest : '–';
      this.setNeedle(isFinite(this.compLatest)? this.compLatest : 50);
      const ts = this.raw?.fetched_at_utc? new Date(this.raw.fetched_at_utc) : null;
      const txt = ts ? `${ts.toLocaleDateString('en-GB',{day:'2-digit',month:'short',year:'numeric'})} ${ts.toLocaleTimeString('en-GB',{hour:'2-digit',minute:'2-digit'})}` : '—';
      document.getElementById('freshness').textContent = `AS-OF ${txt}`;
      
      // Display regime
      const regimeEl = document.getElementById('regimeIndicator');
      const regimeColors = { normal: 'var(--green)', stressed: 'var(--amber)', crisis: 'var(--red)' };
      regimeEl.innerHTML = `Current Regime: <b style="color:${regimeColors[this.currentRegime]}">${this.currentRegime.toUpperCase()}</b> | 
                            Probabilities: Normal ${Math.round(this.regimeProbability.normal*100)}%, 
                            Stressed ${Math.round(this.regimeProbability.stressed*100)}%, 
                            Crisis ${Math.round(this.regimeProbability.crisis*100)}%`;
    },

    renderRiskAttribution() {
      const container = document.getElementById('riskAttribution');
      if (!container) return;
      
      const S = this.raw?.series||{};
      const currentWeights = this.getCurrentWeights();
      
      let html = '';
      let totalRisk = 0;
      const riskContributions = {};
      
      // Calculate risk contributions
      for(const k of KEYS){
        const v = this.latestVals[k];
        if (v === null) continue;
        
        const risk = SCALE[k](v);
        const pen = this.freshnessPenalty(this.ages[k], CADENCE[k]);
        const weight = currentWeights[k];
        const contribution = risk * weight * pen;
        
        riskContributions[k] = contribution;
        totalRisk += contribution;
      }
      
      // Normalize and display
      for(const k of KEYS){
        if (riskContributions[k] === undefined) continue;
        
        const percent = totalRisk > 0 ? Math.round((riskContributions[k] / totalRisk) * 100) : 0;
        const indicatorLabels = {
          'T10Y3M': 'Yield Curve', 'CREDIT': 'Credit Spread', 'UN_SLOPE6': 'Unemp Δ6m', 
          'DD_12M': 'Drawdown 12m', 'NFCI': 'NFCI', 'VIX': 'Volatility (VIX)',
          'TEDRATE': 'TED Spread', 'BAMLH0A0HYM2': 'High-Yield Spread', 'INDPRO': 'Industrial Production',
          'CSUSHPINSA': 'Housing Prices', 'EMRATIO': 'Employment', 'UMCSENT': 'Consumer Sentiment',
          'USEPUINDXD': 'Policy Uncertainty'
        };
        
        html += `
          <div class="progress-container">
            <div class="progress-label">
              <span>${indicatorLabels[k] || k}</span>
              <span>${percent}%</span>
            </div>
            <div class="progress-bar">
              <div class="progress-fill" style="width: ${percent}%"></div>
            </div>
          </div>
        `;
      }
      
      container.innerHTML = html;
    },

    pillDot(days, cadence){
      const lim = FRESH[cadence]||FRESH.daily;
      if (days<=lim.ok) return 'var(--green)';
      if (days<=lim.warn) return 'var(--amber)';
      return 'var(--red)';
    },

    renderPills(){
      const host=document.getElementById('pills'); 
      if (!host) return;
      
      host.innerHTML='';
      
      // Group indicators by category
      const indicatorCategories = {
        market: ['T10Y3M', 'DD_12M', 'VIX'],
        liquidity: ['NFCI', 'TEDRATE'],
        corporate: ['CREDIT', 'BAMLH0A0HYM2'],
        real: ['UN_SLOPE6', 'INDPRO', 'CSUSHPINSA', 'EMRATIO', 'UMCSENT', 'USEPUINDXD']
      };
      
      const currentCategory = indicatorCategories[this.activeTab] || [];
      
      const label={
        T10Y3M:'Yield (10y–3m)', CREDIT:'Credit (BAA–AAA)', UN_SLOPE6:'Unemp Δ6m', 
        DD_12M:'Drawdown 12m', NFCI:'NFCI', VIX:'VIX Volatility',
        TEDRATE:'TED Spread', BAMLH0A0HYM2:'High-Yield Spread', INDPRO:'Industrial Production',
        CSUSHPINSA:'Case-Shiller', EMRATIO:'Emp/Pop Ratio', UMCSENT:'Consumer Sentiment',
        USEPUINDXD:'Policy Uncertainty'
      };
      
      const fmt={
        T10Y3M:v=>v?.toFixed(2), CREDIT:v=>v?.toFixed(2), UN_SLOPE6:v=>v?.toFixed(2), 
        DD_12M:v=>((v??0)*100).toFixed(1)+'%', NFCI:v=>v?.toFixed(3), VIX:v=>v?.toFixed(1),
        TEDRATE:v=>v?.toFixed(2), BAMLH0A0HYM2:v=>v?.toFixed(2), INDPRO:v=>v?.toFixed(1)+'%',
        CSUSHPINSA:v=>v?.toFixed(1)+'%', EMRATIO:v=>v?.toFixed(1)+'%', UMCSENT:v=>v?.toFixed(0),
        USEPUINDXD:v=>v?.toFixed(0)
      };
      
      for(const k of currentCategory){
        if (!KEYS.includes(k)) continue;
        
        const pill=document.createElement('span'); 
        pill.className='pill'; 
        pill.dataset.indicator = k;
        pill.title={
          T10Y3M:'More negative = worse (inversions often precede recessions).',
          CREDIT:'Wider = worse (lower-grade vs AAA).',
          UN_SLOPE6:'Rising unemployment over 6 months = worse.',
          DD_12M:'More negative = worse (price stress).',
          NFCI:'Higher = tighter/worse; >0 tighter than average.',
          VIX:'Higher = more market fear/worse.',
          TEDRATE:'Wider = more interbank lending stress/worse.',
          BAMLH0A0HYM2:'Wider = more corporate credit stress/worse.',
          INDPRO:'Negative = contracting industrial activity/worse.',
          CSUSHPINSA:'Negative = declining home prices/worse.',
          EMRATIO:'Declining = weakening labor market/worse.',
          UMCSENT:'Declining = worsening consumer sentiment/worse.',
          USEPUINDXD:'Higher = more policy uncertainty/worse.'
        }[k] || '';
        
        const dot=document.createElement('span'); 
        dot.className='dot';
        dot.style.background=this.pillDot(this.ages[k], CADENCE[k]);
        
        const val=this.latestVals[k];
        pill.append(dot, document.createTextNode(`${label[k]}: ${val==null?'—':fmt[k](val)}`));
        host.appendChild(pill);
      }
    },

    renderHeatmap() {
      const container = document.getElementById('heatmap');
      if (!container) return;
      
      let html = '';
      const currentWeights = this.getCurrentWeights();
      
      for(const k of KEYS) {
        const v = this.latestVals[k];
        if (v === null) continue;
        
        const risk = SCALE[k](v);
        const zone = zoneOf(risk);
        const zoneColors = { green: 'var(--green)', amber: 'var(--amber)', red: 'var(--red)' };
        const zoneBgColors = { green: 'var(--safe-bg)', amber: 'var(--warning-bg)', red: 'var(--danger-bg)' };
        
        const indicatorLabels = {
          'T10Y3M': 'Yield Curve', 'CREDIT': 'Credit Spread', 'UN_SLOPE6': 'Unemp Δ6m', 
          'DD_12M': 'Drawdown', 'NFCI': 'NFCI', 'VIX': 'VIX',
          'TEDRATE': 'TED Spread', 'BAMLH0A0HYM2': 'HY Spread', 'INDPRO': 'Ind Production',
          'CSUSHPINSA': 'Housing', 'EMRATIO': 'Employment', 'UMCSENT': 'Sentiment',
          'USEPUINDXD': 'Uncertainty'
        };
        
        html += `
          <div class="heatmap-item" style="border-color: ${zoneColors[zone]}; background: ${zoneBgColors[zone]};">
            <div class="heatmap-label">${indicatorLabels[k] || k}</div>
            <div class="heatmap-value" style="color: ${zoneColors[zone]}">${Math.round(risk)}</div>
            <div class="heatmap-label">Weight: ${Math.round(currentWeights[k] * 100)}%</div>
          </div>
        `;
      }
      
      container.innerHTML = html;
    },

    renderCompositeChart(){
      const el=document.getElementById('compChart');
      if(!this.compMA7.length){ el.closest('.chart').innerHTML='<div class="meta">No data.</div>'; return; }

      // Register annotation plugin if available
      try{ 
        const ap=(window.ChartAnnotation||window['chartjs-plugin-annotation']); 
        if(ap && !Chart.registry.getPlugin('annotation')) Chart.register(ap);
      }catch(e){}

      const xs = this.alignedXs.map(s=>{
        const D=new Date(s+"T00:00:00Z");
        return !isNaN(D) ? D.toLocaleDateString('en-GB',{month:'short',year:'2-digit'}).replace(' ',' ’') : s;
      });

      const prev=App.charts.get(el); if(prev) prev.destroy();
      const chart=new Chart(el,{
        type:'line',
        data:{
          labels:xs, 
          datasets:[
            {
              label:'Composite (7-day MA)', 
              data:this.compMA7, 
              borderColor:'#7da6ff', 
              backgroundColor:'rgba(125, 166, 255, 0.1)', 
              fill: true,
              tension:.35, 
              spanGaps:true, 
              pointRadius:0
            }
          ]
        },
        options:{
          responsive:true, 
          maintainAspectRatio:false,
          scales:{
            y:{
              min:0,
              max:100,
              grid:{color:'rgba(255,255,255,.06)'},
              ticks:{color:'#9aa6bf'}
            },
            x:{
              grid:{color:'rgba(255,255,255,.04)'},
              ticks:{color:'#9aa6bf',maxTicksLimit:6}
            }
          },
          plugins:{
            legend:{display:false},
            annotation:{
              annotations:{
                g:{type:'box',yMin:0,yMax:30,backgroundColor:'rgba(30,194,139,.06)',borderWidth:0},
                a:{type:'box',yMin:30,yMax:60,backgroundColor:'rgba(255,194,71,.05)',borderWidth:0},
                r:{type:'box',yMin:60,yMax:100,backgroundColor:'rgba(255,96,112,.05)',borderWidth:0},
                gl:{type:'line',yMin:30,yMax:30,borderColor:'rgba(30,194,139,.6)',borderDash:[6,4]},
                al:{type:'line',yMin:60,yMax:60,borderColor:'rgba(255,194,71,.7)',borderDash:[6,4]}
              }
            }
          }
        }
      });
      App.charts.set(el,chart);
    },

    renderIndicatorCharts(){
      const host=document.getElementById('charts'); 
      host.innerHTML='';
      
      const cfgs=[
        {k:'T10Y3M', title:'Yield Curve (10y–3m)', desc:'More negative = worse.', color:'#6bb9ff', zero:true},
        {k:'CREDIT', title:'Credit Spread (BAA–AAA)', desc:'Wider = worse.', color:'#ffb36b', zero:false},
        {k:'UN_SLOPE6', title:'Unemployment 6-month slope', desc:'Rising = worse.', color:'#ffa0b5', zero:true},
        {k:'DD_12M', title:'12-month Drawdown (S&P vs 1-yr peak)', desc:'More negative = worse.', color:'#a6c7ff', zero:true},
        {k:'NFCI', title:'Chicago Fed NFCI', desc:'Higher = tighter/worse.', color:'#9bd3c1', zero:true},
        {k:'VIX', title:'CBOE Volatility Index (VIX)', desc:'Higher = more market fear/worse.', color:'#ff7b7b', zero:false},
        {k:'TEDRATE', title:'TED Spread', desc:'Wider = more interbank stress/worse.', color:'#c97bff', zero:false},
        {k:'BAMLH0A0HYM2', title:'High-Yield Bond Spread', desc:'Wider = more corporate stress/worse.', color:'#7bffc2', zero:false}
      ];
      
      const S=this.raw?.series||{};
      for(const c of cfgs){
        const sec=document.createElement('section'); 
        sec.className='card';
        sec.innerHTML=`<h3 style="margin:0 0 8px">${c.title}</h3>
          <div class="chart"><canvas id="c_${c.k}" aria-label="${c.title} over time"></canvas></div>
          <div class="meta">${c.desc}</div>`;
        host.appendChild(sec);

        const obs=(S[c.k]?.observations||[]).slice(-180);
        if(!obs.length){ sec.querySelector('.chart').innerHTML='<div class="meta">No data.</div>'; continue; }
        const xs=obs.map(o=>o.date); 
        const ys=obs.map(o=>+o.value);

        const el=document.getElementById(`c_${c.k}`);
        const prev=App.charts.get(el); if(prev) prev.destroy();
        const chart=new Chart(el,{
          type:'line',
          data:{
            labels:xs, 
            datasets:[
              {
                data:ys, 
                borderColor:c.color, 
                backgroundColor:'transparent', 
                pointRadius:0, 
                tension:.35
              }
            ]
          },
          options:{
            responsive:true, 
            maintainAspectRatio:false,
            scales:{
              x:{
                grid:{color:'rgba(255,255,255,.04)'},
                ticks:{
                  color:'#9aa6bf',
                  maxTicksLimit:6,
                  callback:(v,i,t)=>{
                    const raw=t?.[i]?.label||''; 
                    const D=new Date(raw); 
                    return !isNaN(D)? 
                      D.toLocaleDateString('en-GB',{month:'short',year:'2-digit'}).replace(' ',' ’'):raw;
                  }
                }
              },
              y:{
                grid:{color:'rgba(255,255,255,.06)'},
                ticks:{color:'#9aa6bf'}
              }
            },
            plugins:{
              legend:{display:false},
              annotation:c.zero?{annotations:{z:{type:'line',yMin:0,yMax:0,borderColor:'rgba(154,166,191,.6)',borderDash:[4,4]}}}:{}
            }
          }
        });
        App.charts.set(el,chart);
      }
    },

    renderHistoricalAnalogs() {
      const container = document.getElementById('analogCharts');
      if (!container) return;
      
      container.innerHTML = '';
      
      // For each historical analog, create a mini gauge
      Object.entries(HISTORICAL_ANALOGS).forEach(([name, data]) => {
        const analogEl = document.createElement('div');
        analogEl.style.flex = '1';
        analogEl.style.minWidth = '150px';
        analogEl.innerHTML = `
          <div style="text-align: center; margin-bottom: 10px;">
            <div style="font-size: 14px; font-weight: bold; margin-bottom: 5px;">${name}</div>
            <div style="font-size: 11px; color: var(--muted);">${data.start} to ${data.end}</div>
          </div>
          <div style="width: 80px; height: 80px; margin: 0 auto; position: relative;">
            <div style="position: absolute; inset: 0; border-radius: 50%; 
                        background: conic-gradient(var(--green) 0deg 108deg, var(--amber) 108deg 194deg, var(--red) 194deg 360deg);"></div>
            <div style="position: absolute; inset: 10px; border-radius: 50%; background: var(--panel);"></div>
            <div style="position: absolute; inset: 0; display: grid; place-items: center; font-weight: 700; font-size: 18px;">
              ${Math.floor(Math.random() * 40) + 30}
            </div>
          </div>
        `;
        container.appendChild(analogEl);
      });
    },

    showIndicatorDetails(indicator) {
      // In a full implementation, this would show a detailed modal with:
      // - Historical chart
      // - Z-score analysis
      // - Contribution to composite
      // - Explanation of what it measures
      alert(`Detailed view for ${indicator} would appear here in a full implementation.`);
    },

    checkAlerts() {
      const alertBanner = document.getElementById('alertBanner');
      const alertMessage = document.getElementById('alertMessage');
      
      if (this.compLatest > 70) {
        alertBanner.style.display = 'flex';
        alertBanner.className = 'alert-banner danger';
        alertMessage.innerHTML = `<b>High Risk Alert:</b> Composite score of ${this.compLatest} indicates elevated crash risk. Consider defensive positioning.`;
      } else if (this.compLatest > 50) {
        alertBanner.style.display = 'flex';
        alertBanner.className = 'alert-banner';
        alertMessage.innerHTML = `<b>Moderate Risk Alert:</b> Composite score of ${this.compLatest} suggests increased market stress. Monitor indicators closely.`;
      } else {
        alertBanner.style.display = 'none';
      }
    },

    renderDiagnostics(){
      const diag=document.getElementById('diag');
      const S=this.raw?.series||{};
      const out={
        fetched_at_utc:this.raw?.fetched_at_utc||null,
        sample_sizes:Object.fromEntries(KEYS.map(k=>[k,(S[k]?.observations||[]).length])),
        latest_values:this.latestVals,
        ages_days:this.ages,
        base_weights:BASE_WEIGHTS,
        current_regime: this.currentRegime,
        regime_probability: this.regimeProbability,
        current_weights: this.getCurrentWeights(),
        composite_latest:this.compLatest,
        composite_3month: this.comp3Month,
        composite_12month: this.comp12Month,
        calculation_timestamp:new Date().toISOString()
      };
      diag.textContent=JSON.stringify(out,null,2);
    },

    renderEpisodes(){
      const tbody=document.querySelector('#episodesTable tbody');
      const wrap=document.getElementById('episodesWrap');
      tbody.innerHTML='';
      const arr=this.compMA7;
      if(!arr || !arr.length){ wrap.style.display='none'; return; }

      let prevZone=null;
      let zoneStart = 0;
      
      for(let i=0;i<arr.length;i++){
        const v=arr[i]; if(v==null) continue;
        const z=zoneOf(v);
        if(prevZone==null){ 
          prevZone=z; 
          zoneStart = i;
          continue; 
        }
        if(z!==prevZone){
          const tr=document.createElement('tr');
          const dt = this.alignedXs?.[i] ? gbDate(new Date(this.alignedXs[i]+"T00:00:00Z")) : `t-${arr.length-i}`;
          const startDt = this.alignedXs?.[zoneStart] ? gbDate(new Date(this.alignedXs[zoneStart]+"T00:00:00Z")) : `t-${arr.length-zoneStart}`;
          const duration = i - zoneStart;
          tr.innerHTML=`<td>${dt}</td><td>${zoneName(prevZone)}</td><td>${zoneName(z)}</td><td>${v.toFixed(1)}</td><td>${duration} days</td>`;
          tbody.appendChild(tr);
          prevZone=z;
          zoneStart = i;
        }
      }
      wrap.style.display = tbody.children.length? 'block':'none';
    }
  };

  // ====================== BOOT ======================
  (async ()=>{ await App.init(); })();
  </script>
</body>
</html>
