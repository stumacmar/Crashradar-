<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Economic Crash Radar Pro v7</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <style>
    :root {
      --bg:#0a0e1a;
      --panel:#12182b;
      --panel-soft:#151d33;
      --text:#e8eeff;
      --muted:#8b96b0;
      --accent:#6b9eff;
      --accent-soft:#8fb4ff;
      --green:#1ec28b;
      --amber:#ffc247;
      --red:#ff6070;
      --radius-lg:16px;
      --shadow-soft:0 8px 24px rgba(0,0,0,0.45);
      --font-main:-apple-system,BlinkMacSystemFont,"Segoe UI",system-ui,sans-serif;
    }

    *{margin:0;padding:0;box-sizing:border-box;}

    body{
      background:#050813;
      background-image:
        radial-gradient(circle at 0 0,rgba(107,158,255,0.12),transparent 55%),
        radial-gradient(circle at 100% 0,rgba(30,194,139,0.08),transparent 55%);
      color:var(--text);
      font-family:var(--font-main);
      -webkit-font-smoothing:antialiased;
    }

    .wrap{
      max-width:1400px;
      margin:0 auto;
      padding:16px 12px 40px;
    }

    header{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
      margin-bottom:12px;
    }

    .title-block h1{
      font-size:clamp(24px,4vw,32px);
      letter-spacing:0.08em;
      text-transform:uppercase;
      color:#f4f6ff;
    }

    .title-block .subtitle{
      margin-top:4px;
      font-size:0.85rem;
      color:var(--muted);
    }

    .badge-row{
      display:flex;
      flex-wrap:wrap;
      gap:6px;
      margin-top:6px;
    }

    .badge{
      padding:4px 8px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,0.12);
      background:rgba(255,255,255,0.02);
      font-size:0.75rem;
      color:var(--muted);
    }

    .alert-banner{
      margin:10px 0 14px;
      padding:8px 12px;
      background:rgba(255,255,255,0.02);
      border-radius:10px;
      border:1px solid rgba(255,255,255,0.08);
      font-size:0.8rem;
      color:var(--muted);
    }

    .status-pill{
      padding:3px 8px;
      border-radius:999px;
      font-size:0.7rem;
    }
    .status-green{background:rgba(30,194,139,0.1);color:var(--green);}
    .status-amber{background:rgba(255,194,71,0.08);color:var(--amber);}
    .status-red{background:rgba(255,96,112,0.08);color:var(--red);}

    /* === Tabs / history / micro charts === */
    .tab-container{
      margin:12px auto 18px;
      max-width:1400px;
    }
    .tab-buttons{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
    }
    .tab-button{
      padding:8px 16px;
      background:var(--panel);
      border:1px solid rgba(255,255,255,0.12);
      border-radius:8px;
      color:var(--muted);
      cursor:pointer;
      font-size:0.85rem;
    }
    .tab-button.active{
      background:var(--accent);
      color:var(--text);
    }
    .tab-content{
      display:none;
    }
    .tab-content.active{
      display:block;
    }

    .sparkline-container{
      margin-top:4px;
      height:40px;
      position:relative;
    }

    .saved-indicator{
      position:absolute;
      right:4px;
      top:4px;
      font-size:0.6rem;
      color:var(--green);
      opacity:0;
      transition:opacity 0.25s;
    }
    .saved-indicator.show{
      opacity:1;
    }

    /* === Layout / cards === */
    .dashboard{
      display:flex;
      flex-direction:column;
      gap:12px;
    }

    .grid-top{
      display:grid;
      grid-template-columns:minmax(0,1.1fr) minmax(0,0.9fr);
      gap:12px;
    }

    .grid-2{
      display:grid;
      grid-template-columns:repeat(2,minmax(0,1fr));
      gap:12px;
    }

    @media (max-width:900px){
      .grid-top,
      .grid-2{
        grid-template-columns:1fr;
      }
    }

    .card{
      background:radial-gradient(circle at 0 0,rgba(107,158,255,0.16),transparent 55%),
                 radial-gradient(circle at 100% 100%,rgba(30,194,139,0.16),transparent 55%),
                 var(--panel);
      border-radius:var(--radius-lg);
      box-shadow:var(--shadow-soft);
      padding:14px 14px 12px;
      border:1px solid rgba(255,255,255,0.06);
    }

    .card-title{
      font-size:0.9rem;
      font-weight:600;
      margin-bottom:4px;
      display:flex;
      align-items:center;
      gap:6px;
    }

    .card-subtitle{
      font-size:0.78rem;
      color:var(--muted);
      margin-bottom:10px;
    }

    .icon{
      font-size:0.9rem;
    }

    /* === Gauge === */
    .gauge-wrap{
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      gap:8px;
    }

    .gauge-main-value{
      font-size:1.7rem;
      font-weight:600;
    }
    .gauge-label{
      font-size:0.8rem;
      color:var(--muted);
    }

    .gauge-meta{
      display:flex;
      flex-wrap:wrap;
      justify-content:center;
      gap:8px;
      margin-top:4px;
      font-size:0.75rem;
      color:var(--muted);
    }

    /* === Summary box === */
    .summary-grid{
      display:grid;
      grid-template-columns:minmax(0,1.1fr) minmax(0,0.9fr);
      gap:8px;
      font-size:0.8rem;
    }
    @media (max-width:720px){
      .summary-grid{grid-template-columns:1fr;}
    }

    .summary-row{
      display:flex;
      justify-content:space-between;
      margin-bottom:4px;
    }
    .summary-label{color:var(--muted);}
    .summary-value{font-weight:500;}

    /* === Indicators === */
    .indicator-tier-label{
      font-size:0.75rem;
      text-transform:uppercase;
      letter-spacing:0.08em;
      color:var(--muted);
      margin:4px 0 6px;
    }

    .indicator-grid{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(200px,1fr));
      gap:8px;
    }

    .indicator-box{
      background:rgba(0,0,0,0.25);
      border-radius:12px;
      padding:8px 9px;
      border:1px solid rgba(255,255,255,0.05);
      position:relative;
      overflow:hidden;
    }

    .indicator-header{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:4px;
      margin-bottom:4px;
    }

    .indicator-name{
      font-size:0.8rem;
      font-weight:500;
    }

    .indicator-value{
      font-size:0.8rem;
      font-weight:500;
    }

    .indicator-threshold{
      font-size:0.74rem;
      color:var(--muted);
      margin-top:2px;
    }

    .source-tag{
      margin-top:4px;
      font-size:0.7rem;
      color:var(--muted);
      opacity:0.9;
    }

    .manual-input-row{
      margin-top:6px;
      display:flex;
      align-items:center;
      gap:6px;
      font-size:0.75rem;
      position:relative;
    }

    .manual-input-row span{
      color:var(--muted);
    }

    .manual-input{
      flex:0 0 80px;
      padding:4px 6px;
      border-radius:6px;
      border:1px solid rgba(255,255,255,0.14);
      background:rgba(0,0,0,0.4);
      color:var(--text);
      font-size:0.75rem;
    }

    /* === Valuations === */
    .valuation-box{
      background:rgba(0,0,0,0.25);
      border-radius:12px;
      padding:8px 9px;
      border:1px solid rgba(255,255,255,0.05);
      margin-bottom:8px;
      position:relative;
    }

    .valuation-header{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:4px;
      margin-bottom:4px;
    }

    .valuation-name{
      font-size:0.8rem;
      font-weight:500;
    }

    .valuation-value{
      font-size:0.8rem;
      font-weight:500;
    }

    /* === History tab === */
    .chart-container{
      margin-top:6px;
      position:relative;
      height:260px;
    }

    .history-note{
      font-size:0.72rem;
      color:var(--muted);
      margin-top:8px;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="title-block">
        <h1>Economic Crash Radar Pro</h1>
        <div class="subtitle">
          Live composite stress gauge â€“ macro fragility + market valuations
        </div>
        <div class="badge-row">
          <div class="badge">Composite: macro 70% Â· valuations 30%</div>
          <div class="badge">Data source: FRED cache + manual inputs</div>
          <div class="badge" id="data-stamp">Cache: --</div>
        </div>
      </div>
    </header>

    <div class="alert-banner" id="alert-banner">
      Composite stress = 70% macro block + 30% valuation block when both are available; otherwise uses whichever block is populated.
    </div>

    <!-- Tabs -->
    <div class="tab-container">
      <div class="tab-buttons">
        <button class="tab-button active" onclick="switchTab(event,'dashboard')">Dashboard</button>
        <button class="tab-button" onclick="switchTab(event,'history')">History</button>
      </div>
    </div>

    <!-- DASHBOARD TAB -->
    <div class="tab-content active" id="dashboard-tab">
      <div class="dashboard">

        <div class="grid-top">
          <!-- Gauge -->
          <div class="card">
            <div class="card-title"><span class="icon">ðŸ§­</span>Composite Crash Risk</div>
            <div class="card-subtitle">Smoothed 0â€“100 stress score combining macro & valuations</div>
            <div class="gauge-wrap">
              <canvas id="composite-gauge" width="260" height="260"></canvas>
              <div class="gauge-main-value" id="gauge-main">--</div>
              <div class="gauge-label" id="gauge-label">Waiting for dataâ€¦</div>
              <div class="gauge-meta">
                <div id="gauge-macro-pill" class="status-pill status-green">Macro: --</div>
                <div id="gauge-val-pill" class="status-pill status-green">Valuations: --</div>
              </div>
            </div>
          </div>

          <!-- Summary -->
          <div class="card">
            <div class="card-title"><span class="icon">ðŸ“Š</span>Risk Decomposition</div>
            <div class="card-subtitle">Macro block groups vs valuation pressure</div>
            <div class="summary-grid">
              <div>
                <div class="summary-row">
                  <span class="summary-label">Macro stress</span>
                  <span class="summary-value" id="macro-score-label">--</span>
                </div>
                <div class="summary-row">
                  <span class="summary-label">Valuation stress</span>
                  <span class="summary-value" id="val-score-label">--</span>
                </div>
                <div class="summary-row">
                  <span class="summary-label">Composite (0â€“100)</span>
                  <span class="summary-value" id="comp-score-label">--</span>
                </div>
                <div class="summary-row">
                  <span class="summary-label">Regime</span>
                  <span class="summary-value" id="regime-label">--</span>
                </div>
              </div>
              <div>
                <div class="summary-row">
                  <span class="summary-label">Macro â‰¥ 2 reds?</span>
                  <span class="summary-value" id="macro-reds-label">--</span>
                </div>
                <div class="summary-row">
                  <span class="summary-label">Valuations â‰¥ 2 reds?</span>
                  <span class="summary-value" id="val-reds-label">--</span>
                </div>
                <div class="summary-row">
                  <span class="summary-label">Total red flags</span>
                  <span class="summary-value" id="total-reds-label">--</span>
                </div>
                <div class="summary-row">
                  <span class="summary-label">Override status</span>
                  <span class="summary-value" id="override-label">None</span>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Macro KPIs + Valuations -->
        <div class="grid-2">
          <div class="card">
            <div class="card-title"><span class="icon">ðŸ“‰</span>Macro Stress KPIs</div>
            <div class="card-subtitle">Tier 1 are primary recession/funding signals; Tier 2 supporting</div>

            <div class="indicator-tier-label">Tier 1 â€“ Primary</div>
            <div class="indicator-grid" id="indicator-tier-1"></div>

            <div class="indicator-tier-label" style="margin-top:10px;">Tier 2 â€“ Secondary</div>
            <div class="indicator-grid" id="indicator-tier-2"></div>
          </div>

          <div class="card">
            <div class="card-title"><span class="icon">ðŸ’¸</span>Valuations</div>
            <div class="card-subtitle">Buffett, Shiller PE, Dow/Gold â€“ manual with persistence</div>
            <div id="valuation-container"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- HISTORY TAB -->
    <div class="tab-content" id="history-tab">
      <div class="card">
        <div class="card-title"><span class="icon">ðŸ“ˆ</span>Composite Score History</div>
        <div class="card-subtitle">Placeholder â€“ wiring to full FRED history is still to do</div>
        <div class="chart-container">
          <canvas id="composite-history-chart"></canvas>
        </div>
        <div class="history-note">
          This chart currently uses synthetic placeholder data based on todayâ€™s composite.
          To avoid bullshit, it is <strong>not</strong> claiming to be back-tested from FRED.  
          Once we expose your composite function over full fred_cache history, we can replace this with a real series.
        </div>
      </div>
    </div>
  </div>

  <script>
  'use strict';

  // -------------------------
  // CONFIG / STATE
  // -------------------------

  const INDICATORS = {
    T10Y3M: {
      label: 'Yield curve: 10Yâ€“3M',
      desc: 'Medium-term recession signal. Deep inversion is bad.',
      fromFred: true,
      fredId: 'T10Y3M',
      tier: 1,
      direction: 'lower-worse',   // more negative = worse
      green: -0.1,
      amber: -0.5,                // below this gets red
      formatter: (v) => v.toFixed(2) + ' pts',
      current: null
    },
    CREDIT: {
      label: 'HY credit spread',
      desc: 'US HY option-adjusted spread (BAMLH0A0HYM2).',
      fromFred: true,
      fredId: 'BAMLH0A0HYM2',
      tier: 1,
      direction: 'higher-worse',
      green: 3.5,
      amber: 6.0,
      formatter: (v) => v.toFixed(2) + ' %',
      current: null
    },
    NFCI: {
      label: 'Chicago NFCI',
      desc: 'Financial conditions index, above 0 = tight.',
      fromFred: true,
      fredId: 'NFCI',
      tier: 1,
      direction: 'higher-worse',
      green: 0.0,
      amber: 0.5,
      formatter: (v) => v.toFixed(2),
      current: null
    },
    VIX_PROXY: {
      label: 'Volatility (VIX proxy)',
      desc: 'Implied equity vol; persistent high vol = stress.',
      fromFred: true,
      fredId: 'VIXCLS',
      tier: 2,
      direction: 'higher-worse',
      green: 20,
      amber: 30,
      formatter: (v) => v.toFixed(1),
      current: null
    },
    RETAIL_MOMENTUM: {
      label: 'Real retail momentum',
      desc: 'Retail sales YoY / trend proxy.',
      fromFred: true,
      fredId: 'RSAFS',
      tier: 2,
      direction: 'lower-worse',
      green: 0,
      amber: -5,
      formatter: (v) => v.toFixed(1) + ' %',
      current: null
    },
    SENTIMENT: {
      label: 'UMich consumer sentiment',
      desc: 'Household sentiment: extremes often mark cycles.',
      fromFred: true,
      fredId: 'UMCSENT',
      tier: 2,
      direction: 'lower-worse',
      green: 70,
      amber: 60,
      formatter: (v) => v.toFixed(1),
      current: null
    },
    LEI: {
      label: 'Conf. Board LEI (6m %Î”)',
      desc: 'Manual input: latest 6-month % change in LEI.',
      fromFred: false,
      tier: 1,
      direction: 'lower-worse',
      green: -2,
      amber: -4,
      formatter: (v) => v.toFixed(1) + ' %',
      current: null
    }
  };

  const VALUATIONS = {
    BUFFETT: {
      label: 'Buffett indicator',
      desc: 'Total US market cap / GDP (%).',
      green: 150,
      amber: 200,
      current: null
    },
    SHILLER_PE: {
      label: 'Shiller CAPE',
      desc: 'Cyclically adjusted US PE ratio.',
      green: 25,
      amber: 30,
      current: null
    },
    DOW_GOLD: {
      label: 'Dow / Gold ratio',
      desc: 'Equities vs hard asset valuation regime.',
      green: 12,
      amber: 16,
      current: null
    }
  };

  let fredSeries = {};
  let compositeScore = null;
  let macroScore = null;
  let valScore = null;

  let gaugeChart = null;
  let historyChart = null;
  let manualOverrides = {};

  // -------------------------
  // UTIL
  // -------------------------

  function safeNumber(v){
    const n = typeof v === 'number' ? v : parseFloat(v);
    return Number.isFinite(n) ? n : null;
  }

  function stressFromThresholds(value, cfg){
    if (value === null || value === undefined) return null;
    const v = value;

    const dir = cfg.direction || 'higher-worse';
    const g = cfg.green;
    const a = cfg.amber;

    // Map to 0â€“100 with a gentle S-shape
    if (dir === 'higher-worse'){
      if (v <= g) return 20 * (v / g);      // sub-green
      if (v <= a){
        const t = (v - g) / (a - g);
        return 20 + t * 50;                 // 20â€“70
      }
      const t = Math.min(1, (v - a) / Math.max(1, Math.abs(a)));
      return 70 + t * 30;                   // 70â€“100
    } else {
      // lower-worse (e.g. yield curve, LEI)
      if (v >= g) return 20 * (g / v);      // safely above green
      if (v >= a){
        const t = (g - v) / (g - a);
        return 20 + t * 50;
      }
      const t = Math.min(1, (a - v) / Math.max(1, Math.abs(a)));
      return 70 + t * 30;
    }
  }

  function ragClass(score){
    if (!Number.isFinite(score)) return 'status-green';
    if (score < 40) return 'status-green';
    if (score < 70) return 'status-amber';
    return 'status-red';
  }

  function ragText(score){
    if (!Number.isFinite(score)) return '--';
    if (score < 40) return 'Calm / benign';
    if (score < 70) return 'Watchful / mid-risk';
    return 'Stressed / late-cycle';
  }

  function formatIndicatorValue(key, v){
    const cfg = INDICATORS[key];
    if (!Number.isFinite(v)) return '--';
    if (cfg && typeof cfg.formatter === 'function'){
      try { return cfg.formatter(v); } catch(e){ return v.toFixed(2); }
    }
    return v.toFixed(2);
  }

  // -------------------------
  // FRED CACHE LOADER
  // -------------------------

  async function loadFromFredCache(){
    const res = await fetch('data/fred_cache.json?_=' + Date.now());
    if (!res.ok) throw new Error('Failed to fetch fred_cache.json: ' + res.status);
    const json = await res.json();
    const series = json.series || json;
    fredSeries = series || {};

    // Cache timestamp if available
    if (json.generated_at){
      const stampEl = document.getElementById('data-stamp');
      if (stampEl){
        stampEl.textContent = 'Cache: ' + json.generated_at;
      }
    }

    Object.entries(INDICATORS).forEach(([key, cfg]) => {
      if (!cfg.fromFred || !cfg.fredId) return;
      const s = series[cfg.fredId];
      if (!s) return;
      const v = safeNumber(s.value);
      if (v !== null) cfg.current = v;
    });
  }

  // -------------------------
  // LOCALSTORAGE OVERRIDES
  // -------------------------

  function loadManualOverrides(){
    try{
      const stored = localStorage.getItem('cr_manualOverrides');
      if (!stored) return;
      manualOverrides = JSON.parse(stored) || {};

      if (manualOverrides.LEI !== undefined){
        const v = safeNumber(manualOverrides.LEI);
        if (v !== null && INDICATORS.LEI){
          INDICATORS.LEI.current = v;
        }
      }
      if (manualOverrides.BUFFETT !== undefined){
        const v = safeNumber(manualOverrides.BUFFETT);
        if (v !== null && VALUATIONS.BUFFETT){
          VALUATIONS.BUFFETT.current = v;
        }
      }
      if (manualOverrides.SHILLER_PE !== undefined){
        const v = safeNumber(manualOverrides.SHILLER_PE);
        if (v !== null && VALUATIONS.SHILLER_PE){
          VALUATIONS.SHILLER_PE.current = v;
        }
      }
    }catch(err){
      console.error('Error loading manual overrides', err);
    }
  }

  function persistOverride(key, value, isValuation){
    const n = safeNumber(value);
    if (n === null){
      delete manualOverrides[key];
    } else {
      manualOverrides[key] = n;
    }
    try{
      localStorage.setItem('cr_manualOverrides', JSON.stringify(manualOverrides));
    }catch(e){
      console.error('Error saving manual overrides', e);
    }

    const id = isValuation ? ('saved-val-' + key) : ('saved-' + key);
    const el = document.getElementById(id);
    if (el){
      el.classList.add('show');
      setTimeout(() => el.classList.remove('show'), 1800);
    }
  }

  // -------------------------
  // RENDER: INDICATORS
  // -------------------------

  function buildIndicatorBox(key, cfg){
    const value = safeNumber(cfg.current);
    const stress = stressFromThresholds(value, cfg);
    const valueText = formatIndicatorValue(key, value);
    const stressText = Number.isFinite(stress) ? ('Stress: ' + Math.round(stress) + '/100') : 'Stress: --';

    const box = document.createElement('div');
    box.className = 'indicator-box';
    box.dataset.indicatorKey = key;

    const src = cfg.fromFred ? 'Auto from FRED' : 'Manual input';

    const savedIndicator = !cfg.fromFred
      ? '<span class="saved-indicator" id="saved-'+key+'">âœ“ saved</span>'
      : '';

    let manualHtml = '';
    if (!cfg.fromFred && key === 'LEI'){
      manualHtml =
        '<div class="manual-input-row">' +
          '<span>Set latest 6m %Î”:</span>' +
          '<input class="manual-input" type="number" step="0.1" data-ind-key="'+key+'" value="'+(value !== null ? value : '')+'">' +
          savedIndicator +
        '</div>';
    }

    const sparkHtml = cfg.fromFred && cfg.fredId
      ? '<div class="sparkline-container" id="spark-'+key+'"></div>'
      : '';

    box.innerHTML =
      '<div class="indicator-header">' +
        '<div class="indicator-name">'+cfg.label+'</div>' +
        '<div class="indicator-value" data-ind-value="'+key+'">'+valueText+'</div>' +
      '</div>' +
      '<div class="indicator-threshold" data-ind-stress="'+key+'">'+stressText+'</div>' +
      '<div class="indicator-threshold">'+cfg.desc+'</div>' +
      '<div class="source-tag">'+src+'</div>' +
      sparkHtml +
      manualHtml;

    return box;
  }

  function renderIndicators(){
    const t1 = document.getElementById('indicator-tier-1');
    const t2 = document.getElementById('indicator-tier-2');
    if (!t1 || !t2) return;

    t1.innerHTML = '';
    t2.innerHTML = '';

    Object.entries(INDICATORS).forEach(([key, cfg]) => {
      const el = buildIndicatorBox(key, cfg);
      if (cfg.tier === 1) t1.appendChild(el);
      else t2.appendChild(el);
    });

    // Wire manual indicator inputs (LEI)
    document.querySelectorAll('.manual-input[data-ind-key]').forEach(inp => {
      inp.addEventListener('input', () => {
        const key = inp.getAttribute('data-ind-key');
        const cfg = INDICATORS[key];
        if (!cfg) return;
        const v = safeNumber(inp.value);
        cfg.current = v;
        persistOverride(key, v, false);

        const valEl = document.querySelector('[data-ind-value="'+key+'"]');
        if (valEl){
          valEl.textContent = v !== null ? formatIndicatorValue(key, v) : '--';
        }
        updateAll(false); // recompute but avoid re-building entire DOM again
      });
    });

    // Render sparkline placeholders
    setTimeout(() => {
      Object.entries(INDICATORS).forEach(([k, cfg]) => {
        if (cfg.fromFred && cfg.fredId){
          renderSparkline(k, cfg.fredId);
        }
      });
    }, 80);
  }

  // -------------------------
  // RENDER: VALUATIONS
  // -------------------------

  function computeValuationStress(key, v){
    const cfg = VALUATIONS[key];
    const value = safeNumber(v);
    if (!cfg || value === null) return null;
    const g = cfg.green;
    const a = cfg.amber;

    if (value <= g) return 25 * (value / g); // very rough, but monotonic
    if (value <= a){
      const t = (value - g) / (a - g);
      return 25 + 45 * t;
    }
    const t = Math.min(1, (value - a) / Math.max(1, a));
    return 70 + 30 * t;
  }

  function renderValuations(){
    const container = document.getElementById('valuation-container');
    if (!container) return;
    container.innerHTML = '';

    Object.entries(VALUATIONS).forEach(([key, cfg]) => {
      const v = safeNumber(cfg.current);
      const stress = computeValuationStress(key, v);

      const hasVal = v !== null;
      const valueText = hasVal ? v.toFixed(1) : '--';
      const stressText = Number.isFinite(stress)
        ? ('Stress: ' + Math.round(stress) + '/100')
        : 'Stress: --';

      let dangerLabel = '';
      if (key === 'BUFFETT') dangerLabel = 'Danger band: > '+cfg.amber.toFixed(0)+'%';
      if (key === 'SHILLER_PE') dangerLabel = 'Danger band: > '+cfg.amber.toFixed(0)+'x';
      if (key === 'DOW_GOLD') dangerLabel = 'Danger band: > '+cfg.amber.toFixed(0);

      const div = document.createElement('div');
      div.className = 'valuation-box';
      div.innerHTML =
        '<div class="valuation-header">' +
          '<div class="valuation-name">'+cfg.label+'</div>' +
          '<div class="valuation-value" data-val-value="'+key+'">'+valueText+'</div>' +
        '</div>' +
        (dangerLabel ? '<div class="indicator-threshold">'+dangerLabel+'</div>' : '') +
        '<div class="indicator-threshold">'+cfg.desc+'</div>' +
        '<div class="source-tag">Manual input</div>' +
        '<div class="manual-input-row">' +
          '<span>Set current reading:</span>' +
          '<input class="manual-input" type="number" step="0.1" data-val-key="'+key+'" value="'+(hasVal ? v : '')+'">' +
          '<span class="saved-indicator" id="saved-val-'+key+'">âœ“ saved</span>' +
        '</div>';

      container.appendChild(div);
    });

    document.querySelectorAll('.manual-input[data-val-key]').forEach(inp => {
      inp.addEventListener('input', () => {
        const key = inp.getAttribute('data-val-key');
        const cfg = VALUATIONS[key];
        if (!cfg) return;
        const v = safeNumber(inp.value);
        cfg.current = v;
        persistOverride(key, v, true);

        const valEl = document.querySelector('[data-val-value="'+key+'"]');
        if (valEl){
          valEl.textContent = v !== null ? v.toFixed(1) : '--';
        }
        updateAll(false);
      });
    });
  }

  // -------------------------
  // COMPOSITE CALC / GAUGE
  // -------------------------

  function computeMacroScore(){
    let sum = 0;
    let count = 0;
    Object.entries(INDICATORS).forEach(([key, cfg]) => {
      const value = safeNumber(cfg.current);
      const s = stressFromThresholds(value, cfg);
      if (Number.isFinite(s)){
        sum += s;
        count += 1;
      }
    });
    return count ? sum / count : null;
  }

  function computeValScore(){
    let sum = 0;
    let count = 0;
    Object.entries(VALUATIONS).forEach(([key, cfg]) => {
      const s = computeValuationStress(key, cfg.current);
      if (Number.isFinite(s)){
        sum += s;
        count += 1;
      }
    });
    return count ? sum / count : null;
  }

  function computeComposite(macro, val){
    if (!Number.isFinite(macro) && !Number.isFinite(val)) return null;
    if (!Number.isFinite(val)) return macro;
    if (!Number.isFinite(macro)) return val;
    return macro * 0.7 + val * 0.3;
  }

  function initGauge(){
    const canvas = document.getElementById('composite-gauge');
    if (!canvas || !window.Chart) return;

    const ctx = canvas.getContext('2d');
    const rootStyles = getComputedStyle(document.documentElement);
    const green = '#1ec28b';
    const amber = '#ffc247';
    const red = '#ff6070';

    if (gaugeChart){
      gaugeChart.destroy();
      gaugeChart = null;
    }

    gaugeChart = new Chart(ctx, {
      type: 'doughnut',
      data: {
        labels: ['Low', 'Medium', 'High'],
        datasets: [{
          data: [40, 30, 30],
          backgroundColor: [green, amber, red],
          borderWidth:0,
          circumference:180,
          rotation:270,
          cutout:'78%'
        }]
      },
      options: {
        responsive:true,
        plugins: {
          legend:{display:false},
          tooltip:{enabled:false}
        }
      }
    });
  }

  function updateGauge(score){
    const main = document.getElementById('gauge-main');
    const label = document.getElementById('gauge-label');
    if (!main || !label) return;

    if (!Number.isFinite(score)){
      main.textContent = '--';
      label.textContent = 'Waiting for enough dataâ€¦';
      return;
    }
    main.textContent = Math.round(score) + ' / 100';
    label.textContent = ragText(score);
  }

  // -------------------------
  // HISTORY CHART (PLACEHOLDER)
  // -------------------------

  function renderHistoryChart(){
    const canvas = document.getElementById('composite-history-chart');
    if (!canvas || !window.Chart) return;

    const ctx = canvas.getContext('2d');
    if (historyChart){
      historyChart.destroy();
      historyChart = null;
    }

    const labels = [];
    const data = [];
    const nowScore = Number.isFinite(compositeScore) ? compositeScore : 40;

    // simple synthetic curve around current score â€“ clearly labeled as fake
    for (let i = 11; i >= 0; i--){
      labels.push(`T-${i}`);
      const noise = (Math.sin(i * 0.7) * 5);
      data.push(Math.max(0, Math.min(100, nowScore + noise)));
    }

    const rootStyles = getComputedStyle(document.documentElement);
    const accent = rootStyles.getPropertyValue('--accent').trim() || '#6b9eff';

    historyChart = new Chart(ctx, {
      type:'line',
      data:{
        labels,
        datasets:[{
          label:'Composite (placeholder)',
          data,
          borderColor:accent,
          backgroundColor:'rgba(107,158,255,0.15)',
          tension:0.3,
          fill:true,
          pointRadius:0,
          pointHoverRadius:3
        }]
      },
      options:{
        responsive:true,
        plugins:{
          legend:{display:false},
          tooltip:{
            callbacks:{
              label:(c) => 'Stress: ' + Math.round(c.parsed.y) + '%'
            }
          }
        },
        scales:{
          y:{
            min:0,
            max:100,
            ticks:{color:'var(--muted)',font:{size:10}},
            grid:{color:'rgba(255,255,255,0.08)'}
          },
          x:{
            ticks:{color:'var(--muted)',font:{size:9}},
            grid:{color:'rgba(255,255,255,0.04)'}
          }
        }
      }
    });
  }

  // -------------------------
  // SPARKLINE PLACEHOLDERS
  // -------------------------

  function renderSparkline(indicatorKey, fredId){
    const container = document.getElementById('spark-' + indicatorKey);
    if (!container) return;
    container.innerHTML =
      '<div style="font-size:0.6rem;color:var(--muted);padding:4px;">' +
        'Historical '+fredId+' series loaded in fred_cache â€“ sparkline wiring pending.' +
      '</div>';
  }

  // -------------------------
  // TABS
  // -------------------------

  function switchTab(evt, tabName){
    document.querySelectorAll('.tab-button').forEach(btn => {
      btn.classList.remove('active');
    });
    document.querySelectorAll('.tab-content').forEach(c => {
      c.classList.remove('active');
    });

    if (evt && evt.target){
      evt.target.classList.add('active');
    }
    const tab = document.getElementById(tabName + '-tab');
    if (tab) tab.classList.add('active');

    if (tabName === 'history'){
      renderHistoryChart();
    }
  }

  window.switchTab = switchTab; // expose for inline onclick

  // -------------------------
  // MASTER UPDATE
  // -------------------------

  function updateSummaryAndGauge(){
    macroScore = computeMacroScore();
    valScore = computeValScore();
    compositeScore = computeComposite(macroScore, valScore);

    const macroLabel = document.getElementById('macro-score-label');
    const valLabel = document.getElementById('val-score-label');
    const compLabel = document.getElementById('comp-score-label');
    const regimeLabel = document.getElementById('regime-label');
    const macroPill = document.getElementById('gauge-macro-pill');
    const valPill = document.getElementById('gauge-val-pill');

    if (macroLabel) macroLabel.textContent = Number.isFinite(macroScore) ? Math.round(macroScore) + '/100' : '--';
    if (valLabel) valLabel.textContent = Number.isFinite(valScore) ? Math.round(valScore) + '/100' : '--';
    if (compLabel) compLabel.textContent = Number.isFinite(compositeScore) ? Math.round(compositeScore) + '/100' : '--';

    const macroCls = ragClass(macroScore);
    const valCls = ragClass(valScore);
    if (macroPill){
      macroPill.className = 'status-pill ' + macroCls;
      macroPill.textContent = 'Macro: ' + (Number.isFinite(macroScore) ? Math.round(macroScore) : '--');
    }
    if (valPill){
      valPill.className = 'status-pill ' + valCls;
      valPill.textContent = 'Valuations: ' + (Number.isFinite(valScore) ? Math.round(valScore) : '--');
    }

    if (regimeLabel){
      regimeLabel.textContent = ragText(compositeScore);
    }

    // crude red-flag counts
    let macroReds = 0;
    Object.entries(INDICATORS).forEach(([key, cfg]) => {
      const s = stressFromThresholds(cfg.current, cfg);
      if (Number.isFinite(s) && s >= 70) macroReds++;
    });
    let valReds = 0;
    Object.entries(VALUATIONS).forEach(([key, cfg]) => {
      const s = computeValuationStress(key, cfg.current);
      if (Number.isFinite(s) && s >= 70) valReds++;
    });

    const macroRedsLabel = document.getElementById('macro-reds-label');
    const valRedsLabel = document.getElementById('val-reds-label');
    const totalRedsLabel = document.getElementById('total-reds-label');
    const overrideLabel = document.getElementById('override-label');

    if (macroRedsLabel) macroRedsLabel.textContent = macroReds >= 2 ? 'Yes ('+macroReds+')' : 'No ('+macroReds+')';
    if (valRedsLabel) valRedsLabel.textContent = valReds >= 2 ? 'Yes ('+valReds+')' : 'No ('+valReds+')';
    const totalReds = macroReds + valReds;
    if (totalRedsLabel) totalRedsLabel.textContent = String(totalReds);

    let override = 'None';
    if (totalReds >= 3) override = 'TOTAL MAYHEM (Red)';
    else if (totalReds >= 2) override = 'Heightened (Amber+)';
    if (overrideLabel) overrideLabel.textContent = override;

    const banner = document.getElementById('alert-banner');
    if (banner){
      banner.textContent =
        'Composite stress = 70% macro block + 30% valuation block when both are available; ' +
        'currently macro: ' + (Number.isFinite(macroScore) ? Math.round(macroScore) : '--') +
        ', valuations: ' + (Number.isFinite(valScore) ? Math.round(valScore) : '--') +
        ', composite: ' + (Number.isFinite(compositeScore) ? Math.round(compositeScore) : '--') +
        '. Override: ' + override + '.';
    }

    updateGauge(compositeScore);
  }

  function updateAll(rebuildDom = true){
    if (rebuildDom){
      renderIndicators();
      renderValuations();
    }
    updateSummaryAndGauge();
  }

  // -------------------------
  // BOOTSTRAP
  // -------------------------

  document.addEventListener('DOMContentLoaded', () => {
    loadManualOverrides();  // make sure saved LEI / Buffett / Shiller are in memory
    initGauge();

    loadFromFredCache()
      .catch(err => {
        console.error(err);
      })
      .finally(() => {
        // Even if fred_cache fails, UI will still render with whatever we have
        updateAll(true);
      });
  });
  </script>
</body>
</html>
