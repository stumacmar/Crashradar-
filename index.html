<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Economic Stress Index (ESI) - CrashRadar Core</title>
<style>
:root{
  --bg:#0a0e1a; --panel:#12182b; --panel-hover:#151d33; --text:#e8eeff; --muted:#8b96b0;
  --accent:#6b9eff; --accent-bright:#8fb4ff; --green:#1ec28b; --amber:#ffc247; --red:#ff6070;
  --purple:#a78bfa; --cyan:#22d3ee;
}
*{box-sizing:border-box;margin:0;padding:0}
body{
  background:var(--bg);
  color:var(--text);
  font:15px/1.6 -apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
  -webkit-font-smoothing:antialiased;
}
.wrap{max-width:1600px;margin:0 auto;padding:24px 16px 80px}
h1{
  font-size:clamp(32px,5vw,48px);
  line-height:1.1;
  font-weight:800;
  margin-bottom:6px;
  background:linear-gradient(135deg,var(--text),var(--accent-bright));
  -webkit-background-clip:text;
  -webkit-text-fill-color:transparent;
  letter-spacing:-.02em
}
.subtitle{
  color:var(--muted);
  font-weight:500;
  font-size:13px;
  max-width:640px;
}
.header{
  display:flex;
  justify-content:space-between;
  align-items:flex-start;
  gap:16px;
  flex-wrap:wrap;
  margin-bottom:18px
}
.badges{
  display:flex;
  gap:10px;
  flex-wrap:wrap;
  margin-top:10px
}
.badge{
  display:inline-flex;
  align-items:center;
  gap:6px;
  padding:7px 11px;
  border:1px solid rgba(255,255,255,.08);
  background:rgba(255,255,255,.04);
  border-radius:9px;
  font-weight:600;
  font-size:11px;
  color:var(--muted)
}
.live-dot{
  width:7px;height:7px;border-radius:50%;background:var(--green);
  box-shadow:0 0 8px var(--green)
}
.btn{
  display:inline-flex;
  align-items:center;
  gap:8px;
  padding:9px 14px;
  border:none;
  border-radius:10px;
  background:var(--accent);
  color:#fff;
  font-weight:700;
  cursor:pointer;
  transition:all 0.2s ease;
  font-size:13px
}
.btn:hover{background:var(--accent-bright);transform:translateY(-1px)}
.card{
  background:var(--panel);
  border:1px solid rgba(255,255,255,.06);
  border-radius:16px;
  padding:20px;
  margin:16px 0;
  box-shadow:0 4px 24px rgba(0,0,0,.3);
  transition:all 0.3s ease
}
.card:hover{box-shadow:0 8px 32px rgba(0,0,0,.4)}
.status-pill{
  display:inline-flex;
  align-items:center;
  gap:10px;
  padding:10px 16px;
  border:1px solid rgba(255,255,255,.1);
  border-radius:12px;
  background:rgba(255,255,255,.04);
  font-weight:700;
  font-size:14px;
  margin-top:4px
}
.alert{
  border-radius:14px;
  padding:14px;
  margin-top:12px;
  background:linear-gradient(135deg,rgba(255,96,112,.12),rgba(255,194,71,.12));
  border:1px solid rgba(255,96,112,.25);
  font-size:13px
}
.tabs{
  display:flex;
  gap:8px;
  border-bottom:2px solid rgba(255,255,255,.06);
  margin-top:8px;
  overflow-x:auto;
  -webkit-overflow-scrolling:touch
}
.tab{
  background:transparent;
  border:none;
  color:var(--muted);
  padding:10px 14px;
  font-weight:700;
  cursor:pointer;
  border-radius:8px 8px 0 0;
  transition:all 0.2s ease;
  white-space:nowrap;
  font-size:12px
}
.tab.active{
  color:var(--accent-bright);
  background:rgba(255,255,255,.03)
}
.tab:hover:not(.active){
  color:var(--text);
  background:rgba(255,255,255,.02)
}
.view{display:none;animation:fadeIn 0.3s ease}
.view.active{display:block}
@keyframes fadeIn{from{opacity:0}to{opacity:1}}

.gauge{
  display:flex;
  gap:24px;
  align-items:center;
  flex-wrap:wrap
}
.gauge-wrap{
  position:relative;
  width:220px;
  height:220px;
  flex-shrink:0
}
.ring{
  position:absolute;
  inset:0;
  border-radius:50%;
  background:conic-gradient(var(--green) 0 70deg,var(--amber) 70deg 130deg,var(--red) 130deg 180deg);
  opacity:.35;
  transform:rotate(-90deg);
}
.ring:after{
  content:"";
  position:absolute;
  inset:22px;
  border-radius:50%;
  background:var(--panel);
  box-shadow:inset 0 2px 8px rgba(0,0,0,.35)
}
.needle{
  position:absolute;
  inset:0;
}
.needle:before{
  content:"";
  position:absolute;
  top:50%;
  left:50%;
  width:5px;
  height:46%;
  transform-origin:bottom center;
  transform:translate(-50%,-100%) rotate(var(--angle,0deg));
  background:linear-gradient(180deg,var(--accent-bright),var(--accent));
  border-radius:5px 5px 0 0;
  box-shadow:0 0 10px var(--accent);
  transition:transform 0.8s ease;
}
.needle:after{
  content:"";
  position:absolute;
  top:50%;
  left:50%;
  width:16px;
  height:16px;
  border-radius:50%;
  background:var(--accent-bright);
  transform:translate(-50%,-50%);
}
.score{
  position:absolute;
  inset:0;
  display:flex;
  align-items:center;
  justify-content:center;
  flex-direction:column;
  font-weight:800;
  z-index:1
}
.score .v{
  font-size:46px;
  background:linear-gradient(135deg,var(--text),var(--accent-bright));
  -webkit-background-clip:text;
  -webkit-text-fill-color:transparent
}
.score .l{
  font-size:10px;
  color:var(--muted);
  letter-spacing:1px;
  margin-top:4px;
  text-align:center
}

.kpi-grid{
  display:grid;
  grid-template-columns:repeat(auto-fill,minmax(260px,1fr));
  gap:10px;
  margin-top:8px
}
.kpi{
  border:1px solid rgba(255,255,255,.06);
  border-radius:10px;
  padding:10px 10px 9px;
  background:rgba(255,255,255,.02);
  transition:all 0.2s ease
}
.kpi:hover{
  border-color:rgba(255,255,255,.12);
  background:rgba(255,255,255,.04);
  transform:translateY(-1px)
}
.kpi h4{
  display:flex;
  align-items:center;
  justify-content:space-between;
  font-size:12px;
  margin-bottom:4px
}
.dot{
  width:9px;height:9px;border-radius:50%;
}
.dot.g{background:var(--green);box-shadow:0 0 8px var(--green)}
.dot.a{background:var(--amber);box-shadow:0 0 8px var(--amber)}
.dot.r{background:var(--red);box-shadow:0 0 8px var(--red)}
.small{font-size:10px;color:var(--muted)}
.val{font-size:18px;font-weight:700;margin:4px 0 2px}
.zscore{font-size:11px;font-weight:600;color:var(--accent-bright);margin-bottom:2px}
.desc{
  font-size:10px;
  color:var(--muted);
  margin-top:4px;
  line-height:1.5;
}
.category-header{
  background:linear-gradient(135deg,rgba(107,158,255,.16),rgba(139,187,255,.06));
  border:1px solid rgba(107,158,255,.25);
  border-radius:9px;
  padding:8px 10px;
  margin:10px 0 6px;
  font-weight:700;
  font-size:12px;
  color:var(--accent-bright)
}
.insight-card{
  background:linear-gradient(135deg,rgba(107,158,255,.08),rgba(139,187,255,.03));
  border:1px solid rgba(107,158,255,.18);
  border-radius:10px;
  padding:10px;
  margin-top:10px;
  font-size:11px;
}
.insight-card h4{
  display:flex;
  align-items:center;
  gap:6px;
  margin-bottom:4px;
  color:var(--accent-bright);
  font-size:12px;
}
.methodology{
  background:rgba(255,255,255,.02);
  border:1px solid rgba(255,255,255,.06);
  border-radius:12px;
  padding:12px;
  margin-top:10px;
  font-size:10px;
  color:var(--muted);
}
.methodology h4{
  font-size:11px;
  margin-bottom:4px;
  color:var(--accent-bright)
}
.methodology ul{margin-left:16px;margin-top:4px}
.methodology li{margin:4px 0}
.audit-list{
  font-size:10px;
  color:var(--muted);
  margin-top:4px;
}
.audit-list div{margin-bottom:2px}
@media (max-width:768px){
  .gauge{flex-direction:column;align-items:center}
  .wrap{padding:16px 10px 40px}
  h1{font-size:26px}
  .header{flex-direction:column;align-items:stretch}
  .kpi-grid{grid-template-columns:1fr}
  .gauge-wrap{width:190px;height:190px}
  .score .v{font-size:38px}
}
</style>
</head>
<body>
<div class="wrap">
  <div class="header">
    <div>
      <h1>üìä Economic Stress Index (ESI)</h1>
      <div class="subtitle">
        U.S. stress monitor using cached FRED data from GitHub Actions.
        Transparent rules. No fake endorsements. Calibrate and backtest before you size risk.
      </div>
      <div class="badges">
        <div class="badge"><span class="live-dot"></span><span id="dataMode">Loading cache‚Ä¶</span></div>
        <div class="badge" id="upd">Updated: --</div>
        <div class="badge">11 indicators ‚Ä¢ stress-aligned z-scores ‚Ä¢ 60 / 30 / 10 weighting</div>
        <div class="badge">Equal-weight inside buckets (simple, auditable)</div>
      </div>
    </div>
    <div style="display:flex;gap:8px;flex-wrap:wrap">
      <button class="btn" id="refreshBtn">üîÑ Refresh (from cache)</button>
      <button class="btn" id="exportBtn">üì• Export snapshot JSON</button>
    </div>
  </div>

  <div class="status-pill" id="regime">
    <span style="width:12px;height:12px;border-radius:50%;background:var(--amber);box-shadow:0 0 10px var(--amber)"></span>
    <span>ESI Z-Score: -- | Not computed</span>
  </div>

  <div class="alert" id="alert" style="display:none"></div>

  <div class="card">
    <div class="gauge">
      <div class="gauge-wrap">
        <div class="ring"></div>
        <div class="needle" id="needle"></div>
        <div class="score">
          <div class="v" id="scoreV">--</div>
          <div class="l">ESI STANDARDIZED SCORE (œÉ)</div>
        </div>
      </div>
      <div style="flex:1;min-width:260px">
        <h2 style="margin:0 0 4px;font-size:18px">Economic Stress Index ‚Äî Core Read</h2>
        <div class="small">
          60% leading indicators, 30% financial conditions, 10% coincident/confirmatory.
          Inputs are stress-aligned z-scores from cached FRED histories.
        </div>

        <div style="margin-top:10px;padding:9px;background:rgba(255,255,255,.03);border-radius:8px">
          <div class="small" style="margin-bottom:6px">Current composite:</div>
          <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:10px">
            <div>
              <div class="small">ESI Z-Score</div>
              <div style="font-size:20px;font-weight:800" id="zscoreVal">--</div>
            </div>
            <div>
              <div class="small">Percentile*</div>
              <div style="font-size:20px;font-weight:800" id="percentileVal">--</div>
            </div>
            <div>
              <div class="small">Buckets Used</div>
              <div style="font-size:20px;font-weight:800" id="bucketInfo">--</div>
            </div>
          </div>
          <div class="small" style="margin-top:4px">
            *Percentile assumes ESI_z calibrated vs historical ESI_raw. Until you run that, treat as indicative only.
          </div>
        </div>

        <div style="margin-top:10px">
          <div class="small">Regime guide (on calibrated ESI_z):</div>
          <div style="margin-top:4px;font-size:10px;line-height:1.7">
            <div>&lt; 0.5œÉ ‚Äî <span style="color:var(--green);font-weight:700">Normal</span></div>
            <div>0.5‚Äì1.0œÉ ‚Äî <span style="color:var(--amber);font-weight:700">Elevated</span></div>
            <div>1.0‚Äì2.0œÉ ‚Äî <span style="color:var(--red);font-weight:700">High</span></div>
            <div>&gt;= 2.0œÉ ‚Äî <span style="color:var(--red);font-weight:700">Critical</span></div>
          </div>
        </div>
      </div>
    </div>

    <div class="insight-card" id="insightCard" style="display:none">
      <h4>üí° ESI Read</h4>
      <div id="insightText"></div>
    </div>

    <div class="methodology">
      <h4>What this code actually does</h4>
      <ul>
        <li>Reads <code>data/fred_cache.json</code> generated server-side by GitHub Actions using your FRED key.</li>
        <li>For each series, builds stress-aligned z-scores from its own history (higher z = more stress).</li>
        <li>Within each bucket (Leading / Financial / Nowcast) takes the mean of available z-scores.</li>
        <li>Composite: <strong>ESI_raw = 0.6¬∑Z_leading + 0.3¬∑Z_financial + 0.1¬∑Z_nowcast</strong>.</li>
        <li>ESI_z = (ESI_raw ‚àí Œº_ESI)/œÉ_ESI (defaults Œº=0,œÉ=1 here; you must calibrate from historical ESI_raw).</li>
        <li>Surfaces missing/stale series explicitly; it does not fabricate values.</li>
      </ul>
    </div>
  </div>

  <div class="tabs">
    <button class="tab active" data-t="overview">Indicator Dashboard</button>
    <button class="tab" data-t="audit">Data Integrity & Weights</button>
    <button class="tab" data-t="methodology">Sources & Caveats</button>
  </div>

  <div id="view-overview" class="view active">
    <div class="card">
      <div class="category-header">üöÄ Leading Indicators (60%) ‚Ä¢ 3‚Äì18m</div>
      <div class="kpi-grid" id="leadingGrid"></div>

      <div class="category-header">üí∞ Financial Conditions (30%) ‚Ä¢ 0‚Äì24m</div>
      <div class="kpi-grid" id="financialGrid"></div>

      <div class="category-header">üìâ Confirmatory / Nowcast (10%)</div>
      <div class="kpi-grid" id="nowcastGrid"></div>
    </div>
  </div>

  <div id="view-audit" class="view">
    <div class="card">
      <h3 style="margin-bottom:6px;font-size:15px">Data Integrity & Composite Audit</h3>
      <div class="small" id="auditSummary">Loading‚Ä¶</div>
      <div class="audit-list" id="auditDetails"></div>
    </div>
  </div>

  <div id="view-methodology" class="view">
    <div class="card">
      <h3 style="margin-bottom:6px;font-size:15px">Methodology, Series & Caveats</h3>
      <div class="small">
        No ‚ÄúFed-approved‚Äù fairy tales. You can trace every step from cache ‚Üí z-score ‚Üí bucket ‚Üí composite.
      </div>
      <ul class="small" style="margin-left:16px;margin-top:4px;line-height:1.6">
        <li>Yield curve: Bauer &amp; Mertens (2018), SF Fed (near-term spread). </li>
        <li>Equal-weight robustness: Arrigoni, Bobasu &amp; Venditti (2022), IMF Economic Review.</li>
        <li>NFCI: Chicago Fed documentation.</li>
        <li>Sahm Rule: Claudia Sahm (2019), Brookings.</li>
      </ul>
      <div class="small" style="margin-top:6px">
        You still need to:
        <ul style="margin-left:16px;margin-top:2px">
          <li>Confirm <code>fred_cache.json</code> structure matches what this script expects.</li>
          <li>Estimate Œº_ESI and œÉ_ESI from historical ESI_raw and plug them into the config.</li>
          <li>Run a backtest vs NBER dates before trusting œÉ cutoffs with real money.</li>
        </ul>
      </div>
    </div>
  </div>
</div>

<script>
'use strict';

// Path to your server-side cache
const CACHE_URL = 'data/fred_cache.json';

// Indicator definitions (must match what fetch_fred.js writes into the cache)
const INDICATORS = [
  { key:'T10Y3M',       bucket:'LEADING',  label:'Yield Curve (10y-3m)',        series_id:'T10Y3M',       orientation:'inverted', freq:'daily'   },
  { key:'PERMIT',       bucket:'LEADING',  label:'Building Permits',            series_id:'PERMIT',       orientation:'inverted', freq:'monthly' },
  { key:'ICSA',         bucket:'LEADING',  label:'Initial Claims',              series_id:'ICSA',         orientation:'direct',   freq:'weekly'  },
  { key:'NAPMNOI',      bucket:'LEADING',  label:'ISM New Orders',              series_id:'NAPMNOI',      orientation:'inverted', freq:'monthly' },
  { key:'UMCSENT',      bucket:'LEADING',  label:'Consumer Sentiment',          series_id:'UMCSENT',      orientation:'inverted', freq:'monthly' },
  { key:'AWHMAN',       bucket:'LEADING',  label:'Avg Weekly Hours, Mfg',       series_id:'AWHMAN',       orientation:'inverted', freq:'monthly' },

  { key:'BAMLH0A0HYM2', bucket:'FINANCIAL',label:'HY OAS',                      series_id:'BAMLH0A0HYM2', orientation:'direct',   freq:'daily'   },
  { key:'NFCI',         bucket:'FINANCIAL',label:'NFCI',                         series_id:'NFCI',         orientation:'direct',   freq:'weekly'  },
  { key:'VIXCLS',       bucket:'FINANCIAL',label:'VIX',                          series_id:'VIXCLS',       orientation:'direct',   freq:'daily'   },

  { key:'SAHMREALTIME', bucket:'NOWCAST',  label:'Sahm Rule',                   series_id:'SAHMREALTIME', orientation:'direct',   freq:'monthly' },
  { key:'INDPRO',       bucket:'NOWCAST',  label:'Industrial Production',       series_id:'INDPRO',       orientation:'inverted', freq:'monthly' }
];

const BUCKETS = {
  LEADING:   { label:'Leading',   weight:0.6, gridId:'leadingGrid' },
  FINANCIAL: { label:'Financial', weight:0.3, gridId:'financialGrid' },
  NOWCAST:   { label:'Nowcast',   weight:0.1, gridId:'nowcastGrid' }
};

const STALE = { daily:7, weekly:21, monthly:75 };

// Placeholders: set these from historical ESI_raw distribution once you‚Äôve run it.
const ESI_CAL = { mean:0.0, std:1.0 };

// ---- Cache loading ----

async function loadCache(){
  const res = await fetch(CACHE_URL, { cache:'no-store' });
  if (!res.ok) throw new Error('CACHE_HTTP_'+res.status);
  return res.json();
}

// Tries a few obvious shapes: history / series / values / observations.
function extractHistory(entry){
  if (!entry) return [];
  if (Array.isArray(entry.history)) return entry.history;
  if (Array.isArray(entry.series)) return entry.series;
  if (Array.isArray(entry.values)) return entry.values;
  if (Array.isArray(entry.observations)) return entry.observations;
  return [];
}

function computeZFromCache(ind, cache){
  const c = cache[ind.series_id] || cache[ind.key];
  if (!c) throw new Error('MISSING_IN_CACHE');

  const hist = extractHistory(c);
  if (!hist.length) throw new Error('NO_HISTORY');

  const series = hist
    .map(d => ({
      date: d.date,
      value: typeof d.value === 'number' ? d.value : parseFloat(d.value)
    }))
    .filter(d => !isNaN(d.value));

  if (series.length < 24) throw new Error('SHORT_HISTORY');

  const latest = (c.last_date && c.last != null)
    ? { date:c.last_date, value:c.last }
    : series[series.length - 1];

  const now = new Date();
  const lastDate = new Date(latest.date);
  const ageDays = isNaN(lastDate) ? Infinity : (now - lastDate)/(1000*60*60*24);
  const maxAge = STALE[ind.freq] || 90;
  const stale = ageDays > maxAge;

  // orientation
  const vals = series.map(d =>
    ind.orientation === 'inverted' ? -d.value : d.value
  );

  const mean = vals.reduce((a,b)=>a+b,0)/vals.length;
  const varSum = vals.reduce((a,b)=>a+Math.pow(b-mean,2),0);
  const std = Math.sqrt(varSum/(vals.length-1)) || 0;
  if (!isFinite(std) || std === 0) throw new Error('ZERO_STD');

  const latestAdj = ind.orientation === 'inverted' ? -latest.value : latest.value;
  const z = (latestAdj - mean) / std;

  return {
    key:ind.key,
    bucket:ind.bucket,
    label:ind.label,
    series_id:ind.series_id,
    orientation:ind.orientation,
    freq:ind.freq,
    lastDate:latest.date,
    lastValue:latest.value,
    z,
    stale
  };
}

// ---- ESI computation ----

function computeESI(results){
  const detail = { buckets:{}, stale:[] };
  let wSum = 0;
  let wVal = 0;

  for (const [bKey, bCfg] of Object.entries(BUCKETS)){
    const inB = results.filter(r => r.bucket === bKey);
    if (!inB.length){
      detail.buckets[bKey] = { mean:null, weight:bCfg.weight, effWeight:0, count:0 };
      continue;
    }
    const zs = inB.map(r => r.z);
    const mean = zs.reduce((a,b)=>a+b,0)/zs.length;
    detail.buckets[bKey] = {
      mean,
      weight:bCfg.weight,
      effWeight:bCfg.weight,
      count:inB.length
    };
    wVal += bCfg.weight * mean;
    wSum += bCfg.weight;
    inB.forEach(r => { if (r.stale) detail.stale.push(`${bKey}:${r.label} (${r.lastDate})`); });
  }

  if (!wSum) return { raw:null, z:null, detail };

  const raw = wVal / wSum;
  const mu = ESI_CAL.mean;
  const sd = ESI_CAL.std;
  const z = (sd && isFinite(sd)) ? (raw - mu)/sd : raw;

  return { raw, z, detail };
}

function cumulativeNormal(z){
  const t = 1/(1+0.2316419*Math.abs(z));
  const d = 0.3989423*Math.exp(-0.5*z*z);
  const prob = d*t*(0.3193815 + t*(-0.3565638 + t*(1.781478 + t*(-1.821256 + t*1.330274))));
  return z > 0 ? 1 - prob : prob;
}

// ---- Rendering ----

function statusFromZ(z){
  if (!Number.isFinite(z)) return 'a';
  if (z >= 1.5) return 'r';
  if (z >= 0.5) return 'a';
  return 'g';
}

function renderGauge(z){
  const needleEl = document.getElementById('needle');
  const scoreV = document.getElementById('scoreV');
  const zEl = document.getElementById('zscoreVal');
  const pEl = document.getElementById('percentileVal');

  if (!Number.isFinite(z)){
    needleEl.style.setProperty('--angle','0deg');
    scoreV.textContent = '--';
    zEl.textContent = '--';
    pEl.textContent = '--';
    return;
  }

  const zMin = -2, zMax = 3;
  const zClamp = Math.max(zMin, Math.min(zMax, z));
  const angle = ((zClamp - zMin)/(zMax - zMin))*180;

  needleEl.style.setProperty('--angle', angle + 'deg');

  const d = z.toFixed(2);
  scoreV.textContent = d + 'œÉ';
  zEl.textContent = d + 'œÉ';
  const pct = Math.round(cumulativeNormal(z)*100);
  pEl.textContent = (isFinite(pct)?pct:'--') + 'th';
}

function renderIndicators(results){
  const buckets = { LEADING:[], FINANCIAL:[], NOWCAST:[] };
  results.forEach(r => { if (buckets[r.bucket]) buckets[r.bucket].push(r); });

  for (const [bKey,bCfg] of Object.entries(BUCKETS)){
    const grid = document.getElementById(bCfg.gridId);
    if (!grid) continue;
    const list = buckets[bKey];
    if (!list || !list.length){
      grid.innerHTML = `<div class="small">No valid data for ${bCfg.label} bucket.</div>`;
      continue;
    }
    grid.innerHTML = list.map(r => {
      const dot = statusFromZ(r.z);
      const stale = r.stale ? ' ‚Ä¢ STALE' : '';
      const val = Number.isFinite(r.lastValue) ? r.lastValue : '--';
      const ztxt = Number.isFinite(r.z) ? r.z.toFixed(2)+'œÉ' : '--';
      return `
        <div class="kpi">
          <h4><span>${r.label}</span><span class="dot ${dot}"></span></h4>
          <div class="val">${val}</div>
          <div class="zscore">Stress Z: ${ztxt}</div>
          <div class="small">Series: ${r.series_id} ‚Ä¢ Last: ${r.lastDate || 'n/a'}${stale}</div>
          <div class="desc">
            Orientation: ${r.orientation}.
            Z-score based on full available history from cache; higher Z = more stress.
          </div>
        </div>`;
    }).join('');
  }
}

function renderRegime(z){
  const el = document.getElementById('regime');
  const alertEl = document.getElementById('alert');

  if (!Number.isFinite(z)){
    el.innerHTML =
      `<span style="width:12px;height:12px;border-radius:50%;background:var(--amber);box-shadow:0 0 10px var(--amber)"></span>
       <span>ESI Z-Score: -- | Not computed (missing/bad cache or calibration)</span>`;
    alertEl.style.display = 'block';
    alertEl.textContent = 'Fix fred_cache.json or indicator mapping before using this.';
    return;
  }

  let status,color,msg;
  if (z < 0.5){      status='Normal';   color='green'; msg='No broad stress. Stay data-dependent.'; }
  else if (z < 1.0){ status='Elevated'; color='amber'; msg='Tightening signals. Review risk.'; }
  else if (z < 2.0){ status='High';     color='red';   msg='Clustered warnings. De-risk and stress-test.'; }
  else {             status='Critical'; color='red';   msg='Rare regime. Capital preservation first.'; }

  el.innerHTML =
    `<span style="width:12px;height:12px;border-radius:50%;background:var(--${color});box-shadow:0 0 10px var(--${color})"></span>
     <span>ESI Z-Score: ${z.toFixed(2)}œÉ | ${status} (assuming calibrated Œº,œÉ)</span>`;

  if (z >= 1.0){
    alertEl.style.display = 'block';
    alertEl.innerHTML = `‚ö†Ô∏è <strong>${status.toUpperCase()} STRESS:</strong> ${msg}`;
  } else {
    alertEl.style.display = 'none';
    alertEl.textContent = '';
  }
}

function renderInsight(z, raw, detail){
  const card = document.getElementById('insightCard');
  const text = document.getElementById('insightText');
  if (!card || !text) return;

  if (!Number.isFinite(z)){
    card.style.display = 'block';
    text.textContent = 'ESI not computed. Either cache missing / malformed or calibration not set. Do not pretend this is live.';
    return;
  }

  const b = detail.buckets;
  const lead = b.LEADING?.mean;
  const fin  = b.FINANCIAL?.mean;
  const now  = b.NOWCAST?.mean;

  let line = `ESI_raw=${raw.toFixed(2)}, standardized to ${z.toFixed(2)}œÉ using configured Œº,œÉ. `;
  if (lead!=null) line += `Leading=${lead.toFixed(2)}œÉ; `;
  if (fin!=null)  line += `Financial=${fin.toFixed(2)}œÉ; `;
  if (now!=null)  line += `Nowcast=${now.toFixed(2)}œÉ. `;
  line += 'Check backtest vs NBER dates before treating these bands as gospel.';

  card.style.display = 'block';
  text.textContent = line;
}

function renderAudit(detail, z, raw, results, errors){
  const sumEl = document.getElementById('auditSummary');
  const detEl = document.getElementById('auditDetails');
  if (!sumEl || !detEl) return;

  const lines = [];

  for (const [bKey,b] of Object.entries(detail.buckets)){
    if (!b) continue;
    lines.push(
      `[${bKey}] mean z=${b.mean!=null?b.mean.toFixed(2):'n/a'}, target weight=${b.weight}, effective weight=${b.effWeight}, count=${b.count}`
    );
  }

  if (detail.stale && detail.stale.length){
    lines.push(`Stale series: ${detail.stale.join('; ')}`);
  }

  const missing = INDICATORS.filter(ind =>
    !results.some(r => r.series_id === ind.series_id)
  );
  if (missing.length){
    lines.push(
      'Missing indicators: ' +
      missing.map(m => `${m.bucket}:${m.label} (${m.series_id})`).join('; ')
    );
  }

  if (errors && errors.length){
    lines.push('Errors: ' + errors.join(' | '));
  }

  let summary = `Composite uses 60/30/10 weights on available indicators. `;
  if (Number.isFinite(z)){
    summary += `ESI_raw=${raw.toFixed(2)}, ESI_z=${z.toFixed(2)} (using current Œº,œÉ).`;
  } else {
    summary += 'ESI not computed due to issues above.';
  }

  sumEl.textContent = summary;
  detEl.innerHTML = lines.map(l=>`<div>${l}</div>`).join('');
}

function setDataMode(msg){
  const el = document.getElementById('dataMode');
  if (el) el.textContent = msg;
}

// ---- Main ----

async function loadAndRender(){
  document.getElementById('upd').textContent = 'Updated: ' + new Date().toISOString();
  const errors = [];
  let results = [];

  try{
    const cache = await loadCache();
    setDataMode('Using server-side FRED cache');
    for (const ind of INDICATORS){
      try{
        const r = computeZFromCache(ind, cache);
        results.push(r);
      } catch(e){
        errors.push(`${ind.label}: ${e.message}`);
      }
    }
  }catch(e){
    setDataMode('Cache load failed');
    const alertEl = document.getElementById('alert');
    alertEl.style.display = 'block';
    alertEl.textContent = 'Cannot read data/fred_cache.json ‚Äî fix workflow or path.';
    renderGauge(NaN);
    renderRegime(NaN);
    renderAudit({buckets:{},stale:[]}, NaN, NaN, [], [e.message]);
    return;
  }

  const { raw, z, detail } = computeESI(results);
  renderIndicators(results);
  renderGauge(z);
  renderRegime(z);
  renderInsight(z, raw, detail);
  renderAudit(detail, z, raw, results, errors);

  if (errors.length){
    const alertEl = document.getElementById('alert');
    alertEl.style.display = 'block';
    alertEl.innerHTML = `‚ö†Ô∏è Issues for some series: ${errors.join(' | ')}`;
  }
}

function setupTabs(){
  document.querySelectorAll('.tab').forEach(tab => {
    tab.addEventListener('click', () => {
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      tab.classList.add('active');
      const key = tab.dataset.t;
      document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
      document.getElementById('view-' + key).classList.add('active');
    });
  });
}

function setupButtons(){
  document.getElementById('refreshBtn').onclick = loadAndRender;
  document.getElementById('exportBtn').onclick = () => {
    const snapshot = {
      ts:new Date().toISOString(),
      note:'Snapshot exports current ESI inputs & outputs. Backfill your own history for real work.'
    };
    const blob = new Blob([JSON.stringify(snapshot,null,2)], {type:'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'esi_snapshot.json';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  };
}

window.addEventListener('DOMContentLoaded', () => {
  setupTabs();
  setupButtons();
  loadAndRender();
});
</script>
</body>
</html>
