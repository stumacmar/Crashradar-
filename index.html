<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>CrashRadar — Safe Index</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<style>
  :root{
    --bg:#0e1326; --card:#161b3a; --ring:#0f1430;
    --text:#eef0ff; --muted:#9aa2c9;
    --ok:#21d07a; --warn:#ffd166; --risk:#ff5c7a;
  }
  html,body{margin:0;background:var(--bg);color:var(--text);font:15px system-ui,Segoe UI,Roboto,Helvetica,Arial}
  header{padding:16px 14px;border-bottom:1px solid rgba(255,255,255,.06)}
  h1{margin:0 0 6px;font-size:22px}
  .sub{color:var(--muted);font-size:12px}
  main{padding:12px;max-width:1100px;margin:0 auto}
  .card{background:#161b3a;border-radius:12px;padding:14px;margin:10px 0}
  .row{display:grid;grid-template-columns:1fr;gap:12px}
  @media(min-width:900px){.row{grid-template-columns:1.3fr 1fr}}
  .pill{display:inline-block;background:#0f1430;border-radius:999px;padding:8px 10px;margin:6px 8px 0 0;color:var(--muted);font-weight:600}
  .pill b{color:var(--text)}
  .badge{display:inline-block;border-radius:10px;padding:4px 8px;font-weight:700;margin-left:8px}
  .g{background:rgba(33,208,122,.16);color:var(--ok)}
  .y{background:rgba(255,209,102,.18);color:var(--warn)}
  .r{background:rgba(255,92,122,.18);color:var(--risk)}
  .gauge{--deg:0deg;--col:var(--ok);width:180px;height:180px;border-radius:50%;
         background:conic-gradient(var(--col) var(--deg), #2a2f55 var(--deg));
         display:grid;place-items:center;margin:auto;position:relative}
  .gauge:after{content:"";position:absolute;inset:12px;border-radius:50%;background:var(--ring)}
  .gauge-val{position:relative;font-weight:800;font-size:28px}
  .chart{position:relative;height:260px;margin:10px 0;background:#10163a;border-radius:10px;padding:8px}
  .chart canvas{width:100% !important;height:100% !important;display:block}
  details{background:#10163a;padding:10px;border-radius:8px}
  summary{cursor:pointer}
  pre{white-space:pre-wrap;background:#0f1430;border-radius:8px;padding:10px;color:#ffd166;overflow:auto;max-height:360px;margin:8px 0 0}
</style>
</head>
<body>
<header>
  <h1>CrashRadar — Recession Risk</h1>
  <div id="status" class="sub">Loading <code>data/fred_cache.json</code>…</div>
</header>

<main>
  <section class="card row">
    <div>
      <div class="gauge" id="gauge"><div id="gval" class="gauge-val">—</div></div>
      <div style="text-align:center;margin-top:8px">
        <span id="badge" class="badge">—</span><br>
        <span class="sub">Green ≤ 30 • Amber ≤ 60 • Red &gt; 60</span>
      </div>
    </div>
    <div>
      <b>Latest</b>
      <div class="pill">Term (10y–3m): <b id="k_term">—</b></div>
      <div class="pill">Credit (BAA–AAA or BAA–10y): <b id="k_credit">—</b></div>
      <div class="pill">Unemp 6m slope / Claims: <b id="k_labor">—</b></div>
      <div class="pill">12m Drawdown: <b id="k_dd">—</b></div>
      <div class="pill">NFCI / Lending: <b id="k_nfci">—</b></div>
      <div id="fresh" class="sub" style="margin-top:8px">Data freshness: —</div>
    </div>
  </section>

  <section class="card" id="charts">
    <b>Trends</b>
    <div class="chart" id="compWrap" hidden><canvas id="cComp"></canvas></div>
    <div class="chart" id="termWrap" hidden><canvas id="cTerm"></canvas></div>
    <div class="chart" id="creditWrap" hidden><canvas id="cCredit"></canvas></div>
    <div class="chart" id="laborWrap" hidden><canvas id="cLabor"></canvas></div>
    <div class="chart" id="ddWrap" hidden><canvas id="cDD"></canvas></div>
    <div class="chart" id="nfciWrap" hidden><canvas id="cNFCI"></canvas></div>
    <div class="sub" id="noCharts" hidden>No history in cache — charts hidden (gauge + KPIs still live).</div>
  </section>

  <section class="card">
    <b>Diagnostics</b>
    <details>
      <summary>Open raw JSON</summary>
      <pre id="diag">Waiting…</pre>
    </details>
  </section>
</main>

<script>
const $ = s => document.querySelector(s);
const fmt = (x,d=2)=>Number.isFinite(x)?(+x).toFixed(d):'—';
function setBadge(score){
  const b=$('#badge'); b.className='badge';
  if(!Number.isFinite(score)){ b.textContent='—'; return; }
  if(score<=30){ b.textContent='GREEN'; b.classList.add('g'); }
  else if(score<=60){ b.textContent='AMBER'; b.classList.add('y'); }
  else { b.textContent='RED'; b.classList.add('r'); }
}
function renderGauge(score){
  const g=$('#gauge'), v=$('#gval');
  const s=Number.isFinite(score)? Math.max(0,Math.min(score,100)) : NaN;
  v.textContent=Number.isFinite(s)? s.toFixed(1) : '—';
  const deg=Number.isFinite(s)? (s/100)*360 : 0;
  const col = !Number.isFinite(s)? 'var(--ok)' : (s<=30?'var(--ok)': s<=60?'var(--warn)':'var(--risk)');
  g.style.background = `conic-gradient(${col} ${deg}deg, #2a2f55 ${deg}deg)`;
  setBadge(s);
}
function arrFrom(obj){ // supports {observations:[{date,value}]} or {last: num}
  if(obj?.observations && Array.isArray(obj.observations)){
    const a = obj.observations.filter(o=>o && o.date!=null && o.value!=null)
                              .map(o=>({d:String(o.date), v:+o.value}))
                              .filter(o=>Number.isFinite(o.v));
    return a;
  }
  if(typeof obj?.last === 'number'){
    return [{d:'latest', v:obj.last}];
  }
  return [];
}
function drawLine(id,title,points,color='#7ea6ff',yFmt=null){
  const wrap = document.getElementById(id+'Wrap');
  const cvs = document.getElementById(id);
  if(!wrap||!cvs || !points.length) return (wrap&&(wrap.hidden=true));
  wrap.hidden=false;
  const labels = points.map(p=>p.d);
  const values = points.map(p=>p.v);
  if(cvs._chart){ try{ cvs._chart.destroy(); }catch(e){} }
  cvs._chart = new Chart(cvs.getContext('2d'),{
    type:'line',
    data:{ labels, datasets:[{ data:values, borderColor:color, backgroundColor:'rgba(126,166,255,.16)', fill:false, tension:.25, pointRadius:0}] },
    options:{
      responsive:true, maintainAspectRatio:false,
      plugins:{ legend:{display:false}, title:{display:true,text:title,color:'#cfe3ff'} },
      scales:{
        x:{ ticks:{color:'#9aa2c9', maxRotation:0, autoSkip:true}, grid:{color:'rgba(255,255,255,.06)'} },
        y:{ ticks:{color:'#9aa2c9', callback:yFmt||((v)=>v) }, grid:{color:'rgba(255,255,255,.06)'} }
      }
    }
  });
}

(async function(){
  try{
    const r = await fetch('data/fred_cache.json',{cache:'no-store'});
    if(!r.ok) throw new Error(`HTTP ${r.status}`);
    const txt = await r.text();
    $('#diag').textContent = txt;
    const j = JSON.parse(txt);
    $('#status').textContent = '✅ Cache loaded';

    const S = j.series || {};
    // try both composite locations
    const comp = Number.isFinite(j?.composite_score?.score) ? j.composite_score.score
                : Number.isFinite(j?.composite) ? j.composite
                : Number.isFinite(j?.score) ? j.score : NaN;
    renderGauge(Number(comp));

    // freshness
    const ts = j.fetched_at_utc || j.last_updated || j?.composite_score?.last_updated || null;
    $('#fresh').textContent = ts ? (new Date(ts).toLocaleString()) : '—';

    // map fields (support both naming styles)
    const series = {
      term:   S.T10Y3M || S.TERM || null,
      credit: S.CREDIT || S.BAA10Y || S.BAA_AAA || null,
      labor:  S.UN_SLOPE6 || S.CLAIMS || null,
      dd:     S.DD_12M || null,
      nfci:   S.NFCI || S.LEND || null,
      compHist: S.COMPOSITE || null
    };

    // KPIs from last values if available
    const aTerm = arrFrom(series.term);
    const aCred = arrFrom(series.credit);
    const aLab  = arrFrom(series.labor);
    const aDD   = arrFrom(series.dd);
    const aNFCI = arrFrom(series.nfci);

    const last = a => a.length ? a[a.length-1].v : NaN;

    $('#k_term').textContent  = fmt(last(aTerm));
    $('#k_credit').textContent= fmt(last(aCred));
    const labVal = last(aLab);
    $('#k_labor').textContent = Number.isFinite(labVal) ? fmt(labVal) : '—';
    const ddVal = last(aDD);
    $('#k_dd').textContent    = Number.isFinite(ddVal)? (ddVal*100).toFixed(1)+'%' : '—';
    $('#k_nfci').textContent  = fmt(last(aNFCI));

    // Charts (only if have history > 2)
    let anyCharts = false;
    const hasHist = a => a.length > 2 && a[0].d!=='latest';

    // composite trend if present in cache (otherwise skip)
    const compHist = series.compHist ? arrFrom(series.compHist) : [];
    if (hasHist(compHist)) { anyCharts=true; drawLine('cComp','Composite (from cache)', compHist,'#a7c4ff'); }

    if (hasHist(aTerm))  { anyCharts=true; drawLine('cTerm','Term (10y–3m)', aTerm,'#68c1ff'); }
    if (hasHist(aCred))  { anyCharts=true; drawLine('cCredit','Credit Spread', aCred,'#ffbb66'); }
    if (hasHist(aLab))   { anyCharts=true; drawLine('cLabor','Labor slope / claims', aLab,'#ff8899'); }
    if (hasHist(aDD))    { anyCharts=true; drawLine('cDD','12m Drawdown', aDD,'#a089ff', (v)=> (v*100).toFixed(0)+'%'); }
    if (hasHist(aNFCI))  { anyCharts=true; drawLine('cNFCI','NFCI / Lending', aNFCI,'#7dd39f', (v)=> v.toFixed(2)); }

    if (!anyCharts) $('#noCharts').hidden = false;

  }catch(e){
    $('#status').textContent = `❌ ${e.message}`;
    $('#diag').textContent = e.stack || String(e);
    renderGauge(NaN);
  }
})();
</script>
</body>
</html>
