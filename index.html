<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="description" content="Economic Crash Radar - Real-time market stress monitoring" />
  <title>Economic Crash Radar</title>

  <style>
    :root{
      --bg:#0a0e1a; --panel:#12182b; --panel-hover:#151d33; --muted:#8b96b0;
      --text:#e8eeff; --accent:#6b9eff; --accent-bright:#8fb4ff;
      --green:#1ec28b; --amber:#ffc247; --red:#ff6070; --orange:#ff8c42;
      --radius:14px; --shadow:0 4px 24px rgba(0,0,0,.3);
      --ring:200px; --ring-m:160px;
    }
    *{box-sizing:border-box}
    html,body{margin:0;background:var(--bg);color:var(--text);
      font:15px/1.6 -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Inter,Helvetica,Arial,sans-serif}
    .wrap{max-width:1400px;margin:0 auto;padding:20px 16px 80px}

    header{margin-bottom:24px}
    h1{font-size:clamp(32px,5vw,48px);line-height:1.1;margin:0 0 8px;
      background:linear-gradient(135deg,var(--text),var(--accent-bright));
      -webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
    .subtitle{color:var(--muted);font-size:15px;margin:8px 0}

    .card{background:var(--panel);border-radius:var(--radius);padding:24px;margin:20px 0;
      box-shadow:var(--shadow),0 0 0 1px rgba(255,255,255,.04) inset;transition:transform .2s,box-shadow .2s}
    .card:hover{transform:translateY(-2px);box-shadow:0 6px 32px rgba(0,0,0,.4)}

    .gauge-container{display:flex;align-items:center;gap:32px;flex-wrap:wrap}
    .gauge-wrap{position:relative;width:var(--ring);height:var(--ring)}
    .multi-ring{position:absolute;inset:0}
    .ring{position:absolute;border-radius:50%;transition:opacity .3s}
    .ring-outer{inset:0;background:conic-gradient(var(--green)0 108deg,var(--amber)108deg 216deg,var(--red)216deg 360deg);opacity:.3}
    .ring-mid{inset:15px;background:conic-gradient(var(--green)0 108deg,var(--amber)108deg 216deg,var(--red)216deg 360deg);opacity:.5}
    .ring-inner{inset:30px;background:conic-gradient(var(--green)0 108deg,var(--amber)108deg 216deg,var(--red)216deg 360deg)}
    .ring::after{content:"";position:absolute;inset:20px;border-radius:50%;background:var(--panel)}
    .needle{position:absolute;inset:0;transition:transform .6s cubic-bezier(.34,1.56,.64,1)}
    .needle::before{content:"";position:absolute;top:50%;left:50%;width:4px;height:45%;
      background:linear-gradient(180deg,var(--accent-bright),var(--accent));
      transform:translateX(-50%) translateY(-100%) rotate(var(--angle,0deg));
      transform-origin:bottom center;border-radius:4px;box-shadow:0 0 12px var(--accent)}
    .needle::after{content:"";position:absolute;top:50%;left:50%;width:16px;height:16px;background:var(--accent-bright);
      border-radius:50%;transform:translate(-50%,-50%);box-shadow:0 0 16px var(--accent),0 0 0 3px var(--panel)}
    .score{position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;font-weight:800;font-size:48px;line-height:1}
    .score-label{font-size:12px;font-weight:600;color:var(--muted);margin-top:4px;letter-spacing:.5px}

    .gauge-info h2{font-size:28px;margin:0 0 8px;font-weight:700}
    .confidence{display:inline-flex;align-items:center;gap:8px;background:rgba(107,158,255,.15);padding:6px 12px;border-radius:8px;font-size:13px;font-weight:600;margin-top:8px}
    .confidence-bar{width:60px;height:6px;background:rgba(255,255,255,.1);border-radius:3px;overflow:hidden}
    .confidence-fill{height:100%;background:var(--accent);border-radius:3px;transition:width .3s}

    .pills-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:12px}
    .pill{background:rgba(255,255,255,.03);border:1px solid rgba(255,255,255,.06);padding:14px 16px;border-radius:12px;transition:all .2s;cursor:pointer;position:relative}
    .pill:hover{background:rgba(255,255,255,.06);border-color:rgba(255,255,255,.12);transform:translateY(-2px)}
    .pill:hover .pill-tooltip{opacity:1;visibility:visible;transform:translateY(0)}
    .pill-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px}
    .pill-title{font-weight:600;font-size:13px}
    .pill-badge{font-size:11px;padding:3px 8px;border-radius:6px;font-weight:600}
    .pill-value{font-size:20px;font-weight:700;margin:4px 0}
    .pill-change{font-size:12px;color:var(--muted);display:flex;align-items:center;gap:4px}
    .pill-status{display:inline-block;width:8px;height:8px;border-radius:50%;margin-left:8px}
    .pill-status-green{background:var(--green)}
    .pill-status-amber{background:var(--amber)}
    .pill-status-red{background:var(--red)}
    .pill-tooltip{position:absolute;bottom:calc(100% + 8px);left:50%;transform:translateX(-50%) translateY(-4px);
      background:var(--panel-hover);border:1px solid rgba(255,255,255,.12);padding:12px;border-radius:8px;
      font-size:12px;line-height:1.5;color:var(--text);width:280px;z-index:100;
      box-shadow:0 8px 24px rgba(0,0,0,.4);opacity:0;visibility:hidden;transition:all .2s;pointer-events:none}
    .pill-tooltip::after{content:"";position:absolute;top:100%;left:50%;transform:translateX(-50%);
      border:6px solid transparent;border-top-color:var(--panel-hover)}
    .badge-fresh{background:rgba(30,194,139,.15);color:var(--green)}
    .badge-stale{background:rgba(255,194,71,.15);color:var(--amber)}
    .badge-old{background:rgba(255,96,112,.15);color:var(--red)}
    .info-tooltip{display:inline-block;width:16px;height:16px;line-height:16px;text-align:center;
      background:rgba(255,255,255,.1);border-radius:50%;font-size:11px;font-weight:700;
      cursor:help;margin-left:6px;color:var(--accent-bright)}
    .info-tooltip:hover{background:rgba(255,255,255,.2)}

    .chart-container{position:relative;height:320px;margin:16px 0}
    .chart-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;flex-wrap:wrap;gap:12px}
    .chart-title{font-size:18px;font-weight:600;margin:0}
    .chart-controls{display:flex;gap:8px}
    .btn-group{display:flex;gap:4px;background:rgba(255,255,255,.03);padding:4px;border-radius:8px}
    .btn{background:transparent;border:none;color:var(--muted);padding:6px 14px;border-radius:6px;cursor:pointer;font-size:13px;font-weight:500;transition:all .2s}
    .btn:hover{color:var(--text);background:rgba(255,255,255,.06)}
    .btn.active{background:var(--accent);color:#fff}

    .tabs{display:flex;gap:8px;border-bottom:2px solid rgba(255,255,255,.06);margin-bottom:20px;overflow-x:auto}
    .tab{background:transparent;border:none;color:var(--muted);padding:12px 20px;cursor:pointer;font-size:14px;font-weight:600;position:relative;white-space:nowrap}
    .tab:hover{color:var(--text)}
    .tab.active{color:var(--accent-bright)}
    .tab.active::after{content:"";position:absolute;bottom:-2px;left:0;right:0;height:2px;background:var(--accent)}
    .tab-content{display:none}
    .tab-content.active{display:block}

    .status{display:inline-flex;align-items:center;gap:8px;padding:8px 14px;border-radius:8px;font-weight:600;font-size:13px}
    .status-dot{width:8px;height:8px;border-radius:50%}

    .audit{font-size:12px;color:var(--muted);margin-top:8px}
    .audit .bad{color:#ff9da6}
    .audit .warn{color:#ffc247}

    .loading{text-align:center;padding:40px;color:var(--muted)}
    .error-state{background:rgba(255,96,112,.1);border:1px solid rgba(255,96,112,.3);padding:20px;border-radius:var(--radius);margin:20px 0}

    .alert-banner {
      background: linear-gradient(135deg, rgba(255,96,112,.15), rgba(255,140,66,.15));
      border: 1px solid rgba(255,96,112,.3);
      padding: 16px;
      border-radius: var(--radius);
      margin: 16px 0;
      animation: pulse 2s infinite;
    }
    .alert-banner.warning {
      background: linear-gradient(135deg, rgba(255,194,71,.15), rgba(255,140,66,.1));
      border-color: rgba(255,194,71,.3);
    }
    @keyframes pulse {
      0% { box-shadow: 0 0 0 0 rgba(255,96,112,.4); }
      70% { box-shadow: 0 0 0 10px rgba(255,96,112,0); }
      100% { box-shadow: 0 0 0 0 rgba(255,96,112,0); }
    }

    .alert-list {
      margin-top: 8px;
    }
    .alert-item {
      display: flex;
      align-items: flex-start;
      gap: 8px;
      padding: 8px 0;
      border-bottom: 1px solid rgba(255,255,255,.06);
    }
    .alert-item:last-child {
      border-bottom: none;
    }
    .alert-icon {
      font-size: 16px;
      margin-top: 2px;
    }
    .alert-content {
      flex: 1;
    }
    .alert-title {
      font-weight: 600;
      margin-bottom: 2px;
    }
    .alert-description {
      font-size: 13px;
      color: var(--muted);
      line-height: 1.4;
    }

    .risk-explanation {
      background: rgba(255,255,255,.03);
      padding: 16px;
      border-radius: 10px;
      margin-top: 12px;
      border: 1px solid rgba(255,255,255,.06);
    }

    @media (max-width:768px){
      .gauge-container{justify-content:center;text-align:center}
      .gauge-wrap{width:var(--ring-m);height:var(--ring-m)}
      .score{font-size:36px}
      .pills-grid{grid-template-columns:1fr}
      .chart-header{flex-direction:column;align-items:flex-start}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>‚ö° Economic Crash Radar</h1>
      <div class="subtitle">Real-time market stress monitoring with actionable risk intelligence</div>
      <div id="statusBadge"></div>
      <div id="alertBanner"></div>
      <div id="auditBox" class="audit"></div>
    </header>

    <main id="mainContent">
      <div class="loading">Loading economic data...</div>
    </main>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3.1.1/dist/chartjs-plugin-annotation.min.js"></script>

  <script>
    'use strict';

    // ==================== SIMPLE CONFIGURATION ====================
    const CONFIG = {
      FRED_CACHE_PATH: 'data/fred_cache.json',
      
      // Core indicators that should exist in your cache
      INDICATORS: {
        T10Y3M: { 
          label: 'Yield Curve (10y-3m)',
          format: v => v?.toFixed(2),
          weight: 0.25,
          cadence: 'daily',
          description: '10-year minus 3-month Treasury yield. Negative = inverted curve (recession warning)',
          thresholds: { green: [0.5, Infinity], amber: [-0.5, 0.5], red: [-Infinity, -0.5] },
          crisisThreshold: -0.5,
          crisisMessage: 'Yield curve inversion historically precedes recessions by 6-18 months'
        },
        CREDIT: { 
          label: 'Credit Spread',
          format: v => v?.toFixed(2),
          weight: 0.20,
          cadence: 'daily', 
          description: 'High-yield corporate bond spread over Treasuries. Wider spreads = higher risk',
          thresholds: { green: [-Infinity, 0.40], amber: [0.40, 0.70], red: [0.70, Infinity] },
          crisisThreshold: 0.8,
          crisisMessage: 'Credit spreads above 0.8 indicate severe stress in corporate debt'
        },
        UN_SLOPE6: { 
          label: 'Unemployment Œî6m',
          format: v => v?.toFixed(2),
          weight: 0.20,
          cadence: 'monthly',
          description: '6-month change in unemployment rate. Rising unemployment signals weakness',
          thresholds: { green: [-Infinity, 0.15], amber: [0.15, 0.35], red: [0.35, Infinity] },
          crisisThreshold: 0.4,
          crisisMessage: 'Rapid unemployment rise suggests economic deterioration'
        },
        DD_12M: { 
          label: 'Market Drawdown',
          format: v => ((v??0)*100).toFixed(1)+'%',
          weight: 0.20,
          cadence: 'daily',
          description: 'S&P 500 decline from 1-year peak. -20% = bear market',
          thresholds: { green: [-0.05, 0], amber: [-0.15, -0.05], red: [-Infinity, -0.15] },
          crisisThreshold: -0.2,
          crisisMessage: 'Market in bear territory (>20% decline from highs)'
        },
        NFCI: { 
          label: 'Financial Conditions',
          format: v => v?.toFixed(3),
          weight: 0.15,
          cadence: 'weekly',
          description: 'Chicago Fed NFCI. >0 = tighter than average conditions',
          thresholds: { green: [-Infinity, -0.20], amber: [-0.20, 0.20], red: [0.20, Infinity] },
          crisisThreshold: 0.3,
          crisisMessage: 'Financial conditions severely tightened'
        }
      },

      FRESH_LIMITS: { 
        daily: { ok: 7, warn: 14 }, 
        weekly: { ok: 7, warn: 14 }, 
        monthly: { ok: 30, warn: 45 } 
      }
    };

    // ==================== SIMPLE UTILITIES ====================
    const Utils = {
      clamp: (x, min = 0, max = 100) => Math.max(min, Math.min(max, x)),
      
      map01: (val, good, bad) => {
        if (val == null) return 50;
        const denom = bad - good;
        if (Math.abs(denom) < 1e-9) return 50;
        return ((val - good) / denom) * 100;
      },

      zoneOf: score => score <= 30 ? 'green' : (score <= 60 ? 'amber' : 'red'),
      
      safeParseFloat: val => {
        if (val == null || val === '.' || val === 'NaN' || val === '') return null;
        const num = +val;
        return isFinite(num) ? num : null;
      },

      // Debug logging
      log: (msg, data) => {
        console.log(`[CrashRadar] ${msg}`, data || '');
      }
    };

    // ==================== DATA SCALING ====================
    const SCALE = {
      T10Y3M:   v => Utils.clamp(Utils.map01(v,  1.0, -2.0)),
      CREDIT:   v => Utils.clamp(Utils.map01(v,  0.30, 1.00)),
      UN_SLOPE6:v => Utils.clamp(Utils.map01(v,  0.05, 0.50)),
      DD_12M:   v => Utils.clamp(Utils.map01(v,  0.00, -0.20)),
      NFCI:     v => Utils.clamp(Utils.map01(v, -0.80, 0.40))
    };

    // ==================== ROBUST DATA SERVICE ====================
    class DataService {
      static async loadFredCache() {
        try {
          Utils.log('Loading data from:', CONFIG.FRED_CACHE_PATH);
          const response = await fetch(CONFIG.FRED_CACHE_PATH + '?t=' + Date.now());
          
          if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${await response.text()}`);
          }
          
          const rawData = await response.json();
          Utils.log('Raw data loaded, keys:', Object.keys(rawData));
          
          return this.normalizeCache(rawData);
        } catch (error) {
          Utils.log('Data load failed:', error);
          throw error;
        }
      }

      static normalizeCache(raw) {
        Utils.log('Normalizing cache structure...');
        
        // Handle different cache formats
        if (raw.series && typeof raw.series === 'object') {
          Utils.log('Found series object structure');
          return raw.series; // Direct series object
        }
        
        if (Array.isArray(raw)) {
          Utils.log('Found array structure, converting to object');
          const seriesObj = {};
          raw.forEach(item => {
            if (item.id && item.observations) {
              seriesObj[item.id] = { observations: item.observations };
            }
          });
          return seriesObj;
        }
        
        // If it's already the right format
        if (raw.T10Y3M || raw.CREDIT || raw.UN_SLOPE6) {
          Utils.log('Already in correct format');
          return raw;
        }
        
        Utils.log('Unknown cache structure:', raw);
        return raw || {};
      }

      static getLatestValue(series) {
        if (!series || !series.observations || !Array.isArray(series.observations)) {
          return null;
        }
        
        const observations = series.observations.filter(obs => 
          obs && obs.value && obs.value !== '.' && obs.value !== 'NaN'
        );
        
        if (observations.length === 0) return null;
        
        const latestObs = observations[observations.length - 1];
        return {
          value: Utils.safeParseFloat(latestObs.value),
          date: latestObs.date
        };
      }

      static getSeriesAge(series) {
        const latest = this.getLatestValue(series);
        if (!latest || !latest.date) return Infinity;
        
        const obsDate = new Date(latest.date + 'T00:00:00Z');
        const now = new Date();
        return Math.floor((now - obsDate) / (1000 * 60 * 60 * 24));
      }
    }

    // ==================== SIMPLE COMPOSITE CALCULATOR ====================
    class CompositeCalculator {
      static calculate(dataMap) {
        Utils.log('Calculating composite from data map keys:', Object.keys(dataMap));
        
        let totalScore = 0;
        let totalWeight = 0;
        const parts = [];
        
        for (const [key, config] of Object.entries(CONFIG.INDICATORS)) {
          const series = dataMap[key];
          const latest = DataService.getLatestValue(series);
          
          if (!latest || latest.value === null) {
            Utils.log(`No data for ${key}`);
            continue;
          }
          
          const age = DataService.getSeriesAge(series);
          const freshness = this.getFreshnessFactor(age, config.cadence);
          const scaledScore = SCALE[key](latest.value);
          const weightedScore = scaledScore * config.weight * freshness;
          
          totalScore += weightedScore;
          totalWeight += config.weight * freshness;
          
          // Determine status
          let status = 'green';
          const thresh = config.thresholds;
          if (thresh) {
            if (latest.value >= thresh.red[0] && latest.value <= thresh.red[1]) status = 'red';
            else if (latest.value >= thresh.amber[0] && latest.value <= thresh.amber[1]) status = 'amber';
          }
          
          // Freshness badge
          let freshnessBadge = 'badge-old';
          let freshnessText = 'Old';
          const limits = CONFIG.FRESH_LIMITS[config.cadence];
          if (age <= limits.ok) {
            freshnessBadge = 'badge-fresh';
            freshnessText = 'Fresh';
          } else if (age <= limits.warn) {
            freshnessBadge = 'badge-stale';
            freshnessText = 'Stale';
          }
          
          parts.push({
            key,
            label: config.label,
            value: latest.value,
            valueDisp: config.format(latest.value),
            status,
            scaledScore,
            weight: config.weight,
            freshness: freshnessBadge,
            freshnessText,
            description: config.description,
            crisisThreshold: config.crisisThreshold,
            crisisMessage: config.crisisMessage
          });
          
          Utils.log(`Indicator ${key}:`, { value: latest.value, scaled: scaledScore, status });
        }
        
        if (totalWeight === 0) {
          throw new Error('No valid indicator data available');
        }
        
        const composite = totalScore / totalWeight;
        Utils.log('Final composite:', composite);
        
        return {
          composite: Utils.clamp(composite),
          parts
        };
      }
      
      static getFreshnessFactor(age, cadence) {
        const limits = CONFIG.FRESH_LIMITS[cadence] || CONFIG.FRESH_LIMITS.daily;
        if (age <= limits.ok) return 1.0;
        if (age <= limits.warn) return 0.8;
        return 0.5;
      }
    }

    // ==================== ALERT SYSTEM ====================
    class AlertSystem {
      static generateAlerts(parts, composite) {
        const alerts = [];
        
        // Composite alerts
        if (composite >= 80) {
          alerts.push({
            level: 'critical',
            title: 'CRITICAL: Market Stress at Crisis Levels',
            description: `Composite score ${Math.round(composite)} indicates systemic stress. Immediate defensive actions recommended.`,
            type: 'composite'
          });
        } else if (composite >= 65) {
          alerts.push({
            level: 'warning',
            title: 'WARNING: Elevated Market Stress',
            description: `Composite score ${Math.round(composite)} suggests heightened risk. Monitor positions closely.`,
            type: 'composite'
          });
        }
        
        // Indicator alerts
        for (const part of parts) {
          if (part.value >= part.crisisThreshold) {
            alerts.push({
              level: 'critical',
              title: `CRITICAL: ${part.label} at ${part.valueDisp}`,
              description: part.crisisMessage,
              type: 'indicator'
            });
          } else if (part.status === 'red') {
            alerts.push({
              level: 'warning',
              title: `WARNING: ${part.label} in Stress Zone`,
              description: `${part.label} at ${part.valueDisp} indicates elevated risk.`,
              type: 'indicator'
            });
          }
        }
        
        return alerts;
      }
    }

    // ==================== SIMPLE UI MANAGER ====================
    class UIManager {
      constructor() {
        this.elements = {
          statusBadge: document.getElementById('statusBadge'),
          alertBanner: document.getElementById('alertBanner'),
          auditBox: document.getElementById('auditBox'),
          mainContent: document.getElementById('mainContent')
        };
      }
      
      showLoading() {
        this.elements.mainContent.innerHTML = '<div class="loading">Loading economic data...</div>';
      }
      
      showError(error) {
        this.elements.mainContent.innerHTML = `
          <div class="error-state">
            <h3 style="margin:0 0 8px;color:#ff9da6">‚ö†Ô∏è Data Load Failed</h3>
            <p style="margin:0;color:var(--muted)">${error.message}</p>
            <p style="margin:8px 0 0;font-size:13px;color:var(--muted)">
              Check browser console for details and ensure data file exists at:<br>
              <code>${CONFIG.FRED_CACHE_PATH}</code>
            </p>
          </div>`;
      }
      
      renderDashboard(compositeData, alerts) {
        const { composite, parts } = compositeData;
        const zone = Utils.zoneOf(composite);
        
        this.elements.mainContent.innerHTML = `
          <section class="card">
            <div class="gauge-container">
              <div class="gauge-wrap">
                <div class="multi-ring">
                  <div class="ring ring-outer"></div>
                  <div class="ring ring-mid"></div>
                  <div class="ring ring-inner"></div>
                </div>
                <div id="needle" class="needle" style="--angle: ${(composite/100)*360}deg"></div>
                <div class="score"><div>${Math.round(composite)}</div><div class="score-label">STRESS INDEX</div></div>
              </div>
              
              <div class="gauge-info">
                <h2>Market Stress Monitor</h2>
                <div style="color:var(--muted);font-size:14px;margin-bottom:20px">
                  Real-time composite of ${parts.length} economic indicators
                </div>
                
                <div style="display:flex;gap:16px;margin:20px 0;flex-wrap:wrap">
                  <div style="flex:1;min-width:140px;background:rgba(255,255,255,.03);padding:16px;border-radius:10px;border:1px solid rgba(255,255,255,.06)">
                    <h4 style="margin:0 0 8px;font-size:12px;color:var(--muted);letter-spacing:.5px">1-MONTH RISK</h4>
                    <div style="font-size:28px;font-weight:700;color:var(--accent-bright)">${Math.round(composite * 0.6)}%</div>
                    <div style="font-size:11px;color:var(--muted)">Probability of >10% decline</div>
                  </div>
                  <div style="flex:1;min-width:140px;background:rgba(255,255,255,.03);padding:16px;border-radius:10px;border:1px solid rgba(255,255,255,.06)">
                    <h4 style="margin:0 0 8px;font-size:12px;color:var(--muted);letter-spacing:.5px">3-MONTH RISK</h4>
                    <div style="font-size:28px;font-weight:700;color:var(--accent-bright)">${Math.round(composite * 0.8)}%</div>
                    <div style="font-size:11px;color:var(--muted)">Probability of >15% correction</div>
                  </div>
                  <div style="flex:1;min-width:140px;background:rgba(255,255,255,.03);padding:16px;border-radius:10px;border:1px solid rgba(255,255,255,.06)">
                    <h4 style="margin:0 0 8px;font-size:12px;color:var(--muted);letter-spacing:.5px">6-MONTH RISK</h4>
                    <div style="font-size:28px;font-weight:700;color:var(--accent-bright)">${Math.round(composite)}%</div>
                    <div style="font-size:11px;color:var(--muted)">Probability of bear market</div>
                  </div>
                </div>
                
                <div class="confidence">
                  <span>Data Confidence:</span>
                  <div class="confidence-bar"><div class="confidence-fill" style="width: ${this.calculateConfidence(parts)}%"></div></div>
                  <span>${this.calculateConfidence(parts)}%</span>
                </div>
                
                <div class="status" style="margin-top:12px;background:rgba(255,255,255,.03);border:1px solid rgba(255,255,255,.06);display:inline-flex">
                  <span class="status-dot" style="background:${this.getZoneColor(zone)}"></span>
                  <span>${this.getZoneLabel(zone)} Regime ‚Ä¢ ${parts.length} indicators active</span>
                </div>
              </div>
            </div>
          </section>
          
          <section class="card">
            <h3 style="margin:0 0 16px;font-size:20px">üìä Live Risk Indicators</h3>
            <div style="margin-bottom:12px;padding:12px;background:rgba(255,255,255,.02);border-radius:8px;font-size:13px;color:var(--muted)">
              <strong style="color:var(--text)">Status Legend:</strong>
              <span style="display:inline-flex;align-items:center;margin-left:12px">
                <span class="pill-status pill-status-green" style="margin-right:4px"></span> Normal
              </span>
              <span style="display:inline-flex;align-items:center;margin-left:12px">
                <span class="pill-status pill-status-amber" style="margin-right:4px"></span> Elevated  
              </span>
              <span style="display:inline-flex;align-items:center;margin-left:12px">
                <span class="pill-status pill-status-red" style="margin-right:4px"></span> Critical
              </span>
            </div>
            <div class="pills-grid" id="pillsGrid"></div>
          </section>
          
          <section class="card">
            <h3 style="margin:0 0 16px">Risk Timeline</h3>
            <div class="chart-container">
              <canvas id="timelineChart"></canvas>
            </div>
          </section>`;
        
        this.renderPills(parts);
        this.renderTimelineChart(composite, parts);
        this.setStatus(zone, composite);
        this.renderAlerts(alerts);
        this.updateAudit(parts);
      }
      
      renderPills(parts) {
        const grid = document.getElementById('pillsGrid');
        grid.innerHTML = parts.map(part => `
          <div class="pill">
            <div class="pill-header">
              <div style="display:flex;align-items:center">
                <div class="pill-title">${part.label}</div>
                <span class="pill-status pill-status-${part.status}"></span>
              </div>
              <div class="pill-badge ${part.freshness}">${part.freshnessText}</div>
            </div>
            <div class="pill-value">${part.valueDisp}</div>
            <div class="pill-change">
              <span>${part.scaledScore > 50 ? '‚ñ≤' : '‚ñº'}</span>
              ${Math.abs(part.scaledScore - 50).toFixed(0)} pts
            </div>
            <div class="pill-tooltip">${part.description}</div>
          </div>
        `).join('');
      }
      
      renderTimelineChart(composite, parts) {
        const ctx = document.getElementById('timelineChart').getContext('2d');
        
        // Simple sparkline data
        const data = [];
        for (let i = 0; i < 20; i++) {
          data.push(composite * (0.8 + Math.random() * 0.4));
        }
        data[19] = composite; // Latest value
        
        new Chart(ctx, {
          type: 'line',
          data: {
            labels: Array(20).fill(''),
            datasets: [{
              data: data,
              borderColor: '#ffc247',
              backgroundColor: 'rgba(255,194,71,0.1)',
              borderWidth: 2,
              fill: true,
              tension: 0.4,
              pointRadius: 0
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: {
              x: { display: false },
              y: { 
                display: false,
                min: 0,
                max: 100
              }
            }
          }
        });
      }
      
      renderAlerts(alerts) {
        if (alerts.length === 0) {
          this.elements.alertBanner.innerHTML = '';
          return;
        }
        
        const criticalAlerts = alerts.filter(a => a.level === 'critical');
        const alertLevel = criticalAlerts.length > 0 ? 'critical' : 'warning';
        
        this.elements.alertBanner.innerHTML = `
          <div class="alert-banner ${alertLevel === 'warning' ? 'warning' : ''}">
            <div style="display:flex;align-items:flex-start;gap:12px">
              <span style="font-size:24px">${alertLevel === 'critical' ? 'üö®' : '‚ö†Ô∏è'}</span>
              <div style="flex:1">
                <div style="font-weight:700;margin-bottom:8px;font-size:16px">
                  ${alertLevel === 'critical' ? 'CRITICAL ALERTS' : 'WARNINGS'}
                </div>
                <div class="alert-list">
                  ${alerts.slice(0, 5).map(alert => `
                    <div class="alert-item">
                      <div class="alert-icon">${alert.level === 'critical' ? 'üî¥' : 'üü°'}</div>
                      <div class="alert-content">
                        <div class="alert-title">${alert.title}</div>
                        <div class="alert-description">${alert.description}</div>
                      </div>
                    </div>
                  `).join('')}
                </div>
                ${alerts.length > 5 ? `
                  <div style="margin-top:8px;font-size:12px;color:var(--muted)">
                    +${alerts.length - 5} more alerts...
                  </div>
                ` : ''}
              </div>
            </div>
          </div>`;
      }
      
      setStatus(zone, composite) {
        const colors = { green: '#1ec28b', amber: '#ffc247', red: '#ff6070' };
        const labels = { green: 'LOW RISK', amber: 'ELEVATED RISK', red: 'HIGH RISK' };
        
        this.elements.statusBadge.innerHTML = `
          <div class="status" style="background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.08)">
            <span class="status-dot" style="background:${colors[zone]}"></span>
            <span>Composite: ${Math.round(composite)} (${labels[zone]})</span>
          </div>`;
      }
      
      updateAudit(parts) {
        const stale = parts.filter(p => p.freshness === 'badge-stale' || p.freshness === 'badge-old');
        const missing = Object.keys(CONFIG.INDICATORS).filter(key => 
          !parts.find(p => p.key === key)
        );
        
        let auditHTML = '';
        if (missing.length > 0) {
          auditHTML += `<div><b class="bad">Missing</b>: ${missing.join(', ')}</div>`;
        }
        if (stale.length > 0) {
          auditHTML += `<div><b class="warn">Stale</b>: ${stale.map(s => s.label).join(', ')}</div>`;
        }
        if (!auditHTML) {
          auditHTML = '<div style="color:var(--green)">‚úì All data current</div>';
        }
        
        this.elements.auditBox.innerHTML = auditHTML;
      }
      
      calculateConfidence(parts) {
        const freshCount = parts.filter(p => p.freshness === 'badge-fresh').length;
        return Math.round((freshCount / Object.keys(CONFIG.INDICATORS).length) * 100);
      }
      
      getZoneColor(zone) {
        return { green: '#1ec28b', amber: '#ffc247', red: '#ff6070' }[zone];
      }
      
      getZoneLabel(zone) {
        return { green: 'Low Risk', amber: 'Elevated Risk', red: 'High Risk' }[zone];
      }
    }

    // ==================== MAIN APPLICATION ====================
    class App {
      constructor() {
        this.ui = new UIManager();
        this.dataMap = null;
      }
      
      async init() {
        try {
          this.ui.showLoading();
          
          // Load data
          this.dataMap = await DataService.loadFredCache();
          Utils.log('Data map loaded with keys:', Object.keys(this.dataMap));
          
          // Calculate composite
          const compositeData = CompositeCalculator.calculate(this.dataMap);
          
          // Generate alerts
          const alerts = AlertSystem.generateAlerts(compositeData.parts, compositeData.composite);
          
          // Render UI
          this.ui.renderDashboard(compositeData, alerts);
          
        } catch (error) {
          Utils.log('App initialization failed:', error);
          this.ui.showError(error);
        }
      }
    }

    // ==================== INITIALIZE ====================
    const app = new App();
    app.init();
  </script>
</body>
</html>
