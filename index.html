<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>CrashRadar — Composite Crash Risk</title>
<link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
<link rel="dns-prefetch" href="https://cdn.jsdelivr.net">
<style>
  :root{
    --bg:#0f1421; --panel:#161c2e; --muted:#9aa6bf;
    --text:#e8eeff; --accent:#7da6ff; --green:#1ec28b; --amber:#ffc247; --red:#ff6070;
    --grid:#2a3148;
  }
  html,body{margin:0;background:var(--bg);color:var(--text);font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Inter,Helvetica,Arial;}
  .wrap{max-width:980px;margin:0 auto;padding:20px 16px 64px;}
  h1{font-size:clamp(28px,5.5vw,44px);line-height:1.1;margin:0 0 8px;}
  .sub{color:var(--muted);margin:6px 0 18px;font-size:14px}
  .ok{color:var(--green)} .warn{color:var(--amber)} .bad{color:var(--red)}
  .card{background:var(--panel);border-radius:16px;padding:18px 16px;margin:14px 0;box-shadow:0 0 0 1px rgba(255,255,255,0.03) inset;}
  .row{display:grid;gap:12px}
  @media(min-width:760px){.row{grid-template-columns:1fr 1fr}}
  .pill{display:inline-block;background:#13192a;border:1px solid #1f2740;color:var(--text);
        padding:8px 12px;border-radius:999px;font-weight:600;margin:6px 8px 0 0;}
  .meta{color:var(--muted);font-size:13px}
  .chart{position:relative;height:300px}
  .gauge{display:flex;align-items:center;gap:16px;flex-wrap:wrap}
  .ring{width:180px;height:180px;border-radius:50%;background:
        conic-gradient(var(--green) 0deg 120deg, var(--amber) 120deg 216deg, var(--red) 216deg 360deg);
        display:grid;place-items:center;isolation:isolate}
  .ring::after{content:"";position:absolute;width:140px;height:140px;border-radius:50%;background:var(--panel)}
  .score{position:absolute;font-weight:800;font-size:36px}
  .badge{display:inline-block;padding:6px 12px;border-radius:10px;font-weight:800;letter-spacing:.4px}
  .badge.green{background:rgba(30,194,139,.15);color:var(--green);border:1px solid rgba(30,194,139,.35)}
  .badge.amber{background:rgba(255,194,71,.15);color:var(--amber);border:1px solid rgba(255,194,71,.35)}
  .badge.red{background:rgba(255,96,112,.17);color:var(--red);border:1px solid rgba(255,96,112,.35)}
  .callout{font-size:14px;color:var(--muted)}
  canvas{width:100% !important;height:100% !important;}
  .foot{margin-top:24px}
  .list{padding-left:18px;margin:8px 0 0}
  .err{background:#2b1620;color:#ffdbe0;border:1px solid #57313f;padding:10px 12px;border-radius:10px}
</style>
</head>
<body>
  <div class="wrap">
    <h1>CrashRadar — Composite Crash Risk</h1>
    <div id="status" class="sub">Loading…</div>

    <div class="card">
      <div class="gauge">
        <div style="position:relative">
          <div class="ring" id="garRing"></div>
          <div class="score" id="scoreText">–</div>
        </div>
        <div>
          <h2 style="margin:0 0 6px;font-size:26px">Composite Score <span id="garBadge" class="badge">—</span></h2>
          <div class="callout">Lower is safer. Thresholds: <b>Green ≤ 30</b>, <b>Amber ≤ 60</b>, <b>Red &gt; 60</b>.</div>
          <div class="meta" id="freshness" style="margin-top:8px">—</div>
          <div style="margin-top:10px">
            <span class="pill" id="pill_t10y3m">Yield (10y–3m): —</span>
            <span class="pill" id="pill_credit">Credit (BAA–AAA): —</span>
            <span class="pill" id="pill_un">Unemp Δ6m: —</span>
            <span class="pill" id="pill_dd">Drawdown 12m: —</span>
            <span class="pill" id="pill_nfci">NFCI: —</span>
          </div>
        </div>
      </div>
    </div>

    <div class="card">
      <h3 style="margin:0 0 8px">Composite (normalised 0–100)</h3>
      <div class="meta">Legend: <span class="ok">●</span> Green &nbsp; <span class="warn">●</span> Amber &nbsp; <span class="bad">●</span> Red</div>
      <div class="chart"><canvas id="compChart"></canvas></div>
      <div class="callout">Composite (30-day rolling). Smoothed view of the overall risk mix using recent readings.</div>
    </div>

    <div id="charts"></div>

    <div class="card foot">
      <h3 style="margin:0 0 6px;">Diagnostics</h3>
      <pre id="diag" style="white-space:pre-wrap;word-break:break-word;color:#ffdca8;background:#241d12;border:1px solid #4a3e20;border-radius:10px;padding:10px 12px;max-height:420px;overflow:auto"></pre>
    </div>
  </div>

  <!-- Chart.js + annotation plugin -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3.1.1/dist/chartjs-plugin-annotation.min.js"></script>

  <script>
  (async function main() {
    const status = (msg, cls) => {
      const el = document.getElementById('status');
      el.textContent = msg;
      el.className = 'sub ' + (cls || '');
    };

    // -------- helpers
    const gbDate = d => new Date(d).toLocaleDateString('en-GB',{year:'numeric',month:'short',day:'2-digit'});
    const safeNum = v => (v===null||v===undefined||isNaN(+v)) ? null : +v;
    const last = arr => (arr && arr.length ? arr[arr.length-1] : null);

    // Normalisers (domain → 0..100 risk). Tweak anytime.
    const scales = {
      // More negative inversion = worse; +1% to -2% typical range
      T10Y3M: v => clamp(map(v, 1.0, -2.0)),
      // Wider credit spread (BAA-AAA) worse; 0.3→1.0 typical
      CREDIT: v => clamp(map(v, 0.3, 1.0)),
      // 6m change in unemployment; 0→0.6 typical
      UN_SLOPE6: v => clamp(map(v, 0.0, 0.6)),
      // 12m drawdown negative worse; 0→-30% typical
      DD_12M: v => clamp(map(v, 0.0, -0.30)),
      // NFCI higher=tighter; -0.8→+1 typical
      NFCI: v => clamp(map(v, -0.8, 1.0)),
    };
    function map(val, good, bad){ // good -> 0, bad -> 100 (linear)
      if (val==null) return 50;
      const t = (val - good) / (bad - good);
      return t*100;
    }
    const clamp = x => Math.max(0, Math.min(100, x));

    const zoneOf = s => s<=30 ? 'green' : (s<=60 ? 'amber' : 'red');

    // ------- load cache
    let dataRaw, err=null;
    try {
      const res = await fetch('data/fred_cache.json', {cache:'no-cache'});
      if(!res.ok) throw new Error('HTTP '+res.status);
      dataRaw = await res.json();
      status('Cache file found and parsed.','ok');
    } catch(e) {
      err = e;
      status('No cache yet — run the workflow','bad');
      document.getElementById('diag').textContent = 'Load error: '+e;
      return;
    }

    // ------- validate & coerce
    const S = dataRaw?.series || {};
    const seriesKeys = ['T10Y3M','CREDIT','UN_SLOPE6','DD_12M','NFCI'];
    const diagObj = { fetched_at_utc: dataRaw.fetched_at_utc || null, last: {}, samples:{} };

    function seriesToXY(key){
      const obs = S[key]?.observations || [];
      const xs=[], ys=[];
      for(const row of obs){
        const v = safeNum(row.value);
        if(v==null || !row.date) continue;
        xs.push(gbDate(row.date));
        ys.push(v);
      }
      diagObj.samples[key] = ys.length;
      return {xs,ys};
    }

    const latest = {};
    const xys = {};
    for(const k of seriesKeys){
      xys[k] = seriesToXY(k);
      latest[k] = last(xys[k].ys);
      diagObj.last[k] = latest[k];
    }

    // ------- compute composite
    // weights: UC 25, Credit 25, Unemp 20, Drawdown 20, NFCI 10
    const weights = {T10Y3M:0.25, CREDIT:0.25, UN_SLOPE6:0.20, DD_12M:0.20, NFCI:0.10};
    const scores = {};
    let composite = 0;
    for(const k of seriesKeys){
      const s = scales[k](latest[k]);
      scores[k] = Math.round(s*10)/10;
      composite += (isFinite(s)? s : 50) * (weights[k]||0);
    }
    composite = Math.round(composite*10)/10;  // 0..100

    // ------ UI: header ring + pills
    const zone = zoneOf(composite);
    const badge = document.getElementById('garBadge');
    badge.className = 'badge '+zone;
    badge.textContent = zone.toUpperCase();

    document.getElementById('scoreText').textContent = isFinite(composite)? Math.round(composite) : '–';
    document.getElementById('freshness').textContent =
      (dataRaw.fetched_at_utc ? gbDate(dataRaw.fetched_at_utc)+' '+new Date(dataRaw.fetched_at_utc).toLocaleTimeString('en-GB',{hour:'2-digit',minute:'2-digit'}) : '—');

    const pill = (id, val, fmt) => document.getElementById(id).textContent =
      document.getElementById(id).textContent.split(':')[0]+': '+(val==null?'—':fmt(val));

    pill('pill_t10y3m', latest.T10Y3M, v=>v.toFixed(2));
    pill('pill_credit', latest.CREDIT, v=>v.toFixed(2));
    pill('pill_un', latest.UN_SLOPE6, v=>v.toFixed(2));
    pill('pill_dd', latest.DD_12M, v=>(v*100).toFixed(1)+'%');
    pill('pill_nfci', latest.NFCI, v=>v.toFixed(3));

    // ------ Composite history proxy (use normalised weighted history if lengths match; otherwise show last 30 points of best-covered series)
    const len = Math.min(...seriesKeys.map(k => xys[k].ys.length || Infinity));
    let compXs=[], compYs=[];
    if(isFinite(len) && len>=3){
      // build aligned history from the tail 'len' points
      const tail = len; // full overlap
      compXs = xys.T10Y3M.xs.slice(-tail);
      for(let i= -tail; i<0; i++){
        const point = {
          T10Y3M: xys.T10Y3M.ys.at(i),
          CREDIT: xys.CREDIT.ys.at(i),
          UN_SLOPE6: xys.UN_SLOPE6.ys.at(i),
          DD_12M: xys.DD_12M.ys.at(i),
          NFCI: xys.NFCI.ys.at(i)
        };
        let c=0;
        for(const k of seriesKeys){
          c += (scales[k](point[k])*(weights[k]||0));
        }
        compYs.push(Math.round(c*10)/10);
      }
    } else {
      // fallback: show last 12 of an available series
      const k = seriesKeys.find(k=>xys[k].ys.length>0);
      compXs = xys[k].xs.slice(-12);
      const base = xys[k].ys.slice(-12).map(v=>Math.round(scales[k](v)*10)/10);
      compYs = base;
    }

    // ------ draw charts
    Chart.register(ChartAnnotation);
    const baseOpts = {
      responsive:true, maintainAspectRatio:false,
      scales:{
        x:{ grid:{color:'rgba(255,255,255,0.04)'}, ticks:{ color:'#9aa6bf', maxRotation:0, autoSkip:true }},
        y:{ grid:{color:'rgba(255,255,255,0.04)'}, ticks:{ color:'#9aa6bf' } }
      },
      plugins:{
        legend:{display:false},
        tooltip:{enabled:true, callbacks:{
          label:(ctx)=> (ctx.parsed.y!=null? ctx.parsed.y.toFixed(2):'')
        }},
        annotation:{
          annotations:{
            green:{ type:'line', yMin:30, yMax:30, borderColor:'rgba(30,194,139,.6)', borderDash:[4,4], borderWidth:1.5 },
            amber:{ type:'line', yMin:60, yMax:60, borderColor:'rgba(255,194,71,.6)', borderDash:[4,4], borderWidth:1.5 },
          }
        }
      },
      elements:{ line:{ tension:.35, borderWidth:2 }, point:{ radius:2, hitRadius:8 } }
    };

    new Chart(document.getElementById('compChart'), {
      type:'line',
      data:{ labels: compXs, datasets:[{ data:compYs, borderColor:'#7da6ff', backgroundColor:'transparent' }]},
      options:{ ...baseOpts, scales:{...baseOpts.scales, y:{...baseOpts.scales.y, min:0, max:100}}}
    });

    // Per-indicator charts (with zone bands if helpful)
    const chartHost = document.getElementById('charts');
    function addPanel(title, key, explain, fmt, yHint){
      const card = document.createElement('div');
      card.className = 'card';
      card.innerHTML = `<h3 style="margin:0 0 8px">${title}</h3>
        <div class="chart"><canvas id="c_${key}"></canvas></div>
        <div class="callout">${explain}</div>`;
      chartHost.appendChild(card);

      const xs = xys[key].xs, ys = xys[key].ys;
      if(!ys.length){ 
        const p=document.createElement('div'); p.className='err'; p.textContent='No data yet for '+key;
        card.appendChild(p); return;
      }
      const ctx = document.getElementById('c_'+key);
      const ann = {};
      if(yHint && yHint.green!=null) ann.green = {type:'line', yMin:yHint.green, yMax:yHint.green, borderColor:'rgba(30,194,139,.6)', borderDash:[4,4], borderWidth:1.5};
      if(yHint && yHint.amber!=null) ann.amber = {type:'line', yMin:yHint.amber, yMax:yHint.amber, borderColor:'rgba(255,194,71,.6)', borderDash:[4,4], borderWidth:1.5};

      new Chart(ctx,{
        type:'line',
        data:{ labels: xs, datasets:[{ data: ys, borderColor: yHint?.color || '#7da6ff', backgroundColor:'transparent'}]},
        options:{
          ...baseOpts,
          plugins:{ ...baseOpts.plugins, tooltip:{enabled:true, callbacks:{label:(c)=> fmt?fmt(c.parsed.y):c.parsed.y}}, annotation:{annotations:ann}}
        }
      });
    }

    addPanel('Yield Curve (10y–3m)','T10Y3M',
      '<b>More negative = worse</b>. Inversions (below zero) are classic pre-recession and drawdown signals.',
      v=>v.toFixed(2), {green:0.0, amber:-0.3, color:'#6bb9ff'});

    addPanel('Credit Spread (BAA–AAA)','CREDIT',
      '<b>Wider = worse</b>. Rising lower-grade vs top-tier borrowing costs reflect stress building in corporate credit.',
      v=>v.toFixed(2), {green:0.6, amber:0.75, color:'#ffb36b'});

    addPanel('Unemployment 6-month slope','UN_SLOPE6',
      '<b>Rising = worse</b>. Early deterioration in labour markets is a late-cycle risk signal.',
      v=>v.toFixed(2), {green:0.10, amber:0.20, color:'#ffa0b5'});

    addPanel('12-month Drawdown (S&P vs 1-yr peak)','DD_12M',
      '<b>More negative = worse</b>. Captures market-price stress (complements macro/credit indicators).',
      v=>(v*100).toFixed(1)+'%', {green:-0.04, amber:-0.08, color:'#a6c7ff'});

    addPanel('Chicago Fed NFCI','NFCI',
      '<b>Higher = tighter/worse</b>. Summarises overall financial conditions (rates, credit, funding, volatility).',
      v=>v.toFixed(3), {green:-0.2, amber:0.0, color:'#9bd3c1'});

    // diag
    document.getElementById('diag').textContent = JSON.stringify({
      fetched_at_utc: dataRaw.fetched_at_utc || null,
      last_updated: last(Object.values(S).map(s=>s?.observations?.length? s.observations.at(-1).date:null).filter(Boolean)),
      latest_values: diagObj.last,
      sample_sizes: Object.fromEntries(seriesKeys.map(k=>[k, xys[k].ys.length])),
      composite, scores
    }, null, 2);
  })();
  </script>
</body>
</html>
