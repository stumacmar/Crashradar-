<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>CrashRadar Deep Diagnostic</title>
<style>
  body { background:#000;color:#0f0;font-family:monospace;padding:20px; }
  .err { color:#f55; }
  .ok { color:#5f5; }
  h2 { color:#6bf; }
</style>
</head>

<body>
<h2>CrashRadar Deep Diagnostic</h2>
<pre id="log">Starting…</pre>

<script>
// Utility to log to screen
function out(msg, cls="") {
  const log = document.getElementById("log");
  log.innerHTML += (cls ? `<span class="${cls}">${msg}</span>` : msg) + "\n";
}

// Wrapper to load modules and inspect exports
async function loadModule(path) {
  try {
    const mod = await import(path + `?v=${Date.now()}`);
    return { ok:true, mod };
  } catch (err) {
    return { ok:false, err };
  }
}

// Expected dependency map
const dependencies = {
  "./js/scoring.js": [
    "computeComposite",
    "scaleIndicator",
    "stressVerdictLabel",
    "valuationStress",
    "derivedRecessionRisk",
    "derivedValuationRisk",
    "derivedLaborStress",
    "computeContributions"
  ],
  "./js/uiGauge.js": [
    "derivedRecessionRisk",
    "derivedValuationRisk",
    "derivedLaborStress",
    "computeContributions",
    "stressVerdictLabel"
  ],
  "./js/uiIndicators.js": [
    "scaleIndicator",
    "stressVerdictLabel",
    "valuationStress"
  ],
  "./js/uiCharts.js": [
    "updateCompositeHistoryChart",
    "updateRiskRadarChart"
  ],
  "./js/app.js": [
    // app.js imports many modules; we detect failures globally
  ]
};

async function runDiagnostics() {
  out("Loading config.js…");
  const cfg = await loadModule("./js/config.js");
  if (cfg.ok) out("✔ config.js loaded", "ok");
  else out("✖ config.js failed", "err");

  out("\nLoading scoring.js…");
  const scoring = await loadModule("./js/scoring.js");
  if (scoring.ok) {
    out("✔ scoring.js loaded", "ok");
    out("Exports: " + Object.keys(scoring.mod).join(", "));
  } else {
    out("✖ scoring.js failed: " + scoring.err, "err");
  }

  out("\nChecking required scoring.js exports…");
  if (scoring.ok) {
    const exported = Object.keys(scoring.mod);
    dependencies["./js/scoring.js"].forEach(fn => {
      if (exported.includes(fn)) out("✔ " + fn, "ok");
      else out("✖ MISSING → " + fn, "err");
    });
  }

  out("\nLoading uiGauge.js…");
  const gauge = await loadModule("./js/uiGauge.js");
  if (gauge.ok) {
    out("✔ uiGauge.js loaded", "ok");
  } else {
    out("✖ uiGauge.js FAILED: " + gauge.err, "err");
  }

  out("\nResolving uiGauge.js imports…");
  if (gauge.ok && scoring.ok) {
    const scoringExports = Object.keys(scoring.mod);
    dependencies["./js/uiGauge.js"].forEach(fn => {
      if (scoringExports.includes(fn)) out("✔ found: " + fn, "ok");
      else out("✖ missing import: " + fn, "err");
    });
  }

  out("\nLoading uiIndicators.js…");
  const ind = await loadModule("./js/uiIndicators.js");
  if (ind.ok) out("✔ uiIndicators.js loaded", "ok");
  else out("✖ uiIndicators FAILED: " + ind.err, "err");

  out("\nChecking uiIndicators imports from scoring.js…");
  if (ind.ok && scoring.ok) {
    const scoringExports = Object.keys(scoring.mod);
    dependencies["./js/uiIndicators.js"].forEach(fn => {
      if (scoringExports.includes(fn)) out("✔ found: " + fn, "ok");
      else out("✖ missing import: " + fn, "err");
    });
  }

  out("\nLoading uiCharts.js…");
  const charts = await loadModule("./js/uiCharts.js");
  if (charts.ok) out("✔ uiCharts.js loaded", "ok");
  else out("✖ uiCharts FAILED: " + charts.err, "err");

  out("\nAll diagnostics completed.");
}

runDiagnostics();
</script>
</body>
</html>
