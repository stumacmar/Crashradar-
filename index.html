<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>CrashRadar — Recession Risk (GAR)</title>

<!-- Chart.js (official CDN) -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

<style>
  :root{
    --bg:#0e1326; --card:#161b3a; --muted:#9aa2c9; --text:#eef0ff; --accent:#7ea6ff;
    --ok:#21d07a; --warn:#ffd166; --risk:#ff5c7a; --ring:#0f1430; --grid:#2a2f55;
  }
  html,body{margin:0;background:var(--bg);color:var(--text);font:15px system-ui,Segoe UI,Roboto,Helvetica,Arial}
  a{color:var(--accent);text-decoration:none}
  header{padding:18px 14px;border-bottom:1px solid rgba(255,255,255,.06)}
  h1{margin:0 0 4px;font-size:26px;color:#a7c4ff}
  .sub{color:var(--muted);font-size:12px}
  main{padding:12px;max-width:1200px;margin:0 auto}
  .grid{display:grid;grid-template-columns:1fr;gap:12px}
  @media(min-width:1024px){.grid{grid-template-columns:1.35fr 0.9fr}}
  .card{background:var(--card);border-radius:12px;padding:16px}
  .row{display:grid;grid-template-columns:1fr;gap:12px}
  @media(min-width:760px){.row{grid-template-columns:1fr 1fr}}
  .kpi{font-size:44px;font-weight:800;line-height:1.05}
  .badge{display:inline-block;border-radius:10px;padding:4px 8px;font-weight:700;margin-left:8px}
  .g{background:rgba(33,208,122,.16);color:var(--ok)}
  .y{background:rgba(255,209,102,.18);color:var(--warn)}
  .r{background:rgba(255,92,122,.18);color:var(--risk)}

  /* Gauge */
  .gauge-wrap{display:flex;gap:18px;align-items:center;flex-wrap:wrap}
  .gauge{
    --deg:0deg; --col:var(--ok);
    width:180px;height:180px;border-radius:50%;
    background:conic-gradient(var(--col) var(--deg), #2a2f55 var(--deg));
    display:grid;place-items:center;position:relative;
  }
  .gauge:after{content:"";position:absolute;inset:12px;border-radius:50%;background:var(--ring)}
  .gauge-val{position:relative;font-weight:800;font-size:28px}
  .legend{font-size:12px;color:var(--muted);margin-top:6px}

  /* Charts */
  .chart{position:relative;height:280px;margin:12px 0 8px;background:#10163a;border-radius:10px;padding:8px}
  .chart canvas{display:block;width:100% !important;height:100% !important}
  .blurb{font-size:13px;color:#cfe3ff;line-height:1.35}
  .blurb em{color:var(--muted);font-style:normal}

  .pill{display:inline-block;background:#0f1430;border-radius:999px;padding:8px 10px;margin:6px 8px 0 0;color:var(--muted);font-weight:600}
  .pill b{color:var(--text)}
  .delta-up{color:var(--risk);font-weight:700}
  .delta-down{color:var(--ok);font-weight:700}

  details{background:#10163a;padding:10px;border-radius:8px}
  summary{cursor:pointer;color:#cfe3ff}
  pre{white-space:pre-wrap;background:#0f1430;border-radius:8px;padding:10px;color:#ffd166;overflow:auto;max-height:360px;margin:8px 0 0}

  .err{color:#ff6b6b}
  .ok{color:#6bff8b}

  /* Accessibility / motion */
  @media (prefers-reduced-motion: reduce){
    *{animation:none;transition:none}
  }
</style>
</head>
<body>
<header>
  <h1>CrashRadar — Recession Risk (GAR)</h1>
  <div id="loadStatus" class="sub">Loading <code>data/fred_cache.json</code> …</div>
</header>

<main>
  <section class="grid">
    <!-- LEFT: Composite -->
    <div class="card">
      <div class="gauge-wrap">
        <div id="gauge" class="gauge" aria-label="Composite GAR gauge">
          <div class="gauge-val" id="gaugeVal">—</div>
        </div>
        <div>
          <div style="font-weight:700;font-size:18px;margin-bottom:4px">
            Composite Score <span id="riskBadge" class="badge">—</span>
          </div>
          <div class="legend">Thresholds: <b>Green ≤ 0.50</b> • <b>Amber ≤ 1.00</b> • <b>Red &gt; 1.00</b> (lower is safer)</div>
          <div id="fresh" class="sub" style="margin-top:6px">Data freshness: —</div>
          <div id="drivers" class="sub" style="margin-top:6px;max-width:560px">
            The composite blends <em>Yield curve</em>, <em>Credit spread</em>, <em>Lending standards / Labor slope</em>, <em>Equity drawdown</em>, and <em>NFCI</em> via normalized weights.
          </div>
        </div>
      </div>

      <div class="chart"><canvas id="cComp"></canvas></div>
      <div class="blurb">
        <b>Composite (rolling proxy).</b> A smoothed view of the overall risk mix using recent readings. The ring shows the current **GAR** zone and how far into that zone the score is.
      </div>
    </div>

    <!-- RIGHT: KPIs + Insights -->
    <aside class="card">
      <b>Latest readings</b>
      <div class="pill">Term (10y–3m): <b id="k_term">—</b> <span id="d_term" class="sub"></span></div>
      <div class="pill">Credit (BAA–AAA): <b id="k_credit">—</b> <span id="d_credit" class="sub"></span></div>
      <div class="pill">Unemp 6m slope: <b id="k_un">—</b> <span id="d_un" class="sub"></span></div>
      <div class="pill">12m Drawdown: <b id="k_dd">—</b> <span id="d_dd" class="sub"></span></div>
      <div class="pill">NFCI: <b id="k_nfci">—</b> <span id="d_nfci" class="sub"></span></div>
      <div class="sub" style="margin-top:8px">Deltas vs prior reading. Red ▲ = riskier; Green ▼ = safer.</div>

      <div style="margin-top:14px"><b>Insights</b>
        <ul id="insights" class="sub" style="margin:.4rem 0 0 .9rem"></ul>
      </div>
    </aside>
  </section>

  <!-- Indicator charts with explanations -->
  <section class="card">
    <b>Indicators</b>
    <div class="row">
      <div>
        <div class="chart"><canvas id="cTerm"></canvas></div>
        <div class="blurb">
          <b>Yield Curve (10y–3m spread):</b> <em>More negative = worse.</em> Inversions (below zero) precede recessions as markets price future cuts.
        </div>
      </div>
      <div>
        <div class="chart"><canvas id="cCredit"></canvas></div>
        <div class="blurb">
          <b>Credit Spread (BAA–AAA):</b> <em>Wider = worse.</em> Rising risk premia signal stress in corporate credit and tighter conditions.
        </div>
      </div>
      <div>
        <div class="chart"><canvas id="cUn"></canvas></div>
        <div class="blurb">
          <b>Unemployment 6-month slope:</b> <em>Rising = worse.</em> Persistent uptick in unemployment is a classic late-cycle warning.
        </div>
      </div>
      <div>
        <div class="chart"><canvas id="cDD"></canvas></div>
        <div class="blurb">
          <b>12-month Drawdown (S&amp;P vs 1-yr peak):</b> <em>More negative = worse.</em> Captures market stress that complements macro signals.
        </div>
      </div>
      <div>
        <div class="chart"><canvas id="cNFCI"></canvas></div>
        <div class="blurb">
          <b>Chicago Fed NFCI:</b> <em>Higher = tighter/worse.</em> Summarizes overall financial conditions across rates, credit, funding, volatility.
        </div>
      </div>
    </div>
  </section>

  <section class="card">
    <b>Diagnostics</b>
    <details>
      <summary>Open raw JSON & paths</summary>
      <div id="diagHead" class="sub" style="margin:8px 0 6px">Loading…</div>
      <pre id="diag">Waiting…</pre>
      <div class="sub">If you see “No cache yet”, run the GitHub Action to create <code>data/fred_cache.json</code>.</div>
    </details>
  </section>
</main>

<script>
/* =================== Utilities =================== */
const $ = s => document.querySelector(s);
const fmt = (x,d=2)=>Number.isFinite(x)?(+x).toFixed(d):'—';
const pct = (x,d=1)=>Number.isFinite(x)?(x*100).toFixed(d)+'%':'—';
function deltaStr(curr, prev, goodDown=false){
  if(!Number.isFinite(curr) || !Number.isFinite(prev)) return '';
  const diff = curr - prev;
  if(Math.abs(diff) < 1e-12) return '';
  const upBad = goodDown ? diff>0 : diff<0; // choose arrow color by “worse” direction
  const cls = upBad ? 'delta-up' : 'delta-down';
  const arrow = diff>0 ? '▲' : '▼';
  return ` <span class="${cls}">${arrow} ${fmt(Math.abs(diff),2)}</span>`;
}

/* =================== Gauge =================== */
function setBadge(score){
  const b = $('#riskBadge'); b.className='badge';
  if(!Number.isFinite(score)){ b.textContent='—'; return; }
  if(score <= 0.5){ b.textContent='GREEN'; b.classList.add('g'); }
  else if(score <= 1.0){ b.textContent='AMBER'; b.classList.add('y'); }
  else { b.textContent='RED'; b.classList.add('r'); }
}
function renderGauge(score){
  const g = $('#gauge'), gv = $('#gaugeVal');
  g.style.setProperty('--deg','0deg'); g.style.setProperty('--col','var(--ok)');
  gv.textContent = '—'; setBadge(NaN);
  if(!Number.isFinite(score)) return;
  gv.textContent = score.toFixed(2);
  let col = 'var(--ok)';
  if(score <= 0.5){ col='var(--ok)'; }
  else if(score <= 1.0){ col='var(--warn)'; }
  else { col='var(--risk)'; }
  // Fill 0..2 (cap) so the ring doesn’t spin too far
  const cap = Math.max(0, Math.min(score, 2.0));
  const deg = (cap/2.0)*360;
  g.style.setProperty('--deg', deg+'deg');
  g.style.setProperty('--col', col);
  setBadge(score);
}

/* =================== Charts =================== */
function chartOptions(title, yFormatter=null){
  return {
    responsive:true, maintainAspectRatio:false,
    plugins:{
      legend:{display:false},
      title:{display:true,text:title,color:'#cfe3ff'}
    },
    scales:{
      x:{ ticks:{color:'#9aa2c9',maxRotation:0,autoSkip:true}, grid:{color:'rgba(255,255,255,.06)'} },
      y:{ ticks:{color:'#9aa2c9', callback: yFormatter || ((v)=>v) }, grid:{color:'rgba(255,255,255,.06)'} }
    },
    elements:{ line:{ tension:0.25 }, point:{ radius:0 } }
  };
}
const liveCharts = new Map();
function drawLine(canvasId, title, labels, values, yFmt=null, color='#7ea6ff'){
  const el = document.getElementById(canvasId); if(!el) return;
  const ctx = el.getContext('2d');
  if(liveCharts.has(canvasId)){ try{ liveCharts.get(canvasId).destroy(); }catch(e){} }
  liveCharts.set(canvasId, new Chart(ctx, {
    type:'line',
    data:{ labels, datasets:[{ label:title, data:values, borderColor:color, backgroundColor:'rgba(126,166,255,.18)' }] },
    options: chartOptions(title, yFmt)
  }));
}

/* =================== Data shaping =================== */
function toSeries(obs, n=360){
  if(!Array.isArray(obs)) return {labels:[], values:[]};
  const clean = obs.filter(o => o && o.date && Number.isFinite(+o.value))
                   .map(o => ({d:o.date, v:+o.value}));
  const take = clean.slice(-n);
  return { labels: take.map(x=>x.d), values: take.map(x=>x.v) };
}
function lastTwo(arr){
  if(!Array.isArray(arr) || arr.length<2) return [NaN,NaN];
  return [+arr[arr.length-1].value, +arr[arr.length-2].value];
}

/* =================== Main =================== */
(async function(){
  const status = $('#loadStatus'), diag = $('#diag'), head=$('#diagHead');
  try{
    const r = await fetch('data/fred_cache.json', {cache:'no-store'});
    if(!r.ok) throw new Error(`HTTP ${r.status}`);
    const txt = await r.text();
    let j; try{ j = JSON.parse(txt); }catch(e){ throw new Error('Invalid JSON: '+e.message); }

    // Diagnostics
    head.textContent = 'Cache loaded.'; diag.textContent = txt;
    status.textContent = '✅ Cache parsed';

    // Timestamps
    const fetchedAt = j.fetched_at_utc || j.last_updated || (j.composite_score && j.composite_score.last_updated) || null;
    $('#fresh').textContent = fetchedAt ? new Date(fetchedAt).toLocaleString() : '—';

    // Composite score (expect j.composite_score.score)
    const comp =
      (j.composite_score && typeof j.composite_score.score === 'number')
      ? j.composite_score.score
      : (typeof j.composite === 'number' ? j.composite
         : (typeof j.score === 'number' ? j.score : NaN));
    renderGauge(comp);

    // Grab series
    const S = j.series || {};

    // Latest + deltas
    function last(key){ const arr = S[key]?.observations||[]; return arr.length? +arr[arr.length-1].value : NaN; }
    function prev(key){ const arr = S[key]?.observations||[]; return arr.length>1? +arr[arr.length-2].value : NaN; }

    const vTerm = last('T10Y3M'); const pTerm = prev('T10Y3M'); // more negative = worse
    const vCredit= last('CREDIT'); const pCredit= prev('CREDIT'); // wider = worse
    const vUn   = last('UN_SLOPE6'); const pUn   = prev('UN_SLOPE6'); // rising = worse
    const vDD   = last('DD_12M'); const pDD   = prev('DD_12M'); // more negative = worse
    const vN    = last('NFCI'); const pN    = prev('NFCI'); // higher = worse

    $('#k_term').textContent   = fmt(vTerm,2);
    $('#k_credit').textContent = fmt(vCredit,2);
    $('#k_un').textContent     = fmt(vUn,2);
    $('#k_dd').textContent     = Number.isFinite(vDD)?(vDD*100).toFixed(1)+'%':'—';
    $('#k_nfci').textContent   = fmt(vN,3);

    // Deltas (note: “worse” direction per metric)
    // term: more negative is worse => goodDown=false (down is worse), so goodDown=true? No: down (more negative) should be red; use goodDown=false but with sign inverted via diff calc above
    // Simpler: we just set goodDown to true when DOWN is good (i.e. we want green on ▼). For term, DOWN is worse => goodDown=false.
    $('#d_term').innerHTML   = deltaStr(vTerm, pTerm, /*goodDown=*/false);
    $('#d_credit').innerHTML = deltaStr(vCredit, pCredit, /*goodDown=*/false);
    $('#d_un').innerHTML     = deltaStr(vUn, pUn, /*goodDown=*/false);
    // Drawdown: more negative is worse; if DD becomes less negative (moves up), that’s good (▼ or ▲?). We pass goodDown=true so ▼ (down) is green; but for DD, “down” (more negative) is bad, so goodDown=false.
    $('#d_dd').innerHTML     = deltaStr(vDD, pDD, /*goodDown=*/false);
    $('#d_nfci').innerHTML   = deltaStr(vN, pN, /*goodDown=*/false);

    // Indicator charts
    function renderOne(key, title, canvasId, yFmt=null, color='#7ea6ff'){
      const {labels, values} = toSeries(S[key]?.observations);
      drawLine(canvasId, title, labels, values, yFmt, color);
    }
    renderOne('T10Y3M', 'Yield Curve (10y–3m)', 'cTerm', null, '#68c1ff');
    renderOne('CREDIT', 'Credit Spread (BAA–AAA)', 'cCredit', null, '#ffbb66');
    renderOne('UN_SLOPE6', 'Unemployment 6m slope', 'cUn', null, '#ff8899');
    renderOne('DD_12M', '12m Drawdown', 'cDD', (v)=> (v*100).toFixed(0)+'%', '#a089ff');
    renderOne('NFCI', 'NFCI', 'cNFCI', (v)=> v.toFixed(2), '#7dd39f');

    // Composite rolling proxy: simple unweighted mean across available standardized components per index step
    const compLabels = (() => {
      for (const k of Object.keys(S)){
        const lbls = toSeries(S[k]?.observations).labels;
        if(lbls.length) return lbls;
      }
      return [];
    })();
    const tObs = S.T10Y3M?.observations||[];
    const cObs = S.CREDIT?.observations||[];
    const uObs = S.UN_SLOPE6?.observations||[];
    const dObs = S.DD_12M?.observations||[];
    const nObs = S.NFCI?.observations||[];

    function at(arr,i){ return (arr && i < arr.length) ? +arr[i].value : NaN; }
    const compValues = compLabels.map((_,i)=>{
      const vals = [at(tObs,i), at(cObs,i), at(uObs,i), at(dObs,i), at(nObs,i)];
      const num = vals.filter(Number.isFinite);
      if(!num.length) return NaN;
      // quick normalization-ish: center each per small window? Keep it simple: average raw for visual proxy.
      const m = num.reduce((a,b)=>a+b,0)/num.length;
      return m;
    }).filter(Number.isFinite);
    drawLine('cComp','Composite (rolling proxy)', compLabels.slice(-compValues.length), compValues, null, '#a7c4ff');

    // Insights (automatic, concise)
    const ul = $('#insights'); ul.innerHTML='';
    function add(msg){ const li=document.createElement('li'); li.textContent=msg; ul.appendChild(li); }
    if(Number.isFinite(vN) && vN < 0) add('NFCI < 0 (looser than average).');
    if(Number.isFinite(vTerm) && vTerm < 0) add('Yield curve inverted (10y–3m < 0).');
    if(Number.isFinite(vCredit) && vCredit > 1.0) add('Credit spread > 1.0 — risk rising.');
    if(Number.isFinite(vUn) && vUn > 0.2) add('Unemployment 6m slope rising.');
    if(Number.isFinite(vDD) && vDD < -0.1) add('Equities >10% below 12-month peak.');
    // Momentum cues from deltas:
    const riskUp = [vTerm - pTerm < 0, vCredit - pCredit > 0, vUn - pUn > 0, vDD - pDD < 0, vN - pN > 0]
                   .filter(Boolean).length;
    if(riskUp >= 3) add('Multiple indicators worsened vs prior reading.');
    if(!ul.children.length) add('No strong signals from latest readings.');

  }catch(e){
    $('#loadStatus').innerHTML = `<span class="err">❌ ${e.message}</span>`;
    $('#diagHead').textContent = 'Error';
    $('#diag').textContent = String(e.stack || e.message || e);
  }
})();
</script>
</body>
</html>
