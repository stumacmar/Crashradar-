<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="description" content="Economic Crash Radar - Advanced market stress monitoring" />
  <title>Economic Crash Radar Pro</title>

  <style>
    :root{
      --bg:#0a0e1a; --panel:#12182b; --panel-hover:#151d33; --muted:#8b96b0;
      --text:#e8eeff; --accent:#6b9eff; --accent-bright:#8fb4ff;
      --green:#1ec28b; --amber:#ffc247; --red:#ff6070; --orange:#ff8c42;
      --radius:14px; --shadow:0 4px 24px rgba(0,0,0,.3);
      --ring:200px; --ring-m:160px;
    }
    *{box-sizing:border-box}
    html,body{margin:0;background:var(--bg);color:var(--text);
      font:15px/1.6 -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Inter,Helvetica,Arial,sans-serif}
    .wrap{max-width:1400px;margin:0 auto;padding:20px 16px 80px}

    header{margin-bottom:24px}
    h1{font-size:clamp(32px,5vw,48px);line-height:1.1;margin:0 0 8px;
      background:linear-gradient(135deg,var(--text),var(--accent-bright));
      -webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
    .subtitle{color:var(--muted);font-size:15px;margin:8px 0}

    .card{background:var(--panel);border-radius:var(--radius);padding:24px;margin:20px 0;
      box-shadow:var(--shadow),0 0 0 1px rgba(255,255,255,.04) inset;transition:transform .2s,box-shadow .2s}
    .card:hover{transform:translateY(-2px);box-shadow:0 6px 32px rgba(0,0,0,.4)}

    .gauge-container{display:flex;align-items:center;gap:32px;flex-wrap:wrap}
    .gauge-wrap{position:relative;width:var(--ring);height:var(--ring)}
    .multi-ring{position:absolute;inset:0}
    .ring{position:absolute;border-radius:50%;transition:opacity .3s}
    .ring-outer{inset:0;background:conic-gradient(var(--green)0 108deg,var(--amber)108deg 216deg,var(--red)216deg 360deg);opacity:.3}
    .ring-mid{inset:15px;background:conic-gradient(var(--green)0 108deg,var(--amber)108deg 216deg,var(--red)216deg 360deg);opacity:.5}
    .ring-inner{inset:30px;background:conic-gradient(var(--green)0 108deg,var(--amber)108deg 216deg,var(--red)216deg 360deg)}
    .ring::after{content:"";position:absolute;inset:20px;border-radius:50%;background:var(--panel)}
    .needle{position:absolute;inset:0;transition:transform .6s cubic-bezier(.34,1.56,.64,1)}
    .needle::before{content:"";position:absolute;top:50%;left:50%;width:4px;height:45%;
      background:linear-gradient(180deg,var(--accent-bright),var(--accent));
      transform:translateX(-50%) translateY(-100%) rotate(var(--angle,0deg));
      transform-origin:bottom center;border-radius:4px;box-shadow:0 0 12px var(--accent)}
    .needle::after{content:"";position:absolute;top:50%;left:50%;width:16px;height:16px;background:var(--accent-bright);
      border-radius:50%;transform:translate(-50%,-50%);box-shadow:0 0 16px var(--accent),0 0 0 3px var(--panel)}
    .score{position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;font-weight:800;font-size:48px;line-height:1}
    .score-label{font-size:12px;font-weight:600;color:var(--muted);margin-top:4px;letter-spacing:.5px}

    .gauge-info h2{font-size:28px;margin:0 0 8px;font-weight:700}
    .confidence{display:inline-flex;align-items:center;gap:8px;background:rgba(107,158,255,.15);padding:6px 12px;border-radius:8px;font-size:13px;font-weight:600;margin-top:8px}
    .confidence-bar{width:60px;height:6px;background:rgba(255,255,255,.1);border-radius:3px;overflow:hidden}
    .confidence-fill{height:100%;background:var(--accent);border-radius:3px;transition:width .3s}

    .pills-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:12px}
    .pill{background:rgba(255,255,255,.03);border:1px solid rgba(255,255,255,.06);padding:14px 16px;border-radius:12px;transition:all .2s;cursor:pointer;position:relative}
    .pill:hover{background:rgba(255,255,255,.06);border-color:rgba(255,255,255,.12);transform:translateY(-2px)}
    .pill:hover .pill-tooltip{opacity:1;visibility:visible;transform:translateY(0)}
    .pill-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px}
    .pill-title{font-weight:600;font-size:13px}
    .pill-badge{font-size:11px;padding:3px 8px;border-radius:6px;font-weight:600}
    .pill-value{font-size:20px;font-weight:700;margin:4px 0}
    .pill-change{font-size:12px;color:var(--muted);display:flex;align-items:center;gap:4px}
    .pill-status{display:inline-block;width:8px;height:8px;border-radius:50%;margin-left:8px}
    .pill-status-green{background:var(--green)}
    .pill-status-amber{background:var(--amber)}
    .pill-status-red{background:var(--red)}
    .pill-tooltip{position:absolute;bottom:calc(100% + 8px);left:50%;transform:translateX(-50%) translateY(-4px);
      background:var(--panel-hover);border:1px solid rgba(255,255,255,.12);padding:12px;border-radius:8px;
      font-size:12px;line-height:1.5;color:var(--text);width:280px;z-index:100;
      box-shadow:0 8px 24px rgba(0,0,0,.4);opacity:0;visibility:hidden;transition:all .2s;pointer-events:none}
    .pill-tooltip::after{content:"";position:absolute;top:100%;left:50%;transform:translateX(-50%);
      border:6px solid transparent;border-top-color:var(--panel-hover)}
    .badge-fresh{background:rgba(30,194,139,.15);color:var(--green)}
    .badge-stale{background:rgba(255,194,71,.15);color:var(--amber)}
    .badge-old{background:rgba(255,96,112,.15);color:var(--red)}
    .info-tooltip{display:inline-block;width:16px;height:16px;line-height:16px;text-align:center;
      background:rgba(255,255,255,.1);border-radius:50%;font-size:11px;font-weight:700;
      cursor:help;margin-left:6px;color:var(--accent-bright)}
    .info-tooltip:hover{background:rgba(255,255,255,.2)}

    .chart-container{position:relative;height:320px;margin:16px 0}
    .chart-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;flex-wrap:wrap;gap:12px}
    .chart-title{font-size:18px;font-weight:600;margin:0}
    .chart-controls{display:flex;gap:8px}
    .btn-group{display:flex;gap:4px;background:rgba(255,255,255,.03);padding:4px;border-radius:8px}
    .btn{background:transparent;border:none;color:var(--muted);padding:6px 14px;border-radius:6px;cursor:pointer;font-size:13px;font-weight:500;transition:all .2s}
    .btn:hover{color:var(--text);background:rgba(255,255,255,.06)}
    .btn.active{background:var(--accent);color:#fff}

    .tabs{display:flex;gap:8px;border-bottom:2px solid rgba(255,255,255,.06);margin-bottom:20px;overflow-x:auto}
    .tab{background:transparent;border:none;color:var(--muted);padding:12px 20px;cursor:pointer;font-size:14px;font-weight:600;position:relative;white-space:nowrap}
    .tab:hover{color:var(--text)}
    .tab.active{color:var(--accent-bright)}
    .tab.active::after{content:"";position:absolute;bottom:-2px;left:0;right:0;height:2px;background:var(--accent)}
    .tab-content{display:none}
    .tab-content.active{display:block}

    .status{display:inline-flex;align-items:center;gap:8px;padding:8px 14px;border-radius:8px;font-weight:600;font-size:13px}
    .status-dot{width:8px;height:8px;border-radius:50%}

    .heatmap{display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:10px}
    .heat-cell{background:rgba(255,255,255,.03);padding:14px;border-radius:10px;border:1px solid rgba(255,255,255,.06)}
    .heat-label{font-size:12px;color:var(--muted)}
    .heat-value{font-size:22px;font-weight:700}
    .bar{height:6px;border-radius:4px;background:rgba(255,255,255,.08);overflow:hidden;margin-top:8px}
    .bar > span{display:block;height:100%;border-radius:4px}

    .audit{font-size:12px;color:var(--muted);margin-top:8px}
    .audit .bad{color:#ff9da6}
    .audit .warn{color:#ffc247}

    .loading{text-align:center;padding:40px;color:var(--muted)}
    .error-state{background:rgba(255,96,112,.1);border:1px solid rgba(255,96,112,.3);padding:20px;border-radius:var(--radius);margin:20px 0}

    .alert-banner {
      background: linear-gradient(135deg, rgba(255,96,112,.15), rgba(255,140,66,.15));
      border: 1px solid rgba(255,96,112,.3);
      padding: 16px;
      border-radius: var(--radius);
      margin: 16px 0;
      animation: pulse 2s infinite;
    }
    .alert-banner.warning {
      background: linear-gradient(135deg, rgba(255,194,71,.15), rgba(255,140,66,.1));
      border-color: rgba(255,194,71,.3);
    }
    @keyframes pulse {
      0% { box-shadow: 0 0 0 0 rgba(255,96,112,.4); }
      70% { box-shadow: 0 0 0 10px rgba(255,96,112,0); }
      100% { box-shadow: 0 0 0 0 rgba(255,96,112,0); }
    }

    .alert-list {
      margin-top: 8px;
    }
    .alert-item {
      display: flex;
      align-items: flex-start;
      gap: 8px;
      padding: 8px 0;
      border-bottom: 1px solid rgba(255,255,255,.06);
    }
    .alert-item:last-child {
      border-bottom: none;
    }
    .alert-icon {
      font-size: 16px;
      margin-top: 2px;
    }
    .alert-content {
      flex: 1;
    }
    .alert-title {
      font-weight: 600;
      margin-bottom: 2px;
    }
    .alert-description {
      font-size: 13px;
      color: var(--muted);
      line-height: 1.4;
    }

    .risk-explanation {
      background: rgba(255,255,255,.03);
      padding: 16px;
      border-radius: 10px;
      margin-top: 12px;
      border: 1px solid rgba(255,255,255,.06);
    }

    .historical-comparison {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 12px;
      margin-top: 16px;
    }
    .period-card {
      background: rgba(255,255,255,.03);
      padding: 16px;
      border-radius: 10px;
      border: 1px solid rgba(255,255,255,.06);
    }
    .period-card.critical {
      background: rgba(255,96,112,.1);
      border-color: rgba(255,96,112,.3);
    }

    @media (max-width:768px){
      .gauge-container{justify-content:center;text-align:center}
      .gauge-wrap{width:var(--ring-m);height:var(--ring-m)}
      .score{font-size:36px}
      .pills-grid{grid-template-columns:1fr}
      .chart-header{flex-direction:column;align-items:flex-start}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>‚ö° Economic Crash Radar Pro</h1>
      <div class="subtitle">Advanced multi-timeframe market stress analysis with predictive analytics</div>
      <div id="statusBadge"></div>
      <div id="alertBanner"></div>
      <div id="auditBox" class="audit"></div>
    </header>

    <main id="mainContent">
      <div class="loading">Loading economic data...</div>
    </main>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3.1.1/dist/chartjs-plugin-annotation.min.js"></script>

  <script>
    'use strict';

    // ==================== COMPREHENSIVE CONFIGURATION ====================
    const CONFIG = {
      FRED_CACHE_PATH: 'data/fred_cache.json',
      CACHE_TIMEOUT: 10000,
      
      INDICATORS: {
        T10Y3M: { 
          label: 'Yield Curve (10y-3m)',
          format: v => v?.toFixed(2),
          weight: 0.22,
          cadence: 'daily',
          description: 'Difference between 10-year and 3-month Treasury yields. Negative values (inverted curve) historically precede recessions by 6-18 months.',
          thresholds: { green: [0.5, Infinity], amber: [-0.5, 0.5], red: [-Infinity, -0.5] },
          momentumWeight: 1.2,
          crisisThreshold: -0.5,
          crisisMessage: 'Yield curve inversion historically precedes recessions by 6-18 months'
        },
        CREDIT: { 
          label: 'Credit Spread',
          format: v => v?.toFixed(2),
          weight: 0.18,
          cadence: 'daily',
          description: 'High-yield bond spread over Treasuries. Widening spreads indicate investors demanding more compensation for risk and potential credit stress.',
          thresholds: { green: [-Infinity, 0.40], amber: [0.40, 0.70], red: [0.70, Infinity] },
          momentumWeight: 1.1,
          crisisThreshold: 0.8,
          crisisMessage: 'Credit spreads above 0.8 indicate severe stress in corporate debt markets'
        },
        SAHM_RULE: { 
          label: 'Sahm Rule',
          format: v => v?.toFixed(2),
          weight: 0.20,
          cadence: 'monthly',
          description: '3-month average unemployment rate minus 12-month low. Values ‚â•0.5 indicate recession has likely begun. Most reliable labor market signal.',
          thresholds: { green: [-Infinity, 0.1], amber: [0.1, 0.4], red: [0.4, Infinity] },
          momentumWeight: 1.4,
          crisisThreshold: 0.5,
          crisisMessage: 'Sahm Rule triggered - unemployment rise suggests recession has begun'
        },
        DD_12M: { 
          label: 'Market Drawdown',
          format: v => ((v??0)*100).toFixed(1)+'%',
          weight: 0.24,
          cadence: 'daily',
          description: 'S&P 500 decline from 12-month peak. Deep drawdowns often coincide with economic stress. -20% defines bear market territory.',
          thresholds: { green: [-0.05, 0], amber: [-0.15, -0.05], red: [-Infinity, -0.15] },
          momentumWeight: 1.3,
          crisisThreshold: -0.2,
          crisisMessage: 'Market in bear territory (>20% decline from highs)'
        },
        NFCI: { 
          label: 'Financial Conditions',
          format: v => v?.toFixed(3),
          weight: 0.16,
          cadence: 'weekly',
          description: 'Chicago Fed National Financial Conditions Index. Above zero = tighter conditions. Sharp increases precede downturns.',
          thresholds: { green: [-Infinity, -0.20], amber: [-0.20, 0.20], red: [0.20, Infinity] },
          momentumWeight: 1.2,
          crisisThreshold: 0.3,
          crisisMessage: 'Financial conditions severely tightened, restricting credit flow'
        }
      },

      HISTORICAL_CRISES: {
        '2008 GFC': { score: 92, date: '2008-10-15', indicators: { T10Y3M: -1.5, CREDIT: 1.8, SAHM_RULE: 0.8, DD_12M: -0.45 }},
        '2020 COVID': { score: 88, date: '2020-03-23', indicators: { T10Y3M: -0.8, CREDIT: 1.2, SAHM_RULE: 0.6, DD_12M: -0.34 }},
        '2000 Dot-com': { score: 78, date: '2001-03-12', indicators: { T10Y3M: -0.3, CREDIT: 0.9, SAHM_RULE: 0.4, DD_12M: -0.28 }},
        '2022 Inflation': { score: 65, date: '2022-06-13', indicators: { T10Y3M: 0.8, CREDIT: 0.6, SAHM_RULE: 0.1, DD_12M: -0.23 }}
      },

      TIME_HORIZONS: {
        '1m': {
          label: '1 Month',
          description: 'Probability of >10% market decline within 1 month. Based on current volatility and stress levels.',
          action: 'Short-term hedging and position sizing'
        },
        '3m': {
          label: '3 Month', 
          description: 'Probability of >15% correction within a quarter. Incorporates economic momentum and credit conditions.',
          action: 'Portfolio rebalancing and sector rotation'
        },
        '6m': {
          label: '6 Month',
          description: 'Probability of >20% bear market or recession within 6 months. Based on leading indicators and historical patterns.',
          action: 'Strategic asset allocation changes'
        }
      },

      FRESH_LIMITS: { 
        daily: { ok: 7, warn: 14 }, 
        weekly: { ok: 7, warn: 14 }, 
        monthly: { ok: 30, warn: 45 } 
      },

      ZONE_COLORS: {
        green: '#1ec28b',
        amber: '#ffc247', 
        red: '#ff6070'
      }
    };

    // ==================== ENHANCED UTILITIES ====================
    const Utils = {
      clamp: (x, min = 0, max = 100) => Math.max(min, Math.min(max, x)),
      
      map01: (val, good, bad) => {
        if (val == null) return 50;
        const denom = bad - good;
        if (Math.abs(denom) < 1e-9) return 50;
        return ((val - good) / denom) * 100;
      },

      zoneOf: score => score <= 30 ? 'green' : (score <= 60 ? 'amber' : 'red'),
      
      heatColor: score => {
        const r = Math.round(255 * (score / 100));
        const g = Math.round(200 * (1 - score / 100));
        return `rgb(${r},${g},80)`;
      },

      safeParseFloat: val => {
        if (val == null || val === '.' || val === 'NaN' || val === '') return null;
        const num = +val;
        return isFinite(num) ? num : null;
      },

      calculateMomentum: (currentValues, historicalValues, lookback = 30) => {
        const momentum = {};
        for (const [key, current] of Object.entries(currentValues)) {
          const historical = historicalValues[key];
          if (current !== null && historical !== null) {
            momentum[key] = (current - historical) / lookback;
          }
        }
        return momentum;
      },

      log: (msg, data) => {
        console.log(`[CrashRadar] ${msg}`, data || '');
      }
    };

    // ==================== DATA SCALING ====================
    const SCALE = {
      T10Y3M:   v => Utils.clamp(Utils.map01(v,  1.0, -2.0)),
      CREDIT:   v => Utils.clamp(Utils.map01(v,  0.30, 1.00)),
      SAHM_RULE:v => Utils.clamp(Utils.map01(v,  0.0, 0.5)),
      DD_12M:   v => Utils.clamp(Utils.map01(v,  0.00, -0.20)),
      NFCI:     v => Utils.clamp(Utils.map01(v, -0.80, 0.40))
    };

    // ==================== ROBUST DATA SERVICE ====================
    class DataService {
      static async loadFredCache() {
        const controller = new AbortController();
        const timeout = setTimeout(() => controller.abort(), CONFIG.CACHE_TIMEOUT);

        try {
          Utils.log('Loading data from:', CONFIG.FRED_CACHE_PATH);
          const response = await fetch(CONFIG.FRED_CACHE_PATH + '?t=' + Date.now(), {
            signal: controller.signal
          });
          
          if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${await response.text()}`);
          }
          
          const rawData = await response.json();
          clearTimeout(timeout);
          Utils.log('Raw data loaded, keys:', Object.keys(rawData));
          
          return this.normalizeCache(rawData);
        } catch (error) {
          clearTimeout(timeout);
          Utils.log('Data load failed:', error);
          throw error;
        }
      }

      static normalizeCache(raw) {
        Utils.log('Normalizing cache structure...');
        
        // Handle different cache formats
        if (raw.series && typeof raw.series === 'object') {
          Utils.log('Found series object structure');
          return raw.series;
        }
        
        if (Array.isArray(raw)) {
          Utils.log('Found array structure, converting to object');
          const seriesObj = {};
          raw.forEach(item => {
            if (item.id && item.observations) {
              seriesObj[item.id] = { observations: item.observations };
            }
          });
          return seriesObj;
        }
        
        // If it's already the right format
        if (raw.T10Y3M || raw.CREDIT || raw.UN_SLOPE6) {
          Utils.log('Already in correct format');
          return raw;
        }
        
        Utils.log('Unknown cache structure:', raw);
        return raw || {};
      }

      static getLatestValue(series) {
        if (!series || !series.observations || !Array.isArray(series.observations)) {
          return null;
        }
        
        const observations = series.observations.filter(obs => 
          obs && obs.value && obs.value !== '.' && obs.value !== 'NaN'
        );
        
        if (observations.length === 0) return null;
        
        const latestObs = observations[observations.length - 1];
        return {
          value: Utils.safeParseFloat(latestObs.value),
          date: latestObs.date
        };
      }

      static getHistoricalValue(series, daysBack = 30) {
        if (!series?.observations?.length) return null;
        
        const targetDate = new Date(Date.now() - daysBack * 86400000);
        const observations = series.observations.filter(obs => 
          obs && obs.value && obs.value !== '.' && obs.value !== 'NaN'
        );
        
        for (let i = observations.length - 1; i >= 0; i--) {
          const obsDate = new Date(observations[i].date + 'T00:00:00Z');
          if (obsDate <= targetDate) {
            return Utils.safeParseFloat(observations[i].value);
          }
        }
        return null;
      }

      static getSeriesAge(series) {
        const latest = this.getLatestValue(series);
        if (!latest || !latest.date) return Infinity;
        
        const obsDate = new Date(latest.date + 'T00:00:00Z');
        const now = new Date();
        return Math.floor((now - obsDate) / (1000 * 60 * 60 * 24));
      }

      static buildCompositeHistory(dataMap) {
        const keys = Object.keys(CONFIG.INDICATORS);
        const allDates = new Set();
        
        for (const k of keys) {
          (dataMap[k]?.observations || []).forEach(o => allDates.add(o.date));
        }
        
        const dates = Array.from(allDates).sort();
        const history = [];
        
        for (const date of dates.slice(-180)) { // Last 180 days
          let num = 0, den = 0;
          
          for (const [k, cfg] of Object.entries(CONFIG.INDICATORS)) {
            const s = dataMap[k];
            if (!s) continue;
            
            const obs = s.observations;
            let value = null;
            
            // Find latest value on or before this date
            for (let i = obs.length - 1; i >= 0; i--) {
              if (obs[i].date <= date) {
                value = Utils.safeParseFloat(obs[i].value);
                break;
              }
            }
            
            if (value === null) continue;
            const scaled = SCALE[k](value);
            num += scaled * cfg.weight;
            den += cfg.weight;
          }
          
          if (den > 0) {
            history.push({ date, value: +(num / den).toFixed(1) });
          }
        }
        
        return history;
      }
    }

    // ==================== ENHANCED COMPOSITE CALCULATOR ====================
    class CompositeCalculator {
      static calculate(dataMap) {
        Utils.log('Calculating composite from data map keys:', Object.keys(dataMap));
        
        let totalScore = 0;
        let totalWeight = 0;
        const parts = [];
        const currentValues = {};
        const historicalValues = {};
        
        // First pass: collect current and historical values
        for (const [key, config] of Object.entries(CONFIG.INDICATORS)) {
          const series = dataMap[key];
          const latest = DataService.getLatestValue(series);
          
          if (!latest || latest.value === null) {
            Utils.log(`No data for ${key}`);
            continue;
          }

          currentValues[key] = latest.value;
          historicalValues[key] = DataService.getHistoricalValue(series, 30) || latest.value;
        }

        // Calculate momentum
        const momentum = Utils.calculateMomentum(currentValues, historicalValues);

        // Second pass: compute weighted scores with momentum
        for (const [key, config] of Object.entries(CONFIG.INDICATORS)) {
          const series = dataMap[key];
          const latest = DataService.getLatestValue(series);
          
          if (!latest || latest.value === null) continue;

          const age = DataService.getSeriesAge(series);
          const freshness = this.getFreshnessFactor(age, config.cadence);
          let scaledScore = SCALE[key](latest.value);
          
          // Apply momentum adjustment
          const mom = momentum[key] || 0;
          const momWeight = config.momentumWeight || 1.0;
          if (mom !== 0) {
            scaledScore = Utils.clamp(scaledScore * (1 + mom * momWeight));
          }

          const weight = config.weight * freshness;
          totalScore += scaledScore * weight;
          totalWeight += weight;
          
          // Determine status
          let status = 'green';
          const thresh = config.thresholds;
          if (thresh) {
            if (latest.value >= thresh.red[0] && latest.value <= thresh.red[1]) status = 'red';
            else if (latest.value >= thresh.amber[0] && latest.value <= thresh.amber[1]) status = 'amber';
          }
          
          // Freshness badge
          let freshnessBadge = 'badge-old';
          let freshnessText = 'Old';
          const limits = CONFIG.FRESH_LIMITS[config.cadence];
          if (age <= limits.ok) {
            freshnessBadge = 'badge-fresh';
            freshnessText = 'Fresh';
          } else if (age <= limits.warn) {
            freshnessBadge = 'badge-stale';
            freshnessText = 'Stale';
          }
          
          parts.push({
            key,
            label: config.label,
            value: latest.value,
            valueDisp: config.format(latest.value),
            status,
            scaledScore,
            weight: config.weight,
            freshness: freshnessBadge,
            freshnessText,
            description: config.description,
            crisisThreshold: config.crisisThreshold,
            crisisMessage: config.crisisMessage,
            momentum: mom
          });
        }
        
        if (totalWeight === 0) {
          throw new Error('No valid indicator data available');
        }
        
        const composite = totalScore / totalWeight;
        
        // Add complacency penalty
        const complacencyPenalty = this.calculateComplacencyPenalty(dataMap);
        const finalComposite = Utils.clamp(composite + complacencyPenalty);
        
        Utils.log('Final composite:', { raw: composite, penalty: complacencyPenalty, final: finalComposite });
        
        return {
          composite: finalComposite,
          parts,
          currentValues,
          complacencyPenalty
        };
      }
      
      static getFreshnessFactor(age, cadence) {
        const limits = CONFIG.FRESH_LIMITS[cadence] || CONFIG.FRESH_LIMITS.daily;
        if (age <= limits.ok) return 1.0;
        if (age <= limits.warn) return 0.8;
        return 0.5;
      }

      static calculateComplacencyPenalty(dataMap) {
        const vix = dataMap.VIXCLS || dataMap.VIX_PROXY;
        const credit = dataMap.CREDIT;
        const drawdown = dataMap.DD_12M;
        
        if (!vix || !credit || !drawdown) return 0;

        const vixVal = DataService.getLatestValue(vix)?.value;
        const creditVal = DataService.getLatestValue(credit)?.value;
        const ddVal = DataService.getLatestValue(drawdown)?.value;

        if (vixVal === null || creditVal === null || ddVal === null) return 0;

        let penalty = 0;
        
        // Low VIX complacency
        if (vixVal < 15) penalty += 3;
        if (vixVal < 12) penalty += 2;
        
        // Tight credit spreads
        if (creditVal < 0.4) penalty += 2;
        if (creditVal < 0.3) penalty += 3;
        
        // Shallow drawdowns during stress
        if (ddVal > -0.05) penalty += 2;

        return Math.min(8, penalty);
      }
    }

    // ==================== ADVANCED ANALYTICS ====================
    class Analytics {
      static calculateRiskProbabilities(composite, history) {
        const base1m = Math.min(40, composite * 0.6);
        const base3m = Math.min(60, composite * 0.8);
        const base6m = Math.min(80, composite * 1.0);
        
        // Add momentum effect from history
        const momentum = history.length > 10 ? 
          (history[history.length - 1].value - history[history.length - 10].value) / 10 : 0;
        
        return {
          p1: Math.round(base1m + momentum * 5),
          p3: Math.round(base3m + momentum * 8),
          p6: Math.round(base6m + momentum * 12)
        };
      }

      static findHistoricalComparisons(currentValues, currentScore) {
        const comparisons = [];
        
        for (const [period, data] of Object.entries(CONFIG.HISTORICAL_CRISES)) {
          let similarity = 0;
          let matchedIndicators = 0;
          
          for (const [indicator, currentVal] of Object.entries(currentValues)) {
            const historicalVal = data.indicators[indicator];
            if (historicalVal !== undefined && currentVal !== null) {
              const currentDist = Math.abs(currentVal - CONFIG.INDICATORS[indicator].crisisThreshold);
              const historicalDist = Math.abs(historicalVal - CONFIG.INDICATORS[indicator].crisisThreshold);
              similarity += 1 - (Math.abs(currentDist - historicalDist) / Math.max(currentDist, historicalDist));
              matchedIndicators++;
            }
          }
          
          if (matchedIndicators > 0) {
            similarity = (similarity / matchedIndicators) * 100;
            comparisons.push({
              period,
              score: data.score,
              date: data.date,
              similarity: Math.round(similarity),
              currentScore
            });
          }
        }
        
        return comparisons.sort((a, b) => b.similarity - a.similarity).slice(0, 3);
      }

      static generateAlerts(parts, composite) {
        const alerts = [];
        
        // Composite score alerts
        if (composite >= 80) {
          alerts.push({
            level: 'critical',
            title: 'CRITICAL: Market Stress at Crisis Levels',
            description: `Composite score ${Math.round(composite)} indicates systemic stress similar to historical crisis periods. Immediate risk management actions recommended.`,
            type: 'composite'
          });
        } else if (composite >= 65) {
          alerts.push({
            level: 'warning',
            title: 'WARNING: Elevated Market Stress',
            description: `Composite score ${Math.round(composite)} suggests heightened risk environment. Monitor positions closely and consider hedging.`,
            type: 'composite'
          });
        }

        // Individual indicator alerts
        for (const part of parts) {
          if (part.value >= part.crisisThreshold) {
            alerts.push({
              level: 'critical',
              title: `CRITICAL: ${part.label} at ${part.valueDisp}`,
              description: part.crisisMessage,
              type: 'indicator',
              indicator: part.key
            });
          } else if (part.status === 'red') {
            alerts.push({
              level: 'warning',
              title: `WARNING: ${part.label} in Stress Zone`,
              description: `${part.label} at ${part.valueDisp} indicates elevated risk. Monitor for further deterioration.`,
              type: 'indicator',
              indicator: part.key
            });
          }
        }

        return alerts;
      }
    }

    // ==================== COMPREHENSIVE UI MANAGER ====================
    class UIManager {
      constructor() {
        this.elements = {
          statusBadge: document.getElementById('statusBadge'),
          alertBanner: document.getElementById('alertBanner'),
          auditBox: document.getElementById('auditBox'),
          mainContent: document.getElementById('mainContent')
        };
        this.charts = { composite: null, decomp: null, traj: null };
        this.currentTimeframe = '3m';
      }
      
      showLoading() {
        this.elements.mainContent.innerHTML = '<div class="loading">Loading economic data...</div>';
      }
      
      showError(error) {
        this.elements.mainContent.innerHTML = `
          <div class="error-state">
            <h3 style="margin:0 0 8px;color:#ff9da6">‚ö†Ô∏è Data Load Failed</h3>
            <p style="margin:0;color:var(--muted)">${error.message}</p>
            <p style="margin:8px 0 0;font-size:13px;color:var(--muted)">
              Check browser console for details and ensure data file exists at:<br>
              <code>${CONFIG.FRED_CACHE_PATH}</code>
            </p>
          </div>`;
      }
      
      renderDashboard(compositeData, alerts, history, historicalComparisons) {
        const { composite, parts, complacencyPenalty } = compositeData;
        const zone = Utils.zoneOf(composite);
        const probs = Analytics.calculateRiskProbabilities(composite, history);
        
        this.elements.mainContent.innerHTML = `
          <section class="card">
            <div class="gauge-container">
              <div class="gauge-wrap">
                <div class="multi-ring">
                  <div class="ring ring-outer"></div>
                  <div class="ring ring-mid"></div>
                  <div class="ring ring-inner"></div>
                </div>
                <div id="needle" class="needle" style="--angle: ${(composite/100)*360}deg"></div>
                <div class="score"><div>${Math.round(composite)}</div><div class="score-label">STRESS INDEX</div></div>
              </div>
              
              <div class="gauge-info">
                <h2>Market Stress Monitor</h2>
                <div style="color:var(--muted);font-size:14px;margin-bottom:12px">
                  Real-time composite of ${parts.length} economic indicators
                  ${complacencyPenalty > 0 ? `<span style="color:var(--amber);margin-left:8px">+${complacencyPenalty} complacency penalty</span>` : ''}
                </div>
                
                <div style="display:flex;gap:16px;margin:20px 0;flex-wrap:wrap">
                  ${Object.entries(CONFIG.TIME_HORIZONS).map(([key, horizon]) => `
                    <div style="flex:1;min-width:140px;background:rgba(255,255,255,.03);padding:16px;border-radius:10px;border:1px solid rgba(255,255,255,.06)">
                      <h4 style="margin:0 0 8px;font-size:12px;color:var(--muted);letter-spacing:.5px">${horizon.label} RISK</h4>
                      <div style="font-size:28px;font-weight:700;color:var(--accent-bright);margin-bottom:4px">${probs[key]}%</div>
                      <div style="font-size:11px;color:var(--muted);line-height:1.3">${horizon.description}</div>
                    </div>
                  `).join('')}
                </div>

                <div class="confidence">
                  <span>Data Confidence:</span>
                  <div class="confidence-bar"><div id="confidenceFill" class="confidence-fill" style="width: ${this.calculateConfidence(parts)}%"></div></div>
                  <span>${this.calculateConfidence(parts)}%</span>
                </div>
                
                <div id="regimeIndicator" style="margin-top:12px"></div>
              </div>
            </div>
          </section>

          ${historicalComparisons.length > 0 ? `
            <section class="card">
              <h3 style="margin:0 0 16px;font-size:20px;display:flex;align-items:center">
                üìà Historical Context
                <span class="info-tooltip" style="margin-left:8px" title="Compare current market conditions with historical crisis periods">?</span>
              </h3>
              <div class="historical-comparison">
                ${historicalComparisons.map(comp => {
                  const isCritical = comp.similarity > 70;
                  return `
                    <div class="period-card ${isCritical ? 'critical' : ''}">
                      <div style="font-weight:600;margin-bottom:8px">${comp.period}</div>
                      <div style="display:flex;justify-content:space-between;margin-bottom:4px">
                        <span style="color:var(--muted);font-size:12px">Peak Score:</span>
                        <span style="font-weight:700">${comp.score}</span>
                      </div>
                      <div style="display:flex;justify-content:space-between;margin-bottom:4px">
                        <span style="color:var(--muted);font-size:12px">Similarity:</span>
                        <span style="font-weight:700;color:${isCritical ? CONFIG.ZONE_COLORS.red : CONFIG.ZONE_COLORS.amber}">${comp.similarity}%</span>
                      </div>
                      <div style="font-size:11px;color:var(--muted)">${comp.date}</div>
                    </div>`;
                }).join('')}
              </div>
            </section>
          ` : ''}

          <section class="card">
            <h3 style="margin:0 0 16px;font-size:20px">üìä Live Risk Indicators</h3>
            <div style="margin-bottom:12px;padding:12px;background:rgba(255,255,255,.02);border-radius:8px;font-size:13px;color:var(--muted)">
              <strong style="color:var(--text)">Status Legend:</strong>
              <span style="display:inline-flex;align-items:center;margin-left:12px">
                <span class="pill-status pill-status-green" style="margin-right:4px"></span> Normal
              </span>
              <span style="display:inline-flex;align-items:center;margin-left:12px">
                <span class="pill-status pill-status-amber" style="margin-right:4px"></span> Elevated  
              </span>
              <span style="display:inline-flex;align-items:center;margin-left:12px">
                <span class="pill-status pill-status-red" style="margin-right:4px"></span> Critical
              </span>
            </div>
            <div class="pills-grid" id="pillsGrid"></div>
          </section>

          <div class="tabs">
            <button class="tab active" data-tab="composite">Risk Analysis</button>
            <button class="tab" data-tab="scenarios">Forward Outlook</button>
            <button class="tab" data-tab="indicators">Indicator Details</button>
          </div>

          <div id="tab-composite" class="tab-content active">
            <section class="card">
              <div class="chart-header">
                <h3 class="chart-title">Stress Index Timeline</h3>
                <div class="chart-controls">
                  <div class="btn-group" id="timeframeButtons">
                    <button class="btn" data-tf="1m">1M</button>
                    <button class="btn active" data-tf="3m">3M</button>
                    <button class="btn" data-tf="6m">6M</button>
                    <button class="btn" data-tf="1y">1Y</button>
                  </div>
                </div>
              </div>
              <div class="chart-container"><canvas id="compositeChart"></canvas></div>
            </section>

            <section class="card">
              <h3 style="margin:0 0 16px">Risk Contributors</h3>
              <div class="chart-container"><canvas id="decompChart"></canvas></div>
            </section>
          </div>

          <div id="tab-scenarios" class="tab-content">
            <section class="card">
              <h3 style="margin:0 0 12px">Forward-Looking Risk Assessment</h3>
              <p style="color:var(--muted);margin:0 0 20px;font-size:14px">
                Probability-weighted scenarios based on current stress levels and historical patterns
              </p>
              
              <div class="risk-explanation">
                <h4>üìà Understanding Risk Probabilities</h4>
                <p><strong>1-Month Risk</strong> assesses immediate market stress and volatility spikes. 
                <strong>3-Month Risk</strong> incorporates economic momentum and credit conditions. 
                <strong>6-Month Risk</strong> evaluates recession and bear market probabilities using leading indicators.</p>
                <p style="margin-top:8px">These probabilities help inform different time horizons for risk management decisions.</p>
              </div>

              <div id="scenarioGrid" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:16px;margin-top:20px"></div>
            </section>

            <section class="card">
              <h3 style="margin:0 0 16px">Risk Trajectory</h3>
              <div class="chart-container"><canvas id="trajectoryChart"></canvas></div>
            </section>
          </div>

          <div id="tab-indicators" class="tab-content">
            <section class="card">
              <h3 style="margin:0 0 16px">Indicator Heat Map</h3>
              <div id="heatmap" class="heatmap"></div>
            </section>
          </div>`;
        
        this.renderPills(parts);
        this.renderCompositeChart(history);
        this.renderDecompChart(parts);
        this.renderScenarios(composite, probs);
        this.renderTrajectoryChart(composite);
        this.renderHeatmap(parts);
        this.setupEventListeners();
        this.setStatus(zone, composite, complacencyPenalty);
        this.renderAlerts(alerts);
        this.updateAudit(parts);
      }
      
      renderPills(parts) {
        const grid = document.getElementById('pillsGrid');
        grid.innerHTML = parts.map(part => {
          const momentumIndicator = part.momentum !== undefined && part.momentum !== 0 ? 
            `<div style="font-size:10px;color:${part.momentum > 0 ? CONFIG.ZONE_COLORS.red : CONFIG.ZONE_COLORS.green}">
              ${part.momentum > 0 ? '‚Üó' : '‚Üò'} ${Math.abs(part.momentum).toFixed(3)}/day
            </div>` : '';
          
          return `
            <div class="pill">
              <div class="pill-header">
                <div style="display:flex;align-items:center">
                  <div class="pill-title">${part.label}</div>
                  <span class="pill-status pill-status-${part.status}"></span>
                </div>
                <div class="pill-badge ${part.freshness}">${part.freshnessText}</div>
              </div>
              <div class="pill-value">${part.valueDisp}</div>
              <div class="pill-change">
                <span>${part.scaledScore > 50 ? '‚ñ≤' : '‚ñº'}</span>
                ${Math.abs(part.scaledScore - 50).toFixed(0)} pts
              </div>
              ${momentumIndicator}
              <div class="pill-tooltip">${part.description}</div>
            </div>`;
        }).join('');
      }
      
      renderCompositeChart(history) {
        if (!history.length) return;
        
        const now = new Date(history[history.length - 1].date + 'T00:00:00Z');
        const spanDays = this.currentTimeframe === '1m' ? 30 :
                        this.currentTimeframe === '3m' ? 90 :
                        this.currentTimeframe === '6m' ? 180 :
                        this.currentTimeframe === '1y' ? 365 : 180;
        
        const filtered = history.filter(d => {
          const dt = new Date(d.date + 'T00:00:00Z');
          return (now - dt) / 86400000 <= spanDays;
        });
        
        const labels = filtered.map(d => {
          const date = new Date(d.date + 'T00:00:00Z');
          return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        });
        
        const data = filtered.map(d => d.value);
        
        if (this.charts.composite) this.charts.composite.destroy();
        
        const ctx = document.getElementById('compositeChart');
        this.charts.composite = new Chart(ctx, {
          type: 'line',
          data: {
            labels,
            datasets: [{
              label: 'Stress Index',
              data,
              borderColor: '#ffc247',
              backgroundColor: 'rgba(255,194,71,0.1)',
              borderWidth: 2,
              fill: true,
              tension: 0.25,
              pointRadius: 0,
              pointHoverRadius: 4
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { display: false },
              tooltip: { mode: 'index', intersect: false }
            },
            scales: {
              x: { 
                display: true, 
                grid: { color: 'rgba(255,255,255,0.05)' },
                ticks: { maxTicksLimit: 8 }
              },
              y: { 
                min: 0, 
                max: 100,
                grid: { color: 'rgba(255,255,255,0.05)' },
                ticks: { callback: (val) => val }
              }
            }
          }
        });
      }

      renderDecompChart(parts) {
        const labels = parts.map(p => p.label);
        const contrib = parts.map(p => +(p.scaledScore * p.weight).toFixed(1));
        
        if (this.charts.decomp) this.charts.decomp.destroy();
        
        const ctx = document.getElementById('decompChart');
        this.charts.decomp = new Chart(ctx, {
          type: 'bar',
          data: {
            labels,
            datasets: [{
              label: 'Contribution to Stress',
              data: contrib,
              backgroundColor: contrib.map(c => {
                if (c < 10) return '#1ec28b';
                if (c < 20) return '#ffc247';
                return '#ff6070';
              }),
              borderWidth: 0
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: {
              y: { 
                beginAtZero: true,
                max: Math.max(10, Math.ceil(Math.max(...contrib, 10) / 10) * 10),
                grid: { color: 'rgba(255,255,255,0.05)' },
                title: { display: true, text: 'Points to Composite Score' }
              },
              x: { grid: { display: false } }
            }
          }
        });
      }

      renderScenarios(composite, probs) {
        const scenarios = [
          { 
            title: 'Base Case', 
            prob: Math.round(100 - probs.p3), 
            desc: 'Markets stabilize, economic data mixed but no major deterioration. Gradual recovery continues.',
            color: '#1ec28b'
          },
          { 
            title: 'Correction Scenario', 
            prob: Math.round(probs.p3 - probs.p1), 
            desc: '10-15% market decline as stress indicators persist. Increased volatility but no systemic crisis.',
            color: '#ffc247'
          },
          { 
            title: 'Crisis Scenario', 
            prob: Math.round(probs.p1), 
            desc: '>20% decline with credit stress and economic contraction. Requires defensive positioning.',
            color: '#ff6070'
          }
        ];
        
        const grid = document.getElementById('scenarioGrid');
        grid.innerHTML = scenarios.map(s => `
          <div style="background:rgba(255,255,255,.03);padding:20px;border-radius:12px;border:1px solid rgba(255,255,255,.06);border-left:4px solid ${s.color}">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
              <div style="font-weight:600;font-size:16px">${s.title}</div>
              <div style="font-size:24px;font-weight:700;color:${s.color}">${s.prob}%</div>
            </div>
            <div style="color:var(--muted);font-size:13px;line-height:1.5">${s.desc}</div>
          </div>`).join('');
      }

      renderTrajectoryChart(composite) {
        const steps = 26;
        const phi = 0.85;
        const target = 50;
        let v = composite;
        
        const labels = [], path = [], upper = [], lower = [];
        
        for (let i = 1; i <= steps; i++) {
          v = phi * v + (1 - phi) * target;
          labels.push(`W+${i}`);
          path.push(+v.toFixed(1));
          
          const band = 6 * Math.sqrt(i / steps);
          upper.push(Math.min(100, +(v + band).toFixed(1)));
          lower.push(Math.max(0, +(v - band).toFixed(1)));
        }
        
        if (this.charts.traj) this.charts.traj.destroy();
        
        const ctx = document.getElementById('trajectoryChart');
        this.charts.traj = new Chart(ctx, {
          type: 'line',
          data: {
            labels,
            datasets: [
              { label: 'Projected', data: path, borderWidth: 2, fill: false, tension: 0.25, borderColor: '#ffc247' },
              { label: 'Upper', data: upper, borderWidth: 1, fill: false, borderDash: [4, 4], borderColor: '#ff6070' },
              { label: 'Lower', data: lower, borderWidth: 1, fill: false, borderDash: [4, 4], borderColor: '#1ec28b' }
            ]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { 
              legend: { 
                display: true,
                labels: { color: '#8b96b0' }
              } 
            },
            scales: { 
              y: { 
                min: 0, 
                max: 100,
                grid: { color: 'rgba(255,255,255,0.05)' }
              },
              x: { grid: { color: 'rgba(255,255,255,0.05)' } }
            }
          }
        });
      }

      renderHeatmap(parts) {
        const heatmap = document.getElementById('heatmap');
        heatmap.innerHTML = parts.map(p => {
          const color = Utils.heatColor(p.scaledScore);
          return `
            <div class="heat-cell">
              <div class="heat-label">${p.label}</div>
              <div class="heat-value">${p.valueDisp}</div>
              <div class="bar"><span style="width:${p.scaledScore}%;background:${color}"></span></div>
            </div>`;
        }).join('');
      }
      
      renderAlerts(alerts) {
        if (alerts.length === 0) {
          this.elements.alertBanner.innerHTML = '';
          return;
        }
        
        const criticalAlerts = alerts.filter(a => a.level === 'critical');
        const alertLevel = criticalAlerts.length > 0 ? 'critical' : 'warning';
        
        this.elements.alertBanner.innerHTML = `
          <div class="alert-banner ${alertLevel === 'warning' ? 'warning' : ''}">
            <div style="display:flex;align-items:flex-start;gap:12px">
              <span style="font-size:24px">${alertLevel === 'critical' ? 'üö®' : '‚ö†Ô∏è'}</span>
              <div style="flex:1">
                <div style="font-weight:700;margin-bottom:8px;font-size:16px">
                  ${alertLevel === 'critical' ? 'CRITICAL ALERTS' : 'WARNINGS'}
                </div>
                <div class="alert-list">
                  ${alerts.slice(0, 5).map(alert => `
                    <div class="alert-item">
                      <div class="alert-icon">${alert.level === 'critical' ? 'üî¥' : 'üü°'}</div>
                      <div class="alert-content">
                        <div class="alert-title">${alert.title}</div>
                        <div class="alert-description">${alert.description}</div>
                      </div>
                    </div>
                  `).join('')}
                </div>
                ${alerts.length > 5 ? `
                  <div style="margin-top:8px;font-size:12px;color:var(--muted)">
                    +${alerts.length - 5} more alerts...
                  </div>
                ` : ''}
              </div>
            </div>
          </div>`;
      }
      
      setStatus(zone, composite, complacencyPenalty) {
        const colors = { green: '#1ec28b', amber: '#ffc247', red: '#ff6070' };
        const labels = { green: 'LOW RISK', amber: 'ELEVATED RISK', red: 'HIGH RISK' };
        
        let statusText = `Composite: ${Math.round(composite)} (${labels[zone]})`;
        if (complacencyPenalty > 0) {
          statusText += ` ‚Ä¢ Complacency +${complacencyPenalty}`;
        }
        
        this.elements.statusBadge.innerHTML = `
          <div class="status" style="background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.08)">
            <span class="status-dot" style="background:${colors[zone]}"></span>
            <span>${statusText}</span>
          </div>`;

        document.getElementById('regimeIndicator').innerHTML = `
          <div class="status" style="background:rgba(255,255,255,.03);border:1px solid rgba(255,255,255,.06);display:inline-flex">
            <span class="status-dot" style="background:${colors[zone]}"></span>
            <span>${labels[zone]} Regime ‚Ä¢ Active monitoring recommended</span>
          </div>`;
      }
      
      updateAudit(parts) {
        const stale = parts.filter(p => p.freshness === 'badge-stale' || p.freshness === 'badge-old');
        const missing = Object.keys(CONFIG.INDICATORS).filter(key => 
          !parts.find(p => p.key === key)
        );
        
        let auditHTML = '';
        if (missing.length > 0) {
          auditHTML += `<div><b class="bad">Missing</b>: ${missing.join(', ')}</div>`;
        }
        if (stale.length > 0) {
          auditHTML += `<div><b class="warn">Stale</b>: ${stale.map(s => s.label).join(', ')}</div>`;
        }
        if (!auditHTML) {
          auditHTML = '<div style="color:var(--green)">‚úì All data current</div>';
        }
        
        this.elements.auditBox.innerHTML = auditHTML;
      }
      
      calculateConfidence(parts) {
        const freshCount = parts.filter(p => p.freshness === 'badge-fresh').length;
        return Math.round((freshCount / Object.keys(CONFIG.INDICATORS).length) * 100);
      }

      setupEventListeners() {
        // Tab switching
        document.querySelectorAll('.tab').forEach(tab => {
          tab.addEventListener('click', (e) => {
            const target = e.currentTarget.dataset.tab;
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            e.currentTarget.classList.add('active');
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.getElementById(`tab-${target}`).classList.add('active');
          });
        });

        // Timeframe buttons
        document.querySelectorAll('#timeframeButtons .btn').forEach(btn => {
          btn.addEventListener('click', (e) => {
            document.querySelectorAll('#timeframeButtons .btn').forEach(b => b.classList.remove('active'));
            e.currentTarget.classList.add('active');
            this.currentTimeframe = e.currentTarget.dataset.tf;
            // Re-render chart with new timeframe
            if (app.state.compositeHistory) {
              this.renderCompositeChart(app.state.compositeHistory);
            }
          });
        });
      }
    }

    // ==================== MAIN APPLICATION ====================
    class App {
      constructor() {
        this.ui = new UIManager();
        this.state = {
          dataMap: null,
          compositeHistory: [],
          cache: null
        };
      }
      
      async init() {
        try {
          this.ui.showLoading();
          
          // Load data
          this.state.dataMap = await DataService.loadFredCache();
          Utils.log('Data map loaded with keys:', Object.keys(this.state.dataMap));
          
          // Calculate composite
          const compositeData = CompositeCalculator.calculate(this.state.dataMap);
          
          // Build history
          this.state.compositeHistory = DataService.buildCompositeHistory(this.state.dataMap);
          
          // Generate analytics
          const alerts = Analytics.generateAlerts(compositeData.parts, compositeData.composite);
          const historicalComparisons = Analytics.findHistoricalComparisons(
            compositeData.currentValues, 
            compositeData.composite
          );
          
          // Render UI
          this.ui.renderDashboard(
            compositeData, 
            alerts, 
            this.state.compositeHistory,
            historicalComparisons
          );
          
        } catch (error) {
          Utils.log('App initialization failed:', error);
          this.ui.showError(error);
        }
      }
    }

    // ==================== INITIALIZE ====================
    const app = new App();
    app.init();
  </script>
</body>
</html>
