<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Economic Crash Radar Pro</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <style>
    :root {
      --bg:#0a0e1a;
      --panel:#12182b;
      --text:#e8eeff;
      --muted:#8b96b0;
      --accent:#6b9eff;
      --accent-soft:#8fb4ff;
      --green:#1ec28b;
      --amber:#ffc247;
      --red:#ff6070;
      --critical-red: #ff4757;
      --warning-orange: #ffa502;
      --watch-yellow: #eccc68;
      --normal-green: #2ed573;
      --radius-lg:16px;
      --shadow-soft:0 8px 24px rgba(0,0,0,0.45);
      --font-main:-apple-system,BlinkMacSystemFont,"Segoe UI",system-ui,sans-serif;
    }

    *{margin:0;padding:0;box-sizing:border-box;}

    body{
      background:var(--bg);
      color:var(--text);
      font:15px/1.6 var(--font-main);
      -webkit-font-smoothing:antialiased;
      padding:18px 12px 40px;
    }

    .container{max-width:1440px;margin:0 auto;}
    .header{text-align:center;margin-bottom:18px;}

    h1{
      font-size:clamp(30px,6vw,46px);
      font-weight:800;
      margin-bottom:6px;
      background:linear-gradient(135deg,var(--text),var(--accent-soft));
      -webkit-background-clip:text;
      -webkit-text-fill-color:transparent;
    }

    .subtitle{
      color:var(--muted);
      font-size:0.95rem;
    }

    .meta-badges{
      display:flex;
      flex-wrap:wrap;
      justify-content:center;
      gap:6px;
      margin-top:8px;
      font-size:0.7rem;
      color:var(--muted);
    }

    .badge{
      padding:4px 8px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,0.12);
      background:rgba(255,255,255,0.02);
    }

    .alert-banner{
      margin:16px auto 18px;
      padding:10px 12px;
      max-width:900px;
      border-radius:10px;
      background:linear-gradient(135deg,rgba(107,158,255,0.08),rgba(139,187,255,0.02));
      border:1px solid rgba(107,158,255,0.25);
      font-size:0.8rem;
      color:var(--text);
    }

    .critical-alert {
      animation: pulse 2s infinite;
      background: linear-gradient(135deg, rgba(255, 71, 87, 0.15), rgba(255, 71, 87, 0.05));
      border: 1px solid var(--critical-red);
      border-left: 6px solid var(--critical-red);
    }

    @keyframes pulse {
      0% { opacity: 1; }
      50% { opacity: 0.8; }
      100% { opacity: 1; }
    }

    .dashboard{
      display:grid;
      grid-template-columns:280px 1fr;
      gap:16px;
      align-items:flex-start;
    }

    .sidebar{
      background:var(--panel);
      border-radius:var(--radius-lg);
      padding:16px 14px 14px;
      box-shadow:var(--shadow-soft);
    }

    .main-content{
      display:grid;
      grid-template-columns:repeat(2,minmax(0,1fr));
      gap:14px;
    }

    .card{
      background:var(--panel);
      border-radius:var(--radius-lg);
      padding:14px 12px 12px;
      box-shadow:var(--shadow-soft);
    }

    .card.critical {
      border: 1px solid var(--critical-red);
      background: linear-gradient(135deg, rgba(255, 71, 87, 0.08), var(--panel));
    }

    .card-title{
      font-size:1rem;
      font-weight:700;
      color:var(--accent-soft);
      display:flex;
      align-items:center;
      gap:6px;
      margin-bottom:8px;
    }
    .card-title .icon{font-size:1.1rem;}

    .gauge-container{text-align:center;margin-bottom:8px;}
    .gauge{
      position:relative;
      width:190px;
      height:190px;
      margin:0 auto;
    }
    .gauge-background{
      position:absolute;
      inset:0;
      border-radius:50%;
      background:conic-gradient(
        var(--normal-green) 0deg 90deg,
        var(--watch-yellow) 90deg 144deg,
        var(--warning-orange) 144deg 216deg,
        var(--critical-red) 216deg 360deg
      );
      opacity:0.28;
    }
    .gauge-center{
      position:absolute;
      top:10%;
      left:10%;
      width:80%;
      height:80%;
      border-radius:50%;
      background:var(--panel);
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
    }
    .gauge-score{
      font-size:2.4rem;
      font-weight:800;
    }
    .gauge-label{
      font-size:0.7rem;
      color:var(--muted);
      text-transform:uppercase;
      letter-spacing:0.08em;
      margin-top:2px;
      text-align:center;
    }
    .gauge-needle{
      position:absolute;
      bottom:50%;
      left:50%;
      width:3px;
      height:46%;
      background:var(--accent);
      transform-origin:bottom center;
      transform:translateX(-50%) rotate(0deg);
      border-radius:4px 4px 0 0;
      transition:transform 0.9s ease;
    }

    .risk-meter{margin-top:6px;}
    .risk-bar{
      height:6px;
      border-radius:4px;
      background:rgba(255,255,255,0.1);
      overflow:hidden;
    }
    .risk-fill{
      height:100%;
      width:0%;
      background:linear-gradient(90deg,var(--normal-green),var(--watch-yellow),var(--warning-orange),var(--critical-red));
      transition:width 0.8s ease;
    }
    .risk-labels{
      display:flex;
      justify-content:space-between;
      margin-top:4px;
      font-size:0.65rem;
      color:var(--muted);
    }

    .status-grid{
      display:grid;
      grid-template-columns:repeat(2,minmax(0,1fr));
      gap:6px;
      margin-top:10px;
    }
    .status-item{
      padding:7px 6px;
      background:rgba(255,255,255,0.02);
      border-radius:8px;
      font-size:0.7rem;
    }
    .status-item.critical {
      border: 1px solid var(--critical-red);
      background: rgba(255, 71, 87, 0.08);
    }

    .status-label{
      color:var(--muted);
      font-size:0.66rem;
    }
    .status-value{
      font-weight:700;
      font-size:0.95rem;
      margin-top:1px;
    }

    .top-drivers {
      margin-top: 12px;
      padding: 8px;
      background: rgba(255,255,255,0.03);
      border-radius: 8px;
      font-size: 0.7rem;
    }

    .driver-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 4px 0;
      border-bottom: 1px solid rgba(255,255,255,0.05);
    }

    .driver-item:last-child {
      border-bottom: none;
    }

    .driver-trend {
      font-size: 0.6rem;
      padding: 2px 6px;
      border-radius: 4px;
      background: rgba(255,255,255,0.1);
    }

    .trend-up { color: var(--red); }
    .trend-down { color: var(--green); }

    .indicator-grid{
      display:grid;
      grid-template-columns:repeat(auto-fill,minmax(220px,1fr));
      gap:7px;
      margin-top:4px;
    }
    .indicator{
      padding:7px 7px 6px;
      background:rgba(255,255,255,0.03);
      border-radius:8px;
      border-left:3px solid var(--green);
      font-size:0.7rem;
    }
    .indicator.warning{border-left-color:var(--amber);}
    .indicator.danger{border-left-color:var(--red);}
    .indicator.critical{
      border-left-color:var(--critical-red);
      background: rgba(255, 71, 87, 0.05);
      animation: pulse 3s infinite;
    }

    .indicator-header{
      display:flex;
      justify-content:space-between;
      gap:4px;
      align-items:baseline;
      margin-bottom:2px;
    }
    .indicator-name{
      font-weight:600;
      font-size:0.78rem;
    }
    .indicator-value{
      font-weight:700;
      font-size:0.9rem;
    }
    .indicator-threshold{
      color:var(--muted);
      font-size:0.62rem;
      margin-top:1px;
    }
    .source-tag{
      display:inline-block;
      margin-top:3px;
      padding:2px 5px;
      border-radius:6px;
      border:1px solid rgba(255,255,255,0.14);
      font-size:0.58rem;
      color:var(--muted);
    }

    .manual-input-row{
      display:flex;
      flex-direction:column;
      gap:3px;
      margin-top:4px;
      font-size:0.6rem;
    }
    .manual-input-row span{
      color:var(--muted);
      font-size:0.62rem;
    }
    .manual-input{
      width:100%;
      padding:8px 8px;
      min-height:44px;
      border-radius:6px;
      border:1px solid rgba(255,255,255,0.25);
      background:rgba(0,0,0,0.5);
      color:var(--text);
      font-size:0.75rem;
      outline:none;
    }
    .manual-input:focus{
      border-color:var(--accent);
      box-shadow:0 0 4px var(--accent);
    }

    .valuation-comparison{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(150px,1fr));
      gap:6px;
      margin-top:8px;
      font-size:0.68rem;
    }
    .valuation-item{
      padding:6px;
      background:rgba(255,255,255,0.02);
      border-radius:8px;
      text-align:center;
    }
    .valuation-item.current{
      border:1px solid var(--red);
      background:rgba(255,96,112,0.05);
    }
    .valuation-item.extreme {
      border: 2px solid var(--critical-red);
      background: rgba(255, 71, 87, 0.1);
      animation: pulse 2s infinite;
    }
    .valuation-title{
      font-weight:600;
      margin-bottom:2px;
    }
    .valuation-metric{margin:1px 0;}
    .valuation-outcome{
      margin-top:2px;
      color:var(--muted);
    }

    .insight-card{
      margin-top:6px;
      padding:6px 7px;
      border-radius:8px;
      background:linear-gradient(135deg,rgba(107,158,255,0.10),rgba(10,14,26,1));
      border:1px solid rgba(107,158,255,0.25);
      font-size:0.7rem;
    }
    .insight-card.critical {
      background: linear-gradient(135deg, rgba(255, 71, 87, 0.15), rgba(10,14,26,1));
      border: 1px solid var(--critical-red);
    }
    .chart-container{margin-top:4px;}

    .history-grid{
      margin-top:6px;
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(160px,1fr));
      gap:5px;
      font-size:0.66rem;
    }
    .history-item{
      padding:5px;
      border-radius:8px;
      background:rgba(255,255,255,0.02);
    }
    .history-title{
      font-weight:600;
      margin-bottom:1px;
      font-size:0.7rem;
    }

    .context-badge {
      display: inline-block;
      padding: 2px 6px;
      margin-left: 4px;
      border-radius: 4px;
      font-size: 0.6rem;
      background: rgba(255, 71, 87, 0.2);
      color: var(--critical-red);
      font-weight: 600;
    }

    @media(max-width:900px){
      body{padding:14px 8px 26px;}
      .dashboard{grid-template-columns:1fr;}
      .main-content{grid-template-columns:1fr;}
      .sidebar{order:-1;}
    }
  </style>
</head>
<body>
<div class="container">
  <div class="header">
    <h1>‚ö° Economic Crash Radar Pro</h1>
    <div class="subtitle">
      8 macro indicators (7 auto via FRED, 1 manual) + 2 valuations. Transparent, deterministic composite.
    </div>
    <div class="meta-badges">
      <div class="badge" id="cache-badge">FRED cache: not loaded</div>
      <div class="badge">Manual: LEI 6m Œî, Buffett, CAPE</div>
      <div class="badge">Auto: Yield, HY, UMich, M2, Claims, Sahm, Permits</div>
      <div class="badge" id="inputs-badge">Inputs: 0/10 populated</div>
    </div>
  </div>

  <div class="alert-banner" id="alert-banner">
    Composite stress = 70% macro block + 30% valuation block when both are available.
  </div>

  <div class="dashboard">
    <!-- SIDEBAR -->
    <div class="sidebar">
      <div class="gauge-container">
        <div class="gauge">
          <div class="gauge-background"></div>
          <div class="gauge-center">
            <div class="gauge-score" id="composite-score">--</div>
            <div class="gauge-label" id="regime-label">COMPOSITE STRESS</div>
          </div>
          <div class="gauge-needle" id="needle"></div>
        </div>
        <div class="risk-meter">
          <div class="risk-bar">
            <div class="risk-fill" id="risk-fill"></div>
          </div>
          <div class="risk-labels">
            <span>Normal (0-25)</span>
            <span>Watch (25-40)</span>
            <span>Elevated (40-60)</span>
            <span>High (60-100)</span>
          </div>
        </div>
      </div>

      <!-- Top Risk Drivers -->
      <div class="top-drivers" id="top-drivers">
        <div style="font-weight: 600; margin-bottom: 6px; color: var(--accent-soft);">Top Risk Drivers</div>
        <div class="driver-item">
          <span>Loading drivers...</span>
          <span class="driver-trend">--</span>
        </div>
      </div>

      <div class="status-grid">
        <div class="status-item" id="recession-status">
          <div class="status-label">Recession Probability (12‚Äì18m)</div>
          <div class="status-value" id="recession-risk-display">--</div>
          <div class="indicator-threshold">Mapped from composite.</div>
        </div>
        <div class="status-item" id="valuation-status">
          <div class="status-label">Valuation Risk</div>
          <div class="status-value" id="valuation-risk-display">--</div>
          <div class="indicator-threshold">Buffett + CAPE combined.</div>
        </div>
        <div class="status-item">
          <div class="status-label">Labor Market Stress</div>
          <div class="status-value" id="labor-risk-display">--</div>
          <div class="indicator-threshold">Claims + Sahm.</div>
        </div>
        <div class="status-item">
          <div class="status-label">Data Coverage</div>
          <div class="status-value" id="quality-display">--</div>
          <div class="indicator-threshold">Filled indicators / total.</div>
        </div>
      </div>
    </div>

    <!-- MAIN -->
    <div class="main-content">
      <div class="card">
        <div class="card-title"><span class="icon">üìä</span>Tier 1 Leading Indicators</div>
        <div class="indicator-grid" id="tier1-indicators"></div>
      </div>

      <div class="card">
        <div class="card-title"><span class="icon">üìà</span>Tier 2 Confirming Indicators</div>
        <div class="indicator-grid" id="tier2-indicators"></div>
      </div>

      <div class="card" id="valuation-card">
        <div class="card-title"><span class="icon">üí∞</span>Valuation Indicators <span id="valuation-context-badge"></span></div>
        <div class="indicator-grid" id="valuation-indicators"></div>

        <div class="valuation-comparison">
          <div class="valuation-item">
            <div class="valuation-title">2000 Dot-com</div>
            <div class="valuation-metric">CAPE ‚âà 44</div>
            <div class="valuation-metric">Buffett ‚âà 140‚Äì160%</div>
            <div class="valuation-outcome">Severe drawdown.</div>
          </div>
          <div class="valuation-item">
            <div class="valuation-title">2007 Pre-GFC</div>
            <div class="valuation-metric">CAPE ‚âà 27</div>
            <div class="valuation-metric">Buffett ‚âà 105%</div>
            <div class="valuation-outcome">Crisis.</div>
          </div>
          <div class="valuation-item">
            <div class="valuation-title">2021 Peak</div>
            <div class="valuation-metric">CAPE ‚âà 38</div>
            <div class="valuation-metric">Buffett ‚âà 195%</div>
            <div class="valuation-outcome">2022 correction.</div>
          </div>
          <div class="valuation-item current" id="current-valuation">
            <div class="valuation-title">Current (your inputs)</div>
            <div class="valuation-metric" id="current-buffett-label">Buffett: --</div>
            <div class="valuation-metric" id="current-cape-label">CAPE: --</div>
            <div class="valuation-outcome">Reflects manual entries.</div>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="card-title"><span class="icon">üïí</span>History, Radar & Prior Recessions</div>
        <div class="chart-container">
          <canvas id="market-trend" height="130"></canvas>
        </div>
        <div class="chart-container">
          <canvas id="risk-radar" height="140"></canvas>
        </div>
        <div class="insight-card" id="insight-card">
          <strong>Insight:</strong>
          <span id="insight-text">
            Once populated, this compares today's configuration to prior stress regimes.
          </span>
        </div>
        <div class="history-grid">
          <div class="history-item">
            <div class="history-title">1973‚Äì75 / early 80s</div>
            <div>Curve inversion + energy shocks + weak leads.</div>
          </div>
          <div class="history-item">
            <div class="history-title">2000‚Äì02</div>
            <div>Extreme valuations, tightening, growth rollover.</div>
          </div>
          <div class="history-item">
            <div class="history-title">2007‚Äì09</div>
            <div>Housing + credit + inversion aligned.</div>
          </div>
          <div class="history-item">
            <div class="history-title">2020</div>
            <div>External shock; indicator behavior distinct.</div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
'use strict';

const VALUATION_BLOCK_WEIGHT = 0.30;
let cacheAgeDays = null;

const INDICATORS = {
  LEI: {
    tier:1,
    label:'Conference Board LEI 6m %Œî',
    weight:0.18,
    threshold:-4.0,
    direction:'below',
    span:3.0,
    fromFred:false,
    fredId:null,
    current:null,
    format:v => v.toFixed(1) + '%',
    desc:'Manual: 6m % change in LEI (Conference Board).'
  },
  YIELD_CURVE: {
    tier:1,
    label:'Yield Curve (10y-3m)',
    weight:0.12,
    threshold:0,
    direction:'below',
    span:1.0,
    fromFred:true,
    fredId:'T10Y3M',
    current:null,
    format:v => v.toFixed(2) + '%',
    desc:'T10Y3M. Inversion (<0) raises forward recession risk.'
  },
  CREDIT_SPREAD: {
    tier:1,
    label:'HY Credit Spread',
    weight:0.10,
    threshold:5.0,
    direction:'above',
    span:3.0,
    fromFred:true,
    fredId:'BAMLH0A0HYM2',
    current:null,
    format:v => v.toFixed(2) + '%',
    desc:'High yield spread; >5‚Äì8% historically stress regime.'
  },
  CONSUMER_SENTIMENT: {
    tier:1,
    label:'UMich Sentiment',
    weight:0.09,
    threshold:60,
    direction:'below',
    span:20,
    fromFred:true,
    fredId:'UMCSENT',
    current:null,
    format:v => v.toFixed(1),
    desc:'Deep pessimism clusters with recessions.'
  },
  M2_GROWTH: {
    tier:1,
    label:'M2 Growth YoY',
    weight:0.06,
    threshold:4.0,
    direction:'below',
    span:5.0,
    fromFred:true,
    fredId:'M2SL',
    current:null,
    format:v => v.toFixed(1) + '%',
    desc:'YoY growth from M2SL. Persistently weak/negative = tight liquidity.'
  },
  INITIAL_CLAIMS: {
    tier:2,
    label:'Initial Claims 4wk MA',
    weight:0.10,
    threshold:323,
    direction:'above',
    span:150,
    fromFred:true,
    fredId:'ICSA',
    current:null,
    format:v => Math.round(v) + 'k',
    desc:'4-week avg. Rapid rise confirms labor weakness.'
  },
  SAHM_RULE: {
    tier:2,
    label:'Sahm Rule',
    weight:0.10,
    threshold:0.50,
    direction:'above',
    span:1.0,
    fromFred:true,
    fredId:'SAHMREALTIME',
    current:null,
    format:v => v.toFixed(2),
    desc:'‚â•0.5 = strong real-time recession confirmation.'
  },
  BUILDING_PERMITS: {
    tier:2,
    label:'Building Permits 6m %Œî',
    weight:0.08,
    threshold:-15,
    direction:'below',
    span:15,
    fromFred:true,
    fredId:'PERMIT',
    current:null,
    format:v => v.toFixed(1) + '%',
    desc:'6m change; housing slowdown as classic lead.'
  }
};

const VALUATIONS = {
  BUFFETT: {
    label:'Buffett Indicator (MktCap/GDP)',
    weight:0.50,
    danger:180,
    current:null,
    format:v => v.toFixed(1) + '%',
    desc:'Manual. Wilshire 5000 / GDP (or equivalent).'
  },
  SHILLER_PE: {
    label:'Shiller CAPE',
    weight:0.50,
    danger:30,
    current:null,
    format:v => v.toFixed(1),
    desc:'Manual. Long-term CAPE vs history.'
  }
};

let charts = { trend:null, radar:null };
let compositeScore = null;

/**
 * Enhanced valuation stress with exponential scaling for extremes
 */
function valuationStress(key, val){
  const v = VALUATIONS[key];
  if(!v || !Number.isFinite(val)) return null;
  
  let stress = 0;
  
  if(key === 'BUFFETT'){
    // Buffett Indicator: exponential scaling above 150%
    if(val <= 100) return 0;
    if(val <= 150) {
      stress = ((val - 100) / 50) * 50; // Linear 0-50 for 100-150%
    } else {
      stress = 50 + ((val - 150) / 100) * 50; // Additional 0-50 for 150-250%
    }
  } else if(key === 'SHILLER_PE'){
    // Shiller CAPE: exponential scaling above 30
    if(val <= 20) return 0;
    if(val <= 30) {
      stress = ((val - 20) / 10) * 50; // Linear 0-50 for 20-30
    } else {
      stress = 50 + ((val - 30) / 20) * 50; // Additional 0-50 for 30-50
    }
  }
  
  return Math.min(100, stress);
}

/**
 * Enhanced composite with better valuation extremes handling
 */
function computeComposite(){
  // Macro indicators block (70% weight)
  let macroStress = 0;
  let macroTotalWeight = 0;
  let macroCount = 0;
  
  Object.entries(INDICATORS).forEach(([k, ind]) => {
    const stress = scaleIndicator(k, ind.current);
    if(stress !== null && Number.isFinite(stress) && ind.weight){
      macroStress += stress * ind.weight;
      macroTotalWeight += ind.weight;
      macroCount++;
    }
  });
  
  // Valuation block (30% weight)
  let valuationStressSum = 0;
  let valuationTotalWeight = 0;
  let valuationCount = 0;
  
  Object.entries(VALUATIONS).forEach(([k, v]) => {
    const stress = valuationStress(k, v.current);
    if(stress !== null && Number.isFinite(stress) && v.weight){
      valuationStressSum += stress * v.weight;
      valuationTotalWeight += v.weight;
      valuationCount++;
    }
  });
  
  let composite = null;
  
  // Calculate weighted components
  const macroComponent = macroTotalWeight > 0 ? (macroStress / macroTotalWeight) : 0;
  const valuationComponent = valuationTotalWeight > 0 ? (valuationStressSum / valuationTotalWeight) : 0;
  
  // Determine final composite based on data availability
  if(macroCount > 0 && valuationCount > 0){
    // Full composite: 70% macro + 30% valuation
    composite = (macroComponent * 0.7) + (valuationComponent * 0.3);
  } else if(macroCount > 0){
    // Macro-only: scale to 70% of full range to indicate partial data
    composite = macroComponent * 0.7;
  } else if(valuationCount > 0){
    // Valuation-only: scale to 30% of full range
    composite = valuationComponent * 0.3;
  }
  
  // Apply non-linear scaling to emphasize high-risk scenarios
  if(composite !== null){
    // Quadratic scaling to make high scores more distinctive
    composite = Math.min(100, composite * (1 + (composite / 100) * 0.2));
    
    // Additional boost for simultaneous valuation extremes
    const buffettStress = valuationStress('BUFFETT', VALUATIONS.BUFFETT.current);
    const capeStress = valuationStress('SHILLER_PE', VALUATIONS.SHILLER_PE.current);
    if(buffettStress > 80 && capeStress > 80){
      composite = Math.min(100, composite * 1.15); // 15% boost for dual extremes
    }
  }
  
  return composite;
}

/**
 * Enhanced risk band detection
 */
function getRiskBand(score){
  if(score == null) return 'insufficient';
  if(score < 25) return 'normal';
  if(score < 40) return 'watch';
  if(score < 60) return 'elevated';
  return 'high';
}

/**
 * Enhanced recession probability mapping
 */
function derivedRecessionRisk(c){
  if(c == null) return '--';
  
  // Based on historical stress-to-recession probability mapping
  if(c < 20) return '<10%';
  if(c < 35) return '10‚Äì25%';
  if(c < 50) return '25‚Äì40%';
  if(c < 65) return '40‚Äì60%';
  if(c < 80) return '60‚Äì75%';
  return '75‚Äì90%';
}

/**
 * Get top risk drivers for display
 */
function getTopRiskDrivers(){
  const drivers = [];
  
  // Check valuation extremes first
  Object.entries(VALUATIONS).forEach(([k, v]) => {
    if(Number.isFinite(v.current)){
      const stress = valuationStress(k, v.current);
      if(stress > 50){
        drivers.push({
          name: v.label,
          stress: stress,
          value: v.current,
          type: 'valuation',
          trend: 'up'
        });
      }
    }
  });
  
  // Check macro indicators
  Object.entries(INDICATORS).forEach(([k, ind]) => {
    if(Number.isFinite(ind.current)){
      const stress = scaleIndicator(k, ind.current);
      if(stress > 40){
        drivers.push({
          name: ind.label,
          stress: stress,
          value: ind.current,
          type: 'macro',
          trend: ind.direction === 'above' && ind.current > ind.threshold ? 'up' : 'down'
        });
      }
    }
  });
  
  // Sort by stress level and return top 3
  return drivers.sort((a, b) => b.stress - a.stress).slice(0, 3);
}

/**
 * Update risk drivers display
 */
function updateRiskDrivers(){
  const driversContainer = document.getElementById('top-drivers');
  const drivers = getTopRiskDrivers();
  
  if(drivers.length === 0){
    driversContainer.innerHTML = '<div style="font-weight: 600; margin-bottom: 6px; color: var(--accent-soft);">Top Risk Drivers</div><div>No elevated risks detected</div>';
    return;
  }
  
  let driversHTML = '<div style="font-weight: 600; margin-bottom: 6px; color: var(--accent-soft);">Top Risk Drivers</div>';
  
  drivers.forEach(driver => {
    const trendClass = driver.trend === 'up' ? 'trend-up' : 'trend-down';
    const trendSymbol = driver.trend === 'up' ? '‚Üó' : '‚Üò';
    driversHTML += `
      <div class="driver-item">
        <span>${driver.name}</span>
        <span class="driver-trend ${trendClass}">${Math.round(driver.stress)}% ${trendSymbol}</span>
      </div>
    `;
  });
  
  driversContainer.innerHTML = driversHTML;
}

/**
 * Enhanced valuation context detection
 */
function getValuationContext(){
  const buffett = VALUATIONS.BUFFETT.current;
  const cape = VALUATIONS.SHILLER_PE.current;
  
  if(!Number.isFinite(buffett) || !Number.isFinite(cape)) return null;
  
  // Similar to 2000 dot-com bubble
  if(buffett > 190 && cape > 35) return 'Similar to 2000 dot-com bubble';
  // Similar to 2021 peak
  if(buffett > 180 && cape > 35) return 'Similar to 2021 peak';
  // Similar to 2007 pre-GFC
  if(buffett > 100 && cape > 25) return 'Similar to 2007 pre-GFC';
  
  return null;
}

// ... (rest of the existing functions remain the same, but with enhanced styling based on risk levels)

/**
 * Enhanced gauge and status rendering with risk-based styling
 */
function renderGaugeAndStatus(){
  compositeScore = computeComposite();

  const scoreEl = document.getElementById('composite-score');
  const needle = document.getElementById('needle');
  const fill = document.getElementById('risk-fill');
  const regimeEl = document.getElementById('regime-label');
  const alert = document.getElementById('alert-banner');
  const riskBand = getRiskBand(compositeScore);

  // Update risk drivers
  updateRiskDrivers();

  // Update valuation context
  const valuationContext = getValuationContext();
  const contextBadge = document.getElementById('valuation-context-badge');
  if(valuationContext && contextBadge){
    contextBadge.innerHTML = `<span class="context-badge">${valuationContext}</span>`;
  }

  const total = Object.keys(INDICATORS).length + Object.keys(VALUATIONS).length;
  const used =
    Object.keys(INDICATORS).filter(k => Number.isFinite(INDICATORS[k].current)).length +
    Object.keys(VALUATIONS).filter(k => Number.isFinite(VALUATIONS[k].current)).length;

  const coverage = total ? (used / total) : 0;
  document.getElementById('inputs-badge').textContent =
    'Inputs: ' + used + '/' + total + ' populated';
  document.getElementById('quality-display').textContent =
    total ? Math.round(coverage * 100) + '%' : '--';

  if(compositeScore == null){
    scoreEl.textContent = '--';
    fill.style.width = '0%';
    needle.style.transform = 'translateX(-50%) rotate(0deg)';
    regimeEl.textContent = 'COMPOSITE STRESS ‚Äî insufficient data';
    document.getElementById('recession-risk-display').textContent = '--';
    document.getElementById('valuation-risk-display').textContent = '--';
    document.getElementById('labor-risk-display').textContent = '--';

    let msg = 'No composite yet. Check FRED cache and manual LEI / valuation inputs.';
    if(cacheAgeDays != null && cacheAgeDays > 7){
      msg = 'Data warning: FRED cache is ' + cacheAgeDays.toFixed(1) +
            ' days old. Update fred_cache.json. ' + msg;
    }
    alert.textContent = msg;
    return;
  }

  const v = Math.round(compositeScore);
  scoreEl.textContent = v;
  fill.style.width = v + '%';
  const angle = (v / 100) * 360;
  needle.style.transform = 'translateX(-50%) rotate(' + angle + 'deg)';

  // Enhanced regime labels with new risk bands
  let regime;
  let alertClass = '';
  if(riskBand === 'normal'){
    regime = 'Normal regime';
  } else if(riskBand === 'watch'){
    regime = 'Watch ‚Äî monitor closely';
  } else if(riskBand === 'elevated'){
    regime = 'Elevated ‚Äî defensive positioning';
    alertClass = 'critical-alert';
  } else {
    regime = 'High ‚Äî crash risk elevated';
    alertClass = 'critical-alert';
  }

  regimeEl.textContent = 'COMPOSITE STRESS ‚Äî ' + regime;
  document.getElementById('recession-risk-display').textContent = derivedRecessionRisk(v);
  document.getElementById('valuation-risk-display').textContent = derivedValuationRisk();
  document.getElementById('labor-risk-display').textContent = derivedLaborStress();

  // Apply critical styling to valuation status if extreme
  const valuationStatus = document.getElementById('valuation-status');
  const recessionStatus = document.getElementById('recession-status');
  if(derivedValuationRisk() === 'High'){
    valuationStatus.classList.add('critical');
  } else {
    valuationStatus.classList.remove('critical');
  }

  if(riskBand === 'high'){
    recessionStatus.classList.add('critical');
  } else {
    recessionStatus.classList.remove('critical');
  }

  let prefix = '';
  if(cacheAgeDays != null && cacheAgeDays > 7){
    prefix += 'Data warning: FRED cache is ' + cacheAgeDays.toFixed(1) +
              ' days old. Update fred_cache.json. ';
  }
  if(coverage < 0.8){
    prefix += 'Coverage below 80%. Treat composite as tentative. ';
  }

  // Enhanced alert messages
  if(riskBand === 'high'){
    alert.innerHTML = prefix + '<strong>üö® HIGH RISK:</strong> Composite = ' + v +
      '. Multiple indicators in danger territory. Similar to prior crash setups.';
    alert.className = 'alert-banner critical-alert';
  } else if(riskBand === 'elevated'){
    alert.innerHTML = prefix + '<strong>‚ö†Ô∏è ELEVATED:</strong> Composite = ' + v +
      '. Key indicators showing stress ‚Äî inspect risk drivers.';
    alert.className = 'alert-banner';
  } else {
    alert.textContent = prefix +
      'Composite = ' + v +
      '. Configuration not in classic crash cluster; monitor risk drivers.';
    alert.className = 'alert-banner';
  }

  // Apply critical styling to valuation card if valuations extreme
  const valuationCard = document.getElementById('valuation-card');
  const currentValuation = document.getElementById('current-valuation');
  const insightCard = document.getElementById('insight-card');
  
  const buffettStress = valuationStress('BUFFETT', VALUATIONS.BUFFETT.current);
  const capeStress = valuationStress('SHILLER_PE', VALUATIONS.SHILLER_PE.current);
  
  if(buffettStress > 70 || capeStress > 70){
    valuationCard.classList.add('critical');
    currentValuation.classList.add('extreme');
    insightCard.classList.add('critical');
  } else {
    valuationCard.classList.remove('critical');
    currentValuation.classList.remove('extreme');
    insightCard.classList.remove('critical');
  }
}

// ... (rest of the existing functions like loadFromFredCache, scaleIndicator, etc. remain unchanged)

// The existing functions for building UI elements, charts, and initialization remain the same
// but will now use the enhanced styling based on risk levels

</script>
</body>
</html>
