<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Economic Crash Radar Pro</title>
<style>
:root{
  --bg:#0a0e1a; --panel:#12182b; --panel-hover:#151d33; --text:#e8eeff; --muted:#8b96b0;
  --accent:#6b9eff; --accent-bright:#8fb4ff; --green:#1ec28b; --amber:#ffc247; --red:#ff6070;
}
*{box-sizing:border-box;margin:0;padding:0}
body{
  background:var(--bg);
  color:var(--text);
  font:15px/1.6 -apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
  -webkit-font-smoothing:antialiased;
  overflow-x:hidden;
}
.wrap{
  max-width:1600px;
  margin:0 auto;
  padding:24px 16px 80px;
  overflow-x:hidden;
}
h1{
  font-size:clamp(28px,5vw,54px);
  line-height:1.08;
  font-weight:800;
  margin-bottom:8px;
  background:linear-gradient(135deg,var(--text),var(--accent-bright));
  -webkit-background-clip:text;
  -webkit-text-fill-color:transparent;
  letter-spacing:-.02em;
}
.subtitle{
  color:var(--muted);
  font-weight:600;
  font-size:14px;
}
.header{
  display:flex;
  justify-content:space-between;
  align-items:flex-start;
  gap:16px;
  flex-wrap:wrap;
  margin-bottom:18px;
}
.badges{
  display:flex;
  gap:8px;
  flex-wrap:wrap;
  margin-top:12px;
}
.badge{
  display:inline-flex;
  align-items:center;
  gap:8px;
  padding:8px 12px;
  border:1px solid rgba(255,255,255,.08);
  background:rgba(255,255,255,.04);
  border-radius:10px;
  font-weight:700;
  font-size:12px;
  white-space:nowrap;
}
.btn{
  display:inline-flex;
  align-items:center;
  gap:8px;
  padding:10px 16px;
  border:none;
  border-radius:10px;
  background:var(--accent);
  color:#fff;
  font-weight:700;
  cursor:pointer;
  transition:all 0.2s ease;
  font-size:14px;
  white-space:nowrap;
}
.btn:hover{
  background:var(--accent-bright);
  transform:translateY(-1px);
}
.card{
  background:var(--panel);
  border:1px solid rgba(255,255,255,.06);
  border-radius:16px;
  padding:20px;
  margin:18px 0;
  box-shadow:0 4px 24px rgba(0,0,0,.3);
  transition:all 0.3s ease;
  overflow:hidden;
}
.card:hover{
  box-shadow:0 8px 32px rgba(0,0,0,.4);
  transform:translateY(-2px);
}
.status-pill{
  display:inline-flex;
  align-items:center;
  gap:10px;
  padding:10px 16px;
  border:1px solid rgba(255,255,255,.1);
  border-radius:12px;
  background:rgba(255,255,255,.04);
  font-weight:700;
  flex-wrap:wrap;
}
.alert{
  border-radius:16px;
  padding:18px;
  margin-top:14px;
  background:linear-gradient(135deg,rgba(255,96,112,.12),rgba(255,194,71,.12));
  border:1px solid rgba(255,96,112,.25);
  display:none;
}
.tabs{
  display:flex;
  gap:4px;
  border-bottom:2px solid rgba(255,255,255,.06);
  margin-top:8px;
  overflow-x:auto;
  overflow-y:hidden;
  -webkit-overflow-scrolling:touch;
  scrollbar-width:thin;
  scrollbar-color:rgba(255,255,255,.2) transparent;
}
.tabs::-webkit-scrollbar{height:4px}
.tabs::-webkit-scrollbar-thumb{
  background:rgba(255,255,255,.2);
  border-radius:2px;
}
.tab{
  background:transparent;
  border:none;
  color:var(--muted);
  padding:10px 14px;
  font-weight:800;
  cursor:pointer;
  border-radius:8px 8px 0 0;
  transition:all 0.2s ease;
  white-space:nowrap;
  flex-shrink:0;
  font-size:13px;
}
.tab.active{
  color:var(--accent-bright);
  background:rgba(255,255,255,.03);
}
.tab:hover:not(.active){
  color:var(--text);
  background:rgba(255,255,255,.02);
}
.view{
  display:none;
  animation:fadeIn 0.5s ease;
}
.view.active{display:block}
@keyframes fadeIn{from{opacity:0}to{opacity:1}}

.gauge{
  display:flex;
  gap:32px;
  align-items:center;
  flex-wrap:wrap;
}
.gauge-wrap{
  position:relative;
  width:200px;
  height:200px;
  flex-shrink:0;
}
.ring{
  position:absolute;
  inset:0;
  border-radius:50%;
  background:conic-gradient(var(--green) 0 108deg,var(--amber)108deg 216deg,var(--red)216deg 360deg);
  opacity:.35;
}
.ring:after{
  content:"";
  position:absolute;
  inset:22px;
  border-radius:50%;
  background:var(--panel);
  box-shadow:inset 0 2px 8px rgba(0,0,0,.35);
}
.needle{
  position:absolute;
  inset:0;
}
.needle:before{
  content:"";
  position:absolute;
  top:50%;
  left:50%;
  width:6px;
  height:48%;
  transform-origin:bottom center;
  transform:translate(-50%,-100%) rotate(var(--angle,0deg));
  background:linear-gradient(180deg,var(--accent-bright),var(--accent));
  border-radius:6px 6px 0 0;
  box-shadow:0 0 10px var(--accent);
  transition:transform 1s ease;
}
.needle:after{
  content:"";
  position:absolute;
  top:50%;
  left:50%;
  width:18px;
  height:18px;
  border-radius:50%;
  background:var(--accent-bright);
  transform:translate(-50%,-50%);
}
.score{
  position:absolute;
  inset:0;
  display:flex;
  align-items:center;
  justify-content:center;
  flex-direction:column;
  font-weight:800;
  z-index:1;
}
.score .v{
  font-size:52px;
  background:linear-gradient(135deg,var(--text),var(--accent-bright));
  -webkit-background-clip:text;
  -webkit-text-fill-color:transparent;
}
.score .l{
  font-size:10px;
  color:var(--muted);
  letter-spacing:1px;
  margin-top:4px;
  text-align:center;
}
.kpi-grid{
  display:grid;
  grid-template-columns:repeat(auto-fill,minmax(240px,1fr));
  gap:12px;
}
.kpi{
  border:1px solid rgba(255,255,255,.06);
  border-radius:12px;
  padding:14px;
  background:rgba(255,255,255,.03);
  transition:all 0.2s ease;
}
.kpi:hover{
  border-color:rgba(255,255,255,.1);
  background:rgba(255,255,255,.05);
}
.kpi h4{
  display:flex;
  align-items:center;
  justify-content:space-between;
  font-size:13px;
  margin-bottom:6px;
}
.dot{
  width:10px;
  height:10px;
  border-radius:50%;
  flex-shrink:0;
}
.dot.g{background:var(--green);box-shadow:0 0 8px var(--green)}
.dot.a{background:var(--amber);box-shadow:0 0 8px var(--amber)}
.dot.r{background:var(--red);box-shadow:0 0 8px var(--red)}
.small{font-size:11px;color:var(--muted)}
.kpi .val{
  font-size:26px;
  font-weight:800;
  margin:8px 0;
}

/* Manual override controls */
.manual-row{
  display:flex;
  align-items:center;
  gap:4px;
  margin-top:4px;
  flex-wrap:wrap;
}
.manual-label{
  font-size:9px;
  color:var(--muted);
}
.manual-input{
  width:80px;
  padding:3px 6px;
  font-size:10px;
  border-radius:6px;
  border:1px solid rgba(255,255,255,.22);
  background:rgba(0,0,0,.35);
  color:var(--text);
  outline:none;
}
.manual-input:focus{
  border-color:var(--accent);
  box-shadow:0 0 4px var(--accent);
}
.badge-mini{
  display:inline-flex;
  align-items:center;
  gap:4px;
  padding:2px 6px;
  border-radius:6px;
  border:1px solid rgba(255,255,255,.15);
  font-size:8px;
  color:var(--muted);
}

/* Buttons group */
.btns{
  display:flex;
  gap:4px;
  background:rgba(255,255,255,.04);
  border:1px solid rgba(255,255,255,.06);
  padding:4px;
  border-radius:10px;
  flex-wrap:wrap;
}
.btns button{
  background:transparent;
  border:none;
  color:var(--muted);
  padding:6px 10px;
  border-radius:8px;
  font-weight:700;
  cursor:pointer;
  transition:all 0.2s ease;
  font-size:12px;
  white-space:nowrap;
}
.btns button.active{
  background:var(--accent);
  color:#fff;
}
.btns button:hover:not(.active){
  background:rgba(255,255,255,.05);
  color:var(--text);
}

/* Charts / heatmap */
.chart{
  position:relative;
  height:340px;
  margin-top:12px;
}
.heat{
  display:grid;
  grid-template-columns:repeat(auto-fill,minmax(160px,1fr));
  gap:10px;
}
.cell{
  border:1px solid rgba(255,255,255,.06);
  border-radius:10px;
  padding:12px;
  background:rgba(255,255,255,.03);
  transition:all 0.2s ease;
  overflow:hidden;
  word-wrap:break-word;
}
.cell:hover{
  border-color:rgba(255,255,255,.1);
  background:rgba(255,255,255,.05);
}
.cell>*{
  word-wrap:break-word;
  overflow-wrap:break-word;
}
.bar{
  height:7px;
  border-radius:5px;
  background:rgba(255,255,255,.06);
  overflow:hidden;
  margin-top:8px;
}
.bar>span{
  display:block;
  height:100%;
  transition:width 0.5s ease;
}
.radar-chart{
  height:300px;
  margin-top:20px;
}

/* Risk meter */
.risk-meter{
  display:flex;
  align-items:center;
  gap:12px;
  margin-top:8px;
  flex-wrap:wrap;
}
.risk-level{
  width:100%;
  min-width:180px;
  height:7px;
  border-radius:4px;
  background:rgba(255,255,255,.1);
  overflow:hidden;
}
.risk-level>div{
  height:100%;
  transition:width 0.5s ease;
}
.risk-labels{
  display:flex;
  justify-content:space-between;
  margin-top:4px;
  gap:4px;
  flex-wrap:wrap;
}
.risk-labels span{
  font-size:9px;
  color:var(--muted);
}

/* Insight */
.insight-card{
  background:linear-gradient(135deg,rgba(107,158,255,.1),rgba(139,187,255,.05));
  border:1px solid rgba(107,158,255,.2);
  border-radius:12px;
  padding:14px;
  margin-top:16px;
  display:none;
}
.insight-card h4{
  display:flex;
  align-items:center;
  gap:8px;
  margin-bottom:8px;
  color:var(--accent-bright);
  font-size:14px;
}

/* Responsive */
@media (max-width:768px){
  .gauge{
    flex-direction:column;
    align-items:center;
    gap:24px;
  }
  .gauge-wrap{
    width:180px;
    height:180px;
  }
  .wrap{
    padding:16px 12px 60px;
  }
  h1{font-size:28px;}
  .header{
    flex-direction:column;
    align-items:stretch;
  }
  .header>div:first-child{margin-bottom:8px;}
  .kpi-grid{grid-template-columns:1fr;}
  .heat{grid-template-columns:1fr;}
  .chart{height:260px;}
  .tabs{
    gap:2px;
    padding-bottom:2px;
  }
  .tab{
    padding:8px 10px;
    font-size:12px;
  }
  .btns{justify-content:flex-start;}
  .btns button{
    padding:6px 8px;
    font-size:11px;
  }
  .cell{
    padding:10px;
    font-size:13px;
  }
  .badge{
    font-size:11px;
    padding:6px 10px;
    gap:6px;
  }
  .card{padding:16px;}
  .status-pill{
    font-size:13px;
    padding:8px 12px;
  }
}
</style>
</head>
<body>
<div class="wrap">
  <div class="header">
    <div>
      <h1>‚ö° Economic Crash Radar Pro</h1>
      <div class="subtitle">
        Reads your FRED cache for what exists. Lets you type the rest. Composite = exactly what‚Äôs on this screen.
      </div>
    </div>
    <div style="display:flex;gap:10px;flex-wrap:wrap">
      <button class="btn" id="refreshBtn">üîÑ Reload from FRED cache</button>
      <button class="btn" id="exportBtn">üì• Export JSON</button>
    </div>
  </div>

  <div class="badges">
    <div class="badge" id="modeBadge">Source: data/fred_cache.json + manual overrides</div>
    <div class="badge" id="upd">Last FRED Cache: --</div>
    <div class="badge" id="qual">Quality: --</div>
    <div class="badge" id="indicatorsCount">Indicators: --</div>
  </div>

  <div class="status-pill" id="regime">--</div>
  <div class="alert" id="alert"></div>

  <div class="card">
    <div class="gauge">
      <div class="gauge-wrap">
        <div class="ring"></div>
        <div class="needle" id="needle"></div>
        <div class="score">
          <div class="v" id="scoreV">--</div>
          <div class="l">COMPOSITE STRESS</div>
        </div>
      </div>
      <div style="flex:1;min-width:240px">
        <h2 style="margin:0 0 6px;font-size:20px">Economic Stress Index</h2>
        <div class="small" id="partsNote">Composite from indicator set below</div>

        <div class="badge" style="margin-top:10px;display:flex;align-items:center;gap:10px;flex-wrap:wrap">
          <span>Methodology Transparency</span>
          <div style="width:80px;height:7px;background:rgba(255,255,255,.1);border-radius:4px;overflow:hidden">
            <div id="qfill" style="height:100%;background:linear-gradient(90deg,#4a7fe8,var(--accent-bright));width:0%"></div>
          </div>
          <strong id="qtxt">--</strong>
        </div>

        <div class="risk-meter">
          <span class="small">Risk Level:</span>
          <div class="risk-level">
            <div id="riskFill" style="width:0%;background:linear-gradient(90deg,var(--green),var(--amber),var(--red))"></div>
          </div>
        </div>
        <div class="risk-labels">
          <span>Low (0-30)</span><span>Medium (30-50)</span>
          <span>High (50-70)</span><span>Critical (70+)</span>
        </div>

        <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:8px;margin-top:12px">
          <div class="kpi">
            <div class="small">Recession Risk (2026) ‚Äî manual</div>
            <div class="val" style="font-size:22px" id="r1m">--</div>
            <div class="small" id="m1dir">Set from your own probabilities</div>
          </div>
          <div class="kpi">
            <div class="small">Valuation Risk ‚Äî manual</div>
            <div class="val" style="font-size:22px" id="r3m">--</div>
            <div class="small" id="m3dir">2‚Äì5 year drawdown risk</div>
          </div>
          <div class="kpi">
            <div class="small">Labor Market Stress ‚Äî from FRED where possible</div>
            <div class="val" style="font-size:22px" id="r6m">--</div>
            <div class="small" id="m6dir">Derived from UNRATE / claims</div>
          </div>
        </div>
      </div>
    </div>
    <div class="insight-card" id="insightCard">
      <h4>üí° Insight</h4>
      <div id="insightText"></div>
    </div>
  </div>

  <div class="tabs">
    <button class="tab active" data-t="overview">Overview</button>
    <button class="tab" data-t="ind">Indicators</button>
    <button class="tab" data-t="val">Valuations</button>
    <button class="tab" data-t="hist">Historical</button>
    <button class="tab" data-t="scn">Analysis</button>
  </div>

  <div id="view-overview" class="view active">
    <div class="card">
      <h3 style="margin-bottom:12px;font-size:18px">üìä Tier 1 Critical Indicators</h3>
      <div class="kpi-grid" id="tier1Grid"></div>
    </div>
    <div class="card">
      <h3 style="margin-bottom:12px;font-size:18px">üìà Tier 2 Key Stress Indicators</h3>
      <div class="kpi-grid" id="tier2Grid"></div>
    </div>
    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap;margin-bottom:8px">
        <h3 style="margin:0;font-size:18px">üìà Composite Trend (demo)</h3>
        <div class="btns">
          <button data-p="30d" class="active">30D</button>
          <button data-p="90d">90D</button>
          <button data-p="6m">6M</button>
          <button data-p="1y">1Y</button>
          <button data-p="all">ALL</button>
        </div>
      </div>
      <div class="chart"><canvas id="mainChart"></canvas></div>
    </div>
  </div>

  <div id="view-ind" class="view">
    <div class="card">
      <h3 style="margin-bottom:10px;font-size:18px">Risk Contribution Breakdown</h3>
      <div class="chart"><canvas id="decomp"></canvas></div>
    </div>
    <div class="card">
      <h3 style="margin-bottom:10px;font-size:18px">Indicator Radar</h3>
      <div class="radar-chart"><canvas id="radarChart"></canvas></div>
    </div>
    <div class="card">
      <h3 style="margin-bottom:10px;font-size:18px">Indicator Heat Map</h3>
      <div class="heat" id="heat"></div>
    </div>
  </div>

  <div id="view-val" class="view">
    <div class="card">
      <h3 style="margin-bottom:10px;font-size:18px">üìä Market Valuation Analysis (manual)</h3>
      <div class="kpi-grid" id="valGrid"></div>
    </div>
  </div>

  <div id="view-hist" class="view">
    <div class="card">
      <h3 style="margin-bottom:10px;font-size:18px">üìà Historical Crisis Comparisons (illustrative)</h3>
      <div id="crises" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:10px"></div>
    </div>
    <div class="card">
      <h3 style="margin-bottom:10px;font-size:18px">Crisis Timeline (synthetic)</h3>
      <div class="chart"><canvas id="crisisTimeline"></canvas></div>
    </div>
  </div>

  <div id="view-scn" class="view">
    <div class="card">
      <h3 style="margin-bottom:10px;font-size:18px">üéØ 2026 Recession Risk Assessment (manual)</h3>
      <div id="scenarios"></div>
    </div>
    <div class="card">
      <h3 style="margin-bottom:10px;font-size:18px">Narrative / Institutional Signals</h3>
      <div id="institutionalForecasts"></div>
    </div>
    <div class="card">
      <h3 style="margin-bottom:10px;font-size:18px">Risk Trajectory Outlook (modelled)</h3>
      <div class="chart"><canvas id="traj"></canvas></div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script>
'use strict';

const USE_VALUATIONS_IN_COMPOSITE = true;

const INDICATORS = {
  // FRED-backed where you have series
  YIELD_CURVE:{tier:1,label:'10y-3m Treasury Spread',short:'YC',weight:0.12,current:0,threshold:0,direction:'below',fromFred:true,
    format:v=>v.toFixed(2)+'%',desc:'Auto from T10Y3M (spread already).'},
  CREDIT_SPREAD:{tier:2,label:'HY Credit Spread (BAMLH0A0HYM2)',short:'HY',weight:0.08,current:0,threshold:5.0,direction:'above',fromFred:true,
    format:v=>v.toFixed(2)+'%',desc:'Auto from HY OAS FRED series.'},
  UNEMPLOYMENT:{tier:3,label:'Unemployment Rate (UNRATE)',short:'U',weight:0.05,current:0,threshold:5.0,direction:'above',fromFred:true,
    format:v=>v.toFixed(1)+'%',desc:'Auto from UNRATE.'},
  INITIAL_CLAIMS:{tier:2,label:'Initial Claims 4w MA (k)',short:'Claims',weight:0.07,current:0,threshold:323,direction:'above',fromFred:true,
    format:v=>Math.round(v),desc:'4-week avg from ICSA, in thousands.'},
  CONSUMER_SENTIMENT:{tier:1,label:'UMich Sentiment (UMCSENT)',short:'Sent',weight:0.10,current:0,threshold:60,direction:'below',fromFred:true,
    format:v=>v.toFixed(1),desc:'Auto from UMCSENT.'},
  NFCI:{tier:3,label:'Financial Conditions (NFCI)',short:'NFCI',weight:0.06,current:0,threshold:0,direction:'above',fromFred:true,
    format:v=>v.toFixed(3),desc:'Auto from NFCI.'},
  VIX:{tier:3,label:'VIX (VIXCLS)',short:'VIX',weight:0.04,current:0,threshold:25,direction:'above',fromFred:true,
    format:v=>v.toFixed(1),desc:'Auto from VIXCLS.'},
  SAHM_RULE:{tier:3,label:'Sahm Rule (SAHMREALTIME)',short:'Sahm',weight:0.04,current:0,threshold:0.5,direction:'above',fromFred:true,
    format:v=>v.toFixed(2),desc:'Auto from SAHMREALTIME.‚Äô},
  HOUSEHOLD_DSR:{tier:2,label:'Household Debt Service (TDSP)',short:'DSR',weight:0.07,current:0,threshold:13.5,direction:'above',fromFred:true,
    format:v=>v.toFixed(2)+'%',desc:'Auto from TDSP; % of DPI.'},
  BUILDING_PERMITS:{tier:3,label:'Permits 6m %Œî (PERMIT)',short:'Perm',weight:0.04,current:0,threshold:-15,direction:'below',fromFred:true,
    format:v=>v.toFixed(1)+'%',desc:'Computed 6m change if history available.'},

  // Manual-only (not in fred_cache)
  LEI:{tier:1,label:'Conference Board LEI 6m %Œî',short:'LEI',weight:0.15,current:-2.8,threshold:-4.1,direction:'below',fromFred:false,
    format:v=>v.toFixed(1)+'%',desc:'Enter from Conference Board release.'},
  ISM_NEW_ORDERS:{tier:2,label:'ISM New Orders',short:'ISM NO',weight:0.08,current:49.4,threshold:47.5,direction:'below',fromFred:false,
    format:v=>v.toFixed(1),desc:'Enter from ISM report.'},
  HOUSING_AFFORD:{tier:2,label:'Housing Affordability Index',short:'HAI',weight:0.06,current:87.3,threshold:100,direction:'below',fromFred:false,
    format:v=>v.toFixed(1),desc:'Enter from NAR.'},
  CORPORATE_MARGINS:{tier:2,label:'Corporate Profit Margins',short:'Margins',weight:0.06,current:8.2,threshold:7.5,direction:'below',fromFred:false,
    format:v=>v.toFixed(1)+'%',desc:'Enter from BEA / internal calc.'}
};

const VALUATIONS = {
  BUFFETT:{label:'Buffett Indicator (MktCap/GDP%)',short:'Buffett',weight:0.40,current:220.2,danger:180,fromFred:false,
    format:v=>v.toFixed(1)+'%',desc:'Enter from Wilshire/GDP sources.'},
  SHILLER_PE:{label:'Shiller CAPE',short:'CAPE',weight:0.30,current:39.6,danger:30,fromFred:false,
    format:v=>v.toFixed(1),desc:'Enter from Shiller data.'},
  FORWARD_PE:{label:'Forward P/E',short:'FwdPE',weight:0.20,current:22.7,danger:20,fromFred:false,
    format:v=>v.toFixed(1),desc:'Enter from S&P index providers.'},
  EQUITY_RISK_PREM:{label:'Equity Risk Premium',short:'ERP',weight:0.10,current:0.0,danger:1.5,fromFred:false,
    format:v=>v.toFixed(1)+'%',desc:'Enter from your own ERP model.'}
};

const CURRENT_DATA = {
  composite:null,
  quality:92,
  recessionProb:NaN,
  valuationRisk:NaN,
  laborRisk:NaN
};

const CRISES = [
  {name:'2000 Dot-com',score:72,outcome:'~49% drawdown'},
  {name:'2008 GFC',score:95,outcome:'~57% drawdown'},
  {name:'2020 COVID',score:82,outcome:'Sharp but brief'},
  {name:'2022 Inflation',score:58,outcome:'~25% tech-led'}
];

let app = {boundPeriods:false,boundTabs:false};
let charts = {};

function byId(id){return document.getElementById(id);}

/* ===== Load from data/fred_cache.json ===== */

async function loadLiveData(){
  try{
    const res = await fetch('data/fred_cache.json', {cache:'no-store'});
    if(!res.ok){
      console.warn('No fred_cache.json or fetch failed', res.status);
      return;
    }
    const cache = await res.json();

    if(cache.generated_at && byId('upd')){
      byId('upd').textContent = `Last FRED Cache: ${cache.generated_at}`;
    }

    // Helpers on this cache format
    const series = cache.series || {};

    const lastVal = id => {
      const s = series[id];
      if(!s || !s.observations || !s.observations.length) return null;
      const o = s.observations[s.observations.length - 1];
      return typeof o.value === 'number' ? o.value : null;
    };

    const rollingAvgLastN = (id,n) => {
      const s = series[id];
      if(!s || !s.observations || s.observations.length < n) return null;
      const slice = s.observations.slice(-n);
      const sum = slice.reduce((a,o)=>a+o.value,0);
      return sum / n;
    };

    const obsMonthsBack = (id,months) => {
      const s = series[id];
      if(!s || !s.observations || !s.observations.length) return null;
      const last = s.observations[s.observations.length - 1];
      const lastDate = new Date(last.date);
      if(isNaN(lastDate)) return null;
      const target = new Date(lastDate);
      target.setMonth(target.getMonth()-months);
      let candidate = null;
      for(const o of s.observations){
        const d = new Date(o.date);
        if(isNaN(d)) continue;
        if(d <= target) candidate = o; else break;
      }
      return candidate;
    };

    const pctChange = (nv,ov) => {
      if(!Number.isFinite(nv) || !Number.isFinite(ov) || ov === 0) return null;
      return (nv-ov)/ov*100;
    };

    // Map cache ‚Üí indicators where we have them

    const yc = lastVal('T10Y3M');
    if(yc != null && INDICATORS.YIELD_CURVE) INDICATORS.YIELD_CURVE.current = yc;

    const hy = lastVal('BAMLH0A0HYM2');
    if(hy != null && INDICATORS.CREDIT_SPREAD) INDICATORS.CREDIT_SPREAD.current = hy;

    const unrate = lastVal('UNRATE');
    if(unrate != null && INDICATORS.UNEMPLOYMENT) INDICATORS.UNEMPLOYMENT.current = unrate;

    const sent = lastVal('UMCSENT');
    if(sent != null && INDICATORS.CONSUMER_SENTIMENT) INDICATORS.CONSUMER_SENTIMENT.current = sent;

    const nfci = lastVal('NFCI');
    if(nfci != null && INDICATORS.NFCI) INDICATORS.NFCI.current = nfci;

    const vix = lastVal('VIXCLS');
    if(vix != null && INDICATORS.VIX) INDICATORS.VIX.current = vix;

    const sahm = lastVal('SAHMREALTIME');
    if(sahm != null && INDICATORS.SAHM_RULE) INDICATORS.SAHM_RULE.current = sahm;

    const tdsp = lastVal('TDSP');
    if(tdsp != null && INDICATORS.HOUSEHOLD_DSR) INDICATORS.HOUSEHOLD_DSR.current = tdsp;

    const claims4 = rollingAvgLastN('ICSA',4);
    if(claims4 != null && INDICATORS.INITIAL_CLAIMS){
      INDICATORS.INITIAL_CLAIMS.current = claims4/1000; // to thousands
    } else {
      const cLast = lastVal('ICSA');
      if(cLast != null && INDICATORS.INITIAL_CLAIMS){
        INDICATORS.INITIAL_CLAIMS.current = cLast/1000;
      }
    }

    const permLast = lastVal('PERMIT');
    const perm6m = obsMonthsBack('PERMIT',6);
    if(permLast != null && perm6m && INDICATORS.BUILDING_PERMITS){
      const d = pctChange(permLast, perm6m.value);
      if(d != null) INDICATORS.BUILDING_PERMITS.current = d;
    }
  }catch(err){
    console.error('Error loading fred_cache.json', err);
  }
}

/* ===== Scoring ===== */

function scaleIndicator(key,value){
  const ind = INDICATORS[key];
  if(!ind || !Number.isFinite(value)) return 50;
  const t = ind.threshold;
  const dir = ind.direction;
  let stress;
  if(dir === 'below'){
    if(value >= t) stress = 0;
    else{
      const diff = t - value;
      stress = Math.min(100, Math.abs(diff / (t || 1))*100);
    }
  }else{
    if(value <= t) stress = 0;
    else{
      const diff = value - t;
      stress = Math.min(100, Math.abs(diff / (t || 1))*100);
    }
  }
  return Math.max(0, Math.min(100, stress));
}

function valuationStress(key,val){
  const v = VALUATIONS[key];
  if(!v || !Number.isFinite(val)) return 0;
  if(key === 'EQUITY_RISK_PREM'){
    if(val >= v.danger) return 0;
    const diff = v.danger - val;
    return Math.max(0, Math.min(100, (diff / (v.danger || 1))*100));
  }else{
    if(val <= v.danger) return 0;
    const diff = val - v.danger;
    return Math.max(0, Math.min(100, (diff / v.danger)*100));
  }
}

/* ===== Render / Recalc ===== */

function recalcAll(){
  renderComposite();
  renderTierGrids();
  renderValuations();
  renderDecomp();
  renderRadar();
  renderHeat();
  renderCrises();
  renderScenarios();
  renderInstitutionalForecasts();
  renderTrajectory();
  drawTrendChart();
}

function renderComposite(){
  let sum=0, wsum=0;

  Object.keys(INDICATORS).forEach(k=>{
    const ind = INDICATORS[k];
    const s = scaleIndicator(k, ind.current);
    sum += s * ind.weight;
    wsum += ind.weight;
  });

  if(USE_VALUATIONS_IN_COMPOSITE){
    Object.keys(VALUATIONS).forEach(k=>{
      const v = VALUATIONS[k];
      const s = valuationStress(k, v.current);
      sum += s * (v.weight || 0);
      wsum += (v.weight || 0);
    });
  }

  const composite = wsum ? sum/wsum : 50;
  CURRENT_DATA.composite = composite;

  byId('scoreV').textContent = Math.round(composite);
  byId('needle').style.setProperty('--angle',(composite*3.6)+'deg');
  byId('partsNote').textContent =
    `Composite from ${Object.keys(INDICATORS).length} indicators` +
    (USE_VALUATIONS_IN_COMPOSITE ? ' + valuations' : '');
  byId('indicatorsCount').textContent =
    `Indicators: ${Object.keys(INDICATORS).length}/${Object.keys(INDICATORS).length}`;
  byId('qfill').style.width = CURRENT_DATA.quality + '%';
  byId('qtxt').textContent = CURRENT_DATA.quality + '%';
  byId('qual').textContent = `Quality: ${CURRENT_DATA.quality}% (inputs visible, no hidden feed)`;
  byId('riskFill').style.width = composite + '%';

  const zone = composite<=30 ? 'green' : (composite<=50 ? 'amber' : 'red');
  const zoneLabel =
    composite<=30 ? 'Low stress'
    : composite<=50 ? 'Elevated ‚Äî monitor'
    : 'High ‚Äî defensive stance';
  const zoneColor = zone==='green' ? 'var(--green)'
                   : zone==='amber' ? 'var(--amber)'
                   : 'var(--red)';

  byId('regime').innerHTML =
    `<span style="width:12px;height:12px;border-radius:50%;background:${zoneColor};box-shadow:0 0 10px ${zoneColor}"></span>
     <strong style="font-size:17px">${Math.round(composite)}</strong>
     <span style="font-size:15px">| ${zoneLabel}</span>`;

  const alertBox = byId('alert');
  if(composite >= 50){
    alertBox.style.display = 'block';
    alertBox.innerHTML =
      `‚ö†Ô∏è <strong>ELEVATED WARNING</strong> ‚Äî Composite at ${Math.round(composite)}. Check inputs; nothing here is simulated.`;
  }else{
    alertBox.style.display = 'none';
  }

  const insightCard = byId('insightCard');
  const insightText = byId('insightText');
  if(composite >= 45){
    insightCard.style.display = 'block';
    insightText.textContent =
      'Signal is driven by your actual FRED data plus any manual valuations you entered. If this looks wrong, it means an input is off ‚Äî not hidden logic.';
  }else{
    insightCard.style.display = 'none';
    insightText.textContent = '';
  }
}

/* ===== Indicator Cards ===== */

function buildKpi(key, ind){
  const s = scaleIndicator(key, ind.current);
  const rag = s<33 ? 'g' : (s<66 ? 'a' : 'r');
  const tLabel = (ind.direction === 'below' ? '< ' : '> ') + ind.format(ind.threshold);
  const badge = ind.fromFred
    ? '<span class="badge-mini">From FRED cache</span>'
    : '<span class="badge-mini">Manual</span>';

  const manual = !ind.fromFred ? `
    <div class="manual-row">
      <span class="manual-label">Set value:</span>
      <input class="manual-input" type="number" step="0.01" value="${ind.current}"
        data-key="${key}"/>
    </div>` : '';

  return `
    <div class="kpi" id="pill-${key}">
      <h4>
        <span>${ind.label}</span>
        <span style="display:flex;align-items:center;gap:4px">
          ${badge}
          <span class="dot ${rag}"></span>
        </span>
      </h4>
      <div class="val">${Number.isFinite(ind.current) ? ind.format(ind.current) : '--'}</div>
      <div class="small">Threshold: ${tLabel}</div>
      <div class="small">${ind.desc}</div>
      ${manual}
    </div>
  `;
}

function attachManualInputs(root){
  root.querySelectorAll('.manual-input[data-key]').forEach(input=>{
    input.onchange = () => {
      const k = input.dataset.key;
      const v = parseFloat(input.value);
      if(!isNaN(v) && INDICATORS[k]){
        INDICATORS[k].current = v;
        recalcAll();
      }
    };
  });
}

function renderTierGrids(){
  const t1 = Object.keys(INDICATORS).filter(k=>INDICATORS[k].tier===1);
  const t2 = Object.keys(INDICATORS).filter(k=>INDICATORS[k].tier===2);
  byId('tier1Grid').innerHTML = t1.map(k=>buildKpi(k,INDICATORS[k])).join('');
  byId('tier2Grid').innerHTML = t2.map(k=>buildKpi(k,INDICATORS[k])).join('');
  attachManualInputs(byId('tier1Grid'));
  attachManualInputs(byId('tier2Grid'));
}

/* ===== Valuations (all manual) ===== */

function renderValuations(){
  const grid = byId('valGrid');
  grid.innerHTML = Object.keys(VALUATIONS).map(key=>{
    const v = VALUATIONS[key];
    const s = valuationStress(key, v.current);
    const rag = s<33 ? 'g' : (s<66 ? 'a' : 'r');
    return `
      <div class="kpi">
        <h4>
          <span>${v.label}</span>
          <span style="display:flex;align-items:center;gap:4px">
            <span class="badge-mini">Manual</span>
            <span class="dot ${rag}"></span>
          </span>
        </h4>
        <div class="val">${Number.isFinite(v.current) ? v.format(v.current) : '--'}</div>
        <div class="small">${v.desc}</div>
        <div class="manual-row">
          <span class="manual-label">Set value:</span>
          <input class="manual-input" type="number" step="0.01"
            value="${v.current}" data-valkey="${key}"/>
        </div>
      </div>
    `;
  }).join('');

  grid.querySelectorAll('.manual-input[data-valkey]').forEach(input=>{
    input.onchange = () => {
      const k = input.dataset.valkey;
      const v = parseFloat(input.value);
      if(!isNaN(v) && VALUATIONS[k]){
        VALUATIONS[k].current = v;
        recalcAll();
      }
    };
  });
}

/* ===== Charts (decomp, radar, heat, crises, etc.) ===== */

function renderDecomp(){
  const ctx = byId('decomp').getContext('2d');
  if(charts.decomp) charts.decomp.destroy();
  const keys = Object.keys(INDICATORS);
  const labels = keys.map(k=>INDICATORS[k].short);
  const data = keys.map(k=>{
    const ind = INDICATORS[k];
    return +(scaleIndicator(k, ind.current) * ind.weight).toFixed(2);
  });
  const colors = keys.map(k=>{
    const s = scaleIndicator(k, INDICATORS[k].current);
    return s<33 ? '#1ec28b' : (s<66 ? '#ffc247' : '#ff6070');
  });
  charts.decomp = new Chart(ctx,{
    type:'bar',
    data:{labels,datasets:[{data,backgroundColor:colors}]},
    options:{
      responsive:true,
      plugins:{legend:{display:false}},
      scales:{
        x:{ticks:{color:'#8b96b0',font:{size:10}}},
        y:{ticks:{color:'#8b96b0',callback:v=>v+'%',font:{size:10}},
           grid:{color:'rgba(255,255,255,.06)'}}
      }
    }
  });
}

function renderRadar(){
  const ctx = byId('radarChart').getContext('2d');
  if(charts.radar) charts.radar.destroy();
  const keys = Object.keys(INDICATORS).slice(0,10);
  const labels = keys.map(k=>INDICATORS[k].short);
  const data = keys.map(k=>scaleIndicator(k, INDICATORS[k].current));
  const colors = keys.map(k=>{
    const s = scaleIndicator(k, INDICATORS[k].current);
    return s<33 ? '#1ec28b' : (s<66 ? '#ffc247' : '#ff6070');
  });
  charts.radar = new Chart(ctx,{
    type:'radar',
    data:{labels,datasets:[{
      data,
      backgroundColor:'rgba(107,158,255,.2)',
      borderColor:'#6b9eff',
      pointBackgroundColor:colors,
      pointBorderColor:'#fff',
      pointRadius:3
    }]},
    options:{
      responsive:true,
      plugins:{legend:{display:false}},
      scales:{r:{
        min:0,max:100,
        grid:{color:'rgba(255,255,255,.1)'},
        angleLines:{color:'rgba(255,255,255,.1)'},
        pointLabels:{color:'#8b96b0',font:{size:9}},
        ticks:{display:true,backdropColor:'transparent',color:'#8b96b0',
               callback:v=>v+'%',font:{size:8}}
      }}
    }
  });
}

function renderHeat(){
  const heat = byId('heat');
  const keys = Object.keys(INDICATORS);
  heat.innerHTML = keys.map(k=>{
    const ind = INDICATORS[k];
    const s = Math.round(scaleIndicator(k, ind.current));
    const col = s<33 ? 'var(--green)' : (s<66 ? 'var(--amber)' : 'var(--red)');
    return `
      <div class="cell">
        <div class="small" style="font-weight:800">${ind.short}</div>
        <div style="font-weight:800;font-size:22px;margin:6px 0">
          ${Number.isFinite(ind.current) ? ind.format(ind.current) : '--'}
        </div>
        <div class="bar"><span style="width:${s}%;background:${col};box-shadow:0 0 8px ${col}"></span></div>
        <div class="small" style="margin-top:4px">Stress: ${s}%</div>
      </div>
    `;
  }).join('');
}

function renderCrises(){
  const cur = CURRENT_DATA.composite || 50;
  const box = byId('crises');
  box.innerHTML = CRISES.map(c=>{
    const sim = Math.max(0, 100 - Math.abs(cur - c.score));
    const col = sim>70 ? 'var(--red)' : 'var(--amber)';
    return `
      <div class="cell">
        <div class="small" style="font-weight:800">${c.name}</div>
        <div class="small">Ref stress: ${c.score}</div>
        <div class="small">Outcome: ${c.outcome}</div>
        <div class="small" style="margin-top:4px">Pattern similarity (rough):</div>
        <div style="font-weight:800;font-size:18px;color:${col}">${Math.round(sim)}%</div>
      </div>
    `;
  }).join('');
  drawCrisisTimeline();
}

function drawCrisisTimeline(){
  const ctx = byId('crisisTimeline').getContext('2d');
  if(charts.crisisTimeline) charts.crisisTimeline.destroy();
  const labels = [];
  const data = [];
  let val = CURRENT_DATA.composite || 45;
  const start = new Date();
  start.setMonth(start.getMonth()-36);
  for(let i=0;i<=36;i++){
    const d = new Date(start);
    d.setMonth(start.getMonth()+i);
    labels.push(d.toISOString().slice(0,7));
    val += (Math.random()-0.5)*4;
    val = Math.max(20,Math.min(80,val));
    data.push(+val.toFixed(1));
  }
  charts.crisisTimeline = new Chart(ctx,{
    type:'line',
    data:{labels,datasets:[{
      data,fill:true,tension:0.35,borderWidth:2,
      borderColor:'#6b9eff',backgroundColor:'rgba(107,158,255,.12)',
      pointRadius:0
    }]},
    options:{
      responsive:true,
      plugins:{legend:{display:false}},
      scales:{
        y:{min:0,max:100,ticks:{color:'#8b96b0',callback:v=>v+'%',font:{size:10}},
           grid:{color:'rgba(255,255,255,.06)'}},
        x:{ticks:{color:'#8b96b0',maxTicksLimit:8,font:{size:9}},
           grid:{color:'rgba(255,255,255,.06)'}}
      }
    }
  });
}

function drawTrendChart(){
  const ctx = byId('mainChart').getContext('2d');
  if(charts.main) charts.main.destroy();
  const labels = [];
  const data = [];
  let val = CURRENT_DATA.composite || 45;
  const start = new Date();
  start.setDate(start.getDate()-365);
  for(let i=0;i<52;i++){
    const d = new Date(start);
    d.setDate(start.getDate()+i*7);
    labels.push(d.toISOString().slice(0,10));
    val += (Math.random()-0.5)*3;
    val = Math.max(20,Math.min(80,val));
    data.push(+val.toFixed(1));
  }
  charts.main = new Chart(ctx,{
    type:'line',
    data:{labels,datasets:[{
      data,
      tension:0.35,
      fill:true,
      borderWidth:2,
      borderColor:'#6b9eff',
      backgroundColor:'rgba(107,158,255,.12)',
      pointRadius:0
    }]},
    options:{
      responsive:true,
      plugins:{legend:{display:false}},
      scales:{
        y:{min:0,max:100,ticks:{color:'#8b96b0',callback:v=>v+'%',font:{size:10}},
           grid:{color:'rgba(255,255,255,.06)'}},
        x:{ticks:{color:'#8b96b0',maxTicksLimit:8,font:{size:9}},
           grid:{color:'rgba(255,255,255,.06)'}}
      }
    }
  });
}

function renderScenarios(){
  byId('scenarios').innerHTML = `
    <div class="cell">
      <div class="small">Set your own probabilities. This block does not guess.</div>
    </div>
  `;
}

function renderInstitutionalForecasts(){
  byId('institutionalForecasts').innerHTML = `
    <div class="cell">
      <div class="small">Use this area for written views. No hidden data or forecasts here.</div>
    </div>
  `;
}

function renderTrajectory(){
  const ctx = byId('traj').getContext('2d');
  if(charts.traj) charts.traj.destroy();
  const cur = CURRENT_DATA.composite || 50;
  const labels=[],base=[],up=[],dn=[];
  let v=cur;
  for(let i=1;i<=26;i++){
    v = 0.92*v + 0.08*45;
    const band = 8*Math.sqrt(i/26);
    labels.push('W+'+i);
    base.push(+v.toFixed(1));
    up.push(Math.min(100,+(v+band).toFixed(1)));
    dn.push(Math.max(0,+(v-band).toFixed(1)));
  }
  charts.traj = new Chart(ctx,{
    type:'line',
    data:{labels,datasets:[
      {label:'Base',data:base,borderColor:'#6b9eff',borderWidth:2,tension:.35,fill:false},
      {label:'Upside',data:dn,borderColor:'#1ec28b',borderDash:[4,4],borderWidth:1,fill:false},
      {label:'Downside',data:up,borderColor:'#ff6070',borderDash:[4,4],borderWidth:1,fill:false}
    ]},
    options:{
      responsive:true,
      plugins:{legend:{labels:{color:'#8b96b0',font:{size:9}}}},
      scales:{
        y:{min:0,max:100,ticks:{color:'#8b96b0',callback:v=>v+'%',font:{size:9}},
           grid:{color:'rgba(255,255,255,.06)'}},
        x:{ticks:{color:'#8b96b0',font:{size:8}},
           grid:{color:'rgba(255,255,255,.06)'}}
      }
    }
  });
}

/* ===== Tabs / Buttons / Export ===== */

function setupTabs(){
  if(app.boundTabs) return;
  app.boundTabs = true;
  document.querySelectorAll('.tab').forEach(t=>{
    t.addEventListener('click',()=>{
      document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
      t.classList.add('active');
      const key = t.dataset.t;
      document.querySelectorAll('.view').forEach(v=>v.classList.remove('active'));
      byId('view-'+key).classList.add('active');
    });
  });
}

function setupPeriodButtons(){
  if(app.boundPeriods) return;
  app.boundPeriods = true;
  document.querySelectorAll('.btns button').forEach(b=>{
    b.addEventListener('click',()=>{
      document.querySelectorAll('.btns button').forEach(x=>x.classList.remove('active'));
      b.classList.add('active');
      drawTrendChart();
    });
  });
}

function exportData(){
  const report = {
    generated_at:new Date().toISOString(),
    composite_stress:CURRENT_DATA.composite,
    indicators:INDICATORS,
    valuations:VALUATIONS,
    note:'FRED-backed fields from data/fred_cache.json; others manual.'
  };
  const blob = new Blob([JSON.stringify(report,null,2)],{type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `economic-crash-radar-${Date.now()}.json`;
  a.click();
  URL.revokeObjectURL(url);
}

/* ===== Init ===== */

window.addEventListener('DOMContentLoaded', async () => {
  await loadLiveData();   // pull your real FRED-based values
  recalcAll();            // compute from what‚Äôs actually there
  setupTabs();
  setupPeriodButtons();
  byId('exportBtn').onclick = exportData;
  byId('refreshBtn').onclick = async () => {
    await loadLiveData();
    recalcAll();
  };
});
</script>
</body>
</html>
