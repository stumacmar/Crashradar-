<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="description" content="Advanced Economic Crash Radar with predictive analytics and multi-timeframe analysis" />
  <title>Economic Crash Radar Pro</title>

  <style>
    :root{
      --bg:#0a0e1a; --panel:#12182b; --panel-hover:#151d33; --muted:#8b96b0;
      --text:#e8eeff; --accent:#6b9eff; --accent-bright:#8fb4ff;
      --green:#1ec28b; --amber:#ffc247; --red:#ff6070; --orange:#ff8c42;
      --radius:14px; --shadow:0 4px 24px rgba(0,0,0,.3);
      --ring:200px; --ring-m:160px;
    }
    *{box-sizing:border-box}
    html,body{margin:0;background:var(--bg);color:var(--text);
      font:15px/1.6 -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Inter,Helvetica,Arial,sans-serif}

    .wrap{max-width:1400px;margin:0 auto;padding:20px 16px 80px}

    header{margin-bottom:24px}
    h1{font-size:clamp(32px,5vw,48px);line-height:1.1;margin:0 0 8px;
      background:linear-gradient(135deg,var(--text),var(--accent-bright));
      -webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
    .subtitle{color:var(--muted);font-size:15px;margin:8px 0}

    .card{background:var(--panel);border-radius:var(--radius);padding:24px;margin:20px 0;
      box-shadow:var(--shadow),0 0 0 1px rgba(255,255,255,.04) inset;transition:transform .2s,box-shadow .2s}
    .card:hover{transform:translateY(-2px);box-shadow:0 6px 32px rgba(0,0,0,.4)}
    .card-head{display:flex;justify-content:space-between;align-items:center;gap:12px;margin-bottom:8px}

    /* Gauge */
    .gauge-container{display:flex;align-items:center;gap:32px;flex-wrap:wrap}
    .gauge-wrap{position:relative;width:var(--ring);height:var(--ring)}
    .multi-ring{position:absolute;inset:0}
    .ring{position:absolute;border-radius:50%;transition:opacity .3s}
    .ring-outer{inset:0;background:conic-gradient(var(--green)0 108deg,var(--amber)108deg 216deg,var(--red)216deg 360deg);opacity:.3}
    .ring-mid{inset:15px;background:conic-gradient(var(--green)0 108deg,var(--amber)108deg 216deg,var(--red)216deg 360deg);opacity:.5}
    .ring-inner{inset:30px;background:conic-gradient(var(--green)0 108deg,var(--amber)108deg 216deg,var(--red)216deg 360deg)}
    .ring::after{content:"";position:absolute;inset:20px;border-radius:50%;background:var(--panel)}
    .needle{position:absolute;inset:0;transition:transform .6s cubic-bezier(.34,1.56,.64,1)}
    .needle::before{content:"";position:absolute;top:50%;left:50%;width:4px;height:45%;
      background:linear-gradient(180deg,var(--accent-bright),var(--accent));
      transform:translateX(-50%) translateY(-100%) rotate(var(--angle,0deg));
      transform-origin:bottom center;border-radius:4px;box-shadow:0 0 12px var(--accent)}
    .needle::after{content:"";position:absolute;top:50%;left:50%;width:16px;height:16px;background:var(--accent-bright);
      border-radius:50%;transform:translate(-50%,-50%);box-shadow:0 0 16px var(--accent),0 0 0 3px var(--panel)}
    .score{position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;font-weight:800;font-size:48px;line-height:1}
    .score-label{font-size:12px;font-weight:600;color:var(--muted);margin-top:4px;letter-spacing:.5px}

    .gauge-info h2{font-size:28px;margin:0 0 8px;font-weight:700}
    .confidence{display:inline-flex;align-items:center;gap:8px;background:rgba(107,158,255,.15);padding:6px 12px;border-radius:8px;font-size:13px;font-weight:600;margin-top:8px}
    .confidence-bar{width:60px;height:6px;background:rgba(255,255,255,.1);border-radius:3px;overflow:hidden}
    .confidence-fill{height:100%;background:var(--accent);border-radius:3px;transition:width .3s}

    .pills-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:12px}
    .pill{background:rgba(255,255,255,.03);border:1px solid rgba(255,255,255,.06);padding:14px 16px;border-radius:12px;transition:all .2s;cursor:pointer;position:relative}
    .pill:hover{background:rgba(255,255,255,.06);border-color:rgba(255,255,255,.12);transform:translateY(-2px)}
    .pill-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;gap:8px}
    .pill-title{font-weight:600;font-size:13px;display:flex;align-items:center;gap:6px}
    .pill-value{font-size:20px;font-weight:700;margin:4px 0}
    .pill-change{font-size:12px;color:var(--muted);display:flex;align-items:center;gap:4px}
    .pill-badge{font-size:11px;padding:3px 8px;border-radius:6px;font-weight:600}
    .badge-fresh{background:rgba(30,194,139,.15);color:var(--green)}
    .badge-stale{background:rgba(255,194,71,.15);color:var(--amber)}
    .badge-old{background:rgba(255,96,112,.15);color:var(--red)}

    .chart-container{position:relative;height:320px;margin:16px 0}
    .chart-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;flex-wrap:wrap;gap:12px}
    .chart-title{font-size:18px;font-weight:600;margin:0}
    .chart-controls{display:flex;gap:8px}
    .btn-group{display:flex;gap:4px;background:rgba(255,255,255,.03);padding:4px;border-radius:8px}
    .btn{background:transparent;border:none;color:var(--muted);padding:6px 14px;border-radius:6px;cursor:pointer;font-size:13px;font-weight:500;transition:all .2s}
    .btn:hover{color:var(--text);background:rgba(255,255,255,.06)}
    .btn.active{background:var(--accent);color:#fff}

    .tabs{display:flex;gap:8px;border-bottom:2px solid rgba(255,255,255,.06);margin-bottom:20px;overflow-x:auto}
    .tab{background:transparent;border:none;color:var(--muted);padding:12px 20px;cursor:pointer;font-size:14px;font-weight:600;position:relative;white-space:nowrap}
    .tab:hover{color:var(--text)}
    .tab.active{color:var(--accent-bright)}
    .tab.active::after{content:"";position:absolute;bottom:-2px;left:0;right:0;height:2px;background:var(--accent)}
    .tab-content{display:none}
    .tab-content.active{display:block}

    .heatmap{display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:10px}
    .heat-cell{background:rgba(255,255,255,.03);padding:14px;border-radius:10px;border:1px solid rgba(255,255,255,.06)}
    .heat-label{font-size:12px;color:var(--muted)}
    .heat-value{font-size:22px;font-weight:700}
    .bar{height:6px;border-radius:4px;background:rgba(255,255,255,.08);overflow:hidden;margin-top:8px}
    .bar > span{display:block;height:100%;border-radius:4px}

    @media (max-width:768px){
      .gauge-container{justify-content:center;text-align:center}
      .gauge-wrap{width:var(--ring-m);height:var(--ring-m)}
      .score{font-size:36px}
      .pills-grid{grid-template-columns:1fr}
      .chart-header{flex-direction:column;align-items:flex-start}
    }

    /* === NEW: explain UI bits (tiny, unobtrusive) === */
    .info-btn{
      display:inline-flex;align-items:center;gap:6px;
      font-size:12px;font-weight:600;color:var(--accent-bright);
      background:rgba(107,158,255,.12);padding:6px 10px;border-radius:8px;
      border:1px solid rgba(107,158,255,.25);cursor:pointer;white-space:nowrap
    }
    .info-note{margin-top:10px;border-radius:10px;padding:12px 14px;
      background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.08);
      color:var(--muted);font-size:13px;display:none}
    .info-note.show{display:block}
    .help-toggle{margin:4px 0 10px;font-size:13px;color:var(--accent-bright);cursor:pointer;text-decoration:underline}
    .micro-note{display:none;color:var(--muted);font-size:12px;margin-top:6px}
    body.help-on .micro-note{display:block}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>⚡ Economic Crash Radar Pro</h1>
      <div class="subtitle">Advanced multi-timeframe market stress analysis with predictive analytics</div>
      <div id="statusBadge"></div>
    </header>

    <main>
      <!-- Gauge -->
      <section class="card">
        <div class="gauge-container">
          <div class="gauge-wrap">
            <div class="multi-ring">
              <div class="ring ring-outer"></div>
              <div class="ring ring-mid"></div>
              <div class="ring ring-inner"></div>
            </div>
            <div id="needle" class="needle"></div>
            <div class="score"><div id="scoreText">--</div><div class="score-label">COMPOSITE</div></div>
          </div>

          <div class="gauge-info">
            <h2>Market Stress Index</h2>
            <div style="color:var(--muted);font-size:14px;margin-bottom:8px">
              Real-time composite of <span id="indicatorCount">8</span> economic indicators
            </div>
            <div class="confidence">
              <span>Confidence:</span>
              <div class="confidence-bar"><div id="confidenceFill" class="confidence-fill" style="width:85%"></div></div>
              <span id="confidenceText">85%</span>
            </div>
            <div id="regimeIndicator" class="regime"></div>
            <div class="prob-display" style="display:flex;gap:16px;margin-top:16px;flex-wrap:wrap">
              <div class="prob-item" style="flex:1;min-width:140px;background:rgba(255,255,255,.03);padding:12px;border-radius:10px;border:1px solid rgba(255,255,255,.06)">
                <h4 style="margin:0 0 4px;font-size:11px;color:var(--muted);letter-spacing:.5px;text-transform:uppercase">1-Month Risk</h4>
                <div class="prob-value" id="prob1m" style="font-size:24px;font-weight:700;color:var(--accent-bright)">--</div>
              </div>
              <div class="prob-item" style="flex:1;min-width:140px;background:rgba(255,255,255,.03);padding:12px;border-radius:10px;border:1px solid rgba(255,255,255,.06)">
                <h4 style="margin:0 0 4px;font-size:11px;color:var(--muted);letter-spacing:.5px;text-transform:uppercase">3-Month Risk</h4>
                <div class="prob-value" id="prob3m" style="font-size:24px;font-weight:700;color:var(--accent-bright)">--</div>
              </div>
              <div class="prob-item" style="flex:1;min-width:140px;background:rgba(255,255,255,.03);padding:12px;border-radius:10px;border:1px solid rgba(255,255,255,.06)">
                <h4 style="margin:0 0 4px;font-size:11px;color:var(--muted);letter-spacing:.5px;text-transform:uppercase">6-Month Risk</h4>
                <div class="prob-value" id="prob6m" style="font-size:24px;font-weight:700;color:var(--accent-bright)">--</div>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- Indicator Pills -->
      <section class="card">
        <div class="card-head">
          <h3 style="margin:0 0 16px;font-size:20px">📊 Live Indicators</h3>
        </div>
        <div id="kpiExplainToggle" class="help-toggle">Explain KPIs</div>
        <div id="pillsGrid" class="pills-grid"></div>
      </section>

      <!-- Tabs -->
      <div class="tabs">
        <button class="tab active" onclick="switchTab(event, 'composite')">Composite</button>
        <button class="tab" onclick="switchTab(event, 'scenarios')">Scenarios</button>
        <button class="tab" onclick="switchTab(event, 'indicators')">Indicators</button>
        <button class="tab" onclick="switchTab(event, 'analogs')">Analogs</button>
      </div>

      <div id="tab-composite" class="tab-content active">
        <section class="card">
          <div class="chart-header">
            <h3 class="chart-title">Composite Risk Score</h3>
            <div class="chart-controls">
              <div class="btn-group">
                <button class="btn active" data-tf="1m">1M</button>
                <button class="btn" data-tf="3m">3M</button>
                <button class="btn" data-tf="6m">6M</button>
                <button class="btn" data-tf="1y">1Y</button>
                <button class="btn" data-tf="all">ALL</button>
              </div>
            </div>
          </div>
          <div class="chart-container"><canvas id="compositeChart"></canvas></div>
        </section>

        <section class="card">
          <h3 style="margin:0 0 16px">Risk Decomposition</h3>
          <div class="chart-container"><canvas id="decompChart"></canvas></div>
        </section>
      </div>

      <div id="tab-scenarios" class="tab-content">
        <section class="card">
          <div class="card-head">
            <h3 style="margin:0 0 8px">Forward-Looking Scenarios</h3>
            <button class="info-btn" data-note-target="scenarios">ⓘ Explain</button>
          </div>
          <p style="color:var(--muted);margin:0 0 16px;font-size:14px">Probability-weighted forecasts</p>
          <div id="scenarioGrid" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:16px;margin-top:16px"></div>
          <div id="scenariosNote" class="info-note">
            Scenarios estimate the odds of three possible regimes—Base Case, Downside (Stress), and Upside (Relief).
            They come from how today’s indicators align with past stable or stressed periods.
            More “Downside” means conditions are tighter and turbulence risk is higher.
          </div>
        </section>

        <section class="card">
          <div class="card-head">
            <h3 style="margin:0 0 0">Risk Trajectory</h3>
            <button class="info-btn" data-note-target="trajectory">ⓘ Explain</button>
          </div>
          <div class="chart-container"><canvas id="trajectoryChart"></canvas></div>
          <div id="trajectoryNote" class="info-note">
            The trajectory projects the composite about 25 weeks ahead if current trends continue.
            The solid line is the central path; dashed lines show uncertainty.
            Up-sloping = pressure building; flat/down = stabilising.
          </div>
        </section>
      </div>

      <div id="tab-indicators" class="tab-content">
        <section class="card">
          <h3 style="margin:0 0 16px">Indicator Heat Map</h3>
          <div id="heatmap" class="heatmap"></div>
        </section>
      </div>

      <div id="tab-analogs" class="tab-content">
        <section class="card">
          <h3 style="margin:0 0 8px">Similar Historical Periods</h3>
          <p style="color:var(--muted);margin:0 0 16px;font-size:14px">Compared to past market regimes</p>
          <div id="analogList" class="analog-list"></div>
        </section>
      </div>
    </main>
  </div>

  <!-- Chart libs -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3.1.1/dist/chartjs-plugin-annotation.min.js"></script>

  <script>
    /* ===================== CONFIG ===================== */
    const FRED_CACHE_PATH = 'data/fred_cache.json';

    const INDICATORS = {
      T10Y3M:          { label:'Yield Curve',         format:v=>v?.toFixed(2),               weight:0.18, cadence:'daily',   tip:'10y–3m Treasury spread. Inversions (≤0) often precede recessions.' },
      CREDIT:          { label:'Credit Spread',       format:v=>v?.toFixed(2),               weight:0.14, cadence:'daily',   tip:'Corporate vs Treasury yields. Wider = tighter financing conditions.' },
      UN_SLOPE6:       { label:'Unemployment Δ',      format:v=>v?.toFixed(2),               weight:0.12, cadence:'monthly', tip:'Six-month change in unemployment. Rising = labour softening.' },
      DD_12M:          { label:'Market Drawdown',     format:v=>((v??0)*100).toFixed(1)+'%', weight:0.20, cadence:'daily',   tip:'S&P vs its 12-month peak. Negative means below the recent high.' },
      NFCI:            { label:'Financial Conditions',format:v=>v?.toFixed(3),               weight:0.12, cadence:'weekly',  tip:'NFCI combines rates, credit, and liquidity tightness.' },
      VIX_PROXY:       { label:'Volatility Index',    format:v=>v?.toFixed(1),               weight:0.10, cadence:'daily',   tip:'Implied S&P 500 volatility (VIX). Higher = more stress.' },
      RETAIL_MOMENTUM: { label:'Retail Sales Δ',      format:v=>(v*100)?.toFixed(2)+'%',     weight:0.08, cadence:'monthly', tip:'Latest month-over-month change in retail sales.' },
      SENTIMENT:       { label:'Consumer Confidence', format:v=>v?.toFixed(1),               weight:0.06, cadence:'monthly', tip:'Survey-based household confidence; higher = more optimistic.' }
    };

    const clamp = x => Math.max(0, Math.min(100, x));
    const map01 = (val, good, bad) => {
      if (val == null) return 50;
      const denom = bad - good;
      if (Math.abs(denom) < 1e-9) return 50;
      return ((val - good) / denom) * 100;
    };
    const SCALE = {
      T10Y3M:          v => clamp(map01(v,  1.0, -2.0)),
      CREDIT:          v => clamp(map01(v,  0.30, 1.00)),
      UN_SLOPE6:       v => clamp(map01(v,  0.05, 0.50)),
      DD_12M:          v => clamp(map01(v,  0.00, -0.20)),
      NFCI:            v => clamp(map01(v, -0.80, 0.40)),
      VIX_PROXY:       v => clamp(map01(v,  12,  35)),
      RETAIL_MOMENTUM: v => clamp(map01(v,  0.03, -0.02)),
      SENTIMENT:       v => clamp(map01(v, 110,  70))
    };
    const FRESH_LIMITS = { daily:{ok:7,warn:30}, weekly:{ok:7,warn:30}, monthly:{ok:30,warn:60} };
    const zoneOf = s => s <= 30 ? 'green' : (s <= 60 ? 'amber' : 'red');

    /* ===================== CACHE LOADING ===================== */
    async function loadFredCache(){
      const res = await fetch(`${FRED_CACHE_PATH}?t=${Date.now()}`, { cache:'no-store' });
      if(!res.ok) throw new Error(`FRED cache: HTTP ${res.status}`);
      const raw = await res.json();
      return normalizeCache(raw);
    }

    function normalizeCache(raw){
      const out = {};
      const directLike = raw && typeof raw === 'object' &&
        Object.keys(raw).some(k => raw[k] && Array.isArray(raw[k].observations));
      if (directLike) {
        for (const [k,v] of Object.entries(raw)) out[k] = v;
        return out;
      }
      if (Array.isArray(raw?.series)) {
        for (const item of raw.series) {
          const id = item?.id || item?.series_id || item?.name;
          if (!id) continue;
          const obs = Array.isArray(item.observations) ? item.observations
                    : Array.isArray(item.data) ? item.data : [];
          out[id] = { observations: obs, fetchedAt: item.fetchedAt };
        }
        return out;
      }
      if (raw && raw.series && typeof raw.series === 'object' && !Array.isArray(raw.series)) {
        for (const [id,item] of Object.entries(raw.series)) {
          const obs = Array.isArray(item?.observations) ? item.observations
                    : Array.isArray(item?.data) ? item.data : [];
          out[id] = { observations: obs, fetchedAt: item.fetchedAt };
        }
        return out;
      }
      if (Array.isArray(raw)) {
        for (const item of raw) {
          const id = item?.id || item?.series_id || item?.name;
          if (!id) continue;
          const obs = Array.isArray(item.observations) ? item.observations
                    : Array.isArray(item.data) ? item.data : [];
          out[id] = { observations: obs, fetchedAt: item.fetchedAt };
        }
      }
      return out;
    }

    function latest(series){
      const obs = series?.observations||[];
      if(!obs.length) return null;
      const o = obs[obs.length-1];
      const v = (o.value==null || o.value==='.' || o.value==='NaN') ? null : +o.value;
      return {value:v, date:o.date};
    }
    function seriesAgeDays(series, fetchedAt){
      const L = latest(series);
      if(!L) return Infinity;
      const d = new Date(L.date + 'T00:00:00Z');
      return Math.max(0, Math.round((new Date(fetchedAt || Date.now()) - d) / 86400000));
    }
    function freshnessPenalty(days, cadence){
      const lim = FRESH_LIMITS[cadence] || FRESH_LIMITS.daily;
      if(days<=lim.ok) return 1.00;
      if(days<=lim.warn) return 0.85;
      return 0.70;
    }

    // Derivations
    function deriveUnempSlope6(UNRATE){
      const obs = UNRATE?.observations||[];
      if(!obs.length) return null;
      const byMonth = {};
      for(const o of obs){ byMonth[o.date.slice(0,7)] = +o.value; }
      const months = Object.keys(byMonth).sort();
      if(months.length<7) return null;
      const out = [];
      for(let i=6;i<months.length;i++){
        const m = months[i], prev = months[i-6];
        const delta = byMonth[m] - byMonth[prev];
        const [yy,mm] = m.split('-').map(Number);
        const d = new Date(Date.UTC(yy, mm, 0));
        out.push({date: d.toISOString().slice(0,10), value: String(delta)});
      }
      return { observations: out, fetchedAt: UNRATE.fetchedAt };
    }
    function deriveDrawdown12m(SP500){
      const obs = SP500?.observations||[];
      if(!obs.length) return null;
      const dates = obs.map(o=>o.date), vals = obs.map(o=>+o.value);
      const peak = [];
      for(let i=0;i<vals.length;i++){
        const start = Math.max(0, i-252);
        let p = -Infinity;
        for(let j=start;j<=i;j++) p = Math.max(p, vals[j]);
        peak.push(p);
      }
      const dd = dates.map((d,i)=>({date:d, value:String(vals[i]/peak[i]-1)}));
      return { observations: dd, fetchedAt: SP500.fetchedAt };
    }
    function deriveRetailMomentum(RSAFS){
      const o = RSAFS?.observations||[];
      if(o.length<2) return null;
      const last = +o[o.length-1].value;
      let prev = null;
      for(let i=o.length-2;i>=0;i--){ const v = +o[i].value; if(isFinite(v)){ prev=v; break; } }
      if(prev==null || prev===0) return null;
      return { observations:[{date:o[o.length-1].date, value:String(last/prev-1)}], fetchedAt: RSAFS.fetchedAt };
    }

    function mapIndicatorsFromCache(cache){
      const out = {};
      for(const k of Object.keys(INDICATORS)){ if(cache[k]) out[k]=cache[k]; }
      if(!out.CREDIT && (cache.BAMLH0A0HYM2 || cache.BAA10YM)) out.CREDIT = cache.BAMLH0A0HYM2 || cache.BAA10YM;
      if(!out.VIX_PROXY && cache.VIXCLS) out.VIX_PROXY = cache.VIXCLS;
      if(!out.SENTIMENT && cache.UMCSENT) out.SENTIMENT = cache.UMCSENT;

      if(!out.UN_SLOPE6 && cache.UNRATE){ out.UN_SLOPE6 = deriveUnempSlope6(cache.UNRATE) || {observations:[],fetchedAt:cache.UNRATE.fetchedAt}; }
      if(!out.DD_12M   && cache.SP500 ){ out.DD_12M   = deriveDrawdown12m(cache.SP500 ) || {observations:[],fetchedAt:cache.SP500.fetchedAt}; }
      if(!out.RETAIL_MOMENTUM && cache.RSAFS){ out.RETAIL_MOMENTUM = deriveRetailMomentum(cache.RSAFS) || {observations:[],fetchedAt:cache.RSAFS.fetchedAt}; }
      return out;
    }

    /* ======= RISK MODELS ======= */
    function logistic(x){ return 1/(1+Math.exp(-x)); }
    function horizonRisk(composite, months){
      const base = logistic((composite-50)/10);
      const mult = months<=1 ? 0.7 : months<=3 ? 1.0 : 1.25;
      const p = clamp(100 * base * mult);
      return Math.round(Math.min(95, Math.max(5, p)));
    }
    const zoneLabel = z => z==='green'?'Normal':z==='amber'?'Stressed':'Crisis';

    /* ===================== STATE / CHART HANDLES ===================== */
    let STATE = {
      dataMap:null,
      compositeHistory:[],   // [{date, value}]
      tf:'1m',
      charts:{ composite:null, decomp:null, traj:null }
    };

    function timeframeSpan(tf){
      const day = 1, mo=30, yr=365;
      return tf==='1m'? 1*mo : tf==='3m'? 3*mo : tf==='6m'? 6*mo : tf==='1y'? yr : Infinity;
    }

    /* ===================== UI HELPERS ===================== */
    const els = {
      statusBadge:  document.getElementById('statusBadge'),
      scoreText:    document.getElementById('scoreText'),
      needle:       document.getElementById('needle'),
      indicatorCount: document.getElementById('indicatorCount'),
      regimeIndicator: document.getElementById('regimeIndicator'),
      prob1m: document.getElementById('prob1m'),
      prob3m: document.getElementById('prob3m'),
      prob6m: document.getElementById('prob6m'),
      pillsGrid: document.getElementById('pillsGrid'),
      heatmap: document.getElementById('heatmap'),
      scenarioGrid: document.getElementById('scenarioGrid'),
      kpiExplainToggle: document.getElementById('kpiExplainToggle')
    };
    function setStatus(zone, text){
      const colors = {green:'#1ec28b', amber:'#ffc247', red:'#ff6070'};
      els.statusBadge.innerHTML = `
        <div class="status" style="background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.08)">
          <span class="status-dot" style="background:${colors[zone]||'#8fb4ff'}"></span>
          <span>${text}</span>
        </div>`;
    }
    function setErrorStatus(errText){
      els.statusBadge.innerHTML = `
        <div class="status" style="background:rgba(255,96,112,.12);border:1px solid rgba(255,96,112,.4)">
          <span class="status-dot" style="background:#ff6070"></span>
          <span>Data error: ${errText}</span>
        </div>`;
    }
    function setGauge(score){
      els.scoreText.textContent = Math.round(score);
      const angle = (score/100)*360;
      els.needle.style.setProperty('--angle', angle+'deg');
    }
    function pillHTML({key,label,valueDisp,change,freshClass,freshTxt,tip}){
      const arrow = change==null?'' : (change>0?'▲':'▼');
      const changeTxt = change==null?'' : `${(change>0?'+':'')}${change.toFixed(2)}`;
      return `
        <div class="pill" data-key="${key}">
          <div class="pill-header">
            <div class="pill-title">${label}</div>
            <div class="pill-badge ${freshClass}">${freshTxt}</div>
          </div>
          <div class="pill-value">${valueDisp}</div>
          <div class="pill-change"><span class="trend-arrow">${arrow}</span>${changeTxt}</div>
          <div class="micro-note">${tip||''}</div>
        </div>`;
    }

    function mkLine(ctx, labels, data){
      return new Chart(ctx, {
        type:'line',
        data:{ labels, datasets:[{label:'Composite', data, borderWidth:2, fill:false, tension:0.25}] },
        options:{ responsive:true, plugins:{legend:{display:false}}, scales:{x:{display:false}, y:{min:0,max:100}} }
      });
    }
    function mkBar(ctx, labels, data){
      return new Chart(ctx, {
        type:'bar',
        data:{ labels, datasets:[{label:'Contribution', data, borderWidth:1}] },
        options:{ responsive:true, plugins:{legend:{display:false}}, scales:{y:{beginAtZero:true,max:Math.max(10,Math.ceil(Math.max(...data,10)/10)*10)}} }
      });
    }

    function renderCompositeChart(){
      const span = timeframeSpan(STATE.tf);
      const hist = STATE.compositeHistory;
      const last = span===Infinity ? hist : hist.slice(-span);
      const labels = last.map(d=>d.date);
      const data = last.map(d=>d.value);
      if(STATE.charts.composite) STATE.charts.composite.destroy();
      STATE.charts.composite = mkLine(document.getElementById('compositeChart'), labels, data);
    }

    function renderDecomp(parts){
      const labels = parts.map(p=>p.label);
      const contrib = parts.map(p=>+(p.scaled*p.w).toFixed(1));
      if(STATE.charts.decomp) STATE.charts.decomp.destroy();
      STATE.charts.decomp = mkBar(document.getElementById('decompChart'), labels, contrib);
    }

    function heatColor(score){
      const r = Math.round(255 * (score/100));
      const g = Math.round(200 * (1-score/100));
      return `rgb(${r},${g},80)`;
    }

    function renderHeatmap(parts){
      els.heatmap.innerHTML = parts.map(p=>{
        const c = heatColor(p.scaled);
        return `<div class="heat-cell">
          <div class="heat-label">${p.label}</div>
          <div class="heat-value">${p.valueDisp}</div>
          <div class="bar"><span style="width:${p.scaled}%;background:${c}"></span></div>
        </div>`;
      }).join('');
    }

    function renderScenarios(composite, breadth){
      const stress = composite/100;
      const riskBias = (breadth-50)/50; // <0 better, >0 worse
      const baseProb = 60 - 20*riskBias;                 // ~40-80
      const downProb = Math.min(40, 20 + 40*stress);     // capped
      const upProb = Math.max(5, 100 - baseProb - downProb);

      const cards = [
        {title:'Base Case', prob:Math.round(baseProb), desc:'Sideways-to-mildly volatile regime; conditions stabilise with modest dispersion.'},
        {title:'Downside (Stress)', prob:Math.round(downProb), desc:'Tighter financial conditions and volatility spikes; drawdowns concentrated in cyclicals.'},
        {title:'Upside (Relief)', prob:Math.round(upProb), desc:'Soft-landing drift; risk appetite improves as macro prints surprise positively.'}
      ];
      els.scenarioGrid.innerHTML = cards.map(c=>`
        <div class="scenario-card" style="background:rgba(255,255,255,.03);padding:16px;border-radius:12px;border:1px solid rgba(255,255,255,.06)">
          <div class="scenario-header" style="display:flex;justify-content:space-between;align-items:center">
            <div class="scenario-title" style="font-weight:600">${c.title}</div>
            <div class="scenario-prob" style="font-size:22px;font-weight:700;color:var(--accent-bright)">${c.prob}%</div>
          </div>
          <div class="scenario-desc" style="color:var(--muted);font-size:13px">${c.desc}</div>
        </div>
      `).join('');
    }

    function renderTrajectory(composite){
      const steps = 26; // ~26 weeks
      const phi = 0.85; // persistence
      const target = 50;
      let v = composite;
      const labels = [];
      const path = [];
      const upper = [];
      const lower = [];
      for(let i=1;i<=steps;i++){
        v = phi*v + (1-phi)*target;
        labels.push(`W+${i}`);
        path.push(+v.toFixed(1));
        const band = 6*Math.sqrt(i/steps); // widening band
        upper.push(Math.min(100, +(v+band).toFixed(1)));
        lower.push(Math.max(0,   +(v-band).toFixed(1)));
      }
      if(STATE.charts.traj) STATE.charts.traj.destroy();
      STATE.charts.traj = new Chart(document.getElementById('trajectoryChart'),{
        type:'line',
        data:{labels,
          datasets:[
            {label:'Projected', data:path, borderWidth:2, fill:false, tension:0.25},
            {label:'Upper', data:upper, borderWidth:1, fill:false, borderDash:[4,4]},
            {label:'Lower', data:lower, borderWidth:1, fill:false, borderDash:[4,4]}
          ]},
        options:{responsive:true, plugins:{legend:{display:false}}, scales:{y:{min:0,max:100}}}
      });
    }

    /* ===================== MAIN ===================== */
    (async function init(){
      try{
        // Load + map indicators
        const cache = await loadFredCache();
        const dataMap = mapIndicatorsFromCache(cache);
        STATE.dataMap = dataMap;

        // ===== build pills + composite =====
        let num=0, den=0;
        const parts=[];
        for(const [k,cfg] of Object.entries(INDICATORS)){
          const s = dataMap[k];
          const obs = s?.observations||[];
          if(!obs.length) continue;
          const last = obs[obs.length-1];
          const L = {value:+last.value, date:last.date};
          const days = seriesAgeDays(s, s.fetchedAt);
          const lim = FRESH_LIMITS[cfg.cadence]||FRESH_LIMITS.daily;
          const badge = days<=lim.ok ? {cls:'badge-fresh',txt:'Fresh'} : days<=lim.warn ? {cls:'badge-stale',txt:'Stale'} : {cls:'badge-old',txt:'Old'};
          const scaled = SCALE[k](L.value);
          const w = cfg.weight * freshnessPenalty(days, cfg.cadence);
          if(Number.isFinite(scaled) && Number.isFinite(w)){ num += scaled*w; den += w; }

          let change = null;
          if(obs.length>=2){ const a=+obs[obs.length-1].value, b=+obs[obs.length-2].value; if(isFinite(a)&&isFinite(b)) change=a-b; }

          parts.push({ key:k, label:cfg.label, valueDisp: cfg.format?.(L.value) ?? L.value, change, freshClass:badge.cls, freshTxt:badge.txt, scaled, w, obs, tip:cfg.tip });
        }

        if(den<=0) throw new Error('No valid indicators / weights.');
        const composite = num/den;
        setGauge(composite);
        const zone = zoneOf(composite);
        setStatus(zone, `Composite: ${Math.round(composite)} (${zone.toUpperCase()})`);
        document.getElementById('indicatorCount').textContent = parts.length;
        els.pillsGrid.innerHTML = parts.map(p=>pillHTML(p)).join('');

        // ===== build composite history (synchronised by date)
        const keysForHist = ['DD_12M','VIX_PROXY','T10Y3M','CREDIT','NFCI'];
        const allDates = new Set();
        for(const k of keysForHist){ (dataMap[k]?.observations||[]).forEach(o=>allDates.add(o.date)); }
        const dates = Array.from(allDates).sort();

        STATE.compositeHistory = dates.map(date=>{
          let n=0,d=0;
          for(const [k,cfg] of Object.entries(INDICATORS)){
            const s = dataMap[k]; if(!s) continue;
            const obs = s.observations;
            let v=null;
            for(let i=obs.length-1;i>=0;i--){ if(obs[i].date<=date){ const vv=+obs[i].value; if(isFinite(vv)) v=vv; break; } }
            if(v==null) continue;
            const sc = SCALE[k](v); n+=sc*cfg.weight; d+=cfg.weight;
          }
          return {date, value: d>0 ? +(n/d).toFixed(1) : null};
        }).filter(x=>x.value!=null);

        // Initial charts
        renderCompositeChart();
        renderDecomp(parts);
        renderHeatmap(parts);
        renderScenarios(composite, parts.reduce((a,p)=>a+p.scaled,0)/parts.length);
        renderTrajectory(composite);

        // Probabilities (consistent with composite)
        els.prob1m.textContent = `${horizonRisk(composite,1)}%`;
        els.prob3m.textContent = `${horizonRisk(composite,3)}%`;
        els.prob6m.textContent = `${horizonRisk(composite,6)}%`;
        els.regimeIndicator.innerHTML =
          `<span class="status-dot" style="background:${zone==='green'?'#1ec28b':zone==='amber'?'#ffc247':'#ff6070'}"></span>${zoneLabel(zone)} regime`;

        // ===== Tab / timeframe handlers =====
        window.switchTab = (e, id)=>{
          document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
          e.currentTarget.classList.add('active');
          document.querySelectorAll('.tab-content').forEach(x=>x.classList.remove('active'));
          document.getElementById('tab-'+id).classList.add('active');
        };

        document.querySelectorAll('.btn-group .btn').forEach(btn=>{
          btn.addEventListener('click', (evt)=>{
            document.querySelectorAll('.btn-group .btn').forEach(b=>b.classList.remove('active'));
            evt.currentTarget.classList.add('active');
            STATE.tf = evt.currentTarget.dataset.tf;
            renderCompositeChart();
          });
        });

        // ===== Explain buttons for scenarios/trajectory
        document.querySelectorAll('.info-btn').forEach(btn=>{
          btn.addEventListener('click', ()=>{
            const t = btn.getAttribute('data-note-target');
            const el = document.getElementById(t==='scenarios'?'scenariosNote':'trajectoryNote');
            if(el) el.classList.toggle('show');
          });
        });

        // ===== KPI explain toggle (micro-notes under pills)
        const key = 'helpMode';
        const saved = localStorage.getItem(key);
        if(saved==='on'){ document.body.classList.add('help-on'); }
        els.kpiExplainToggle.addEventListener('click', ()=>{
          document.body.classList.toggle('help-on');
          localStorage.setItem(key, document.body.classList.contains('help-on')?'on':'off');
        });

      }catch(err){
        console.error(err);
        setErrorStatus(err.message||'FRED cache error');
      }
    })();
  </script>
</body>
</html>
