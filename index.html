<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Economic Crash Radar Pro</title>
<style>
:root{
  --bg:#0a0e1a; --panel:#12182b; --panel-hover:#151d33; --text:#e8eeff; 
  --muted:#a5b4cf; /* FIXED contrast */
  --accent:#6b9eff; --accent-bright:#8fb4ff; --green:#1ec28b; --amber:#ffc247; --red:#ff6070;
  --purple:#a78bfa; --cyan:#22d3ee;
  /* Design tokens */
  --space-xs:4px; --space-sm:8px; --space-md:16px; --space-lg:24px; --space-xl:32px;
  --radius-sm:8px; --radius-md:12px; --radius-lg:16px;
}
*{box-sizing:border-box;margin:0;padding:0}
body{background:var(--bg);color:var(--text);font:15px/1.6 -apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;-webkit-font-smoothing:antialiased}
.wrap{max-width:1600px;margin:0 auto;padding:24px 16px 80px}

/* Responsive typography */
h1{
  font-size:clamp(28px,5vw,54px);
  line-height:1.1;
  font-weight:800;
  margin-bottom:8px;
  background:linear-gradient(135deg,var(--text),var(--accent-bright));
  -webkit-background-clip:text;
  -webkit-text-fill-color:transparent;
  letter-spacing:-.02em;
  word-break:break-word;
}
.subtitle{color:var(--muted);font-weight:600;font-size:clamp(13px,2vw,15px)}

/* Header */
.header{
  display:flex;justify-content:space-between;align-items:flex-start;gap:16px;flex-wrap:wrap;margin-bottom:18px;
}

/* Focus indicators */
:focus-visible { outline:2px solid var(--accent); outline-offset:2px; }

.badges{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
.badge{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border:1px solid rgba(255,255,255,.08);background:rgba(255,255,255,.04);border-radius:var(--radius-md);font-weight:700;font-size:clamp(10px,1.5vw,12px)}
.live-dot{width:8px;height:8px;border-radius:50%;background:var(--green);box-shadow:0 0 10px var(--green);animation:pulse 2s infinite}

/* Pulse animation */
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.6}}

/* Buttons */
.btn{
  display:inline-flex;align-items:center;gap:8px;padding:10px 16px;border:none;border-radius:var(--radius-md);
  background:var(--accent);color:#fff;font-weight:700;cursor:pointer;transition:all 0.2s ease;position:relative;overflow:hidden;
}
.btn:hover{background:var(--accent-bright);transform:translateY(-1px)}
.btn:active{transform:translateY(0)}
.btn:disabled{opacity:0.5;cursor:not-allowed}

/* Spinner */
.spinner{
  width:20px;height:20px;border:3px solid rgba(255,255,255,.3);border-top-color:#fff;border-radius:50%;
  animation:spin 0.8s linear infinite;
}
@keyframes spin{to{transform:rotate(360deg)}}

/* Card */
.card{
  background:var(--panel);border:1px solid rgba(255,255,255,.06);border-radius:var(--radius-lg);
  padding:var(--space-lg);margin:18px 0;box-shadow:0 4px 24px rgba(0,0,0,.3);
  transition:all 0.3s cubic-bezier(0.4,0,0.2,1);
}
.card:hover{box-shadow:0 8px 32px rgba(0,0,0,.4);transform:translateY(-2px)}

/* Skeleton */
.skeleton{
  background:linear-gradient(90deg,rgba(255,255,255,0.05) 25%,rgba(255,255,255,0.1) 50%,rgba(255,255,255,0.05) 75%);
  background-size:200% 100%;animation:loading 1.5s infinite;border-radius:var(--radius-sm);
}
@keyframes loading{0%{background-position:200% 0}100%{background-position:-200% 0}}
.skeleton-title{height:24px;width:40%;margin-bottom:16px}
.skeleton-chart{height:300px;width:100%}

/* Error/Empty */
.error-state{text-align:center;padding:var(--space-xl);color:var(--red)}
.error-state button{margin-top:var(--space-md)}
.empty-state{text-align:center;padding:var(--space-xl);color:var(--muted)}
.empty-state .icon{font-size:48px;margin-bottom:var(--space-md)}

.status-pill{display:inline-flex;align-items:center;gap:10px;padding:10px 16px;border:1px solid rgba(255,255,255,.1);border-radius:var(--radius-md);background:rgba(255,255,255,.04);font-weight:700}
.alert{border-radius:var(--radius-lg);padding:18px;margin-top:14px;background:linear-gradient(135deg,rgba(255,96,112,.12),rgba(255,194,71,.12));border:1px solid rgba(255,96,112,.25)}

/* Tabs */
.tabs{
  display:flex;gap:8px;border-bottom:2px solid rgba(255,255,255,.06);margin-top:8px;overflow-x:auto;-webkit-overflow-scrolling:touch;scrollbar-width:thin;
}
.tabs::-webkit-scrollbar{height:4px}
.tabs::-webkit-scrollbar-thumb{background:var(--accent);border-radius:2px}
.tab{
  background:transparent;border:none;color:var(--muted);padding:12px 18px;font-weight:800;cursor:pointer;border-radius:8px 8px 0 0;transition:all 0.2s ease;white-space:nowrap;flex-shrink:0;
}
.tab.active{color:var(--accent-bright);background:rgba(255,255,255,.03)}
.tab:hover:not(.active){color:var(--text);background:rgba(255,255,255,.02)}

/* Views */
.view{display:none;animation:slideIn 0.3s ease-out}
.view.active{display:block}
@keyframes slideIn{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}

/* Gauge */
.gauge{display:flex;gap:36px;align-items:center;flex-wrap:wrap}
.gauge-wrap{position:relative;width:220px;height:220px}
.ring{position:absolute;inset:0;border-radius:50%;background:conic-gradient(var(--green) 0 108deg,var(--amber)108deg 216deg,var(--red)216deg 360deg);opacity:.35}
.ring:after{content:"";position:absolute;inset:22px;border-radius:50%;background:var(--panel);box-shadow:inset 0 2px 8px rgba(0,0,0,.35)}
.needle{position:absolute;inset:0}
.needle:before{content:"";position:absolute;top:50%;left:50%;width:6px;height:48%;transform-origin:bottom center;transform:translate(-50%,-100%) rotate(var(--angle,0deg));background:linear-gradient(180deg,var(--accent-bright),var(--accent));border-radius:6px 6px 0 0;box-shadow:0 0 10px var(--accent);transition:transform 1s ease}
.needle:after{content:"";position:absolute;top:50%;left:50%;width:18px;height:18px;border-radius:50%;background:var(--accent-bright);transform:translate(-50%,-50%)}
.score{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;flex-direction:column;font-weight:800;z-index:1}
.score .v{font-size:56px;background:linear-gradient(135deg,var(--text),var(--accent-bright));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.score .l{font-size:11px;color:var(--muted);letter-spacing:1px;margin-top:4px}

/* KPI grid */
.kpi-grid{display:grid;grid-template-columns:1fr;gap:12px}
.kpi{
  border:1px solid rgba(255,255,255,.06);border-radius:var(--radius-md);padding:16px;background:rgba(255,255,255,.03);
  transition:all 0.2s ease;cursor:pointer;
}
.kpi:hover{border-color:rgba(255,255,255,.1);background:rgba(255,255,255,.05)}
.kpi h4{display:flex;align-items:center;justify-content:space-between;font-size:14px;margin-bottom:6px}
.dot{width:10px;height:10px;border-radius:50%}
.dot.g{background:var(--green);box-shadow:0 0 8px var(--green)}
.dot.a{background:var(--amber);box-shadow:0 0 8px var(--amber)}
.dot.r{background:var(--red);box-shadow:0 0 8px var(--red)}
.small{font-size:12px;color:var(--muted);font-weight:600}
.kpi .val{font-size:28px;font-weight:800;margin:8px 0}
.b-fresh{color:var(--green);border-color:rgba(30,194,139,.35);background:rgba(30,194,139,.15)}
.b-stale{color:var(--amber);border-color:rgba(255,194,71,.5);background:rgba(255,194,71,.15)}
.toggle-desc{cursor:pointer;font-size:12px;color:var(--accent-bright);transition:color 0.2s ease;user-select:none}
.toggle-desc:hover{color:var(--accent-bright)}
.desc{display:none;font-size:12px;color:var(--muted);margin-top:6px;line-height:1.5}
.show .desc{display:block}

/* Period buttons */
.btns{display:flex;gap:6px;background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.06);padding:4px;border-radius:var(--radius-md)}
.btns button{background:transparent;border:none;color:var(--muted);padding:6px 10px;border-radius:8px;font-weight:700;cursor:pointer;transition:all 0.2s ease}
.btns button.active{background:var(--accent);color:#fff}
.btns button:hover:not(.active){background:rgba(255,255,255,.05);color:var(--text)}

.chart{position:relative;height:360px;margin-top:12px}
.heat{display:grid;grid-template-columns:1fr;gap:12px}
.cell{border:1px solid rgba(255,255,255,.06);border-radius:var(--radius-md);padding:14px;background:rgba(255,255,255,.03);transition:all 0.2s ease}
.cell:hover{border-color:rgba(255,255,255,.1);background:rgba(255,255,255,.05)}
.bar{height:8px;border-radius:6px;background:rgba(255,255,255,.06);overflow:hidden;margin-top:8px}
.bar>span{display:block;height:100%;transition:width 0.5s ease}
.radar-chart{height:320px;margin-top:20px}
.risk-meter{display:flex;align-items:center;gap:12px;margin-top:8px}
.risk-level{width:100%;height:8px;border-radius:4px;background:rgba(255,255,255,.1);overflow:hidden}
.risk-level>div{height:100%;transition:width 0.5s ease}
.risk-labels{display:flex;justify-content:space-between;margin-top:4px}
.risk-labels span{font-size:10px;color:var(--muted)}
.insight-card{background:linear-gradient(135deg, rgba(107,158,255,.1), rgba(139,187,255,.05));border:1px solid rgba(107,158,255,.2);border-radius:var(--radius-md);padding:16px;margin-top:16px}
.insight-card h4{display:flex;align-items:center;gap:8px;margin-bottom:8px;color:var(--accent-bright)}
.loading{display:flex;flex-direction:column;justify-content:center;align-items:center;height:200px;font-size:16px;color:var(--muted);gap:16px}

/* Breakpoints */
@media (min-width:640px){
  .kpi-grid{grid-template-columns:repeat(2,1fr)}
  .heat{grid-template-columns:repeat(2,1fr)}
  .gauge{flex-direction:row}
}
@media (min-width:1024px){
  .kpi-grid{grid-template-columns:repeat(3,1fr)}
  .heat{grid-template-columns:repeat(3,1fr)}
}
@media (min-width:1280px){
  .kpi-grid{grid-template-columns:repeat(auto-fill,minmax(260px,1fr))}
  .heat{grid-template-columns:repeat(auto-fill,minmax(180px,1fr))}
}
@media (max-width:640px){
  h1{font-size:28px;margin-bottom:12px}
  .subtitle{font-size:13px}
  .header{flex-direction:column;align-items:stretch}
  .header>div:last-child{display:flex;flex-direction:column;gap:8px}
  .btn{width:100%;justify-content:center}
  .gauge{flex-direction:column;align-items:center}
  .chart{height:280px}
}
</style>
</head>
<body>
<div class="wrap">
  <header role="banner">
    <div class="header">
      <div>
        <h1><span aria-hidden="true">‚ö°</span> Economic Crash Radar Pro</h1>
        <p class="subtitle" role="doc-subtitle">World-class institutional analytics (FRED-only)</p>
      </div>
      <div>
        <button class="btn" id="refreshBtn" aria-label="Refresh dashboard data">
          <span aria-hidden="true">üîÑ</span> Refresh
        </button>
        <button class="btn" id="exportBtn" aria-label="Export report as JSON">
          <span aria-hidden="true">üì•</span> Export Report
        </button>
      </div>
    </div>

    <div class="badges">
      <div class="badge" aria-live="polite"><span class="live-dot"></span> Live Data</div>
      <div class="badge" id="upd" aria-live="polite">Last Update: --</div>
      <div class="badge" id="qual">Quality: --</div>
      <div class="badge" id="indicatorsCount">Indicators: --/10</div>
    </div>

    <div class="status-pill" id="regime" role="status" aria-live="polite">--</div>
    <div class="card" id="auditBox" style="display:none;padding:12px;border:1px dashed rgba(255,96,112,.4);background:rgba(255,96,112,.06);border-radius:12px;margin-top:10px">
      <div style="font-weight:700;margin-bottom:4px">Data audit</div>
      <div class="small" id="auditMsg">Checking required series‚Ä¶</div>
    </div>
    <div class="alert" id="alert" style="display:none" role="alert" aria-live="assertive"></div>
  </header>

  <main role="main">
    <div class="card">
      <div class="gauge">
        <div class="gauge-wrap" role="img" aria-label="Market stress gauge">
          <div class="ring"></div>
          <div class="needle" id="needle"></div>
          <div class="score" aria-live="polite">
            <div class="v" id="scoreV" aria-atomic="true">--</div>
            <div class="l">COMPOSITE STRESS</div>
          </div>
        </div>
        <div style="flex:1;min-width:280px">
          <h2 style="margin:0 0 6px">Market Stress Index</h2>
          <div class="small" id="partsNote">Composite derived from 0 indicators</div>

          <div style="margin-top:10px;display:flex;align-items:center;gap:10px" class="badge">
            <span>Data Quality</span>
            <div style="width:90px;height:8px;background:rgba(255,255,255,.1);border-radius:4px;overflow:hidden">
              <div id="qfill" style="height:100%;background:linear-gradient(90deg,#4a7fe8,var(--accent-bright));width:0%;transition:width 0.5s ease"></div>
            </div>
            <strong id="qtxt" aria-live="polite">--</strong>
          </div>

          <div class="risk-meter">
            <span class="small">Risk Level:</span>
            <div class="risk-level" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
              <div id="riskFill" style="width:0%;background:linear-gradient(90deg,var(--green),var(--amber),var(--red))"></div>
            </div>
          </div>
          <div class="risk-labels" aria-hidden="true">
            <span>Low</span><span>Medium</span><span>High</span><span>Critical</span>
          </div>

          <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:10px;margin-top:12px">
            <div class="kpi"><div class="small">1-Month Risk</div><div class="val" id="r1m">--</div><div class="small" id="m1dir">‚Üí Momentum</div></div>
            <div class="kpi"><div class="small">3-Month Risk</div><div class="val" id="r3m">--</div><div class="small" id="m3dir">‚Üí Elevated</div></div>
            <div class="kpi"><div class="small">6-Month Risk</div><div class="val" id="r6m">--</div><div class="small" id="m6dir">‚Üó Accelerating</div></div>
          </div>
        </div>
      </div>

      <div class="insight-card" id="insightCard" style="display:none">
        <h4><span aria-hidden="true">üí°</span> Market Insight</h4>
        <div id="insightText"></div>
      </div>
    </div>

    <nav role="navigation" aria-label="Dashboard sections">
      <div class="tabs" role="tablist">
        <button class="tab active" role="tab" aria-selected="true" aria-controls="view-overview" id="tab-overview" data-t="overview">Overview</button>
        <button class="tab" role="tab" aria-selected="false" aria-controls="view-ind" id="tab-ind" data-t="ind">Indicators</button>
        <button class="tab" role="tab" aria-selected="false" aria-controls="view-hist" id="tab-hist" data-t="hist">Historical</button>
        <button class="tab" role="tab" aria-selected="false" aria-controls="view-scn" id="tab-scn" data-t="scn">Scenarios</button>
        <button class="tab" role="tab" aria-selected="false" aria-controls="view-news" id="tab-news" data-t="news">News & Events</button>
      </div>
    </nav>

    <div id="view-overview" class="view active" role="tabpanel" aria-labelledby="tab-overview">
      <div class="card">
        <h3 style="margin-bottom:12px">üìä Live Indicator Dashboard</h3>
        <div class="kpi-grid" id="pillGrid" role="list"></div>
      </div>

      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap">
          <h3 style="margin:0">üìà Composite Trend Analysis</h3>
          <div class="btns" role="radiogroup" aria-label="Time period selection">
            <button data-p="30d" class="active" role="radio" aria-checked="true">30D</button>
            <button data-p="90d" role="radio" aria-checked="false">90D</button>
            <button data-p="6m" role="radio" aria-checked="false">6M</button>
            <button data-p="1y" role="radio" aria-checked="false">1Y</button>
            <button data-p="all" role="radio" aria-checked="false">ALL</button>
          </div>
        </div>
        <div class="chart"><canvas id="mainChart" role="img" aria-label="Composite stress trend chart"></canvas></div>
      </div>
    </div>

    <div id="view-ind" class="view" role="tabpanel" aria-labelledby="tab-ind">
      <div class="card">
        <h3 style="margin-bottom:10px">Risk Contribution Breakdown</h3>
        <div class="chart"><canvas id="decomp" role="img" aria-label="Risk contribution by indicator"></canvas></div>
      </div>

      <div class="card">
        <h3 style="margin-bottom:10px">Indicator Radar</h3>
        <div class="radar-chart"><canvas id="radarChart" role="img" aria-label="Indicator stress levels radar"></canvas></div>
      </div>

      <div class="card">
        <h3 style="margin-bottom:10px">Indicator Heat Map</h3>
        <div class="heat" id="heat" role="list"></div>
      </div>
    </div>

    <div id="view-hist" class="view" role="tabpanel" aria-labelledby="tab-hist">
      <div class="card">
        <h3 style="margin-bottom:10px">üìà Historical Crisis Comparisons</h3>
        <div id="crises" style="display:grid;grid-template-columns:1fr;gap:12px" role="list"></div>
      </div>

      <div class="card">
        <h3 style="margin-bottom:10px">Crisis Timeline</h3>
        <div class="chart"><canvas id="crisisTimeline" role="img" aria-label="Historical crisis timeline"></canvas></div>
      </div>
    </div>

    <div id="view-scn" class="view" role="tabpanel" aria-labelledby="tab-scn">
      <div class="card">
        <h3 style="margin-bottom:10px">üéØ Forward-Looking Scenarios</h3>
        <div id="scenarios" style="display:grid;grid-template-columns:1fr;gap:12px" role="list"></div>
      </div>
      <div class="card">
        <h3 style="margin-bottom:10px">Risk Trajectory Forecast (26 Weeks)</h3>
        <div class="chart"><canvas id="traj" role="img" aria-label="26-week risk forecast"></canvas></div>
      </div>
    </div>

    <div id="view-news" class="view" role="tabpanel" aria-labelledby="tab-news">
      <div class="card">
        <h3 style="margin-bottom:10px">üì∞ Market News & Events</h3>
        <div id="newsFeed" class="loading"><div class="spinner"></div>Loading market news...</div>
      </div>

      <div class="card">
        <h3 style="margin-bottom:10px">üóìÔ∏è Upcoming Economic Events</h3>
        <div id="economicCalendar" class="loading"><div class="spinner"></div>Loading economic calendar...</div>
      </div>
    </div>
  </main>
</div>

<!-- Load Chart.js dynamically and wait -->
<script>
(function() {
  const script = document.createElement('script');
  script.src = 'https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js';
  script.async = false;
  document.head.appendChild(script);
})();
</script>

<script>
'use strict';

function waitForChart() {
  return new Promise((resolve) => {
    if (window.Chart) return resolve();
    const iv = setInterval(() => { if (window.Chart){ clearInterval(iv); resolve(); } }, 50);
    setTimeout(() => { clearInterval(iv); resolve(); }, 10000);
  });
}

const CONFIG = {
  FRED_CACHE_PATH: 'data/fred_cache.json',
  MAX_RETRIES: 3,
  RETRY_DELAY: 1000,
  REQUEST_TIMEOUT: 10000,
  INDICATORS: {
    T10Y3M:{label:'Yield Curve',short:'Yield',weight:0.20,format:v=>v?.toFixed(2)+'%',crisis:-0.2,severe:-0.5,dir:'below',
      desc:'10y‚Äì3m Treasury spread.'},
    CREDIT:{label:'Credit Spread',short:'Credit',weight:0.20,format:v=>v?.toFixed(2)+'%',crisis:4.5,elevated:6.0,severe:8.0,dir:'above',
      desc:'US HY OAS (BAMLH0A0HYM2).'},
    SAHM_RULE:{label:'Sahm Rule',short:'Sahm',weight:0.00,format:v=>v?.toFixed(2),crisis:0.50,watch:0.20,caution:0.35,dir:'above',
      desc:'Unemployment 3m avg minus 12m low.'},
    DD_12M:{label:'Market Drawdown',short:'Drawdown',weight:0.08,format:v=>((v??0)*100).toFixed(1)+'%',correction:-0.10,crisis:-0.20,severe:-0.30,dir:'below',
      desc:'S&P 500 drawdown from 12m peak.'},
    UN_SLOPE6:{label:'Unemp Slope (6m)',short:'U-Slope6',weight:0.10,format:v=>v?.toFixed(2)+' pp',crisis:0.30,warning:0.15,dir:'above',
      desc:'Œî unemployment over 6 months.'},
    NFCI:{label:'Financial Conditions',short:'NFCI',weight:0.15,format:v=>v?.toFixed(3),crisis:0.50,elevated:0.80,severe:1.50,dir:'above',
      desc:'Chicago Fed NFCI.'},
    VIX_PROXY:{label:'Volatility',short:'VIX',weight:0.05,format:v=>v?.toFixed(1),elevated:25,crisis:35,panic:50,dir:'above',
      desc:'VIXCLS.'},
    RETAIL_MOMENTUM:{label:'Retail Momentum',short:'Retail',weight:0.05,format:v=>v?.toFixed(1)+'%',crisis:0.0,severe:-2.0,dir:'below',
      desc:'RSAFS 3m/3m annualised.'},
    SENTIMENT:{label:'Consumer Sentiment',short:'Sent',weight:0.07,format:v=>v?.toFixed(0),crisis:55,concerned:65,dir:'below',
      desc:'UMich Sentiment.'},
    VALUATION:{label:'Valuation',short:'Valuation',weight:0.10,
      format:v=>v>20? (v?.toFixed(0)+'% MC/GDP') : (v?.toFixed(2)+'% EY'),
      crisis:null,dir:'above',
      desc:'Market-cap/GDP (Buffett) or Earnings Yield fallback. High MC/GDP or low EY = higher crash susceptibility.'}
  },
  ALIAS:{
    T10Y3M:['T10Y3M'],
    CREDIT:['BAMLH0A0HYM2'],
    NFCI:['NFCI'],
    VIX_PROXY:['VIXCLS'],
    SENTIMENT:['UMCSENT'],
    RETAIL_BASE:['RSAFS'],
    UNRATE:['UNRATE'],
    SPX:['SP500','SPX','^GSPC'],
    VALUATION:['DDDM01USA156NWDB','Q13051USQ156NNBR'] /* MC/GDP primary, Earnings Yield fallback */
  },
  CRISES:[
    {name:'2022 Inflation',score:65,date:'2022-06-13',phase:'Rate Shock',duration:'9 months',drawdown:'-25%'},
    {name:'2000 Dot-com',score:78,date:'2001-03-12',phase:'Tech Bubble',duration:'30 months',drawdown:'-49%'},
    {name:'2020 COVID',score:88,date:'2020-03-23',phase:'Pandemic Shock',duration:'2 months',drawdown:'-34%'},
    {name:'2008 GFC',score:92,date:'2008-10-15',phase:'Crisis Peak',duration:'18 months',drawdown:'-57%'}
  ],
  INSIGHTS: [
    {min:0,max:30,text:"Market conditions are favorable with low stress levels."},
    {min:31,max:50,text:"Moderate stress. Review allocations and consider defense."},
    {min:51,max:70,text:"Elevated stress. Implement defensive strategies."},
    {min:71,max:85,text:"High stress. Prepare for potential corrections."},
    {min:86,max:100,text:"Critical stress. Crisis protocols recommended."}
  ]
};

const SCALE = {
  T10Y3M:v=>{ if(v>=0.5)return 0; if(v>=0)return Math.min(20,v*-40); if(v>=-0.2)return 20+(v*-150); return Math.min(100,50+(v*-250)); },
  CREDIT:v=>{ if(v<=3.0)return 0; if(v<=4.5)return((v-3.0)/1.5)*40; if(v<=6.0)return 40+((v-4.5)/1.5)*30; return 70+Math.min(30,((v-6.0)/2.0)*30); },
  SAHM_RULE:v=>{ if(v<0.20)return v*50; if(v<0.35)return 40+((v-0.20)/0.15)*30; if(v<0.50)return 70+((v-0.35)/0.15)*30; return 100; },
  DD_12M:v=>{ if(v>-0.05)return 0; if(v>-0.10)return((-0.05-v)/0.05)*30; if(v>-0.20)return 30+((-0.10-v)/0.10)*40; return 70+Math.min(30,((-0.20-v)/0.10)*30); },
  UN_SLOPE6:v=>clamp((v/0.6)*100),
  NFCI:v=>{ if(v<=-0.3)return 0; if(v<=0.3)return((v+0.3)/0.6)*40; if(v<=0.8)return 40+((v-0.3)/0.5)*35; return 75+Math.min(25,((v-0.8)/0.7)*25); },
  VIX_PROXY:v=>{ if(v<15)return 0; if(v<25)return((v-15)/10)*40; if(v<35)return 40+((v-25)/10)*35; return 75+Math.min(25,((v-35)/15)*25); },
  RETAIL_MOMENTUM:v=>{ if(v>=4)return 0; if(v>=0)return((4-v)/4)*50; return 50+Math.min(50,((-v)/4)*50); },
  SENTIMENT:v=>{ if(v>=90)return 0; if(v>=75)return((90-v)/15)*30; if(v>=55)return 30+((75-v)/20)*45; return 75+Math.min(25,((55-v)/15)*25); },
  VALUATION:v=>{
    if (v==null || !isFinite(v)) return 0;
    // If value is >20 we treat it as MC/GDP % (typical range 70‚Äì200+).
    if (v>20) return clamp(((v - 100)/80)*100); // 100 ‚Üí 0 stress, 180 ‚Üí 100 stress
    // Otherwise treat as Earnings Yield % (typical 3‚Äì8%); lower yield = more stress.
    return clamp(((6 - v)/4)*100);               // 6%‚Üí0 stress, 2%‚Üí100 stress
  }
};
function clamp(x){return Math.max(0,Math.min(100,x));}

class DashboardState {
  constructor(){ this.charts=new Map(); }
  setChart(name,chart){ this.destroyChart(name); this.charts.set(name,chart); }
  destroyChart(name){ const c=this.charts.get(name); if(c){ c.destroy(); this.charts.delete(name); } }
  cleanup(){ this.charts.forEach(c=>c.destroy()); this.charts.clear(); }
}
const dashboardState=new DashboardState();

class DataValidationError extends Error { constructor(msg,indicator){ super(msg); this.name='DataValidationError'; this.indicator=indicator; } }

function sanitizeHTML(str){ const div=document.createElement('div'); div.textContent=str; return div.innerHTML; }
function sleep(ms){ return new Promise(r=>setTimeout(r,ms)); }
function byId(id){ return document.getElementById(id); }

async function loadDataWithRetry(){
  for(let i=0;i<CONFIG.MAX_RETRIES;i++){
    try{
      const controller=new AbortController();
      const to=setTimeout(()=>controller.abort(),CONFIG.REQUEST_TIMEOUT);
      const res=await fetch(`${CONFIG.FRED_CACHE_PATH}?t=${Date.now()}`,{cache:'no-store',signal:controller.signal});
      clearTimeout(to);
      if(!res.ok) throw new Error(`HTTP ${res.status}: ${res.statusText}`);
      return validateCacheData(await res.json());
    }catch(e){
      if(i===CONFIG.MAX_RETRIES-1) throw e;
      await sleep(CONFIG.RETRY_DELAY*(i+1));
    }
  }
}

function validateCacheData(data){
  if(!data || typeof data!=='object') throw new DataValidationError('Invalid cache data');
  return data;
}
function validateIndicatorData(data,key){
  if(!data || typeof data!=='object') throw new DataValidationError(`Invalid data for ${key}`,key);
  if(!Array.isArray(data.observations)) throw new DataValidationError(`Missing observations for ${key}`,key);
  return data;
}

function resolveSeries(cache, arr){ for(const k of arr){ if(cache && cache[k]){ try{return validateIndicatorData(cache[k],k);}catch(e){ console.error(e); return null; } } } return null; }
function lastValidObs(series){ if(!series?.observations?.length) return null; for(let i=series.observations.length-1;i>=0;i--){ const v=parseFloat(series.observations[i].value); if(isFinite(v)) return {date:series.observations[i].date,value:v}; } return null; }
function parseDate(d){return new Date(d)}
function daysSince(d){return Math.floor((Date.now()-parseDate(d))/86400000)}

function buildDerived(ser){
  const out={};
  if(ser.UNRATE?.observations){
    const map=obsMap(ser.UNRATE.observations); const mkeys=Object.keys(map).sort();
    const sahm=[], slope6=[];
    for(const ym of mkeys){
      const cur=map[ym];
      const prevMs=monthOffset(ym,-1), prevM2=monthOffset(ym,-2);
      if(map[prevMs]!==undefined && map[prevM2]!==undefined){
        const avg3=(cur+map[prevMs]+map[prevM2])/3;
        let low12=Infinity; for(let i=0;i<12;i++){ const k=monthOffset(ym,-i); if(map[k]!==undefined) low12=Math.min(low12,map[k]); }
        if(low12<Infinity) sahm.push({date: ym+'-01', value:+(avg3-low12).toFixed(2)});
      }
      const back6=monthOffset(ym,-6);
      if(map[back6]!==undefined) slope6.push({date: ym+'-01', value:+(cur-map[back6]).toFixed(2)});
    }
    out.SAHM_RULE={observations:sahm};
    out.UN_SLOPE6={observations:slope6};
  }
  if(ser.SPX?.observations){
    const obs=ser.SPX.observations.filter(o=>isFinite(parseFloat(o.value)));
    const vals=[], outObs=[];
    for(let i=0;i<obs.length;i++){
      const p=parseFloat(obs[i].value); vals.push(p);
      const start=Math.max(0,i-252); let max=-Infinity; for(let j=start;j<=i;j++) if(vals[j]>max) max=vals[j];
      const dd=p/max-1; outObs.push({date:obs[i].date, value:+dd.toFixed(4)});
    }
    out.DD_12M={observations:outObs};
  }
  if(ser.RSAFS?.observations){
    const map=obsMap(ser.RSAFS.observations); const mkeys=Object.keys(map).sort(); const outR=[];
    for(const ym of mkeys){
      const back3=monthOffset(ym,-3);
      if(map[back3]!==undefined){ const g=((map[ym]/map[back3])-1)*4*100; outR.push({date: ym+'-01', value:+g.toFixed(2)}); }
    }
    out.RETAIL_MOMENTUM={observations:outR};
  }
  if(ser.VIX) out.VIX_PROXY=ser.VIX;
  if(ser.UMCSENT) out.SENTIMENT=ser.UMCSENT;
  if(ser.VALUATION) out.VALUATION=ser.VALUATION; // pass-through (monthly/quarterly ok)
  return out;
}
function obsMap(observations){ const m={}; for(const o of observations){ const v=parseFloat(o.value); if(!isFinite(v)) continue; const ym=o.date.slice(0,7); m[ym]=v; } return m; }
function monthOffset(ym,off){ const [y,m]=ym.split('-').map(Number); const d=new Date(y,m-1,1); d.setMonth(d.getMonth()+off); return d.toISOString().slice(0,7); }

function computeLatestKPIs(ser,deriv){
  const out=[]; const defs=CONFIG.INDICATORS;
  function add(key, source){
    const def=defs[key]; const lv=lastValidObs(source); if(!lv) return;
    const raw=lv.value; const scaled=SCALE[key](raw); const rag=scaled<30?'g':(scaled<60?'a':'r');
    const crisis = def.crisis==null ? false : (def.dir==='below' ? raw<=def.crisis : raw>=def.crisis);
    out.push({ key,label:def.label,short:def.short,desc:def.desc,weight:def.weight,date:lv.date,raw,scaled,disp:def.format(raw),rag,crisis });
  }
  add('T10Y3M', ser.T10Y3M);
  add('CREDIT', ser.CREDIT);
  add('NFCI',   ser.NFCI);
  add('VIX_PROXY', deriv.VIX_PROXY);
  add('SENTIMENT', deriv.SENTIMENT);
  add('RETAIL_MOMENTUM', deriv.RETAIL_MOMENTUM);
  add('SAHM_RULE', deriv.SAHM_RULE);
  add('UN_SLOPE6', deriv.UN_SLOPE6);
  add('DD_12M', deriv.DD_12M);
  add('VALUATION', deriv.VALUATION || ser.VALUATION);
  return out;
}

function pickAnchorDates(ser){
  const s = ser.SPX?.observations?.length ? ser.SPX
        : ser.T10Y3M?.observations?.length ? ser.T10Y3M
        : ser.CREDIT?.observations?.length ? ser.CREDIT
        : ser.NFCI;
  return (s?.observations||[]).filter(o=>isFinite(parseFloat(o.value))).map(o=>o.date);
}

function valueOnOrBefore(seriesObs,date){
  const arr=seriesObs; if(!arr?.length) return null;
  let lo=0,hi=arr.length-1,ans=null;
  while(lo<=hi){
    const mid=(lo+hi)>>1; const d=arr[mid].date;
    if(d<=date){ ans=arr[mid]; lo=mid+1; } else hi=mid-1;
  }
  return ans ? parseFloat(ans.value) : null;
}

function buildCompositeHistory(anchorDates,ser,deriv){
  const keys=Object.keys(CONFIG.INDICATORS);
  const look=(k)=> (['VIX_PROXY','SENTIMENT','RETAIL_MOMENTUM','SAHM_RULE','UN_SLOPE6','DD_12M','VALUATION'].includes(k) ? (deriv[k]||ser[k]) : ser[k]);
  const obs={};
  for(const k of keys){
    const src=look(k); if(!src?.observations) continue;
    const arr=src.observations.filter(o=>isFinite(parseFloat(o.value))).sort((a,b)=>a.date.localeCompare(b.date));
    obs[k]=arr;
  }
  const hist=[];
  for(const d of anchorDates){
    let sum=0,wsum=0,parts={};
    for(const k of keys){
      const arr=obs[k]; if(!arr) continue;
      const v=valueOnOrBefore(arr,d); if(v==null) continue;
      const scaled=SCALE[k](v); const w=CONFIG.INDICATORS[k].weight;
      sum+=scaled*w; wsum+=w; parts[k]={raw:v,scaled,w};
    }
    if(wsum>0) hist.push({date:d, composite:+(sum/wsum).toFixed(2), parts});
  }
  return hist;
}

function renderTop(kpis,history){
  const composite=history.length? history[history.length-1].composite : 50;
  const zone=composite<=30?'green':(composite<=60?'amber':'red');
  const scoreEl=byId('scoreV'); scoreEl.textContent=Math.round(composite);
  scoreEl.setAttribute('aria-label',`Composite stress score: ${Math.round(composite)} out of 100`);
  byId('needle').style.setProperty('--angle', `${composite*3.6}deg`);
  byId('partsNote').textContent=`Composite derived from ${kpis.length} indicators`;
  byId('indicatorsCount').textContent=`Indicators: ${kpis.length}/10`;
  const riskFill=byId('riskFill'); riskFill.style.width=`${composite}%`; riskFill.parentElement.setAttribute('aria-valuenow',Math.round(composite));
  const now=new Date(); const missing=Object.keys(CONFIG.INDICATORS).length - kpis.length;
  let stale=0; kpis.forEach(k=>{ if(daysSince(k.date)>60) stale++; }); // allow 60d window for slow series (valuation etc.)
  const quality=Math.max(30, 100 - (missing*12 + stale*6));
  byId('qfill').style.width=quality+'%'; byId('qtxt').textContent=quality+'%'; byId('qual').textContent='Quality: '+quality+'%';
  byId('upd').textContent='Last Update: ' + now.toLocaleTimeString();

  const status = zone==='green'?'Normal':(zone==='amber'?'Elevated':'Critical');
  byId('regime').innerHTML = `<span style="width:12px;height:12px;border-radius:50%;background:var(--${zone});box-shadow:0 0 10px var(--${zone})" aria-hidden="true"></span> <strong style="font-size:18px">${Math.round(composite)}</strong> | ${status} Market Regime`;

  const alerts=kpis.filter(p=>p.crisis); const alertBox=byId('alert');
  if(composite>=80){
    alertBox.style.display='block';
    alertBox.innerHTML=`<span aria-hidden="true">üö®</span> <strong>CRITICAL MARKET ALERT</strong> ‚Äî Stress ${Math.round(composite)}. ${alerts.length} indicator(s) at crisis levels.`;
  } else if(alerts.length>0){
    alertBox.style.display='block';
    alertBox.innerHTML=`<span aria-hidden="true">‚ö†Ô∏è</span> <strong>ATTENTION</strong> ‚Äî ${alerts.length} indicator(s) at crisis threshold.`;
  } else alertBox.style.display='none';

  const r1m=Math.round(20+composite*0.6), r3m=Math.round(30+composite*0.7), r6m=Math.round(40+composite*0.8);
  byId('r1m').textContent=r1m+'%'; byId('r3m').textContent=r3m+'%'; byId('r6m').textContent=r6m+'%';
  byId('m1dir').innerHTML=getTrendIndicator(r1m);
  byId('m3dir').innerHTML=getTrendIndicator(r3m);
  byId('m6dir').innerHTML=getTrendIndicator(r6m);

  const insight=CONFIG.INSIGHTS.find(i=>composite>=i.min && composite<=i.max);
  if(insight){ byId('insightText').textContent=insight.text; byId('insightCard').style.display='block'; }

  drawTrend(history,'30d');

  // Audit panel
  runAudit(kpis);
}
function getTrendIndicator(v){ if(v<30) return '<span aria-hidden="true">‚Üì</span> Low Risk'; if(v<50) return '<span aria-hidden="true">‚Üí</span> Moderate'; if(v<70) return '<span aria-hidden="true">‚Üó</span> Elevated'; return '<span aria-hidden="true">‚Üó‚Üë</span> High Risk'; }

function runAudit(kpis){
  const required = Object.keys(CONFIG.INDICATORS);
  const have = new Set(kpis.map(k=>k.key));
  const missing = required.filter(k=>!have.has(k));
  const stale = kpis.filter(k=>daysSince(k.date)>60).map(k=>k.key);
  const box = byId('auditBox'); const msg = byId('auditMsg');
  if(missing.length || stale.length){
    box.style.display='block';
    const parts=[];
    if(missing.length) parts.push(`Missing: ${missing.join(', ')}`);
    if(stale.length) parts.push(`Stale (>60d): ${stale.join(', ')}`);
    msg.textContent = parts.join(' ‚Ä¢ ');
  } else {
    box.style.display='none';
  }
}

function pill(node){
  node.addEventListener('click',()=>node.classList.toggle('show'));
  node.setAttribute('tabindex','0'); node.setAttribute('role','listitem');
  node.addEventListener('keydown',(e)=>{ if(e.key==='Enter'||e.key===' '){ e.preventDefault(); node.classList.toggle('show'); }});
}

const fadeInStyle=document.createElement('style'); fadeInStyle.textContent='@keyframes fadeInUp{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}'; document.head.appendChild(fadeInStyle);

function renderPills(kpis){
  const grid=byId('pillGrid'); const frag=document.createDocumentFragment();
  kpis.forEach((k,idx)=>{
    const fresh=daysSince(k.date)<=60 ? '<span class="badge b-fresh">FRESH</span>' : '<span class="badge b-stale">STALE</span>';
    const rag=k.rag==='g'?'g':(k.rag==='a'?'a':'r');
    const div=document.createElement('div');
    div.className='kpi show'; div.id=`pill-${k.key}`; div.setAttribute('aria-label',`${k.label}: ${k.disp}`);
    div.innerHTML=`<h4>${sanitizeHTML(k.label)} <span class="dot ${rag}" aria-label="${rag==='g'?'Green':(rag==='a'?'Amber':'Red')} status"></span></h4>
      <div class="val" aria-label="Value: ${k.disp}">${k.disp}</div>
      <div class="small">Last: ${k.date} &nbsp; ${fresh}</div>
      <div class="toggle-desc small" title="Tap to expand">About this KPI</div>
      <div class="desc">${sanitizeHTML(k.desc)}</div>`;
    div.style.opacity='0'; div.style.animation='fadeInUp 0.5s ease forwards'; div.style.animationDelay=`${idx*0.05}s`;
    frag.appendChild(div);
  });
  grid.innerHTML=''; grid.appendChild(frag);
  kpis.forEach(k=> pill(byId('pill-'+k.key)));
}

function renderHeat(kpis){
  const heat=byId('heat'); const frag=document.createDocumentFragment();
  kpis.forEach(k=>{
    const pct=Math.round(k.scaled);
    const col=pct<30?'var(--green)':(pct<60?'var(--amber)':'var(--red)');
    const div=document.createElement('div'); div.className='cell'; div.setAttribute('role','listitem');
    div.setAttribute('aria-label',`${k.short}: ${k.disp}, ${pct}% stress`);
    div.innerHTML=`<div class="small" style="text-transform:uppercase;font-weight:800">${sanitizeHTML(k.short)}</div>
      <div style="font-weight:800;font-size:26px;margin:6px 0">${k.disp}</div>
      <div class="bar" role="progressbar" aria-valuenow="${pct}" aria-valuemin="0" aria-valuemax="100">
        <span style="width:${pct}%;background:${col};box-shadow:0 0 8px ${col}"></span>
      </div>`;
    frag.appendChild(div);
  });
  heat.innerHTML=''; heat.appendChild(frag);
}

function renderDecomp(kpis){
  if(!window.Chart) return;
  const canvas=byId('decomp'); if(!canvas) return;
  const ctx=canvas.getContext('2d');
  const data=kpis.map(k=> +(k.scaled*k.weight).toFixed(2));
  const labels=kpis.map(k=>k.short);
  const colors=kpis.map(k=> k.rag==='g'?'#1ec28b':(k.rag==='a'?'#ffc247':'#ff6070'));
  dashboardState.setChart('decomp', new Chart(ctx,{ type:'bar',
    data:{labels,datasets:[{data,backgroundColor:colors}]},
    options:{ responsive:true, maintainAspectRatio:true, plugins:{ legend:{display:false},
      tooltip:{callbacks:{label:c=>{ const k=kpis[c.dataIndex]; return `${k.label}: ${k.disp} (${Math.round(k.scaled)}% stress)`; }}} },
      scales:{ x:{ticks:{color:'#a5b4cf'}}, y:{ticks:{color:'#a5b4cf',callback:v=>v+'%'},grid:{color:'rgba(255,255,255,.06)'}} }
    }
  }));
}

function renderRadar(kpis){
  if(!window.Chart) return;
  const canvas=byId('radarChart'); if(!canvas) return;
  const ctx=canvas.getContext('2d'); const labels=kpis.map(k=>k.short); const data=kpis.map(k=>k.scaled);
  const colors=kpis.map(k=> k.rag==='g'?'#1ec28b':(k.rag==='a'?'#ffc247':'#ff6070'));
  dashboardState.setChart('radar', new Chart(ctx,{ type:'radar',
    data:{ labels, datasets:[{ data, backgroundColor:'rgba(107,158,255,0.2)', borderColor:'#6b9eff',
      pointBackgroundColor:colors, pointBorderColor:'#fff', pointHoverBackgroundColor:'#fff', pointHoverBorderColor:colors, pointRadius:4, pointHoverRadius:6 }]},
    options:{ responsive:true, maintainAspectRatio:true, plugins:{ legend:{display:false}, tooltip:{callbacks:{label:c=>{ const k=kpis[c.dataIndex]; return `${k.label}: ${k.disp} (${Math.round(k.scaled)}% stress)`; }}}},
      scales:{ r:{ angleLines:{color:'rgba(255,255,255,0.1)'}, grid:{color:'rgba(255,255,255,0.1)'}, pointLabels:{color:'#a5b4cf',font:{size:11}},
        ticks:{color:'#a5b4cf',backdropColor:'transparent',callback:v=>v+'%'}, min:0,max:100 } } }
  }));
}

function renderCrises(history){
  const cur=history.length? history[history.length-1].composite : 50;
  const box=byId('crises'); const frag=document.createDocumentFragment();
  CONFIG.CRISES.forEach(c=>{
    const sim=Math.max(50, 100 - Math.abs(cur - c.score));
    const col=sim>70?'var(--red)':'var(--amber)';
    const div=document.createElement('div'); div.className='cell'; div.setAttribute('role','listitem'); div.style.borderRadius='12px';
    div.innerHTML=`<div style="font-weight:800;margin-bottom:6px">${sanitizeHTML(c.name)}</div>
      <div class="badge" style="margin-bottom:6px">${sanitizeHTML(c.phase)}</div>
      <div class="small">Peak Stress Score</div><div style="font-weight:800">${c.score}</div>
      <div class="small" style="margin-top:6px">Pattern Similarity</div>
      <div style="font-weight:800;color:${col}">${Math.round(sim)}%</div>
      <div class="small" style="margin-top:6px">Max Drawdown</div><div style="font-weight:800">${sanitizeHTML(c.drawdown)}</div>
      <div class="small" style="margin-top:6px">${c.date} ‚Ä¢ Duration: ${sanitizeHTML(c.duration)}</div>`;
    frag.appendChild(div);
  });
  box.innerHTML=''; box.appendChild(frag);
  drawCrisisTimeline(history);
}

function renderScenarios(history){
  const cur=history.length? history[history.length-1].composite : 50;
  const base=Math.max(10,Math.min(80,Math.round(60 - cur*0.2)));
  const down=Math.max(5,Math.min(80,Math.round(20 + cur*0.4)));
  const up=Math.max(5,Math.min(80,100 - base - down));
  const box=byId('scenarios');
  box.innerHTML=`<div class="cell" role="listitem"><div style="font-weight:800;margin-bottom:6px">Base Case</div>
      <div style="font-size:28px;font-weight:800;background:linear-gradient(135deg,var(--accent-bright),#4a7fe8);-webkit-background-clip:text;-webkit-text-fill-color:transparent" aria-label="Base case probability: ${base}%">${base}%</div>
      <div class="small" style="margin-top:6px">Sideways-to-mild volatility; gradual improvement in 3‚Äì6m.</div></div>
    <div class="cell" role="listitem"><div style="font-weight:800;margin-bottom:6px">Downside Risk</div>
      <div style="font-size:28px;font-weight:800;color:var(--red)" aria-label="Downside risk probability: ${down}%">${down}%</div>
      <div class="small" style="margin-top:6px">Tighter financial conditions; correction risk.</div></div>
    <div class="cell" role="listitem"><div style="font-weight:800;margin-bottom:6px">Upside Relief</div>
      <div style="font-size:28px;font-weight:800;color:var(--green)" aria-label="Upside relief probability: ${up}%">${up}%</div>
      <div class="small" style="margin-top:6px">Soft-landing prints; easing conditions.</div></div>`;
  drawTrajectory(cur);
}

function renderNewsFeed(){
  // Static stub (FRED-only build)
  const news=[{title:"FRED-only build",source:"Notice",time:"",impact:"low"}];
  const newsHtml=news.map(item=>`
    <div class="cell" style="display:flex;align-items:flex-start;gap:12px;padding:12px" role="listitem">
      <div style="width:8px;height:8px;border-radius:50%;margin-top:6px;background:var(--green)"></div>
      <div style="flex:1">
        <div style="font-weight:700;margin-bottom:4px">${sanitizeHTML(item.title)}</div>
        <div class="small">Live headlines disabled by design.</div>
      </div>
    </div>`).join('');
  byId('newsFeed').innerHTML=newsHtml;

  const calHtml=`<div class="cell" style="display:flex;justify-content:space-between;align-items:center;padding:12px" role="listitem">
    <div><div style="font-weight:700;margin-bottom:4px">Calendar (manual)</div><div class="small">Add key dates manually.</div></div>
    <span class="badge b-fresh">INFO</span></div>`;
  byId('economicCalendar').innerHTML=calHtml;
}

function drawTrend(history,period='30d'){
  if(!window.Chart) return;
  const canvas=byId('mainChart'); if(!canvas) return;
  const ctx=canvas.getContext('2d'); const sliced=sliceHistory(history,period);
  const labels=sliced.map(x=>formatLabel(x.date)); const data=sliced.map(x=>x.composite);
  dashboardState.setChart('main', new Chart(ctx,{ type:'line',
    data:{labels,datasets:[{label:'Stress Index',data,fill:true,tension:0.35,borderWidth:2,borderColor:'#6b9eff',backgroundColor:'rgba(107,158,255,.12)',pointRadius:0}]},
    options:{ responsive:true, maintainAspectRatio:true, plugins:{ legend:{display:false}, tooltip:{mode:'index',intersect:false,backgroundColor:'rgba(18,24,43,.95)',titleColor:'#e8eeff',bodyColor:'#a5b4cf',callbacks:{label:c=>`Stress: ${c.parsed.y}%`}} },
      scales:{ y:{min:0,max:100,ticks:{color:'#a5b4cf',callback:v=>v+'%'},grid:{color:'rgba(255,255,255,.06)'}}, x:{ticks:{color:'#a5b4cf',maxTicksLimit: window.innerWidth<768?5:10},grid:{color:'rgba(255,255,255,.06)'}} },
      interaction:{intersect:false,mode:'index'} }
  }));
}

function drawCrisisTimeline(history){
  if(!window.Chart) return;
  const canvas=byId('crisisTimeline'); if(!canvas) return;
  const ctx=canvas.getContext('2d'); const sliced=sliceHistory(history,'5y');
  const labels=sliced.map(x=>{ const d=new Date(x.date); return d.getFullYear()+'-'+String(d.getMonth()+1).padStart(2,'0'); });
  const data=sliced.map(x=>x.composite);
  dashboardState.setChart('crisisTimeline', new Chart(ctx,{ type:'line',
    data:{labels,datasets:[{data,fill:true,tension:0.4,borderWidth:2,borderColor:'#6b9eff',backgroundColor:'rgba(107,158,255,.12)',pointRadius:0,
      segment:{borderColor:ctx=>{ const v=ctx.p0.parsed.y; if(v<30)return'#1ec28b'; if(v<60)return'#ffc247'; return'#ff6070'; }}}]},
    options:{ responsive:true, maintainAspectRatio:true, plugins:{ legend:{display:false}, tooltip:{mode:'index',intersect:false,backgroundColor:'rgba(18,24,43,.95)',titleColor:'#e8eeff',bodyColor:'#a5b4cf'} },
      scales:{ y:{min:0,max:100,ticks:{color:'#a5b4cf',callback:v=>v+'%'},grid:{color:'rgba(255,255,255,.06)'}}, x:{ticks:{color:'#a5b4cf',autoSkip:true,maxTicksLimit:10},grid:{color:'rgba(255,255,255,.06)'}} } }
  }));
}

function drawTrajectory(cur){
  if(!window.Chart) return;
  const canvas=byId('traj'); if(!canvas) return;
  const ctx=canvas.getContext('2d'); const weeks=26,path=[],upper=[],lower=[]; let v=cur;
  for(let i=0;i<weeks;i++){ v=0.85*v+0.15*50; const band=6*Math.sqrt((i+1)/weeks); path.push(+v.toFixed(1)); upper.push(Math.min(100,+(v+band).toFixed(1))); lower.push(Math.max(0,+(v-band).toFixed(1))); }
  dashboardState.setChart('traj', new Chart(ctx,{ type:'line',
    data:{labels:Array.from({length:weeks},(_,i)=>'W+'+(i+1)),
      datasets:[ {label:'Projected',data:path,borderColor:'#ffc247',borderWidth:2,tension:.35,fill:false},
                 {label:'Upper',data:upper,borderColor:'#ff6070',borderDash:[4,4],borderWidth:1,fill:false},
                 {label:'Lower',data:lower,borderColor:'#1ec28b',borderDash:[4,4],borderWidth:1,fill:false} ]},
    options:{ responsive:true, maintainAspectRatio:true, plugins:{ legend:{labels:{color:'#a5b4cf'}}, tooltip:{callbacks:{label:c=>`${c.dataset.label}: ${c.parsed.y}%`}} },
      scales:{ y:{min:0,max:100,ticks:{color:'#a5b4cf',callback:v=>v+'%'},grid:{color:'rgba(255,255,255,.06)'}}, x:{ticks:{color:'#a5b4cf'},grid:{color:'rgba(255,255,255,.06)'}} } }
  }));
}

function sliceHistory(history,period){
  if(!history.length) return [];
  if(period==='all') return history;
  const end=parseDate(history[history.length-1].date); let start=new Date(end);
  if(period==='30d') start.setDate(start.getDate()-30);
  else if(period==='90d') start.setDate(start.getDate()-90);
  else if(period==='6m') start.setMonth(start.getMonth()-6);
  else if(period==='1y') start.setFullYear(start.getFullYear()-1);
  else if(period==='2y') start.setFullYear(start.getFullYear()-2);
  else if(period==='3y') start.setFullYear(start.getFullYear()-3);
  else if(period==='5y') start.setFullYear(start.getFullYear()-5);
  return history.filter(x=>parseDate(x.date)>=start);
}
function formatLabel(d){ const dt=new Date(d); return dt.toLocaleDateString('en-GB',{month:'short',day:'numeric'}); }

function setupPeriodButtons(history){
  const container=document.querySelector('.btns'); const clone=container.cloneNode(true); container.parentNode.replaceChild(clone,container);
  clone.addEventListener('click',e=>{
    if(e.target.tagName!=='BUTTON') return;
    clone.querySelectorAll('button').forEach(b=>{ b.classList.remove('active'); b.setAttribute('aria-checked','false'); });
    e.target.classList.add('active'); e.target.setAttribute('aria-checked','true');
    drawTrend(history, e.target.dataset.p);
  });
}

function setupTabs(){
  const tabs=document.querySelectorAll('.tab'); const views=document.querySelectorAll('.view');
  function activateTab(active){
    tabs.forEach(t=>{ t.classList.remove('active'); t.setAttribute('aria-selected','false'); });
    views.forEach(v=>v.classList.remove('active'));
    active.classList.add('active'); active.setAttribute('aria-selected','true');
    document.getElementById('view-'+active.dataset.t).classList.add('active');
  }
  tabs.forEach((tab)=>{
    tab.addEventListener('click',()=>activateTab(tab));
    tab.addEventListener('keydown',(e)=>{
      const arr=Array.from(tabs); const i=arr.indexOf(tab);
      if(e.key==='ArrowRight'){ e.preventDefault(); const n=arr[Math.min(i+1,arr.length-1)]; n.focus(); activateTab(n); }
      else if(e.key==='ArrowLeft'){ e.preventDefault(); const p=arr[Math.max(i-1,0)]; p.focus(); activateTab(p); }
      else if(e.key==='Home'){ e.preventDefault(); arr[0].focus(); activateTab(arr[0]); }
      else if(e.key==='End'){ e.preventDefault(); arr[arr.length-1].focus(); activateTab(arr[arr.length-1]); }
    });
  });
}

function exportReport(kpis,history){
  const report={ timestamp:new Date().toISOString(), composite: history.length? Math.round(history[history.length-1].composite):null,
    quality: byId('qtxt').textContent, indicators: kpis.map(k=>({name:k.label,value:k.disp,status:k.rag,crisis:k.crisis,last:k.date})) };
  const blob=new Blob([JSON.stringify(report,null,2)],{type:'application/json'});
  const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=`crash-radar-report-${Date.now()}.json`; a.click(); URL.revokeObjectURL(url);
}

function debounce(fn,wait){ let t; return (...args)=>{ clearTimeout(t); t=setTimeout(()=>fn.apply(this,args),wait); }; }
const debouncedRefresh=debounce(init,300);

let resizeTimeout;
window.addEventListener('resize',()=>{ clearTimeout(resizeTimeout); resizeTimeout=setTimeout(()=>{ dashboardState.charts.forEach(c=>{ if(c) c.resize(); }); },250); });

async function init(){
  try{
    showLoadingState(true);
    await waitForChart();
    if(!window.Chart) throw new Error('Chart.js library failed to load.');
    const cache=await loadDataWithRetry();
    const s=k=> resolveSeries(cache, CONFIG.ALIAS[k]);
    const ser={ T10Y3M:s('T10Y3M'), CREDIT:s('CREDIT'), NFCI:s('NFCI'), VIX:s('VIX_PROXY'), UMCSENT:s('SENTIMENT'),
               RSAFS:s('RETAIL_BASE'), UNRATE:s('UNRATE'), SPX:s('SPX'), VALUATION:s('VALUATION') };
    const deriv=buildDerived(ser);
    const kpis=computeLatestKPIs(ser,deriv);
    const anchors=pickAnchorDates(ser);
    const history=buildCompositeHistory(anchors,ser,deriv);

    renderTop(kpis,history);
    renderPills(kpis);
    renderHeat(kpis);
    setTimeout(()=>{ try{ renderDecomp(kpis); renderRadar(kpis); }catch(e){ console.error('Chart render error',e);} },100);
    renderCrises(history);
    renderScenarios(history);
    renderNewsFeed();
    setupTabs();
    setupPeriodButtons(history);

    byId('refreshBtn').onclick=()=>debouncedRefresh();
    byId('exportBtn').onclick=()=>exportReport(kpis,history);
    showLoadingState(false);
  }catch(e){ console.error('Init failed:',e); showErrorState(e); }
}

function showLoadingState(show){
  if(show){ document.body.style.opacity='0.7'; document.body.style.pointerEvents='none'; byId('refreshBtn').disabled=true; }
  else { document.body.style.opacity='1'; document.body.style.pointerEvents='auto'; byId('refreshBtn').disabled=false; }
}

function showErrorState(error){
  const card=document.querySelector('.card');
  const msg=sanitizeHTML(error.message||String(error));
  if(!card){
    document.body.innerHTML=`<div style="padding:40px;text-align:center"><h1 style="color:#ff6070">‚ö†Ô∏è Error</h1><p style="color:#a5b4cf;margin:20px 0">${msg}</p><button class="btn" onclick="location.reload()">üîÑ Reload Page</button></div>`;
    return;
  }
  card.innerHTML=`<div class="error-state">
    <h2 style="color:var(--red);margin-bottom:16px">‚ö†Ô∏è Unable to Load Dashboard</h2>
    <p style="margin-bottom:16px"><strong>Error:</strong> ${msg}</p>
    ${msg.includes('fred_cache')?`<div style="background:rgba(255,194,71,.1);padding:16px;border-radius:8px;margin:16px 0;border:1px solid rgba(255,194,71,.3)">
      <p style="color:var(--amber);margin-bottom:8px"><strong>Missing Data File</strong></p>
      <p style="font-size:14px;color:var(--muted)">Required <code>data/fred_cache.json</code></p></div>`:''}
    ${msg.includes('Chart')?`<div style="background:rgba(255,194,71,.1);padding:16px;border-radius:8px;margin:16px 0;border:1px solid rgba(255,194,71,.3)">
      <p style="color:var(--amber);margin-bottom:8px"><strong>Chart Library Issue</strong></p>
      <p style="font-size:14px;color:var(--muted)">Chart.js failed to load from CDN</p></div>`:''}
    <div style="margin-top:20px"><button class="btn" onclick="location.reload()">üîÑ Retry</button></div></div>`;
}

window.addEventListener('DOMContentLoaded',init);
window.addEventListener('beforeunload',()=>{ dashboardState.cleanup(); });
</script>
</body>
</html>
