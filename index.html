<!doctype html>

<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Economic Crash Radar Pro</title>
  <style>
    :root{
      --bg:#0a0e1a; --panel:#12182b; --muted:#8b96b0; --text:#e8eeff;
      --accent:#6b9eff; --green:#1ec28b; --amber:#ffc247; --red:#ff6070;
      --radius:14px; --shadow:0 4px 24px rgba(0,0,0,.3);
    }
    *{box-sizing:border-box;margin:0;padding:0}
    body{background:var(--bg);color:var(--text);font:15px/1.6 -apple-system,sans-serif;padding:20px}
    .wrap{max-width:1400px;margin:0 auto}
    h1{font-size:42px;margin-bottom:8px;background:linear-gradient(135deg,var(--text),var(--accent));
      -webkit-background-clip:text;-webkit-text-fill-color:transparent}
    .subtitle{color:var(--muted);margin-bottom:24px}
    .card{background:var(--panel);border-radius:var(--radius);padding:24px;margin:20px 0;
      box-shadow:var(--shadow)}
    .gauge-section{display:flex;gap:32px;align-items:center;flex-wrap:wrap}
    .gauge{width:200px;height:200px;position:relative;flex-shrink:0}
    .gauge-ring{position:absolute;inset:0;border-radius:50%;
      background:conic-gradient(var(--green) 0 108deg,var(--amber) 108deg 216deg,var(--red) 216deg 360deg)}
    .gauge-ring::after{content:"";position:absolute;inset:20px;border-radius:50%;background:var(--panel)}
    .gauge-needle{position:absolute;inset:0;transition:transform .6s}
    .gauge-needle::before{content:"";position:absolute;top:50%;left:50%;width:4px;height:45%;
      background:var(--accent);transform:translateX(-50%) translateY(-100%) rotate(var(--angle,0deg));
      transform-origin:bottom;border-radius:4px}
    .gauge-score{position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;
      justify-content:center;font-size:48px;font-weight:800}
    .gauge-info{flex:1;min-width:300px}
    .gauge-info h2{font-size:28px;margin-bottom:8px}
    .info-box{background:rgba(107,158,255,.08);border-left:3px solid var(--accent);
      padding:12px;border-radius:8px;margin:12px 0;font-size:13px;line-height:1.6}
    .regime-box{background:rgba(255,255,255,.04);padding:16px;border-radius:10px;margin:16px 0}
    .regime-header{display:flex;align-items:center;gap:12px;margin-bottom:8px}
    .regime-dot{width:12px;height:12px;border-radius:50%}
    .regime-title{font-size:18px;font-weight:700}
    .regime-desc{font-size:13px;color:var(--muted);margin-bottom:12px}
    .regime-actions{display:grid;gap:8px;margin-top:12px}
    .regime-action{background:rgba(255,255,255,.03);padding:10px;border-radius:8px;font-size:12px}
    .action-title{font-weight:600;margin-bottom:2px}
    .risk-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:16px;margin:16px 0}
    .risk-card{background:rgba(255,255,255,.03);padding:18px;border-radius:12px}
    .risk-title{font-size:12px;text-transform:uppercase;color:var(--muted);margin-bottom:8px}
    .risk-value{font-size:32px;font-weight:800;color:var(--accent);margin-bottom:8px}
    .risk-desc{font-size:12px;color:var(--muted);line-height:1.5;margin-bottom:8px}
    .risk-detail{font-size:11px;padding-top:8px;border-top:1px solid rgba(255,255,255,.06)}
    .pills{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:14px}
    .pill{background:rgba(255,255,255,.03);border-left:4px solid;padding:16px;border-radius:10px;
      transition:transform .2s}
    .pill:hover{transform:translateY(-2px)}
    .pill.rag-green{border-left-color:var(--green)}
    .pill.rag-amber{border-left-color:var(--amber)}
    .pill.rag-red{border-left-color:var(--red)}
    .pill-header{display:flex;justify-content:space-between;margin-bottom:8px}
    .pill-title{font-weight:600;font-size:14px}
    .pill-status{font-size:10px;padding:4px 8px;border-radius:6px;text-transform:uppercase;font-weight:600}
    .status-green{background:rgba(30,194,139,.15);color:var(--green)}
    .status-amber{background:rgba(255,194,71,.15);color:var(--amber)}
    .status-red{background:rgba(255,96,112,.15);color:var(--red)}
    .pill-value{font-size:22px;font-weight:700;margin:6px 0}
    .pill-desc{font-size:11px;color:var(--muted);line-height:1.4;margin-top:8px;
      padding-top:8px;border-top:1px solid rgba(255,255,255,.06)}
    .pill-action{font-size:11px;font-weight:600;margin-top:6px;padding:6px;background:rgba(255,255,255,.02);
      border-radius:6px}
    .stale-indicator{font-size:10px;color:var(--amber);margin-top:4px}
    .tabs{display:flex;gap:8px;border-bottom:2px solid rgba(255,255,255,.06);margin:20px 0}
    .tab{background:transparent;border:none;color:var(--muted);padding:12px 20px;cursor:pointer;
      font-size:14px;font-weight:600;position:relative}
    .tab:hover{color:var(--text)}
    .tab.active{color:var(--accent)}
    .tab.active::after{content:"";position:absolute;bottom:-2px;left:0;right:0;height:2px;
      background:var(--accent)}
    .tab-content{display:none}
    .tab-content.active{display:block}
    .chart-container{height:320px;margin:16px 0}
    .heatmap{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:12px}
    .heat-cell{background:rgba(255,255,255,.03);padding:16px;border-radius:10px;border-left:4px solid}
    .heat-cell.rag-green{border-left-color:var(--green)}
    .heat-cell.rag-amber{border-left-color:var(--amber)}
    .heat-cell.rag-red{border-left-color:var(--red)}
    .heat-label{font-size:13px;font-weight:600;margin-bottom:6px}
    .heat-value{font-size:26px;font-weight:700;margin:6px 0}
    .heat-status{font-size:11px;color:var(--muted)}
    .loading{text-align:center;padding:40px;color:var(--muted)}
    .error{background:rgba(255,96,112,.1);border:1px solid rgba(255,96,112,.3);padding:20px;
      border-radius:var(--radius);margin:20px 0;color:#ff9da6}
    @media (max-width:768px){
      .gauge-section{justify-content:center}
      .pills{grid-template-columns:1fr}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>⚡ Economic Crash Radar Pro</h1>
      <div class="subtitle">Real-time market stress monitoring with forward-looking risk assessment</div>
    </header>
    <main id="app"><div class="loading">Loading economic data...</div></main>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <script>
    'use strict';

    const CONFIG = {
      CACHE_PATH: 'data/fred_cache.json',
      INDICATORS: {
        T10Y3M: {
          label: 'Yield Curve', format: v => v?.toFixed(2) + '%', weight: 0.18,
          desc: '10Y-3M Treasury spread. Inverted curves (negative) precede recessions by 6-18 months.',
          thresholds: { green: [0.5, 99], amber: [-0.5, 0.5], red: [-99, -0.5] },
          actions: { green: 'Normal yield curve', amber: 'Flattening - monitor closely', red: 'Inverted - recession risk elevated' }
        },
        CREDIT: {
          label: 'Credit Spread', format: v => v?.toFixed(2) + '%', weight: 0.14,
          desc: 'High-yield bond spread. Widening = rising default risk. >7% signals credit stress.',
          thresholds: { green: [-99, 4.5], amber: [4.5, 7.0], red: [7.0, 99] },
          actions: { green: 'Healthy credit markets', amber: 'Watch for deterioration', red: 'Credit stress - avoid junk bonds' }
        },
        UN_SLOPE6: {
          label: 'Unemployment Trend', format: v => (v >= 0 ? '+' : '') + v?.toFixed(2) + '%', weight: 0.12,
          desc: '6-month unemployment change. Sahm Rule: >0.5% rise triggers recession signal.',
          thresholds: { green: [-99, 0.15], amber: [0.15, 0.35], red: [0.35, 99] },
          actions: { green: 'Stable employment', amber: 'Softening labor market', red: 'Recession likely started' }
        },
        DD_12M: {
          label: 'Market Drawdown', format: v => ((v ?? 0) * 100).toFixed(1) + '%', weight: 0.20,
          desc: 'S&P 500 from peak. -10% = correction, -20% = bear market.',
          thresholds: { green: [-5, 0], amber: [-15, -5], red: [-99, -15] },
          actions: { green: 'Near all-time highs', amber: 'Correction underway', red: 'Bear market - reduce risk' }
        },
        NFCI: {
          label: 'Financial Conditions', format: v => v?.toFixed(2), weight: 0.12,
          desc: 'Chicago Fed NFCI. >0 = tight conditions. Sharp rises precede downturns.',
          thresholds: { green: [-99, -0.20], amber: [-0.20, 0.30], red: [0.30, 99] },
          actions: { green: 'Easy conditions', amber: 'Tightening', red: 'Financial stress rising' }
        },
        VIX_PROXY: {
          label: 'Volatility (VIX)', format: v => v?.toFixed(1), weight: 0.10,
          desc: 'Fear gauge. <15 = calm, 20-30 = elevated, >30 = panic.',
          thresholds: { green: [-99, 20], amber: [20, 30], red: [30, 99] },
          actions: { green: 'Low volatility', amber: 'Rising fear', red: 'Market panic' }
        },
        RETAIL_MOMENTUM: {
          label: 'Retail Sales', format: v => ((v ?? 0) * 100).toFixed(2) + '%', weight: 0.08,
          desc: 'Consumer spending (70% of GDP). Negative = weakening demand.',
          thresholds: { green: [0.01, 99], amber: [-0.01, 0.01], red: [-99, -0.01] },
          actions: { green: 'Strong spending', amber: 'Stalling', red: 'Consumer retrenchment' }
        },
        SENTIMENT: {
          label: 'Consumer Confidence', format: v => v?.toFixed(1), weight: 0.06,
          desc: 'U. Michigan sentiment. <80 = pessimistic. Sharp drops precede recessions.',
          thresholds: { green: [90, 999], amber: [70, 90], red: [-99, 70] },
          actions: { green: 'Optimistic', amber: 'Cautious', red: 'Fearful consumers' }
        }
      }
    };

    const Utils = {
      parse: v => {
        if (v == null || v === '.' || v === 'NaN') return null;
        const n = +v;
        return isFinite(n) ? n : null;
      },
      map01: (v, good, bad) => {
        if (v == null) return 50;
        return Math.max(0, Math.min(100, ((v - good) / (bad - good)) * 100));
      },
      rag: (v, t) => {
        if (!t || v == null) return 'amber';
        if (v >= t.red[0] && v <= t.red[1]) return 'red';
        if (v >= t.amber[0] && v <= t.amber[1]) return 'amber';
        return 'green';
      }
    };

    const SCALE = {
      T10Y3M: v => Utils.map01(v, 1.0, -2.0),
      CREDIT: v => Utils.map01(v, 3.0, 8.0),
      UN_SLOPE6: v => Utils.map01(v, 0.05, 0.50),
      DD_12M: v => Utils.map01(v, 0, -0.20),
      NFCI: v => Utils.map01(v, -0.80, 0.40),
      VIX_PROXY: v => Utils.map01(v, 12, 35),
      RETAIL_MOMENTUM: v => Utils.map01(v, 0.03, -0.02),
      SENTIMENT: v => Utils.map01(v, 110, 70)
    };

    class DataService {
      static async load() {
        const res = await fetch(`${CONFIG.CACHE_PATH}?t=${Date.now()}`, { cache: 'no-store' });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        return this.normalize(await res.json());
      }

      static normalize(raw) {
        if (!raw) return {};
        if (raw.observations) return { DEFAULT: raw };
        if (Array.isArray(raw?.series)) {
          const out = {};
          for (const s of raw.series) {
            const id = s.id || s.series_id || s.name;
            if (id) out[id] = { observations: s.observations || s.data || [], fetchedAt: s.fetchedAt };
          }
          return out;
        }
        return raw;
      }

      static latest(series) {
        const obs = series?.observations || [];
        if (!obs.length) return null;
        const o = obs[obs.length - 1];
        return { value: Utils.parse(o.value), date: o.date };
      }

      static ageDays(series) {
        const l = this.latest(series);
        if (!l) return 999;
        return Math.round((Date.now() - new Date(l.date + 'T00:00:00Z')) / 86400000);
      }
    }

    class Processor {
      static map(cache) {
        const out = {};
        for (const k of Object.keys(CONFIG.INDICATORS)) {
          if (cache[k]) out[k] = cache[k];
        }
        if (!out.CREDIT && cache.BAMLH0A0HYM2) out.CREDIT = cache.BAMLH0A0HYM2;
        if (!out.VIX_PROXY && cache.VIXCLS) out.VIX_PROXY = cache.VIXCLS;
        if (!out.SENTIMENT && cache.UMCSENT) out.SENTIMENT = cache.UMCSENT;
        
        // Derive UN_SLOPE6
        if (!out.UN_SLOPE6 && cache.UNRATE) {
          const obs = cache.UNRATE.observations || [];
          const byMonth = {};
          for (const o of obs) {
            const v = Utils.parse(o.value);
            if (v != null) byMonth[o.date.slice(0, 7)] = v;
          }
          const months = Object.keys(byMonth).sort();
          const derived = [];
          for (let i = 6; i < months.length; i++) {
            const delta = byMonth[months[i]] - byMonth[months[i - 6]];
            derived.push({ date: months[i] + '-01', value: String(delta) });
          }
          out.UN_SLOPE6 = { observations: derived, fetchedAt: cache.UNRATE.fetchedAt };
        }
        
        // Derive DD_12M
        if (!out.DD_12M && cache.SP500) {
          const obs = cache.SP500.observations || [];
          const vals = obs.map(o => Utils.parse(o.value));
          const derived = [];
          for (let i = 0; i < vals.length; i++) {
            let peak = -Infinity;
            for (let j = Math.max(0, i - 252); j <= i; j++) {
              if (vals[j] != null) peak = Math.max(peak, vals[j]);
            }
            if (vals[i] != null && peak > 0) {
              derived.push({ date: obs[i].date, value: String(vals[i] / peak - 1) });
            }
          }
          out.DD_12M = { observations: derived, fetchedAt: cache.SP500.fetchedAt };
        }
        
        // Derive RETAIL_MOMENTUM
        if (!out.RETAIL_MOMENTUM && cache.RSAFS) {
          const obs = cache.RSAFS.observations || [];
          if (obs.length >= 2) {
            const last = Utils.parse(obs[obs.length - 1].value);
            const prev = Utils.parse(obs[obs.length - 2].value);
            if (last != null && prev != null && prev !== 0) {
              out.RETAIL_MOMENTUM = {
                observations: [{ date: obs[obs.length - 1].date, value: String(last / prev - 1) }],
                fetchedAt: cache.RSAFS.fetchedAt
              };
            }
          }
        }
        
        return out;
      }

      static compute(dataMap) {
        let num = 0, den = 0;
        const parts = [];
        
        for (const [k, cfg] of Object.entries(CONFIG.INDICATORS)) {
          const s = dataMap[k];
          if (!s?.observations?.length) continue;
          
          const l = DataService.latest(s);
          if (!l || l.value == null) continue;
          
          const age = DataService.ageDays(s);
          const scaled = SCALE[k](l.value);
          const w = cfg.weight * (age <= 30 ? 1.0 : 0.8);
          
          if (isFinite(scaled) && isFinite(w)) {
            num += scaled * w;
            den += w;
          }
          
          const rag = Utils.rag(l.value, cfg.thresholds);
          
          parts.push({
            key: k,
            label: cfg.label,
            value: l.value,
            display: cfg.format(l.value),
            scaled,
            rag,
            age,
            desc: cfg.desc,
            action: cfg.actions[rag]
          });
        }
        
        return { parts, composite: den > 0 ? num / den : 50 };
      }
    }

    class UI {
      constructor() {
        this.app = document.getElementById('app');
        this.charts = {};
      }

      render(data) {
        const { parts, composite } = data;
        const zone = composite <= 30 ? 'green' : composite <= 60 ? 'amber' : 'red';
        const regimeName = { green: 'Normal', amber: 'Stressed', red: 'Crisis' }[zone];
        const regimeColor = { green: '#1ec28b', amber: '#ffc247', red: '#ff6070' }[zone];
        
        // Calculate risks
        const base = x => 1 / (1 + Math.exp(-(x - 50) / 10));
        const p1m = Math.round(base(composite) * 70 * 100);
        const p3m = Math.round(base(composite) * 95 * 100);
        const p6m = Math.round(base(composite) * 120 * 100);
        
        // Calculate confidence
        const fresh = parts.filter(p => p.age <= 30).length;
        const confidence = Math.round((fresh / parts.length) * 100);
        
        this.app.innerHTML = `
          <div class="card">
            <div class="gauge-section">
              <div class="gauge">
                <div class="gauge-ring"></div>
                <div class="gauge-needle" style="--angle:${(composite / 100) * 360}deg"></div>
                <div class="gauge-score">${Math.round(composite)}</div>
              </div>
              <div class="gauge-info">
                <h2>Market Stress Index: ${Math.round(composite)}/100</h2>
                <div style="color:var(--muted);margin-bottom:12px">
                  Composite of ${parts.length} weighted economic indicators
                </div>
                
                <div class="info-box">
                  <div style="font-weight:700;margin-bottom:4px">Data Confidence: ${confidence}%</div>
                  This measures data freshness and completeness. ${confidence >= 80 ? 'High confidence - all indicators current.' : confidence >= 60 ? 'Moderate confidence - some stale data.' : 'Low confidence - significant data staleness.'}
                  ${fresh < parts.length ? ` ${parts.length - fresh} indicator(s) need updating.` : ''}
                </div>
                
                <div class="regime-box">
                  <div class="regime-header">
                    <div class="regime-dot" style="background:${regimeColor}"></div>
                    <div class="regime-title">${regimeName} Regime</div>
                  </div>
                  <div class="regime-desc">
                    ${zone === 'green' ? 'Economic fundamentals are stable. Normal market volatility expected. Risk indicators within historical norms.' :
                      zone === 'amber' ? 'Elevated stress detected across multiple indicators. Increased probability of market volatility and economic softening. Monitor closely for deterioration.' :
                      'Critical stress levels. Multiple recession indicators triggered. High probability of significant market downturn and/or economic contraction in progress.'}
                  </div>
                  <div class="regime-actions">
                    ${parts.filter(p => p.rag === 'red').map(p => 
                      `<div class="regime-action"><div class="action-title">⚠️ ${p.label}</div>${p.action}</div>`
                    ).join('')}
                    ${parts.filter(p => p.rag === 'red').length === 0 ? '<div class="regime-action"><div class="action-title">✓ No Critical Alerts</div>Continue monitoring key indicators</div>' : ''}
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="card">
            <h3 style="margin-bottom:16px">Forward Risk Horizon</h3>
            <div class="risk-grid">
              <div class="risk-card">
                <div class="risk-title">1-Month Risk</div>
                <div class="risk-value">${p1m}%</div>
                <div class="risk-desc">
                  Probability of >10% market drawdown within 30 days based on current stress levels and short-term momentum.
                </div>
                <div class="risk-detail">
                  <strong>What it means:</strong> ${p1m < 20 ? 'Low near-term risk' : p1m < 40 ? 'Elevated volatility expected' : 'High crash probability'}
                </div>
              </div>
              <div class="risk-card">
                <div class="risk-title">3-Month Risk</div>
                <div class="risk-value">${p3m}%</div>
                <div class="risk-desc">
                  Probability of sustained correction (>15% decline) within next quarter incorporating medium-term trend deterioration.
                </div>
                <div class="risk-detail">
                  <strong>What it means:</strong> ${p3m < 25 ? 'Markets likely stable' : p3m < 50 ? 'Correction possible' : 'High correction risk'}
                </div>
              </div>
              <div class="risk-card">
                <div class="risk-title">6-Month Risk</div>
                <div class="risk-value">${p6m}%</div>
                <div class="risk-desc">
                  Probability of bear market (>20% decline) or recession within 6 months based on historical deterioration patterns.
                </div>
                <div class="risk-detail">
                  <strong>What it means:</strong> ${p6m < 30 ? 'Low recession risk' : p6m < 60 ? 'Elevated recession risk' : 'Recession likely'}
                </div>
              </div>
            </div>
          </div>

          <div class="tabs">
            <button class="tab active" onclick="app.showTab('indicators')">Live Indicators</button>
            <button class="tab" onclick="app.showTab('heatmap')">Heat Map</button>
          </div>

          <div id="tab-indicators" class="tab-content active">
            <div class="card">
              <h3 style="margin-bottom:16px">Individual Indicator Status</h3>
              <div class="pills">
                ${parts.map(p => `
                  <div class="pill rag-${p.rag}">
                    <div class="pill-header">
                      <div class="pill-title">${p.label}</div>
                      <div class="pill-status status-${p.rag}">${p.rag.toUpperCase()}</div>
                    </div>
                    <div class="pill-value">${p.display}</div>
                    <div class="pill-desc">${p.desc}</div>
                    <div class="pill-action" style="color:${p.rag === 'green' ? 'var(--green)' : p.rag === 'amber' ? 'var(--amber)' : 'var(--red)'}">${p.action}</div>
                    ${p.age > 30 ? `<div class="stale-indicator">⚠️ Data ${p.age} days old</div>` : ''}
                  </div>
                `).join('')}
              </div>
            </div>
          </div>

          <div id="tab-heatmap" class="tab-content">
            <div class="card">
              <h3 style="margin-bottom:16px">Indicator Heat Map</h3>
              <div class="heatmap">
                ${parts.map(p => `
                  <div class="heat-cell rag-${p.rag}">
                    <div class="heat-label">${p.label}</div>
                    <div class="heat-value">${p.display}</div>
                    <div class="heat-status">${Utils.rag(p.value, CONFIG.INDICATORS[p.key].thresholds).toUpperCase()} - ${p.action}</div>
                  </div>
                `).join('')}
              </div>
            </div>
          </div>
        `;
      }

      showTab(name) {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        event.target.classList.add('active');
        document.getElementById('tab-' + name).classList.add('active');
      }

      error(msg) {
        this.app.innerHTML = `<div class="error"><h3>⚠️ Error Loading Data</h3><p>${msg}</p></div>`;
      }
    }

    const app = new UI();

    (async () => {
      try {
        const cache = await DataService.load();
        const dataMap = Processor.map(cache);
        const result = Processor.compute(dataMap);
        app.render(result);
      } catch (err) {
        console.error(err);
        app.error(err.message || 'Failed to load data');
      }
    })();
  </script>

</body>
</html>
