<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Economic Crash Radar Pro</title>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    :root {
      --bg:#0a0e1a;
      --panel:#12182b;
      --panel-soft:#151b30;
      --text:#e8eeff;
      --muted:#8b96b0;
      --accent:#6b9eff;
      --accent-soft:#8fb4ff;
      --green:#1ec28b;
      --amber:#ffc247;
      --red:#ff6070;
      --purple:#a78bfa;
      --cyan:#22d3ee;
      --radius-lg:16px;
      --radius-md:12px;
      --radius-sm:8px;
      --shadow-soft:0 8px 24px rgba(0,0,0,0.45);
      --border-subtle:1px solid rgba(255,255,255,0.06);
      --gap-xs:6px;
      --gap-sm:10px;
      --gap-md:16px;
      --gap-lg:22px;
      --gap-xl:30px;
      --transition-fast:0.18s ease-out;
    }

    * {
      box-sizing:border-box;
      margin:0;
      padding:0;
    }

    body {
      background: radial-gradient(circle at top, #151b30 0, #050813 44%, #020309 100%);
      color:var(--text);
      font-family:-apple-system,BlinkMacSystemFont,"SF Pro Text","Segoe UI",system-ui,sans-serif;
      -webkit-font-smoothing:antialiased;
      line-height:1.6;
    }

    .wrap {
      max-width:1600px;
      margin:0 auto;
      padding:18px 14px 40px;
    }

    header {
      display:flex;
      flex-wrap:wrap;
      align-items:flex-end;
      justify-content:space-between;
      gap:var(--gap-md);
      margin-bottom:var(--gap-lg);
    }

    .title-block h1 {
      font-size:clamp(26px,4.2vw,40px);
      font-weight:600;
      letter-spacing:0.03em;
      text-transform:uppercase;
      display:flex;
      align-items:center;
      gap:10px;
    }

    .title-pill {
      font-size:10px;
      padding:3px 7px;
      border-radius:999px;
      border:1px solid rgba(107,158,255,0.6);
      color:var(--accent-soft);
      text-transform:uppercase;
    }

    .subtitle {
      font-size:13px;
      color:var(--muted);
      margin-top:3px;
    }

    .meta {
      display:flex;
      flex-direction:column;
      gap:4px;
      font-size:11px;
      color:var(--muted);
      align-items:flex-end;
    }

    .badge {
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:4px 9px;
      border-radius:999px;
      font-size:10px;
      background:rgba(18,24,43,0.96);
      border:1px solid rgba(139,150,176,0.35);
    }

    .badge span.dot {
      width:7px;
      height:7px;
      border-radius:50%;
      background:#22c55e;
      box-shadow:0 0 8px rgba(34,197,94,0.9);
    }

    main {
      display:grid;
      grid-template-columns: minmax(0,2.2fr) minmax(260px,1.4fr);
      gap:var(--gap-lg);
    }

    @media (max-width:960px) {
      main {
        display:flex;
        flex-direction:column;
      }
      header {
        align-items:flex-start;
      }
      .meta {
        align-items:flex-start;
      }
    }

    /* Left: composite + charts */

    .panel {
      background:radial-gradient(circle at top, rgba(111,143,255,0.05) 0, rgba(5,8,19,0.98) 55%);
      border-radius:var(--radius-lg);
      padding:var(--gap-md);
      border:var(--border-subtle);
      box-shadow:var(--shadow-soft);
      position:relative;
      overflow:hidden;
    }

    .panel-header {
      display:flex;
      justify-content:space-between;
      align-items:baseline;
      gap:var(--gap-md);
      margin-bottom:var(--gap-md);
    }

    .panel-title {
      font-size:14px;
      font-weight:500;
      text-transform:uppercase;
      letter-spacing:0.12em;
      color:var(--accent-soft);
    }

    .panel-sub {
      font-size:11px;
      color:var(--muted);
    }

    .primary-score {
      display:flex;
      align-items:flex-end;
      gap:10px;
      margin-bottom:var(--gap-md);
    }

    .primary-score-value {
      font-size:32px;
      font-weight:600;
    }

    .primary-score-label {
      font-size:11px;
      color:var(--muted);
      text-transform:uppercase;
      letter-spacing:0.14em;
    }

    .primary-score-pill {
      padding:4px 9px;
      border-radius:999px;
      font-size:10px;
      display:inline-flex;
      align-items:center;
      gap:6px;
      background:rgba(6,10,24,0.96);
      border:1px solid rgba(255,255,255,0.06);
      color:var(--muted);
    }

    .primary-score-pill span.indicator-dot {
      width:7px;
      height:7px;
      border-radius:50%;
      background:var(--green);
    }

    .gauge-wrap {
      position:relative;
      margin:4px 0 14px;
      height:150px;
    }

    .gauge-labels {
      display:flex;
      justify-content:space-between;
      font-size:9px;
      color:var(--muted);
      text-transform:uppercase;
      letter-spacing:0.12em;
      margin-bottom:4px;
    }

    .horizon-row {
      display:flex;
      flex-wrap:wrap;
      gap:6px;
      font-size:9px;
      margin-top:4px;
      color:var(--muted);
    }

    .horizon-pill {
      padding:3px 7px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,0.04);
      background:rgba(10,14,26,0.96);
    }

    .tabs {
      display:flex;
      gap:8px;
      margin:2px 0 8px;
      font-size:10px;
    }

    .tab-btn {
      padding:4px 8px;
      border-radius:999px;
      border:1px solid transparent;
      background:transparent;
      color:var(--muted);
      cursor:pointer;
      transition:var(--transition-fast);
      font-size:10px;
    }

    .tab-btn.active {
      background:rgba(20,32,66,0.96);
      border-color:rgba(107,158,255,0.7);
      color:var(--accent-soft);
    }

    .chart-wrap {
      margin-top:4px;
      height:160px;
    }

    /* Right: indicators grid */

    .indicators-panel {
      display:flex;
      flex-direction:column;
      gap:var(--gap-md);
    }

    .indicators-grid {
      display:grid;
      grid-template-columns:repeat(2, minmax(0,1fr));
      gap:8px;
    }

    @media (max-width:640px) {
      .indicators-grid {
        grid-template-columns:repeat(2,minmax(0,1fr));
      }
    }

    .indicator-card {
      background:radial-gradient(circle at top left, rgba(107,158,255,0.06) 0, rgba(9,13,25,0.98) 52%);
      border-radius:var(--radius-md);
      padding:6px 7px 7px;
      border:1px solid rgba(255,255,255,0.05);
      display:flex;
      flex-direction:column;
      gap:1px;
      min-height:40px;
      position:relative;
      overflow:hidden;
      cursor:default;
    }

    .indicator-label {
      font-size:9px;
      color:var(--muted);
      text-transform:uppercase;
      letter-spacing:0.11em;
    }

    .indicator-main {
      display:flex;
      align-items:baseline;
      gap:4px;
    }

    .indicator-value {
      font-size:15px;
      font-weight:500;
    }

    .indicator-unit {
      font-size:9px;
      color:var(--muted);
    }

    .indicator-status {
      font-size:8px;
      padding:1px 5px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,0.06);
      align-self:flex-start;
      margin-top:1px;
    }

    .indicator-fresh {
      font-size:7px;
      color:var(--muted);
    }

    .rag-green { color:var(--green); border-color:rgba(30,194,139,0.4);}
    .rag-amber { color:var(--amber); border-color:rgba(255,194,71,0.4);}
    .rag-red { color:var(--red); border-color:rgba(255,96,112,0.4);}

    .indicator-missing {
      color:var(--red);
      font-size:8px;
      margin-top:2px;
    }

    .audit-panel {
      background:var(--panel-soft);
      border-radius:var(--radius-md);
      padding:7px;
      border:var(--border-subtle);
      font-size:8px;
      color:var(--muted);
      display:flex;
      flex-direction:column;
      gap:3px;
    }

    .audit-panel strong {
      color:var(--accent-soft);
      font-weight:500;
    }

    a {
      color:var(--accent-soft);
      text-decoration:none;
    }
  </style>
</head>
<body>
<div class="wrap">
  <header>
    <div class="title-block">
      <div class="title-pill">CrashRadar Pro · Institutional Macro Monitor</div>
      <h1>Economic Crash Radar Pro</h1>
      <div class="subtitle">
        Composite stress signal from yield curve, credit, ISM, housing, labour, sentiment &amp; liquidity.
      </div>
    </div>
    <div class="meta">
      <div class="badge">
        <span class="dot"></span>
        <span>Live FRED cache reader</span>
      </div>
      <div>Cache source: <code>data/fred_cache.json</code></div>
      <div id="metaGenerated">Cache: --</div>
      <div id="metaStatus">Status: waiting for data…</div>
    </div>
  </header>

  <main>
    <!-- LEFT: Composite + charts -->
    <section class="panel" id="compositePanel">
      <div class="panel-header">
        <div>
          <div class="panel-title">Composite Fragility Index</div>
          <div class="panel-sub">
            0 = calm · 100 = crisis. Auto-built only from data present in fred_cache.json.
          </div>
        </div>
      </div>

      <div class="primary-score">
        <div>
          <div class="primary-score-label">Current composite risk</div>
          <div class="primary-score-value" id="compositeScore">--</div>
        </div>
        <div class="primary-score-pill" id="compositeTag">
          <span class="indicator-dot"></span>
          <span>Awaiting data</span>
        </div>
      </div>

      <div class="gauge-labels">
        <span>Subdued</span>
        <span>Elevated</span>
        <span>Severe</span>
      </div>
      <div class="gauge-wrap">
        <canvas id="gaugeCanvas"></canvas>
      </div>

      <div class="horizon-row" id="horizonRow">
        <!-- filled by JS -->
      </div>

      <div class="tabs">
        <button class="tab-btn active" data-tab="lead">Lead stress</button>
        <button class="tab-btn" data-tab="coincident">Real economy</button>
        <button class="tab-btn" data-tab="markets">Market & liquidity</button>
      </div>

      <div class="chart-wrap">
        <canvas id="decompChart"></canvas>
      </div>
    </section>

    <!-- RIGHT: Indicators + audit -->
    <section class="indicators-panel">
      <div class="panel-header">
        <div>
          <div class="panel-title">Key Indicators</div>
          <div class="panel-sub">Each tile reads directly from fred_cache.json; missing = our fault, not yours.</div>
        </div>
      </div>

      <div class="indicators-grid" id="indicatorsGrid">
        <!-- indicator cards via JS -->
      </div>

      <div class="audit-panel" id="auditPanel">
        <strong>Data audit</strong>
        <div id="auditSummary">Awaiting cache load…</div>
        <div id="missingList"></div>
      </div>
    </section>
  </main>
</div>

<script>
  // ---------- CONFIG: keep this in sync with fetch_fred.js REQUIRED_SERIES ----------

  const FRED_CACHE_PATH = "data/fred_cache.json";

  // Indicator definitions:
  // - id: FRED series id in fred_cache.json
  // - group: lead / coincident / markets (for tabs & decomp)
  // - invert: if true, higher = safer (we flip when scoring risk)
  // - thresholds: simple RAG bands for tile colouring (design choice)
  const INDICATOR_CONFIG = {
    T10Y3M: {
      label: "10Y-3M Curve",
      id: "T10Y3M",
      group: "lead",
      invert: false,
      unit: "pp",
      thresholds: { green: 0.5, amber: 0, red: -0.25 },
      note: "Inverted curve = stress"
    },
    BAMLH0A0HYM2: {
      label: "HY Credit OAS",
      id: "BAMLH0A0HYM2",
      group: "markets",
      invert: false,
      unit: "pp",
      thresholds: { green: 3.0, amber: 4.5, red: 6.0 },
      note: "Wider = stress"
    },
    NAPMNOI: {
      label: "ISM New Orders",
      id: "NAPMNOI",
      group: "lead",
      invert: false,
      unit: "",
      thresholds: { green: 52, amber: 48, red: 45 },
      note: "Manufacturing lead (NAPMNOI)"
    },
    UMCSENT: {
      label: "Consumer Sentiment",
      id: "UMCSENT",
      group: "coincident",
      invert: false,
      unit: "",
      thresholds: { green: 70, amber: 60, red: 50 }
    },
    M2SL: {
      label: "M2 (level)",
      id: "M2SL",
      group: "markets",
      invert: null,
      unit: "bn",
      ignoreInComposite: true
    },
    ICSA: {
      label: "Initial Claims",
      id: "ICSA",
      group: "coincident",
      invert: false,
      unit: "",
      thresholds: { green: 300000, amber: 350000, red: 450000 }
    },
    UNRATE: {
      label: "Unemployment Rate",
      id: "UNRATE",
      group: "coincident",
      invert: false,
      unit: "%",
      thresholds: { green: 5, amber: 6, red: 7 }
    },
    SAHMREALTIME: {
      label: "Sahm Rule",
      id: "SAHMREALTIME",
      group: "coincident",
      invert: false,
      unit: "pp",
      thresholds: { green: 0.5, amber: 0.75, red: 0.99 }
    },
    INDPRO: {
      label: "Industrial Production",
      id: "INDPRO",
      group: "coincident",
      invert: null,
      unit: "",
      ignoreInComposite: true
    },
    AWHMAN: {
      label: "Weekly Hours (Mfg)",
      id: "AWHMAN",
      group: "lead",
      invert: false,
      unit: "hrs",
      thresholds: { green: 40, amber: 39, red: 38 }
    },
    USSLIND: {
      label: "US Leading Index",
      id: "USSLIND",
      group: "lead",
      invert: false,
      unit: "",
      thresholds: { green: 0.2, amber: -0.1, red: -0.4 }
    },
    PERMIT: {
      label: "Building Permits",
      id: "PERMIT",
      group: "lead",
      invert: false,
      unit: "k",
      thresholds: { green: 1300, amber: 1100, red: 900 }
    },
    HOUST: {
      label: "Housing Starts",
      id: "HOUST",
      group: "lead",
      invert: false,
      unit: "k",
      thresholds: { green: 1300, amber: 1100, red: 900 }
    },
    NFCI: {
      label: "Financial Conditions",
      id: "NFCI",
      group: "markets",
      invert: true,
      unit: "",
      thresholds: { green: 0, amber: 0.3, red: 0.6 }
    },
    TEDRATE: {
      label: "TED Spread",
      id: "TEDRATE",
      group: "markets",
      invert: false,
      unit: "pp",
      thresholds: { green: 0.4, amber: 0.75, red: 1.0 }
    },
    TDSP: {
      label: "Term Spread Proxy",
      id: "TDSP",
      group: "lead",
      invert: false,
      unit: "pp",
      thresholds: { green: 0.75, amber: 0.25, red: 0 }
    },
    VIXCLS: {
      label: "VIX",
      id: "VIXCLS",
      group: "markets",
      invert: false,
      unit: "",
      thresholds: { green: 15, amber: 22, red: 30 }
    }
  };

  const REQUIRED_IDS = Object.values(INDICATOR_CONFIG).map(d => d.id);

  // ---------- UTILITIES ----------

  function getSeries(cache, id) {
    if (!cache || !cache.series) return null;
    return cache.series[id] || null;
  }

  function getLatestPoint(series) {
    if (!series) return null;

    if (typeof series.value === "number") {
      // Use convenience field if present; we still trust observations for date if needed
      if (Array.isArray(series.observations) && series.observations.length) {
        for (let i = series.observations.length - 1; i >= 0; i--) {
          const v = series.observations[i].value;
          if (v !== null && !Number.isNaN(v)) {
            return { value: series.value, date: series.observations[i].date };
          }
        }
      }
      return { value: series.value, date: series.last_updated || null };
    }

    if (!Array.isArray(series.observations) || !series.observations.length) {
      return null;
    }
    for (let i = series.observations.length - 1; i >= 0; i--) {
      const v = series.observations[i].value;
      if (v !== null && !Number.isNaN(v)) {
        return { value: v, date: series.observations[i].date };
      }
    }
    return null;
  }

  function classifyRAG(cfg, value) {
    if (value == null || !cfg || !cfg.thresholds) return { cls: "", label: "N/A" };
    const t = cfg.thresholds;

    // Design choice: thresholds assume "normal" direction; if invert == true,
    // we flip interpretation for composite, but RAG shown is simple banding.
    if (value >= t.red && t.red > t.amber && t.amber > t.green) {
      // Not using that pattern here; keep explicit below.
      return { cls: "", label: "" };
    }

    // Most of ours: green < amber < red for risk (non-inverted)
    if (cfg.id === "T10Y3M" || cfg.id === "TDSP") {
      // More negative = worse
      if (value <= t.red) return { cls: "rag-red", label: "Inverted" };
      if (value <= t.amber) return { cls: "rag-amber", label: "Flat" };
      return { cls: "rag-green", label: "Normal" };
    }

    if (cfg.id === "BAMLH0A0HYM2" || cfg.id === "TEDRATE" || cfg.id === "VIXCLS") {
      if (value >= t.red) return { cls: "rag-red", label: "Stressed" };
      if (value >= t.amber) return { cls: "rag-amber", label: "Elevated" };
      return { cls: "rag-green", label: "Calm" };
    }

    if (cfg.id === "NAPMNOI") {
      if (value <= t.red) return { cls: "rag-red", label: "Contraction" };
      if (value <= t.amber) return { cls: "rag-amber", label: "Soft" };
      if (value >= t.green) return { cls: "rag-green", label: "Expansion" };
      return { cls: "", label: "" };
    }

    if (cfg.id === "UMCSENT") {
      if (value <= t.red) return { cls: "rag-red", label: "Recessionary" };
      if (value <= t.amber) return { cls: "rag-amber", label: "Weak" };
      if (value >= t.green) return { cls: "rag-green", label: "Strong" };
      return { cls: "", label: "" };
    }

    if (cfg.id === "ICSA") {
      if (value >= t.red) return { cls: "rag-red", label: "Surging" };
      if (value >= t.amber) return { cls: "rag-amber", label: "Rising" };
      return { cls: "rag-green", label: "Contained" };
    }

    if (cfg.id === "UNRATE") {
      if (value >= t.red) return { cls: "rag-red", label: "High" };
      if (value >= t.amber) return { cls: "rag-amber", label: "Drifting up" };
      return { cls: "rag-green", label: "Low" };
    }

    if (cfg.id === "SAHMREALTIME") {
      if (value >= t.red) return { cls: "rag-red", label: "Trigger" };
      if (value >= t.amber) return { cls: "rag-amber", label: "Watch" };
      return { cls: "rag-green", label: "No trigger" };
    }

    if (cfg.id === "NFCI") {
      // negative = loose, positive = tight
      if (value >= t.red) return { cls: "rag-red", label: "Tight" };
      if (value >= t.amber) return { cls: "rag-amber", label: "Less easy" };
      return { cls: "rag-green", label: "Easy" };
    }

    return { cls: "", label: "" };
  }

  // Composite: crude but transparent equal-weight scoring of selected indicators.
  function computeComposite(cache) {
    let total = 0;
    let count = 0;

    for (const key in INDICATOR_CONFIG) {
      const cfg = INDICATOR_CONFIG[key];
      if (cfg.ignoreInComposite) continue;
      const s = getSeries(cache, cfg.id);
      const pt = getLatestPoint(s);
      if (!pt) continue;

      const v = pt.value;
      let score = 50; // neutral

      // Basic rules – design, not prophecy.
      switch (cfg.id) {
        case "T10Y3M":
          if (v <= -0.75) score = 95;
          else if (v <= -0.25) score = 80;
          else if (v <= 0) score = 65;
          else score = 35;
          break;
        case "BAMLH0A0HYM2":
          if (v >= 6) score = 95;
          else if (v >= 4.5) score = 80;
          else if (v >= 3) score = 60;
          else score = 35;
          break;
        case "NAPMNOI":
          if (v <= 45) score = 90;
          else if (v <= 48) score = 70;
          else if (v < 52) score = 55;
          else score = 35;
          break;
        case "UMCSENT":
          if (v <= 50) score = 80;
          else if (v <= 60) score = 65;
          else if (v >= 70) score = 40;
          else score = 50;
          break;
        case "ICSA":
          if (v >= 450000) score = 95;
          else if (v >= 350000) score = 75;
          else score = 40;
          break;
        case "UNRATE":
          if (v >= 7) score = 90;
          else if (v >= 6) score = 70;
          else if (v <= 4) score = 40;
          else score = 55;
          break;
        case "SAHMREALTIME":
          if (v >= 0.5) score = 95;
          else if (v >= 0.3) score = 75;
          else score = 40;
          break;
        case "PERMIT":
        case "HOUST":
          if (v <= 900) score = 80;
          else if (v <= 1100) score = 65;
          else score = 45;
          break;
        case "NFCI":
          if (v >= 0.6) score = 90;
          else if (v >= 0.3) score = 70;
          else if (v <= -0.5) score = 40;
          else score = 55;
          break;
        case "TEDRATE":
          if (v >= 1) score = 85;
          else if (v >= 0.75) score = 70;
          else score = 45;
          break;
        case "VIXCLS":
          if (v >= 30) score = 90;
          else if (v >= 22) score = 70;
          else score = 40;
          break;
        default:
          score = 50;
      }

      total += score;
      count++;
    }

    if (!count) return null;

    const avg = total / count;
    return Math.round(avg);
  }

  function horizonRisk(composite) {
    if (composite == null) return { "3m": "--", "6m": "--", "12m": "--" };
    // Simple mapping: higher composite → higher short-term risk
    const base = composite / 100;
    const clamp = x => Math.max(0, Math.min(99, Math.round(x)));
    return {
      "3m": clamp(base * 90),
      "6m": clamp(base * 80),
      "12m": clamp(base * 65)
    };
  }

  // ---------- RENDERING ----------

  let gaugeChart, decompChart;

  function renderIndicators(cache) {
    const grid = document.getElementById("indicatorsGrid");
    grid.innerHTML = "";

    REQUIRED_IDS.forEach(id => {
      const cfg = Object.values(INDICATOR_CONFIG).find(c => c.id === id);
      const card = document.createElement("div");
      card.className = "indicator-card";

      const label = document.createElement("div");
      label.className = "indicator-label";
      label.textContent = cfg ? cfg.label : id;
      card.appendChild(label);

      const s = getSeries(cache, id);
      const pt = getLatestPoint(s);

      const main = document.createElement("div");
      main.className = "indicator-main";

      const valEl = document.createElement("div");
      valEl.className = "indicator-value";

      const unitEl = document.createElement("div");
      unitEl.className = "indicator-unit";

      if (!s || !pt) {
        valEl.textContent = "--";
        const miss = document.createElement("div");
        miss.className = "indicator-missing";
        miss.textContent = "Missing in fred_cache.json";
        card.appendChild(main);
        main.appendChild(valEl);
        card.appendChild(miss);
      } else {
        let display = pt.value;
        if (cfg && (cfg.id === "PERMIT" || cfg.id === "HOUST")) {
          display = (pt.value / 1).toFixed(0); // thousands in reality; keep raw for now
        } else if (cfg && cfg.id === "ICSA") {
          display = pt.value.toLocaleString("en-US");
        } else if (cfg && (cfg.id === "T10Y3M" || cfg.id === "TDSP" || cfg.id === "TEDRATE")) {
          display = pt.value.toFixed(2);
        } else if (cfg && cfg.id === "BAMLH0A0HYM2") {
          display = pt.value.toFixed(2);
        } else if (cfg && cfg.id === "VIXCLS") {
          display = pt.value.toFixed(1);
        } else if (cfg && cfg.id === "NFCI") {
          display = pt.value.toFixed(2);
        } else if (cfg && cfg.id === "NAPMNOI") {
          display = pt.value.toFixed(1);
        } else if (cfg && (cfg.id === "UMCSENT" || cfg.id === "UNRATE" || cfg.id === "SAHMREALTIME")) {
          display = pt.value.toFixed(1);
        } else {
          display = (typeof pt.value === "number") ? pt.value.toFixed(2) : pt.value;
        }

        valEl.textContent = display;
        unitEl.textContent = cfg && cfg.unit ? cfg.unit : "";

        main.appendChild(valEl);
        main.appendChild(unitEl);

        const status = document.createElement("div");
        const rag = classifyRAG(cfg, pt.value);
        status.className = "indicator-status " + rag.cls;
        status.textContent = rag.label || "OK";

        const fresh = document.createElement("div");
        fresh.className = "indicator-fresh";
        fresh.textContent = pt.date ? `Last: ${pt.date}` : `Updated: ${s.last_updated || "n/a"}`;

        card.appendChild(main);
        card.appendChild(status);
        card.appendChild(fresh);
      }

      grid.appendChild(card);
    });
  }

  function renderGauge(score) {
    const ctx = document.getElementById("gaugeCanvas").getContext("2d");
    if (gaugeChart) gaugeChart.destroy();

    const value = score == null ? 0 : score;
    const norm = Math.max(0, Math.min(100, value));

    gaugeChart = new Chart(ctx, {
      type: "doughnut",
      data: {
        labels: ["Risk", ""],
        datasets: [{
          data: [norm, 100 - norm],
          borderWidth:0,
          cutout:"72%",
          circumference:180,
          rotation:270,
          backgroundColor:[
            norm < 40 ? "#1ec28b" : (norm < 70 ? "#ffc247" : "#ff6070"),
            "rgba(40,48,80,0.6)"
          ]
        }]
      },
      options: {
        responsive:true,
        maintainAspectRatio:false,
        plugins:{ legend:{ display:false }, tooltip:{ enabled:false } }
      }
    });
  }

  function renderDecomp(cache) {
    const ctx = document.getElementById("decompChart").getContext("2d");
    if (decompChart) decompChart.destroy();

    const labels = [];
    const data = [];
    const bg = [];

    Object.keys(INDICATOR_CONFIG).forEach(key => {
      const cfg = INDICATOR_CONFIG[key];
      if (cfg.ignoreInComposite) return;
      const s = getSeries(cache, cfg.id);
      const pt = getLatestPoint(s);
      if (!pt) return;

      labels.push(cfg.label);
      const rag = classifyRAG(cfg, pt.value);
      let val = 50;
      if (rag.cls === "rag-green") val = 30;
      else if (rag.cls === "rag-amber") val = 65;
      else if (rag.cls === "rag-red") val = 90;
      data.push(val);

      if (rag.cls === "rag-green") bg.push("rgba(30,194,139,0.82)");
      else if (rag.cls === "rag-amber") bg.push("rgba(255,194,71,0.88)");
      else if (rag.cls === "rag-red") bg.push("rgba(255,96,112,0.9)");
      else bg.push("rgba(139,150,176,0.6)");
    });

    decompChart = new Chart(ctx, {
      type:"bar",
      data:{
        labels,
        datasets:[{
          data,
          borderWidth:0,
          backgroundColor:bg
        }]
      },
      options:{
        responsive:true,
        maintainAspectRatio:false,
        indexAxis:"y",
        scales:{
          x:{ display:false, min:0, max:100 },
          y:{ ticks:{ color:"#8b96b0", font:{ size:8 } }, grid:{ display:false } }
        },
        plugins:{ legend:{ display:false }, tooltip:{ enabled:false } }
      }
    });
  }

  function renderHorizon(score) {
    const row = document.getElementById("horizonRow");
    row.innerHTML = "";
    const hr = horizonRisk(score);
    ["3m","6m","12m"].forEach(k => {
      const d = document.createElement("div");
      d.className = "horizon-pill";
      d.textContent = `${k.toUpperCase()} crash risk: ${hr[k]}%`;
      row.appendChild(d);
    });
  }

  function renderComposite(score) {
    const el = document.getElementById("compositeScore");
    const tag = document.getElementById("compositeTag");

    if (score == null) {
      el.textContent = "--";
      tag.innerHTML = '<span class="indicator-dot"></span><span>No composite (missing data)</span>';
      return;
    }

    el.textContent = score;
    let label = "Calm";
    let color = "var(--green)";

    if (score >= 75) { label = "Severe stress"; color = "var(--red)"; }
    else if (score >= 55) { label = "Elevated"; color = "var(--amber)"; }

    tag.innerHTML = `<span class="indicator-dot" style="background:${color}"></span><span>${label}</span>`;
  }

  function renderAudit(cache) {
    const auditSummary = document.getElementById("auditSummary");
    const missingList = document.getElementById("missingList");

    if (!cache || !cache.series) {
      auditSummary.textContent = "Cache failed to load or has no 'series' key.";
      missingList.textContent = "Check data/fred_cache.json and GitHub Action logs.";
      return;
    }

    const present = [];
    const missing = [];

    REQUIRED_IDS.forEach(id => {
      if (cache.series[id]) present.push(id);
      else missing.push(id);
    });

    auditSummary.textContent =
      `Present: ${present.length}/${REQUIRED_IDS.length}. Missing: ${missing.length}.`;

    if (missing.length) {
      missingList.textContent =
        "Missing series: " + missing.join(", ") + ". If NAPMNOI is here, ISM will render; if not, fix fetch_fred.js.";
      document.getElementById("metaStatus").textContent = "Status: MISSING SERIES – see console/audit.";
    } else {
      missingList.textContent = "All required series found.";
    }
  }

  // ---------- INIT ----------

  async function init() {
    try {
      const res = await fetch(FRED_CACHE_PATH, { cache: "no-store" });
      if (!res.ok) {
        throw new Error(`HTTP ${res.status} loading fred_cache.json`);
      }
      const cache = await res.json();

      document.getElementById("metaGenerated").textContent =
        `Cache generated_at: ${cache.generated_at || "n/a"}`;
      document.getElementById("metaStatus").textContent = "Status: cache loaded.";

      renderIndicators(cache);

      const composite = computeComposite(cache);
      renderComposite(composite);
      renderGauge(composite);
      renderDecomp(cache);
      renderHorizon(composite);
      renderAudit(cache);

      console.log("CrashRadar init complete. Composite:", composite);
    } catch (err) {
      console.error("Init error:", err);
      document.getElementById("metaStatus").textContent =
        "Status: FAILED TO LOAD fred_cache.json (see console).";
      document.getElementById("auditSummary").textContent =
        "Could not load fred_cache.json. Check path /data/fred_cache.json and GitHub Action.";
    }

    // Tabs (simple filter: this demo keeps one decomp; you can extend if needed)
    document.querySelectorAll(".tab-btn").forEach(btn => {
      btn.addEventListener("click", () => {
        document.querySelectorAll(".tab-btn").forEach(b => b.classList.remove("active"));
        btn.classList.add("active");
      });
    });
  }

  document.addEventListener("DOMContentLoaded", init);
</script>
</body>
</html>
