<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Economic Crash Radar Pro – DEBUG MODE</title>

  <!-- CSS -->
  <link rel="stylesheet" href="css/main.css" />

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <!-- GitHub Pages base path fix -->
  <script>
    window.__APP_BASE = "";
  </script>
</head>

<body>

<!-- ============================================================
     DEBUG DIAGNOSTICS PANEL (full version)
============================================================ -->
<div id="debug-panel" style="
  background:#111;
  color:#f0f0f0;
  font-family: monospace;
  padding:16px;
  border-bottom:2px solid #444;
  line-height:1.5;
  white-space:pre-line;
">
  <h2 style="margin:0 0 12px;font-size:22px;">CrashRadar Diagnostics</h2>
  <div id="debug-output">Running diagnostics…</div>
</div>

<script type="module">
async function runDiagnostics() {
  const out = document.getElementById('debug-output');
  const log = msg => out.innerHTML += msg + "\n";

  out.innerHTML = "";

  /* -----------------------------------------------------
     1. DOM CHECKS
  ----------------------------------------------------- */
  log("1. Checking required DOM IDs…");

  const requiredIDs = [
    "gauge-container","needle","risk-fill","regime-label",
    "tier1-indicators","tier2-indicators",
    "valuation-indicators","contrib-list",
    "composite-history","risk-radar","data-audit"
  ];

  for (const id of requiredIDs) {
    const ok = document.getElementById(id);
    if (ok) log("✔️ " + id);
    else log("❌ MISSING: " + id);
  }

  /* -----------------------------------------------------
     2. CONFIG
  ----------------------------------------------------- */
  log("\n2. Loading config.js…");

  try {
    const cfg = await import('./js/config.js');
    if (!cfg.INDICATOR_CONFIG) log("❌ INDICATOR_CONFIG missing");
    else log("✔️ Loaded INDICATOR_CONFIG (" + Object.keys(cfg.INDICATOR_CONFIG).length + " items)");

    if (!cfg.VALUATION_CONFIG) log("❌ VALUATION_CONFIG missing");
    else log("✔️ Loaded VALUATION_CONFIG (" + Object.keys(cfg.VALUATION_CONFIG).length + " items)");

  } catch(e) {
    log("❌ Error loading config.js → " + e.message);
  }

  /* -----------------------------------------------------
     3. dataService + fred_cache.json
  ----------------------------------------------------- */
  log("\n3. Checking dataService.js + fred_cache.json…");

  try {
    const ds = await import('./js/dataService.js');
    log("✔️ dataService.js loaded");

    const resp = await fetch('data/fred_cache.json', {cache:'no-store'});

    if (!resp.ok) {
      log("❌ Cannot load data/fred_cache.json (HTTP " + resp.status + ")");
    } else {
      const json = await resp.json();
      const series = json.series ? Object.keys(json.series).length : 0;
      log("✔️ fred_cache.json loaded (" + series + " series)");

      const requiredSeries = [
        "T10Y3M","BAMLH0A0HYM2","UMCSENT","NFCI",
        "ICSA","SAHMREALTIME","INDPRO","PERMIT","M2SL"
      ];

      requiredSeries.forEach(id => {
        if (json.series && json.series[id]) log("✔️ FRED OK: " + id);
        else log("❌ MISSING series: " + id);
      });
    }

  } catch (e) {
    log("❌ dataService or JSON load failed → " + e.message);
  }

  /* -----------------------------------------------------
     4. scoring.js
  ----------------------------------------------------- */
  log("\n4. Checking scoring.js…");

  try {
    const scoring = await import('./js/scoring.js');
    if (!scoring.computeComposite) log("❌ computeComposite missing");
    else log("✔️ scoring.js OK");
  } catch(e) {
    log("❌ scoring.js load failed → " + e.message);
  }

  /* -----------------------------------------------------
     5. uiIndicators.js
  ----------------------------------------------------- */
  log("\n5. Checking uiIndicators.js…");

  try {
    const ui = await import('./js/uiIndicators.js');
    log(ui.renderMacroIndicators ? "✔️ renderMacroIndicators" : "❌ renderMacroIndicators missing");
    log(ui.renderValuationIndicators ? "✔️ renderValuationIndicators" : "❌ renderValuationIndicators missing");
  } catch(e) {
    log("❌ uiIndicators load failed → " + e.message);
  }

  /* -----------------------------------------------------
     6. uiCharts.js
  ----------------------------------------------------- */
  log("\n6. Checking uiCharts.js…");

  try {
    const charts = await import('./js/uiCharts.js');
    log(charts.updateCompositeHistoryChart ? "✔️ composite history OK" : "❌ updateCompositeHistoryChart missing");
    log(charts.updateRiskRadarChart ? "✔️ radar OK" : "❌ updateRiskRadarChart missing");
  } catch(e) {
    log("❌ uiCharts.js load failed → " + e.message);
  }

  /* -----------------------------------------------------
     7. uiAudit.js
  ----------------------------------------------------- */
  log("\n7. Checking uiAudit.js…");

  try {
    const audit = await import('./js/uiAudit.js');
    log(audit.updateDataAudit ? "✔️ updateDataAudit present" : "❌ updateDataAudit missing");
  } catch(e) {
    log("❌ uiAudit.js load failed → " + e.message);
  }

  /* -----------------------------------------------------
     8. Chart.js
  ----------------------------------------------------- */
  log("\n8. Checking Chart.js…");

  if (window.Chart) log("✔️ Chart.js available");
  else log("❌ Chart.js NOT loaded");

  /* -----------------------------------------------------
     9. app.js load test
  ----------------------------------------------------- */
  log("\n9. Checking app.js…");

  try {
    await import('./js/app.js');
    log("✔️ app.js loaded successfully");
  } catch(e) {
    log("❌ app.js load failed → " + e.message);
  }

  log("\nDiagnostics complete.");
}

runDiagnostics();
</script>

<!-- ============================================================
     YOUR NORMAL APP
============================================================ -->

<div class="container">

  <header class="card" style="margin-top: 24px;">
    <h1>Economic Crash Radar Pro</h1>

    <div class="header-row">
      <span id="cache-badge" class="contrib-tag">FRED cache: --</span>

      <div class="button-group">
        <button id="refresh-data" class="btn">Refresh Data</button>
        <button id="reset-inputs" class="btn-secondary">Reset Inputs</button>
        <button id="show-help" class="btn-secondary">Help</button>
      </div>
    </div>
  </header>

  <section class="card">
    <h2>Composite Stress</h2>

    <div id="gauge-container"></div>
    <div id="needle"></div>
    <div id="risk-fill"></div>
    <div id="regime-label">COMPOSITE STRESS — --</div>

    <div class="risk-row">
      <div><div class="contrib-tag">Recession</div><div id="recession-risk-display">--</div></div>
      <div><div class="contrib-tag">Valuation</div><div id="valuation-risk-display">--</div></div>
      <div><div class="contrib-tag">Labor</div><div id="labor-risk-display">--</div></div>
    </div>
  </section>

  <section class="card">
    <h2>Interpretation</h2>
    <p id="insight-text">Loading…</p>
  </section>

  <section class="card">
    <h2>Macro Indicators</h2>
    <h3>Tier 1</h3>
    <div id="tier1-indicators"></div>
    <h3 style="margin-top:24px;">Tier 2</h3>
    <div id="tier2-indicators"></div>
  </section>

  <section class="card">
    <h2>Valuation Indicators</h2>
    <div id="valuation-indicators"></div>
    <div class="valuation-summary">
      <div id="current-buffett-label">Buffett: --</div>
      <div id="current-cape-label">CAPE: --</div>
    </div>
  </section>

  <section class="card">
    <h2>What's Driving the Score?</h2>
    <div id="contrib-list"></div>
  </section>

  <section class="card">
    <h2>Composite Stress History</h2>
    <canvas id="composite-history" height="200"></canvas>
  </section>

  <section class="card">
    <h2>Radar — Normalised Stress</h2>
    <canvas id="risk-radar" height="180"></canvas>
  </section>

  <section class="card" id="data-audit">
    <h2>Data Quality & Staleness</h2>
  </section>

</div>

<div id="loading-overlay" class="loading-overlay">
  <div id="loading-text" class="loading-text">Loading…</div>
</div>

<div id="indicator-tooltip"></div>

<script type="module" src="js/app.js"></script>

</body>
</html>
