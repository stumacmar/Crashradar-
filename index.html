<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="description" content="Advanced Economic Crash Radar with predictive analytics and multi-timeframe analysis" />
  <title>Economic Crash Radar Pro</title>

  <style>
    :root{
      --bg:#0a0e1a; --panel:#12182b; --panel-hover:#151d33; --muted:#8b96b0;
      --text:#e8eeff; --accent:#6b9eff; --accent-bright:#8fb4ff;
      --green:#1ec28b; --amber:#ffc247; --red:#ff6070; --orange:#ff8c42;
      --radius:14px; --shadow:0 4px 24px rgba(0,0,0,.3);
      --ring:200px; --ring-m:160px;
    }
    *{box-sizing:border-box}
    html,body{margin:0;background:var(--bg);color:var(--text);
      font:15px/1.6 -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Inter,Helvetica,Arial,sans-serif}
    .wrap{max-width:1400px;margin:0 auto;padding:20px 16px 80px}

    header{margin-bottom:24px}
    h1{font-size:clamp(32px,5vw,48px);line-height:1.1;margin:0 0 8px;
      background:linear-gradient(135deg,var(--text),var(--accent-bright));
      -webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
    .subtitle{color:var(--muted);font-size:15px;margin:8px 0}

    .card{background:var(--panel);border-radius:var(--radius);padding:24px;margin:20px 0;
      box-shadow:var(--shadow),0 0 0 1px rgba(255,255,255,.04) inset;transition:transform .2s,box-shadow .2s}
    .card:hover{transform:translateY(-2px);box-shadow:0 6px 32px rgba(0,0,0,.4)}

    /* Gauge */
    .gauge-container{display:flex;align-items:center;gap:32px;flex-wrap:wrap}
    .gauge-wrap{position:relative;width:var(--ring);height:var(--ring)}
    .multi-ring{position:absolute;inset:0}
    .ring{position:absolute;border-radius:50%;transition:opacity .3s}
    .ring-outer{inset:0;background:conic-gradient(var(--green)0 108deg,var(--amber)108deg 216deg,var(--red)216deg 360deg);opacity:.3}
    .ring-mid{inset:15px;background:conic-gradient(var(--green)0 108deg,var(--amber)108deg 216deg,var(--red)216deg 360deg);opacity:.5}
    .ring-inner{inset:30px;background:conic-gradient(var(--green)0 108deg,var(--amber)108deg 216deg,var(--red)216deg 360deg)}
    .ring::after{content:"";position:absolute;inset:20px;border-radius:50%;background:var(--panel)}
    .needle{position:absolute;inset:0;transition:transform .6s cubic-bezier(.34,1.56,.64,1)}
    .needle::before{content:"";position:absolute;top:50%;left:50%;width:4px;height:45%;
      background:linear-gradient(180deg,var(--accent-bright),var(--accent));
      transform:translateX(-50%) translateY(-100%) rotate(var(--angle,0deg));
      transform-origin:bottom center;border-radius:4px;box-shadow:0 0 12px var(--accent)}
    .needle::after{content:"";position:absolute;top:50%;left:50%;width:16px;height:16px;background:var(--accent-bright);
      border-radius:50%;transform:translate(-50%,-50%);box-shadow:0 0 16px var(--accent),0 0 0 3px var(--panel)}
    .score{position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;font-weight:800;font-size:48px;line-height:1}
    .score-label{font-size:12px;font-weight:600;color:var(--muted);margin-top:4px;letter-spacing:.5px}

    .gauge-info h2{font-size:28px;margin:0 0 8px;font-weight:700}
    .confidence{display:inline-flex;align-items:center;gap:8px;background:rgba(107,158,255,.15);padding:6px 12px;border-radius:8px;font-size:13px;font-weight:600;margin-top:8px}
    .confidence-bar{width:60px;height:6px;background:rgba(255,255,255,.1);border-radius:3px;overflow:hidden}
    .confidence-fill{height:100%;background:var(--accent);border-radius:3px;transition:width .3s}

    .pills-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:12px}
    .pill{background:rgba(255,255,255,.03);border:1px solid rgba(255,255,255,.06);padding:14px 16px;border-radius:12px;transition:all .2s;cursor:pointer}
    .pill:hover{background:rgba(255,255,255,.06);border-color:rgba(255,255,255,.12);transform:translateY(-2px)}
    .pill-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px}
    .pill-title{font-weight:600;font-size:13px}
    .pill-badge{font-size:11px;padding:3px 8px;border-radius:6px;font-weight:600}
    .pill-value{font-size:20px;font-weight:700;margin:4px 0}
    .pill-change{font-size:12px;color:var(--muted);display:flex;align-items:center;gap:4px}
    .badge-fresh{background:rgba(30,194,139,.15);color:var(--green)}
    .badge-stale{background:rgba(255,194,71,.15);color:var(--amber)}
    .badge-old{background:rgba(255,96,112,.15);color:var(--red)}

    .chart-container{position:relative;height:320px;margin:16px 0}
    .chart-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;flex-wrap:wrap;gap:12px}
    .chart-title{font-size:18px;font-weight:600;margin:0}
    .chart-controls{display:flex;gap:8px}
    .btn-group{display:flex;gap:4px;background:rgba(255,255,255,.03);padding:4px;border-radius:8px}
    .btn{background:transparent;border:none;color:var(--muted);padding:6px 14px;border-radius:6px;cursor:pointer;font-size:13px;font-weight:500;transition:all .2s}
    .btn:hover{color:var(--text);background:rgba(255,255,255,.06)}
    .btn.active{background:var(--accent);color:#fff}

    .tabs{display:flex;gap:8px;border-bottom:2px solid rgba(255,255,255,.06);margin-bottom:20px;overflow-x:auto}
    .tab{background:transparent;border:none;color:var(--muted);padding:12px 20px;cursor:pointer;font-size:14px;font-weight:600;position:relative;white-space:nowrap}
    .tab:hover{color:var(--text)}
    .tab.active{color:var(--accent-bright)}
    .tab.active::after{content:"";position:absolute;bottom:-2px;left:0;right:0;height:2px;background:var(--accent)}
    .tab-content{display:none}
    .tab-content.active{display:block}

    .status{display:inline-flex;align-items:center;gap:8px;padding:8px 14px;border-radius:8px;font-weight:600;font-size:13px}
    .status-dot{width:8px;height:8px;border-radius:50%}

    .heatmap{display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:10px}
    .heat-cell{background:rgba(255,255,255,.03);padding:14px;border-radius:10px;border:1px solid rgba(255,255,255,.06)}
    .heat-label{font-size:12px;color:var(--muted)}
    .heat-value{font-size:22px;font-weight:700}
    .bar{height:6px;border-radius:4px;background:rgba(255,255,255,.08);overflow:hidden;margin-top:8px}
    .bar > span{display:block;height:100%;border-radius:4px}

    .audit{font-size:12px;color:var(--muted);margin-top:8px}
    .audit .bad{color:#ff9da6}
    .audit .warn{color:#ffc247}

    @media (max-width:768px){
      .gauge-container{justify-content:center;text-align:center}
      .gauge-wrap{width:var(--ring-m);height:var(--ring-m)}
      .score{font-size:36px}
      .pills-grid{grid-template-columns:1fr}
      .chart-header{flex-direction:column;align-items:flex-start}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>âš¡ Economic Crash Radar Pro</h1>
      <div class="subtitle">Advanced multi-timeframe market stress analysis with predictive analytics</div>
      <div id="statusBadge"></div>
      <div id="auditBox" class="audit"></div>
    </header>

    <main>
      <!-- Gauge -->
      <section class="card">
        <div class="gauge-container">
          <div class="gauge-wrap">
            <div class="multi-ring">
              <div class="ring ring-outer"></div>
              <div class="ring ring-mid"></div>
              <div class="ring ring-inner"></div>
            </div>
            <div id="needle" class="needle"></div>
            <div class="score"><div id="scoreText">--</div><div class="score-label">COMPOSITE</div></div>
          </div>

          <div class="gauge-info">
            <h2>Market Stress Index</h2>
            <div style="color:var(--muted);font-size:14px;margin-bottom:8px">
              Real-time composite of <span id="indicatorCount">8</span> economic indicators
            </div>
            <div class="confidence">
              <span>Confidence:</span>
              <div class="confidence-bar"><div id="confidenceFill" class="confidence-fill" style="width:85%"></div></div>
              <span id="confidenceText">85%</span>
            </div>
            <div id="regimeIndicator" class="regime"></div>
            <div class="prob-display" style="display:flex;gap:16px;margin-top:16px;flex-wrap:wrap">
              <div class="prob-item" style="flex:1;min-width:140px;background:rgba(255,255,255,.03);padding:12px;border-radius:10px;border:1px solid rgba(255,255,255,.06)">
                <h4 style="margin:0 0 4px;font-size:11px;color:var(--muted);letter-spacing:.5px;text-transform:uppercase">1-Month Risk</h4>
                <div class="prob-value" id="prob1m" style="font-size:24px;font-weight:700;color:var(--accent-bright)">--</div>
              </div>
              <div class="prob-item" style="flex:1;min-width:140px;background:rgba(255,255,255,.03);padding:12px;border-radius:10px;border:1px solid rgba(255,255,255,.06)">
                <h4 style="margin:0 0 4px;font-size:11px;color:var(--muted);letter-spacing:.5px;text-transform:uppercase">3-Month Risk</h4>
                <div class="prob-value" id="prob3m" style="font-size:24px;font-weight:700;color:var(--accent-bright)">--</div>
              </div>
              <div class="prob-item" style="flex:1;min-width:140px;background:rgba(255,255,255,.03);padding:12px;border-radius:10px;border:1px solid rgba(255,255,255,.06)">
                <h4 style="margin:0 0 4px;font-size:11px;color:var(--muted);letter-spacing:.5px;text-transform:uppercase">6-Month Risk</h4>
                <div class="prob-value" id="prob6m" style="font-size:24px;font-weight:700;color:var(--accent-bright)">--</div>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- Indicator Pills -->
      <section class="card">
        <h3 style="margin:0 0 16px;font-size:20px">ðŸ“Š Live Indicators</h3>
        <div id="pillsGrid" class="pills-grid"></div>
      </section>

      <!-- Tabs -->
      <div class="tabs">
        <button class="tab active" onclick="switchTab(event, 'composite')">Composite</button>
        <button class="tab" onclick="switchTab(event, 'scenarios')">Scenarios</button>
        <button class="tab" onclick="switchTab(event, 'indicators')">Indicators</button>
        <button class="tab" onclick="switchTab(event, 'analogs')">Analogs</button>
      </div>

      <div id="tab-composite" class="tab-content active">
        <section class="card">
          <div class="chart-header">
            <h3 class="chart-title">Composite Risk Score</h3>
            <div class="chart-controls">
              <div class="btn-group">
                <button class="btn active" data-tf="1m">1M</button>
                <button class="btn" data-tf="3m">3M</button>
                <button class="btn" data-tf="6m">6M</button>
                <button class="btn" data-tf="1y">1Y</button>
                <button class="btn" data-tf="all">ALL</button>
              </div>
            </div>
          </div>
          <div class="chart-container"><canvas id="compositeChart"></canvas></div>
        </section>

        <section class="card">
          <h3 style="margin:0 0 16px">Risk Decomposition</h3>
          <div class="chart-container"><canvas id="decompChart"></canvas></div>
        </section>
      </div>

      <div id="tab-scenarios" class="tab-content">
        <section class="card">
          <h3 style="margin:0 0 8px">Forward-Looking Scenarios</h3>
          <p style="color:var(--muted);margin:0 0 16px;font-size:14px">Probability-weighted forecasts</p>
          <div id="scenarioGrid" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:16px;margin-top:16px"></div>
        </section>

        <section class="card">
          <h3 style="margin:0 0 16px">Risk Trajectory</h3>
          <div class="chart-container"><canvas id="trajectoryChart"></canvas></div>
        </section>
      </div>

      <div id="tab-indicators" class="tab-content">
        <section class="card">
          <h3 style="margin:0 0 16px">Indicator Heat Map</h3>
          <div id="heatmap" class="heatmap"></div>
        </section>
      </div>

      <div id="tab-analogs" class="tab-content">
        <section class="card">
          <h3 style="margin:0 0 8px">Similar Historical Periods</h3>
          <p style="color:var(--muted);margin:0 0 16px;font-size:14px">Compared to past market regimes</p>
          <div id="analogList" class="analog-list"></div>
        </section>
      </div>
    </main>
  </div>

  <!-- Chart libs -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3.1.1/dist/chartjs-plugin-annotation.min.js"></script>

  <script>
    /* ===================== CONFIG ===================== */
    const FRED_CACHE_PATH = 'data/fred_cache.json';

    // Core indicators used by the composite
    const INDICATORS = {
      T10Y3M:          { label:'Yield Curve',         format:v=>v?.toFixed(2),               weight:0.18, cadence:'daily'   },
      CREDIT:          { label:'Credit Spread',       format:v=>v?.toFixed(2),               weight:0.14, cadence:'daily'   },
      UN_SLOPE6:       { label:'Unemployment Î”',      format:v=>v?.toFixed(2),               weight:0.12, cadence:'monthly' },
      DD_12M:          { label:'Market Drawdown',     format:v=>((v??0)*100).toFixed(1)+'%', weight:0.20, cadence:'daily'   },
      NFCI:            { label:'Financial Conditions',format:v=>v?.toFixed(3),               weight:0.12, cadence:'weekly'  },
      VIX_PROXY:       { label:'Volatility Index',    format:v=>v?.toFixed(1),               weight:0.10, cadence:'daily'   },
      RETAIL_MOMENTUM: { label:'Retail Sales Î”',      format:v=>(v*100)?.toFixed(2)+'%',     weight:0.08, cadence:'monthly' },
      SENTIMENT:       { label:'Consumer Confidence', format:v=>v?.toFixed(1),               weight:0.06, cadence:'monthly' }
    };

    // Scaling 0(good)->100(bad)
    const clamp = x => Math.max(0, Math.min(100, x));
    const map01 = (val, good, bad) => {
      if (val == null) return 50;
      const denom = bad - good;
      if (Math.abs(denom) < 1e-9) return 50;
      return ((val - good) / denom) * 100;
    };
    const SCALE = {
      T10Y3M:          v => clamp(map01(v,  1.0, -2.0)),
      CREDIT:          v => clamp(map01(v,  0.30, 1.00)),
      UN_SLOPE6:       v => clamp(map01(v,  0.05, 0.50)),
      DD_12M:          v => clamp(map01(v,  0.00, -0.20)),
      NFCI:            v => clamp(map01(v, -0.80, 0.40)),
      VIX_PROXY:       v => clamp(map01(v,  12,  35)),
      RETAIL_MOMENTUM: v => clamp(map01(v,  0.03, -0.02)),
      SENTIMENT:       v => clamp(map01(v, 110,  70))
    };
    const FRESH_LIMITS = { daily:{ok:7,warn:30}, weekly:{ok:7,warn:30}, monthly:{ok:30,warn:60} };
    const zoneOf = s => s <= 30 ? 'green' : (s <= 60 ? 'amber' : 'red');

    const els = {
      statusBadge:  document.getElementById('statusBadge'),
      auditBox:     document.getElementById('auditBox'),
      scoreText:    document.getElementById('scoreText'),
      needle:       document.getElementById('needle'),
      indicatorCount: document.getElementById('indicatorCount'),
      regimeIndicator: document.getElementById('regimeIndicator'),
      prob1m: document.getElementById('prob1m'),
      prob3m: document.getElementById('prob3m'),
      prob6m: document.getElementById('prob6m'),
      pillsGrid: document.getElementById('pillsGrid'),
      heatmap: document.getElementById('heatmap'),
      scenarioGrid: document.getElementById('scenarioGrid')
    };

    function setStatus(zone, text){
      const colors = {green:'#1ec28b', amber:'#ffc247', red:'#ff6070'};
      els.statusBadge.innerHTML = `
        <div class="status" style="background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.08)">
          <span class="status-dot" style="background:${colors[zone]||'#8fb4ff'}"></span>
          <span>${text}</span>
        </div>`;
    }
    function setErrorStatus(errText){
      els.statusBadge.innerHTML = `
        <div class="status" style="background:rgba(255,96,112,.12);border:1px solid rgba(255,96,112,.4)">
          <span class="status-dot" style="background:#ff6070"></span>
          <span>Data error: ${errText}</span>
        </div>`;
    }
    function setGauge(score){
      els.scoreText.textContent = Math.round(score);
      const angle = (score/100)*360;
      els.needle.style.setProperty('--angle', angle+'deg');
    }
    function pillHTML({key,label,valueDisp,change,freshClass,freshTxt}){
      const arrow = change==null?'' : (change>0?'â–²':'â–¼');
      const changeTxt = change==null?'' : `${(change>0?'+':'')}${change.toFixed(2)}`;
      return `
        <div class="pill" data-key="${key}">
          <div class="pill-header">
            <div class="pill-title">${label}</div>
            <div class="pill-badge ${freshClass}">${freshTxt}</div>
          </div>
          <div class="pill-value">${valueDisp}</div>
          <div class="pill-change"><span class="trend-arrow">${arrow}</span>${changeTxt}</div>
        </div>`;
    }
    function mkLine(ctx, labels, data){
      return new Chart(ctx, {
        type:'line',
        data:{ labels, datasets:[{label:'Composite', data, borderWidth:2, fill:false, tension:0.25}] },
        options:{ responsive:true, plugins:{legend:{display:false}}, scales:{x:{display:false}, y:{min:0,max:100}} }
      });
    }
    function mkBar(ctx, labels, data){
      return new Chart(ctx, {
        type:'bar',
        data:{ labels, datasets:[{label:'Contribution', data, borderWidth:1}] },
        options:{ responsive:true, plugins:{legend:{display:false}}, scales:{y:{beginAtZero:true,max:Math.max(10,Math.ceil(Math.max(...data,10)/10)*10)}} }
      });
    }
    function heatColor(score){
      const r = Math.round(255 * (score/100));
      const g = Math.round(200 * (1-score/100));
      return `rgb(${r},${g},80)`;
    }

    /* ========= DATA LOAD + NORMALIZE ========= */
    async function loadFredCache(){
      const res = await fetch(`${FRED_CACHE_PATH}?t=${Date.now()}`, { cache:'no-store' });
      if(!res.ok) throw new Error(`FRED cache: HTTP ${res.status}`);
      const raw = await res.json();
      return normalizeCache(raw);
    }
    function normalizeCache(raw){
      const out = {};
      const directLike = raw && typeof raw === 'object' &&
        Object.keys(raw).some(k => raw[k] && Array.isArray(raw[k].observations));
      if (directLike) return raw;

      if (Array.isArray(raw?.series)) {
        for (const item of raw.series) {
          const id = item?.id || item?.series_id || item?.name;
          if (!id) continue;
          const obs = Array.isArray(item.observations) ? item.observations
                    : Array.isArray(item.data) ? item.data : [];
          out[id] = { observations: obs, fetchedAt: item.fetchedAt };
        }
        return out;
      }
      if (raw && raw.series && typeof raw.series === 'object' && !Array.isArray(raw.series)) {
        for (const [id,item] of Object.entries(raw.series)) {
          const obs = Array.isArray(item?.observations) ? item.observations
                    : Array.isArray(item?.data) ? item.data : [];
          out[id] = { observations: obs, fetchedAt: item.fetchedAt };
        }
        return out;
      }
      if (Array.isArray(raw)) {
        for (const item of raw) {
          const id = item?.id || item?.series_id || item?.name;
          if (!id) continue;
          const obs = Array.isArray(item.observations) ? item.observations
                    : Array.isArray(item.data) ? item.data : [];
          out[id] = { observations: obs, fetchedAt: item.fetchedAt };
        }
      }
      return out;
    }

    /* ========= DERIVED SERIES ========= */
    function latest(series){
      const obs = series?.observations||[];
      if(!obs.length) return null;
      const o = obs[obs.length-1];
      const v = (o.value==null || o.value==='.' || o.value==='NaN') ? null : +o.value;
      return {value:v, date:o.date};
    }
    function seriesAgeDays(series, fetchedAt){
      const L = latest(series);
      if(!L) return Infinity;
      const d = new Date(L.date + 'T00:00:00Z');
      return Math.max(0, Math.round((new Date(fetchedAt || Date.now()) - d) / 86400000));
    }
    function deriveUnempSlope6(UNRATE){
      const obs = UNRATE?.observations||[];
      if(!obs.length) return null;
      const byMonth = {};
      for(const o of obs){ const v=+o.value; if(isFinite(v)) byMonth[o.date.slice(0,7)] = v; }
      const months = Object.keys(byMonth).sort();
      if(months.length<7) return null;
      const out = [];
      for(let i=6;i<months.length;i++){
        const m = months[i], prev = months[i-6];
        const delta = byMonth[m] - byMonth[prev];
        const [yy,mm] = m.split('-').map(Number);
        const d = new Date(Date.UTC(yy, mm, 0));
        out.push({date: d.toISOString().slice(0,10), value: String(delta)});
      }
      return { observations: out, fetchedAt: UNRATE.fetchedAt };
    }
    function deriveDrawdown12m(SP500){
      const obs = SP500?.observations||[];
      if(!obs.length) return null;
      const dates = obs.map(o=>o.date), vals = obs.map(o=>+o.value);
      const peak = [];
      for(let i=0;i<vals.length;i++){
        const start = Math.max(0, i-252);
        let p = -Infinity;
        for(let j=start;j<=i;j++) p = Math.max(p, vals[j]);
        peak.push(p);
      }
      const dd = dates.map((d,i)=>({date:d, value:String(vals[i]/peak[i]-1)}));
      return { observations: dd, fetchedAt: SP500.fetchedAt };
    }
    function deriveRetailMomentum(RSAFS){
      const o = RSAFS?.observations||[];
      if(o.length<2) return null;
      const last = +o[o.length-1].value;
      let prev = null;
      for(let i=o.length-2;i>=0;i--){ const v = +o[i].value; if(isFinite(v)){ prev=v; break; } }
      if(prev==null || prev===0) return null;
      return { observations:[{date:o[o.length-1].date, value:String(last/prev-1)}], fetchedAt: RSAFS.fetchedAt };
    }

    /* ========= MAP CACHE â†’ INDICATORS ========= */
    function mapIndicatorsFromCache(cache){
      const out = {};
      for(const k of Object.keys(INDICATORS)){ if(cache[k]) out[k]=cache[k]; }
      // Fallbacks by common FRED IDs
      if(!out.CREDIT && (cache.BAMLH0A0HYM2 || cache.BAA10YM)) out.CREDIT = cache.BAMLH0A0HYM2 || cache.BAA10YM;
      if(!out.VIX_PROXY && cache.VIXCLS) out.VIX_PROXY = cache.VIXCLS;
      if(!out.SENTIMENT && cache.UMCSENT) out.SENTIMENT = cache.UMCSENT;

      // Derived
      if(!out.UN_SLOPE6 && cache.UNRATE){ out.UN_SLOPE6 = deriveUnempSlope6(cache.UNRATE) || {observations:[],fetchedAt:cache.UNRATE.fetchedAt}; }
      if(!out.DD_12M   && cache.SP500 ){ out.DD_12M   = deriveDrawdown12m(cache.SP500 ) || {observations:[],fetchedAt:cache.SP500.fetchedAt}; }
      if(!out.RETAIL_MOMENTUM && cache.RSAFS){ out.RETAIL_MOMENTUM = deriveRetailMomentum(cache.RSAFS) || {observations:[],fetchedAt:cache.RSAFS.fetchedAt}; }
      return out;
    }

    /* ========= AUDIT THE CACHE ========= */
    function auditCache(cache, mapped){
      const required = {
        'T10Y3M': ['T10Y3M'],                                  // yield curve
        'CREDIT': ['BAMLH0A0HYM2','BAA10YM','CREDIT'],         // HY OAS or Baa-Treasury
        'UN_SLOPE6': ['UNRATE'],                               // unemployment level to derive slope
        'DD_12M': ['SP500'],                                   // S&P level
        'NFCI': ['NFCI'],                                      // Chicago Fed NFCI
        'VIX_PROXY': ['VIXCLS','VIX_PROXY'],                   // VIX
        'RETAIL_MOMENTUM': ['RSAFS'],                          // Retail sales
        'SENTIMENT': ['UMCSENT'],                              // U. Michigan
        'OPTIONAL_CPI_YOY': ['CPI_YOY','CPIAUCSL_YOY','CPIAUCSL'] // optional drift nudge
      };
      const missing = [];
      const stale   = [];
      const oldest  = [];

      // check mapped presence
      for(const k of Object.keys(INDICATORS)){
        if(!mapped[k]?.observations?.length) missing.push(k);
      }
      // check freshness
      for(const [k,cfg] of Object.entries(INDICATORS)){
        const s = mapped[k];
        if(!s?.observations?.length) continue;
        const days = seriesAgeDays(s, s.fetchedAt);
        const lim = FRESH_LIMITS[cfg.cadence]||FRESH_LIMITS.daily;
        if(days>lim.warn) stale.push(`${k} (${days}d)`);
        oldest.push({k,days});
      }
      oldest.sort((a,b)=>b.days-a.days);

      // list which raw IDs are accepted
      const idHelp = Object.entries(required).map(([k,ids])=>`${k}: [${ids.join(', ')}]`).join(' Â· ');

      // write audit box
      els.auditBox.innerHTML =
        (missing.length? `<div><b class="bad">Missing</b>: ${missing.join(', ')}</div>`:'') +
        (stale.length? `<div><b class="warn">Stale</b>: ${stale.join(', ')}</div>`:'') +
        `<div>Accepted FRED keys â†’ ${idHelp}</div>`;

      // return boolean for confidence
      return { missing, stale, oldest };
    }

    /* ========= COMPLACENCY & INFLATION OVERLAYS ========= */
    function complacencyPenalty(dataMap){
      const vix = dataMap.VIX_PROXY?.observations || [];
      const hy  = dataMap.CREDIT?.observations  || [];
      const dd  = dataMap.DD_12M?.observations  || [];
      if (vix.length < 22 || hy.length < 1 || dd.length < 1) return 0;

      let streak = 0;
      for (let i = vix.length - 1; i >= 0 && streak < 60; i--){
        const val = +vix[i].value;
        if (isFinite(val) && val <= 13) streak++;
        else break;
      }
      const vixScore = Math.min(1, streak / 30);  // 0..1

      const hyLast = +hy[hy.length-1].value;
      const spreadTight = isFinite(hyLast) && hyLast <= 0.35 ? 1 : 0;

      const ddLast = +dd[dd.length-1].value;
      const shallowDD = isFinite(ddLast) && ddLast >= -0.05 ? 1 : 0;

      const raw = 0.5*vixScore + 0.3*spreadTight + 0.2*shallowDD; // 0..1
      return Math.round(15 * raw);
    }
    function inflationDriftPenalty(cache){
      // Optional: if YoY CPI provided (as CPI_YOY or derived in your cache)
      const CPI = cache.CPI_YOY || cache.CPIAUCSL_YOY || null;
      if(!CPI?.observations?.length) return 0;
      const o = CPI.observations;
      const last = +o[o.length-1].value;
      if(!isFinite(last)) return 0;
      if (last <= 2.5) return 0;
      if (last <= 3.5) return Math.round(1 + 2*(last-2.5)); // 1..3
      return Math.min(6, Math.round(2 + 2*(last-3.5)));     // up to 6
    }

    /* ========= COMPOSITE, CHARTS, UI ========= */
    let STATE = { dataMap:null, compositeHistory:[], tf:'1m', charts:{ composite:null, decomp:null, traj:null } };

    function freshnessPenalty(days, cadence){
      const lim = FRESH_LIMITS[cadence] || FRESH_LIMITS.daily;
      // Calm regime halves freshness windows
      const calm = (STATE?.dataMap?.VIX_PROXY?.observations||[]).slice(-1).some(o=>+o.value<=13) &&
                   (STATE?.dataMap?.CREDIT?.observations||[]).slice(-1).some(o=>+o.value<=0.35);
      const ok = calm ? Math.floor(lim.ok/2) : lim.ok;
      const warn = calm ? Math.floor(lim.warn/2) : lim.warn;
      if(days<=ok) return 1.00;
      if(days<=warn) return 0.85;
      return 0.70;
    }

    function renderCompositeChart(){
      const hist = STATE.compositeHistory;
      if(!hist?.length) return;
      const now = new Date(hist[hist.length-1].date+'T00:00:00Z');
      const day = 1, mo=30, yr=365;
      const spanDays = STATE.tf==='1m'?1*mo:STATE.tf==='3m'?3*mo:STATE.tf==='6m'?6*mo:STATE.tf==='1y'?yr:Infinity;
      const filtered = spanDays===Infinity ? hist : hist.filter(d=>{
        const dt = new Date(d.date+'T00:00:00Z');
        return (now - dt)/86400000 <= spanDays;
      });
      const labels = filtered.map(d=>d.date);
      const data = filtered.map(d=>d.value);
      if(STATE.charts.composite) STATE.charts.composite.destroy();
      STATE.charts.composite = mkLine(document.getElementById('compositeChart'), labels, data);
    }
    function renderDecomp(parts){
      const labels = parts.map(p=>p.label);
      const contrib = parts.map(p=>+(p.scaled*p.w).toFixed(1));
      if(STATE.charts.decomp) STATE.charts.decomp.destroy();
      STATE.charts.decomp = mkBar(document.getElementById('decompChart'), labels, contrib);
    }
    function renderHeatmap(parts){
      document.getElementById('heatmap').innerHTML = (parts.length?parts:[{label:'No data',scaled:0,valueDisp:'â€”'}]).map(p=>{
        const c = heatColor(p.scaled);
        return `<div class="heat-cell">
          <div class="heat-label">${p.label}</div>
          <div class="heat-value">${p.valueDisp??'â€”'}</div>
          <div class="bar"><span style="width:${p.scaled}%;background:${c}"></span></div>
        </div>`;
      }).join('');
    }
    function renderScenarios(composite, breadth){
      const stress = composite/100;
      const riskBias = (breadth-50)/50;
      const baseProb = 60 - 20*riskBias;
      const downProb = Math.min(40, 20 + 40*stress);
      const upProb = Math.max(5, 100 - baseProb - downProb);
      const cards = [
        {title:'Base Case', prob:Math.round(baseProb), desc:'Sideways-to-mildly volatile regime; conditions stabilize with modest dispersion.'},
        {title:'Downside (Stress)', prob:Math.round(downProb), desc:'Tighter financial conditions and volatility spikes; drawdowns concentrated in cyclicals.'},
        {title:'Upside (Relief)', prob:Math.round(upProb), desc:'Soft-landing drift; risk appetite improves as macro prints surprise positively.'}
      ];
      els.scenarioGrid.innerHTML = cards.map(c=>`
        <div class="scenario-card" style="background:rgba(255,255,255,.03);padding:16px;border-radius:12px;border:1px solid rgba(255,255,255,.06)">
          <div class="scenario-header" style="display:flex;justify-content:space-between;align-items:center">
            <div class="scenario-title" style="font-weight:600">${c.title}</div>
            <div class="scenario-prob" style="font-size:22px;font-weight:700;color:var(--accent-bright)">${c.prob}%</div>
          </div>
          <div class="scenario-desc" style="color:var(--muted);font-size:13px">${c.desc}</div>
        </div>`).join('');
    }
    function renderTrajectory(composite){
      const steps = 26, phi = 0.85, target = 50;
      let v = composite;
      const labels=[], path=[], upper=[], lower=[];
      for(let i=1;i<=steps;i++){
        v = phi*v + (1-phi)*target;
        labels.push(`W+${i}`); path.push(+v.toFixed(1));
        const band = 6*Math.sqrt(i/steps);
        upper.push(Math.min(100, +(v+band).toFixed(1)));
        lower.push(Math.max(0,   +(v-band).toFixed(1)));
      }
      if(STATE.charts.traj) STATE.charts.traj.destroy();
      STATE.charts.traj = new Chart(document.getElementById('trajectoryChart'),{
        type:'line',
        data:{labels,
          datasets:[
            {label:'Projected', data:path, borderWidth:2, fill:false, tension:0.25},
            {label:'Upper', data:upper, borderWidth:1, fill:false, borderDash:[4,4]},
            {label:'Lower', data:lower, borderWidth:1, fill:false, borderDash:[4,4]}
          ]},
        options:{responsive:true, plugins:{legend:{display:false}}, scales:{y:{min:0,max:100}}}
      });
    }

    // Momentum-aware horizon probabilities
    function compositeMomentum(hist, lookbackDays){
      if(!hist?.length) return 0;
      const n = hist.length;
      const a = Math.max(0, n-1-lookbackDays);
      const b = n-1;
      const da = hist[a]?.value ?? hist[0].value;
      const db = hist[b]?.value ?? hist[n-1].value;
      return db - da;
    }
    function horizonRiskSmart(composite, hist){
      const m20 = compositeMomentum(hist, 20);
      const m60 = compositeMomentum(hist, 60);
      const m120= compositeMomentum(hist,120);
      const base = x => 1/(1+Math.exp(-(x-50)/10));
      const p1 = base(composite) * (0.70 + 0.02*m20);
      const p3 = base(composite) * (0.95 + 0.015*m60);
      const p6 = base(composite) * (1.20 + 0.010*m120);
      const clip = p=>Math.round(Math.max(5, Math.min(95, 100*p)));
      return { p1: clip(p1), p3: clip(p3), p6: clip(p6) };
    }

    /* ========= MAIN ========= */
    (async function init(){
      try{
        setStatus('green','Loading dataâ€¦');

        const cache = await loadFredCache();
        const dataMap = mapIndicatorsFromCache(cache);
        STATE.dataMap = dataMap;

        // Audit cache & show help
        const audit = auditCache(cache, dataMap);

        // Build parts + composite
        let num=0, den=0;
        const parts=[];
        for(const [k,cfg] of Object.entries(INDICATORS)){
          const s = dataMap[k];
          const obs = s?.observations||[];
          if(!obs.length) continue;
          const L = latest(s); if(!L || L.value==null) continue;

          const days = seriesAgeDays(s, s.fetchedAt);
          const lim = FRESH_LIMITS[cfg.cadence]||FRESH_LIMITS.daily;
          const badge = days<=lim.ok ? {cls:'badge-fresh',txt:'Fresh'} : days<=lim.warn ? {cls:'badge-stale',txt:'Stale'} : {cls:'badge-old',txt:'Old'};

          const scaled = SCALE[k](L.value);
          const w = cfg.weight * freshnessPenalty(days, cfg.cadence);
          if(Number.isFinite(scaled) && Number.isFinite(w)){ num += scaled*w; den += w; }

          let change = null;
          if(obs.length>=2){ const a=+obs[obs.length-1].value, b=+obs[obs.length-2].value; if(isFinite(a)&&isFinite(b)) change=a-b; }

          parts.push({ key:k, label:cfg.label, valueDisp: cfg.format?.(L.value) ?? L.value, change, freshClass:badge.cls, freshTxt:badge.txt, scaled, w, obs });
        }
        if(den<=0) throw new Error('No valid indicators / weights.');

        const compositeBase = num/den;
        const penalty = complacencyPenalty(dataMap);
        const infl = inflationDriftPenalty(cache);
        const composite = Math.min(100, compositeBase + penalty + infl);

        // Status + gauge
        setGauge(composite);
        const zone = zoneOf(composite);
        const badges = [];
        if (penalty>0) badges.push(`Complacency +${penalty}`);
        if (infl>0) badges.push(`Inflation +${infl}`);
        setStatus(zone, `Composite: ${Math.round(composite)} (${zone.toUpperCase()}) ${badges.length? 'Â· ' + badges.join(' Â· ') : ''}`);
        document.getElementById('indicatorCount').textContent = parts.length;

        // Pills / charts
        els.pillsGrid.innerHTML = parts.map(p=>pillHTML(p)).join('');
        if (penalty>0) parts.push({ label:'Complacency Overlay', scaled: penalty, w:1, valueDisp:`+${penalty}`, change:null });
        if (infl>0)     parts.push({ label:'Inflation Drift',   scaled: infl,     w:1, valueDisp:`+${infl}`,     change:null });

        // Build composite history (union of dates from higher-cadence series)
        const keysForHist = ['DD_12M','VIX_PROXY','T10Y3M','CREDIT','NFCI'];
        const allDates = new Set();
        for(const k of keysForHist){ (dataMap[k]?.observations||[]).forEach(o=>allDates.add(o.date)); }
        const dates = Array.from(allDates).sort();
        STATE.compositeHistory = dates.map(date=>{
          let n=0,d=0;
          for(const [k,cfg] of Object.entries(INDICATORS)){
            const s = dataMap[k]; if(!s) continue;
            const obs = s.observations;
            let v=null;
            for(let i=obs.length-1;i>=0;i--){ if(obs[i].date<=date){ const vv=+obs[i].value; if(isFinite(vv)) v=vv; break; } }
            if(v==null) continue;
            const sc = SCALE[k](v); n+=sc*cfg.weight; d+=cfg.weight;
          }
          return {date, value: d>0 ? +(n/d).toFixed(1) : null};
        }).filter(x=>x.value!=null);

        // Charts & views
        renderCompositeChart();
        renderDecomp(parts.length?parts:[{label:'No data', scaled:0, w:1, valueDisp:'â€”', change:null}]);
        renderHeatmap(parts);
        const breadth = parts.reduce((a,p)=>a+p.scaled,0)/parts.length;
        renderScenarios(composite, breadth);
        renderTrajectory(composite);

        // Probabilities with momentum tilts
        const {p1,p3,p6} = horizonRiskSmart(composite, STATE.compositeHistory);
        els.prob1m.textContent = `${p1}%`;
        els.prob3m.textContent = `${p3}%`;
        els.prob6m.textContent = `${p6}%`;
        els.regimeIndicator.innerHTML =
          `<span class="status-dot" style="background:${zone==='green'?'#1ec28b':zone==='amber'?'#ffc247':'#ff6070'}"></span>${zone==='green'?'Normal':zone==='amber'?'Stressed':'Crisis'} regime`;

        // Tabs
        window.switchTab = (e, id)=>{
          document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
          e.currentTarget.classList.add('active');
          document.querySelectorAll('.tab-content').forEach(x=>x.classList.remove('active'));
          document.getElementById('tab-'+id).classList.add('active');
        };
        // Timeframe buttons
        document.querySelectorAll('.btn-group .btn').forEach(btn=>{
          btn.addEventListener('click', (evt)=>{
            document.querySelectorAll('.btn-group .btn').forEach(b=>b.classList.remove('active'));
            evt.currentTarget.classList.add('active');
            STATE.tf = evt.currentTarget.dataset.tf;
            renderCompositeChart();
          });
        });

        // Confidence display based on audit
        const confidence = Math.max(40, 100 - (audit.missing.length*12 + audit.stale.length*4));
        document.getElementById('confidenceFill').style.width = confidence+'%';
        document.getElementById('confidenceText').textContent = confidence+'%';

      }catch(err){
        console.error(err);
        setErrorStatus(err.message||'FRED cache error');
      }
    })();
  </script>
</body>
</html>
