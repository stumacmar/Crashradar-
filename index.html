<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="description" content="Advanced Economic Crash Radar with predictive analytics and multi-timeframe analysis" />
  <title>Economic Crash Radar Pro</title>
  <style>
    :root{
      --bg:#0a0e1a; --panel:#12182b; --panel-hover:#151d33; --muted:#8b96b0; 
      --text:#e8eeff; --accent:#6b9eff; --accent-bright:#8fb4ff;
      --green:#1ec28b; --amber:#ffc247; --red:#ff6070; --orange:#ff8c42;
      --radius:14px; --shadow:0 4px 24px rgba(0,0,0,.3);
      --ring:200px; --ring-m:160px;
    }
    *{box-sizing:border-box}
    html,body{margin:0;background:var(--bg);color:var(--text);
      font:15px/1.6 -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Inter,Helvetica,Arial,sans-serif}

    .wrap{max-width:1400px;margin:0 auto;padding:20px 16px 80px}

    header{margin-bottom:24px}
    h1{font-size:clamp(32px,5vw,48px);line-height:1.1;margin:0 0 8px;
      background:linear-gradient(135deg,var(--text),var(--accent-bright));
      -webkit-background-clip:text;-webkit-text-fill-color:transparent;
      background-clip:text}
    .subtitle{color:var(--muted);font-size:15px;margin:8px 0}

    .card{background:var(--panel);border-radius:var(--radius);padding:24px;margin:20px 0;
      box-shadow:var(--shadow),0 0 0 1px rgba(255,255,255,.04) inset;
      transition:transform .2s,box-shadow .2s}
    .card:hover{transform:translateY(-2px);box-shadow:0 6px 32px rgba(0,0,0,.4)}

    .grid{display:grid;gap:20px;grid-template-columns:repeat(auto-fit,minmax(320px,1fr))}

    /* Enhanced Gauge */
    .gauge-container{display:flex;align-items:center;gap:32px;flex-wrap:wrap}
    .gauge-wrap{position:relative;width:var(--ring);height:var(--ring)}

    .multi-ring{position:absolute;inset:0}
    .ring{position:absolute;border-radius:50%;transition:opacity .3s}
    .ring-outer{inset:0;background:conic-gradient(
      var(--green) 0deg 108deg,
      var(--amber) 108deg 216deg, 
      var(--red) 216deg 360deg);opacity:.3}
    .ring-mid{inset:15px;background:conic-gradient(
      var(--green) 0deg 108deg,
      var(--amber) 108deg 216deg,
      var(--red) 216deg 360deg);opacity:.5}
    .ring-inner{inset:30px;background:conic-gradient(
      var(--green) 0deg 108deg,
      var(--amber) 108deg 216deg,
      var(--red) 216deg 360deg)}
    .ring::after{content:"";position:absolute;inset:20px;border-radius:50%;background:var(--panel)}

    .needle{position:absolute;inset:0;transition:transform .6s cubic-bezier(.34,1.56,.64,1)}
    .needle::before{content:"";position:absolute;top:50%;left:50%;width:4px;height:45%;
      background:linear-gradient(180deg,var(--accent-bright),var(--accent));
      transform:translateX(-50%) translateY(-100%) rotate(var(--angle,0deg));
      transform-origin:bottom center;border-radius:4px;box-shadow:0 0 12px var(--accent)}
    .needle::after{content:"";position:absolute;top:50%;left:50%;width:16px;height:16px;
      background:var(--accent-bright);border-radius:50%;transform:translate(-50%,-50%);
      box-shadow:0 0 16px var(--accent),0 0 0 3px var(--panel)}

    .score{position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;
      justify-content:center;font-weight:800;font-size:48px;line-height:1}
    .score-label{font-size:12px;font-weight:600;color:var(--muted);margin-top:4px;letter-spacing:.5px}

    .gauge-info h2{font-size:28px;margin:0 0 8px;font-weight:700}
    .confidence{display:inline-flex;align-items:center;gap:8px;background:rgba(107,158,255,.15);
      padding:6px 12px;border-radius:8px;font-size:13px;font-weight:600;margin-top:8px}
    .confidence-bar{width:60px;height:6px;background:rgba(255,255,255,.1);border-radius:3px;overflow:hidden}
    .confidence-fill{height:100%;background:var(--accent);border-radius:3px;transition:width .3s}

    /* Probability Display */
    .prob-display{display:flex;gap:16px;margin-top:16px;flex-wrap:wrap}
    .prob-item{flex:1;min-width:140px;background:rgba(255,255,255,.03);padding:12px;border-radius:10px;
      border:1px solid rgba(255,255,255,.06)}
    .prob-item h4{margin:0 0 4px;font-size:11px;text-transform:uppercase;letter-spacing:.5px;color:var(--muted)}
    .prob-value{font-size:24px;font-weight:700;color:var(--accent-bright)}

    /* Indicator Pills */
    .pills-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:12px}
    .pill{background:rgba(255,255,255,.03);border:1px solid rgba(255,255,255,.06);
      padding:14px 16px;border-radius:12px;transition:all .2s;cursor:pointer;position:relative}
    .pill:hover{background:rgba(255,255,255,.06);border-color:rgba(255,255,255,.12);transform:translateY(-2px)}
    .pill-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px}
    .pill-title{font-weight:600;font-size:13px;color:var(--text)}
    .pill-badge{font-size:11px;padding:3px 8px;border-radius:6px;font-weight:600}
    .pill-value{font-size:20px;font-weight:700;margin:4px 0}
    .pill-change{font-size:12px;color:var(--muted);display:flex;align-items:center;gap:4px}
    .trend-arrow{display:inline-block;font-weight:bold}

    .badge-fresh{background:rgba(30,194,139,.15);color:var(--green)}
    .badge-stale{background:rgba(255,194,71,.15);color:var(--amber)}
    .badge-old{background:rgba(255,96,112,.15);color:var(--red)}

    /* Charts */
    .chart-container{position:relative;height:320px;margin:16px 0}
    .chart-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;flex-wrap:wrap;gap:12px}
    .chart-title{font-size:18px;font-weight:600;margin:0}
    .chart-controls{display:flex;gap:8px}
    .btn-group{display:flex;gap:4px;background:rgba(255,255,255,.03);padding:4px;border-radius:8px}
    .btn{background:transparent;border:none;color:var(--muted);padding:6px 14px;
      border-radius:6px;cursor:pointer;font-size:13px;font-weight:500;transition:all .2s}
    .btn:hover{color:var(--text);background:rgba(255,255,255,.06)}
    .btn.active{background:var(--accent);color:#fff}

    /* Heat Map */
    .heatmap{display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:10px}
    .heat-cell{background:rgba(255,255,255,.03);padding:14px;border-radius:10px;
      border-left:4px solid var(--accent);transition:all .2s}
    .heat-cell:hover{background:rgba(255,255,255,.06);transform:scale(1.02)}
    .heat-label{font-size:11px;color:var(--muted);margin-bottom:6px;text-transform:uppercase;letter-spacing:.3px}
    .heat-value{font-size:22px;font-weight:700;margin:4px 0}

    /* Regime Indicator */
    .regime{display:inline-flex;align-items:center;gap:10px;background:rgba(255,255,255,.05);
      padding:10px 16px;border-radius:10px;font-weight:600;margin-top:12px}
    .regime-dot{width:10px;height:10px;border-radius:50%;animation:pulse 2s infinite}
    @keyframes pulse{0%,100%{opacity:1}50%{opacity:.5}}

    /* Historical Analogs */
    .analog-list{display:grid;gap:12px}
    .analog-item{background:rgba(255,255,255,.03);padding:14px;border-radius:10px;
      border-left:3px solid var(--accent);display:flex;justify-content:space-between;align-items:center}
    .analog-period{font-weight:600}
    .analog-similarity{color:var(--accent-bright);font-weight:700}

    /* Tabs */
    .tabs{display:flex;gap:8px;border-bottom:2px solid rgba(255,255,255,.06);margin-bottom:20px;overflow-x:auto}
    .tab{background:transparent;border:none;color:var(--muted);padding:12px 20px;
      cursor:pointer;font-size:14px;font-weight:600;position:relative;transition:color .2s;white-space:nowrap}
    .tab:hover{color:var(--text)}
    .tab.active{color:var(--accent-bright)}
    .tab.active::after{content:"";position:absolute;bottom:-2px;left:0;right:0;height:2px;background:var(--accent)}
    .tab-content{display:none}
    .tab-content.active{display:block}

    /* Status Badge */
    .status{display:inline-flex;align-items:center;gap:8px;padding:8px 14px;
      border-radius:8px;font-weight:600;font-size:13px}
    .status-dot{width:8px;height:8px;border-radius:50%}

    /* Scenario Cards */
    .scenario-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:16px;margin-top:16px}
    .scenario-card{background:rgba(255,255,255,.03);padding:18px;border-radius:12px;border:1px solid rgba(255,255,255,.06)}
    .scenario-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
    .scenario-title{font-weight:600;font-size:15px}
    .scenario-prob{font-size:24px;font-weight:700;color:var(--accent-bright)}
    .scenario-desc{font-size:13px;color:var(--muted);line-height:1.5}

    /* Responsive */
    @media (max-width:768px){
      .gauge-container{justify-content:center;text-align:center}
      .gauge-wrap{width:var(--ring-m);height:var(--ring-m)}
      .score{font-size:36px}
      .pills-grid{grid-template-columns:1fr}
      .chart-header{flex-direction:column;align-items:flex-start}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>âš¡ Economic Crash Radar Pro</h1>
      <div class="subtitle">Advanced multi-timeframe market stress analysis with predictive analytics</div>
      <div id="statusBadge"></div>
    </header>

    <main>
      <!-- Enhanced Gauge Section -->
      <section class="card">
        <div class="gauge-container">
          <div class="gauge-wrap">
            <div class="multi-ring">
              <div class="ring ring-outer"></div>
              <div class="ring ring-mid"></div>
              <div class="ring ring-inner"></div>
            </div>
            <div id="needle" class="needle"></div>
            <div class="score">
              <div id="scoreText">--</div>
              <div class="score-label">COMPOSITE</div>
            </div>
          </div>

          <div class="gauge-info">
            <h2>Market Stress Index</h2>
            <div style="color:var(--muted);font-size:14px;margin-bottom:8px">
              Real-time composite of <span id="indicatorCount">12</span> economic indicators
            </div>
            <div class="confidence">
              <span>Confidence:</span>
              <div class="confidence-bar"><div id="confidenceFill" class="confidence-fill" style="width:85%"></div></div>
              <span id="confidenceText">85%</span>
            </div>
            <div id="regimeIndicator" class="regime"></div>
            <div class="prob-display">
              <div class="prob-item"><h4>1-Month Risk</h4><div class="prob-value" id="prob1m">--</div></div>
              <div class="prob-item"><h4>3-Month Risk</h4><div class="prob-value" id="prob3m">--</div></div>
              <div class="prob-item"><h4>6-Month Risk</h4><div class="prob-value" id="prob6m">--</div></div>
            </div>
          </div>
        </div>
      </section>

      <!-- Indicator Pills Grid -->
      <section class="card">
        <h3 style="margin:0 0 16px;font-size:20px">ðŸ“Š Live Indicators</h3>
        <div id="pillsGrid" class="pills-grid"></div>
      </section>

      <!-- Tabs for Different Views -->
      <div class="tabs">
        <button class="tab active" onclick="switchTab(event, 'composite')">Composite</button>
        <button class="tab" onclick="switchTab(event, 'scenarios')">Scenarios</button>
        <button class="tab" onclick="switchTab(event, 'indicators')">Indicators</button>
        <button class="tab" onclick="switchTab(event, 'analogs')">Analogs</button>
      </div>

      <!-- Tab 1: Composite Analysis -->
      <div id="tab-composite" class="tab-content active">
        <section class="card">
          <div class="chart-header">
            <h3 class="chart-title">Composite Risk Score</h3>
            <div class="chart-controls">
              <div class="btn-group">
                <button class="btn active" onclick="setTimeframe(event, '1m')">1M</button>
                <button class="btn" onclick="setTimeframe(event, '3m')">3M</button>
                <button class="btn" onclick="setTimeframe(event, '6m')">6M</button>
                <button class="btn" onclick="setTimeframe(event, '1y')">1Y</button>
                <button class="btn" onclick="setTimeframe(event, 'all')">ALL</button>
              </div>
            </div>
          </div>
          <div class="chart-container"><canvas id="compositeChart"></canvas></div>
        </section>

        <section class="card">
          <h3 style="margin:0 0 16px">Risk Decomposition</h3>
          <div class="chart-container"><canvas id="decompChart"></canvas></div>
        </section>
      </div>

      <!-- Tab 2: Scenarios -->
      <div id="tab-scenarios" class="tab-content">
        <section class="card">
          <h3 style="margin:0 0 8px">Forward-Looking Scenarios</h3>
          <p style="color:var(--muted);margin:0 0 16px;font-size:14px">Probability-weighted forecasts</p>
          <div class="scenario-grid" id="scenarioGrid"></div>
        </section>

        <section class="card">
          <h3 style="margin:0 0 16px">Risk Trajectory</h3>
          <div class="chart-container"><canvas id="trajectoryChart"></canvas></div>
        </section>
      </div>

      <!-- Tab 3: Indicators -->
      <div id="tab-indicators" class="tab-content">
        <section class="card">
          <h3 style="margin:0 0 16px">Indicator Heat Map</h3>
          <div id="heatmap" class="heatmap"></div>
        </section>
        <div id="indicatorCharts"></div>
      </div>

      <!-- Tab 4: Historical Analogs -->
      <div id="tab-analogs" class="tab-content">
        <section class="card">
          <h3 style="margin:0 0 8px">Similar Historical Periods</h3>
          <p style="color:var(--muted);margin:0 0 16px;font-size:14px">Compared to past market regimes</p>
          <div id="analogList" class="analog-list"></div>
        </section>
      </div>

    </main>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3.1.1/dist/chartjs-plugin-annotation.min.js"></script>

  <script>
    // ================= FRED CACHE BASE PATH (subpath-safe) =================
    // Why change from "/fred"? Because on GH/CF Pages or Replit you're served from /<repo>/
    // so absolute "/fred" 404s. This computes a repo-relative base by default.
    (function(){
      const path = location.pathname;
      const repoBase = path.endsWith('/') ? path : path.replace(/[^/]+$/, '');
      window.FRED_CACHE_BASE = window.FRED_CACHE_BASE || (repoBase + 'fred');
    })();

    const FRED_BASE = (window.FRED_CACHE_BASE || '/fred').replace(/\/+$/,''); 

    // ============ CONFIGURATION ============
    const INDICATORS = {
      T10Y3M: { label: 'Yield Curve', format: v => v?.toFixed(2), weight: 0.18, cadence: 'daily' },
      CREDIT: { label: 'Credit Spread', format: v => v?.toFixed(2), weight: 0.14, cadence: 'daily' },
      UN_SLOPE6: { label: 'Unemployment Î”', format: v => v?.toFixed(2), weight: 0.12, cadence: 'monthly' },
      DD_12M: { label: 'Market Drawdown', format: v => ((v ?? 0) * 100).toFixed(1) + '%', weight: 0.20, cadence: 'daily' },
      NFCI: { label: 'Financial Conditions', format: v => v?.toFixed(3), weight: 0.12, cadence: 'weekly' },
      VIX_PROXY: { label: 'Volatility Index', format: v => v?.toFixed(1), weight: 0.10, cadence: 'daily' },
      RETAIL_MOMENTUM: { label: 'Retail Sales Î”', format: v => v?.toFixed(2) + '%', weight: 0.08, cadence: 'monthly' },
      SENTIMENT: { label: 'Consumer Confidence', format: v => v?.toFixed(1), weight: 0.06, cadence: 'monthly' }
    };

    const SCALE = {
      T10Y3M: v => clamp(map01(v, 1.0, -2.0)),
      CREDIT: v => clamp(map01(v, 0.30, 1.00)),
      UN_SLOPE6: v => clamp(map01(v, 0.05, 0.50)),
      DD_12M: v => clamp(map01(v, 0.00, -0.20)),
      NFCI: v => clamp(map01(v, -0.80, 0.40)),
      VIX_PROXY: v => clamp(map01(v, 12, 35)),
      RETAIL_MOMENTUM: v => clamp(map01(v, 0.03, -0.02)),
      SENTIMENT: v => clamp(map01(v, 110, 70))
    };

    const FRESH_LIMITS = {
      daily: { ok: 7, warn: 30 },
      weekly: { ok: 7, warn: 30 },
      monthly: { ok: 30, warn: 60 }
    };

    // ============ UTILITIES ============
    const clamp = x => Math.max(0, Math.min(100, x));
    const map01 = (val, good, bad) => {
      if (val == null) return 50;
      const denom = bad - good;
      if (Math.abs(denom) < 1e-9) return 50;
      return ((val - good) / denom) * 100;
    };
    const zoneOf = s => s <= 30 ? 'green' : (s <= 60 ? 'amber' : 'red');
    const movingAvg = (arr, k) => {
      const out = [];
      let sum = 0;
      for (let i = 0; i < arr.length; i++) {
        sum += arr[i];
        if (i >= k) sum -= arr[i - k];
        out.push(i >= k - 1 ? +(sum / k).toFixed(1) : null);
      }
      return out;
    };

    function freshnessPenalty(days, cadence) {
      const lim = FRESH_LIMITS[cadence] || FRESH_LIMITS.daily;
      if (days <= lim.ok) return 1.00;
      if (days <= lim.warn) return 0.85;
      return 0.70;
    }

    function latest(series) {
      const obs = series?.observations || [];
      if (!obs.length) return null;
      const o = obs[obs.length - 1];
      const v = (o.value==null || o.value==='.' || o.value==='NaN') ? null : +o.value;
      return { value: v, date: o.date };
    }

    function seriesAgeDays(series, fetchedAt) {
      const L = latest(series);
      if (!L) return Infinity;
      const d = new Date(L.date + "T00:00:00Z");
      return Math.max(0, Math.round((new Date(fetchedAt || Date.now()) - d) / 86400000));
    }

    // ============ DOM HOOKS ============
    const els = {
      statusBadge:  document.getElementById('statusBadge'),
      scoreText:    document.getElementById('scoreText'),
      needle:       document.getElementById('needle'),
      indicatorCount: document.getElementById('indicatorCount'),
      confidenceFill: document.getElementById('confidenceFill'),
      confidenceText: document.getElementById('confidenceText'),
      regimeIndicator: document.getElementById('regimeIndicator'),
      prob1m: document.getElementById('prob1m'),
      prob3m: document.getElementById('prob3m'),
      prob6m: document.getElementById('prob6m'),
      pillsGrid: document.getElementById('pillsGrid')
    };

    function setStatus(zone, text){
      const colors = {green:'#1ec28b', amber:'#ffc247', red:'#ff6070'};
      els.statusBadge.innerHTML = `
        <div class="status" style="background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.08)">
          <span class="status-dot" style="background:${colors[zone]||'#8fb4ff'}"></span>
          <span>${text}</span>
        </div>`;
    }
    function setErrorStatus(errText){
      els.statusBadge.innerHTML = `
        <div class="status" style="background:rgba(255,96,112,.12);border:1px solid rgba(255,96,112,.4)">
          <span class="status-dot" style="background:#ff6070"></span>
          <span>Data error: ${errText}</span>
        </div>`;
    }
    function setGauge(score){
      els.scoreText.textContent = Math.round(score);
      const angle = (score/100)*360;
      els.needle.style.setProperty('--angle', angle+'deg');
      els.needle.style.transform = `rotate(${angle}deg)`;
    }

    // ============ FRED-ONLY FETCH ============
    async function fetchSeriesByKey(key){
      const bust = (window.__CACHE_BUSTER__ ? `?v=${window.__CACHE_BUSTER__}` : '');
      const url = `${FRED_BASE}/${key}.json${bust}`;
      const res = await fetch(url, {cache:'no-store'});
      if(!res.ok) throw new Error(`${key}: HTTP ${res.status}`);
      const json = await res.json();
      if(!json || !Array.isArray(json.observations)) throw new Error(`${key}: bad JSON`);
      return json;
    }

    // --- helpers for derived when files are absent (no demo, no placeholders) ---
    function latestVal(series){
      const obs = series?.observations || [];
      if(!obs.length) return null;
      const o = obs[obs.length-1];
      const v = (o.value==null || o.value==='.' || o.value==='NaN') ? null : +o.value;
      return {value:v, date:o.date};
    }
    function deriveUnempSlope6(unrate){
      const L = latestVal(unrate); if(!L?.date || L.value==null) return null;
      const back = new Date(L.date+"T00:00:00Z"); back.setMonth(back.getMonth()-6);
      const iso = back.toISOString().slice(0,10);
      const obs = unrate.observations;
      for(let i=obs.length-1;i>=0;i--){
        if(obs[i].date<=iso){
          const v = obs[i].value; if(v!=null && v!=='.' && v!=='NaN') return L.value - (+v);
          break;
        }
      }
      return null;
    }
    function deriveDrawdown12m(spx){
      const L = latestVal(spx); if(!L?.date || L.value==null) return null;
      const end = L.date;
      const start = new Date(end+"T00:00:00Z"); start.setFullYear(start.getFullYear()-1);
      const startIso = start.toISOString().slice(0,10);
      let maxv = -Infinity;
      for(const o of spx.observations||[]){
        if(o.date>=startIso && o.date<=end){
          const v = (o.value==null||o.value==='.'||o.value==='NaN')?null:+o.value;
          if(v!=null) maxv = Math.max(maxv, v);
        }
      }
      if(!isFinite(maxv) || maxv<=0) return null;
      return (L.value/maxv) - 1;
    }

    async function loadAllIndicators(){
      const keys = Object.keys(INDICATORS);
      const map = {};

      // try to fetch declared indicator files
      await Promise.all(keys.map(async k=>{
        try { map[k] = await fetchSeriesByKey(k); }
        catch(e){ map[k] = null; }
      }));

      // derive missing UN_SLOPE6 from UNRATE.json (if needed)
      if(!map.UN_SLOPE6){
        const unrate = await fetchSeriesByKey('UNRATE');
        const val = deriveUnempSlope6(unrate);
        if(val!=null){
          map.UN_SLOPE6 = {
            observations: [{date: latestVal(unrate).date, value: String(val)}],
            fetchedAt: unrate.fetchedAt || new Date().toISOString()
          };
        } else {
          throw new Error('UN_SLOPE6 missing and could not be derived from UNRATE');
        }
      }

      // derive missing DD_12M from SP500.json (if needed)
      if(!map.DD_12M){
        const spx = await fetchSeriesByKey('SP500');
        const val = deriveDrawdown12m(spx);
        if(val!=null){
          map.DD_12M = {
            observations: [{date: latestVal(spx).date, value: String(val)}],
            fetchedAt: spx.fetchedAt || new Date().toISOString()
          };
        } else {
          throw new Error('DD_12M missing and could not be derived from SP500');
        }
      }

      // hard error if any required series still missing
      for(const k of keys){
        if(!map[k]) throw new Error(`${k} missing from FRED cache`);
      }
      return map;
    }

    // ============ RENDER HELPERS ============
    function pillHTML({key,label,valueDisp,change,freshClass,freshTxt}){
      const arrow = change==null?'' : (change>0?'â–²':'â–¼');
      const changeTxt = change==null?'' : `${(change>0?'+':'')}${change.toFixed(2)}`;
      return `
        <div class="pill" data-key="${key}">
          <div class="pill-header">
            <div class="pill-title">${label}</div>
            <div class="pill-badge ${freshClass}">${freshTxt}</div>
          </div>
          <div class="pill-value">${valueDisp}</div>
          <div class="pill-change"><span class="trend-arrow">${arrow}</span>${changeTxt}</div>
        </div>`;
    }

    function ensureLineChart(id, labels, data){
      const ctx = document.getElementById(id);
      if(!ctx || !window.Chart) return;
      new Chart(ctx, {
        type:'line',
        data:{ labels, datasets:[{label:'Composite', data, borderWidth:2, fill:false, tension:0.25}] },
        options:{ responsive:true, plugins:{legend:{display:false}}, scales:{x:{display:false}, y:{min:0,max:100}} }
      });
    }
    function ensureBarChart(id, labels, data){
      const ctx = document.getElementById(id);
      if(!ctx || !window.Chart) return;
      new Chart(ctx, {
        type:'bar',
        data:{ labels, datasets:[{label:'Contribution', data, borderWidth:1}] },
        options:{ responsive:true, plugins:{legend:{display:false}}, scales:{y:{beginAtZero:true}} }
      });
    }

    // ============ MAIN ============
    (async function init(){
      try{
        const dataMap = await loadAllIndicators();

        // Latest values & freshness
        let num=0, den=0;
        const parts=[];
        for(const [k,cfg] of Object.entries(INDICATORS)){
          const s = dataMap[k];
          const L = latest(s);
          const days = seriesAgeDays(s, s.fetchedAt);
          const {cls, txt} = (()=> {
            const lim = FRESH_LIMITS[cfg.cadence] || FRESH_LIMITS.daily;
            if (days <= lim.ok) return {cls:'badge-fresh', txt:'Fresh'};
            if (days <= lim.warn) return {cls:'badge-stale', txt:'Stale'};
            return {cls:'badge-old', txt:'Old'};
          })();
          const scaled = SCALE[k](L?.value);
          const pen = freshnessPenalty(days, cfg.cadence);
          const w = cfg.weight * pen;

          if(Number.isFinite(scaled) && Number.isFinite(w)){ num += scaled*w; den += w; }

          // simple Î” vs previous
          let change=null;
          const obs=s?.observations||[];
          if(obs.length>=2){
            const a=+obs[obs.length-1].value, b=+obs[obs.length-2].value;
            if(isFinite(a)&&isFinite(b)) change=a-b;
          }

          parts.push({
            key:k,label:cfg.label,raw:L?.value, valueDisp: cfg.format?.(L?.value) ?? (L?.value??'â€”'),
            freshClass:cls,freshTxt:txt, scaled, w, change
          });
        }

        if(den<=0) throw new Error('No valid indicators / weights.');
        const composite = num/den;

        // Gauge + status
        setGauge(composite);
        const zone = zoneOf(composite);
        setStatus(zone, `Composite: ${Math.round(composite)} (${zone.toUpperCase()})`);
        els.indicatorCount.textContent = parts.length;

        // Pills
        els.pillsGrid.innerHTML = parts.map(p=>pillHTML(p)).join('');

        // Composite history (baseline on first indicatorâ€™s dates)
        const baseKey = Object.keys(INDICATORS)[0];
        const baseObs = (dataMap[baseKey]?.observations)||[];
        const labels = baseObs.map(o=>o.date);
        const hist = labels.map(date=>{
          let n=0,d=0;
          for(const [k,cfg] of Object.entries(INDICATORS)){
            const s = dataMap[k]; if(!s) continue;
            const obs = s.observations;
            let v=null;
            for(let i=obs.length-1;i>=0;i--){
              if(obs[i].date<=date){
                const vv = obs[i].value;
                if(vv!=null && vv!=='.' && vv!=='NaN'){ v=+vv; }
                break;
              }
            }
            if(v==null) continue;
            const sc = SCALE[k](v);
            n += sc * cfg.weight;
            d += cfg.weight;
          }
          return d>0 ? +(n/d).toFixed(1) : null;
        });

        ensureLineChart('compositeChart', labels, hist);
        ensureBarChart('decompChart', parts.map(p=>p.label), parts.map(p=>+(p.scaled*p.w).toFixed(1)));

        // Regime + simple forward probabilities (direct level map; keep your model later)
        els.regimeIndicator.innerHTML = `<span class="regime-dot" style="background:${zone==='green'?'#1ec28b':zone==='amber'?'#ffc247':'#ff6070'}"></span>${zone==='green'?'Normal':zone==='amber'?'Stressed':'Crisis'} regime`;
        els.prob1m.textContent = `${Math.round(Math.min(95, Math.max(5, composite-20)))}%`;
        els.prob3m.textContent = `${Math.round(Math.min(95, Math.max(5, composite-10)))}%`;
        els.prob6m.textContent = `${Math.round(Math.min(95, Math.max(5, composite)))}%`;

        // Tabs & timeframe buttons
        window.switchTab = (e, id)=>{
          document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
          e.currentTarget.classList.add('active');
          document.querySelectorAll('.tab-content').forEach(x=>x.classList.remove('active'));
          document.getElementById('tab-'+id).classList.add('active');
        };
        window.setTimeframe = (e, tf)=>{
          const btns = e.currentTarget.parentElement.querySelectorAll('.btn');
          btns.forEach(b=>b.classList.toggle('active', b===e.currentTarget));
          // TODO: filter/compress 'hist' by tf
        };

      }catch(err){
        console.error(err);
        setErrorStatus(err.message||'FRED cache error');
      }
    })();
  </script>
</body>
</html>
