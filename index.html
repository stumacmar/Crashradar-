<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Economic Crash Radar Pro</title>
    <!-- Pinned Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <style>
        :root {
            --bg:#0a0e1a;
            --panel:#12182b;
            --panel-hover:#151d33;
            --text:#e8eeff;
            --muted:#8b96b0;
            --accent:#6b9eff;
            --accent-bright:#8fb4ff;
            --green:#1ec28b;
            --amber:#ffc247;
            --red:#ff6070;
            --radius-md:12px;
            --radius-lg:16px;
            --shadow-soft:0 8px 24px rgba(0,0,0,0.45);
            --font-main:-apple-system,BlinkMacSystemFont,"Segoe UI",system-ui,sans-serif;
        }

        * {
            box-sizing:border-box;
            margin:0;
            padding:0;
        }

        body {
            background:var(--bg);
            color:var(--text);
            font:15px/1.6 var(--font-main);
            -webkit-font-smoothing:antialiased;
            padding:18px 12px 40px;
        }

        .container {
            max-width:1440px;
            margin:0 auto;
        }

        .header {
            text-align:center;
            margin-bottom:18px;
        }

        h1 {
            font-size:clamp(30px,6vw,46px);
            line-height:1.1;
            margin-bottom:6px;
            font-weight:800;
            background:linear-gradient(135deg,var(--text),var(--accent-bright));
            -webkit-background-clip:text;
            -webkit-text-fill-color:transparent;
        }

        .subtitle {
            color:var(--muted);
            font-size:0.95rem;
        }

        .meta-badges {
            display:flex;
            flex-wrap:wrap;
            justify-content:center;
            gap:6px;
            margin-top:8px;
            font-size:0.7rem;
            color:var(--muted);
        }

        .badge {
            padding:4px 8px;
            border-radius:999px;
            border:1px solid rgba(255,255,255,0.12);
            background:rgba(255,255,255,0.02);
        }

        .alert-banner {
            margin:16px auto 18px;
            padding:10px 12px;
            max-width:900px;
            border-radius:10px;
            background:linear-gradient(135deg,rgba(107,158,255,0.08),rgba(139,187,255,0.02));
            border:1px solid rgba(107,158,255,0.25);
            font-size:0.8rem;
            color:var(--text);
        }

        .dashboard {
            display:grid;
            grid-template-columns:280px 1fr;
            gap:16px;
            align-items:flex-start;
        }

        .sidebar {
            background:var(--panel);
            border-radius:var(--radius-lg);
            padding:16px 14px 14px;
            box-shadow:var(--shadow-soft);
        }

        .main-content {
            display:grid;
            grid-template-columns:repeat(2,minmax(0,1fr));
            gap:14px;
        }

        .card {
            background:var(--panel);
            border-radius:var(--radius-lg);
            padding:14px 12px 12px;
            box-shadow:var(--shadow-soft);
        }

        .card-title {
            font-size:1rem;
            font-weight:700;
            margin-bottom:8px;
            color:var(--accent-bright);
            display:flex;
            align-items:center;
            gap:6px;
        }

        .card-title span.icon {
            font-size:1.1rem;
        }

        .gauge-container {
            text-align:center;
            margin-bottom:8px;
        }

        .gauge {
            position:relative;
            width:190px;
            height:190px;
            margin:0 auto;
        }

        .gauge-background {
            position:absolute;
            inset:0;
            border-radius:50%;
            background:conic-gradient(
                var(--green) 0deg 108deg,
                var(--amber) 108deg 216deg,
                var(--red) 216deg 360deg
            );
            opacity:0.28;
        }

        .gauge-center {
            position:absolute;
            top:10%;
            left:10%;
            width:80%;
            height:80%;
            border-radius:50%;
            background:var(--panel);
            display:flex;
            flex-direction:column;
            align-items:center;
            justify-content:center;
        }

        .gauge-score {
            font-size:2.4rem;
            font-weight:800;
        }

        .gauge-label {
            font-size:0.7rem;
            color:var(--muted);
            text-transform:uppercase;
            letter-spacing:0.08em;
            margin-top:2px;
        }

        .gauge-needle {
            position:absolute;
            bottom:50%;
            left:50%;
            width:3px;
            height:46%;
            background:var(--accent);
            transform-origin:bottom center;
            transform:translateX(-50%) rotate(0deg);
            border-radius:4px 4px 0 0;
            transition:transform 0.9s ease;
        }

        .risk-meter {
            margin-top:6px;
        }

        .risk-bar {
            height:6px;
            border-radius:4px;
            background:rgba(255,255,255,0.1);
            overflow:hidden;
        }

        .risk-fill {
            height:100%;
            width:0%;
            background:linear-gradient(90deg,var(--green),var(--amber),var(--red));
            transition:width 0.8s ease;
        }

        .risk-labels {
            display:flex;
            justify-content:space-between;
            margin-top:4px;
            font-size:0.65rem;
            color:var(--muted);
        }

        .status-grid {
            display:grid;
            grid-template-columns:repeat(2,minmax(0,1fr));
            gap:6px;
            margin-top:10px;
        }

        .status-item {
            padding:7px 6px;
            background:rgba(255,255,255,0.02);
            border-radius:8px;
            font-size:0.7rem;
        }

        .status-label {
            color:var(--muted);
            font-size:0.66rem;
        }

        .status-value {
            font-weight:700;
            font-size:0.95rem;
            margin:1px 0 0;
        }

        .indicator-grid {
            display:grid;
            grid-template-columns:repeat(auto-fill,minmax(220px,1fr));
            gap:7px;
            margin-top:4px;
        }

        .indicator {
            padding:7px 7px 6px;
            background:rgba(255,255,255,0.03);
            border-radius:8px;
            border-left:3px solid var(--green);
            font-size:0.7rem;
        }

        .indicator.warning { border-left-color:var(--amber); }
        .indicator.danger { border-left-color:var(--red); }

        .indicator-header {
            display:flex;
            justify-content:space-between;
            gap:4px;
            align-items:baseline;
            margin-bottom:2px;
        }

        .indicator-name {
            font-weight:600;
            font-size:0.78rem;
        }

        .indicator-value {
            font-weight:700;
            font-size:0.9rem;
        }

        .indicator-threshold {
            color:var(--muted);
            font-size:0.62rem;
            margin-top:1px;
        }

        .source-tag {
            display:inline-block;
            margin-top:3px;
            padding:2px 5px;
            border-radius:6px;
            border:1px solid rgba(255,255,255,0.14);
            font-size:0.58rem;
            color:var(--muted);
        }

        .manual-input-row {
            display:flex;
            align-items:center;
            gap:3px;
            margin-top:3px;
            font-size:0.6rem;
        }

        .manual-input {
            width:72px;
            padding:2px 4px;
            border-radius:4px;
            border:1px solid rgba(255,255,255,0.25);
            background:rgba(0,0,0,0.5);
            color:var(--text);
            font-size:0.65rem;
            outline:none;
        }

        .manual-input:focus {
            border-color:var(--accent);
            box-shadow:0 0 4px var(--accent);
        }

        .valuation-comparison {
            display:grid;
            grid-template-columns:repeat(auto-fit,minmax(150px,1fr));
            gap:6px;
            margin-top:8px;
            font-size:0.68rem;
        }

        .valuation-item {
            padding:6px;
            background:rgba(255,255,255,0.02);
            border-radius:8px;
            text-align:center;
        }

        .valuation-item.current {
            border:1px solid var(--red);
            background:rgba(255,96,112,0.05);
        }

        .valuation-title {
            font-weight:600;
            margin-bottom:2px;
        }

        .valuation-metric { margin:1px 0; }
        .valuation-outcome { margin-top:2px; color:var(--muted); }

        .insight-card {
            margin-top:6px;
            padding:6px 7px;
            border-radius:8px;
            background:linear-gradient(135deg,rgba(107,158,255,0.10),rgba(10,14,26,1));
            border:1px solid rgba(107,158,255,0.25);
            font-size:0.7rem;
        }

        .chart-container {
            margin-top:4px;
        }

        .history-grid {
            margin-top:6px;
            display:grid;
            grid-template-columns:repeat(auto-fit,minmax(160px,1fr));
            gap:5px;
            font-size:0.66rem;
        }

        .history-item {
            padding:5px;
            border-radius:8px;
            background:rgba(255,255,255,0.02);
        }

        .history-title {
            font-weight:600;
            margin-bottom:1px;
            font-size:0.7rem;
        }

        @media (max-width:900px) {
            body {
                padding:14px 8px 26px;
            }
            .dashboard {
                grid-template-columns:1fr;
            }
            .main-content {
                grid-template-columns:1fr;
            }
            .sidebar {
                order:-1;
            }
        }
    </style>
</head>
<body>
<div class="container">
    <div class="header">
        <h1>âš¡ Economic Crash Radar Pro</h1>
        <div class="subtitle">
            9 core indicators (8 auto, 1 manual) + 2 valuation metrics. All logic visible and deterministic.
        </div>
        <div class="meta-badges">
            <div class="badge" id="cache-badge">FRED cache: not loaded</div>
            <div class="badge">Manual KPIs: 3 (LEI, Buffett, CAPE)</div>
            <div class="badge">Auto KPIs: 8 from FRED</div>
            <div class="badge" id="quality-badge">Methodology: yield-curve & LEI anchored</div>
        </div>
    </div>

    <div class="alert-banner" id="alert-banner">
        Composite stress uses macro indicators plus valuation stress. Sidebar metrics are derived outputs, not hand-edited.
    </div>

    <div class="dashboard">
        <!-- SIDEBAR -->
        <div class="sidebar">
            <div class="gauge-container">
                <div class="gauge">
                    <div class="gauge-background"></div>
                    <div class="gauge-center">
                        <div class="gauge-score" id="composite-score">--</div>
                        <div class="gauge-label" id="regime-label">COMPOSITE STRESS</div>
                    </div>
                    <div class="gauge-needle" id="needle"></div>
                </div>
                <div class="risk-meter">
                    <div class="risk-bar"><div class="risk-fill" id="risk-fill"></div></div>
                    <div class="risk-labels">
                        <span>Low (0-30)</span>
                        <span>Med (30-50)</span>
                        <span>High (50-70)</span>
                        <span>Critical (70-100)</span>
                    </div>
                </div>
            </div>

            <div class="status-grid">
                <div class="status-item">
                    <div class="status-label">Recession Probability (12â€“18m)</div>
                    <div class="status-value" id="recession-risk-display">--</div>
                    <div class="indicator-threshold">Mapped from composite score.</div>
                </div>
                <div class="status-item">
                    <div class="status-label">Valuation Risk</div>
                    <div class="status-value" id="valuation-risk-display">--</div>
                    <div class="indicator-threshold">Buffett + CAPE combined.</div>
                </div>
                <div class="status-item">
                    <div class="status-label">Labor Market Stress</div>
                    <div class="status-value" id="labor-risk-display">--</div>
                    <div class="indicator-threshold">Claims + Sahm Rule.</div>
                </div>
                <div class="status-item">
                    <div class="status-label">Data Coverage</div>
                    <div class="status-value" id="quality-display">--</div>
                    <div class="indicator-threshold">Populated inputs / total.</div>
                </div>
            </div>
        </div>

        <!-- MAIN CONTENT -->
        <div class="main-content">
            <div class="card">
                <div class="card-title"><span class="icon">ðŸ“Š</span>Tier 1 Leading Indicators</div>
                <div class="indicator-grid" id="tier1-indicators"></div>
            </div>

            <div class="card">
                <div class="card-title"><span class="icon">ðŸ“ˆ</span>Tier 2 Confirming Indicators</div>
                <div class="indicator-grid" id="tier2-indicators"></div>
            </div>

            <div class="card">
                <div class="card-title"><span class="icon">ðŸ’°</span>Valuation Indicators</div>
                <div class="indicator-grid" id="valuation-indicators"></div>

                <div class="valuation-comparison">
                    <div class="valuation-item">
                        <div class="valuation-title">2000 Dot-com</div>
                        <div class="valuation-metric">CAPE â‰ˆ 44</div>
                        <div class="valuation-metric">Buffett â‰ˆ 140â€“160%</div>
                        <div class="valuation-outcome">Major drawdown.</div>
                    </div>
                    <div class="valuation-item">
                        <div class="valuation-title">2007 Pre-GFC</div>
                        <div class="valuation-metric">CAPE â‰ˆ 27</div>
                        <div class="valuation-metric">Buffett â‰ˆ 105%</div>
                        <div class="valuation-outcome">Financial crisis.</div>
                    </div>
                    <div class="valuation-item">
                        <div class="valuation-title">2021 Peak</div>
                        <div class="valuation-metric">CAPE â‰ˆ 38</div>
                        <div class="valuation-metric">Buffett â‰ˆ 195%</div>
                        <div class="valuation-outcome">2022 correction.</div>
                    </div>
                    <div class="valuation-item current">
                        <div class="valuation-title">Current (your inputs)</div>
                        <div class="valuation-metric" id="current-buffett-label">Buffett: --</div>
                        <div class="valuation-metric" id="current-cape-label">CAPE: --</div>
                        <div class="valuation-outcome">Auto-updates via manual fields.</div>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-title"><span class="icon">ðŸ•’</span>History, Radar & Prior Recessions</div>
                <div class="chart-container">
                    <canvas id="market-trend" height="130"></canvas>
                </div>
                <div class="chart-container">
                    <canvas id="risk-radar" height="140"></canvas>
                </div>
                <div class="insight-card">
                    <strong>Insight:</strong>
                    <span id="insight-text">
                        Waiting for inputs. Once loaded, this panel contrasts macro stress, valuation excess and known crisis regimes.
                    </span>
                </div>
                <div class="history-grid">
                    <div class="history-item">
                        <div class="history-title">1973â€“75 / 1980 / 1982</div>
                        <div>Deep downturns coincided with inverted curve + tight policy + weak LEI.</div>
                    </div>
                    <div class="history-item">
                        <div class="history-title">2000â€“02</div>
                        <div>Extreme valuations + tightening. Macro rolled over with a lag.</div>
                    </div>
                    <div class="history-item">
                        <div class="history-title">2007â€“09</div>
                        <div>Housing + credit + inversion aligned. Multiple indicators red simultaneously.</div>
                    </div>
                    <div class="history-item">
                        <div class="history-title">2020 Shock</div>
                        <div>Exogenous collapse; traditional leading indicators gave limited warning.</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
'use strict';

/*
 Two internal reviewers baked into the logic:

 Expert A (Performance-first):
 - Wants minimal DOM work, deterministic loops, no redundant recalcs.
 Expert B (Robustness-first):
 - Forces null checks, schema-tolerant FRED parsing, safe math, graceful partial data.

 Code below reflects both: no magical globals, no silent failures on missing series.
*/

// ---- CONFIG ----

const INDICATORS = {
    // TIER 1 (Leading)
    LEI: {
        tier:1,
        label:'Conference Board LEI 6m %Î”',
        weight:0.20,
        threshold:-4.1,
        direction:'below',
        fromFred:false,
        fredId:null,
        current:null,
        format:v => v.toFixed(1) + '%',
        desc:'Manual quarterly input. Composite of forward-looking components.'
    },
    YIELD_CURVE: {
        tier:1,
        label:'Yield Curve (10y-3m)',
        weight:0.15,
        threshold:0,
        direction:'below',
        fromFred:true,
        fredId:'T10Y3M',
        current:null,
        format:v => v.toFixed(2) + '%',
        desc:'T10Y3M. Fed-backed 12â€“18m recession signal.'
    },
    CREDIT_SPREAD: {
        tier:1,
        label:'HY Credit Spread',
        weight:0.12,
        threshold:5.0,
        direction:'above',
        fromFred:true,
        fredId:'BAMLH0A0HYM2',
        current:null,
        format:v => v.toFixed(2) + '%',
        desc:'BAMLH0A0HYM2. Risk & funding stress.'
    },
    CONSUMER_SENTIMENT: {
        tier:1,
        label:'UMich Sentiment',
        weight:0.10,
        threshold:60,
        direction:'below',
        fromFred:true,
        fredId:'UMCSENT',
        current:null,
        format:v => v.toFixed(1),
        desc:'UMCSENT. 3â€“6m leading demand / risk appetite.'
    },
    ISM_NEW_ORDERS: {
        tier:1,
        label:'ISM New Orders',
        weight:0.08,
        threshold:47.5,
        direction:'below',
        fromFred:true,
        fredId:'NAPMNOI',
        current:null,
        format:v => v.toFixed(1),
        desc:'NAPMNOI. Manufacturing demand lead.'
    },
    M2_GROWTH: {
        tier:1,
        label:'M2 Growth YoY',
        weight:0.07,
        threshold:4.0,
        direction:'below',
        fromFred:true,
        fredId:'M2SL',
        current:null,
        format:v => v.toFixed(1) + '%',
        desc:'YoY from M2SL. Liquidity / policy backdrop.'
    },

    // TIER 2 (Confirming)
    INITIAL_CLAIMS: {
        tier:2,
        label:'Initial Claims 4wk MA',
        weight:0.10,
        threshold:323,
        direction:'above',
        fromFred:true,
        fredId:'ICSA',
        current:null,
        format:v => Math.round(v) + 'k',
        desc:'4-week avg. Fast labor stress readout.'
    },
    SAHM_RULE: {
        tier:2,
        label:'Sahm Rule',
        weight:0.10,
        threshold:0.50,
        direction:'above',
        fromFred:true,
        fredId:'SAHMREALTIME',
        current:null,
        format:v => v.toFixed(2),
        desc:'SAHMREALTIME. Recession confirmation.'
    },
    BUILDING_PERMITS: {
        tier:2,
        label:'Building Permits 6m %Î”',
        weight:0.08,
        threshold:-15,
        direction:'below',
        fromFred:true,
        fredId:'PERMIT',
        current:null,
        format:v => v.toFixed(1) + '%',
        desc:'6m %Î” from PERMIT. Housing lead indicator.'
    }
};

const VALUATIONS = {
    BUFFETT: {
        label:'Buffett Indicator (MktCap/GDP)',
        weight:0.50,
        danger:180,
        current:null,
        format:v => v.toFixed(1) + '%',
        desc:'Manual. Wilshire 5000 / GDP.'
    },
    SHILLER_PE: {
        label:'Shiller CAPE',
        weight:0.50,
        danger:30,
        current:null,
        format:v => v.toFixed(1),
        desc:'Manual. Long-term earnings multiple.'
    }
};

const VALUATION_WEIGHT = 0.30; // share of total composite allocated to valuations

let charts = { trend:null, radar:null };
let compositeScore = null;

// ---- FRED CACHE LOADER ----

async function loadFromFredCache() {
    try {
        const res = await fetch('data/fred_cache.json', { cache:'no-store' });
        if (!res.ok) {
            document.getElementById('cache-badge').textContent = 'FRED cache: not found';
            return;
        }

        const cache = await res.json();
        const series = cache.series || {};
        document.getElementById('cache-badge').textContent =
            'FRED cache: ' + (cache.generated_at || 'loaded');

        // helper: tolerant of two formats: {value} or {observations:[{date,value}]}
        const lastVal = id => {
            const s = series[id];
            if (!s) return null;

            if (Array.isArray(s.observations) && s.observations.length) {
                const o = s.observations[s.observations.length - 1];
                const v = (typeof o.value === 'number') ? o.value : parseFloat(o.value);
                return Number.isFinite(v) ? v : null;
            }

            if (s.value !== undefined) {
                const v = (typeof s.value === 'number') ? s.value : parseFloat(s.value);
                return Number.isFinite(v) ? v : null;
            }

            return null;
        };

        const rollingAvgLastN = (id, n) => {
            const s = series[id];
            if (!s) return null;

            if (Array.isArray(s.observations) && s.observations.length >= n) {
                const slice = s.observations.slice(-n);
                const vals = slice.map(o =>
                    (typeof o.value === 'number') ? o.value : parseFloat(o.value)
                ).filter(Number.isFinite);
                if (vals.length < n) return null;
                return vals.reduce((a,v) => a + v, 0) / n;
            }
            return null;
        };

        const obsMonthsBack = (id, months) => {
            const s = series[id];
            if (!s || !Array.isArray(s.observations) || !s.observations.length) return null;

            const last = s.observations[s.observations.length - 1];
            const lastDate = new Date(last.date);
            if (Number.isNaN(lastDate)) return null;

            const target = new Date(lastDate);
            target.setMonth(target.getMonth() - months);

            let candidate = null;
            for (const o of s.observations) {
                const d = new Date(o.date);
                if (Number.isNaN(d)) continue;
                if (d <= target) candidate = o; else break;
            }
            return candidate;
        };

        const pctChange = (nv, ov) => {
            if (!Number.isFinite(nv) || !Number.isFinite(ov) || ov === 0) return null;
            return ((nv - ov) / ov) * 100;
        };

        // map to indicators
        Object.keys(INDICATORS).forEach(key => {
            const ind = INDICATORS[key];
            if (!ind.fromFred || !ind.fredId) return;

            if (ind.fredId === 'M2SL') {
                const last = lastVal('M2SL');
                const back = obsMonthsBack('M2SL', 12);
                if (last != null && back && Number.isFinite(back.value)) {
                    const s = pctChange(last, parseFloat(back.value));
                    if (s != null) ind.current = s;
                }
            } else if (ind.fredId === 'ICSA') {
                const avg = rollingAvgLastN('ICSA', 4);
                if (avg != null) {
                    ind.current = avg / 1000;
                } else {
                    const lv = lastVal('ICSA');
                    if (lv != null) ind.current = lv / 1000;
                }
            } else if (ind.fredId === 'PERMIT') {
                const last = lastVal('PERMIT');
                const back = obsMonthsBack('PERMIT', 6);
                if (last != null && back && Number.isFinite(back.value)) {
                    const s = pctChange(last, parseFloat(back.value));
                    if (s != null) ind.current = s;
                }
            } else {
                const lv = lastVal(ind.fredId);
                if (lv != null) ind.current = lv;
            }
        });

    } catch (err) {
        console.error('FRED cache error:', err);
        document.getElementById('cache-badge').textContent = 'FRED cache: error';
    }
}

// ---- SCORING ----

function scaleIndicator(key, value) {
    const ind = INDICATORS[key];
    if (!ind || !Number.isFinite(value)) return null;

    const t = ind.threshold;
    const dir = ind.direction;
    let stress = 0;

    if (dir === 'below') {
        if (value >= t) {
            stress = 0;
        } else {
            const diff = t - value;
            const base = (t === 0) ? 1 : Math.abs(t);
            stress = Math.min(100, (diff / base) * 100);
        }
    } else {
        if (value <= t) {
            stress = 0;
        } else {
            const diff = value - t;
            const base = (t === 0) ? 1 : Math.abs(t);
            stress = Math.min(100, (diff / base) * 100);
        }
    }

    return Math.max(0, Math.min(100, stress));
}

// valuations: harsh above "danger" to reflect your thresholds
function valuationStress(key, val) {
    const v = VALUATIONS[key];
    if (!v || !Number.isFinite(val)) return null;
    if (val <= v.danger) return 0;

    const ratio = val / v.danger;
    const stress = (ratio - 1) * 300; // each +10% above danger ~30 stress
    return Math.max(0, Math.min(100, stress));
}

function computeComposite() {
    let sum = 0;
    let wsum = 0;

    // macro indicators block
    Object.keys(INDICATORS).forEach(k => {
        const ind = INDICATORS[k];
        const s = scaleIndicator(k, ind.current);
        if (s != null && ind.weight) {
            sum += s * ind.weight;
            wsum += ind.weight;
        }
    });

    // valuations block
    Object.keys(VALUATIONS).forEach(k => {
        const v = VALUATIONS[k];
        const s = valuationStress(k, v.current);
        if (s != null && v.weight) {
            sum += s * v.weight * VALUATION_WEIGHT;
            wsum += v.weight * VALUATION_WEIGHT;
        }
    });

    if (!wsum) return null;
    return sum / wsum;
}

// ---- DERIVED METRICS ----

function derivedRecessionRisk(composite) {
    if (composite == null) return '--';
    const c = composite;

    if (c < 25) return '<10%';
    if (c < 40) return '10â€“20%';
    if (c < 55) return '20â€“30%';
    if (c < 70) return '30â€“50%';
    return '>50%';
}

function derivedValuationRisk() {
    let sum = 0, wsum = 0;
    Object.keys(VALUATIONS).forEach(k => {
        const s = valuationStress(k, VALUATIONS[k].current);
        if (s != null) {
            sum += s * VALUATIONS[k].weight;
            wsum += VALUATIONS[k].weight;
        }
    });
    if (!wsum) return '--';
    const score = Math.round(sum / wsum);
    if (score < 33) return 'Low';
    if (score < 66) return 'Moderate';
    return 'High';
}

function derivedLaborStress() {
    const claims = INDICATORS.INITIAL_CLAIMS.current;
    const sahm = INDICATORS.SAHM_RULE.current;

    if (!Number.isFinite(claims) || !Number.isFinite(sahm)) return '--';

    const cStress = Math.max(0, Math.min(100, (claims - 250) * 0.5));
    const sStress = Math.max(0, Math.min(100, sahm * 200));
    const avg = (cStress + sStress) / 2;

    if (avg < 30) return 'Low';
    if (avg < 60) return 'Moderate';
    return 'High';
}

// ---- RENDERING ----

function buildIndicatorElement(key, ind) {
    const s = scaleIndicator(key, ind.current);
    let cls = 'indicator';
    if (s != null) {
        if (s >= 66) cls += ' danger';
        else if (s >= 33) cls += ' warning';
    }

    const valText = (ind.current != null && Number.isFinite(ind.current))
        ? ind.format(ind.current)
        : '--';

    const threshText = (ind.threshold != null)
        ? `Threshold: ${ind.direction === 'below' ? '<' : '>'} ${ind.format(ind.threshold)}`
        : '';

    const source = ind.fromFred ? 'Auto from FRED' : 'Manual input';

    const manualInput = !ind.fromFred ? `
        <div class="manual-input-row">
            <span>Set:</span>
            <input class="manual-input" type="number" step="0.1"
                data-ind-key="${key}" value="${ind.current != null ? ind.current : ''}">
        </div>` : '';

    const div = document.createElement('div');
    div.className = cls;
    div.innerHTML = `
        <div class="indicator-header">
            <div class="indicator-name">${ind.label}</div>
            <div class="indicator-value">${valText}</div>
        </div>
        <div class="indicator-threshold">${threshText}</div>
        <div class="indicator-threshold">${ind.desc}</div>
        <div class="source-tag">${source}</div>
        ${manualInput}
    `;
    return div;
}

function renderIndicators() {
    const t1 = document.getElementById('tier1-indicators');
    const t2 = document.getElementById('tier2-indicators');
    t1.innerHTML = '';
    t2.innerHTML = '';

    Object.keys(INDICATORS).forEach(key => {
        const ind = INDICATORS[key];
        const el = buildIndicatorElement(key, ind);
        if (ind.tier === 1) t1.appendChild(el);
        else t2.appendChild(el);
    });

    // hook manual LEI input
    document.querySelectorAll('.manual-input[data-ind-key]').forEach(input => {
        input.addEventListener('change', () => {
            const k = input.dataset.indKey;
            const v = parseFloat(input.value);
            if (!Number.isNaN(v) && INDICATORS[k]) {
                INDICATORS[k].current = v;
                updateAll();
            }
        });
    });
}

function renderValuations() {
    const container = document.getElementById('valuation-indicators');
    container.innerHTML = '';

    Object.keys(VALUATIONS).forEach(key => {
        const v = VALUATIONS[key];
        const s = valuationStress(key, v.current);
        let cls = 'indicator';
        if (s != null) {
            if (s >= 66) cls += ' danger';
            else if (s >= 33) cls += ' warning';
        }

        const valText = (v.current != null && Number.isFinite(v.current))
            ? v.format(v.current)
            : '--';

        const div = document.createElement('div');
        div.className = cls;
        div.innerHTML = `
            <div class="indicator-header">
                <div class="indicator-name">${v.label}</div>
                <div class="indicator-value">${valText}</div>
            </div>
            <div class="indicator-threshold">Danger threshold: ${v.danger}</div>
            <div class="indicator-threshold">${v.desc}</div>
            <div class="source-tag">Manual input</div>
            <div class="manual-input-row">
                <span>Set:</span>
                <input class="manual-input" type="number" step="0.1"
                    data-val-key="${key}" value="${v.current != null ? v.current : ''}">
            </div>
        `;
        container.appendChild(div);
    });

    // input listeners
    document.querySelectorAll('.manual-input[data-val-key]').forEach(input => {
        input.addEventListener('change', () => {
            const k = input.dataset.valKey;
            const v = parseFloat(input.value);
            if (!Number.isNaN(v) && VALUATIONS[k]) {
                VALUATIONS[k].current = v;
                updateAll();
            }
        });
    });

    // update comparison panel labels
    const b = VALUATIONS.BUFFETT.current;
    const c = VALUATIONS.SHILLER_PE.current;
    document.getElementById('current-buffett-label').textContent =
        (b != null && Number.isFinite(b)) ? `Buffett: ${b.toFixed(1)}%` : 'Buffett: --';
    document.getElementById('current-cape-label').textContent =
        (c != null && Number.isFinite(c)) ? `CAPE: ${c.toFixed(1)}` : 'CAPE: --';
}

function renderGaugeAndStatus() {
    compositeScore = computeComposite();
    const scoreEl = document.getElementById('composite-score');
    const needle = document.getElementById('needle');
    const riskFill = document.getElementById('risk-fill');
    const regimeLabel = document.getElementById('regime-label');
    const alert = document.getElementById('alert-banner');

    if (compositeScore == null) {
        scoreEl.textContent = '--';
        regimeLabel.textContent = 'COMPOSITE STRESS (insufficient data)';
        riskFill.style.width = '0%';
        needle.style.transform = 'translateX(-50%) rotate(0deg)';
        document.getElementById('recession-risk-display').textContent = '--';
        document.getElementById('valuation-risk-display').textContent = '--';
        document.getElementById('labor-risk-display').textContent = '--';
        document.getElementById('quality-display').textContent = '--';
        return;
    }

    const val = Math.round(compositeScore);
    scoreEl.textContent = val;
    riskFill.style.width = val + '%';

    const angle = (val / 100) * 360;
    needle.style.transform = `translateX(-50%) rotate(${angle}deg)`;

    let label;
    if (val <= 30) label = 'Low stress regime';
    else if (val <= 50) label = 'Elevated â€” monitor';
    else if (val <= 70) label = 'High â€” defensive bias';
    else label = 'Critical regime';
    regimeLabel.textContent = `COMPOSITE STRESS â€” ${label}`;

    const filled = Object.keys(INDICATORS).filter(k => Number.isFinite(INDICATORS[k].current)).length +
                   Object.keys(VALUATIONS).filter(k => Number.isFinite(VALUATIONS[k].current)).length;
    const total = Object.keys(INDICATORS).length + Object.keys(VALUATIONS).length;
    const coverage = total ? Math.round((filled / total) * 100) : 0;
    document.getElementById('quality-display').textContent = coverage + '%';

    document.getElementById('recession-risk-display').textContent = derivedRecessionRisk(val);
    document.getElementById('valuation-risk-display').textContent = derivedValuationRisk();
    document.getElementById('labor-risk-display').textContent = derivedLaborStress();

    if (val >= 70) {
        alert.innerHTML = `<strong>Critical:</strong> Composite stress = ${val}. Multiple systems flashing. Check all inputs and data timestamps.`;
    } else if (val >= 50) {
        alert.innerHTML = `<strong>Warning:</strong> Composite stress = ${val}. Elevated risk based on current verified inputs.`;
    } else {
        alert.textContent = `Composite stress = ${val}. Macro + valuation mix currently not in a historically dangerous cluster, based on your inputs.`;
    }

    const qualityBadge = document.getElementById('quality-badge');
    qualityBadge.textContent = `Inputs: ${filled}/${total} populated`;
}

// ---- CHARTS ----

function renderMarketTrendChart() {
    const canvas = document.getElementById('market-trend');
    if (!canvas) return;
    const ctx = canvas.getContext('2d');

    if (charts.trend) charts.trend.destroy();

    const base = compositeScore != null ? compositeScore : 40;

    // simple illustrative back-series anchored to current composite
    const labels = ['T-10', 'T-8', 'T-6', 'T-4', 'T-2', 'Now'];
    const compData = [0.7,0.8,0.9,0.95,0.98,1].map(f =>
        Math.max(0, Math.min(100, Math.round(base * f)))
    );

    let valSum = 0, valW = 0;
    Object.keys(VALUATIONS).forEach(k => {
        const s = valuationStress(k, VALUATIONS[k].current);
        if (s != null) {
            valSum += s * VALUATIONS[k].weight;
            valW += VALUATIONS[k].weight;
        }
    });
    const valBase = valW ? (valSum / valW) : 30;
    const valData = [0.75,0.85,0.92,0.96,0.99,1].map(f =>
        Math.max(0, Math.min(100, Math.round(valBase * f)))
    );

    charts.trend = new Chart(ctx, {
        type:'line',
        data:{
            labels,
            datasets:[
                {
                    label:'Composite Stress',
                    data:compData,
                    borderColor:'#6b9eff',
                    backgroundColor:'rgba(107,158,255,0.14)',
                    tension:0.32,
                    fill:true,
                    pointRadius:2
                },
                {
                    label:'Valuation Stress',
                    data:valData,
                    borderColor:'#ff6070',
                    backgroundColor:'rgba(255,96,112,0.12)',
                    tension:0.32,
                    fill:true,
                    pointRadius:2
                }
            ]
        },
        options:{
            responsive:true,
            plugins:{
                legend:{ labels:{ color:'#e8eeff', font:{ size:9 } } },
                title:{
                    display:true,
                    text:'Stress & Valuation Trajectory (Illustrative)',
                    color:'#e8eeff',
                    font:{ size:11 }
                }
            },
            scales:{
                y:{
                    min:0,
                    max:100,
                    ticks:{ color:'#8b96b0', font:{ size:8 } },
                    grid:{ color:'rgba(255,255,255,0.08)' }
                },
                x:{
                    ticks:{ color:'#8b96b0', font:{ size:8 } },
                    grid:{ color:'rgba(255,255,255,0.06)' }
                }
            }
        }
    });
}

function renderRiskRadarChart() {
    const canvas = document.getElementById('risk-radar');
    if (!canvas) return;
    const ctx = canvas.getContext('2d');

    if (charts.radar) charts.radar.destroy();

    const labels = [];
    const data = [];

    Object.keys(INDICATORS).forEach(k => {
        const ind = INDICATORS[k];
        const s = scaleIndicator(k, ind.current);
        if (s != null) {
            labels.push(ind.label);
            data.push(Math.round(s));
        }
    });

    // aggregate valuation stress as one spoke
    let valSum = 0, valW = 0;
    Object.keys(VALUATIONS).forEach(k => {
        const s = valuationStress(k, VALUATIONS[k].current);
        if (s != null) {
            valSum += s * VALUATIONS[k].weight;
            valW += VALUATIONS[k].weight;
        }
    });
    if (valW) {
        labels.push('Valuations (Buffett + CAPE)');
        data.push(Math.round(valSum / valW));
    }

    if (!labels.length) return;

    charts.radar = new Chart(ctx, {
        type:'radar',
        data:{
            labels,
            datasets:[{
                label:'Normalized Stress (0â€“100)',
                data,
                borderColor:'#6b9eff',
                backgroundColor:'rgba(107,158,255,0.18)',
                pointRadius:2
            }]
        },
        options:{
            responsive:true,
            plugins:{
                legend:{ display:false },
            },
            scales:{
                r:{
                    angleLines:{ color:'rgba(255,255,255,0.05)' },
                    grid:{ color:'rgba(255,255,255,0.09)' },
                    suggestedMin:0,
                    suggestedMax:100,
                    ticks:{ display:false },
                    pointLabels:{
                        color:'#8b96b0',
                        font:{ size:7 }
                    }
                }
            }
        }
    });
}

// ---- INSIGHT TEXT ----

function updateInsight() {
    const el = document.getElementById('insight-text');
    if (!el) return;

    const comp = compositeScore;
    const valRisk = derivedValuationRisk();

    if (comp == null) {
        el.textContent = 'Awaiting populated indicators. Once in place, this panel benchmarks today versus past stress regimes.';
        return;
    }

    if (comp >= 70 && valRisk === 'High') {
        el.textContent = 'Macro stress and valuations are both in historical danger territory. This profile resembles pre-crisis clusters; treat as high risk if inputs are verified.';
    } else if (comp >= 50 && valRisk !== 'Low') {
        el.textContent = 'Elevated macro stress with stretched valuations. Not yet a confirmed crisis cluster, but asymmetry is poor.';
    } else if (comp < 40 && valRisk === 'High') {
        el.textContent = 'Macro indicators are relatively calm but valuations are extreme. Classic â€œvaluation without catalystâ€ regimeâ€”crash timing uncertain, downside potential large.';
    } else if (comp < 40 && valRisk === 'Low') {
        el.textContent = 'Macro and valuations both moderate. Historically associated with benign or early-cycle environments.';
    } else {
        el.textContent = 'Signals are mixed. Use the radar and individual tiles to see exactly which levers are driving risk.';
    }
}

// ---- MASTER UPDATE ----

function updateAll() {
    renderIndicators();
    renderValuations();
    renderGaugeAndStatus();
    renderMarketTrendChart();
    renderRiskRadarChart();
    updateInsight();
}

// ---- INIT ----

document.addEventListener('DOMContentLoaded', async () => {
    await loadFromFredCache();
    updateAll();
});
</script>
</body>
</html>
