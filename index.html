<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>CrashRadar v7 – Diagnostics</title>

  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background:#0a0e1a;
      color:#e8eeff;
      padding:20px;
    }
    #log {
      background:#12182b;
      padding:20px;
      border-radius:12px;
      white-space:pre-wrap;
      font-family: monospace;
      font-size:13px;
      overflow-x:auto;
    }
    h1 { margin-bottom:10px; }
    button {
      background:#6b9eff;
      border:none;
      padding:10px 16px;
      border-radius:8px;
      margin-bottom:20px;
      cursor:pointer;
    }
  </style>

  <script type="module">
    import * as DataService from './js/dataService.js';
    import * as HistoryService from './js/historyService.js';
    import * as IndicatorProcessor from './js/indicatorProcessor.js';
    import * as Analytics from './js/analytics.js';
    import { INDICATOR_CONFIG } from './js/config.js';

    const logEl = document.getElementById("log");
    const log = (msg) => logEl.textContent += msg + "\n";

    async function runDiagnostics() {
      log("=== CrashRadar v7 DIAGNOSTICS START ===");

      // 1. TEST CACHE LOAD
      log("\n[1] Testing DataService.loadCache()...");
      let cache = null;
      try {
        cache = await DataService.loadCache();
        log("✔ Cache loaded successfully.");
        log("Keys: " + Object.keys(cache).length);
      } catch (err) {
        log("✖ ERROR loading cache: " + err.message);
      }

      // 2. TEST SERIES LOOKUP
      log("\n[2] Testing HistoryService.findSeries()...");
      for (const id of Object.keys(INDICATOR_CONFIG)) {
        try {
          const result = HistoryService.findSeries(cache, INDICATOR_CONFIG[id].fredId);
          if (!result) {
            log(`✖ ${id} — NO MATCH FOUND for fredId: ${INDICATOR_CONFIG[id].fredId}`);
          } else {
            log(`✔ ${id} — series found with ${result.data.length} points`);
          }
        } catch (err) {
          log(`✖ ${id} — ERROR in findSeries(): ${err}`);
        }
      }

      // 3. TEST PROCESSING OF LATEST VALUES
      log("\n[3] Testing IndicatorProcessor for stress calculations...");
      for (const id of Object.keys(INDICATOR_CONFIG)) {
        try {
          const indicator = INDICATOR_CONFIG[id];
          const series = HistoryService.findSeries(cache, indicator.fredId);

          const latest = series ? series.data.at(-1)?.value : null;
          const processed = IndicatorProcessor.processIndicator(id, latest, series);

          if (!processed) {
            log(`✖ ${id} — processIndicator() returned NULL`);
          } else if (!processed.stressScore && processed.stressScore !== 0) {
            log(`✖ ${id} — Missing stressScore.`);
          } else {
            log(`✔ ${id} — stressScore=${processed.stressScore}, verdict=${processed.verdict}`);
          }

        } catch (err) {
          log(`✖ ${id} — ERROR in processIndicator(): ${err}`);
        }
      }

      // 4. TEST COMPOSITE ENGINE
      log("\n[4] Testing Analytics.computeComposite()...");
      try {
        const stressMap = {};
        for (const id of Object.keys(INDICATOR_CONFIG)) {
          stressMap[id] = 50; // dummy test value
        }
        const composite = Analytics.computeComposite(stressMap);
        log("✔ Composite calculation executed.");
        log("Value: " + composite);
      } catch (err) {
        log("✖ ERROR in composite calculation: " + err);
      }

      log("\n=== Diagnostics Complete ===");
    }

    window.runDiagnostics = runDiagnostics;
  </script>
</head>

<body>
  <h1>CrashRadar v7 Diagnostics Console</h1>
  <button onclick="runDiagnostics()">Run Full Diagnostics</button>

  <pre id="log"></pre>
</body>
</html>
