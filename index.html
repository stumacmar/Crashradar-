<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Economic Crash Radar Pro</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <style>
    :root {
      --bg:#0a0e1a;
      --panel:#12182b;
      --text:#e8eeff;
      --muted:#8b96b0;
      --accent:#6b9eff;
      --accent-soft:#8fb4ff;
      --green:#1ec28b;
      --amber:#ffc247;
      --red:#ff6070;
      --radius-lg:16px;
      --shadow-soft:0 8px 24px rgba(0,0,0,0.45);
      --font-main:-apple-system,BlinkMacSystemFont,"Segoe UI",system-ui,sans-serif;
    }
    *{margin:0;padding:0;box-sizing:border-box;}
    body{
      background:var(--bg);
      color:var(--text);
      font:15px/1.6 var(--font-main);
      -webkit-font-smoothing:antialiased;
      padding:18px 12px 40px;
    }
    .container{max-width:1440px;margin:0 auto;}
    .header{text-align:center;margin-bottom:18px;}
    h1{
      font-size:clamp(30px,6vw,46px);
      font-weight:800;
      margin-bottom:6px;
      background:linear-gradient(135deg,var(--text),var(--accent-soft));
      -webkit-background-clip:text;
      -webkit-text-fill-color:transparent;
    }
    .subtitle{
      color:var(--muted);
      font-size:0.95rem;
    }
    .meta-badges{
      display:flex;
      flex-wrap:wrap;
      justify-content:center;
      gap:6px;
      margin-top:8px;
      font-size:0.7rem;
      color:var(--muted);
    }
    .badge{
      padding:4px 8px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,0.12);
      background:rgba(255,255,255,0.02);
    }
    .alert-banner{
      margin:16px auto 18px;
      padding:10px 12px;
      max-width:900px;
      border-radius:10px;
      background:linear-gradient(135deg,rgba(107,158,255,0.08),rgba(139,187,255,0.02));
      border:1px solid rgba(107,158,255,0.25);
      font-size:0.8rem;
      color:var(--text);
    }
    .dashboard{
      display:grid;
      grid-template-columns:280px 1fr;
      gap:16px;
      align-items:flex-start;
    }
    .sidebar{
      background:var(--panel);
      border-radius:var(--radius-lg);
      padding:16px 14px 14px;
      box-shadow:var(--shadow-soft);
    }
    .main-content{
      display:grid;
      grid-template-columns:repeat(2,minmax(0,1fr));
      gap:14px;
    }
    .card{
      background:var(--panel);
      border-radius:var(--radius-lg);
      padding:14px 12px 12px;
      box-shadow:var(--shadow-soft);
    }
    .card-title{
      font-size:1rem;
      font-weight:700;
      color:var(--accent-soft);
      display:flex;
      align-items:center;
      gap:6px;
      margin-bottom:8px;
    }
    .card-title .icon{font-size:1.1rem;}
    .gauge-container{text-align:center;margin-bottom:8px;}
    .gauge{
      position:relative;
      width:190px;
      height:190px;
      margin:0 auto;
    }
    .gauge-background{
      position:absolute;
      inset:0;
      border-radius:50%;
      background:conic-gradient(
        var(--green) 0deg 108deg,
        var(--amber) 108deg 216deg,
        var(--red) 216deg 360deg
      );
      opacity:0.28;
    }
    .gauge-center{
      position:absolute;
      top:10%;
      left:10%;
      width:80%;
      height:80%;
      border-radius:50%;
      background:var(--panel);
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
    }
    .gauge-score{
      font-size:2.4rem;
      font-weight:800;
    }
    .gauge-label{
      font-size:0.7rem;
      color:var(--muted);
      text-transform:uppercase;
      letter-spacing:0.08em;
      margin-top:2px;
    }
    .gauge-needle{
      position:absolute;
      bottom:50%;
      left:50%;
      width:3px;
      height:46%;
      background:var(--accent);
      transform-origin:bottom center;
      transform:translateX(-50%) rotate(0deg);
      border-radius:4px 4px 0 0;
      transition:transform 0.9s ease;
    }
    .risk-meter{margin-top:6px;}
    .risk-bar{
      height:6px;
      border-radius:4px;
      background:rgba(255,255,255,0.1);
      overflow:hidden;
    }
    .risk-fill{
      height:100%;
      width:0%;
      background:linear-gradient(90deg,var(--green),var(--amber),var(--red));
      transition:width 0.8s ease;
    }
    .risk-labels{
      display:flex;
      justify-content:space-between;
      margin-top:4px;
      font-size:0.65rem;
      color:var(--muted);
    }
    .status-grid{
      display:grid;
      grid-template-columns:repeat(2,minmax(0,1fr));
      gap:6px;
      margin-top:10px;
    }
    .status-item{
      padding:7px 6px;
      background:rgba(255,255,255,0.02);
      border-radius:8px;
      font-size:0.7rem;
    }
    .status-label{
      color:var(--muted);
      font-size:0.66rem;
    }
    .status-value{
      font-weight:700;
      font-size:0.95rem;
      margin-top:1px;
    }
    .indicator-grid{
      display:grid;
      grid-template-columns:repeat(auto-fill,minmax(220px,1fr));
      gap:7px;
      margin-top:4px;
    }
    .indicator{
      padding:7px 7px 6px;
      background:rgba(255,255,255,0.03);
      border-radius:8px;
      border-left:3px solid var(--green);
      font-size:0.7rem;
    }
    .indicator.warning{border-left-color:var(--amber);}
    .indicator.danger{border-left-color:var(--red);}
    .indicator-header{
      display:flex;
      justify-content:space-between;
      gap:4px;
      align-items:baseline;
      margin-bottom:2px;
    }
    .indicator-name{
      font-weight:600;
      font-size:0.78rem;
    }
    .indicator-value{
      font-weight:700;
      font-size:0.9rem;
    }
    .indicator-threshold{
      color:var(--muted);
      font-size:0.62rem;
      margin-top:1px;
    }
    .source-tag{
      display:inline-block;
      margin-top:3px;
      padding:2px 5px;
      border-radius:6px;
      border:1px solid rgba(255,255,255,0.14);
      font-size:0.58rem;
      color:var(--muted);
    }
    .manual-input-row{
      display:flex;
      align-items:center;
      gap:3px;
      margin-top:3px;
      font-size:0.6rem;
    }
    .manual-input{
      width:72px;
      padding:2px 4px;
      border-radius:4px;
      border:1px solid rgba(255,255,255,0.25);
      background:rgba(0,0,0,0.5);
      color:var(--text);
      font-size:0.65rem;
      outline:none;
    }
    .manual-input:focus{
      border-color:var(--accent);
      box-shadow:0 0 4px var(--accent);
    }
    .valuation-comparison{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(150px,1fr));
      gap:6px;
      margin-top:8px;
      font-size:0.68rem;
    }
    .valuation-item{
      padding:6px;
      background:rgba(255,255,255,0.02);
      border-radius:8px;
      text-align:center;
    }
    .valuation-item.current{
      border:1px solid var(--red);
      background:rgba(255,96,112,0.05);
    }
    .valuation-title{
      font-weight:600;
      margin-bottom:2px;
    }
    .valuation-metric{margin:1px 0;}
    .valuation-outcome{
      margin-top:2px;
      color:var(--muted);
    }
    .insight-card{
      margin-top:6px;
      padding:6px 7px;
      border-radius:8px;
      background:linear-gradient(135deg,rgba(107,158,255,0.10),rgba(10,14,26,1));
      border:1px solid rgba(107,158,255,0.25);
      font-size:0.7rem;
    }
    .chart-container{margin-top:4px;}
    .history-grid{
      margin-top:6px;
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(160px,1fr));
      gap:5px;
      font-size:0.66rem;
    }
    .history-item{
      padding:5px;
      border-radius:8px;
      background:rgba(255,255,255,0.02);
    }
    .history-title{
      font-weight:600;
      margin-bottom:1px;
      font-size:0.7rem;
    }
    @media(max-width:900px){
      body{padding:14px 8px 26px;}
      .dashboard{grid-template-columns:1fr;}
      .main-content{grid-template-columns:1fr;}
      .sidebar{order:-1;}
    }
  </style>
</head>
<body>
<div class="container">
  <div class="header">
    <h1>âš¡ Economic Crash Radar Pro</h1>
    <div class="subtitle">
      9 indicators (8 auto from FRED, 1 manual) + 2 valuations. Transparent, deterministic logic.
    </div>
    <div class="meta-badges">
      <div class="badge" id="cache-badge">FRED cache: not loaded</div>
      <div class="badge">Manual: LEI, Buffett, CAPE</div>
      <div class="badge">Auto: Yield, HY, UMich, ISM, M2, Claims, Sahm, Permits</div>
      <div class="badge" id="inputs-badge">Inputs: 0/11 populated</div>
    </div>
  </div>

  <div class="alert-banner" id="alert-banner">
    Composite stress = 70% macro indicators + 30% valuations when both blocks have data.
  </div>

  <div class="dashboard">
    <!-- SIDEBAR -->
    <div class="sidebar">
      <div class="gauge-container">
        <div class="gauge">
          <div class="gauge-background"></div>
          <div class="gauge-center">
            <div class="gauge-score" id="composite-score">--</div>
            <div class="gauge-label" id="regime-label">COMPOSITE STRESS</div>
          </div>
          <div class="gauge-needle" id="needle"></div>
        </div>
        <div class="risk-meter">
          <div class="risk-bar">
            <div class="risk-fill" id="risk-fill"></div>
          </div>
          <div class="risk-labels">
            <span>Low (0-30)</span>
            <span>Med (30-50)</span>
            <span>High (50-70)</span>
            <span>Critical (70-100)</span>
          </div>
        </div>
      </div>
      <div class="status-grid">
        <div class="status-item">
          <div class="status-label">Recession Probability (12â€“18m)</div>
          <div class="status-value" id="recession-risk-display">--</div>
          <div class="indicator-threshold">Mapped from composite.</div>
        </div>
        <div class="status-item">
          <div class="status-label">Valuation Risk</div>
          <div class="status-value" id="valuation-risk-display">--</div>
          <div class="indicator-threshold">Buffett + CAPE combined.</div>
        </div>
        <div class="status-item">
          <div class="status-label">Labor Market Stress</div>
          <div class="status-value" id="labor-risk-display">--</div>
          <div class="indicator-threshold">Claims + Sahm.</div>
        </div>
        <div class="status-item">
          <div class="status-label">Data Coverage</div>
          <div class="status-value" id="quality-display">--</div>
          <div class="indicator-threshold">Filled indicators / total.</div>
        </div>
      </div>
    </div>

    <!-- MAIN -->
    <div class="main-content">
      <div class="card">
        <div class="card-title"><span class="icon">ðŸ“Š</span>Tier 1 Leading Indicators</div>
        <div class="indicator-grid" id="tier1-indicators"></div>
      </div>

      <div class="card">
        <div class="card-title"><span class="icon">ðŸ“ˆ</span>Tier 2 Confirming Indicators</div>
        <div class="indicator-grid" id="tier2-indicators"></div>
      </div>

      <div class="card">
        <div class="card-title"><span class="icon">ðŸ’°</span>Valuation Indicators</div>
        <div class="indicator-grid" id="valuation-indicators"></div>

        <div class="valuation-comparison">
          <div class="valuation-item">
            <div class="valuation-title">2000 Dot-com</div>
            <div class="valuation-metric">CAPE â‰ˆ 44</div>
            <div class="valuation-metric">Buffett â‰ˆ 140â€“160%</div>
            <div class="valuation-outcome">Severe drawdown.</div>
          </div>
          <div class="valuation-item">
            <div class="valuation-title">2007 Pre-GFC</div>
            <div class="valuation-metric">CAPE â‰ˆ 27</div>
            <div class="valuation-metric">Buffett â‰ˆ 105%</div>
            <div class="valuation-outcome">Crisis.</div>
          </div>
          <div class="valuation-item">
            <div class="valuation-title">2021 Peak</div>
            <div class="valuation-metric">CAPE â‰ˆ 38</div>
            <div class="valuation-metric">Buffett â‰ˆ 195%</div>
            <div class="valuation-outcome">2022 correction.</div>
          </div>
          <div class="valuation-item current">
            <div class="valuation-title">Current (your inputs)</div>
            <div class="valuation-metric" id="current-buffett-label">Buffett: --</div>
            <div class="valuation-metric" id="current-cape-label">CAPE: --</div>
            <div class="valuation-outcome">Reflects manual entries.</div>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="card-title"><span class="icon">ðŸ•’</span>History, Radar & Prior Recessions</div>
        <div class="chart-container">
          <canvas id="market-trend" height="130"></canvas>
        </div>
        <div class="chart-container">
          <canvas id="risk-radar" height="140"></canvas>
        </div>
        <div class="insight-card">
          <strong>Insight:</strong>
          <span id="insight-text">
            Once populated, this compares todayâ€™s configuration to prior stress regimes.
          </span>
        </div>
        <div class="history-grid">
          <div class="history-item">
            <div class="history-title">1973â€“75 / early 80s</div>
            <div>Curve inversion + energy shocks + weak leads.</div>
          </div>
          <div class="history-item">
            <div class="history-title">2000â€“02</div>
            <div>Extreme valuations, tightening, growth rollover.</div>
          </div>
          <div class="history-item">
            <div class="history-title">2007â€“09</div>
            <div>Housing + credit + inversion aligned.</div>
          </div>
          <div class="history-item">
            <div class="history-title">2020</div>
            <div>External shock; indicator behavior distinct.</div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
'use strict';

// ==== CONFIG ====

const VALUATION_BLOCK_WEIGHT = 0.30;

const INDICATORS = {
  LEI: {
    tier:1,
    label:'Conference Board LEI 6m %Î”',
    weight:0.20,
    threshold:-4.1,
    direction:'below',
    fromFred:false,
    fredId:null,
    current:null,
    format:function(v){return v.toFixed(1) + '%';},
    desc:'Manual quarterly input.'
  },
  YIELD_CURVE: {
    tier:1,
    label:'Yield Curve (10y-3m)',
    weight:0.15,
    threshold:0,
    direction:'below',
    fromFred:true,
    fredId:'T10Y3M',
    current:null,
    format:function(v){return v.toFixed(2) + '%';},
    desc:'T10Y3M. 12â€“18m lead.'
  },
  CREDIT_SPREAD: {
    tier:1,
    label:'HY Credit Spread',
    weight:0.12,
    threshold:5.0,
    direction:'above',
    fromFred:true,
    fredId:'BAMLH0A0HYM2',
    current:null,
    format:function(v){return v.toFixed(2) + '%';},
    desc:'BAMLH0A0HYM2. Credit stress.'
  },
  CONSUMER_SENTIMENT: {
    tier:1,
    label:'UMich Sentiment',
    weight:0.10,
    threshold:60,
    direction:'below',
    fromFred:true,
    fredId:'UMCSENT',
    current:null,
    format:function(v){return v.toFixed(1);},
    desc:'UMCSENT. Demand & confidence.'
  },
  ISM_NEW_ORDERS: {
    tier:1,
    label:'ISM New Orders',
    weight:0.08,
    threshold:47.5,
    direction:'below',
    fromFred:true,
    fredId:'NAPMNOI',
    current:null,
    format:function(v){return v.toFixed(1);},
    desc:'NAPMNOI. Manufacturing lead.'
  },
  M2_GROWTH: {
    tier:1,
    label:'M2 Growth YoY',
    weight:0.07,
    threshold:4.0,
    direction:'below',
    fromFred:true,
    fredId:'M2SL',
    current:null,
    format:function(v){return v.toFixed(1) + '%';},
    desc:'YoY from M2SL. Liquidity regime.'
  },
  INITIAL_CLAIMS: {
    tier:2,
    label:'Initial Claims 4wk MA',
    weight:0.10,
    threshold:323,
    direction:'above',
    fromFred:true,
    fredId:'ICSA',
    current:null,
    format:function(v){return Math.round(v) + 'k';},
    desc:'4-week avg. Labor market turn.'
  },
  SAHM_RULE: {
    tier:2,
    label:'Sahm Rule',
    weight:0.10,
    threshold:0.50,
    direction:'above',
    fromFred:true,
    fredId:'SAHMREALTIME',
    current:null,
    format:function(v){return v.toFixed(2);},
    desc:'>= 0.5 is recession confirmation.'
  },
  BUILDING_PERMITS: {
    tier:2,
    label:'Building Permits 6m %Î”',
    weight:0.08,
    threshold:-15,
    direction:'below',
    fromFred:true,
    fredId:'PERMIT',
    current:null,
    format:function(v){return v.toFixed(1) + '%';},
    desc:'6m change. Housing lead.'
  }
};

const VALUATIONS = {
  BUFFETT: {
    label:'Buffett Indicator (MktCap/GDP)',
    weight:0.50,
    danger:180,
    current:null,
    format:function(v){return v.toFixed(1) + '%';},
    desc:'Manual. Wilshire 5000 / GDP.'
  },
  SHILLER_PE: {
    label:'Shiller CAPE',
    weight:0.50,
    danger:30,
    current:null,
    format:function(v){return v.toFixed(1);},
    desc:'Manual. Long-term earnings multiple.'
  }
};

var charts = { trend:null, radar:null };
var compositeScore = null;

// ==== FRED LOADER ====

async function loadFromFredCache(){
  try{
    var res = await fetch('data/fred_cache.json', { cache:'no-store' });
    if(!res.ok){
      document.getElementById('cache-badge').textContent = 'FRED cache: not found';
      return;
    }
    var cache = await res.json();
    var series = cache.series || {};
    document.getElementById('cache-badge').textContent =
      'FRED cache: ' + (cache.generated_at || 'loaded');

    function lastVal(id){
      var s = series[id];
      if(!s || !Array.isArray(s.observations) || !s.observations.length) return null;
      var o = s.observations[s.observations.length - 1];
      var v = Number(o.value);
      return isFinite(v) ? v : null;
    }

    function obsMonthsBack(id, months){
      var s = series[id];
      if(!s || !Array.isArray(s.observations) || !s.observations.length) return null;
      var last = s.observations[s.observations.length - 1];
      var lastDate = new Date(last.date);
      if(isNaN(lastDate)) return null;
      var target = new Date(lastDate);
      target.setMonth(target.getMonth() - months);
      var candidate = null;
      for(var i=0;i<s.observations.length;i++){
        var o = s.observations[i];
        var d = new Date(o.date);
        if(isNaN(d)) continue;
        if(d <= target) candidate = o; else break;
      }
      return candidate;
    }

    function rollingAvgLastN(id, n){
      var s = series[id];
      if(!s || !Array.isArray(s.observations) || s.observations.length < n) return null;
      var slice = s.observations.slice(-n);
      var vals = [];
      for(var i=0;i<slice.length;i++){
        var v = Number(slice[i].value);
        if(isFinite(v)) vals.push(v);
      }
      if(vals.length < n) return null;
      var sum = 0;
      for(i=0;i<vals.length;i++) sum += vals[i];
      return sum / n;
    }

    function pctChange(nv, ov){
      var n = Number(nv), o = Number(ov);
      if(!isFinite(n) || !isFinite(o) || o === 0) return null;
      return ((n - o) / o) * 100;
    }

    // Map into indicator state
    Object.keys(INDICATORS).forEach(function(k){
      var ind = INDICATORS[k];
      if(!ind.fromFred || !ind.fredId) return;

      if(ind.fredId === 'M2SL'){
        var last = lastVal('M2SL');
        var back = obsMonthsBack('M2SL', 12);
        if(last != null && back && back.value != null){
          var pc = pctChange(last, back.value);
          if(pc != null) ind.current = pc;
        }
      } else if(ind.fredId === 'ICSA'){
        var avg = rollingAvgLastN('ICSA', 4);
        if(avg != null) ind.current = avg / 1000;
      } else if(ind.fredId === 'PERMIT'){
        var pl = lastVal('PERMIT');
        var pb = obsMonthsBack('PERMIT', 6);
        if(pl != null && pb && pb.value != null){
          var pc2 = pctChange(pl, pb.value);
          if(pc2 != null) ind.current = pc2;
        }
      } else {
        var v = lastVal(ind.fredId);
        if(v != null) ind.current = v;
      }
    });

  }catch(e){
    console.error('FRED cache error:', e);
    document.getElementById('cache-badge').textContent = 'FRED cache: error';
  }
}

// ==== SCORING ====

function scaleIndicator(key, value){
  var ind = INDICATORS[key];
  if(!ind || !isFinite(value)) return null;
  var t = ind.threshold;
  var dir = ind.direction;
  var base = (t === 0) ? 1 : Math.abs(t);
  var stress = 0;

  if(dir === 'below' && value < t){
    stress = Math.min(100, ((t - value) / base) * 100);
  } else if(dir === 'above' && value > t){
    stress = Math.min(100, ((value - t) / base) * 100);
  }
  if(stress < 0) stress = 0;
  if(stress > 100) stress = 100;
  return stress;
}

function valuationStress(key, val){
  var v = VALUATIONS[key];
  if(!v || !isFinite(val)) return null;
  if(val <= v.danger) return 0;
  var ratio = val / v.danger;
  var stress = (ratio - 1) * 300; // aggressive scaling
  if(stress < 0) stress = 0;
  if(stress > 100) stress = 100;
  return stress;
}

function computeComposite(){
  var mSum = 0, mW = 0;
  Object.keys(INDICATORS).forEach(function(k){
    var ind = INDICATORS[k];
    var s = scaleIndicator(k, ind.current);
    if(s != null && ind.weight){
      mSum += s * ind.weight;
      mW   += ind.weight;
    }
  });
  var macroAvg = mW > 0 ? (mSum / mW) : null;

  var vSum = 0, vW = 0;
  Object.keys(VALUATIONS).forEach(function(k){
    var s = valuationStress(k, VALUATIONS[k].current);
    var v = VALUATIONS[k];
    if(s != null && v.weight){
      vSum += s * v.weight;
      vW   += v.weight;
    }
  });
  var valAvg = vW > 0 ? (vSum / vW) : null;

  if(macroAvg == null && valAvg == null) return null;
  if(macroAvg != null && valAvg != null){
    return macroAvg * (1 - VALUATION_BLOCK_WEIGHT) + valAvg * VALUATION_BLOCK_WEIGHT;
  }
  return macroAvg != null ? macroAvg : valAvg;
}

// ==== DERIVED ====

function derivedRecessionRisk(c){
  if(c == null) return '--';
  if(c < 25) return '<10%';
  if(c < 40) return '10â€“20%';
  if(c < 55) return '20â€“30%';
  if(c < 70) return '30â€“50%';
  return '>50%';
}

function derivedValuationRisk(){
  var sum = 0, w = 0;
  Object.keys(VALUATIONS).forEach(function(k){
    var s = valuationStress(k, VALUATIONS[k].current);
    var v = VALUATIONS[k];
    if(s != null && v.weight){
      sum += s * v.weight;
      w   += v.weight;
    }
  });
  if(!w) return '--';
  var sc = Math.round(sum / w);
  if(sc < 33) return 'Low';
  if(sc < 66) return 'Moderate';
  return 'High';
}

function derivedLaborStress(){
  var c = INDICATORS.INITIAL_CLAIMS.current;
  var s = INDICATORS.SAHM_RULE.current;
  if(!isFinite(c) || !isFinite(s)) return '--';
  var cs = Math.max(0, Math.min(100, (c - 250) * 0.5));
  var ss = Math.max(0, Math.min(100, s * 200));
  var avg = (cs + ss) / 2;
  if(avg < 30) return 'Low';
  if(avg < 60) return 'Moderate';
  return 'High';
}

// ==== RENDER ====

function buildIndicatorElement(key, ind){
  var s = scaleIndicator(key, ind.current);
  var cls = 'indicator';
  if(s != null){
    if(s >= 66) cls += ' danger';
    else if(s >= 33) cls += ' warning';
  }
  var hasVal = isFinite(ind.current);
  var valText = hasVal ? ind.format(ind.current) : '--';
  var thr = ind.threshold != null
    ? ('Threshold: ' + (ind.direction === 'below' ? '< ' : '> ') + ind.format(ind.threshold))
    : '';
  var src = ind.fromFred ? 'Auto from FRED' : 'Manual input';

  var manual = '';
  if(!ind.fromFred){
    manual =
      '<div class="manual-input-row">' +
      '<span>Set:</span>' +
      '<input class="manual-input" type="number" step="0.1" data-ind-key="'+key+'" value="'+(hasVal ? ind.current : '')+'">' +
      '</div>';
  }

  var div = document.createElement('div');
  div.className = cls;
  div.innerHTML =
    '<div class="indicator-header">' +
      '<div class="indicator-name">'+ind.label+'</div>' +
      '<div class="indicator-value">'+valText+'</div>' +
    '</div>' +
    '<div class="indicator-threshold">'+thr+'</div>' +
    '<div class="indicator-threshold">'+ind.desc+(ind.fromFred && !hasVal ? ' (no usable data)' : '')+'</div>' +
    '<div class="source-tag">'+src+'</div>' +
    manual;
  return div;
}

function renderIndicators(){
  var t1 = document.getElementById('tier1-indicators');
  var t2 = document.getElementById('tier2-indicators');
  t1.innerHTML = '';
  t2.innerHTML = '';

  Object.keys(INDICATORS).forEach(function(k){
    var ind = INDICATORS[k];
    var el = buildIndicatorElement(k, ind);
    if(ind.tier === 1) t1.appendChild(el);
    else t2.appendChild(el);
  });

  // manual LEI input
  var manualInputs = document.querySelectorAll('.manual-input[data-ind-key]');
  for(var i=0;i<manualInputs.length;i++){
    (function(inp){
      function handler(){
        var key = inp.getAttribute('data-ind-key');
        var v = parseFloat(inp.value);
        if(!isNaN(v)) INDICATORS[key].current = v;
        else INDICATORS[key].current = null;
        updateAll();
      }
      inp.addEventListener('input', handler);
      inp.addEventListener('change', handler);
    })(manualInputs[i]);
  }
}

function renderValuations(){
  var box = document.getElementById('valuation-indicators');
  box.innerHTML = '';

  Object.keys(VALUATIONS).forEach(function(k){
    var v = VALUATIONS[k];
    var s = valuationStress(k, v.current);
    var cls = 'indicator';
    if(s != null){
      if(s >= 66) cls += ' danger';
      else if(s >= 33) cls += ' warning';
    }
    var hasVal = isFinite(v.current);
    var valText = hasVal ? v.format(v.current) : '--';

    var div = document.createElement('div');
    div.className = cls;
    div.innerHTML =
      '<div class="indicator-header">' +
        '<div class="indicator-name">'+v.label+'</div>' +
        '<div class="indicator-value">'+valText+'</div>' +
      '</div>' +
      '<div class="indicator-threshold">Danger threshold: '+v.danger+'</div>' +
      '<div class="indicator-threshold">'+v.desc+'</div>' +
      '<div class="source-tag">Manual input</div>' +
      '<div class="manual-input-row">' +
        '<span>Set:</span>' +
        '<input class="manual-input" type="number" step="0.1" data-val-key="'+k+'" value="'+(hasVal ? v.current : '')+'">' +
      '</div>';
    box.appendChild(div);
  });

  // attach handlers (Buffett + CAPE)
  var valInputs = document.querySelectorAll('.manual-input[data-val-key]');
  for(var i=0;i<valInputs.length;i++){
    (function(inp){
      function handler(){
        var key = inp.getAttribute('data-val-key');
        var v = parseFloat(inp.value);
        if(!isNaN(v)) VALUATIONS[key].current = v;
        else VALUATIONS[key].current = null;
        updateAll();
      }
      inp.addEventListener('input', handler);
      inp.addEventListener('change', handler);
    })(valInputs[i]);
  }

  // sync "Current (your inputs)" labels
  var b = VALUATIONS.BUFFETT.current;
  var c = VALUATIONS.SHILLER_PE.current;
  document.getElementById('current-buffett-label').textContent =
    isFinite(b) ? ('Buffett: ' + b.toFixed(1) + '%') : 'Buffett: --';
  document.getElementById('current-cape-label').textContent =
    isFinite(c) ? ('CAPE: ' + c.toFixed(1)) : 'CAPE: --';
}

function renderGaugeAndStatus(){
  compositeScore = computeComposite();

  var scoreEl = document.getElementById('composite-score');
  var needle = document.getElementById('needle');
  var fill = document.getElementById('risk-fill');
  var regimeEl = document.getElementById('regime-label');
  var alert = document.getElementById('alert-banner');

  var total = Object.keys(INDICATORS).length + Object.keys(VALUATIONS).length;
  var used =
    Object.keys(INDICATORS).filter(function(k){return isFinite(INDICATORS[k].current);}).length +
    Object.keys(VALUATIONS).filter(function(k){return isFinite(VALUATIONS[k].current);}).length;

  document.getElementById('inputs-badge').textContent =
    'Inputs: ' + used + '/' + total + ' populated';
  document.getElementById('quality-display').textContent =
    total ? Math.round(used / total * 100) + '%' : '--';

  if(compositeScore == null){
    scoreEl.textContent = '--';
    fill.style.width = '0%';
    needle.style.transform = 'translateX(-50%) rotate(0deg)';
    regimeEl.textContent = 'COMPOSITE STRESS (insufficient data)';
    document.getElementById('recession-risk-display').textContent = '--';
    document.getElementById('valuation-risk-display').textContent = '--';
    document.getElementById('labor-risk-display').textContent = '--';
    alert.textContent = 'No composite yet. Check FRED cache and manual inputs.';
    return;
  }

  var v = Math.round(compositeScore);
  scoreEl.textContent = v;
  fill.style.width = v + '%';
  var angle = (v / 100) * 360;
  needle.style.transform = 'translateX(-50%) rotate(' + angle + 'deg)';

  var regime;
  if(v <= 30) regime = 'Low stress regime';
  else if(v <= 50) regime = 'Elevated â€” monitor';
  else if(v <= 70) regime = 'High â€” defensive bias';
  else regime = 'Critical regime';
  regimeEl.textContent = 'COMPOSITE STRESS â€” ' + regime;

  document.getElementById('recession-risk-display').textContent =
    derivedRecessionRisk(v);
  document.getElementById('valuation-risk-display').textContent =
    derivedValuationRisk();
  document.getElementById('labor-risk-display').textContent =
    derivedLaborStress();

  if(v >= 70){
    alert.innerHTML = '<strong>Critical:</strong> Composite = ' + v +
      '. Macro + valuations in historical danger cluster.';
  }else if(v >= 50){
    alert.innerHTML = '<strong>Warning:</strong> Composite = ' + v +
      '. Elevated risk â€” inspect indicator tiles.';
  }else{
    alert.textContent =
      'Composite = ' + v +
      '. On your inputs, configuration is not yet in the classic crash cluster, but always cross-check.';
  }
}

function renderMarketTrendChart(){
  var ctx = document.getElementById('market-trend').getContext('2d');
  if(charts.trend){ charts.trend.destroy(); }

  var base = compositeScore != null ? compositeScore : 40;
  var labels = ['T-10','T-8','T-6','T-4','T-2','Now'];
  var compData = [0.7,0.8,0.9,0.95,0.98,1].map(function(f){
    var x = base * f;
    if(x < 0) x = 0;
    if(x > 100) x = 100;
    return Math.round(x);
  });

  var vSum = 0, vW = 0;
  Object.keys(VALUATIONS).forEach(function(k){
    var s = valuationStress(k, VALUATIONS[k].current);
    var v = VALUATIONS[k];
    if(s != null && v.weight){
      vSum += s * v.weight;
      vW   += v.weight;
    }
  });
  var valBase = vW ? (vSum / vW) : 30;
  var valData = [0.75,0.85,0.92,0.96,0.99,1].map(function(f){
    var x = valBase * f;
    if(x < 0) x = 0;
    if(x > 100) x = 100;
    return Math.round(x);
  });

  charts.trend = new Chart(ctx, {
    type:'line',
    data:{
      labels:labels,
      datasets:[
        {
          label:'Composite Stress',
          data:compData,
          borderColor:'#6b9eff',
          backgroundColor:'rgba(107,158,255,0.14)',
          tension:0.32,
          fill:true,
          pointRadius:2
        },
        {
          label:'Valuation Stress',
          data:valData,
          borderColor:'#ff6070',
          backgroundColor:'rgba(255,96,112,0.12)',
          tension:0.32,
          fill:true,
          pointRadius:2
        }
      ]
    },
    options:{
      responsive:true,
      plugins:{
        legend:{labels:{color:'#e8eeff',font:{size:9}}},
        title:{
          display:true,
          text:'Stress & Valuation Trajectory (Illustrative)',
          color:'#e8eeff',
          font:{size:11}
        }
      },
      scales:{
        y:{
          min:0,
          max:100,
          ticks:{color:'#8b96b0',font:{size:8}},
          grid:{color:'rgba(255,255,255,0.08)'}
        },
        x:{
          ticks:{color:'#8b96b0',font:{size:8}},
          grid:{color:'rgba(255,255,255,0.06)'}
        }
      }
    }
  });
}

function renderRiskRadarChart(){
  var ctx = document.getElementById('risk-radar').getContext('2d');
  if(charts.radar){ charts.radar.destroy(); }

  var labels = [];
  var data = [];

  Object.keys(INDICATORS).forEach(function(k){
    var ind = INDICATORS[k];
    var s = scaleIndicator(k, ind.current);
    if(s != null){
      labels.push(ind.label);
      data.push(Math.round(s));
    }
  });

  var vSum = 0, vW = 0;
  Object.keys(VALUATIONS).forEach(function(k){
    var s = valuationStress(k, VALUATIONS[k].current);
    var v = VALUATIONS[k];
    if(s != null && v.weight){
      vSum += s * v.weight;
      vW   += v.weight;
    }
  });
  if(vW){
    labels.push('Valuations (Buffett + CAPE)');
    data.push(Math.round(vSum / vW));
  }

  if(!labels.length){ return; }

  charts.radar = new Chart(ctx, {
    type:'radar',
    data:{
      labels:labels,
      datasets:[{
        label:'Normalized Stress (0â€“100)',
        data:data,
        borderColor:'#6b9eff',
        backgroundColor:'rgba(107,158,255,0.18)',
        pointRadius:2
      }]
    },
    options:{
      responsive:true,
      plugins:{legend:{display:false}},
      scales:{
        r:{
          angleLines:{color:'rgba(255,255,255,0.05)'},
          grid:{color:'rgba(255,255,255,0.09)'},
          suggestedMin:0,
          suggestedMax:100,
          ticks:{display:false},
          pointLabels:{color:'#8b96b0',font:{size:7}}
        }
      }
    }
  });
}

function updateInsight(){
  var el = document.getElementById('insight-text');
  if(!el) return;
  var c = compositeScore;
  var vRisk = derivedValuationRisk();

  if(c == null){
    el.textContent = 'No composite yet. Ensure FRED cache is updated and manual LEI / valuations are set.';
  } else if(c >= 70 && vRisk === 'High'){
    el.textContent = 'Macro and valuations both extreme. Historically associated with major drawdowns.';
  } else if(c >= 50 && vRisk !== 'Low'){
    el.textContent = 'Elevated macro stress with stretched valuations. Asymmetry poor.';
  } else if(c < 40 && vRisk === 'High'){
    el.textContent = 'Macro ok but valuations rich. Vulnerable to shocks or policy surprises.';
  } else if(c < 40 && vRisk === 'Low'){
    el.textContent = 'Macro and valuations both moderate vs history. No obvious crash cluster.';
  } else {
    el.textContent = 'Mixed configuration. Use radar and tiles to see which levers are driving risk.';
  }
}

function updateAll(){
  renderIndicators();
  renderValuations();
  renderGaugeAndStatus();
  renderMarketTrendChart();
  renderRiskRadarChart();
  updateInsight();
}

// ==== INIT ====

document.addEventListener('DOMContentLoaded', function(){
  loadFromFredCache().then(function(){
    updateAll();
  }).catch(function(e){
    console.error(e);
    updateAll();
  });
});
</script>
</body>
</html>
