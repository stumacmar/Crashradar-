<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>CrashRadar v4 — Recession Risk Composite</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<style>
  :root {
    --bg:#0b0f24; --card:#161b3a; --ring:#0f1430;
    --text:#eef0ff; --muted:#9aa2c9;
    --ok:#21d07a; --warn:#ffd166; --risk:#ff5c7a;
  }
  html,body{margin:0;background:var(--bg);color:var(--text);font:15px system-ui,Segoe UI,Roboto,Helvetica,Arial}
  header{padding:16px;text-align:center;border-bottom:1px solid rgba(255,255,255,.08)}
  h1{margin:0;font-size:22px}
  .sub{color:var(--muted);font-size:12px}
  main{padding:12px;max-width:1100px;margin:auto}
  .card{background:var(--card);border-radius:12px;padding:14px;margin:10px 0}
  .row{display:grid;grid-template-columns:1fr;gap:12px}
  @media(min-width:900px){.row{grid-template-columns:1.3fr 1fr}}
  .pill{display:inline-block;background:var(--ring);border-radius:999px;padding:8px 10px;margin:6px 8px 0 0;color:var(--muted);font-weight:600}
  .pill b{color:var(--text)}
  .badge{display:inline-block;border-radius:10px;padding:4px 8px;font-weight:700;margin-left:8px}
  .g{background:rgba(33,208,122,.16);color:var(--ok)}
  .y{background:rgba(255,209,102,.18);color:var(--warn)}
  .r{background:rgba(255,92,122,.18);color:var(--risk)}
  .gauge{--deg:0deg;--col:var(--ok);width:180px;height:180px;border-radius:50%;
         background:conic-gradient(var(--col) var(--deg), #2a2f55 var(--deg));
         display:grid;place-items:center;margin:auto;position:relative}
  .gauge:after{content:"";position:absolute;inset:12px;border-radius:50%;background:var(--ring)}
  .gauge-val{position:relative;font-weight:800;font-size:28px}
  .chart{position:relative;height:260px;margin:10px 0;background:#10163a;border-radius:10px;padding:8px}
  .chart canvas{width:100% !important;height:100% !important;display:block}
  details{background:#10163a;padding:10px;border-radius:8px}
  summary{cursor:pointer}
  pre{white-space:pre-wrap;background:#0f1430;border-radius:8px;padding:10px;color:#ffd166;overflow:auto;max-height:360px;margin:8px 0 0}
</style>
</head>
<body>
<header>
  <h1>CrashRadar v4 — Recession Risk Composite</h1>
  <div id="status" class="sub">Loading <code>data/fred_cache.json</code>…</div>
</header>

<main>
  <section class="card row">
    <div>
      <div class="gauge" id="gauge"><div id="gval" class="gauge-val">—</div></div>
      <div style="text-align:center;margin-top:8px">
        <span id="badge" class="badge">—</span><br>
        <span class="sub">Green ≤ 30 • Amber ≤ 60 • Red &gt; 60</span>
      </div>
    </div>
    <div>
      <b>Key Inputs</b>
      <div class="pill">Yield (10y–3m): <b id="k_term">—</b></div>
      <div class="pill">Credit (BAA–AAA): <b id="k_credit">—</b></div>
      <div class="pill">Unemployment Δ6m: <b id="k_un">—</b></div>
      <div class="pill">Drawdown 12m: <b id="k_dd">—</b></div>
      <div class="pill">NFCI: <b id="k_nfci">—</b></div>
      <div id="fresh" class="sub" style="margin-top:8px">Data freshness: —</div>
    </div>
  </section>

  <section class="card" id="charts">
    <b>Composite & Indicators</b>
    <div class="chart" id="compWrap"><canvas id="cComp"></canvas></div>
    <div class="chart" id="termWrap"><canvas id="cTerm"></canvas></div>
    <div class="chart" id="creditWrap"><canvas id="cCredit"></canvas></div>
    <div class="chart" id="unWrap"><canvas id="cUn"></canvas></div>
    <div class="chart" id="ddWrap"><canvas id="cDD"></canvas></div>
    <div class="chart" id="nfciWrap"><canvas id="cNFCI"></canvas></div>
  </section>

  <section class="card">
    <b>Diagnostics</b>
    <details><summary>Open raw JSON</summary><pre id="diag">Waiting…</pre></details>
  </section>
</main>

<script>
const $=s=>document.querySelector(s);
const fmt=(x,d=2)=>Number.isFinite(x)?(+x).toFixed(d):'—';
function setBadge(score){
  const b=$('#badge'); b.className='badge';
  if(!Number.isFinite(score)){ b.textContent='—'; return; }
  if(score<=30){ b.textContent='GREEN'; b.classList.add('g'); }
  else if(score<=60){ b.textContent='AMBER'; b.classList.add('y'); }
  else{ b.textContent='RED'; b.classList.add('r'); }
}
function renderGauge(score){
  const g=$('#gauge'),v=$('#gval');
  const s=Number.isFinite(score)?Math.max(0,Math.min(score,100)):NaN;
  v.textContent=Number.isFinite(s)?s.toFixed(1):'—';
  const deg=Number.isFinite(s)?(s/100)*360:0;
  const col=!Number.isFinite(s)?'var(--ok)':(s<=30?'var(--ok)':s<=60?'var(--warn)':'var(--risk)');
  g.style.background=`conic-gradient(${col} ${deg}deg, #2a2f55 ${deg}deg)`;
  setBadge(s);
}
function arrFrom(o){return o?.observations?.map(x=>({d:x.date,v:+x.value})).filter(x=>Number.isFinite(x.v))||[];}
function drawLine(id,title,points,color='#7ea6ff',yFmt=null){
  if(!points.length)return;
  const ctx=document.getElementById(id).getContext('2d');
  new Chart(ctx,{type:'line',data:{labels:points.map(p=>p.d),datasets:[{data:points.map(p=>p.v),borderColor:color,fill:false,tension:.25,pointRadius:0}]},
  options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false},title:{display:true,text:title,color:'#cfe3ff'}},
  scales:{x:{ticks:{color:'#9aa2c9'},grid:{color:'rgba(255,255,255,.06)'}},y:{ticks:{color:'#9aa2c9',callback:yFmt||((v)=>v)},grid:{color:'rgba(255,255,255,.06)'}}}}});
}

// === Econometric Normalisation ===
function normYield(v){return (!Number.isFinite(v))?NaN:v>=2?0:v<=-1?100:((2-v)/3)*100;}
function normCredit(v){return (!Number.isFinite(v))?NaN:Math.min(100,Math.max(0,(v-1)*50));}
function normUn(v){return (!Number.isFinite(v))?NaN:v<=0?0:v>=1?80:v*80;}
function normDD(v){return (!Number.isFinite(v))?NaN:Math.min(100,Math.max(0,(-v)*300));}
function normNFCI(v){return (!Number.isFinite(v))?NaN:v<=-0.5?0:v>=1?100:(v+0.5)*66;}

// === Main ===
(async()=>{
try{
  const r=await fetch('data/fred_cache.json',{cache:'no-store'});
  const txt=await r.text(); $('#diag').textContent=txt;
  const j=JSON.parse(txt),S=j.series||{};
  $('#status').textContent='✅ Cache loaded';
  $('#fresh').textContent=j.fetched_at_utc?new Date(j.fetched_at_utc).toLocaleString():'—';

  const sY=arrFrom(S.T10Y3M||{}), sC=arrFrom(S.CREDIT||{}), sU=arrFrom(S.UN_SLOPE6||{}), sD=arrFrom(S.DD_12M||{}), sN=arrFrom(S.NFCI||{});
  const y=Number.isFinite(+S.T10Y3M?.last)?+S.T10Y3M.last:(sY.at(-1)?.v??NaN);
  const c=Number.isFinite(+S.CREDIT?.last)?+S.CREDIT.last:(sC.at(-1)?.v??NaN);
  const u=Number.isFinite(+S.UN_SLOPE6?.last)?+S.UN_SLOPE6.last:(sU.at(-1)?.v??NaN);
  const d=Number.isFinite(+S.DD_12M?.last)?+S.DD_12M.last:(sD.at(-1)?.v??NaN);
  const n=Number.isFinite(+S.NFCI?.last)?+S.NFCI.last:(sN.at(-1)?.v??NaN);

  $('#k_term').textContent=fmt(y);
  $('#k_credit').textContent=fmt(c);
  $('#k_un').textContent=fmt(u);
  $('#k_dd').textContent=(Number.isFinite(d)?(d*100).toFixed(1)+'%':'—');
  $('#k_nfci').textContent=fmt(n);

  const ry=normYield(y),rc=normCredit(c),ru=normUn(u),rd=normDD(d),rn=normNFCI(n);
  const composite=(ry*0.25)+(rc*0.25)+(ru*0.2)+(rd*0.15)+(rn*0.15);
  renderGauge(composite);

  // Charts
  drawLine('cComp','Composite (norm.)',[{d:'Now',v:composite}],'#a7c4ff');
  if(sY.length)drawLine('cTerm','Yield Curve',sY,'#66b2ff');
  if(sC.length)drawLine('cCredit','Credit Spread',sC,'#ffb366');
  if(sU.length)drawLine('cUn','Unemployment Δ6m',sU,'#ff8899');
  if(sD.length)drawLine('cDD','Drawdown 12m',sD,'#b49eff',(v)=>(v*100).toFixed(0)+'%');
  if(sN.length)drawLine('cNFCI','NFCI',sN,'#7dd39f',(v)=>v.toFixed(2));

}catch(e){
  $('#status').textContent='❌ '+e.message;
  $('#diag').textContent=e.stack||String(e);
  renderGauge(NaN);
}
})();
</script>
</body>
</html>
