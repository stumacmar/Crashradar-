<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>CrashRadar — Composite Crash Risk</title>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

<style>
  :root{
    --bg:#0e1326; --card:#161b3a; --muted:#9aa2c9; --text:#eef0ff; --accent:#7ea6ff;
    --ok:#21d07a; --warn:#ffd166; --risk:#ff5c7a; --ring:#0f1430;
  }
  html,body{margin:0;background:var(--bg);color:var(--text);font:15px system-ui,Segoe UI,Roboto,Helvetica,Arial}
  a{color:var(--accent)}
  header{padding:18px 14px}
  h1{margin:0 0 6px;font-size:26px;color:#7ea6ff}
  main{padding:0 12px 28px;max-width:1040px;margin:0 auto}
  .grid{display:grid;grid-template-columns:1fr;gap:12px}
  @media(min-width:980px){.grid{grid-template-columns:1.2fr 1fr}}
  .card{background:var(--card);border-radius:12px;padding:16px}
  .row{display:grid;grid-template-columns:1fr;gap:12px}
  @media(min-width:760px){.row{grid-template-columns:1fr 1fr}}
  .kpi{font-size:42px;font-weight:800}
  .sub{color:var(--muted);font-size:12px}
  .pill{display:inline-block;background:#0f1430;border-radius:999px;padding:8px 10px;margin:6px 8px 0 0;color:var(--muted);font-weight:600}
  .pill b{color:var(--text)}
  .badge{display:inline-block;border-radius:10px;padding:4px 8px;font-weight:700;margin-left:6px}
  .g{background:rgba(33,208,122,.16);color:var(--ok)}
  .y{background:rgba(255,209,102,.18);color:var(--warn)}
  .r{background:rgba(255,92,122,.18);color:var(--risk)}

  /* Gauge */
  .gauge-wrap{display:flex;gap:18px;align-items:center;flex-wrap:wrap}
  .gauge{
    --deg: 0deg; --col: var(--ok);
    width:160px;height:160px;border-radius:50%;
    background:
      conic-gradient(var(--col) var(--deg), #2a2f55 var(--deg));
    display:grid;place-items:center;position:relative;
  }
  .gauge:after{
    content:""; position:absolute; inset:10px; border-radius:50%;
    background:var(--ring);
  }
  .gauge-val{
    position:relative; font-weight:800; font-size:26px;
  }
  .gauge-label{font-size:12px;color:var(--muted);margin-top:-6px}

  /* Charts */
  .chart{position:relative;height:260px;margin:12px 0 6px}
  .chart canvas{display:block;width:100% !important;height:100% !important}
  .blurb{font-size:13px;color:#cfe3ff;line-height:1.35}
  .blurb em{color:var(--muted);font-style:normal}

  pre{white-space:pre-wrap;background:#0f1430;border-radius:8px;padding:10px;color:#ffd166;overflow:auto;max-height:360px}
  .err{color:#ff6b6b}
</style>
</head>
<body>
<header>
  <h1>CrashRadar — Composite Crash Risk</h1>
  <div id="loadStatus" class="sub">Reading <code>data/fred_cache.json</code> …</div>
</header>

<main>
  <section class="grid">
    <!-- LEFT: Composite -->
    <div class="card">
      <div style="display:flex;justify-content:space-between;gap:16px;align-items:flex-start;flex-wrap:wrap">
        <div class="gauge-wrap">
          <div id="gauge" class="gauge">
            <div class="gauge-val" id="gaugeVal">—</div>
          </div>
          <div>
            <div style="font-weight:700;font-size:18px;margin-bottom:4px">
              Composite Score <span id="riskBadge" class="badge">—</span>
            </div>
            <div class="sub">Lower is safer. Thresholds: <b>≤0.50 Green</b>, <b>0.51–1.00 Amber</b>, <b>≥1.01 Red</b>.</div>
            <div id="fresh" class="sub" style="margin-top:6px">Data freshness: —</div>
            <div id="expl" class="sub" style="margin-top:6px;max-width:520px">
              The composite blends <em>yield curve, credit spread, unemployment slope, equity drawdown</em> and <em>NFCI</em>, each scaled to be comparable, then weighted.
            </div>
          </div>
        </div>
      </div>
      <div class="chart"><canvas id="cComp"></canvas></div>
      <div class="blurb">
        <b>Composite (30-day rolling proxy).</b> A smoothed view of the overall risk mix using recent readings. The ring above shows the current GAR zone and how far into that zone the score is.
      </div>
    </div>

    <!-- RIGHT: Latest quick KPIs -->
    <aside class="card">
      <b>Latest readings</b>
      <div class="pill">Term (10y–3m): <b id="k_term">—</b></div>
      <div class="pill">Credit (BAA–AAA): <b id="k_credit">—</b></div>
      <div class="pill">Unemp 6m slope: <b id="k_un">—</b></div>
      <div class="pill">12m Drawdown: <b id="k_dd">—</b></div>
      <div class="pill">NFCI: <b id="k_nfci">—</b></div>
      <div class="sub" style="margin-top:8px">Tip: values are raw; the composite uses normalized versions so movements are comparable.</div>
    </aside>
  </section>

  <!-- Indicator charts with descriptions -->
  <section class="card">
    <b>Indicators</b>
    <div class="row">
      <div>
        <div class="chart"><canvas id="cTerm"></canvas></div>
        <div class="blurb">
          <b>Yield Curve (10y–3m spread).</b> <em>More negative = worse.</em> Inversions (below zero) tend to precede recessions and major drawdowns as policy tightness bites.
        </div>
      </div>
      <div>
        <div class="chart"><canvas id="cCredit"></canvas></div>
        <div class="blurb">
          <b>Credit Spread (BAA–AAA).</b> <em>Wider = worse.</em> Rising lower-grade borrowing costs vs. top-tier reflect stress building in corporate credit.
        </div>
      </div>
      <div>
        <div class="chart"><canvas id="cUn"></canvas></div>
        <div class="blurb">
          <b>Unemployment 6-month slope.</b> <em>Rising = worse.</em> Early deterioration in labor markets is a classic late-cycle risk signal.
        </div>
      </div>
      <div>
        <div class="chart"><canvas id="cDD"></canvas></div>
        <div class="blurb">
          <b>12-month Drawdown (S&amp;P vs. 1-yr peak).</b> <em>More negative = worse.</em> Captures market-price stress, complementing macro/credit indicators.
        </div>
      </div>
      <div>
        <div class="chart"><canvas id="cNFCI"></canvas></div>
        <div class="blurb">
          <b>Chicago Fed NFCI.</b> <em>Higher = tighter/worse.</em> Summarizes overall financial conditions (rates, credit, funding, volatility).
        </div>
      </div>
    </div>
  </section>

  <section class="card">
    <b>Insights</b>
    <ul id="insights" class="sub" style="margin:.4rem 0 0 .9rem"></ul>
  </section>

  <section class="card">
    <b>Diagnostics</b>
    <div id="diagHead" class="sub" style="margin:8px 0 6px">Loading…</div>
    <pre id="diag">Waiting…</pre>
  </section>
</main>

<script>
/* ======= Helpers ======= */
const $ = s => document.querySelector(s);
const fmt = (x,d=2)=>Number.isFinite(x)?(+x).toFixed(d):'—';

/* Gauge control (conic-gradient ring) */
function renderGauge(score){
  const g = $('#gauge'), gv = $('#gaugeVal'), badge = $('#riskBadge');
  g.style.setProperty('--deg','0deg'); g.style.setProperty('--col','var(--ok)');
  gv.textContent = '—'; badge.className='badge'; badge.textContent='—';
  if(!Number.isFinite(score)) return;

  gv.textContent = score.toFixed(2);
  let col = 'var(--ok)', label = 'GREEN';
  if(score <= 0.50){ col = 'var(--ok)'; label='GREEN'; badge.classList.add('g'); }
  else if(score <= 1.00){ col = 'var(--warn)'; label='AMBER'; badge.classList.add('y'); }
  else { col = 'var(--risk)'; label='RED'; badge.classList.add('r'); }
  badge.textContent = label;

  // Fill ring proportionally inside its GAR zone (cap 0..2)
  const cap = Math.max(0, Math.min(score, 2.0));
  const deg = (cap/2.0)*360;
  g.style.setProperty('--deg', deg+'deg');
  g.style.setProperty('--col', col);
}

/* Charts */
function chartOptions(title, formatter=null){
  return {
    responsive:true, maintainAspectRatio:false,
    plugins:{ legend:{display:false}, title:{display:true,text:title,color:'#cfe3ff'} },
    scales:{
      x:{ ticks:{color:'#9aa2c9',maxRotation:0,autoSkip:true}, grid:{color:'rgba(255,255,255,.06)'} },
      y:{ ticks:{color:'#9aa2c9', callback: formatter || ((v)=>v) }, grid:{color:'rgba(255,255,255,.06)'} }
    },
    elements:{ line:{ tension:0.2 }, point:{ radius:0 } }
  };
}
const liveCharts = new Map();
function drawLine(canvasId, title, labels, values, yFormatter=null){
  const el = document.getElementById(canvasId);
  if(!el) return;
  const ctx = el.getContext('2d');
  if(liveCharts.has(canvasId)){ try{ liveCharts.get(canvasId).destroy(); }catch(e){} }
  liveCharts.set(canvasId, new Chart(ctx, {
    type:'line',
    data:{ labels, datasets:[{ label:title, data:values, borderColor:'#7ea6ff', backgroundColor:'rgba(126,166,255,.18)' }] },
    options: chartOptions(title, yFormatter)
  }));
}

/* Convert observations -> labels/values */
function toSeries(obs, n=260){
  if(!Array.isArray(obs)) return {labels:[], values:[]};
  const clean = obs.filter(o => o && o.date && Number.isFinite(+o.value))
                   .map(o => ({d:o.date, v:+o.value}));
  const take = clean.slice(-n);
  return { labels: take.map(x=>x.d), values: take.map(x=>x.v) };
}

(async function(){
  const status = $('#loadStatus'), diag = $('#diag'), head=$('#diagHead');
  try{
    const r = await fetch('data/fred_cache.json', {cache:'no-store'});
    if(!r.ok) throw new Error(`HTTP ${r.status}`);
    const txt = await r.text();
    let j; try{ j = JSON.parse(txt); }catch(e){ throw new Error('Invalid JSON: '+e.message); }

    head.textContent = 'Cache loaded.'; diag.textContent = txt;
    status.textContent = '✅ Cache file found and parsed.';

    const fetchedAt = j.fetched_at_utc || j.last_updated || (j.composite_score && j.composite_score.last_updated) || null;
    $('#fresh').textContent = fetchedAt ? new Date(fetchedAt).toLocaleString() : '—';

    const comp = (j.composite_score && typeof j.composite_score.score === 'number')
                  ? j.composite_score.score
                  : (typeof j.score === 'number' ? j.score : NaN);
    renderGauge(comp);

    // Series + latest KPIs
    const S = j.series || {};
    const lastVal = key => {
      const arr = S[key]?.observations || [];
      return arr.length ? +arr[arr.length-1].value : NaN;
    };
    $('#k_term').textContent   = fmt(lastVal('T10Y3M'));
    $('#k_credit').textContent = fmt(lastVal('CREDIT'));
    $('#k_un').textContent     = fmt(lastVal('UN_SLOPE6'));
    const dd = lastVal('DD_12M'); $('#k_dd').textContent = Number.isFinite(dd)?(dd*100).toFixed(1)+'%':'—';
    $('#k_nfci').textContent   = fmt(lastVal('NFCI'),3);

    // Indicator charts
    function renderOne(key, title, canvasId, yFmt=null){
      const {labels, values} = toSeries(S[key]?.observations);
      drawLine(canvasId, title, labels, values, yFmt);
    }
    renderOne('T10Y3M', 'Yield Curve (10y–3m)', 'cTerm');
    renderOne('CREDIT', 'Credit Spread (BAA–AAA)', 'cCredit');
    renderOne('UN_SLOPE6', 'Unemployment 6m slope', 'cUn');
    renderOne('DD_12M', '12m Drawdown', 'cDD', (v)=> (v*100).toFixed(0)+'%');
    renderOne('NFCI', 'NFCI', 'cNFCI');

    // Composite rolling proxy: simple mean of available components per index
    const compLabels = (() => {
      for (const k of Object.keys(S)){
        const lbls = toSeries(S[k]?.observations).labels;
        if(lbls.length) return lbls;
      }
      return [];
    })();
    const comps = compLabels.map((_,i)=>{
      function at(arr, idx){ return (arr && idx < arr.length) ? +arr[idx].value : NaN; }
      const t = S.T10Y3M?.observations || [];
      const c = S.CREDIT?.observations || [];
      const u = S.UN_SLOPE6?.observations || [];
      const d = S.DD_12M?.observations || [];
      const n = S.NFCI?.observations || [];
      const vals = [at(t,i), at(c,i), at(u,i), at(d,i), at(n,i)];
      const num = vals.filter(Number.isFinite);
      if(!num.length) return NaN;
      // quick normalize-ish: center each component locally using a small window
      const m = num.reduce((a,b)=>a+b,0)/num.length;
      return m;
    }).filter(Number.isFinite);
    drawLine('cComp','Composite (rolling proxy)', compLabels.slice(-comps.length), comps);

    // Insights
    const ul = $('#insights'); ul.innerHTML='';
    function add(msg){ const li=document.createElement('li'); li.textContent=msg; ul.appendChild(li); }
    const vTerm = lastVal('T10Y3M');
    const vCred = lastVal('CREDIT');
    const vUn   = lastVal('UN_SLOPE6');
    const vDD   = lastVal('DD_12M');
    const vN    = lastVal('NFCI');
    if(Number.isFinite(vN) && vN < 0) add('NFCI < 0 (looser than average).');
    if(Number.isFinite(vTerm) && vTerm < 0) add('Yield curve inverted (10y–3m < 0).');
    if(Number.isFinite(vCred) && vCred > 1.0) add('Credit spread > 1.0 — risk rising.');
    if(Number.isFinite(vUn) && vUn > 0.2) add('Unemployment 6m slope rising.');
    if(Number.isFinite(vDD) && vDD < -0.1) add('Equities >10% below 12-month peak.');
    if(!ul.children.length) add('No strong signals from latest readings.');

  }catch(e){
    $('#loadStatus').innerHTML = `<span class="err">❌ ${e.message}</span>`;
    $('#diagHead').textContent = 'Error';
    $('#diag').textContent = String(e.stack || e.message || e);
  }
})();
</script>
</body>
</html>
