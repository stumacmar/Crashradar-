<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>CrashRadar — Composite Crash Risk</title>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

<style>
  body {
    font-family: system-ui, sans-serif;
    background-color: #0e1326;
    color: #cfe3ff;
    margin: 0;
    padding: 20px;
  }
  h1 {
    color: #58a6ff;
  }
  .section {
    background-color: #1a2038;
    border-radius: 10px;
    padding: 15px;
    margin-bottom: 20px;
    box-shadow: 0 0 10px rgba(0,0,0,0.2);
  }
  .chart {
    position: relative;
    height: 260px;
    margin: 15px 0;
  }
  .chart canvas {
    display: block;
    width: 100% !important;
    height: 100% !important;
  }
  .error {
    color: #ff6b6b;
  }
  .ok {
    color: #6bff8b;
  }
</style>
</head>

<body>
  <h1>CrashRadar — Composite Crash Risk</h1>
  <div id="status" class="section">Loading data...</div>

  <div id="composite" class="section">
    <h2>Composite Score</h2>
    <p><strong id="score">–</strong></p>
    <p>Data freshness: <span id="freshness">–</span></p>
  </div>

  <div id="charts" class="section">
    <h2>Indicators</h2>
    <div class="chart"><canvas id="chartTerm"></canvas></div>
    <div class="chart"><canvas id="chartCredit"></canvas></div>
    <div class="chart"><canvas id="chartUnemp"></canvas></div>
    <div class="chart"><canvas id="chartDraw"></canvas></div>
    <div class="chart"><canvas id="chartNFCI"></canvas></div>
    <div class="chart"><canvas id="chartComposite"></canvas></div>
  </div>

  <div id="insights" class="section">
    <h2>Insights</h2>
    <p id="insightText">–</p>
  </div>

  <footer style="text-align:center; margin-top:40px; opacity:0.6;">
    © CrashRadar — GitHub Pages
  </footer>

<script>
async function init() {
  const status = document.getElementById('status');
  try {
    const response = await fetch('data/fred_cache.json');
    if (!response.ok) throw new Error(`HTTP ${response.status}`);
    const data = await response.json();
    status.innerHTML = '✅ Cache file loaded.';
    renderDashboard(data);
  } catch (err) {
    status.innerHTML = `<span class='error'>❌ Error loading data: ${err.message}</span>`;
  }
}

function renderDashboard(data) {
  const s = data.series;
  document.getElementById('score').textContent = data.score.toFixed(2);
  document.getElementById('freshness').textContent = new Date(data.last_updated).toLocaleString();

  // Simple insight logic
  let insights = [];
  if (s.NFCI < 0) insights.push('NFCI < 0 → financial conditions looser than average');
  if (s['T10Y3M'] < 0) insights.push('Yield curve inverted — recession risk rising');
  if (s.CREDIT > 1) insights.push('Credit spread widening — risk-off tone');
  document.getElementById('insightText').textContent = insights.join('; ') || 'No major signals currently.';

  // Chart helpers
  const ctx = (id) => document.getElementById(id).getContext('2d');
  const opts = (label) => ({
    responsive: true,
    maintainAspectRatio: false,
    scales: {
      x: { ticks: { color: '#9aa2c9' }, grid: { color: 'rgba(255,255,255,0.05)' } },
      y: { ticks: { color: '#9aa2c9' }, grid: { color: 'rgba(255,255,255,0.05)' } }
    },
    plugins: {
      legend: { display: false },
      title: { display: true, text: label, color: '#cfe3ff' }
    },
    borderColor: '#58a6ff',
    backgroundColor: 'rgba(88,166,255,0.2)',
  });

  // Dummy history arrays (expand later when you have full time series)
  const labels = [ "T", "T-1", "T-2", "T-3", "T-4" ];
  const makeHist = (v) => [v*0.8, v*0.9, v*1.05, v*0.95, v];

  new Chart(ctx('chartTerm'),     { type: 'line', data: { labels, datasets: [{ data: makeHist(s.T10Y3M), label: '10y–3m Spread' }] }, options: opts('Yield Curve (10y–3m)') });
  new Chart(ctx('chartCredit'),   { type: 'line', data: { labels, datasets: [{ data: makeHist(s.CREDIT), label: 'BAA–AAA Credit Spread' }] }, options: opts('Credit Spread (BAA–AAA)') });
  new Chart(ctx('chartUnemp'),    { type: 'line', data: { labels, datasets: [{ data: makeHist(s.UN_SLOPE6), label: 'Unemp. 6m Slope' }] }, options: opts('Unemployment 6m Slope') });
  new Chart(ctx('chartDraw'),     { type: 'line', data: { labels, datasets: [{ data: makeHist(s.DD_12M), label: '12m Drawdown' }] }, options: opts('Equity 12m Drawdown') });
  new Chart(ctx('chartNFCI'),     { type: 'line', data: { labels, datasets: [{ data: makeHist(s.NFCI), label: 'Financial Conditions' }] }, options: opts('NFCI Index') });
  new Chart(ctx('chartComposite'),{ type: 'line', data: { labels, datasets: [{ data: makeHist(data.score), label: 'Composite Score' }] }, options: opts('Composite (30-day Rolling)') });
}

init();
</script>
</body>
</html>
