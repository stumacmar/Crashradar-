// scripts/fetch_fred.js
// Builds fred_cache.json with full history arrays for ESI engine

const fs = require("fs/promises");

(async () => {
  try {
    if (!process.env.FRED_API_KEY) {
      throw new Error("Missing env FRED_API_KEY.");
    }

    let _fetch = global.fetch;
    if (typeof _fetch !== "function") {
      _fetch = (await import("node-fetch")).default;
    }

    const FRED = "https://api.stlouisfed.org/fred";
    const KEY  = process.env.FRED_API_KEY;

    // --- all series used in the dashboard ---
    const SERIES = [
      "T10Y3M","T10Y2Y","BAMLH0A0HYM2","NFCI","VIXCLS","RSAFS",
      "ICSA","UNRATE","SAHMREALTIME","AWHMAN","INDPRO","USSLIND",
      "PERMIT","HOUST","UMCSENT","TEDRATE","TDSP"
    ];

    async function getSeries(id){
      const url = `${FRED}/series/observations?series_id=${id}&api_key=${KEY}&file_type=json&observation_start=1990-01-01`;
      const r = await _fetch(url);
      if (!r.ok) throw new Error(`${id} HTTP ${r.status}`);
      const j = await r.json();

      const history = j.observations
        .filter(o => o.value !== "." && o.value !== "")
        .map(o => ({ date:o.date, value:Number(o.value) }))
        .filter(o => Number.isFinite(o.value));

      if (!history.length) throw new Error(`No numeric data for ${id}`);

      const last = history[history.length-1];
      return { history, last: last.value, last_date: last.date };
    }

    const cache = { generated_at:new Date().toISOString() };

    for(const id of SERIES){
      try{
        console.log("Fetching",id);
        cache[id] = await getSeries(id);
      }catch(e){
        console.error("ERROR",id,e.message);
      }
    }

    await fs.mkdir("data",{recursive:true});
    await fs.writeFile("data/fred_cache.json",JSON.stringify(cache,null,2));
    console.log("âœ… data/fred_cache.json written.");
  } catch(err){
    console.error("FATAL",err);
    process.exit(1);
  }
})();
