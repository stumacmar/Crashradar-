      - name: Fetch FRED data (with history)
        env:
          FRED_API_KEY: ${{ secrets.FRED_API_KEY }}
        run: |
          import json, os, requests
          from datetime import datetime

          API_KEY = os.environ["FRED_API_KEY"]
          BASE = "https://api.stlouisfed.org/fred/series/observations"

          def fred_series(sid):
              r = requests.get(BASE, params={
                  "api_key": API_KEY,
                  "file_type": "json",
                  "series_id": sid
              })
              r.raise_for_status()
              obs = r.json().get("observations", [])
              return {"observations": [
                  {"date": o["date"], "value": o["value"]}
                  for o in obs if o.get("value") not in (None, ".", "")
              ]}

          data = {
              "fetched_at_utc": datetime.utcnow().isoformat()+"Z",
              "series": {
                  "DGS10": fred_series("DGS10"),
                  "DGS3MO": fred_series("DGS3MO"),
                  "BAA": fred_series("BAA"),
                  "AAA": fred_series("AAA"),
                  "UNRATE": fred_series("UNRATE"),
                  "SP500": fred_series("SP500"),
                  "NFCI": fred_series("NFCI")
              }
          }

          os.makedirs("data", exist_ok=True)
          with open("data/fred_cache.json", "w") as f:
              json.dump(data, f)
