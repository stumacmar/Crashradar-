<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>CrashRadar — Composite Crash Risk</title>
<meta name="description" content="Cache-first crash risk dashboard fed by GitHub Actions.">
<style>
  :root{--bg:#0b0f24;--panel:#161b3a;--muted:#9aa2c9;--text:#eef0ff;--ok:#21d07a;--warn:#ffd166;--risk:#ff5c7a;--accent:#7ea6ff;--chip:#0f1430;--border:#242b57}
  *{box-sizing:border-box} html,body{margin:0;background:var(--bg);color:var(--text);font:15px system-ui,Segoe UI,Roboto,Helvetica,Arial}
  header{padding:18px 14px;border-bottom:1px solid var(--border)} h1{margin:0 0 6px;font-size:22px}
  .sub{color:var(--muted);font-size:12px} main{padding:14px}
  .grid{display:grid;grid-template-columns:1fr;gap:12px}@media(min-width:920px){.grid{grid-template-columns:2fr 1fr}}
  .card{background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:14px}
  .row{display:flex;gap:12px;flex-wrap:wrap;align-items:flex-start;justify-content:space-between}
  .pill{display:inline-block;background:var(--chip);border:1px solid var(--border);border-radius:999px;padding:8px 10px;margin:6px 6px 0 0;color:var(--muted);font-weight:600}
  .pill b{color:var(--text)} .kpi{font-size:42px;font-weight:800}
  .badge{display:inline-block;border-radius:10px;padding:4px 8px;font-weight:700;margin-top:6px}
  .g{background:rgba(33,208,122,.16);color:var(--ok)} .y{background:rgba(255,209,102,.18);color:var(--warn)} .r{background:rgba(255,92,122,.18);color:var(--risk)}
  .stale{display:inline-block;border-radius:8px;padding:6px 8px;margin-left:8px;font-weight:700}
  .stale.ok{background:rgba(33,208,122,.16);color:var(--ok)} .stale.amber{background:rgba(255,209,102,.18);color:var(--warn)} .stale.red{background:rgba(255,92,122,.18);color:var(--risk)}
  pre{white-space:pre-wrap;background:var(--chip);border:1px solid var(--border);border-radius:8px;padding:10px;color:#ffd166;overflow:auto;max-height:380px}
  .footer{padding:12px 14px;color:var(--muted);font-size:12px;text-align:center;border-top:1px solid var(--border)}
</style>
</head>
<body>
<header>
  <h1>CrashRadar — Composite Crash Risk</h1>
  <div class="sub">
    Cache file: <code>./data/fred_cache.json</code> (written by GitHub Actions)
    <span id="stale" class="stale">checking…</span>
  </div>
</header>

<main class="grid">
  <section class="card">
    <div class="row">
      <div>
        <div>Composite Score</div>
        <div id="score" class="kpi">—</div>
        <div id="badge" class="badge">—</div>
        <div id="fresh" class="sub" style="margin-top:6px">data freshness: —</div>
      </div>
      <div>
        <div class="pill">Term (10y–3m): <b id="k_term">—</b></div>
        <div class="pill">Credit (BAA–AAA): <b id="k_credit">—</b></div>
        <div class="pill">Unemp level: <b id="k_un">—</b></div>
        <div class="pill">12m Drawdown: <b id="k_dd">—</b></div>
        <div class="pill">NFCI: <b id="k_nfci">—</b></div>
      </div>
    </div>
  </section>

  <aside class="card">
    <b>Diagnostics</b>
    <div id="diagHead" class="sub" style="margin:8px 0 6px">Loading…</div>
    <pre id="diag">Waiting…</pre>
    <div class="sub" style="margin-top:6px">If you see “No cache yet”, run the workflow to create <code>data/fred_cache.json</code>.</div>
  </aside>
</main>

<div class="footer">© CrashRadar · GitHub Pages</div>

<script>
const $=s=>document.querySelector(s);
const fmt=(x,d=2)=>Number.isFinite(x)?(+x).toFixed(d):'—';
function setBadge(score){const b=$('#badge'); b.className='badge';
  if(!Number.isFinite(score)){b.textContent='—';return}
  if(score<=0.5){b.textContent='GREEN';b.classList.add('g')}
  else if(score<=1.0){b.textContent='AMBER';b.classList.add('y')}
  else {b.textContent='RED';b.classList.add('r')}
}
function setStaleness(ts){const el=$('#stale'); el.className='stale';
  if(!ts){el.textContent='no timestamp';el.classList.add('red');return}
  const hrs=(Date.now()-new Date(ts).getTime())/36e5;
  if(hrs<24){el.textContent='fresh <24h';el.classList.add('ok')}
  else if(hrs<48){el.textContent='stale >24h';el.classList.add('amber')}
  else{el.textContent='stale >48h';el.classList.add('red')}
}

(async function(){
  const head=$('#diagHead'),diag=$('#diag');
  try{
    const url='./data/fred_cache.json?t='+Date.now();
    head.textContent='Fetching: '+url;
    const r=await fetch(url,{cache:'no-store'});
    if(!r.ok) throw new Error('HTTP '+r.status);
    const raw=await r.text(); diag.textContent=raw.slice(0,4000);
    let j; try{j=JSON.parse(raw)}catch(e){throw new Error('Invalid JSON: '+e.message)}

    // Two supported shapes:
    // A) { series: { T10Y3M: number, CREDIT: number, UNRATE: number, SP500: {observations? or number}, NFCI: number } }
    // B) { series: { DGS10:{...}, DGS3MO:{...}, BAA:{...}, AAA:{...}, UNRATE:{...}, SP500:{...}, NFCI:{...} } }
    const s=j.series||{};

    // Helpers
    const last = node => {
      if(node==null) return null;
      if(typeof node==='number') return node;
      if(typeof node.last==='number') return node.last;
      const obs=node.observations;
      if(Array.isArray(obs)&&obs.length){const v=+obs[obs.length-1].value; return Number.isFinite(v)?v:null}
      return null;
    };

    const D10 = s.DGS10, D3M = s.DGS3MO, BAA = s.BAA, AAA = s.AAA, UNraw = s.UNRATE, SP = s.SP500, NF = s.NFCI;

    // Term/Credit can come precomputed or from raw series:
    const term = (typeof s.T10Y3M==='number')
      ? s.T10Y3M
      : (last(D10)!=null && last(D3M)!=null ? last(D10)-last(D3M) : null);

    const credit = (typeof s.CREDIT==='number')
      ? s.CREDIT
      : (last(BAA)!=null && last(AAA)!=null ? last(BAA)-last(AAA) : null);

    const un = (typeof s.UNRATE==='number') ? s.UNRATE : last(UNraw);
    const nfci = (typeof s.NFCI==='number') ? s.NFCI : last(NF);

    // Drawdown needs observations; if we only have a number, we can’t compute it:
    let dd12 = null;
    if(SP && Array.isArray(SP.observations)){
      const vals = SP.observations.slice(-252).map(o=>+o.value).filter(Number.isFinite);
      if(vals.length){ const curr=vals[vals.length-1], peak=Math.max(...vals); dd12 = curr/peak-1; }
    }

    // Composite using what we have (weights renormalize automatically)
    const zparts = [];
    const pushZ=(val,scale,flip=false)=>{ if(Number.isFinite(val)) zparts.push((flip?-val:val)/scale); };
    pushZ(term,1.0,true);    // more inverted = worse
    pushZ(credit,0.5,false); // wider = worse
    pushZ(un,0.3,false);     // level proxy (rough)
    if(Number.isFinite(dd12)) pushZ(dd12,0.15,true); // deeper dd = worse
    pushZ(nfci,0.5,false);   // tighter = worse

    const weights=[0.3,0.25,0.15,0.2,0.1].slice(0,zparts.length);
    const wsum=weights.reduce((a,b)=>a+b,0)||1;
    const comp = zparts.reduce((a,v,i)=>a+v*weights[i],0)/wsum;

    // Render
    $('#k_term').textContent   = fmt(term,2);
    $('#k_credit').textContent = fmt(credit,2);
    $('#k_un').textContent     = fmt(un,2);
    $('#k_dd').textContent     = Number.isFinite(dd12)?(dd12*100).toFixed(1)+'%':'—';
    $('#k_nfci').textContent   = fmt(nfci,3);
    $('#score').textContent    = Number.isFinite(comp)?fmt(comp,2):'—';
    setBadge(comp);

    const ts=j.fetched_at_utc||j.fetched_at; 
    $('#fresh').textContent = ts ? ('fetched at: '+new Date(ts).toISOString()) : 'timestamp missing';
    setStaleness(ts);
  }catch(e){
    head.textContent='No cache yet — run the workflow';
    diag.textContent=String(e.message||e);
    ['k_term','k_credit','k_un','k_dd','k_nfci','score'].forEach(id=>{$('#'+id).textContent='—'});
    setBadge(NaN); setStaleness(null);
  }
})();
</script>
</body>
</html>
